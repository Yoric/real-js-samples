define(["jquery","client-server","counters","base/view","app/history","app/comet","util/helpers","util/promise","util/icons-manager","util/scroll","util/uri","models/user/active"],function(a,b,c,d,e,f,g,h,i,j,k,l){"use strict";var m=d.extend({props:{deferred:{notifications:"layers/head/notifications",messages:"layers/head/messages",discussions:"layers/head/discussions",games:"layers/head/games",media:"media",autocomplete:"jquery-ui/autocomplete",friendsCollection:"collections/users/friends",musicCollection:"collections/audio/suggest",videoCollection:"collections/video/suggest",appsCollection:"collections/apps/search",appsInstalledCollection:"collections/apps/catalog",hashtagsCollection:"collections/hashtags/suggest"},templates:{menu:"top-menu/tmpl/menu",suggestItem:"top-menu/tmpl/suggests/item",suggestAppItem:"top-menu/tmpl/suggests/apps"},elements:{items:".b-head__menu__buttons__item",search:".b-head__menu__search",searchSectionsList:".b-head__menu__search__sections__items",searchSectionsTitle:".b-head__menu__search__sections__title",searchSectionsItems:".b-head__menu__search__sections__items__item",searchInput:".b-head__menu__search__input",suggestItems:".b-head__menu__suggests__item"},events:{"click .b-head__menu__buttons__item":"onHeadMenuButtonsItemClick","click .b-head__menu__search__sections__title":"onSearchSectionsTitleClick","click .b-head__menu__search__sections__items__item":"onSearchSectionsItemClick","click .b-head__menu__search__button":"onSearchButtonClick","suggest .b-head__menu__search__input":"onSearchInputSuggest","keydown .b-head__menu__search__input":"onSearchInputKeyDown","focus .b-head__menu__search__input":{delegate:!1,method:"onSearchInputFocus"},"input .b-head__menu__search__input":"onSearchInputInput"},cssClasses:{writeMessage:"e-dialogues__single-message-button",counter:"b-head__menu__buttons__item__counter",withCounter:"b-head__menu__buttons__item_with-counter",fade:"b-head__menu__fade"},defaultOptions:{position:"fixed",selectedFromAutoCompleteTimeout:100,searchSuggestAppsLimit:7,fadeAnimationDuration:300,fadeHideTimeout:50},clns:{search:{any:405881,peoples:405882,photo:405884,music:405886,video:405888,games:405890,hashtags:23812618,groups:405892,internet:405893}},vars:{height:null,offsetTop:null,layers:{},counters:{},isSelectedFromAutoComplete:!1,friends:null,music:null,video:null,apps:null,installedApps:null,hashtags:null,openedLayer:null,$fade:null,fadeHideTimer:null,isOpenLayerNow:!1,isSelectedSearchSectionByUserInput:!1,defaultSearchSectionId:null}},public:{init:function(){var b=new k,c=b.param("browse");return this.height=this.$el.height(),this.offsetTop=this.$el.offset().top,this.counters=this.options.counters,this.onWindowScrollHandler=this.onWindowScroll.bind(this),j.on(this.onWindowScrollHandler),this.onBodyClickHandler=this.onBodyClick.bind(this),a(document.body).on("click",this.onBodyClickHandler),this.onOpenHeadLayerHandler=this.onOpenHeadLayer.bind(this),a(document.body).on("open-head-layer",this.onOpenHeadLayerHandler),this.onBannerLoadedHandler=this.onBannerLoaded.bind(this),a(document.body).on("banner.loaded",this.onBannerLoadedHandler),this.onBoosterLoadedHandler=this.onBoosterLoaded.bind(this),a(document.body).on("booster:loaded",this.onBoosterLoadedHandler),f.pushEvent.on(this.onCometEvent.bind(this)),c&&this.open(this.getMappedType(c)),this.defaultSearchSectionId=this.options.sections.selected.id,this.options.sections&&this.options.sections.selected&&this.defaultSearchSectionId&&(this.$searchSectionsItems.removeClass("selected"),this.$searchSectionsItems.filter('[data-id="'+this.defaultSearchSectionId+'"]').addClass("selected")),this.checkFixed(window.pageYOffset||document.documentElement.scrollTop||document.body.scrollTop||0),this.fadePosition(),setTimeout(function(){this.fadePosition()}.bind(this),3e3),this},destroy:function(){return this.onWindowScrollHandler&&(j.off(this.onWindowScrollHandler),delete this.onWindowScrollHandler),this.onBodyClickHandler&&(a(document.body).off("click",this.onBodyClickHandler),delete this.onBodyClickHandler),this.onOpenHeadLayerHandler&&(a(document.body).off("open-message",this.onOpenHeadLayerHandler),delete this.onOpenHeadLayerHandler),this.onBoosterLoadedHandler&&(a(document.body).off("booster:loaded",this.onBoosterLoadedHandler),delete this.onBoosterLoadedHandler),this.onBannerLoadedHandler&&(a(document.body).off("banner.loaded",this.onBannerLoadedHandler),delete this.onBannerLoadedHandler),this.$fade&&(this.$fade.remove(),delete this.$fade),m.__super__.destroy.call(this)},open:function(b,c){var d=this.$items.filter('[data-id="'+b+'"]');return a(document.body).addClass("popup-opened"),c=c||{},d.size()&&(this.layers[b]||(this.$fade&&this.$fade.size()||(this.$fade=a("<div></div>").addClass(this.cssClasses.fade).appendTo(this.$el)),this.$fade.fadeIn(this.options.fadeAnimationDuration),this.fadePosition(),clearTimeout(this.fadeHideTimer),this.isOpenLayerNow=!0,this.fadeHideTimer=setTimeout(function(){this.isOpenLayerNow=!1}.bind(this),this.options.fadeHideTimeout),this.$items.removeClass("selected"),d.addClass("selected"),this.openedLayer&&this.layers[this.openedLayer].destroy(),this.require(b,function(a){setTimeout(function(){var e=new a(g.extend(!0,{$container:d},this.options,c));e.on("destroy",this.onLayerDestroy.bind(this,b)).on("change-counter",this.onLayerChangeCounter.bind(this,b)),this.layers[b]=e,"messages"!==b&&d.removeClass(this.cssClasses.withCounter)}.bind(this)),this.setUrl(b)}.bind(this))),this.openedLayer=b),this.fadePosition(),this},searchSubmit:function(){var a=this.getSearchQuery(),b=this.getSearchType();if(!this.isSelectedFromAutoComplete)switch(c.myrb(this.clns.search.any),this.clns.search[b]&&c.myrb(this.clns.search[b]),b){case"peoples":this.boosterGo(this.getPeoplesSearchUrl(a));break;case"photo":this.boosterGo(this.getPhotoSearchUrl(a));break;case"music":window.open(this.getMusicSearchUrl(a));break;case"video":window.open(this.getVideoSearchUrl(a));break;case"games":location.href=this.getAppsSearchUrl(a);break;case"hashtags":this.boosterGo(this.getHashTagSearchUrl(a));break;case"groups":location.href=this.getGroupsSearchUrl(a);break;case"internet":window.open(this.getInternetSearchUrl(a))}this.$el.find(".ui-autocomplete").hide()},setUrl:function(a){var b=new k,c=b.param("browse"),d=e.page();this.opening=!0,b.data.query?c?d=d.replace("browse="+c,"browse="+a):d+="&browse="+a:d+="?browse="+a,e.page(d,e.SetHashModes.SUPPRESS_EVENT)}},protected:{isBoosterPage:function(){return!!a(document.body).data("has-booster")},boosterGo:function(a){this.isBoosterPage()?e.page(a):location.href=a},fadePosition:function(){var b=a(window).scrollTop()||document.documentElement.scrollTop;this.$fade&&this.$fade.size()&&this.$fade.css("top",this.height+this.$el.position().top-b)},initSearchAutoComplete:function(){return new h(function(a,b){this.$searchInput.data("uiAutocomplete")?a():this.require("autocomplete",function(){this.$searchInput.autocomplete({appendTo:this.$search,minLength:3,source:function(a,b){this.suggestFactory(this.getSearchType(),b)}.bind(this),select:this.onSearchAutoCompleteSelect.bind(this)}),this.$searchInput.data("uiAutocomplete")._renderMenu=this.onSearchInputSuggest.bind(this),a()}.bind(this))}.bind(this))},getMappedType:function(a){return"communication"===a&&(a="discussions"),"dialogues"===a&&(a="messages"),a},getSearchType:function(){return this.$searchSectionsItems.filter(".selected").data("id")},getSearchQuery:function(){return this.$searchInput.val().trim()},suggestFactory:function(a,b){a&&g.isFunction(b)&&this.getSuggestCollection(a).then(function(c){c.clear().setQuery(this.getSearchQuery()).suggest().then(function(){b(c.toJSON().map(function(b){return this.getSuggestItem(a,b)}.bind(this)))}.bind(this))}.bind(this))},getSuggestCollection:function(a){return new h(function(b,c){switch(a){case"peoples":this.getFriendsCollection().then(function(){b(this.friends)}.bind(this)).catch(c);break;case"music":this.getMusicCollection().then(function(){b(this.music)}.bind(this)).catch(c);break;case"video":this.getVideoCollection().then(function(){b(this.video)}.bind(this)).catch(c);break;case"games":this.getAppsCollection().then(function(){b(this.apps)}.bind(this)).catch(c);break;case"hashtags":this.getHashtagsCollection().then(function(){b(this.hashtags)}.bind(this)).catch(c)}}.bind(this))},getFriendsCollection:function(){return new h(function(a,b){this.friends?a(this.friends):this.require("friendsCollection",function(b){this.friends=new b,a(this.friends)}.bind(this))}.bind(this))},getAppsCollection:function(){return new h(function(a,b){this.apps?a(this.apps):this.require("appsCollection",function(b){this.apps=new b,a(this.apps)}.bind(this))}.bind(this))},getInstalledAppsCollection:function(){return new h(function(a,b){this.apps?a(this.apps):this.require("appsInstalledCollection",function(b){this.installedApps=new b({func:"app.installed"}),a(this.installedApps)}.bind(this))}.bind(this))},getMusicCollection:function(){return new h(function(a,b){this.music?a(this.music):this.require("musicCollection",function(b){this.music=new b,a(this.music)}.bind(this))}.bind(this))},getVideoCollection:function(){return new h(function(a,b){this.video?a(this.video):this.require("videoCollection",function(b){this.video=new b,a(this.video)}.bind(this))}.bind(this))},getHashtagsCollection:function(){return new h(function(a,b){this.hashtags?a(this.hashtags):this.require("hashtagsCollection",function(b){this.hashtags=new b,a(this.hashtags)}.bind(this))}.bind(this))},getSuggestItem:function(a,b){var c;switch(a){case"peoples":c=g.extend(b,{value:b.name,url:b.dir});break;case"music":c=g.extend(b,{value:b.query,url:this.getMusicSearchUrl(b.query)});break;case"video":c=g.extend(b,{value:b.text,url:this.getVideoSearchUrl(b.text)});break;case"games":c=g.extend(b,{img:b.pics["120x60"],inst:b.installationsFormatted,value:b.shortName,url:"/apps/"+b.id+"?ref="+b.ref});break;case"hashtags":c=g.extend(b,{value:b.text,url:this.getVideoSearchUrl(b.text)})}return c},getPeoplesSearchUrl:function(a){return"/my/search_people?&name="+a},getPhotoSearchUrl:function(a){return"/my/photo_search?q="+a+"&st=search&head=1"},getMusicSearchUrl:function(a){return"/music/search/"+a},getVideoSearchUrl:function(a){return"/video/search/?q="+a},getAppsSearchUrl:function(a){return"/apps/search?q="+a+"&st=search&head=1"},getHashTagSearchUrl:function(a){return"/hashtag/"+a.replace(/[#\s]/g,"")},getGroupsSearchUrl:function(a){return"/my/communities-search?q="+a+"&st=search&head=1"},getInternetSearchUrl:function(a){return"//go.mail.ru/search?q="+a+"&st=search&head=1"},checkFixed:function(b){"fixed"===this.options.position&&(a(document.body).is(".head-fixed")||(this.offsetTop=this.$el.offset().top),b>=this.offsetTop?a(document.body).addClass("head-fixed"):a(document.body).removeClass("head-fixed"))},updateCounters:function(b){this.$items.each(function(c,d){var e=a(d),f=e.data("id");!b[f]||f===this.openedLayer&&"messages"!==f||e.addClass(this.cssClasses.withCounter).find("."+this.cssClasses.counter).text(b[f])}.bind(this)),this.counters=b},showInstalledGamesSuggests:function(){h.all([this.getInstalledAppsCollection(),this.initSearchAutoComplete()]).then(function(){this.installedApps.fetch().then(function(){var a=this.installedApps.toJSON().filter(function(a){return/[^\s\r\n]+/.test(a.shortName)}).slice(0,this.options.searchSuggestAppsLimit).map(function(a){return this.getSuggestItem("games",a)}.bind(this));this.$searchInput.data("uiAutocomplete")._suggest(a)}.bind(this))}.bind(this))},setSelectedSearchSection:function(a,b){this.$searchSectionsItems.removeClass("selected").filter('[data-id="'+a+'"]').addClass("selected"),this.$searchSectionsTitle.text(this.options.locales.search.sections[a]),this.isSelectedSearchSectionByUserInput=!!b},onLayerDestroy:function(b,c,d){var f=e.page().replace(new RegExp("[?&]browse="+b+"(&email=.+)?","g"),"");a(document.body).removeClass("popup-opened"),this.$items.filter('[data-id="'+b+'"]').removeClass("selected"),e.page(f,e.SetHashModes.SUPPRESS_EVENT),delete this.layers[b],this.openedLayer=null,this.isOpenLayerNow||this.$fade.fadeOut(this.options.fadeAnimationDuration)},onLayerChangeCounter:function(a,b,c){var d,e=this.$items.filter('[data-id="'+a+'"]'),f=e.find("."+this.cssClasses.counter);"all"===c?this.counters[a]=0:this.counters[a]-=c,d=this.counters[a],isNaN(d)&&(d=0),f.text(d),d<=0&&e.removeClass(this.cssClasses.withCounter)},onCometEvent:function(a,b){var c;a&&!b&&(b=a),c=b.data,"notification-numbers"===b.name&&this.updateCounters(g.extend(c,{messages:c.dialogues,discussions:c.communication})),"dialogues"===b.type&&c.recipient_email===l.get("email")&&(this.layers.messages&&this.layers.messages.content&&this.layers.messages.content.model?this.layers.messages.content.model.get("email")!==c.author_email&&this.updateCounters({messages:c.total_unread}):this.updateCounters({messages:c.total_unread}))},onWindowScroll:function(a,b){this.checkFixed(b.scrollTop),this.fadePosition()},onBodyClick:function(b){var c,d,e=a(b.target);b.target!==this.$searchSectionsTitle.get(0)&&this.$searchSectionsList.removeClass("show"),e.closest("."+this.cssClasses.writeMessage).size()?c=e.closest("."+this.cssClasses.writeMessage):e.is("."+this.cssClasses.writeMessage)&&(c=e),c&&c.length&&(d=c.data(),this.require("media",function(a){a.closeLayers(),this.open("messages",{messages:{from:d.from,userEmail:d.email}})}.bind(this)))},onOpenHeadLayer:function(a,b){var c=b.type,d={};c=this.getMappedType(c),d[c]=b.options,"friendship"!==c&&this.open(c,d)},onBoosterLoaded:function(a,b){var c={"/my/friends":"peoples","/friends":"peoples","/my/photo":"photo","/my/communities":"groups","/hashtag":"hashtags"},d=!1;Object.keys(c).forEach(function(a){0===location.pathname.indexOf(a)&&(this.setSelectedSearchSection(c[a]),this.defaultSearchSectionId=c[a],d=!0)}.bind(this)),d||(this.setSelectedSearchSection("peoples"),this.defaultSearchSectionId="peoples")},onHeadMenuButtonsItemClick:function(b,d){var e=a(d.target).closest(".b-head-layer").size()>0;this.open(b.data("id")),e||c.myrb(b.data("menuButtonCounter"))},onSearchSectionsTitleClick:function(a,b){this.$searchSectionsList.toggleClass("show")},onSearchSectionsItemClick:function(a,b){this.$searchSectionsTitle.text(a.text()),this.$searchSectionsItems.removeClass("selected"),a.addClass("selected"),this.$searchInput.focus()},onSearchButtonClick:function(a,b){this.searchSubmit()},onSearchInputSuggest:function(b,c){m.renderList({template:"games"===this.getSearchType()?"suggestAppItem":"suggestItem",data:c,$container:b,isNoCreateViews:!0}).then(function(){this.updateElements(),this.$suggestItems.each(function(b){a(this).data("ui-autocomplete-item",c[b])})}.bind(this))},onSearchAutoCompleteSelect:function(a,b){switch(this.isSelectedFromAutoComplete=!0,clearTimeout(this.selectedFromAutoCompleteTimer),this.selectedFromAutoCompleteTimer=setTimeout(function(){this.isSelectedFromAutoComplete=!1}.bind(this),this.options.selectedFromAutoCompleteTimeout),this.getSearchType()){case"peoples":this.boosterGo(b.item.dir);break;case"music":window.open(this.getMusicSearchUrl(b.item.query));break;case"video":window.open(this.getVideoSearchUrl(b.item.text));break;case"games":location.href=b.item.url;break;case"hashtags":this.boosterGo(this.getHashTagSearchUrl(b.item.text))}},onSearchInputKeyDown:function(a,b){13===b.keyCode&&this.searchSubmit()},onSearchInputFocus:function(a,b){"games"===this.getSearchType()&&0===this.getSearchQuery().length?this.showInstalledGamesSuggests():this.initSearchAutoComplete()},onSearchInputInput:function(a,b){var c=this.getSearchQuery();0===c.indexOf("#")&&"hashtags"!==this.getSearchType()?this.setSelectedSearchSection("hashtags",!0):0===c.length&&"hashtags"===this.getSearchType()&&this.isSelectedSearchSectionByUserInput&&this.setSelectedSearchSection(this.defaultSearchSectionId)},onBannerLoaded:function(a,b){this.offsetTop=this.$el.offset().top,this.fadePosition()}}});return m});