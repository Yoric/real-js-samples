nhn.LikeIt.list.Main=LIKE.$Class({$init:function(){this._oConf=nhn.LikeIt.list.config;this._bDelegateEvent=false;this._bAttachEvent=false;this._bDevServer=this._isDevServer();var c=this._oConf.bMobile?"m":"d";var b="css."+c+"Service";var a=this._oConf.sId;if(this._oConf.sCssId){a=this._oConf.sCssId;}else{if(this._bDevServer&&this._oConf.sDevCssUrl){b="css.sDevCssUrl";a=this._oConf.sDevCssUrl;}}nhn.LikeIt.list.util.loadFile("css."+c+"Main");nhn.LikeIt.list.util.loadFile(b,a);this._setApiUrl();this.update();},_isDevServer:function(){var a=this._oConf.sDomain.split("//")[1].split(".")[0];if(a=="local"||a=="dev"||a=="test"){return true;}return false;},update:function(){this._aCurrentButton=this._getBtnElement({likeit:0});LIKE.$ElementList(this._aCurrentButton).html(this._oConf.sTemplate);for(var b=0,d=this._aCurrentButton.length,c=Math.ceil(d/this._oConf.nRequestContentCount),e,a;b<c;b++){e=Math.max(0,b*this._oConf.nRequestContentCount);a=Math.min(e+this._oConf.nRequestContentCount,d);this._getCount(this._aCurrentButton.slice(e,a));}},_getBtnElement:function(){var d="";for(var b=0,c;c=arguments[b];b++){for(var a in c){d+="[data-"+this._oConf.oPrefix[a]+'="'+c[a]+'"]';}}return this._selectElement(d);},_selectElement:function(c){var a=this._oConf.elWrapper;try{return(nhn.LikeIt.list.Main.prototype._selectElement=function(d){return LIKE.$$(d,a);})(c);}catch(b){return(nhn.LikeIt.list.Main.prototype._selectElement=function(d){return LIKE.$A(a.querySelectorAll(d)).forEach(function(f,g,e){e[g]=LIKE.$Element(f);}).$value();})(c);}},_getElement:function(b,a,d){var c=this._getBtnElement({sid:b},{cid:a});return d?LIKE.$ElementList(c):c;},_extractData:function(b){var d={},c="";LIKE.$A(b).forEach(LIKE.$Fn(function(g,j){var f=LIKE.$Element(g),h=f.data(this._oConf.oPrefix.sid),e=f.data(this._oConf.oPrefix.cid);if(!(h in d)){d[h]=[];}if(!LIKE.$A(d[h]).has(e)){d[h].push(e);}},this).bind());for(var a in d){if(c){c+="|";}c+=a+"["+d[a].join(",")+"]";}return c;},_getCount:function(c){var a=this._extractData(c);if(a==""){return;}var b=function(d,g){for(var e=0,f;f=d.get(e);e++){if(this._oConf.bHideCount){LIKE.$Element(f.query("._cnt")).css("display","none");}LIKE.$Element(f.query("._cnt")).html(nhn.LikeIt.list.util.getFormattedCount(g.likeItCount));f.data(this._oConf.oPrefix.likeit,1);if(g.likeItYn=="Y"){f.removeClass("off");f.addClass("on");}}};new LIKE.$Ajax(this._oConf.oUrl.api.content,{type:"jsonp",method:"get",onload:LIKE.$Fn(function(f){var k=f.json(),g=k.result;nhn.LikeIt.list.util.setDataMethod();if(!k.success){alert(k.message);return;}var h=g.contents;for(var e=0;e<h.length;e++){var d=this._getElement(h[e].serviceId,h[e].contentsId,this._oConf.oPrefix.likeit,true);b.call(this,d,{likeItCount:h[e].likeItCount,likeItYn:h[e].likeItYn});}var j=this._getBtnElement({likeit:0});var d=LIKE.$ElementList(j);b.call(this,d,{likeItCount:0,likeItYn:"N"});if(this._bDelegateEvent==false&&this._bAttachEvent==false){this._attachEvent();}if(g.likeItToken){this._oConf.sLikeItToken=g.likeItToken;}if(g.timestamp){this._oConf.lTimestamp=g.timestamp;}},this).bind()}).request({params:a,token:this._oConf.sToken,consumerKey:this._oConf.sConsumerKey,snsCode:this._oConf.sSnsCode});this._bAttachEvent=false;},_setApiUrl:function(){if(this._oConf.sAuthType=="neoid"){var a=this._oConf.oUrl.apigw_domain.real;var b=this._oConf.sDomain.split("//")[1].split(".")[0];if(this._bDevServer){a=this._oConf.oUrl.apigw_domain.dev;b=this._oConf.sDomain.split("//")[1].split(".")[1];}if(this._oConf.sApiDomain){a=this._oConf.sApiDomain;}this._oConf.oUrl.api.content=a+this._oConf.oUrl.apigw_api.content.replace("{=VAL}",b);this._oConf.oUrl.api.contentAdd=a+this._oConf.oUrl.apigw_api.contentAdd.replace("{=VAL}",b);this._oConf.oUrl.api.contentAddCancel=a+this._oConf.oUrl.apigw_api.contentAddCancel.replace("{=VAL}",b);}else{this._oConf.oUrl.api.content=this._oConf.sDomain+this._oConf.oUrl.like_api.content;this._oConf.oUrl.api.contentAdd=this._oConf.sDomain+this._oConf.oUrl.like_api.contentAdd;this._oConf.oUrl.api.contentAddCancel=this._oConf.sDomain+this._oConf.oUrl.like_api.contentAddCancel;}},_likeItAdd:function(c,f){var d=c.data(this._oConf.oPrefix.sid),b=c.data(this._oConf.oPrefix.cid),e=c.data(this._oConf.oPrefix.catgid)||"",h=c.data(this._oConf.oPrefix.did)||"",a=c.data(this._oConf.oPrefix.rparam)||"",g=this._oConf.oUrl.api[(f?"contentAdd":"contentAddCancel")];LIKE.$Ajax(g,{type:"jsonp",method:"get",onload:LIKE.$Fn(function(n){var p=n.json(),j=this._getElement(d,b,true),k=[],l=0;if(!p.success){alert(p.message);return;}for(var m=0,o;o=j.get(m);m++){k.push(LIKE.$$.getSingle("._cnt",o.$value()));}k=LIKE.$ElementList(k);l=~~k.get(0).text().replace(/\W/g,"");if(p.result.resultStatusCode=="0"||p.result.resultStatusCode=="2003"||p.result.resultStatusCode=="1017"){if(this._oConf.bHideCount){k.css("display","none");}k.html(nhn.LikeIt.list.util.getFormattedCount(f?l+1:p.result.contents.likeItCount));j.removeClass(f?"off":"on");j.addClass(f?"on":"off");}else{if(p.code=="9001"||p.result.resultStatusCode=="1001"){nhn.LikeIt.list.util.login();}else{alert(p.result.resultMessage);}}this._btnClicked=false;if(!!this._oConf.oPostHandler&&typeof this._oConf.oPostHandler=="function"){this._oConf.oPostHandler(f,p);}},this).bind(),timeout:3,ontimeout:LIKE.$Fn(function(){this._btnClicked=false;},this).bind()}).request({serviceId:d,contentsId:b,categoryId:e,displayId:h,lang:this._oConf.sLang,timeLineShare:"N",countCallbackYn:this._oConf.sCountCallbackYn,rparam:a,_ch:(this._oConf.bMobile?"mbw":"pcw"),token:this._oConf.sToken,consumerKey:this._oConf.sConsumerKey,snsCode:this._oConf.sSnsCode,likeItToken:this._oConf.sLikeItToken,timestamp:this._oConf.lTimestamp});this._btnClicked=true;},_attachEvent:function(){var a;if(this._oConf.elWrapper==document.body){a=this._aCurrentButton;this._bAttachEvent=true;}else{if(this._oConf.elWrapper!=null&&typeof this._oConf.elWrapper!=="undefined"){a=this._oConf.elWrapper;this._bDelegateEvent=true;}else{a=this._aCurrentButton;this._bAttachEvent=true;}}LIKE.$Fn(this._clickBtn,this).attach(a,"click");},_clickBtn:function(d){var b=this._oConf.elWrapper==document.body?d.currentElement:(d.element||d.srcElement),a,c;b.tagName!="A"&&(b=b.parentNode)&&b.tagName!="A"&&(b=b.parentNode);a=LIKE.$Element(b);if(a==null||!a.data(this._oConf.oPrefix.likeit)||b.tagName!="A"){return;}c=!a.hasClass("on");nhn.LikeIt.list.util.clickcr(b,(c?"like":"unlike"),d._event);if(nhn.LikeIt.list.util.isLogin()){if(!!this._oConf.oPreHandler&&typeof this._oConf.oPreHandler=="function"&&this._oConf.oPreHandler(d)==false){d.stop();return;}this._btnClicked?alert(nhn.LikeIt.message.alert[c?"LIKE_CALLING":"LIKE_CANCELING"]):this._likeItAdd(a,c);}else{nhn.LikeIt.list.util.login();}d.stop();}});nhn.LikeIt.list.instance=new nhn.LikeIt.list.Main();