/**
 * @file  dhotelsearch_area-[version].js
 * @brief トラベルNEXT  都道府県・Lエリアプルダウン制御
 * @version $Id$
 */

/**
 * @brief DhotelsearchArea トラベル国内宿泊 都道府県・Lエリアプルダウン制御
 */
var DhotelsearchArea = function (form_id) {
    // IDを指定のない場合は終了
    if (!form_id) return;
    
    /**
     * 初期化
     */
    var larea_default = 0;
    var marea_default = 0;

    var elm = document.getElementById(form_id);

    // イベント付与
    $(elm.ken).on('change', function () {
        onChangePref(elm.lcd.options);
    });
    // mareaは無いことがあるので注意
    if (typeof elm.mcd!="undefined" && elm.mcd) {
        $(elm.lcd).on('change', function () {
            onChangeLarea(elm.mcd.options.length);
        });
    }

    // 初期化メソッド実行
    initArea(_myGetQuery('larea'));

    // ※ グローバルに必要な関数を出しておく
    window.reloadLarea = reloadLarea;
    window.reloadMarea = reloadMarea;
  
    /**
     * @brief kenの値をリセット
     */
    function resetKen(){
        elm.ken.options[0].value = "";
        elm.ken.options[0].text = "都道府県を選択してください";
        elm.ken.options[0].selected = true;
    }
    
    /**
     * @brief lareaの値をリセット
     */    
    function resetLarea(){
        elm.lcd.length = 1;
        elm.lcd.options[0].value = "";
        elm.lcd.options[0].text = "指定しない";
        elm.lcd.options[0].selected = true;
    }
    
    /**
     * @brief mareaの値をリセット
     */    
    function resetMarea(){
        // mareaは無いことがあるので注意
        if (typeof elm.mcd!="undefined" && elm.mcd) {
            elm.mcd.length = 1;
            elm.mcd.options[0].value = "";
            elm.mcd.options[0].text = "指定しない";
            elm.mcd.options[0].selected = true;
        }
    }

    /**
     * @brief area を初期化するメソッド
     */
    function initArea(param_larea){
       if(elm.lcd.type != "hidden"){
            larea_default = param_larea;

            if (param_larea) {
                // URLでパラメータ指定の場合
                elm.ken.value = param_larea;
            } else if (elm.ken.value) {
                // 初期値が指定されているときはそのまま何もしない
            } else {
                // なにもないときはとりあえずリセット!!!!
                resetKen();      
            }
            resetLarea();
            resetMarea();

            onChangePref(elm.lcd.options);
        }
    }

    /**
     * @brief ken変更時に呼ぶメソッド
     */ 
    function onChangePref(prm_hide_array){
        var v = elm.ken.options[elm.ken.selectedIndex].value;
        var hide_array = new Array();

        if(v == "" || v == "00"){
            resetLarea();
            larea_default = "";
            resetMarea();
            marea_default = "";
        }else{
            resetLarea();
            resetMarea();

            if(v.match('LL')) {
                 resetLarea();
            } else {
                 // "KC01" → "01"のみ使う
                 var ken = elm.ken.value.toString().substring(2, 4);
                 reloadLarea(ken);

            } 
        }
    }

    /**
     * @brief Lareaを再設定メソッド
     */
    function reloadLarea(ken){
       var i = 1;
       for (var key in BT_L_AREA_MST) {
           if(BT_L_AREA_MST[key].parentcode == ken) {
               elm.lcd.length++;
               elm.lcd[i].value = key;
               elm.lcd[i].text = decodeURI(BT_L_AREA_MST[key].name);
               i++;
           }
       }

        if(larea_default != ""){
            for(i=0;i<elm.lcd.length;i++){
                if(larea_default == elm.lcd[i].value){
                    elm.lcd.options[i].selected = true;
                }
            }
            larea_default = "";
            onChangeLarea();
        }
    }

    /**
     * @brief Mareaを再設定メソッド
     */
    function reloadMarea(marea){
        var i = 1;
        for (var key in BT_M_AREA_MST) {
            if(BT_M_AREA_MST[key].parentcode == marea) {
                elm.mcd.length++;
                elm.mcd[i].value = key;
                elm.mcd[i].text = decodeURI(BT_M_AREA_MST[key].name);
                i++;
            }
        }

        if(marea_default != ""){
            for(i=0;i<elm.mcd.length;i++){
                if(marea_default == elm.mcd[i].value){
                    elm.mcd.options[i].selected = true;
                }
            }
            marea_default = "";
            onChangeMarea();
        }
    }

    /**
     * @brief Larea変更時に呼ぶメソッド
     */    
    function onChangeLarea(){
        if(elm.lcd.options[elm.lcd.selectedIndex].value == ""){
            resetMarea();
            marea_default = "";
        }else{
            resetMarea();
            reloadMarea(elm.lcd.value.toString());
        }
    }

    /**
     * @brief Marea変更時に呼ぶメソッド
     */    
    function onChangeMarea(){
        if(elm.mcd.options[elm.mcd.selectedIndex].value == ""){
        }else{
        }
    }

    /**
     * @brief URLから指定したパラメータを取得
     * @praam[in] パラメータのキー
     */
    function _myGetQuery(myKeyWord){
        myKeyWord = "&" + myKeyWord + "=";
        myValue = null;
        myStr = location.search;
        myLen = myStr.length;
        myStr = "&" + myStr.substring(1,myLen) + "&";
        myOfst = myStr.indexOf(myKeyWord);
        if (myOfst != -1){
            myStart = myOfst + myKeyWord.length;
            myEnd   = myStr.indexOf("&" , myStart);
            myValue = myStr.substring(myStart,myEnd);
            myValue = unescape(myValue);
        }
        return myValue;
    }
};

