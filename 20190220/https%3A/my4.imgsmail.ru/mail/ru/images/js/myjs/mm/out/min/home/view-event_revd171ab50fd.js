define(["jquery","client-server","counters","util/promise","util/helpers","isInViewport","jquery.jcarousel"],function(a,b,c,d,e){"use strict";var f,g,h,i=new d(function(b){var c=a("html");c.hasClass("window-loaded")?b():a(window).on("load",function(){b()})}),j=function(b,c,d){return d=a(d),b.push(d.data("viewId")),c},k=function(){var a=[];return{add:function(b){a.push(b)},count:function(){a.length&&(c.astat(a),a=[])}}},l={sendStat:function(a,c){a.length&&(b.func("video_channel.send_stat",{type:"view_video",group_id:a.join(",")}),a=[]),c.length&&(b.func("multipost.adv_send_stat",{pids:c.join(",")}),c=[])},stat:function(b){var d,e,k,l,m=[],n=[];h&&(d=a(".stat-channels:in-viewport"),d.each(j.bind(this,m)),d.removeClass("stat-channels"),d=null,e=a(".b-history-event.stat-adv-post:in-viewport"),e.each(j.bind(this,n)),e.removeClass("stat-adv-post"),e=null,k=a(".b-history__adv-post-carousel__wrap"),k.size()&&k.data("jcarousel")&&k.jcarousel("visible").filter(":not([data-viewed])").each(j.bind(this,n)).attr("data-viewed","1"),n.forEach(c.myrb.bind(null,23244649)),l=a(".b-history-event.stat-commercial-post:in-viewport"),l.each(c.myrb.bind(null,23291168)),l.removeClass("stat-commercial-post"),l=null),a(".stat-astat:in-viewport").each(function(d,e){var h,i=[],j=a(e),k={version:1,category:{}};return h=j.data("astat").split(":"),i={UserID:h[0]||"0",Type:h[1],EvID:h[2],JournalID:h[3]||"0",ParentJournalID:h[4],ParentEvID:h[5],LikesCnt:h[6],CommentsCnt:h[7],IsRecommend:h[9],CountryID:h[10]},this.queue.add(i),f&&(k.category[f]=i,c.dwh(k),"first"!==b&&c.dwh({version:1,category:{"news-feed-scrolls":{UserID:g||"0",HistoryType:f}}})),j.removeClass("stat-astat"),d}.bind(this)),i.then(this.sendStat.bind(this,m,n))},checkWatch:function(){e.isFunction(this.onWatched)&&a(".b-history-event__runtime-update:in-viewport").each(function(b,c){return this.onWatched(a(c)),b}.bind(this))},onScrolled:function(){this.timeout&&(window.clearTimeout(this.timeout),this.timeout=null),this.timeout=window.setTimeout(this.stat.bind(this),200),this.checkWatch()},advCarouselAnimateEnd:function(){this.stat()}},m=l.onScrolled.bind(l),n=l.advCarouselAnimateEnd.bind(l);return{init:function(b,c){f=b.data("history-dstat"),g=b.data("history-user"),h=b.data("historyView"),a(window).on("scroll",m),l.queue=new k({activeId:g}),l.stat("first"),this.statInterval||(this.statInterval=setInterval(l.queue.count.bind(l),5e3)),l.onWatched=c.onWatched},initAdvCarousel:function(){a(".b-history__adv-post-carousel__wrap").on("jcarousel:animateend",n),l.stat("first")},checkWatch:l.checkWatch.bind(l),destroy:function(){a(window).off("scroll",m),a(".b-history__adv-post-carousel__wrap").off("jcarousel:animateend",n),clearInterval(this.statInterval),delete this.statInterval,l.queue.count.call(l),l.timeout&&window.clearTimeout(l.timeout)}}});