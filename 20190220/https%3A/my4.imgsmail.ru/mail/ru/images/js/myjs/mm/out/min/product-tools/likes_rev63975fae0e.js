define(["jquery","factory","client-server","counters","util/find-event-target","util/helpers"],function(a,b,c,d,e,f){var g="progress",h="active",i="inactive",j="like:Controller",k=function(){return function(b,c){var d=c.find('[data-type="config"]'),e={};return d&&d.length&&(e=a.parseJSON(d.html())),e.like=window.parseInt(e.like),e.likers=window.parseInt(e.likers),e}}(),l={MusicPlaylist:17509310},m=function(){b("product-tools/auth-form",function(a){a.show()})},n={setUp:function(){},onBrowserEvent:function(a){var b,c,d,f,h=!1;return"click"===a.type&&(c=e(a,'[type="'+j+'"]'),b=e(a,'[data-target="click"]'),b&&c&&!b.hasClass(g)&&(d=this["action_"+b.attr("data-type")],d&&(f=k(b,c),d.call(this,f,b,c),h=!0))),h},action_like:function(a,b){var e,f,h=isNaN(a.likers)?0:a.likers;this.likeRequest||(d.mygrst("monitoring.likes.action_like"),a.like?(h+=1,d.mygrst("monitoring.likes.like"),l[a.type]&&d.myrb(l[a.type])):a.likers>0?(h-=1,d.mygrst("monitoring.likes.unlike")):h=0,a.like&&a.likers?(d.mygrst("monitoring.likes.liked"),e="Like"):a.like&&!a.likers?(d.mygrst("monitoring.likes.liked"),e="Like"):!a.like&&h?(d.mygrst("monitoring.likes.unliked"),e="Dislike"):(d.mygrst("monitoring.likes.unliked"),e="Dislike"),this.likeRequest=c.func("likes.like",function(){return{type:a.type,item:a.item,owner:a.owner,like:a.like}},{url:"/cgi-bin/my/ajax?user="+a.juser,type:"POST",context:this,success:function(c){var g;try{c=JSON.parse(c),"error"===c[2]||"invalid"===c[2]?this.revertLike(a):(g=b.parents("[data-dwh]"),g&&g.length&&"history"===a.from&&(f=g.data("dwh").split(":"),d.dwh({version:1,category:{"news-feed-actions":{UserID:f[0]||"0",Type:f[1],EvID:f[2],JournalID:f[3],ParentJournalID:f[4],ParentEvID:f[5],Action:e,IsRecommend:f[9]}}})),g=b.parents("[data-astat]"),g&&g.length&&"history"===a.from&&(f=g.data("astat").split(":"),d.astat({type:f[1],evid:f[2],action:e,version:"1",category:"news-feed-actions",actor_id:f[0]||"0",owner_id:f[3]||"0",parent_owner_id:f[4]||"0",parent_evid:f[5]||"0",create_time:f[8]||"0",is_recommend:f[9]})))}catch(a){}d.mygrst("monitoring.likes.action_liked")}.bind(this),error:function(){d.mygrst("monitoring.likes.xhrerror"),d.myrb(721691)},complete:function(){b.removeClass(g),b=null,a=null,delete this.likeRequest}},null,null,null,null,function(b){this.revertLike(a),b[2].indexOf("/cgi-bin/login")!==-1&&m()}.bind(this)),a.like=a.like?0:1,a.likers=h,this.updateLike(a))},action_showlikers:function(c,d){var e="data-likers-";b("product-tools/likers-popup",function(b){this.likersPopupInited||b.create().onLoad(a(".b-likers-popup")),b.show({type:d.attr(e+"type"),item:d.attr(e+"item"),juser:d.attr(e+"juser")})}.bind(this))},action_closelikers:function(){b("product-tools/likers-popup",function(a){a.hide()})},action_auth:function(){m()},updateLikeCount:function(b){var c,d=a('[data-like-id="'+b.item+"-"+b.owner+'"]');c=b.likers>99&&b.cutCounter?'<span class="b-like__button-counter__number">'+f.numberHumanFormat(Number(b.likers))+"</span>":0===b.likers?"":'<span class="b-like__button-counter__number">'+b.likers+"</span>",0===c.length?d.find('[data-type="counter"]').hide():d.find('[data-type="counter"]').show().html(c)},updateLike:function(b){var c=a('[data-like-id="'+b.item+"-"+b.owner+'"]');c.each(function(c,d){d=a(d);var e,f,g=d.find('[data-type="config"]'),j=d.find('[data-type="text"]'),k=d.find('[data-type="popup-text"]'),l=d.find(".b-like__users-list-you");d.trigger("likeChanged",[b.like]),g.length&&(e=JSON.parse(g.html()),e.like=b.like,e.likers=b.likers,this.updateLikeCount(b),j.html(e.states.nobody),e.popupStates&&k.html(e.like?e.popupStates.likeable:e.popupStates.notLikeable),d.removeClass(h).removeClass(i).addClass(e.like?h:i),g.html(JSON.stringify(e)),l.removeClass("ui-lazy-background")),d.get(0)&&d.get(0).like&&(f=d.get(0).tagName.toLowerCase(),"object"!==f&&"embed"!==f||d.get(0).like(b.like))}.bind(this))},revertLike:function(a){var b=a.like,c=a.likers;b?(b=0,c++):(b=1,c--),a.likers=c,a.like=b,this.updateLike(a)},reset:function(){this.action_closelikers(),this.likeRequest&&(this.likeRequest.abort(),delete this.likeRequest)}};return{create:function(){var a=Object.create(n);return a}}});