YUI.add("af-location-panel",function(e,t){"use strict";var a="displayState",n=!1,i="favorite",o="searchResults",s=null,l=!0;e.namespace("Af").LocationPanel=e.Base.create("AfLocationPanel",e.View,[],{autohide_timer:s,animation_timer:s,can_render:l,events:{".js-panel-trigger":{click:"toggle"},".Tooltip":{click:"handleClick",focus:"toggle",blur:"toggle"},".location-list-ta":{focus:function(){this.search_gui.addClass("Focused")},blur:function(){this.search_gui.removeClass("Focused")}}},i13n:{sec:"locpanl",bucket:0},input_node:s,keypress_event:s,keypress_throttle:s,list_item_height:0,list_node:s,list_template:"ape-location-templates-location-list",list_items:s,search_gui:s,model_loaded:n,model_bootstrap:{alias:"Locations",current:s,id:"location",favorite:s,user_crumb:s},panel_node:s,panel_template:"ape-location-templates-location-panel",tooltip_conf:{id:s,position:"bfr",container:s,classes:"ThemeReset Tooltip FancyBox Arrow Bgc-w Mt-10 Lh-14 Z-5 Pos-a Cur-a",contentClasses:"TooltipContent Pos-r js-location-panel",role:"popover",width:"250px",minWidth:"150px",autohide:!1},trigger_node:s,show_manage_link:l,search_type:null,initializer:function(t){var a=this;if(!t)return n;t.show_manage_link===n&&(a.show_manage_link=n),t.list_template&&(a.list_template=t.list_template),t.panel_template&&(a.panel_template=t.panel_template),t.user_crumb&&(t.i13n&&(a.i13n=e.merge(a.i13n,t.i13n)),t.hasOwnProperty("tooltip_conf")&&(a.tooltip_conf=e.merge(a.tooltip_conf,t.tooltip_conf)),!1!==t.useplus&&(t.useplus=!0),a.i18n=e.Af.Utils.i18n("ape-location/strings"),t.search_type&&"string"==typeof t.search_type&&""!==t.search_type&&(a.search_type=t.search_type),a.model_bootstrap=e.merge(a.model_bootstrap,t),a.render("location-panel",function(t,n){!t&&n&&(a.keypress_event=e.bind(a.handleKeypress,a),a.after("displayStateChange",a.resetView,a),a.search_gui=a.get("container").one(".LookupBox"))}),t.autoDetectLocation===l&&(a.lazyLoadLocationsModel(),a.getCurrentLocation(n)))},activatePanel:function(){var t=this;t.lazyLoadLocationsModel(),t.trigger_node.hasClass("active")||(t.trigger_node.addClass("active"),t.trigger_node.removeClass("C-2"),t.trigger_node.addClass("C-e"),t.handleTypeAhead({type:"focus"}),t.tooltip_conf.id=t.panel_node.generateID(),t.resetView(),e.Stencil.Tooltip("show",t.trigger_node,t.tooltip_conf),e.later(100,t,function(){e.UA.ios&&e.UA.ios>=8&&e.UA.safari||t.input_node.focus(),t.resizeResultsList(n)},n))},resizeResultsList:function(){var t=this;t.list_node&&(t.animation_timer&&t.animation_timer.cancel(),t.animation_timer=e.later(100,t,function(){var e=t.getResultsHeight();t.list_node.setStyles({height:e,opacity:1})},!1))},getResultsHeight:function(){var e,t=this,a=t.get("data"),n="0px";return!t.list_item_height&&t.list_items&&t.list_items.item&&t.list_items.item(0)&&(t.list_item_height=t.list_items.item(0).get("offsetHeight")),e=t.list_item_height,a&&(1===a.length?n=e+"px":2===a.length?n=2*e+"px":a.length>2&&(n=3*e+"px")),n},deactivatePanel:function(){var t=this;t.animation_timer&&t.animation_timer.cancel(),e.Stencil.Tooltip("hide",t.trigger_node),t.handleTypeAhead({type:"blur"}),t.trigger_node.removeClass("active"),t.trigger_node.removeClass("C-e"),t.trigger_node.addClass("C-2"),t.input_node.setContent(""),t.input_node.blur()},focusCurrentTypeaheadItem:function(e,t,a){if(e){if("up"===a)t=t<0?e.item(0):e.item(t-1);else{if(t>=e)return;t=e.item(t+1)}t&&t.one("a")&&t.one("a.js-ta-item").focus()}},handleClick:function(e){var t=e.target.ancestor(".js-location-select",l,"li"),a=e.target.ancestor(".js-location-detect",l,"button"),n=e.target.ancestor("a",l,"a"),i=this;if(n&&!n.hasClass("js-location-detect")){if(t){if(e.preventDefault(),n.hasClass("js-user-favorite"))return i.toggleFavoriteLocation(t,n);if(n.hasClass("js-ta-item"))return i.updateSelectedLocation(t)}}else a&&(e.preventDefault(),i.getCurrentLocation(l))},handleKeypress:function(t){var a,i,o,r=this,c=t.keyCode,d=t.target.ancestor(".location-list-ta",l,"input"),u=c&&40===c,p=c&&38===c,g=s;switch(!r.list_items&&r.list_node&&(r.list_items=r.list_node.all(".js-location-select")),g=r.list_items,r.keypress_throttle&&r.keypress_throttle.cancel(),t.type){case"keyup":if(27===c)return void r.toggle({type:"click"});32!==c&&13!==c||((o=t.target.ancestor("a",l,"a"))&&o.hasClass("js-ta-item")?(i=o,g&&i!==r.input_node&&(a=g.indexOf(i.ancestor("li.js-location-select",l,"li")))>=0&&(t.preventDefault(),r.updateSelectedLocation(g.item(a)))):o&&o.hasClass("remove-location")&&r.deleteLocation(o)),u||p||!d||(r.keypress_throttle=e.later(250,r,function(){r.handleSearch(t.target.get("value"))},n));break;case"keydown":g&&(p||u)&&(t.halt(),a=g.indexOf(t.target.ancestor("li.js-location-select")),r.focusCurrentTypeaheadItem(g,a,p===l?"up":"down"))}},handleSearch:function(t){var n=this,s=n.get(o),l={};if("string"!=typeof t||!t.length)return n.set(a,i);(t=e.Lang.trim(t)).length>2?s&&s.text===t?n.set(o,s):(l.text=t,n.search_type&&(l.type=n.search_type),n.get("model").search(l,function(e,t){!e&&t&&n.set(o,t)})):n.set(a,i)},handleTypeAhead:function(e){switch(e.type){case"focus":this.toggleInputListener(l);break;case"blur":this.toggleInputListener(n)}},lazyLoadLocationsModel:function(){var e=this;e.model_loaded||(e.model_loaded=l,e.loadModel(e.model_bootstrap,function(){"undefined"!=typeof e.model_bootstrap.show_favorite&&!0!==e.model_bootstrap.show_favorite||e.set(a,i,l)}))},loadModel:function(t,a){var n=t.alias,o=e.Mjata.ModelStore.getByAlias(n),s=this;o?(s.set("model",o),t.current&&o.setCurrent(t.current,l),t.favorite&&o.set(i,t.favorite,{silent:l}),s.syncLocationData()):(o=new e.Af.Locations(t),s.set("model",o),e.Mjata.ModelStore.alias(n,o)),e.Mjata.ModelStore.after("AfLocations:favoriteChange",s.syncLocationData,s),e.Lang.isFunction(a)&&a()},resetView:function(){this.can_render&&this.render("locations-list")},toggleFavoriteLocation:function(t,r){var c,d=r.getData(),u=t.getData(),p=e.Af.Utils.getObjectInArray(this.get("data"),"woeid",u.woeid),g=this;function _(e,t){
g.get("data")[e.index].type=t,g.resetView(),r.focus(),g.autohide_timer&&g.autohide_timer.cancel()}r.focus(),p&&p.data&&("remove"===d["user-action"]?g.get(a)===i?(g.can_render=n,g.get("model").deleteLocation(p.data,function(){g.panel_node.removeClass("animated"),g.animation_timer&&g.animation_timer.cancel(),g.autohide_timer&&g.autohide_timer.cancel(),t.transition({height:"0px",opacity:0,duration:.5},function(){t.remove(),e.UA.ios&&e.UA.ios>=8&&e.UA.safari||g.input_node.focus(),g.list_items=s,g.panel_node.addClass("animated"),g.can_render=l,g.resizeResultsList()}),g.set(o,null)})):g.get("model").deleteLocation(p.data,function(){_(p,"search")}):(c=p.data,g.get("model").createLocation(i,c,function(e,t){!e&&t&&_(p,i)})))},syncLocationData:function(){var e=this;e.get(a)===i&&(e.set("data",e.get("model").get(i)),e.resetView(),e.resizeResultsList())},getCurrentLocation:function(t){var a=this,i=a.model_bootstrap.glyphHook,o=i?{glyphHook:i}:s;a.get("model").getCurrentLocation(function(n){if(n){e.Af.Message.show(a.get("container").ancestor(".js-applet",l),{level:"error",token:n.message,content:n.message},o,"app");var i=a.getRapid();i&&i.beaconClick(a.i13n.sec,"dterr",1,e.merge(a.i13n,{mid:"locwgt"}))}t&&a.deactivatePanel()},n)},getRapid:function(){var t=e.Af.rapid;return(t&&"function"==typeof t.getRapidTracker?t.getRapidTracker():e.rapid)||null},render:function(t,a){var n,i=this;switch(t){case"location-panel":dust.render(i.panel_template,{i13n:i.i13n,i18n:i.i18n,show_manage_link:i.show_manage_link,lang:e.config.lang||"en-US",config:i.model_bootstrap},function(e,t){i.get("container").setContent(t),i.trigger_node=i.get("container").one(".js-panel-trigger"),i.panel_node=i.get("container").one(".js-location-panel"),i.input_node=i.get("container").one(".location-list-ta"),i.theForm=i.get("container").one(".js-location-panel-form"),i.theForm.on("submit",function(e){e.preventDefault()}),i.attachEvents(),a&&"function"==typeof a&&a(null,!0)});break;case"locations-list":i.list_node=i.get("container").one(".af-locations-list"),i.list_node&&(n={locations:i.get("data"),i13n:i.i13n,i18n:i.i18n},dust.render(i.list_template,{data:n,config:i.model_bootstrap},function(e,t){e||(i.list_node.setContent(t),t.length>0&&(i.list_items=i.list_node.all(".js-location-select")))}))}return this},updateSelectedLocation:function(t){var o,s,r=this;(o=t.getData())&&o.woeid&&(s=e.Af.Utils.getObjectInArray(r.get("data"),"woeid",o.woeid))&&s.data&&(r.get("model").updateLocation(s.data),r.autohide_timer=e.later(500,r,function(){r.deactivatePanel(),r.set(a,i,{silent:l}),r.input_node.set("value","")},n))},toggle:function(t){var a=this;if(a.trigger_node)switch(t.type){case"focus":a.autohide_timer&&a.autohide_timer.cancel(),a.activatePanel();break;case"blur":a.autohide_timer=e.later(500,a,function(){a.deactivatePanel()},n);break;case"click":a.panel_node&&a.trigger_node&&(a.trigger_node.hasClass("active")?a.deactivatePanel:a.activatePanel).apply(a)}},toggleInputListener:function(e){var t=this;e?(t.panel_node.on("keyup",t.keypress_event),t.panel_node.on("keydown",t.keypress_event)):(t.panel_node.detach("keyup",t.keypress_event),t.panel_node.detach("keydown",t.keypress_event))},getFavsList:function(){var t=this.get("model"),a=e.clone(t.get(i));this.set("data",a),this.panel_node.hasClass("D-n")||this.resizeResultsList(!1)}},{ATTRS:{container:{writeOnce:n},data:{},model:{},searchResults:{setter:function(e){e&&e.data&&e.data.length&&(this.set(a,"search"),this.set("data",e.data),this.resetView(),this.resizeResultsList())}},displayState:{setter:function(e,t,a){var n=this.get("model");"search"!==e&&n&&(a&&a.silent||this.getFavsList())}}}})},"@VERSION@",{langBundles:["strings"],requires:["view","mjata-model-store","af-config","af-message","af-locations","af-utils","ape-location-templates-location-list","ape-location-templates-location-panel","stencil-toggle","stencil-tooltip"]});