/*
 easyXDM
 http://easyxdm.net/
 Copyright(c) 2009, ï¿½?yvind Sean Kinsey, oyvind@kinsey.no.

 Permission is hereby granted, free of charge, to any person obtaining a copy
 of this software and associated documentation files (the "Software"), to deal
 in the Software without restriction, including without limitation the rights
 to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
 copies of the Software, and to permit persons to whom the Software is
 furnished to do so, subject to the following conditions:

 The above copyright notice and this permission notice shall be included in
 all copies or substantial portions of the Software.

 THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
 AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
 LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
 OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN
 THE SOFTWARE.
	SWFObject v2.2 <http://code.google.com/p/swfobject/>
 is released under the MIT License <http://www.opensource.org/licenses/mit-license.php> 
*/
window._JSON = function() {
  function f(n) {
    return n < 10 ? "0" + n : n
  }
  function thisDateToJSON(key) {
    return isFinite(this.valueOf()) ? this.getUTCFullYear() + "-" + f(this.getUTCMonth() + 1) + "-" + f(this.getUTCDate()) + "T" + f(this.getUTCHours()) + ":" + f(this.getUTCMinutes()) + ":" + f(this.getUTCSeconds()) + "Z" : null
  }
  function thisValueOf(key) {
    return this.valueOf()
  }
  var cx = /[\u0000\u00ad\u0600-\u0604\u070f\u17b4\u17b5\u200c-\u200f\u2028-\u202f\u2060-\u206f\ufeff\ufff0-\uffff]/g, escapable = /[\\\"\x00-\x1f\x7f-\x9f\u00ad\u0600-\u0604\u070f\u17b4\u17b5\u200c-\u200f\u2028-\u202f\u2060-\u206f\ufeff\ufff0-\uffff]/g, gap, indent, meta = {"\b":"\\b", "\t":"\\t", "\n":"\\n", "\f":"\\f", "\r":"\\r", '"':'\\"', "\\":"\\\\"}, rep;
  function quote(string) {
    escapable.lastIndex = 0;
    return escapable.test(string) ? '"' + string.replace(escapable, function(a) {
      var c = meta[a];
      return typeof c === "string" ? c : "\\u" + ("0000" + a.charCodeAt(0).toString(16)).slice(-4)
    }) + '"' : '"' + string + '"'
  }
  function str(key, holder) {
    var i, k, v, length, mind = gap, partial, value = holder[key];
    if(value && typeof value === "object") {
      if(value instanceof Date) {
        value = thisDateToJSON.call(value)
      }else {
        if(value instanceof String || value instanceof Number || value instanceof Boolean) {
          value = thisValueOf.call(value)
        }
      }
    }
    if(typeof rep === "function") {
      value = rep.call(holder, key, value)
    }
    switch(typeof value) {
      case "string":
        return quote(value);
      case "number":
        return isFinite(value) ? String(value) : "null";
      case "boolean":
      ;
      case "null":
        return String(value);
      case "object":
        if(!value) {
          return"null"
        }
        gap += indent;
        partial = [];
        if(Object.prototype.toString.apply(value) === "[object Array]") {
          length = value.length;
          for(i = 0;i < length;i += 1) {
            partial[i] = str(i, value) || "null"
          }
          v = partial.length === 0 ? "[]" : gap ? "[\n" + gap + partial.join(",\n" + gap) + "\n" + mind + "]" : "[" + partial.join(",") + "]";
          gap = mind;
          return v
        }
        if(rep && typeof rep === "object") {
          length = rep.length;
          for(i = 0;i < length;i += 1) {
            if(typeof rep[i] === "string") {
              k = rep[i];
              v = str(k, value);
              if(v) {
                partial.push(quote(k) + (gap ? ": " : ":") + v)
              }
            }
          }
        }else {
          for(k in value) {
            if(Object.prototype.hasOwnProperty.call(value, k)) {
              v = str(k, value);
              if(v) {
                partial.push(quote(k) + (gap ? ": " : ":") + v)
              }
            }
          }
        }
        v = partial.length === 0 ? "{}" : gap ? "{\n" + gap + partial.join(",\n" + gap) + "\n" + mind + "}" : "{" + partial.join(",") + "}";
        gap = mind;
        return v
    }
  }
  return{stringify:function(value, replacer, space) {
    var i;
    gap = "";
    indent = "";
    if(typeof space === "number") {
      for(i = 0;i < space;i += 1) {
        indent += " "
      }
    }else {
      if(typeof space === "string") {
        indent = space
      }
    }
    rep = replacer;
    if(replacer && typeof replacer !== "function" && (typeof replacer !== "object" || typeof replacer.length !== "number")) {
      throw new Error("JSON.stringify");
    }
    return str("", {"":value})
  }, parse:function(text, reviver) {
    var j;
    function walk(holder, key) {
      var k, v, value = holder[key];
      if(value && typeof value === "object") {
        for(k in value) {
          if(Object.prototype.hasOwnProperty.call(value, k)) {
            v = walk(value, k);
            if(v !== undefined) {
              value[k] = v
            }else {
              delete value[k]
            }
          }
        }
      }
      return reviver.call(holder, key, value)
    }
    text = String(text);
    cx.lastIndex = 0;
    if(cx.test(text)) {
      text = text.replace(cx, function(a) {
        return"\\u" + ("0000" + a.charCodeAt(0).toString(16)).slice(-4)
      })
    }
    if(/^[\],:{}\s]*$/.test(text.replace(/\\(?:["\\\/bfnrt]|u[0-9a-fA-F]{4})/g, "@").replace(/"[^"\\\n\r]*"|true|false|null|-?\d+(?:\.\d*)?(?:[eE][+\-]?\d+)?/g, "]").replace(/(?:^|:|,)(?:\s*\[)+/g, ""))) {
      j = eval("(" + text + ")");
      return typeof reviver === "function" ? walk({"":j}, "") : j
    }
    throw new SyntaxError("JSON.parse");
  }}
}();
(function(window, document, location, setTimeout, decodeURIComponent, encodeURIComponent) {
  if("easyXDM" in window) {
    return
  }
  var global = this;
  var channelId = 0;
  var emptyFn = Function.prototype;
  var reURI = /^(http.?:\/\/([^\/\s]+))/;
  var reParent = /[\-\w]+\/\.\.\//;
  var reDoubleSlash = /([^:])\/\//g;
  var IFRAME_PREFIX = "easyXDM_";
  var HAS_NAME_PROPERTY_BUG;
  function isHostMethod(object, property) {
    var t = typeof object[property];
    return t == "function" || !!(t == "object" && object[property]) || t == "unknown"
  }
  function isHostObject(object, property) {
    return!!(typeof object[property] == "object" && object[property])
  }
  function isArray(o) {
    return Object.prototype.toString.call(o) === "[object Array]"
  }
  var on, un;
  if(isHostMethod(window, "addEventListener")) {
    on = function(target, type, listener) {
      target.addEventListener(type, listener, false)
    };
    un = function(target, type, listener) {
      target.removeEventListener(type, listener, false)
    }
  }else {
    if(isHostMethod(window, "attachEvent")) {
      on = function(object, sEvent, fpNotify) {
        object.attachEvent("on" + sEvent, fpNotify)
      };
      un = function(object, sEvent, fpNotify) {
        object.detachEvent("on" + sEvent, fpNotify)
      }
    }else {
      throw new Error("Browser not supported");
    }
  }
  var isReady = false, domReadyQueue = [];
  if("readyState" in document) {
    isReady = document.readyState == "complete" || document.readyState == "interactive"
  }else {
    if(document.body) {
      isReady = true
    }
  }
  function dom_onReady() {
    dom_onReady = emptyFn;
    isReady = true;
    for(var i = 0;i < domReadyQueue.length;i++) {
      domReadyQueue[i]()
    }
    domReadyQueue.length = 0
  }
  if(!isReady) {
    if(isHostMethod(window, "addEventListener")) {
      on(document, "DOMContentLoaded", dom_onReady)
    }else {
      on(document, "readystatechange", function() {
        if(document.readyState == "complete") {
          dom_onReady()
        }
      });
      if(document.documentElement.doScroll && window === top) {
        (function doScrollCheck() {
          if(isReady) {
            return
          }
          try {
            document.documentElement.doScroll("left")
          }catch(e) {
            setTimeout(doScrollCheck, 1);
            return
          }
          dom_onReady()
        })()
      }
    }
    on(window, "load", dom_onReady)
  }
  function whenReady(fn, scope) {
    if(isReady) {
      fn.call(scope);
      return
    }
    domReadyQueue.push(function() {
      fn.call(scope)
    })
  }
  function getDomainName(url) {
    return url.match(reURI)[2]
  }
  function getLocation(url) {
    return url.match(reURI)[1]
  }
  function resolveUrl(url) {
    url = url.replace(reDoubleSlash, "$1/");
    if(!url.match(/^(http||https):\/\//)) {
      var path = url.substring(0, 1) === "/" ? "" : location.pathname;
      if(path.substring(path.length - 1) !== "/") {
        path = path.substring(0, path.lastIndexOf("/") + 1)
      }
      url = location.protocol + "//" + location.host + path + url
    }
    while(reParent.test(url)) {
      url = url.replace(reParent, "")
    }
    return url
  }
  function appendQueryParameters(url, parameters) {
    var hash = "", indexOf = url.indexOf("#");
    if(indexOf !== -1) {
      hash = url.substring(indexOf);
      url = url.substring(0, indexOf)
    }
    var q = [];
    for(var key in parameters) {
      if(parameters.hasOwnProperty(key)) {
        q.push(key + "=" + encodeURIComponent(parameters[key]))
      }
    }
    return url + (url.indexOf("?") === -1 ? "?" : "&") + q.join("&") + hash
  }
  var query = function() {
    var query = {}, pair, search = location.search.substring(1).split("&"), i = search.length;
    while(i--) {
      pair = search[i].split("=");
      try {
        query[pair[0]] = decodeURIComponent(pair[1])
      }catch(e) {
      }
    }
    return query
  }();
  function undef(v) {
    return typeof v === "undefined"
  }
  var getJSON_initTS = Math.floor(new Date / 1E3), getJSON_lastTS = getJSON_initTS, getJSON_loadedTS = 0, getJSON_useCounter = 0, getJSON_nativeIsBroken = false, getJSON_testStringify = document.location.hostname.indexOf("my.mail.ru") > -1;
  function getJSON() {
    if(window.JSON && window.JSON.stringify(["a"]) === '["a"]') {
      return{stringify:function() {
        if(getJSON_testStringify) {
          var now = Math.floor(new Date / 1E3);
          getJSON_useCounter++;
          getJSON_nativeIsBroken = window.JSON.stringify(["a"]) != '["a"]';
          if(getJSON_nativeIsBroken) {
            getJSON_testStringify = false
          }else {
            if(document.readyState == "complete" && !getJSON_loadedTS) {
              getJSON_loadedTS = now
            }
          }
          getJSON_lastTS = now
        }
        return getJSON_nativeIsBroken ? window._JSON.stringify.apply(window._JSON, arguments) : window.JSON.stringify.apply(window.JSON, arguments)
      }, parse:function() {
        return window.JSON.parse.apply(window.JSON, arguments)
      }}
    }else {
      return window._JSON
    }
    var cached = {};
    var obj = {a:[1, 2, 3]}, json = '{"a":[1,2,3]}';
    if(JSON && typeof JSON.stringify === "function" && JSON.stringify(obj).replace(/\s/g, "") === json) {
      return JSON
    }
    if(Object.toJSON) {
      if(Object.toJSON(obj).replace(/\s/g, "") === json) {
        cached.stringify = Object.toJSON
      }
    }
    if(typeof String.prototype.evalJSON === "function") {
      obj = json.evalJSON();
      if(obj.a && obj.a.length === 3 && obj.a[2] === 3) {
        cached.parse = function(str) {
          return str.evalJSON()
        }
      }
    }
    if(cached.stringify && cached.parse) {
      getJSON = function() {
        return cached
      };
      return cached
    }
    return null
  }
  function apply(destination, source, noOverwrite) {
    var member;
    for(var prop in source) {
      if(source.hasOwnProperty(prop)) {
        if(prop in destination) {
          member = source[prop];
          if(typeof member === "object") {
            apply(destination[prop], member, noOverwrite)
          }else {
            if(!noOverwrite) {
              destination[prop] = source[prop]
            }
          }
        }else {
          destination[prop] = source[prop]
        }
      }
    }
    return destination
  }
  function testForNamePropertyBug() {
    var el = document.createElement("iframe");
    el.name = "easyXDM_TEST";
    apply(el.style, {position:"absolute", left:"-2000px", top:"0px"});
    document.body.appendChild(el);
    HAS_NAME_PROPERTY_BUG = !(el.contentWindow === window.frames[el.name]);
    document.body.removeChild(el)
  }
  function createFrame(config) {
    if(undef(HAS_NAME_PROPERTY_BUG)) {
      testForNamePropertyBug()
    }
    var frame;
    if(HAS_NAME_PROPERTY_BUG) {
      frame = document.createElement('<iframe name="' + config.props.name + '"/>')
    }else {
      frame = document.createElement("IFRAME");
      frame.name = config.props.name
    }
    frame.id = frame.name = config.props.name;
    delete config.props.name;
    if(config.onLoad) {
      on(frame, "load", config.onLoad)
    }
    if(typeof config.container == "string") {
      config.container = document.getElementById(config.container)
    }
    if(!config.container) {
      frame.style.position = "absolute";
      frame.style.left = "-2000px";
      frame.style.top = "0px";
      config.container = document.body
    }
    frame.border = frame.frameBorder = 0;
    config.container.insertBefore(frame, config.container.firstChild);
    if(config.onLoadSrc) {
      on(frame, "load", function() {
        if(frame.src) {
          config.onLoadSrc && config.onLoadSrc(frame)
        }
      })
    }
    apply(frame, config.props);
    return frame
  }
  function checkAcl(acl, domain) {
    if(typeof acl == "string") {
      acl = [acl]
    }
    var re, i = acl.length;
    while(i--) {
      re = acl[i];
      re = new RegExp(re.substr(0, 1) == "^" ? re : "^" + re.replace(/(\*)/g, ".$1").replace(/\?/g, ".") + "$");
      if(re.test(domain)) {
        return true
      }
    }
    return false
  }
  function prepareTransportStack(config) {
    var protocol = config.protocol, stackEls;
    config.isHost = config.isHost || undef(query.xdm_p);
    if(!config.props) {
      config.props = {}
    }
    if(!config.isHost) {
      config.channel = query.xdm_c;
      config.secret = query.xdm_s;
      config.remote = query.xdm_e;
      protocol = query.xdm_p;
      if(config.acl && !checkAcl(config.acl, config.remote)) {
        throw new Error("Access denied for " + config.remote);
      }
    }else {
      config.remote = resolveUrl(config.remote);
      config.channel = config.channel || "default" + channelId++;
      config.secret = Math.random().toString(16).substring(2);
      if(undef(protocol)) {
        if(getLocation(location.href) == getLocation(config.remote)) {
          protocol = "4"
        }else {
          if(isHostMethod(window, "postMessage") || isHostMethod(document, "postMessage")) {
            protocol = "1"
          }else {
            if(isHostMethod(window, "ActiveXObject") && isHostMethod(window, "execScript")) {
              protocol = "3"
            }else {
              if(navigator.product === "Gecko" && "frameElement" in window && navigator.userAgent.indexOf("WebKit") == -1) {
                protocol = "5"
              }else {
                if(config.remoteHelper) {
                  config.remoteHelper = resolveUrl(config.remoteHelper);
                  protocol = "2"
                }else {
                  protocol = "0"
                }
              }
            }
          }
        }
      }
    }
    switch(protocol) {
      case "0":
        apply(config, {interval:100, delay:2E3, useResize:true, useParent:false, usePolling:false}, true);
        if(config.isHost) {
          if(!config.local) {
            var domain = location.protocol + "//" + location.host, images = document.body.getElementsByTagName("img"), image;
            var i = images.length;
            while(i--) {
              image = images[i];
              if(image.src.substring(0, domain.length) === domain) {
                config.local = image.src;
                break
              }
            }
            if(!config.local) {
              config.local = window
            }
          }
          var parameters = {xdm_c:config.channel, xdm_p:0};
          if(config.local === window) {
            config.usePolling = true;
            config.useParent = true;
            config.local = location.protocol + "//" + location.host + location.pathname + location.search;
            parameters.xdm_e = config.local;
            parameters.xdm_pa = 1
          }else {
            parameters.xdm_e = resolveUrl(config.local)
          }
          if(config.container) {
            config.useResize = false;
            parameters.xdm_po = 1
          }
          config.remote = appendQueryParameters(config.remote, parameters)
        }else {
          apply(config, {channel:query.xdm_c, remote:query.xdm_e, useParent:!undef(query.xdm_pa), usePolling:!undef(query.xdm_po), useResize:config.useParent ? false : config.useResize})
        }
        stackEls = [new easyXDM.stack.HashTransport(config), new easyXDM.stack.ReliableBehavior({}), new easyXDM.stack.QueueBehavior({encode:true, maxLength:4E3 - config.remote.length}), new easyXDM.stack.VerifyBehavior({initiate:config.isHost})];
        break;
      case "1":
        stackEls = [new easyXDM.stack.PostMessageTransport(config)];
        break;
      case "2":
        stackEls = [new easyXDM.stack.NameTransport(config), new easyXDM.stack.QueueBehavior, new easyXDM.stack.VerifyBehavior({initiate:config.isHost})];
        break;
      case "3":
        stackEls = [new easyXDM.stack.NixTransport(config)];
        break;
      case "4":
        stackEls = [new easyXDM.stack.SameOriginTransport(config)];
        break;
      case "5":
        stackEls = [new easyXDM.stack.FrameElementTransport(config)];
        break
    }
    stackEls.push(new easyXDM.stack.QueueBehavior({lazy:config.lazy, remove:true}));
    return stackEls
  }
  function chainStack(stackElements) {
    var stackEl, defaults = {incoming:function(message, origin) {
      this.up.incoming(message, origin)
    }, outgoing:function(message, recipient) {
      this.down.outgoing(message, recipient)
    }, callback:function(success) {
      this.up.callback(success)
    }, init:function() {
      this.down.init()
    }, destroy:function() {
      this.down.destroy()
    }};
    for(var i = 0, len = stackElements.length;i < len;i++) {
      stackEl = stackElements[i];
      apply(stackEl, defaults, true);
      if(i !== 0) {
        stackEl.down = stackElements[i - 1]
      }
      if(i !== len - 1) {
        stackEl.up = stackElements[i + 1]
      }
    }
    return stackEl
  }
  function removeFromStack(element) {
    element.up.down = element.down;
    element.down.up = element.up;
    element.up = element.down = null
  }
  global.easyXDM = {version:"2.4.9.102", query:query, stack:{}, apply:apply, getJSONObject:getJSON, whenReady:whenReady};
  easyXDM.DomHelper = {on:on, un:un, requiresJSON:function(path) {
    if(!isHostObject(window, "JSON")) {
      document.write('<script type="text/javascript" src="' + path + '">\x3c/script>')
    }
  }};
  (function() {
    var _map = {};
    easyXDM.Fn = {set:function(name, fn) {
      _map[name] = fn
    }, get:function(name, del) {
      var fn = _map[name];
      if(del) {
        delete _map[name]
      }
      return fn
    }}
  })();
  easyXDM.Socket = function(config) {
    var stack = chainStack(prepareTransportStack(config).concat([{incoming:function(message, origin) {
      config.onMessage(message, origin)
    }, callback:function(success) {
      if(config.onReady) {
        config.onReady(success)
      }
    }}])), recipient = getLocation(config.remote);
    this.origin = getLocation(config.remote);
    this.destroy = function() {
      stack.destroy()
    };
    this.postMessage = function(message) {
      stack.outgoing(message, recipient)
    };
    stack.init()
  };
  easyXDM.Rpc = function(config, jsonRpcConfig) {
    if(jsonRpcConfig.local) {
      for(var method in jsonRpcConfig.local) {
        if(jsonRpcConfig.local.hasOwnProperty(method)) {
          var member = jsonRpcConfig.local[method];
          if(typeof member === "function") {
            jsonRpcConfig.local[method] = {method:member}
          }
        }
      }
    }
    var stack = chainStack(prepareTransportStack(config).concat([new easyXDM.stack.RpcBehavior(this, jsonRpcConfig), {callback:function(success) {
      if(config.onReady) {
        config.onReady(success)
      }
    }}]));
    this.origin = getLocation(config.remote);
    this.destroy = function() {
      stack.destroy()
    };
    this.__position = function(p) {
      var st = stack;
      while(st.down) {
        st = st.down
      }
      st.__move(p.left, p.top, p.right, p.bottom);
      st.__size(p.width, p.height, p.zi, p.pos)
    };
    this.__back = function() {
      var st = stack;
      while(st.down) {
        st = st.down
      }
      st.__back()
    };
    this.refreshFrame = function() {
      var st = stack;
      while(st.down) {
        st = st.down
      }
      st.refreshFrame && st.refreshFrame()
    };
    stack.init()
  };
  easyXDM.stack.SameOriginTransport = function(config) {
    var pub, frame, send, targetOrigin;
    var __back;
    return pub = {outgoing:function(message, domain, fn) {
      send(message);
      if(fn) {
        fn()
      }
    }, destroy:function() {
      if(frame) {
        frame.parentNode.removeChild(frame);
        frame = null
      }
    }, __move:function(l, t, r, b) {
      if(frame) {
        __back || (__back = frame.style.cssText);
        r && (frame.style.right = r);
        b && (frame.style.bottom = b);
        l && (frame.style.left = l);
        t && (frame.style.top = t)
      }
    }, __size:function(w, h, zi, p) {
      if(frame) {
        __back || (__back = frame.style.cssText);
        w && (frame.style.width = w);
        h && (frame.style.height = h);
        zi && (frame.style.zIndex = zi);
        p && (frame.style.position = p)
      }
    }, __back:function() {
      frame && __back && (frame.style.cssText = __back)
    }, refreshFrame:function() {
      frame && (frame.src = frame.src)
    }, onDOMReady:function() {
      targetOrigin = getLocation(config.remote);
      if(config.isHost) {
        apply(config.props, {src:appendQueryParameters(config.remote, {xdm_e:location.protocol + "//" + location.host + location.pathname, xdm_c:config.channel, xdm_p:4}), name:IFRAME_PREFIX + config.channel + "_provider"});
        frame = createFrame(config);
        easyXDM.Fn.set(config.channel, function(sendFn) {
          send = sendFn;
          setTimeout(function() {
            pub.up.callback(true)
          }, 0);
          return function(msg) {
            pub.up.incoming(msg, targetOrigin)
          }
        })
      }else {
        send = parent.easyXDM.Fn.get(config.channel, true)(function(msg) {
          pub.up.incoming(msg, targetOrigin)
        });
        setTimeout(function() {
          pub.up.callback(true)
        }, 0)
      }
    }, init:function() {
      whenReady(pub.onDOMReady, pub)
    }}
  };
  easyXDM.stack.PostMessageTransport = function(config) {
    var pub, frame, callerWindow, targetOrigin;
    function _getOrigin(event) {
      if(event.origin) {
        return event.origin
      }
      if(event.uri) {
        return getLocation(event.uri)
      }
      if(event.domain) {
        return location.protocol + "//" + event.domain
      }
      throw"Unable to retrieve the origin of the event";
    }
    function _window_onMessage(event) {
      var origin = _getOrigin(event);
      if(origin == targetOrigin && event.data.substring(0, config.channel.length + 1) == config.channel + " ") {
        var cb = function() {
          pub.up.incoming(event.data.substring(config.channel.length + 1), origin)
        };
        window.WebAgent ? WebAgent.util.Mnt.wrapTryCatch(cb) : cb()
      }
    }
    var __back;
    return pub = {outgoing:function(message, domain, fn) {
      callerWindow.postMessage(config.channel + " " + message, domain || targetOrigin);
      if(fn) {
        fn()
      }
    }, destroy:function() {
      un(window, "message", _window_onMessage);
      if(frame) {
        callerWindow = null;
        frame.parentNode.removeChild(frame);
        frame = null
      }
    }, __move:function(l, t, r, b) {
      if(frame) {
        __back || (__back = frame.style.cssText);
        r && (frame.style.right = r);
        b && (frame.style.bottom = b);
        l && (frame.style.left = l);
        t && (frame.style.top = t)
      }
    }, __size:function(w, h, zi, p) {
      if(frame) {
        __back || (__back = frame.style.cssText);
        w && (frame.style.width = w);
        h && (frame.style.height = h);
        zi && (frame.style.zIndex = zi);
        p && (frame.style.position = p)
      }
    }, __back:function() {
      frame && __back && (frame.style.cssText = __back)
    }, refreshFrame:function() {
      frame && (frame.src = frame.src)
    }, onDOMReady:function() {
      targetOrigin = getLocation(config.remote);
      if(config.isHost) {
        on(window, "message", function waitForReady(event) {
          if(event.data == config.channel + "-ready") {
            callerWindow = "postMessage" in frame.contentWindow ? frame.contentWindow : frame.contentWindow.document;
            un(window, "message", waitForReady);
            on(window, "message", _window_onMessage);
            setTimeout(function() {
              pub.up.callback(true)
            }, 0)
          }
        });
        apply(config.props, {src:appendQueryParameters(config.remote, {xdm_e:location.protocol + "//" + location.host, xdm_c:config.channel, xdm_p:1}), name:IFRAME_PREFIX + config.channel + "_provider"});
        frame = createFrame(config)
      }else {
        on(window, "message", _window_onMessage);
        callerWindow = "postMessage" in window.parent ? window.parent : window.parent.document;
        callerWindow.postMessage(config.channel + "-ready", targetOrigin);
        setTimeout(function() {
          pub.up.callback(true)
        }, 0)
      }
    }, init:function() {
      whenReady(pub.onDOMReady, pub)
    }}
  };
  easyXDM.stack.FrameElementTransport = function(config) {
    var pub, frame, send, targetOrigin;
    var __back;
    return pub = {outgoing:function(message, domain, fn) {
      send.call(this, message);
      if(fn) {
        fn()
      }
    }, destroy:function() {
      if(frame) {
        frame.parentNode.removeChild(frame);
        frame = null
      }
    }, __move:function(l, t, r, b) {
      if(frame) {
        __back || (__back = frame.style.cssText);
        r && (frame.style.right = r);
        b && (frame.style.bottom = b);
        l && (frame.style.left = l);
        t && (frame.style.top = t)
      }
    }, __size:function(w, h, zi, p) {
      if(frame) {
        __back || (__back = frame.style.cssText);
        w && (frame.style.width = w);
        h && (frame.style.height = h);
        zi && (frame.style.zIndex = zi);
        p && (frame.style.position = p)
      }
    }, __back:function() {
      frame && __back && (frame.style.cssText = __back)
    }, refreshFrame:function() {
      frame && (frame.src = frame.src)
    }, onDOMReady:function() {
      targetOrigin = getLocation(config.remote);
      if(config.isHost) {
        apply(config.props, {src:appendQueryParameters(config.remote, {xdm_e:location.protocol + "//" + location.host + location.pathname + location.search, xdm_c:config.channel, xdm_p:5}), name:IFRAME_PREFIX + config.channel + "_provider"});
        frame = createFrame(config);
        frame.fn = function(sendFn) {
          delete frame.fn;
          send = sendFn;
          setTimeout(function() {
            pub.up.callback(true)
          }, 0);
          return function(msg) {
            pub.up.incoming(msg, targetOrigin)
          }
        }
      }else {
        if(document.referrer && document.referrer != query.xdm_e) {
          window.parent.location = query.xdm_e
        }else {
          if(document.referrer != query.xdm_e) {
            window.parent.location = query.xdm_e
          }
          send = window.frameElement.fn(function(msg) {
            pub.up.incoming(msg, targetOrigin)
          });
          pub.up.callback(true)
        }
      }
    }, init:function() {
      whenReady(pub.onDOMReady, pub)
    }}
  };
  easyXDM.stack.NixTransport = function(config) {
    var pub, frame, send, targetOrigin, proxy;
    var __back;
    return pub = {outgoing:function(message, domain, fn) {
      send(message);
      if(fn) {
        fn()
      }
    }, destroy:function() {
      proxy = null;
      if(frame) {
        frame.parentNode.removeChild(frame);
        frame = null
      }
    }, __move:function(l, t, r, b) {
      if(frame) {
        __back || (__back = frame.style.cssText);
        r && (frame.style.right = r);
        b && (frame.style.bottom = b);
        l && (frame.style.left = l);
        t && (frame.style.top = t)
      }
    }, __size:function(w, h, zi, p) {
      if(frame) {
        __back || (__back = frame.style.cssText);
        w && (frame.style.width = w);
        h && (frame.style.height = h);
        zi && (frame.style.zIndex = zi);
        p && (frame.style.position = p)
      }
    }, __back:function() {
      frame && __back && (frame.style.cssText = __back)
    }, refreshFrame:function() {
      frame && (frame.src = frame.src)
    }, onDOMReady:function() {
      targetOrigin = getLocation(config.remote);
      if(config.isHost) {
        try {
          if(!isHostMethod(window, "getNixProxy")) {
            window.execScript("Class NixProxy\n" + "    Private m_parent, m_child, m_Auth\n" + "\n" + "    Public Sub SetParent(obj, auth)\n" + "        If isEmpty(m_Auth) Then m_Auth = auth\n" + "        SET m_parent = obj\n" + "    End Sub\n" + "    Public Sub SetChild(obj)\n" + "        SET m_child = obj\n" + "        m_parent.ready()\n" + "    End Sub\n" + "\n" + "    Public Sub SendToParent(data, auth)\n" + "        If m_Auth = auth Then m_parent.send(CStr(data))\n" + "    End Sub\n" + "    Public Sub SendToChild(data, auth)\n" + 
            "        If m_Auth = auth Then m_child.send(CStr(data))\n" + "    End Sub\n" + "End Class\n" + "Function getNixProxy()\n" + "    Set GetNixProxy = New NixProxy\n" + "End Function\n", "vbscript")
          }
          proxy = getNixProxy();
          proxy.SetParent({send:function(msg) {
            pub.up.incoming(msg, targetOrigin)
          }, ready:function() {
            setTimeout(function() {
              pub.up.callback(true)
            }, 0)
          }}, config.secret);
          send = function(msg) {
            proxy.SendToChild(msg, config.secret)
          }
        }catch(e1) {
          throw new Error("Could not set up VBScript NixProxy:" + e1.message);
        }
        apply(config.props, {src:appendQueryParameters(config.remote, {xdm_e:location.protocol + "//" + location.host + location.pathname + location.search, xdm_c:config.channel, xdm_s:config.secret, xdm_p:3}), name:IFRAME_PREFIX + config.channel + "_provider"});
        frame = createFrame(config);
        frame.contentWindow.opener = proxy
      }else {
        if(document.referrer && document.referrer != query.xdm_e) {
          window.parent.location = query.xdm_e
        }else {
          if(document.referrer != query.xdm_e) {
            window.parent.location = query.xdm_e
          }
          try {
            proxy = window.opener
          }catch(e2) {
            throw new Error("Cannot access window.opener");
          }
          proxy.SetChild({send:function(msg) {
            global.setTimeout(function() {
              pub.up.incoming(msg, targetOrigin)
            }, 0)
          }});
          send = function(msg) {
            proxy.SendToParent(msg, config.secret)
          };
          setTimeout(function() {
            pub.up.callback(true)
          }, 0)
        }
      }
    }, init:function() {
      whenReady(pub.onDOMReady, pub)
    }}
  };
  easyXDM.stack.NameTransport = function(config) {
    var pub;
    var isHost, callerWindow, remoteWindow, readyCount, callback, remoteOrigin, remoteUrl;
    function _sendMessage(message) {
      var url = config.remoteHelper + (isHost ? "#_3" : "#_2") + config.channel;
      callerWindow.contentWindow.sendMessage(message, url)
    }
    function _onReady() {
      if(isHost) {
        if(++readyCount === 2 || !isHost) {
          pub.up.callback(true)
        }
      }else {
        _sendMessage("ready");
        pub.up.callback(true)
      }
    }
    function _onMessage(message) {
      pub.up.incoming(message, remoteOrigin)
    }
    function _onLoad() {
      if(callback) {
        setTimeout(function() {
          callback(true)
        }, 0)
      }
    }
    return pub = {outgoing:function(message, domain, fn) {
      callback = fn;
      _sendMessage(message)
    }, destroy:function() {
      callerWindow.parentNode.removeChild(callerWindow);
      callerWindow = null;
      if(isHost) {
        remoteWindow.parentNode.removeChild(remoteWindow);
        remoteWindow = null
      }
    }, onDOMReady:function() {
      isHost = config.isHost;
      readyCount = 0;
      remoteOrigin = getLocation(config.remote);
      config.local = resolveUrl(config.local);
      if(isHost) {
        easyXDM.Fn.set(config.channel, function(message) {
          if(isHost && message === "ready") {
            easyXDM.Fn.set(config.channel, _onMessage);
            _onReady()
          }
        });
        remoteUrl = appendQueryParameters(config.remote, {xdm_e:config.local, xdm_c:config.channel, xdm_p:2});
        apply(config.props, {src:remoteUrl + "#" + config.channel, name:IFRAME_PREFIX + config.channel + "_provider"});
        remoteWindow = createFrame(config)
      }else {
        config.remoteHelper = config.remote;
        easyXDM.Fn.set(config.channel, _onMessage)
      }
      callerWindow = createFrame({props:{src:config.local + "#_4" + config.channel}, onLoad:function onLoad() {
        un(callerWindow, "load", onLoad);
        easyXDM.Fn.set(config.channel + "_load", _onLoad);
        (function test() {
          if(typeof callerWindow.contentWindow.sendMessage == "function") {
            _onReady()
          }else {
            setTimeout(test, 50)
          }
        })()
      }})
    }, init:function() {
      whenReady(pub.onDOMReady, pub)
    }}
  };
  easyXDM.stack.HashTransport = function(config) {
    var pub;
    var me = this, isHost, _timer, pollInterval, _lastMsg, _msgNr, _listenerWindow, _callerWindow;
    var useParent, _remoteOrigin;
    function _sendMessage(message) {
      if(!_callerWindow) {
        return
      }
      var url = config.remote + "#" + _msgNr++ + "_" + message;
      (isHost || !useParent ? _callerWindow.contentWindow : _callerWindow).location = url
    }
    function _handleHash(hash) {
      _lastMsg = hash;
      pub.up.incoming(_lastMsg.substring(_lastMsg.indexOf("_") + 1), _remoteOrigin)
    }
    function _pollHash() {
      if(!_listenerWindow) {
        return
      }
      var href = _listenerWindow.location.href, hash = "", indexOf = href.indexOf("#");
      if(indexOf != -1) {
        hash = href.substring(indexOf)
      }
      if(hash && hash != _lastMsg) {
        _handleHash(hash)
      }
    }
    function _attachListeners() {
      _timer = setInterval(_pollHash, pollInterval)
    }
    return pub = {outgoing:function(message, domain) {
      _sendMessage(message)
    }, destroy:function() {
      window.clearInterval(_timer);
      if(isHost || !useParent) {
        _callerWindow.parentNode.removeChild(_callerWindow)
      }
      _callerWindow = null
    }, onDOMReady:function() {
      isHost = config.isHost;
      pollInterval = config.interval;
      _lastMsg = "#" + config.channel;
      _msgNr = 0;
      useParent = config.useParent;
      _remoteOrigin = getLocation(config.remote);
      if(isHost) {
        config.props = {src:config.remote, name:IFRAME_PREFIX + config.channel + "_provider"};
        if(useParent) {
          config.onLoad = function() {
            _listenerWindow = window;
            _attachListeners();
            pub.up.callback(true)
          }
        }else {
          var tries = 0, max = config.delay / 50;
          (function getRef() {
            if(++tries > max) {
              throw new Error("Unable to reference listenerwindow");
            }
            try {
              _listenerWindow = _callerWindow.contentWindow.frames[IFRAME_PREFIX + config.channel + "_consumer"]
            }catch(ex) {
            }
            if(_listenerWindow) {
              _attachListeners();
              pub.up.callback(true)
            }else {
              setTimeout(getRef, 50)
            }
          })()
        }
        _callerWindow = createFrame(config)
      }else {
        _listenerWindow = window;
        _attachListeners();
        if(useParent) {
          _callerWindow = parent;
          pub.up.callback(true)
        }else {
          apply(config, {props:{src:config.remote + "#" + config.channel + new Date, name:IFRAME_PREFIX + config.channel + "_consumer"}, onLoad:function() {
            pub.up.callback(true)
          }});
          _callerWindow = createFrame(config)
        }
      }
    }, init:function() {
      whenReady(pub.onDOMReady, pub)
    }}
  };
  easyXDM.stack.ReliableBehavior = function(config) {
    var pub, callback;
    var idOut = 0, idIn = 0, currentMessage = "";
    return pub = {incoming:function(message, origin) {
      var indexOf = message.indexOf("_"), ack = message.substring(0, indexOf).split(",");
      message = message.substring(indexOf + 1);
      if(ack[0] == idOut) {
        currentMessage = "";
        if(callback) {
          callback(true)
        }
      }
      if(message.length > 0) {
        pub.down.outgoing(ack[1] + "," + idOut + "_" + currentMessage, origin);
        if(idIn != ack[1]) {
          idIn = ack[1];
          pub.up.incoming(message, origin)
        }
      }
    }, outgoing:function(message, origin, fn) {
      currentMessage = message;
      callback = fn;
      pub.down.outgoing(idIn + "," + ++idOut + "_" + message, origin)
    }}
  };
  easyXDM.stack.QueueBehavior = function(config) {
    var pub, queue = [], waiting = true, incoming = "", destroying, maxLength = 0, lazy = false, doFragment = false;
    function dispatch() {
      if(config.remove && queue.length === 0) {
        removeFromStack(pub);
        return
      }
      if(waiting || queue.length === 0 || destroying) {
        return
      }
      waiting = true;
      var message = queue.shift();
      pub.down.outgoing(message.data, message.origin, function(success) {
        waiting = false;
        if(message.callback) {
          setTimeout(function() {
            message.callback(success)
          }, 0)
        }
        dispatch()
      })
    }
    return pub = {init:function() {
      if(undef(config)) {
        config = {}
      }
      if(config.maxLength) {
        maxLength = config.maxLength;
        doFragment = true
      }
      if(config.lazy) {
        lazy = true
      }else {
        pub.down.init()
      }
    }, callback:function(success) {
      waiting = false;
      var up = pub.up;
      dispatch();
      up.callback(success)
    }, incoming:function(message, origin) {
      if(doFragment) {
        var indexOf = message.indexOf("_"), seq = parseInt(message.substring(0, indexOf), 10);
        incoming += message.substring(indexOf + 1);
        if(seq === 0) {
          if(config.encode) {
            incoming = decodeURIComponent(incoming)
          }
          pub.up.incoming(incoming, origin);
          incoming = ""
        }
      }else {
        pub.up.incoming(message, origin)
      }
    }, outgoing:function(message, origin, fn) {
      if(config.encode) {
        message = encodeURIComponent(message)
      }
      var fragments = [], fragment;
      if(doFragment) {
        while(message.length !== 0) {
          fragment = message.substring(0, maxLength);
          message = message.substring(fragment.length);
          fragments.push(fragment)
        }
        while(fragment = fragments.shift()) {
          queue.push({data:fragments.length + "_" + fragment, origin:origin, callback:fragments.length === 0 ? fn : null})
        }
      }else {
        queue.push({data:message, origin:origin, callback:fn})
      }
      if(lazy) {
        pub.down.init()
      }else {
        dispatch()
      }
    }, destroy:function() {
      destroying = true;
      pub.down.destroy()
    }}
  };
  easyXDM.stack.VerifyBehavior = function(config) {
    var pub, mySecret, theirSecret, verified = false;
    function startVerification() {
      mySecret = Math.random().toString(16).substring(2);
      pub.down.outgoing(mySecret)
    }
    return pub = {incoming:function(message, origin) {
      var indexOf = message.indexOf("_");
      if(indexOf === -1) {
        if(message === mySecret) {
          pub.up.callback(true)
        }else {
          if(!theirSecret) {
            theirSecret = message;
            if(!config.initiate) {
              startVerification()
            }
            pub.down.outgoing(message)
          }
        }
      }else {
        if(message.substring(0, indexOf) === theirSecret) {
          pub.up.incoming(message.substring(indexOf + 1), origin)
        }
      }
    }, outgoing:function(message, origin, fn) {
      pub.down.outgoing(mySecret + "_" + message, origin, fn)
    }, callback:function(success) {
      if(config.initiate) {
        startVerification()
      }
    }}
  };
  easyXDM.stack.RpcBehavior = function(proxy, config) {
    var pub, serializer = config.serializer || getJSON();
    var _callbackCounter = 0, _callbacks = {};
    function _send(data) {
      data.jsonrpc = "2.0";
      pub.down.outgoing(serializer.stringify(data))
    }
    function _createMethod(definition, method) {
      var slice = Array.prototype.slice;
      return function() {
        var l = arguments.length, callback, message = {method:method};
        if(l > 0 && typeof arguments[l - 1] === "function") {
          if(l > 1 && typeof arguments[l - 2] === "function") {
            callback = {success:arguments[l - 2], error:arguments[l - 1]};
            message.params = slice.call(arguments, 0, l - 2)
          }else {
            callback = {success:arguments[l - 1]};
            message.params = slice.call(arguments, 0, l - 1)
          }
          _callbacks["" + ++_callbackCounter] = callback;
          message.id = _callbackCounter
        }else {
          message.params = slice.call(arguments, 0)
        }
        if(definition.namedParams && message.params.length === 1) {
          message.params = message.params[0]
        }
        _send(message)
      }
    }
    function _executeMethod(method, id, fn, params) {
      if(!fn) {
        if(id) {
          _send({id:id, error:{code:-32601, message:"Procedure not found."}})
        }
        return
      }
      var success, error;
      if(id) {
        success = function(result) {
          success = emptyFn;
          _send({id:id, result:result})
        };
        error = function(message, data) {
          error = emptyFn;
          var msg = {id:id, error:{code:-32099, message:message}};
          if(data) {
            msg.error.data = data
          }
          _send(msg)
        }
      }else {
        success = error = emptyFn
      }
      if(!isArray(params)) {
        params = [params]
      }
      try {
        var result = fn.method.apply(fn.scope, params.concat([success, error]));
        if(!undef(result)) {
          success(result)
        }
      }catch(ex1) {
        error(ex1.message)
      }
    }
    return pub = {incoming:function(message, origin) {
      var data = serializer.parse(message);
      if(data.method) {
        if(config.handle) {
          config.handle(data, _send)
        }else {
          _executeMethod(data.method, data.id, config.local[data.method], data.params)
        }
      }else {
        var callback = _callbacks[data.id] || {};
        if(data.error) {
          if(callback.error) {
            callback.error(data.error)
          }
        }else {
          if(callback.success) {
            callback.success(data.result)
          }
        }
        delete _callbacks[data.id]
      }
    }, init:function() {
      if(config.remote) {
        for(var method in config.remote) {
          if(config.remote.hasOwnProperty(method)) {
            proxy[method] = _createMethod(config.remote[method], method)
          }
        }
      }
      pub.down.init()
    }, destroy:function() {
      for(var method in config.remote) {
        if(config.remote.hasOwnProperty(method) && proxy.hasOwnProperty(method)) {
          delete proxy[method]
        }
      }
      pub.down.destroy()
    }}
  }
})(window, document, location, window.nativeSetTimeout || window.setTimeout, decodeURIComponent, encodeURIComponent);
(function() {
  var WA = window.WebAgent = window.WebAgent || {};
  WA.icqSupport = true;
  var isEmail = function(str) {
    var m = str.match(/[^@:]+@[^:]+/);
    return m && m[0] || false
  };
  var getUserCookieLogin = function() {
    return(/Mpop=.*?:([^@:]+@[^:]+)/.exec(document.cookie.toString()) || [0, false])[1]
  };
  var getUserLogin = function() {
    return window.patron && patron.useremail && isEmail(patron.useremail) || getUserCookieLogin()
  };
  var ACTIVE_MAIL = getUserLogin();
  var SAFE_ACTIVE_MAIL = (ACTIVE_MAIL || "").replace(/[^a-z0-9]+/ig, "").toLowerCase().slice(-63);
  var isDebug = location.href.indexOf("localhost") != -1 || location.href.indexOf("wa_debug") != -1;
  var docMode = document.documentMode;
  var ua = navigator.userAgent.toLowerCase();
  var checkUA = function(regexp) {
    return regexp.test(ua)
  };
  var isOpera = checkUA(/opera/) || checkUA(/opr\//), isWebKit = checkUA(/webkit/), isChrome = !isOpera && checkUA(/chrome/), isSpartan = isChrome && checkUA(/Edge\/12/i), isIE = !isOpera && checkUA(/msie/) || ua.match(/rv:11\.0/i) && ua.match(/Trident\/7\.0/i), isIE8 = isIE && checkUA(/msie 8/) && docMode != 7, isIE9 = isIE && checkUA(/msie 9/) && docMode != 7 && docMode != 8, isGecko = !isWebKit && checkUA(/gecko/), isGecko3 = isGecko && checkUA(/rv:1\.9/), isMac = checkUA(/macintosh/), isProblemStrictSafari = 
  isWebKit && isMac && !isChrome && !isOpera, isProblemSafari = isProblemStrictSafari || isIE, isRetina = window.devicePixelRatio >= 1.5;
  var myMailPage = document.location.hostname.indexOf("my.mail.ru") > -1;
  var UID = 1;
  var apply = function(to, from, defaults) {
    if(defaults) {
      apply(to, defaults)
    }
    if(from) {
      for(var key in from) {
        to[key] = from[key]
      }
    }
    return to
  };
  apply(WebAgent, {isDebug:isDebug, allowAuth:false, isIE:isIE, isIE8:isIE8, isIE9:isIE9, isFF36:isGecko3, isFF:isGecko && !isIE, isWebKit:isWebKit, isChrome:isChrome, isSpartan:isSpartan, isOpera:isOpera, isMac:isMac, isProblemStrictSafari:isProblemStrictSafari, isProblemSafari:isProblemSafari, isRetina:isRetina, isSecure:("" + document.location).split(":")[0] == "https", isLoadReduce:isIE, ACTIVE_MAIL:ACTIVE_MAIL, SAFE_ACTIVE_MAIL:SAFE_ACTIVE_MAIL, resizeableLayout:true, apply:apply, applyIf:function(to, 
  from) {
    if(from) {
      for(var key in from) {
        if(typeof to[key] === "undefined") {
          to[key] = from[key]
        }
      }
    }
    return to
  }, isPopup:window.__WebAgent__isPopup || false, namespace:function(path) {
    var arr = path.split(".");
    var o = window[arr[0]] = window[arr[0]] || {};
    WebAgent.each(arr.slice(1), function(el) {
      o = o[el] = o[el] || {}
    });
    return o
  }, getJSON:function() {
    if(window.JSON && window.JSON.stringify(["a"]) == '["a"]') {
      return{stringify:function() {
        if(getJSON_testStringify) {
          var now = Math.floor(new Date / 1E3);
          getJSON_useCounter++;
          getJSON_nativeIsBroken = window.JSON.stringify(["a"]) != '["a"]';
          if(getJSON_nativeIsBroken) {
            getJSON_testStringify = false
          }else {
            if(document.readyState == "complete" && !getJSON_loadedTS) {
              getJSON_loadedTS = now
            }
          }
          getJSON_lastTS = now
        }
        return getJSON_nativeIsBroken ? window._JSON.stringify.apply(window._JSON, arguments) : window.JSON.stringify.apply(window.JSON, arguments)
      }, parse:function() {
        return window.JSON.parse.apply(window.JSON, arguments)
      }}
    }else {
      return window._JSON
    }
  }, getUserLogin:getUserLogin, getUserCookieLogin:getUserCookieLogin, isNumber:function(v) {
    return typeof v === "number" && isFinite(v)
  }, isString:function(v) {
    return typeof v === "string"
  }, isFunction:function(v) {
    return typeof v === "function"
  }, isObject:function(v) {
    return typeof v === "object"
  }, isBoolean:function(value) {
    return typeof value === "boolean"
  }, isDate:function(v) {
    return Object.prototype.toString.apply(v) === "[object Date]"
  }, isArray:function(v) {
    return Object.prototype.toString.apply(v) === "[object Array]"
  }, toArray:function(v) {
    if(WebAgent.isArray(v)) {
      return v
    }else {
      return Array.prototype.slice.call(v, 0)
    }
  }, log:function() {
    if(WA.isDebug) {
      console.log.apply(console, arguments)
    }
  }, each:function(arr, fn, scope) {
    var len = arr.length;
    for(var i = 0;i < len;++i) {
      if(fn.call(scope || window, arr[i], i, arr) === false) {
        return
      }
    }
  }, createDelegate:function(fn, scope, args, appendArgs) {
    return function() {
      var callArgs = WebAgent.toArray(arguments);
      if(appendArgs === true) {
        callArgs = callArgs.concat(args || [])
      }else {
        if(WebAgent.isNumber(appendArgs)) {
          callArgs = callArgs.slice(0, appendArgs).concat(args || [])
        }
      }
      return fn.apply(scope || window, callArgs)
    }
  }, buildId:function(suffix) {
    return"mailru-webagent-" + suffix
  }, buildIconClass:function(status, addDefaultIcon) {
    if(!status || /[<>\"\']/.test(status)) {
      status = "online"
    }
    var isUIN = status.indexOf("icq_") == 0;
    if(isUIN && status.indexOf("status_") == 4) {
      status = status.substr(4)
    }
    var defaultClass = isUIN ? "wa-cl-status-icq-default " : "wa-cl-status-default ";
    return(addDefaultIcon === true ? defaultClass : "") + "wa-cl-status-" + status
  }, generateId:function() {
    return WebAgent.buildId("gen-" + UID++)
  }, emptyFn:function() {
  }, now:function() {
    return Math.floor(new Date / 1E3)
  }, nowFixed:function() {
    return Math.floor(+new Date / 1E3) - (WA.serverTimeDiff || 0)
  }, setTimeout:function(code, interval, scope) {
    var cb = function() {
      WA.util.Mnt.wrapTryCatch(code, scope)
    };
    if(window.nativeSetTimeout) {
      return window.nativeSetTimeout(cb, interval)
    }else {
      return window.setTimeout(cb, interval)
    }
  }, setInterval:function(code, interval, scope) {
    var cb = function() {
      WA.util.Mnt.wrapTryCatch(code, scope)
    };
    if(window.nativeSetInterval) {
      return window.nativeSetInterval(cb, interval)
    }else {
      return window.setInterval(cb, interval)
    }
  }, makeGet:function(hash) {
    var get = [];
    WebAgent.util.Object.each(hash, function(v, k) {
      get[get.length] = k + "=" + encodeURIComponent(v)
    });
    return get.join("&")
  }, makeJsonpRequest:function(url, params, callbackParamName, callback, scope, onError) {
    var cbUniqName = "jscb_tmp_" + Math.round(Math.random() * 999999);
    params = params || {};
    params[callbackParamName] = "WebAgent." + cbUniqName;
    this[cbUniqName] = function(data) {
      delete WebAgent[cbUniqName];
      callback && callback.call(scope || window, data)
    };
    var script = WA.getBody().dom.appendChild(document.createElement("script"));
    WA.get(script).on("error", function() {
      onError && onError.call(scope || window, 1)
    }, this);
    script.type = "text/javascript";
    script.src = url + "?" + WA.makeGet(params)
  }, error:function(e) {
    if(isDebug) {
      debugger
    }
    if(WA.Mnt) {
      WA.Mnt.log(e)
    }
    throw e;
  }, abstractError:function() {
    WebAgent.error("Abstract method")
  }, gstat:function(params) {
  }, emalize:function(email) {
    return email.match(/^\d+$/) ? email + "@uin.icq" : email
  }, splitMail:function(mail) {
    return mail.match(/([^@]+)@(.+)/).slice(1)
  }, sum:function() {
    var table = "00000000 77073096 EE0E612C 990951BA 076DC419 706AF48F E963A535 9E6495A3 0EDB8832 79DCB8A4 E0D5E91E 97D2D988 09B64C2B 7EB17CBD E7B82D07 90BF1D91 1DB71064 6AB020F2 F3B97148 84BE41DE 1ADAD47D 6DDDE4EB F4D4B551 83D385C7 136C9856 646BA8C0 FD62F97A 8A65C9EC 14015C4F 63066CD9 FA0F3D63 8D080DF5 3B6E20C8 4C69105E D56041E4 A2677172 3C03E4D1 4B04D447 D20D85FD A50AB56B 35B5A8FA 42B2986C DBBBC9D6 ACBCF940 32D86CE3 45DF5C75 DCD60DCF ABD13D59 26D930AC 51DE003A C8D75180 BFD06116 21B4F4B5 56B3C423 CFBA9599 B8BDA50F 2802B89E 5F058808 C60CD9B2 B10BE924 2F6F7C87 58684C11 C1611DAB B6662D3D 76DC4190 01DB7106 98D220BC EFD5102A 71B18589 06B6B51F 9FBFE4A5 E8B8D433 7807C9A2 0F00F934 9609A88E E10E9818 7F6A0DBB 086D3D2D 91646C97 E6635C01 6B6B51F4 1C6C6162 856530D8 F262004E 6C0695ED 1B01A57B 8208F4C1 F50FC457 65B0D9C6 12B7E950 8BBEB8EA FCB9887C 62DD1DDF 15DA2D49 8CD37CF3 FBD44C65 4DB26158 3AB551CE A3BC0074 D4BB30E2 4ADFA541 3DD895D7 A4D1C46D D3D6F4FB 4369E96A 346ED9FC AD678846 DA60B8D0 44042D73 33031DE5 AA0A4C5F DD0D7CC9 5005713C 270241AA BE0B1010 C90C2086 5768B525 206F85B3 B966D409 CE61E49F 5EDEF90E 29D9C998 B0D09822 C7D7A8B4 59B33D17 2EB40D81 B7BD5C3B C0BA6CAD EDB88320 9ABFB3B6 03B6E20C 74B1D29A EAD54739 9DD277AF 04DB2615 73DC1683 E3630B12 94643B84 0D6D6A3E 7A6A5AA8 E40ECF0B 9309FF9D 0A00AE27 7D079EB1 F00F9344 8708A3D2 1E01F268 6906C2FE F762575D 806567CB 196C3671 6E6B06E7 FED41B76 89D32BE0 10DA7A5A 67DD4ACC F9B9DF6F 8EBEEFF9 17B7BE43 60B08ED5 D6D6A3E8 A1D1937E 38D8C2C4 4FDFF252 D1BB67F1 A6BC5767 3FB506DD 48B2364B D80D2BDA AF0A1B4C 36034AF6 41047A60 DF60EFC3 A867DF55 316E8EEF 4669BE79 CB61B38C BC66831A 256FD2A0 5268E236 CC0C7795 BB0B4703 220216B9 5505262F C5BA3BBE B2BD0B28 2BB45A92 5CB36A04 C2D7FFA7 B5D0CF31 2CD99E8B 5BDEAE1D 9B64C2B0 EC63F226 756AA39C 026D930A 9C0906A9 EB0E363F 72076785 05005713 95BF4A82 E2B87A14 7BB12BAE 0CB61B38 92D28E9B E5D5BE0D 7CDCEFB7 0BDBDF21 86D3D2D4 F1D4E242 68DDB3F8 1FDA836E 81BE16CD F6B9265B 6FB077E1 18B74777 88085AE6 FF0F6A70 66063BCA 11010B5C 8F659EFF F862AE69 616BFFD3 166CCF45 A00AE278 D70DD2EE 4E048354 3903B3C2 A7672661 D06016F7 4969474D 3E6E77DB AED16A4A D9D65ADC 40DF0B66 37D83BF0 A9BCAE53 DEBB9EC5 47B2CF7F 30B5FFE9 BDBDF21C CABAC28A 53B39330 24B4A3A6 BAD03605 CDD70693 54DE5729 23D967BF B3667A2E C4614AB8 5D681B02 2A6F2B94 B40BBE37 C30C8EA1 5A05DF1B 2D02EF8D".split(" ");
    return function(str) {
      var crc = -1;
      for(var i = 0, len = str.length;i < len;i++) {
        var t = (crc ^ str.charCodeAt(i)) & 255;
        crc = crc >>> 8 ^ parseInt(table[t], 16)
      }
      crc ^= -1;
      if(crc < 0) {
        crc += 4294967296
      }
      return crc.toString(16)
    }
  }(), uniq:function() {
    return Math.round(Math.random() * 99999)
  }, isUIN:function(email) {
    return email.indexOf("@uin.icq") != -1 || email.match(/^[0-9]+$/) != null
  }, ts:function() {
    return+new Date
  }, TIME_INFINITY:9999999999, serverTimeDiff:0, getFixedTS:function(ts, micro) {
    var tsDiff = WebAgent.serverTimeDiff || 0;
    return+ts + tsDiff * (micro ? 1E3 : 1)
  }, getCodePointAt:function(s, index) {
    index = index || 0;
    var h = s.charCodeAt(index), l = s.charCodeAt(index + 1);
    if(isNaN(l)) {
      return h.toString(16).toLowerCase()
    }
    return((h - 55296) * 1024 + l - 56320 + 65536).toString(16).toLowerCase()
  }, fromCharCode:function(codePt) {
    if(codePt > 65535) {
      codePt -= 65536;
      return String.fromCharCode(55296 + (codePt >> 10), 56320 + (codePt & 1023))
    }else {
      return String.fromCharCode(codePt)
    }
  }, checkClienResolution:function(active) {
    if(this._resolutionChecked > 1 || this._resolutionChecked > 0 && !active) {
      return
    }
    this._resolutionChecked = active ? 2 : 1;
    var counter = 0;
    switch(screen.width) {
      case 1024:
        if(screen.height == 768) {
          counter = active ? 2025961 : 2009931
        }
        break;
      case 1280:
        if(screen.height == 800) {
          counter = active ? 2009950 : 2009937
        }
        if(screen.height == 1024) {
          counter = active ? 2009942 : 2009924
        }
        break;
      case 1366:
        if(screen.height == 768) {
          counter = active ? 2009940 : 2009920
        }
        break;
      case 1440:
        if(screen.height == 900) {
          counter = active ? 2009948 : 2009936
        }
        break;
      case 1600:
        if(screen.height == 900) {
          counter = active ? 2009947 : 2009934
        }
        break;
      case 1680:
        if(screen.height == 1050) {
          counter = active ? 2009951 : 2009939
        }
        break;
      case 1920:
        if(screen.height == 1080) {
          counter = active ? 2009943 : 2009929
        }
        break
    }
    if(counter) {
      WA.util.Mnt.countRB(counter)
    }
  }});
  WebAgent.bind = WebAgent.createDelegate;
  var getJSON_initTS = WA.now(), getJSON_lastTS = getJSON_initTS, getJSON_loadedTS = 0, getJSON_useCounter = 0, getJSON_nativeIsBroken = false, getJSON_testStringify = myMailPage
})();
(function() {
  function override(source, overrides) {
    var p = source.prototype;
    WebAgent.apply(p, overrides);
    if(WebAgent.isIE && overrides.hasOwnProperty("toString")) {
      p.toString = overrides.toString
    }
  }
  WebAgent.apply(WebAgent, {extend:function(superclass, overrides) {
    var oc = Object.prototype.constructor;
    var sub;
    if(overrides.constructor != oc) {
      sub = overrides.constructor
    }else {
      sub = function() {
        superclass.apply(this, arguments)
      }
    }
    var F = function() {
    };
    var subP;
    var superP = superclass.prototype;
    F.prototype = superP;
    subP = sub.prototype = new F;
    subP.constructor = sub;
    sub.superclass = superP;
    if(superP.constructor == oc) {
      superP.constructor = superclass
    }
    subP.superclass = function() {
      return superP
    };
    override(sub, overrides);
    return sub
  }})
})();
(function() {
  var WA = WebAgent;
  var addDomListener = function(dom, eventName, fn, useCapture) {
    if(dom.addEventListener) {
      dom.addEventListener(eventName, fn, !!useCapture)
    }else {
      if(dom.attachEvent) {
        dom.attachEvent("on" + eventName, fn)
      }
    }
  };
  var removeDomListener = function(dom, eventName, fn, useCapture) {
    if(dom.removeEventListener) {
      dom.removeEventListener(eventName, fn, !!useCapture)
    }else {
      if(dom.detachEvent) {
        dom.detachEvent("on" + eventName, fn)
      }
    }
  };
  var EVENT_BUTTON_MAP = WA.isIE ? {b1:0, b4:1, b2:2} : {b0:0, b1:1, b2:2};
  var DomEvent = WA.extend(Object, {constructor:function(e) {
    var ev = this.browserEvent = e || {}, doc;
    this.button = ev.button ? EVENT_BUTTON_MAP["b" + ev.button] : ev.which ? ev.which - 1 : -1;
    if(/(dbl)?click/.test(ev.type) && this.button == -1) {
      this.button = 0
    }
    this.type = ev.type;
    this.keyCode = ev.keyCode;
    this.charCode = ev.charCode;
    this.shiftKey = ev.shiftKey;
    this.ctrlKey = ev.ctrlKey || ev.metaKey || false;
    this.altKey = ev.altKey;
    this.pageX = ev.pageX;
    this.pageY = ev.pageY;
    if(ev.pageX == null && ev.clientX != null) {
      doc = document.documentElement;
      this.pageX = ev.clientX + (doc && doc.scrollLeft || 0);
      this.pageY = ev.clientY + (doc && doc.scrollTop || 0)
    }
  }, getKeyCode:function() {
    return this.browserEvent.keyCode
  }, getCharCode:function() {
    return this.browserEvent.charCode
  }, getTarget:function(returnElement) {
    var node = this.browserEvent.target || this.browserEvent.srcElement;
    if(!node) {
      return null
    }else {
      var dom = node.nodeType == 3 ? node.parentNode : node;
      return returnElement ? WA.get(dom) : dom
    }
  }, stopPropagation:function() {
    var event = this.browserEvent;
    if(event) {
      if(event.stopPropagation) {
        event.stopPropagation()
      }else {
        event.cancelBubble = true
      }
    }
  }, preventDefault:function() {
    var event = this.browserEvent;
    if(event) {
      if(event.preventDefault) {
        event.preventDefault()
      }else {
        event.returnValue = false
      }
    }
  }, stopEvent:function() {
    this.stopPropagation();
    this.preventDefault()
  }});
  var Container = {items:{}, blocked:{}, blockedEvents:{}, register:function(el) {
    var id = el.identify();
    if(!this.items[id]) {
      this.items[id] = new ContainerItem(el)
    }
  }, getElement:function(id) {
    var item = this.items[id];
    if(item && item.isValid()) {
      return item.el
    }else {
      return null
    }
  }, each:function(fn, scope) {
    WA.util.Object.each(this.items, fn, scope || this)
  }, addListener:function(el, eventName, fn, scope, options) {
    this.register(el);
    var item = this.items[el.getId()];
    item.addListener(eventName, fn, scope, options)
  }, removeListener:function(el, eventName, fn, scope) {
    var item = this.items[el.getId()];
    if(item) {
      item.removeListener(eventName, fn, scope)
    }
  }, removeListeners:function(el, recursively, eventName) {
    var item = this.items[el.getId()];
    if(item) {
      item.removeListeners(eventName);
      if(recursively && el.dom.childNodes) {
        el.each(function(childEl) {
          this.removeListeners(childEl, recursively, eventName)
        }, this)
      }
    }
  }, blockDOMEvents:function(el, eventTypes, checkFn, scope) {
    this.register(el);
    var id = el.getId();
    if(!this.blocked[id]) {
      this.blocked[id] = {events:{}, counter:0}
    }
    var blocked = this.blocked[id];
    if(!WA.isArray(eventTypes)) {
      eventTypes = [eventTypes]
    }
    WA.util.Array.each(eventTypes, function(eventType) {
      if(!blocked[eventType]) {
        this.blockedEvents[eventType] = (this.blockedEvents[eventType] || 0) + 1
      }
      blocked.events[eventType] = checkFn ? WA.createDelegate(checkFn, scope) : function() {
      };
      blocked.counter++
    }, this)
  }, unblockDOMEvents:function(el, eventTypes) {
    var id = el.getId();
    var blocked = this.blocked[id];
    if(blocked) {
      if(!WA.isArray(eventTypes)) {
        eventTypes = [eventTypes]
      }
      WA.util.Array.each(eventTypes, function(eventType) {
        if(blocked.events[eventType]) {
          this.blockedEvents[eventType] && this.blockedEvents[eventType]--;
          delete blocked.events[eventType];
          blocked.counter--;
          if(!blocked.counter) {
            delete this.blocked[id]
          }
        }
      }, this)
    }
  }, checkBlocking:function(eventName, event) {
    var c = event.getTarget();
    while(c && c !== document) {
      if(c.id && this.blocked[c.id] && this.blocked[c.id].events[eventName]) {
        return this.blocked[c.id].events[eventName](event, WA.get(c))
      }
      c = c.parentNode
    }
    return true
  }, remove:function(el) {
    var id = el.getId();
    var item = this.items[id];
    if(item) {
      item.destroy();
      delete this.items[id]
    }
    if(this.blocked[id]) {
      for(var eventType in this.blocked.events) {
        this.blockedEvents[eventType] && this.blockedEvents[eventType]--
      }
      delete this.blocked[id]
    }
  }};
  var ContainerItem = WA.extend(Object, {constructor:function(el) {
    this.el = el;
    this.events = {};
    this.blockedEvents = {};
    this.domHandlers = {}
  }, isValid:function() {
    var el = this.el;
    var dom = el.dom;
    var isInvalid = !dom || !dom.parentNode || !dom.offsetParent && !document.getElementById(el.getId());
    return!isInvalid || dom === document || dom === document.body || dom === window
  }, addListener:function(eventName, fn, scope, options) {
    var event = this.events[eventName];
    if(!event) {
      event = this.events[eventName] = new WA.util.Event;
      this.domHandlers[eventName] = WA.createDelegate(function(e, ename) {
        WA.util.Mnt.wrapTryCatch(function() {
          if(this.events[ename]) {
            var blocked = Container.blockedEvents[ename] && !Container.checkBlocking(ename, new DomEvent(e));
            if(!blocked) {
              this.events[ename].fire(new DomEvent(e), this.el)
            }
          }
        }, this)
      }, this, [eventName], 1);
      if(eventName == "afterresize") {
        addDomListener(this.el.dom, "resize", WA.createDelegate(function(e) {
          if(this._timer > 0) {
            clearTimeout(this._timer)
          }
          this._timer = WA.setTimeout(WA.createDelegate(function() {
            this.domHandlers[eventName].call(window, e)
          }, this), 150)
        }, this))
      }else {
        addDomListener(this.el.dom, eventName, this.domHandlers[eventName], !!(options || {}).useCapture)
      }
    }
    event.on(fn, scope || this.el, options)
  }, removeListener:function(eventName, fn, scope) {
    var event = this.events[eventName];
    if(event) {
      event.un(fn, scope || this.el);
      if(!event.hasListeners() && this.el && eventName == "mousemove") {
        removeDomListener(this.el.dom, eventName, this.domHandlers[eventName]);
        delete this.events[eventName];
        delete this.domHandlers[eventName]
      }
    }
  }, removeListeners:function(eventName) {
    if(eventName) {
      var event = this.events[eventName];
      if(event) {
        event.removeAll()
      }
    }else {
      WA.util.Object.each(this.events, function(ignored, ename) {
        this.removeListeners(ename)
      }, this)
    }
  }, destroy:function() {
    var eventNames = WA.util.Object.getKeys(this.events);
    WA.util.Array.each(eventNames, function(eventName) {
      this.removeListeners(eventName);
      removeDomListener(this.el.dom, eventName, this.domHandlers[eventName]);
      delete this.events[eventName];
      delete this.domHandlers[eventName]
    }, this);
    this.events = null;
    this.domHandlers = null;
    this.el = null
  }});
  var garbageCollect = function() {
    Container.each(function(item) {
      if(!item.isValid()) {
        this.remove(item.el)
      }
    })
  };
  WA.setInterval(garbageCollect, 3E4);
  var propCache = {}, camelRe = /(-[a-z])/gi, propFloat = WA.isIE ? "styleFloat" : "cssFloat";
  function camelFn(mchkCache, a) {
    return a.charAt(1).toUpperCase()
  }
  function chkCache(prop) {
    return propCache[prop] || (propCache[prop] = prop == "float" ? propFloat : prop.replace(camelRe, camelFn))
  }
  function getStyle(x, styleProp) {
    if(x.currentStyle) {
      var y = x.currentStyle[styleProp]
    }else {
      if(window.getComputedStyle) {
        y = document.defaultView.getComputedStyle(x, null).getPropertyValue(styleProp)
      }
    }
    return y
  }
  var Element = WA.extend(Object, {constructor:function(dom) {
    this.dom = dom
  }, getId:function() {
    if(this.dom === window) {
      return WA.buildId("window")
    }else {
      if(this.dom === document) {
        return WA.buildId("document")
      }else {
        if(this.dom === document.body) {
          return WA.buildId("body")
        }else {
          return this.dom.id
        }
      }
    }
  }, identify:function() {
    return this.getId() || (this.dom.id = WA.generateId())
  }, getWidth:function() {
    return Math.max(this.dom.offsetWidth, this.isVisible() ? 0 : this.dom.clientWidth) || 0
  }, getHeight:function() {
    return Math.max(this.dom.offsetHeight, this.isVisible() ? 0 : this.dom.clientHeight) || 0
  }, getSize:function() {
    return{width:this.getWidth(), height:this.getHeight()}
  }, setWidth:function(width) {
    this.dom.style.width = width + "px";
    return this
  }, setHeight:function(height) {
    this.dom.style.height = height + "px";
    return this
  }, setSize:function(width, height) {
    if(WA.isObject(width)) {
      return this.setSize(width.width, width.height)
    }else {
      this.setWidth(width);
      this.setHeight(height);
      return this
    }
  }, addListener:function(eventName, fn, scope, optons) {
    Container.addListener(this, eventName, fn, scope, optons);
    return this
  }, on:function(eventName, fn, scope, options) {
    return this.addListener(eventName, fn, scope, options)
  }, removeListener:function(eventName, fn, scope) {
    Container.removeListener(this, eventName, fn, scope);
    return this
  }, un:function(eventName, fn, scope) {
    return this.removeListener(eventName, fn, scope)
  }, removeListeners:function(recursively, eventName) {
    Container.removeListeners(this, recursively, eventName);
    return this
  }, blockDOMEvents:function(types, checkFn, scope) {
    Container.blockDOMEvents(this, types, checkFn, scope)
  }, unblockDOMEvents:function(types) {
    Container.unblockDOMEvents(this, types)
  }, setAttribute:function(name, value) {
    this.dom.setAttribute(name, value)
  }, getAttribute:function(name) {
    return this.dom.getAttribute(name)
  }, removeAttribute:function(name) {
    return this.dom.removeAttribute(name)
  }, removeClass:function(className) {
    var clsArray = this.dom.className.split(" ");
    this.dom.className = WA.util.Array.remove(clsArray, className).join(" ");
    return this
  }, addClass:function(className) {
    if(!this.hasClass(className)) {
      this.dom.className += " " + className
    }
    return this
  }, hasClass:function(className) {
    return(" " + this.dom.className + " ").indexOf(" " + className + " ") != -1
  }, toggleClass:function(className, state) {
    var isBool = typeof state === "boolean";
    state = isBool ? state : !this.hasClass(className);
    this[state ? "addClass" : "removeClass"](className);
    return this
  }, getClass:function() {
    return this.dom.className
  }, update:function(html) {
    this.dom.innerHTML = html;
    return this
  }, insertFirst:function(el) {
    var newNode = WA.get(el);
    if(this.first()) {
      this.insertBefore(newNode, this.first());
      return newNode
    }
    return newNode.appendTo(this)
  }, appendChild:function(el) {
    return WA.get(el).appendTo(this)
  }, appendTo:function(el) {
    WA.getDom(el).appendChild(this.dom);
    return this
  }, insertBefore:function(el, before) {
    WA.getDom(el).insertBefore(this.dom, before);
    return this
  }, createChild:function(config, atTheBeginning) {
    var el = WA.util.DomHelper.insertHtml(atTheBeginning === true ? "afterBegin" : "beforeEnd", this.dom, config);
    return WA.fly(el)
  }, setVisible:function(visible) {
    this.dom.style.display = visible ? "block" : "none";
    return this
  }, isVisible:function() {
    return getStyle(this.dom, "display") == "block"
  }, show:function() {
    return this.setVisible(true)
  }, hide:function() {
    return this.setVisible(false)
  }, toggle:function() {
    return this.setVisible(!this.isVisible())
  }, each:function(fn, scope) {
    var nodes = this.dom.childNodes;
    var len = nodes.length;
    var k = 0;
    for(var i = 0;i < len;++i) {
      var node = WA.isFunction(nodes) ? nodes(i) : nodes[i];
      if(node.nodeType == 1) {
        k++;
        var el = node.id ? WA.get(node) : WA.fly(node);
        if(fn.call(scope || this, el, k) === false) {
          return
        }
      }
    }
  }, matchNode:function(dir, start) {
    var node = this.dom[start];
    while(node) {
      if(node.nodeType == 1) {
        return WA.get(node)
      }
      node = node[dir]
    }
    return null
  }, first:function() {
    return this.matchNode("nextSibling", "firstChild")
  }, last:function() {
    return this.matchNode("previousSibling", "lastChild")
  }, prev:function() {
    return this.matchNode("previousSibling", "previousSibling")
  }, next:function() {
    return this.matchNode("nextSibling", "nextSibling")
  }, parent:function() {
    return this.matchNode("parentNode", "parentNode")
  }, up:function(cls) {
    var node = this;
    while(node) {
      if(node.hasClass(cls)) {
        return node
      }
      node = node.parent()
    }
  }, offset:function() {
    var box = {top:0, left:0};
    if("getBoundingClientRect" in document.documentElement) {
      try {
        box = this.dom.getBoundingClientRect()
      }catch(ex) {
      }
    }else {
    }
    var doc = this.dom.ownerDocument, docElem = doc.documentElement, top = box.top + (window.pageYOffset || docElem.scrollTop), left = box.left + (window.pageXOffset || docElem.scrollLeft);
    return{top:top, left:left}
  }, offsetBy:function(el) {
    var node = WA.getDom(el), p = this.dom.offsetParent, left = this.dom.offsetLeft, top = this.dom.offsetTop;
    while(p && p !== node) {
      left += p.offsetLeft;
      top += p.offsetTop;
      p = p.offsetParent
    }
    return{left:left, top:top}
  }, __removeDom:function() {
    var d = null;
    return function(node) {
      if(node.tagName != "BODY") {
        if(WA.isIE && !WA.isIE8) {
          d = d || document.createElement("div");
          d.appendChild(node);
          d.innerHTML = ""
        }else {
          node.parentNode.removeChild(node)
        }
      }
    }
  }(), remove:function() {
    if(this._maskEl) {
      this._maskEl.remove();
      this._maskEl = null
    }
    Container.remove(this);
    this.__removeDom(this.dom);
    this.dom = null
  }, isMasked:function() {
    return this.hasClass("nwa-overlay")
  }, mask:function() {
    return this.addClass("nwa-overlay")
  }, unmask:function() {
    return this.removeClass("nwa-overlay")
  }, isAncestor:function(el) {
    var parent = WA.getDom(el);
    if(parent && parent.contains) {
      try {
        return parent.contains(this.dom)
      }catch(e) {
      }
    }else {
      var c = this.dom.parentNode;
      while(c && c !== document) {
        if(parent === c) {
          return true
        }
        c = c.parentNode
      }
      return false
    }
  }, contains:function(el) {
    return WA.fly(el).isAncestor(this)
  }, equals:function(el) {
    return this.dom === el.dom
  }, setStyle:function(prop, value) {
    var tmp, style;
    if(!WA.isObject(prop)) {
      tmp = {};
      tmp[prop] = value;
      prop = tmp
    }
    for(style in prop) {
      value = prop[style];
      style == "opacity" ? this.setOpacity(value) : this.dom.style[chkCache(style)] = value
    }
    return this
  }, setOpacity:function(opacity, animate) {
    var me = this, s = me.dom.style;
    if(WA.isIE) {
      s.zoom = 1;
      s.filter = (s.filter || "").replace(/alpha\([^\)]*\)/gi, "") + (opacity == 1 ? "" : " alpha(opacity=" + opacity * 100 + ")")
    }else {
      s.opacity = opacity
    }
    return me
  }});
  WA.apply(WA, {getDom:function(el) {
    if(el instanceof Element) {
      return el.dom
    }else {
      if(typeof el === "string") {
        return document.getElementById(el)
      }else {
        return el
      }
    }
  }, fly:function(el) {
    if(el instanceof Element) {
      return el
    }else {
      return new Element(el)
    }
  }, get:function(el) {
    if(el instanceof Element) {
      return el
    }else {
      var dom = WA.getDom(el);
      if(dom) {
        var ret = Container.getElement(dom.id);
        if(!ret) {
          ret = new Element(dom)
        }
        return ret
      }else {
        return null
      }
    }
  }, getBody:function() {
    return new Element(document.body)
  }, getDoc:function() {
    return new Element(document)
  }})
})();
WebAgent.namespace("WebAgent");
(function() {
  var WA = WebAgent;
  var OVERRIDES = {isActive:function() {
    return this.__isActive === true
  }, activate:function(params) {
    if(!this.isActive()) {
      this.__isActive = true;
      return this._onActivate(params) !== false
    }else {
      return false
    }
  }, _onActivate:function(params) {
  }, deactivate:function(params) {
    if(this.isActive()) {
      this.__isActive = false;
      return this._onDeactivate(params) !== false
    }else {
      return false
    }
  }, _onDeactivate:function(params) {
  }};
  WA.Activatable = WA.extend(Object, OVERRIDES);
  WA.Activatable.extend = function(superclass, overrides) {
    var sp = WA.extend(superclass, OVERRIDES);
    return WA.extend(sp, overrides)
  }
})();
WebAgent.namespace("WebAgent.util");
(function() {
  var WA = WebAgent;
  var U = WA.util;
  var Animation = U.Animation = WA.extend(Object, {constructor:function() {
    this._onFrameScope = WA.createDelegate(this._onFrame, this);
    this._list = {};
    this._index = -1
  }, _requestFrame:function() {
    this.requestAnimationFrame.call(window, this._onFrameScope)
  }, start:function(from, to, pxPerMs, cb, scope) {
    if(!this._started) {
      this._started = true;
      this._requestFrame()
    }
    this._index++;
    this._list[this._index] = {from:from, to:to, pxPerMs:pxPerMs, cb:cb, scope:scope, date:+new Date, first:true};
    return this._index
  }, clear:function(index) {
    delete this._list[index]
  }, _onFrame:function() {
    var count = 0;
    U.Object.each(this._list, function(v, index) {
      count++;
      var value;
      var d = (+new Date - v.date) * v.pxPerMs;
      var lastFrame = false;
      if(v.from < v.to) {
        value = v.from + d;
        if(value > v.to) {
          lastFrame = true;
          value = v.to
        }
      }else {
        value = v.from - d;
        if(value < v.to) {
          lastFrame = true;
          value = v.to
        }
      }
      v.cb.call(v.scope || window, value, lastFrame, v.first);
      v.first = false;
      if(lastFrame) {
        this.clear(index)
      }
    }, this);
    if(count) {
      this._requestFrame()
    }else {
      this._started = false
    }
  }, requestAnimationFrame:function() {
    return window.requestAnimationFrame || window.webkitRequestAnimationFrame || window.mozRequestAnimationFrame || window.oRequestAnimationFrame || window.msRequestAnimationFrame || function(callback, element) {
      WA.setTimeout(callback, 1E3 / 60)
    }
  }()});
  U.animation = new U.Animation
})();
WebAgent.namespace("WebAgent.util");
(function() {
  var A = WebAgent.util.Array = {each:function(arr, fn, scope) {
    WebAgent.each(arr, fn, scope)
  }, unique:function(arr) {
    var ret = [];
    for(var i = 0;i < arr.length;i++) {
      if(A.indexOf(ret, arr[i]) == -1) {
        ret.push(arr[i])
      }
    }
    return ret
  }, eachReverse:function(arr, fn, scope) {
    var j = 0;
    for(var i = arr.length;i--;) {
      if(fn.call(scope || window, arr[i], j, arr) === false) {
        return
      }
      j++
    }
  }, transform:function(arr, fn, scope) {
    var ret = [];
    A.each(arr, function() {
      var el = fn.apply(this, arguments);
      ret.push(el)
    }, scope);
    return ret
  }, filter:function(arr, fn, scope) {
    var ret = [];
    A.each(arr, function(el, index, allItems) {
      if(fn.call(this, el, index, allItems)) {
        ret.push(el)
      }
    }, scope);
    return ret
  }, indexOf:function(arr, el) {
    var fn = null;
    if(el instanceof RegExp) {
      fn = function(entry) {
        return el.test(entry)
      }
    }else {
      fn = function(entry) {
        return el === entry
      }
    }
    return A.indexOfBy(arr, fn)
  }, indexOfBy:function(arr, fn, scope) {
    var ret = -1;
    A.each(arr, function(el, index) {
      if(fn.call(scope || window, el, index) === true) {
        ret = index;
        return false
      }
    });
    return ret
  }, findBy:function(arr, fn, scope) {
    var index = A.indexOfBy(arr, fn, scope);
    if(index != -1) {
      return arr[index]
    }else {
      return null
    }
  }, removeAt:function(arr, index) {
    arr.splice(index, 1);
    return arr
  }, remove:function(arr, el) {
    var index = A.indexOf(arr, el);
    if(index != -1) {
      return A.removeAt(arr, index)
    }else {
      return arr
    }
  }, removeBy:function(arr, fn, scope) {
    var index = A.indexOfBy(arr, fn, scope);
    if(index != -1) {
      return A.removeAt(arr, index)
    }else {
      return null
    }
  }, clone:function(arr) {
    return Array.prototype.slice.call(arr)
  }}
})();
WebAgent.namespace("WebAgent.util");
(function() {
  var WA = WebAgent;
  WebAgent.util.Date = {MINUTE:60, HOUR:60 * 60, DAY:60 * 60 * 24, WEEK:7 * 60 * 60 * 24, getElapsed:function(date1, date2) {
    date2 = date2 || new Date;
    return date2.getTime() - date1.getTime()
  }, getTimeFromMidnight:function(date) {
    return 1E3 * (this.HOUR * date.getHours() + this.MINUTE * date.getMinutes() + date.getSeconds())
  }, formatDate:function(ts) {
    var tso = new Date(+ts);
    var msg_date = tso.toTimeString().replace(/:\d\d(\s(?:AM|PM))?(?:\s.*)?$/i, "$1");
    var splitter = ".";
    var den = tso.getDate();
    var mes = tso.getMonth() + 1;
    mes += "";
    if(mes.length == 1) {
      mes = "0" + mes
    }
    var god = tso.getFullYear() + "";
    god = god.slice(-2);
    msg_date = den + splitter + mes + splitter + god + " " + msg_date;
    return msg_date
  }, formatTime:function(ts, now) {
    now = now || new Date;
    var diff = (now - ts) / 6E4;
    var date = new Date(ts);
    var formated = this.formatDate(ts).split(" ");
    var res = {day:WA.tr(date.getDay(), {scope:"at_day"}), date:formated[0], time:formated[1]};
    res.dateString = formated[0].replace(/(\d+)\.(\d+)\.\d+/, function(i, d, m) {
      res.dateShortString = d + " " + WA.tr(+m, {scope:"short_month_gen"});
      return d + " " + WA.tr(+m, {scope:"month_gen"})
    });
    var midnight = this.getTimeFromMidnight(now) / 6E4;
    var oneday = now.getDate() === date.getDate();
    if(diff < 1) {
      res.now = true;
      res.value = WA.tr("time.justNow")
    }else {
      if(diff / 60 < 1) {
        res.minutes = true;
        res.value = WA.tr("time.minutes", {count:Math.floor(diff)})
      }else {
        if(diff / (60 * 24) < 1 && oneday) {
          res.hours = true;
          res.value = WA.tr("time.hours", {count:Math.floor(diff / 60)})
        }else {
          if(diff / (midnight + 24 * 60) < 1 && !oneday) {
            res.yesterday = true;
            res.value = WA.tr("time.yesterday")
          }else {
            res.value = res.dateString
          }
        }
      }
    }
    return res
  }, formatLastSeenData:function(lastseen, gender) {
    var ts = new Date(lastseen * 1E3);
    var now = new Date;
    var dt = this.formatTime(lastseen * 1E3);
    var trId = "dialog.last" + (gender == 2 ? "Female" : gender ? "Male" : "") + "Visit";
    if(dt.now) {
      dt = WA.tr(trId, {date:WA.tr("dialog.date", {date:dt.value})})
    }else {
      if(dt.minutes) {
        dt = WA.tr(trId, {date:WA.tr("dialog.date", {date:dt.value + WA.tr("notify.timeElapsed")})})
      }else {
        if(dt.hours) {
          dt = WA.tr(trId, {atTime:WA.tr("dialog.atTime", {time:dt.time})}).replace(/\s{2,}/g, " ")
        }else {
          if(now.getTime() - ts.getTime() < 7 * WA.DAY * 1E3) {
            if(dt.yesterday) {
              dt.value = WA.tr("dialog.date", {date:WA.tr("time.yesterday")})
            }else {
              dt.value = dt.day
            }
            dt = WA.tr(trId, {date:dt.value, atTime:WA.tr("dialog.atTime", {time:dt.time})})
          }else {
            if(now.getFullYear() > ts.getFullYear()) {
              if(now.getTime() - ts.getTime() > 365 * WA.DAY * 1E3) {
                dt = WA.tr(trId, {date:WA.tr("dialog.longTimeAgo")})
              }else {
                dt = WA.tr(trId, {date:WA.tr("dialog.date", {date:dt.dateShortString + " " + ts.getFullYear()})})
              }
            }else {
              dt.value = WA.tr("dialog.date", {date:dt.value});
              dt = WA.tr(trId, {date:dt.value, atTime:WA.tr("dialog.atTime", {time:dt.time})})
            }
          }
        }
      }
    }
    return dt
  }}
})();
WebAgent.namespace("WebAgent.util");
(function() {
  var WA = WebAgent;
  WA.util.DelayedTask = WA.extend(Object, {constructor:function(config) {
    WA.apply(this, config);
    this.id = null;
    if(this.fn) {
      this._initFn(this.fn, this.scope)
    }
  }, _initFn:function(fn, scope) {
    this.scope = scope || this.scope || this;
    this.fn = WA.createDelegate(fn, this.scope)
  }, isStarted:function() {
    return this.id != null
  }, start:function(interval, fn, scope) {
    if(this.isStarted()) {
      this.stop()
    }
    if(!(interval > 0)) {
      interval = this.interval
    }
    if(fn) {
      this._initFn(fn, scope)
    }
    this.id = WA.setTimeout(this.fn, interval)
  }, startNow:function() {
    this.fn();
    this.start.apply(this, arguments)
  }, stop:function() {
    if(this.isStarted()) {
      clearTimeout(this.id);
      this.id = null
    }
  }})
})();
WebAgent.namespace("WebAgent.util");
(function() {
  var WA = WebAgent;
  var U = WA.util;
  var tableRe = /^(?:table|tbody|tr|td)$/i;
  var tableElRe = /^(?:td|tr|tbody)$/i;
  var emptyTags = /^(?:br|frame|hr|img|input|link|meta|range|spacer|wbr|area|param|col)/i;
  var tempTableEl = null;
  var afterbegin = "afterbegin", afterend = "afterend", beforebegin = "beforebegin", beforeend = "beforeend", ts = "<table>", te = "</table>", tbs = ts + "<tbody>", tbe = "</tbody>" + te, trs = tbs + "<tr>", tre = "</tr>" + tbe;
  function ieTable(depth, s, h, e) {
    tempTableEl.innerHTML = [s, h, e].join("");
    var i = -1;
    var el = tempTableEl;
    var ns;
    while(++i < depth) {
      el = el.firstChild
    }
    if(ns = el.nextSibling) {
      var df = document.createDocumentFragment();
      while(el) {
        ns = el.nextSibling;
        df.appendChild(el);
        el = ns
      }
      el = df
    }
    return el
  }
  function insertIntoTable(tag, where, el, html) {
    var node, before;
    tempTableEl = tempTableEl || document.createElement("div");
    if(tag == "td" && (where == afterbegin || where == beforeend) || !tableRe.test(tag) && (where == beforebegin || where == afterend)) {
      return null
    }
    before = where == beforebegin ? el : where == afterend ? el.nextSibling : where == afterbegin ? el.firstChild : null;
    if(where == beforebegin || where == afterend) {
      el = el.parentNode
    }
    if(tag == "td" || tag == "tr" && (where == beforeend || where == afterbegin)) {
      node = ieTable(4, trs, html, tre)
    }else {
      if(tag == "tbody" && (where == beforeend || where == afterbegin) || tag == "tr" && (where == beforebegin || where == afterend)) {
        node = ieTable(3, tbs, html, tbe)
      }else {
        node = ieTable(2, ts, html, te)
      }
    }
    el.insertBefore(node, before);
    return node
  }
  function createHtml(o) {
    var html = "";
    if(WA.isString(o)) {
      html = o
    }else {
      if(WA.isArray(o)) {
        U.Array.each(o, function(entry) {
          html += createHtml(entry)
        })
      }else {
        var tag = o.tag || "div";
        html = "<" + tag;
        var attrs = [];
        U.Object.each(o, function(val, attr) {
          if(U.Array.indexOf(["tag", "children", "html"], attr) == -1) {
            attrs.push(("cls" === attr ? "class" : attr) + '="' + val + '"')
          }
        });
        if(attrs.length > 0) {
          html += " " + attrs.join(" ")
        }
        if(emptyTags.test(tag)) {
          html += "/>"
        }else {
          html += ">";
          if(o.children) {
            html += createHtml(o.children)
          }else {
            if(o.html) {
              html += o.html
            }
          }
          html += "</" + tag + ">"
        }
      }
    }
    return html
  }
  var DH = U.DomHelper = {elementFromHtml:function(html) {
    var dummyNode, ret;
    dummyNode = document.getElementById("dummy-node");
    if(!dummyNode) {
      dummyNode = document.createElement("div");
      dummyNode.id = "dummy-node";
      dummyNode.style.display = "none";
      document.body.appendChild(dummyNode)
    }
    dummyNode.innerHTML = html;
    ret = dummyNode.getElementsByTagName("*")[0];
    return ret
  }, append:function(el, html, returnElement) {
    return DH.insertHtml("beforeEnd", el, html, returnElement)
  }, insertHtml:function(where, el, html, returnElement) {
    var hash = {}, hashVal, setStart, range, frag, rangeEl, rs;
    where = where.toLowerCase();
    html = createHtml(html);
    hash[beforebegin] = ["BeforeBegin", "previousSibling"];
    hash[afterend] = ["AfterEnd", "nextSibling"];
    if(el.insertAdjacentHTML) {
      if(tableRe.test(el.tagName) && (rs = insertIntoTable(el.tagName.toLowerCase(), where, el, html))) {
        return returnElement ? WA.get(rs) : rs
      }
      hash[afterbegin] = ["AfterBegin", "firstChild"];
      hash[beforeend] = ["BeforeEnd", "lastChild"];
      if(hashVal = hash[where]) {
        el.insertAdjacentHTML(hashVal[0], html);
        rs = el[hashVal[1]];
        return returnElement ? WA.get(rs) : rs
      }
    }else {
      range = el.ownerDocument.createRange();
      setStart = "setStart" + (/end/i.test(where) ? "After" : "Before");
      if(hash[where]) {
        range[setStart](el);
        frag = range.createContextualFragment(html);
        el.parentNode.insertBefore(frag, where == beforebegin ? el : el.nextSibling);
        rs = el[(where == beforebegin ? "previous" : "next") + "Sibling"];
        return returnElement ? WA.get(rs) : rs
      }else {
        rangeEl = (where == afterbegin ? "first" : "last") + "Child";
        if(el.firstChild) {
          range[setStart](el[rangeEl]);
          frag = range.createContextualFragment(html);
          if(where == afterbegin) {
            el.insertBefore(frag, el.firstChild)
          }else {
            el.appendChild(frag)
          }
        }else {
          el.innerHTML = html
        }
        rs = el[rangeEl];
        return returnElement ? WA.get(rs) : rs
      }
    }
    WA.error('Illegal insertion point -> "' + where + '"')
  }, whenReady:function(fn, scope) {
    easyXDM.whenReady(fn, scope)
  }, insertFirst:function(el, html) {
    var before;
    if(el && el.getElementsByTagName && (before = el.getElementsByTagName("*")[0])) {
      el.insertBefore(document.createElement("div"), before).innerHTML = createHtml(html)
    }
  }, rapidHtmlInsert:function(html) {
    var before = document.body.getElementsByTagName("*")[0];
    if(document.body && before) {
      document.body.insertBefore(document.createElement("div"), before).innerHTML = createHtml(html)
    }else {
      WA.setTimeout(function() {
        DH.rapidHtmlInsert(html)
      }, 10)
    }
  }, testUrlAsImage:function(url, clbk, scope) {
    var img = new Image;
    typeof clbk == "function" || (clbk = function() {
    });
    scope || (scope = window);
    var on, off;
    if(typeof img.addEventListener == "function") {
      on = function(t, cb) {
        img.addEventListener(t, cb)
      };
      off = function(t, cb) {
        img.removeEventListener(t, cb)
      }
    }else {
      if(img.attachEvent) {
        on = function(t, cb) {
          img.attachEvent("on" + t, cb)
        };
        off = function(t, cb) {
          img.detachEvent("on" + t, cb)
        }
      }else {
        on = function(t, cb) {
          img["on" + t] = cb
        };
        off = function(t, cb) {
          img["on" + t] = undefined
        }
      }
    }
    function Off() {
      off("error", onError);
      off("load", onLoad)
    }
    function onError() {
      Off();
      clbk.call(scope, url, false, img)
    }
    function onLoad() {
      Off();
      if(typeof img.naturalWidth != "undefined") {
        img.width = img.naturalWidth;
        img.height = img.naturalHeight
      }
      clbk.call(scope, url, true, img)
    }
    on("error", onError);
    on("load", onLoad);
    img.src = url;
    return img
  }, htmlEntities:function(str) {
    return(str || "").replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;")
  }, htmlTree:function(el, cb) {
    var el = el || document.getElementsByTagName("body")[0], child;
    if(el.hasChildNodes()) {
      child = el.firstChild;
      while(child) {
        if(child.nodeType === 1) {
          DH.htmlTree(child, cb);
          cb(child)
        }
        child = child.nextSibling
      }
    }
    return el
  }, getWindowSize:function() {
    var winW, winH;
    if(document.body && document.body.offsetWidth) {
      winW = document.body.offsetWidth;
      winH = document.body.offsetHeight
    }
    if(document.compatMode == "CSS1Compat" && document.documentElement && document.documentElement.offsetWidth) {
      winW = document.documentElement.offsetWidth;
      winH = document.documentElement.offsetHeight
    }
    if(window.innerWidth && window.innerHeight) {
      winW = window.innerWidth;
      winH = window.innerHeight
    }
    return{width:winW, height:winH}
  }}
})();
WebAgent.namespace("WebAgent.util");
(function() {
  var WA = WebAgent;
  var U = WA.util;
  var BaseListener = WA.extend(Object, {constructor:function(fn, scope) {
    this.fn = fn;
    this.scope = scope
  }, equals:function(fn, scope) {
    if(this.fn === fn) {
      if(scope) {
        if(this.scope === scope) {
          return true
        }
      }else {
        return true
      }
    }
  }, invoke:function(args) {
    if(this.fn) {
      return this.fn.apply(this.scope || window, args)
    }
  }, destroy:function() {
    delete this.fn;
    delete this.scope
  }});
  var SingleListener = WA.extend(BaseListener, {constructor:function(fn, scope, owner) {
    SingleListener.superclass.constructor.call(this, fn, scope);
    this.owner = owner
  }, invoke:function(args) {
    var ret = SingleListener.superclass.invoke.call(this, args);
    this.owner.removeListener(this.fn, this.scope);
    return ret
  }, destroy:function() {
    SingleListener.superclass.destroy.call(this);
    delete this.owner
  }});
  U.Event = WA.extend(Object, {constructor:function() {
    this.suspended = false;
    this.listeners = []
  }, hasListeners:function() {
    return this.listeners.length > 0
  }, addListener:function(fn, scope, options) {
    options = options || {};
    var listener = null;
    if(options.single === true) {
      listener = new SingleListener(fn, scope, this)
    }else {
      listener = new BaseListener(fn, scope)
    }
    this.listeners.push(listener);
    return this
  }, on:function(fn, scope, options) {
    return this.addListener(fn, scope, options)
  }, findListener:function(fn, scope) {
    return U.Array.indexOfBy(this.listeners, function(listener) {
      return listener.equals(fn, scope)
    })
  }, removeListener:function(fn, scope) {
    var index = this.findListener(fn, scope);
    if(index != -1) {
      var listener = this.listeners[index];
      listener.destroy();
      if(this.firing) {
        this.__listeners = this.listeners.slice(0)
      }
      this.listeners.splice(index, 1)
    }
    return this
  }, un:function(fn, scope) {
    return this.removeListener(fn, scope)
  }, fire:function() {
    var ret = true;
    if(!this.suspended) {
      var args = arguments;
      this.firing = true;
      var listeners = this.listeners.slice(0);
      U.Array.each(listeners, function(listener, i) {
        if(listener.invoke(args) === false) {
          return ret = false
        }
      }, this);
      this.firing = false;
      if(this._needRemoveAll) {
        delete this._needRemoveAll;
        this.removeAll()
      }
    }
    return ret
  }, removeAll:function() {
    if(!this.firing) {
      while(this.listeners.length > 0) {
        var listener = this.listeners.shift();
        listener.destroy()
      }
    }else {
      this._needRemoveAll = true
    }
  }, relay:function(event) {
    event.on(function() {
      return this.fire.apply(this, arguments)
    }, this);
    return this
  }, suspend:function() {
    this.suspended = true
  }, resume:function() {
    this.suspended = false
  }});
  WA.afterFirstExecEvent = new U.Event
})();
WebAgent.namespace("WebAgent.util");
(function() {
  var WA = WebAgent;
  var U = WA.util;
  U.EventConfirm = WA.extend(U.Event, {fire:function() {
    var ret = true;
    if(!this.suspended) {
      this.firing = true;
      var args = Array.prototype.slice.call(arguments, 0);
      var readyCb = args.shift();
      if(readyCb && readyCb.success) {
        readyCb = WA.createDelegate(readyCb.success, readyCb.scope || window)
      }
      var confirmCount = 0;
      var checkReady = function() {
        if(confirmCount == 0) {
          readyCb && readyCb()
        }
      };
      args.push(function() {
        confirmCount--;
        checkReady()
      });
      var listeners = this.listeners.slice(0);
      U.Array.each(listeners, function(listener, i) {
        var r = listener.invoke(args);
        if(r === false) {
          return ret = false
        }else {
          if(r === true) {
            confirmCount++
          }
        }
      }, this);
      checkReady();
      this.firing = false
    }
    return ret
  }})
})();
WebAgent.namespace("WebAgent.util");
(function() {
  var WA = WebAgent;
  var U = WA.util;
  U.EventDispatcher = WA.extend(Object, {constructor:function() {
    this._listeners = {}
  }, addEventListener:function(type, cb) {
    if(!this._listeners[type]) {
      this._listeners[type] = []
    }
    this._listeners[type].push(cb)
  }, dispatchEvent:function(type, event) {
    if(this["on" + type]) {
      this["on" + type](event)
    }
    var listeners = this._listeners[type];
    if(listeners) {
      for(var i = 0;i < listeners.length;i++) {
        listeners[i].call(window, event)
      }
    }
  }, removeEventListener:function(type, cb) {
    var listeners = this._listeners[type];
    if(listeners) {
      var res = [];
      for(var i = 0;i < listeners.length;i++) {
        if(listeners[i] !== cb) {
          res.push(listeners[i])
        }
      }
      this._listeners[type] = res
    }
  }, destroy:function() {
  }})
})();
WebAgent.namespace("WebAgent.util");
(function() {
  var WA = WebAgent;
  var srcChar = "qwertyuiopasdfghjklzxcvbnm[{]};:',<.> Ð¹ÑÑÐºÐµÐ½Ð³ÑÑÐ·ÑÑÑÑÐ²Ð°Ð¿ÑÐ¾Ð»Ð´Ð¶ÑÑÑÑÐ¼Ð¸ÑÑÐ±Ñ";
  var mapChar = "Ð¹ÑÑÐºÐµÐ½Ð³ÑÑÐ·ÑÑÐ²Ð°Ð¿ÑÐ¾Ð»Ð´ÑÑÑÐ¼Ð¸ÑÑÑÑÑÑÐ¶Ð¶ÑÐ±Ð±ÑÑ qwertyuiop[]asdfghjkl;'zxcvbnm,.";
  var delimPos = 37;
  WA.util.KeyMapping = {translate:function(word) {
    var alterWord = "", len = 0, lang = null, pos = -1, nextChar = "", i = 0;
    word = (word || "").toLowerCase();
    len = word.length;
    while(i < len) {
      nextChar = word[i++];
      pos = srcChar.indexOf(nextChar);
      if(!lang) {
        if(pos > -1 && pos < delimPos) {
          lang = "en"
        }else {
          if(pos > delimPos) {
            lang = "ru"
          }
        }
      }
      if(lang == "ru" && pos > delimPos || lang == "en" && pos < delimPos && pos > -1) {
        nextChar = mapChar[pos]
      }
      alterWord += nextChar
    }
    return alterWord
  }}
})();
WebAgent.namespace("WebAgent.util");
(function() {
  var WA = WebAgent;
  var U = WA.util;
  if(window.patron && patron.notificationLocker) {
    var notifyLocker = patron.notificationLocker()
  }
  if(!notifyLocker) {
    notifyLocker = {_locked:false, isLocked:function() {
      return this._locked
    }, setLock:function(v) {
      this._locked = typeof v != "undefined" ? v : true
    }, onUnLock:function() {
      this._locked = false
    }}
  }
  U.MailApi = {getFlag:function(index, cb, scope) {
    if(window.patron && patron.HelperStatus) {
      cb.call(scope || window, !!(patron.HelperStatus & 1 << index));
      return
    }
    this.getUser(function(user) {
      var flag = !!(user.helper.status & 1 << index);
      cb.call(scope || window, flag)
    }, this)
  }, getFlagTime:function(index, cb, scope) {
    if(window.patron && patron.HelperTimestamp) {
      cb.call(scope || window, patron.HelperTimestamp[index]);
      return
    }
    this.getUser(function(user) {
      cb.call(scope || window, user.helper.time[index])
    }, this)
  }, getUser:function(cb, scope) {
    if(window.patron && patron.HelperTimestamp && patron.HelperStatus) {
      var data = {helper:{}};
      data.helper.status = patron.HelperStatus;
      data.helper.time = patron.HelperTimestamp;
      data.reg_date = patron.RegTime;
      cb.call(scope || window, data);
      return
    }
    this._getToken(function(token) {
      this._request("user", {token:token}, function(err, data) {
        if(!err) {
          cb.call(scope || window, data)
        }
      }, this)
    }, this)
  }, setFlag:function(index, cb, scope) {
    this._getToken(function(token) {
      this._request("helper/set", {token:token, index:index}, cb, scope)
    }, this)
  }, unsetFlag:function(index, cb, scope) {
    this._getToken(function(token) {
      this._request("helper/unset", {token:token, index:index}, cb, scope)
    }, this)
  }, updateFlagTime:function(index, cb, scope) {
    this._getToken(function(token) {
      this._request("helper/set/timestamp", {token:token, index:index}, cb, scope)
    }, this)
  }, _getToken:function(cb, scope) {
    this._request("tokens", {}, function(err, data) {
      if(!err) {
        cb.call(scope || window, data.token)
      }
    }, this)
  }, _request:function(method, params, cb, scope, timeout) {
    if(timeout) {
      var tmr = WA.setTimeout(function() {
        cb.call(scope || window, "timeout")
      }, timeout, this)
    }
    params || (params = {});
    params.email = WA.ACTIVE_MAIL;
    SOCK.send("api/v1/" + method, params, function(success, response) {
      clearTimeout(tmr);
      var data = response && response.data && WA.getJSON().parse(response.data);
      if(!data || !data.status) {
        cb && cb.call(this, "unknown")
      }else {
        if(data.status != 200) {
          cb && cb.call(this, data.status)
        }else {
          cb && cb.call(this, false, data.body)
        }
      }
    }, scope)
  }, lockNotify:function() {
    if(!notifyLocker.isLocked()) {
      notifyLocker.setLock(true);
      return true
    }else {
      return false
    }
  }, unlockNotify:function() {
    notifyLocker.isLocked() && notifyLocker.setLock(false)
  }}
})();
WebAgent.namespace("WebAgent.util");
(function() {
  var WA = WebAgent;
  var U = WA.util;
  var SPEED = 0.2;
  var MsgAnimation = WA.extend(Object, {constructor:function() {
    this.elements = {};
    this._opacity = 0;
    this._animTimer = -1
  }, start:function(el, key) {
    this.elements[key] = el;
    if(this._animTimer == -1) {
      this._animTimer = U.animation.start(this._opacity, 100, SPEED, this._onFadeFrame, this)
    }
  }, setOpacity:function(el, value) {
    el.setStyle("opacity", value / 100);
    this._opacity = value
  }, _onFadeFrame:function(value, lastFrame) {
    var hasEl = false, el, key;
    for(key in this.elements) {
      el = this.elements[key];
      if(el) {
        if(el && !el.isDetached()) {
          hasEl = true;
          this.setOpacity(el, value)
        }else {
          this.stop(key)
        }
      }
    }
    if(!hasEl) {
      U.animation.clear(this._animTimer);
      this._animTimer = -1;
      return
    }
    if(lastFrame) {
      this._animTimer = U.animation.start(this._opacity, value == 0 ? 100 : 0, SPEED, this._onFadeFrame, this)
    }
  }, stop:function(key) {
    if(this.elements[key]) {
      this.elements[key].setStyle("opacity", 1)
    }
    delete this.elements[key]
  }, stopPrefix:function(prefix) {
    for(var key in this.elements) {
      if(key.indexOf(prefix) === 0) {
        this.stop(key)
      }
    }
  }, toggle:function(el, key, start) {
    return start ? this.start(el, key) : this.stop(key)
  }});
  U.msgAnimation = new MsgAnimation
})();
WebAgent.namespace("WebAgent.util");
(function() {
  var WA = WebAgent;
  var U = WA.util;
  var JSON = WA.getJSON();
  var stErrorTs = 0, stErCounter = 0;
  var M = WA.extend(Object, {constructor:function() {
  }, log:function(params) {
    if(WA.isDebug) {
      return
    }
    try {
      if(typeof params == "object") {
        params = WA.makeGet(params)
      }
    }catch(e) {
    }
    (new Image).src = "//mrilog.mail.ru/empty.gif?" + params + "&WAGENT&resPath=" + WebAgent.resPath + "&location=" + document.location + "&rnd=" + Math.random()
  }, errorReason:function(msg, cb, scope) {
    this._errorReason = msg;
    cb.call(scope || window);
    delete this._errorReason
  }, wrapTryCatch:function(cb, scope) {
    if(WA.isProduction) {
      try {
        cb.call(scope || window)
      }catch(e) {
        this.catchException(e)
      }
    }else {
      cb.call(scope || window)
    }
  }, catchException:function(e) {
    try {
      if(!("message" in e)) {
        try {
          e = {message:JSON.stringify(e)}
        }catch(nope) {
        }
      }
    }catch(nope) {
      e = {message:"" + e}
    }
    try {
      if(typeof e.message == "string" && e.message.indexOf("STRGFFERROR") > -1) {
        var nd = +new Date;
        if(stErrorTs < nd) {
          stErrorTs = nd + 3E4;
          e.message = e.message.substring(11)
        }else {
          stErCounter++;
          return
        }
      }
      this.err("js");
      var stack = e.stack;
      if(!stack) {
        stack = e.fileName + ":" + (e.line || e.lineNumber)
      }
      var err = ["login=" + encodeURIComponent(WA.ACTIVE_MAIL), "message=" + encodeURIComponent(e.description || JSON.stringify(e.message)), "stack=" + encodeURIComponent(stack)];
      if(stErCounter > 0) {
        err.push("errcounter=" + stErCounter);
        stErCounter = 0
      }
      if(this._errorReason) {
        err.push("reason=" + encodeURIComponent(this._errorReason))
      }
      this.log(err.join("&"))
    }catch(e) {
      this.log("error on stringify error: " + e)
    }
  }, err:function(type) {
    if(WA.isDebug) {
      return
    }
    (new Image).src = "//stat.radar.imgsmail.ru/update?p=wagenterr&t=" + type + "&v=1&rnd=" + Math.random()
  }, _intData:WA._intData || {}, interval:function(type, name, timeout) {
    var now = +new Date;
    if(!this._intData[type]) {
      this._intData[type] = {start:now, list:{}};
      if(timeout) {
        this._intData[type].timeout = WA.setTimeout(function() {
          this.flushInterval(type, true)
        }, timeout, this)
      }
    }
    if(name) {
      var list = this._intData[type].list;
      if(!list[name]) {
        list[name] = {ts:now}
      }else {
        list[name].i = now - list[name].ts
      }
    }
  }, endPart:function(type, name) {
    if(name && this._intData[type] && this._intData[type].list[name]) {
      this._intData[type].list[name].i = +new Date - this._intData[type].list[name].ts
    }
  }, stopInterval:function(type) {
    clearTimeout(this._intData[type].timeout);
    delete this._intData[type]
  }, flushInterval:function(type, noCloseIntervals) {
    var now = +new Date;
    var parts = [];
    var interval = this._intData[type];
    if(interval) {
      var value = now - interval.start;
      U.Object.each(interval.list, function(part, name) {
        if(!("i" in part) && !noCloseIntervals) {
          part.i = now - part.ts
        }
        if("i" in part) {
          parts.push(name + ":" + part.i)
        }
      }, this);
      (new Image).src = "//stat.radar.imgsmail.ru/update?p=wa&t=" + type + "&v=" + value + "&i=" + parts.join(";") + "&rnd=" + Math.random();
      this.stopInterval(type)
    }
  }, rbCountSubmitDomain:function() {
    var id = {"otvet":"790314", "webagent":"32427972", "e":"726182", "my":"726184", "foto":"726184", "video":"726184", "news":"726185", "maps":"726193", "pogoda":"827834", "health":"827835", "agent":"32427974", "sys":"32427982"}[location.host.split(".")[0]];
    if(id) {
      this.countRB(id)
    }else {
      this.countRB("32427984")
    }
  }, countRB:function(id, click) {
    var url = "//rs.mail.ru/" + (click ? "sb" : "d") + id + ".gif";
    WA.setTimeout(function() {
      (new Image).src = url + "?rnd=" + Math.random()
    }, 0)
  }});
  U.Mnt = new M
})();
WebAgent.namespace("WebAgent.util");
(function() {
  var O = WebAgent.util.Object = {each:function(obj, fn, scope) {
    for(var key in obj) {
      if(obj.hasOwnProperty(key)) {
        if(fn.call(scope || window, obj[key], key) === false) {
          return
        }
      }
    }
  }, filter:function(obj, fn, scope) {
    var ret = {};
    this.each(obj, function(val, key) {
      if(fn.call(scope || window, val, key)) {
        ret[key] = val
      }
    }, scope);
    return ret
  }, getLength:function(obj) {
    var ret = 0;
    this.each(obj, function() {
      ret++
    });
    return ret
  }, pair:function(key, value) {
    var o = {};
    o[key] = value;
    return o
  }, getKeys:function(obj) {
    var keys = [];
    O.each(obj, function(ignored, key) {
      keys.push(key)
    });
    return keys
  }, checkChain:function(obj, propChain, propDefVal, resultRef) {
    resultRef || (resultRef = []);
    propDefVal || (propDefVal = {});
    var existChain = [];
    for(var i = 0;i < propChain.length;i++) {
      var prop = propChain[i];
      existChain.push(prop);
      if(obj && !(prop in obj) && prop in propDefVal) {
        obj[prop] = propDefVal[prop]
      }
      if(!obj || !(prop in obj)) {
        resultRef.push({result:false, chain:existChain});
        return false
      }else {
        obj = obj[prop]
      }
    }
    resultRef.push({result:true, value:obj});
    return true
  }, diff:function(oldHash, newHash) {
    var res = {}, isDiff = false;
    this.each(newHash, function(value, key) {
      if(oldHash[key] != value) {
        res[key] = value;
        isDiff = true
      }
    });
    return isDiff ? res : false
  }, extend:function(dest, source) {
    for(var key in source) {
      dest[key] = source[key]
    }
    return dest
  }}
})();
WebAgent.namespace("WebAgent.util");
(function() {
  if("getSelection" in window) {
    return
  }
  var initRangy = function() {
    var rangy;
    rangy = WebAgent.util.rangy = function() {
      function h(c, d) {
        var e = typeof c[d];
        return e == b || e == a && !!c[d] || e == "unknown"
      }
      function i(b, c) {
        return typeof b[c] == a && !!b[c]
      }
      function j(a, b) {
        return typeof a[b] != c
      }
      function k(a) {
        return function(b, c) {
          var d = c.length;
          while(d--) {
            if(!a(b, c[d])) {
              return!1
            }
          }
          return!0
        }
      }
      function o(a) {
        return a && l(a, g) && n(a, f)
      }
      function q(a, b) {
        b ? window.alert(a) : typeof window.console != c && typeof window.console.log != c && window.console.log(a)
      }
      function r(a) {
        p.initialized = !0, p.supported = !1, q("Rangy is not supported on this page in your browser. Reason: " + a, p.config.alertOnFail)
      }
      function s(a) {
        q("Rangy warning: " + a, p.config.alertOnWarn)
      }
      function v() {
        if(p.initialized) {
          return
        }
        var a, b = !1, c = !1;
        h(document, "createRange") && (a = document.createRange(), l(a, e) && n(a, d) && (b = !0), a.detach());
        var f = i(document, "body") ? document.body : document.getElementsByTagName("body")[0];
        if(!f || f.nodeName.toLowerCase() != "body") {
          r("No body element found");
          return
        }
        f && h(f, "createTextRange") && (a = f.createTextRange(), o(a) && (c = !0));
        if(!b && !c) {
          r("Neither Range nor TextRange are available");
          return
        }
        p.initialized = !0, p.features = {implementsDomRange:b, implementsTextRange:c};
        var g = u.concat(t);
        for(var j = 0, k = g.length;j < k;++j) {
          try {
            g[j](p)
          }catch(m) {
            i(window, "console") && h(window.console, "log") && window.console.log("Rangy init listener threw an exception. Continuing.", m)
          }
        }
      }
      function x(a) {
        a = a || window, v();
        for(var b = 0, c = w.length;b < c;++b) {
          w[b](a)
        }
      }
      function y(a) {
        this.name = a, this.initialized = !1, this.supported = !1
      }
      var a = "object", b = "function", c = "undefined", d = ["startContainer", "startOffset", "endContainer", "endOffset", "collapsed", "commonAncestorContainer"], e = ["setStart", "setStartBefore", "setStartAfter", "setEnd", "setEndBefore", "setEndAfter", "collapse", "selectNode", "selectNodeContents", "compareBoundaryPoints", "deleteContents", "extractContents", "cloneContents", "insertNode", "surroundContents", "cloneRange", "toString", "detach"], f = ["boundingHeight", "boundingLeft", "boundingTop", 
      "boundingWidth", "htmlText", "text"], g = ["collapse", "compareEndPoints", "duplicate", "moveToElementText", "parentElement", "select", "setEndPoint", "getBoundingClientRect"], l = k(h), m = k(i), n = k(j), p = {version:"1.3alpha.681", initialized:!1, supported:!0, util:{isHostMethod:h, isHostObject:i, isHostProperty:j, areHostMethods:l, areHostObjects:m, areHostProperties:n, isTextRange:o}, features:{}, modules:{}, config:{alertOnFail:!0, alertOnWarn:!1, preferTextRange:!1}};
      p.fail = r, p.warn = s, {}.hasOwnProperty ? p.util.extend = function(a, b, c) {
        var d, e;
        for(var f in b) {
          b.hasOwnProperty(f) && (d = a[f], e = b[f], c && d !== null && typeof d == "object" && e !== null && typeof e == "object" && p.util.extend(d, e, !0), a[f] = e)
        }
        return a
      } : r("hasOwnProperty not supported");
      var t = [], u = [];
      p.init = v, p.addInitListener = function(a) {
        p.initialized ? a(p) : t.push(a)
      };
      var w = [];
      p.addCreateMissingNativeApiListener = function(a) {
        w.push(a)
      }, p.createMissingNativeApi = x, y.prototype = {fail:function(a) {
        throw this.initialized = !0, this.supported = !1, new Error("Module '" + this.name + "' failed to load: " + a);
      }, warn:function(a) {
        p.warn("Module " + this.name + ": " + a)
      }, deprecationNotice:function(a, b) {
        p.warn("DEPRECATED: " + a + " in module " + this.name + "is deprecated. Please use " + b + " instead")
      }, createError:function(a) {
        return new Error("Error in Rangy " + this.name + " module: " + a)
      }}, p.createModule = function(a, b) {
        var c = new y(a);
        p.modules[a] = c, u.push(function(a) {
          b(a, c), c.initialized = !0, c.supported = !0
        })
      }, p.requireModules = function(a) {
        for(var b = 0, c = a.length, d, e;b < c;++b) {
          e = a[b], d = p.modules[e];
          if(!d || !(d instanceof y)) {
            throw new Error("Module '" + e + "' not found");
          }
          if(!d.supported) {
            throw new Error("Module '" + e + "' not supported");
          }
        }
      };
      var z = !1, A = function(a) {
        z || (z = !0, p.initialized || v())
      };
      if(typeof window == c) {
        r("No window found");
        return
      }
      if(typeof document == c) {
        r("No document found");
        return
      }
      return h(document, "addEventListener") && document.addEventListener("DOMContentLoaded", A, !1), h(window, "addEventListener") ? window.addEventListener("load", A, !1) : h(window, "attachEvent") ? window.attachEvent("onload", A) : r("Window does not have required addEventListener or attachEvent method"), p
    }(), rangy.createModule("DomUtil", function(a, b) {
      function h(a) {
        var b;
        return typeof a.namespaceURI == c || (b = a.namespaceURI) === null || b == "http://www.w3.org/1999/xhtml"
      }
      function i(a) {
        var b = a.parentNode;
        return b.nodeType == 1 ? b : null
      }
      function j(a) {
        var b = 0;
        while(a = a.previousSibling) {
          b++
        }
        return b
      }
      function k(a) {
        switch(a.nodeType) {
          case 7:
          ;
          case 10:
            return 0;
          case 3:
          ;
          case 8:
            return a.length;
          default:
            return a.childNodes.length
        }
      }
      function l(a, b) {
        var c = [], d;
        for(d = a;d;d = d.parentNode) {
          c.push(d)
        }
        for(d = b;d;d = d.parentNode) {
          if(g(c, d)) {
            return d
          }
        }
        return null
      }
      function m(a, b, c) {
        var d = c ? b : b.parentNode;
        while(d) {
          if(d === a) {
            return!0
          }
          d = d.parentNode
        }
        return!1
      }
      function n(a, b) {
        return m(a, b, !0)
      }
      function o(a, b, c) {
        var d, e = c ? a : a.parentNode;
        while(e) {
          d = e.parentNode;
          if(d === b) {
            return e
          }
          e = d
        }
        return null
      }
      function p(a) {
        var b = a.nodeType;
        return b == 3 || b == 4 || b == 8
      }
      function q(a) {
        if(!a) {
          return!1
        }
        var b = a.nodeType;
        return b == 3 || b == 8
      }
      function r(a, b) {
        var c = b.nextSibling, d = b.parentNode;
        return c ? d.insertBefore(a, c) : d.appendChild(a), a
      }
      function s(a, b, c) {
        var d = a.cloneNode(!1);
        d.deleteData(0, b), a.deleteData(b, a.length - b), r(d, a);
        if(c) {
          for(var e = 0, f;f = c[e++];) {
            f.node == a && f.offset > b ? (f.node = d, f.offset -= b) : f.node == a.parentNode && f.offset > j(a) && ++f.offset
          }
        }
        return d
      }
      function t(a) {
        if(a.nodeType == 9) {
          return a
        }
        if(typeof a.ownerDocument != c) {
          return a.ownerDocument
        }
        if(typeof a.document != c) {
          return a.document
        }
        if(a.parentNode) {
          return t(a.parentNode)
        }
        throw b.createError("getDocument: no document found for node");
      }
      function u(a) {
        var d = t(a);
        if(typeof d.defaultView != c) {
          return d.defaultView
        }
        if(typeof d.parentWindow != c) {
          return d.parentWindow
        }
        throw b.createError("Cannot get a window object for node");
      }
      function v(a) {
        if(typeof a.contentDocument != c) {
          return a.contentDocument
        }
        if(typeof a.contentWindow != c) {
          return a.contentWindow.document
        }
        throw b.createError("getIframeDocument: No Document object found for iframe element");
      }
      function w(a) {
        if(typeof a.contentWindow != c) {
          return a.contentWindow
        }
        if(typeof a.contentDocument != c) {
          return a.contentDocument.defaultView
        }
        throw b.createError("getIframeWindow: No Window object found for iframe element");
      }
      function x(a) {
        return d.isHostObject(a, "body") ? a.body : a.getElementsByTagName("body")[0]
      }
      function y(a) {
        return a && d.isHostMethod(a, "setTimeout") && d.isHostObject(a, "document")
      }
      function z(a) {
        var b;
        return a ? d.isHostProperty(a, "nodeType") ? b = a.nodeType == 1 && a.tagName.toLowerCase() == "iframe" ? v(a) : t(a) : y(a) && (b = a.document) : b = document, b
      }
      function A(a) {
        var b;
        while(b = a.parentNode) {
          a = b
        }
        return a
      }
      function B(a, c, d, e) {
        var f, g, h, i, k;
        if(a == d) {
          return c === e ? 0 : c < e ? -1 : 1
        }
        if(f = o(d, a, !0)) {
          return c <= j(f) ? -1 : 1
        }
        if(f = o(a, d, !0)) {
          return j(f) < e ? -1 : 1
        }
        g = l(a, d), h = a === g ? g : o(a, g, !0), i = d === g ? g : o(d, g, !0);
        if(h === i) {
          throw b.createError("comparePoints got to case 4 and childA and childB are the same!");
        }
        k = g.firstChild;
        while(k) {
          if(k === h) {
            return-1
          }
          if(k === i) {
            return 1
          }
          k = k.nextSibling
        }
      }
      function C(a) {
        if(!a) {
          return"[No node]"
        }
        if(p(a)) {
          return'"' + a.data + '"'
        }
        if(a.nodeType == 1) {
          var b = a.id ? ' id="' + a.id + '"' : "";
          return"<" + a.nodeName + b + ">[" + a.childNodes.length + "]"
        }
        return a.nodeName
      }
      function D(a) {
        var b = t(a).createDocumentFragment(), c;
        while(c = a.firstChild) {
          b.appendChild(c)
        }
        return b
      }
      function E(a) {
        this.root = a, this._next = a
      }
      function F(a) {
        return new E(a)
      }
      function G(a, b) {
        this.node = a, this.offset = b
      }
      function H(a) {
        this.code = this[a], this.codeName = a, this.message = "DOMException: " + this.codeName
      }
      var c = "undefined", d = a.util;
      d.areHostMethods(document, ["createDocumentFragment", "createElement", "createTextNode"]) || b.fail("document missing a Node creation method"), d.isHostMethod(document, "getElementsByTagName") || b.fail("document missing getElementsByTagName method");
      var e = document.createElement("div");
      d.areHostMethods(e, ["insertBefore", "appendChild", "cloneNode"] || !d.areHostObjects(e, ["previousSibling", "nextSibling", "childNodes", "parentNode"])) || b.fail("Incomplete Element implementation"), d.isHostProperty(e, "innerHTML") || b.fail("Element is missing innerHTML property");
      var f = document.createTextNode("test");
      d.areHostMethods(f, ["splitText", "deleteData", "insertData", "appendData", "cloneNode"] || !d.areHostObjects(e, ["previousSibling", "nextSibling", "childNodes", "parentNode"]) || !d.areHostProperties(f, ["data"])) || b.fail("Incomplete Text Node implementation");
      var g = function(a, b) {
        var c = a.length;
        while(c--) {
          if(a[c] === b) {
            return!0
          }
        }
        return!1
      };
      E.prototype = {_current:null, hasNext:function() {
        return!!this._next
      }, next:function() {
        var a = this._current = this._next, b, c;
        if(this._current) {
          b = a.firstChild;
          if(b) {
            this._next = b
          }else {
            c = null;
            while(a !== this.root && !(c = a.nextSibling)) {
              a = a.parentNode
            }
            this._next = c
          }
        }
        return this._current
      }, detach:function() {
        this._current = this._next = this.root = null
      }}, G.prototype = {equals:function(a) {
        return!!a && this.node === a.node && this.offset == a.offset
      }, inspect:function() {
        return"[DomPosition(" + C(this.node) + ":" + this.offset + ")]"
      }, toString:function() {
        return this.inspect()
      }}, H.prototype = {INDEX_SIZE_ERR:1, HIERARCHY_REQUEST_ERR:3, WRONG_DOCUMENT_ERR:4, NO_MODIFICATION_ALLOWED_ERR:7, NOT_FOUND_ERR:8, NOT_SUPPORTED_ERR:9, INVALID_STATE_ERR:11}, H.prototype.toString = function() {
        return this.message
      }, a.dom = {arrayContains:g, isHtmlNamespace:h, parentElement:i, getNodeIndex:j, getNodeLength:k, getCommonAncestor:l, isAncestorOf:m, isOrIsAncestorOf:n, getClosestAncestorIn:o, isCharacterDataNode:p, isTextOrCommentNode:q, insertAfter:r, splitDataNode:s, getDocument:t, getWindow:u, getIframeWindow:w, getIframeDocument:v, getBody:x, isWindow:y, getContentDocument:z, getRootContainer:A, comparePoints:B, inspectNode:C, fragmentFromNodeChildren:D, createIterator:F, DomPosition:G}, a.DOMException = 
      H
    }), rangy.createModule("DomRange", function(a, b) {
      function g(a, b) {
        return a.nodeType != 3 && (c.isOrIsAncestorOf(a, b.startContainer) || c.isOrIsAncestorOf(a, b.endContainer))
      }
      function h(a) {
        return c.getDocument(a.startContainer)
      }
      function i(a) {
        return new e(a.parentNode, c.getNodeIndex(a))
      }
      function j(a) {
        return new e(a.parentNode, c.getNodeIndex(a) + 1)
      }
      function k(a, b, d) {
        var e = a.nodeType == 11 ? a.firstChild : a;
        return c.isCharacterDataNode(b) ? d == b.length ? c.insertAfter(a, b) : b.parentNode.insertBefore(a, d == 0 ? b : c.splitDataNode(b, d)) : d >= b.childNodes.length ? b.appendChild(a) : b.insertBefore(a, b.childNodes[d]), e
      }
      function l(a, b, d) {
        O(a), O(b);
        if(h(b) != h(a)) {
          throw new f("WRONG_DOCUMENT_ERR");
        }
        var e = c.comparePoints(a.startContainer, a.startOffset, b.endContainer, b.endOffset), g = c.comparePoints(a.endContainer, a.endOffset, b.startContainer, b.startOffset);
        return d ? e <= 0 && g >= 0 : e < 0 && g > 0
      }
      function m(a) {
        var b;
        for(var c, d = h(a.range).createDocumentFragment(), e;c = a.next();) {
          b = a.isPartiallySelectedSubtree(), c = c.cloneNode(!b), b && (e = a.getSubtreeIterator(), c.appendChild(m(e)), e.detach(!0));
          if(c.nodeType == 10) {
            throw new f("HIERARCHY_REQUEST_ERR");
          }
          d.appendChild(c)
        }
        return d
      }
      function n(a, b, d) {
        var e, f;
        d = d || {stop:!1};
        for(var g, h;g = a.next();) {
          if(a.isPartiallySelectedSubtree()) {
            if(b(g) === !1) {
              d.stop = !0;
              return
            }
            h = a.getSubtreeIterator(), n(h, b, d), h.detach(!0);
            if(d.stop) {
              return
            }
          }else {
            e = c.createIterator(g);
            while(f = e.next()) {
              if(b(f) === !1) {
                d.stop = !0;
                return
              }
            }
          }
        }
      }
      function o(a) {
        var b;
        while(a.next()) {
          a.isPartiallySelectedSubtree() ? (b = a.getSubtreeIterator(), o(b), b.detach(!0)) : a.remove()
        }
      }
      function p(a) {
        for(var b, c = h(a.range).createDocumentFragment(), d;b = a.next();) {
          a.isPartiallySelectedSubtree() ? (b = b.cloneNode(!1), d = a.getSubtreeIterator(), b.appendChild(p(d)), d.detach(!0)) : a.remove();
          if(b.nodeType == 10) {
            throw new f("HIERARCHY_REQUEST_ERR");
          }
          c.appendChild(b)
        }
        return c
      }
      function q(a, b, c) {
        var d = !!b && !!b.length, e, f = !!c;
        d && (e = new RegExp("^(" + b.join("|") + ")$"));
        var g = [];
        return n(new s(a, !1), function(a) {
          (!d || e.test(a.nodeType)) && (!f || c(a)) && g.push(a)
        }), g
      }
      function r(a) {
        var b = typeof a.getName == "undefined" ? "Range" : a.getName();
        return"[" + b + "(" + c.inspectNode(a.startContainer) + ":" + a.startOffset + ", " + c.inspectNode(a.endContainer) + ":" + a.endOffset + ")]"
      }
      function s(a, b) {
        this.range = a, this.clonePartiallySelectedTextNodes = b;
        if(!a.collapsed) {
          this.sc = a.startContainer, this.so = a.startOffset, this.ec = a.endContainer, this.eo = a.endOffset;
          var d = a.commonAncestorContainer;
          this.sc === this.ec && c.isCharacterDataNode(this.sc) ? (this.isSingleCharacterDataNode = !0, this._first = this._last = this._next = this.sc) : (this._first = this._next = this.sc === d && !c.isCharacterDataNode(this.sc) ? this.sc.childNodes[this.so] : c.getClosestAncestorIn(this.sc, d, !0), this._last = this.ec === d && !c.isCharacterDataNode(this.ec) ? this.ec.childNodes[this.eo - 1] : c.getClosestAncestorIn(this.ec, d, !0))
        }
      }
      function t(a) {
        this.code = this[a], this.codeName = a, this.message = "RangeException: " + this.codeName
      }
      function z(a) {
        return function(b, d) {
          var e, f = d ? b : b.parentNode;
          while(f) {
            e = f.nodeType;
            if(c.arrayContains(a, e)) {
              return f
            }
            f = f.parentNode
          }
          return null
        }
      }
      function E(a, b) {
        if(D(a, b)) {
          throw new t("INVALID_NODE_TYPE_ERR");
        }
      }
      function F(a) {
        if(!a.startContainer) {
          throw new f("INVALID_STATE_ERR");
        }
      }
      function G(a, b) {
        if(!c.arrayContains(b, a.nodeType)) {
          throw new t("INVALID_NODE_TYPE_ERR");
        }
      }
      function H(a, b) {
        if(b < 0 || b > (c.isCharacterDataNode(a) ? a.length : a.childNodes.length)) {
          throw new f("INDEX_SIZE_ERR");
        }
      }
      function I(a, b) {
        if(B(a, !0) !== B(b, !0)) {
          throw new f("WRONG_DOCUMENT_ERR");
        }
      }
      function J(a) {
        if(C(a, !0)) {
          throw new f("NO_MODIFICATION_ALLOWED_ERR");
        }
      }
      function K(a, b) {
        if(!a) {
          throw new f(b);
        }
      }
      function L(a) {
        return!c.arrayContains(v, a.nodeType) && !B(a, !0)
      }
      function M(a, b) {
        return b <= (c.isCharacterDataNode(a) ? a.length : a.childNodes.length)
      }
      function N(a) {
        return!!a.startContainer && !!a.endContainer && !L(a.startContainer) && !L(a.endContainer) && M(a.startContainer, a.startOffset) && M(a.endContainer, a.endOffset)
      }
      function O(a) {
        F(a);
        if(!N(a)) {
          throw new Error("Range error: Range is no longer valid after DOM mutation (" + a.inspect() + ")");
        }
      }
      function T(a, b) {
        O(a);
        var d = a.startContainer, e = a.startOffset, f = a.endContainer, g = a.endOffset, h = d === f;
        c.isCharacterDataNode(f) && g > 0 && g < f.length && c.splitDataNode(f, g, b), c.isCharacterDataNode(d) && e > 0 && e < d.length && (d = c.splitDataNode(d, e, b), h ? (g -= e, f = d) : f == d.parentNode && g >= c.getNodeIndex(d) && g++, e = 0), a.setStartAndEnd(d, e, f, g)
      }
      function bb() {
      }
      function cb(a) {
        a.START_TO_START = V, a.START_TO_END = W, a.END_TO_END = X, a.END_TO_START = Y, a.NODE_BEFORE = Z, a.NODE_AFTER = $, a.NODE_BEFORE_AND_AFTER = _, a.NODE_INSIDE = ab
      }
      function db(a) {
        cb(a), cb(a.prototype)
      }
      function eb(a, b) {
        return function() {
          O(this);
          var d = this.startContainer, e = this.startOffset, f = this.commonAncestorContainer, g = new s(this, !0), h, i;
          d !== f && (h = c.getClosestAncestorIn(d, f, !0), i = j(h), d = i.node, e = i.offset), n(g, J), g.reset();
          var k = a(g);
          return g.detach(), b(this, d, e, d, e), k
        }
      }
      function fb(a, b, e) {
        function f(a, b) {
          return function(c) {
            F(this), G(c, u), G(A(c), v);
            var d = (a ? i : j)(c);
            (b ? h : k)(this, d.node, d.offset)
          }
        }
        function h(a, d, e) {
          var f = a.endContainer, g = a.endOffset;
          if(d !== a.startContainer || e !== a.startOffset) {
            if(A(d) != A(f) || c.comparePoints(d, e, f, g) == 1) {
              f = d, g = e
            }
            b(a, d, e, f, g)
          }
        }
        function k(a, d, e) {
          var f = a.startContainer, g = a.startOffset;
          if(d !== a.endContainer || e !== a.endOffset) {
            if(A(d) != A(f) || c.comparePoints(d, e, f, g) == -1) {
              f = d, g = e
            }
            b(a, f, g, d, e)
          }
        }
        a.prototype = new bb, d.extend(a.prototype, {setStart:function(a, b) {
          F(this), E(a, !0), H(a, b), h(this, a, b)
        }, setEnd:function(a, b) {
          F(this), E(a, !0), H(a, b), k(this, a, b)
        }, setStartAndEnd:function() {
          F(this);
          var a = arguments, c = a[0], d = a[1], e = c, f = d;
          switch(a.length) {
            case 3:
              f = a[2];
              break;
            case 4:
              e = a[2], f = a[3]
          }
          b(this, c, d, e, f)
        }, setStartBefore:f(!0, !0), setStartAfter:f(!1, !0), setEndBefore:f(!0, !1), setEndAfter:f(!1, !1), collapse:function(a) {
          O(this), a ? b(this, this.startContainer, this.startOffset, this.startContainer, this.startOffset) : b(this, this.endContainer, this.endOffset, this.endContainer, this.endOffset)
        }, selectNodeContents:function(a) {
          F(this), E(a, !0), b(this, a, 0, a, c.getNodeLength(a))
        }, selectNode:function(a) {
          F(this), E(a, !1), G(a, u);
          var c = i(a), d = j(a);
          b(this, c.node, c.offset, d.node, d.offset)
        }, extractContents:eb(p, b), deleteContents:eb(o, b), canSurroundContents:function() {
          O(this), J(this.startContainer), J(this.endContainer);
          var a = new s(this, !0), b = a._first && g(a._first, this) || a._last && g(a._last, this);
          return a.detach(), !b
        }, detach:function() {
          e(this)
        }, splitBoundaries:function() {
          T(this)
        }, splitBoundariesPreservingPositions:function(a) {
          T(this, a)
        }, normalizeBoundaries:function() {
          O(this);
          var a = this.startContainer, d = this.startOffset, e = this.endContainer, f = this.endOffset, g = function(a) {
            var b = a.nextSibling;
            b && b.nodeType == a.nodeType && (e = a, f = a.length, a.appendData(b.data), b.parentNode.removeChild(b))
          }, h = function(b) {
            var g = b.previousSibling;
            if(g && g.nodeType == b.nodeType) {
              a = b;
              var h = b.length;
              d = g.length, b.insertData(0, g.data), g.parentNode.removeChild(g);
              if(a == e) {
                f += d, e = a
              }else {
                if(e == b.parentNode) {
                  var i = c.getNodeIndex(b);
                  f == i ? (e = b, f = h) : f > i && f--
                }
              }
            }
          }, i = !0;
          if(c.isCharacterDataNode(e)) {
            e.length == f && g(e)
          }else {
            if(f > 0) {
              var j = e.childNodes[f - 1];
              j && c.isCharacterDataNode(j) && g(j)
            }
            i = !this.collapsed
          }
          if(i) {
            if(c.isCharacterDataNode(a)) {
              d == 0 && h(a)
            }else {
              if(d < a.childNodes.length) {
                var k = a.childNodes[d];
                k && c.isCharacterDataNode(k) && h(k)
              }
            }
          }else {
            a = e, d = f
          }
          b(this, a, d, e, f)
        }, collapseToPoint:function(a, b) {
          F(this), E(a, !0), H(a, b), this.setStartAndEnd(a, b)
        }}), db(a)
      }
      function gb(a) {
        a.collapsed = a.startContainer === a.endContainer && a.startOffset === a.endOffset, a.commonAncestorContainer = a.collapsed ? a.startContainer : c.getCommonAncestor(a.startContainer, a.endContainer)
      }
      function hb(a, b, c, d, e) {
        a.startContainer = b, a.startOffset = c, a.endContainer = d, a.endOffset = e, gb(a)
      }
      function ib(a) {
        F(a), a.startContainer = a.startOffset = a.endContainer = a.endOffset = null, a.collapsed = a.commonAncestorContainer = null
      }
      function jb(a) {
        this.startContainer = a, this.startOffset = 0, this.endContainer = a, this.endOffset = 0, gb(this)
      }
      a.requireModules(["DomUtil"]);
      var c = a.dom, d = a.util, e = c.DomPosition, f = a.DOMException;
      s.prototype = {_current:null, _next:null, _first:null, _last:null, isSingleCharacterDataNode:!1, reset:function() {
        this._current = null, this._next = this._first
      }, hasNext:function() {
        return!!this._next
      }, next:function() {
        var a = this._current = this._next;
        return a && (this._next = a !== this._last ? a.nextSibling : null, c.isCharacterDataNode(a) && this.clonePartiallySelectedTextNodes && (a === this.ec && (a = a.cloneNode(!0)).deleteData(this.eo, a.length - this.eo), this._current === this.sc && (a = a.cloneNode(!0)).deleteData(0, this.so))), a
      }, remove:function() {
        var a = this._current, b, d;
        !c.isCharacterDataNode(a) || a !== this.sc && a !== this.ec ? a.parentNode && a.parentNode.removeChild(a) : (b = a === this.sc ? this.so : 0, d = a === this.ec ? this.eo : a.length, b != d && a.deleteData(b, d - b))
      }, isPartiallySelectedSubtree:function() {
        var a = this._current;
        return g(a, this.range)
      }, getSubtreeIterator:function() {
        var a;
        if(this.isSingleCharacterDataNode) {
          a = this.range.cloneRange(), a.collapse(!1)
        }else {
          a = new jb(h(this.range));
          var b = this._current, d = b, e = 0, f = b, g = c.getNodeLength(b);
          c.isOrIsAncestorOf(b, this.sc) && (d = this.sc, e = this.so), c.isOrIsAncestorOf(b, this.ec) && (f = this.ec, g = this.eo), hb(a, d, e, f, g)
        }
        return new s(a, this.clonePartiallySelectedTextNodes)
      }, detach:function(a) {
        a && this.range.detach(), this.range = this._current = this._next = this._first = this._last = this.sc = this.so = this.ec = this.eo = null
      }}, t.prototype = {BAD_BOUNDARYPOINTS_ERR:1, INVALID_NODE_TYPE_ERR:2}, t.prototype.toString = function() {
        return this.message
      };
      var u = [1, 3, 4, 5, 7, 8, 10], v = [2, 9, 11], w = [5, 6, 10, 12], x = [1, 3, 4, 5, 7, 8, 10, 11], y = [1, 3, 4, 5, 7, 8], A = c.getRootContainer, B = z([9, 11]), C = z(w), D = z([6, 10, 12]), P = document.createElement("style"), Q = !1;
      try {
        P.innerHTML = "<b>x</b>", Q = P.firstChild.nodeType == 3
      }catch(R) {
      }
      a.features.htmlParsingConforms = Q;
      var S = Q ? function(a) {
        var b = this.startContainer, d = c.getDocument(b);
        if(!b) {
          throw new f("INVALID_STATE_ERR");
        }
        var e = null;
        return b.nodeType == 1 ? e = b : c.isCharacterDataNode(b) && (e = c.parentElement(b)), e === null || e.nodeName == "HTML" && c.isHtmlNamespace(c.getDocument(e).documentElement) && c.isHtmlNamespace(e) ? e = d.createElement("body") : e = e.cloneNode(!1), e.innerHTML = a, c.fragmentFromNodeChildren(e)
      } : function(a) {
        F(this);
        var b = h(this), d = b.createElement("body");
        return d.innerHTML = a, c.fragmentFromNodeChildren(d)
      }, U = ["startContainer", "startOffset", "endContainer", "endOffset", "collapsed", "commonAncestorContainer"], V = 0, W = 1, X = 2, Y = 3, Z = 0, $ = 1, _ = 2, ab = 3;
      bb.prototype = {compareBoundaryPoints:function(a, b) {
        O(this), I(this.startContainer, b.startContainer);
        var d, e, f, g, h = a == Y || a == V ? "start" : "end", i = a == W || a == V ? "start" : "end";
        return d = this[h + "Container"], e = this[h + "Offset"], f = b[i + "Container"], g = b[i + "Offset"], c.comparePoints(d, e, f, g)
      }, insertNode:function(a) {
        O(this), G(a, x), J(this.startContainer);
        if(c.isOrIsAncestorOf(a, this.startContainer)) {
          throw new f("HIERARCHY_REQUEST_ERR");
        }
        var b = k(a, this.startContainer, this.startOffset);
        this.setStartBefore(b)
      }, cloneContents:function() {
        O(this);
        var a, b;
        if(this.collapsed) {
          return h(this).createDocumentFragment()
        }
        if(this.startContainer === this.endContainer && c.isCharacterDataNode(this.startContainer)) {
          return a = this.startContainer.cloneNode(!0), a.data = a.data.slice(this.startOffset, this.endOffset), b = h(this).createDocumentFragment(), b.appendChild(a), b
        }
        var d = new s(this, !0);
        return a = m(d), d.detach(), a
      }, canSurroundContents:function() {
        O(this), J(this.startContainer), J(this.endContainer);
        var a = new s(this, !0), b = a._first && g(a._first, this) || a._last && g(a._last, this);
        return a.detach(), !b
      }, surroundContents:function(a) {
        G(a, y);
        if(!this.canSurroundContents()) {
          throw new t("BAD_BOUNDARYPOINTS_ERR");
        }
        var b = this.extractContents();
        if(a.hasChildNodes()) {
          while(a.lastChild) {
            a.removeChild(a.lastChild)
          }
        }
        k(a, this.startContainer, this.startOffset), a.appendChild(b), this.selectNode(a)
      }, cloneRange:function() {
        O(this);
        var a = new jb(h(this)), b = U.length, c;
        while(b--) {
          c = U[b], a[c] = this[c]
        }
        return a
      }, toString:function() {
        O(this);
        var a = this.startContainer;
        if(a === this.endContainer && c.isCharacterDataNode(a)) {
          return a.nodeType == 3 || a.nodeType == 4 ? a.data.slice(this.startOffset, this.endOffset) : ""
        }
        var b = [], d = new s(this, !0);
        return n(d, function(a) {
          (a.nodeType == 3 || a.nodeType == 4) && b.push(a.data)
        }), d.detach(), b.join("")
      }, compareNode:function(a) {
        O(this);
        var b = a.parentNode, d = c.getNodeIndex(a);
        if(!b) {
          throw new f("NOT_FOUND_ERR");
        }
        var e = this.comparePoint(b, d), g = this.comparePoint(b, d + 1);
        return e < 0 ? g > 0 ? _ : Z : g > 0 ? $ : ab
      }, comparePoint:function(a, b) {
        return O(this), K(a, "HIERARCHY_REQUEST_ERR"), I(a, this.startContainer), c.comparePoints(a, b, this.startContainer, this.startOffset) < 0 ? -1 : c.comparePoints(a, b, this.endContainer, this.endOffset) > 0 ? 1 : 0
      }, createContextualFragment:S, toHtml:function() {
        O(this);
        var a = this.commonAncestorContainer.parentNode.cloneNode(!1);
        return a.appendChild(this.cloneContents()), a.innerHTML
      }, intersectsNode:function(a, b) {
        O(this), K(a, "NOT_FOUND_ERR");
        if(c.getDocument(a) !== h(this)) {
          return!1
        }
        var d = a.parentNode, e = c.getNodeIndex(a);
        K(d, "NOT_FOUND_ERR");
        var f = c.comparePoints(d, e, this.endContainer, this.endOffset), g = c.comparePoints(d, e + 1, this.startContainer, this.startOffset);
        return b ? f <= 0 && g >= 0 : f < 0 && g > 0
      }, isPointInRange:function(a, b) {
        return O(this), K(a, "HIERARCHY_REQUEST_ERR"), I(a, this.startContainer), c.comparePoints(a, b, this.startContainer, this.startOffset) >= 0 && c.comparePoints(a, b, this.endContainer, this.endOffset) <= 0
      }, intersectsRange:function(a) {
        return l(this, a, !1)
      }, intersectsOrTouchesRange:function(a) {
        return l(this, a, !0)
      }, intersection:function(a) {
        if(this.intersectsRange(a)) {
          var b = c.comparePoints(this.startContainer, this.startOffset, a.startContainer, a.startOffset), d = c.comparePoints(this.endContainer, this.endOffset, a.endContainer, a.endOffset), e = this.cloneRange();
          return b == -1 && e.setStart(a.startContainer, a.startOffset), d == 1 && e.setEnd(a.endContainer, a.endOffset), e
        }
        return null
      }, union:function(a) {
        if(this.intersectsOrTouchesRange(a)) {
          var b = this.cloneRange();
          return c.comparePoints(a.startContainer, a.startOffset, this.startContainer, this.startOffset) == -1 && b.setStart(a.startContainer, a.startOffset), c.comparePoints(a.endContainer, a.endOffset, this.endContainer, this.endOffset) == 1 && b.setEnd(a.endContainer, a.endOffset), b
        }
        throw new t("Ranges do not intersect");
      }, containsNode:function(a, b) {
        return b ? this.intersectsNode(a, !1) : this.compareNode(a) == ab
      }, containsNodeContents:function(a) {
        return this.comparePoint(a, 0) >= 0 && this.comparePoint(a, c.getNodeLength(a)) <= 0
      }, containsRange:function(a) {
        var b = this.intersection(a);
        return b !== null && a.equals(b)
      }, containsNodeText:function(a) {
        var b = this.cloneRange();
        b.selectNode(a);
        var c = b.getNodes([3]);
        if(c.length > 0) {
          b.setStart(c[0], 0);
          var d = c.pop();
          b.setEnd(d, d.length);
          var e = this.containsRange(b);
          return b.detach(), e
        }
        return this.containsNodeContents(a)
      }, getNodes:function(a, b) {
        return O(this), q(this, a, b)
      }, getDocument:function() {
        return h(this)
      }, collapseBefore:function(a) {
        F(this), this.setEndBefore(a), this.collapse(!1)
      }, collapseAfter:function(a) {
        F(this), this.setStartAfter(a), this.collapse(!0)
      }, getName:function() {
        return"DomRange"
      }, equals:function(a) {
        return jb.rangesEqual(this, a)
      }, isValid:function() {
        return N(this)
      }, inspect:function() {
        return r(this)
      }}, fb(jb, hb, ib), a.rangePrototype = bb.prototype, d.extend(jb, {rangeProperties:U, RangeIterator:s, copyComparisonConstants:db, createPrototypeRange:fb, inspect:r, getRangeDocument:h, rangesEqual:function(a, b) {
        return a.startContainer === b.startContainer && a.startOffset === b.startOffset && a.endContainer === b.endContainer && a.endOffset === b.endOffset
      }}), a.DomRange = jb, a.RangeException = t
    }), rangy.createModule("WrappedRange", function(a, b) {
      function h(a, c) {
        a = d.getContentDocument(a);
        if(!a) {
          throw b.createError(c + "(): Parameter must be a Document or other DOM node, or a Window object");
        }
        return a
      }
      function i(a) {
        var b = a.parentElement(), c = a.duplicate();
        c.collapse(!0);
        var e = c.parentElement();
        c = a.duplicate(), c.collapse(!1);
        var f = c.parentElement(), g = e == f ? e : d.getCommonAncestor(e, f);
        return g == b ? g : d.getCommonAncestor(b, g)
      }
      function j(a) {
        return a.compareEndPoints("StartToEnd", a) == 0
      }
      function k(a, b, c, e, g) {
        var h = a.duplicate();
        h.collapse(c);
        var i = h.parentElement();
        d.isOrIsAncestorOf(b, i) || (i = b);
        if(!i.canHaveHTML) {
          return new f(i.parentNode, d.getNodeIndex(i))
        }
        var j = d.getDocument(i).createElement("span");
        j.parentNode && j.parentNode.removeChild(j);
        var k, l = c ? "StartToStart" : "StartToEnd", m, n, o, p, q = g && g.containerElement == i ? g.nodeIndex : 0, r = i.childNodes.length, s = r, t = s;
        for(;;) {
          t == r ? i.appendChild(j) : i.insertBefore(j, i.childNodes[t]), h.moveToElementText(j), k = h.compareEndPoints(l, a);
          if(k == 0 || q == s) {
            break
          }
          if(k == -1) {
            if(s == q + 1) {
              break
            }
            q = t
          }else {
            s = s == q + 1 ? q : t
          }
          t = Math.floor((q + s) / 2), i.removeChild(j)
        }
        p = j.nextSibling;
        if(k == -1 && p && d.isCharacterDataNode(p)) {
          h.setEndPoint(c ? "EndToStart" : "EndToEnd", a);
          var u;
          if(/[\r\n]/.test(p.data)) {
            var v = h.duplicate(), w = v.text.replace(/\r\n/g, "\r").length;
            u = v.moveStart("character", w);
            while((k = v.compareEndPoints("StartToEnd", v)) == -1) {
              u++, v.moveStart("character", 1)
            }
          }else {
            u = h.text.length
          }
          o = new f(p, u)
        }else {
          m = (e || !c) && j.previousSibling, n = (e || c) && j.nextSibling, n && d.isCharacterDataNode(n) ? o = new f(n, 0) : m && d.isCharacterDataNode(m) ? o = new f(m, m.data.length) : o = new f(i, d.getNodeIndex(j))
        }
        return j.parentNode.removeChild(j), {boundaryPosition:o, nodeInfo:{nodeIndex:t, containerElement:i}}
      }
      function l(a, b) {
        var c, e, f = a.offset, g = d.getDocument(a.node), h, i, j = g.body.createTextRange(), k = d.isCharacterDataNode(a.node);
        return k ? (c = a.node, e = c.parentNode) : (i = a.node.childNodes, c = f < i.length ? i[f] : null, e = a.node), h = g.createElement("span"), h.innerHTML = "&#feff;", c ? e.insertBefore(h, c) : e.appendChild(h), j.moveToElementText(h), j.collapse(!b), e.removeChild(h), k && j[b ? "moveStart" : "moveEnd"]("character", f), j
      }
      a.requireModules(["DomUtil", "DomRange"]);
      var c, d = a.dom, e = a.util, f = d.DomPosition, g = a.DomRange;
      if(a.features.implementsDomRange && (!a.features.implementsTextRange || !a.config.preferTextRange)) {
        (function() {
          function h(a) {
            var b = f.length, c;
            while(b--) {
              c = f[b], a[c] = a.nativeRange[c]
            }
            a.collapsed = a.startContainer === a.endContainer && a.startOffset === a.endOffset
          }
          function i(a, b, c, d, e) {
            var f = a.startContainer !== b || a.startOffset != c, g = a.endContainer !== d || a.endOffset != e, h = !a.equals(a.nativeRange);
            if(f || g || h) {
              a.setEnd(d, e), a.setStart(b, c)
            }
          }
          function j(a) {
            a.nativeRange.detach(), a.detached = !0;
            var b = f.length, c;
            while(b--) {
              c = f[b], a[c] = null
            }
          }
          var a, f = g.rangeProperties, k;
          c = function(a) {
            if(!a) {
              throw b.createError("WrappedRange: Range must be specified");
            }
            this.nativeRange = a, h(this)
          }, g.createPrototypeRange(c, i, j), a = c.prototype, a.selectNode = function(a) {
            this.nativeRange.selectNode(a), h(this)
          }, a.cloneContents = function() {
            return this.nativeRange.cloneContents()
          }, a.surroundContents = function(a) {
            this.nativeRange.surroundContents(a), h(this)
          }, a.collapse = function(a) {
            this.nativeRange.collapse(a), h(this)
          }, a.cloneRange = function() {
            return new c(this.nativeRange.cloneRange())
          }, a.refresh = function() {
            h(this)
          }, a.toString = function() {
            return this.nativeRange.toString()
          };
          var l = document.createTextNode("test");
          d.getBody(document).appendChild(l);
          var m = document.createRange();
          m.setStart(l, 0), m.setEnd(l, 0);
          try {
            m.setStart(l, 1), a.setStart = function(a, b) {
              this.nativeRange.setStart(a, b), h(this)
            }, a.setEnd = function(a, b) {
              this.nativeRange.setEnd(a, b), h(this)
            }, k = function(a) {
              return function(b) {
                this.nativeRange[a](b), h(this)
              }
            }
          }catch(n) {
            a.setStart = function(a, b) {
              try {
                this.nativeRange.setStart(a, b)
              }catch(c) {
                this.nativeRange.setEnd(a, b), this.nativeRange.setStart(a, b)
              }
              h(this)
            }, a.setEnd = function(a, b) {
              try {
                this.nativeRange.setEnd(a, b)
              }catch(c) {
                this.nativeRange.setStart(a, b), this.nativeRange.setEnd(a, b)
              }
              h(this)
            }, k = function(a, b) {
              return function(c) {
                try {
                  this.nativeRange[a](c)
                }catch(d) {
                  this.nativeRange[b](c), this.nativeRange[a](c)
                }
                h(this)
              }
            }
          }
          a.setStartBefore = k("setStartBefore", "setEndBefore"), a.setStartAfter = k("setStartAfter", "setEndAfter"), a.setEndBefore = k("setEndBefore", "setStartBefore"), a.setEndAfter = k("setEndAfter", "setStartAfter"), m.selectNodeContents(l), m.startContainer == l && m.endContainer == l && m.startOffset == 0 && m.endOffset == l.length ? a.selectNodeContents = function(a) {
            this.nativeRange.selectNodeContents(a), h(this)
          } : a.selectNodeContents = function(a) {
            this.setStart(a, 0), this.setEnd(a, g.getEndOffset(a))
          }, m.selectNodeContents(l), m.setEnd(l, 3);
          var o = document.createRange();
          o.selectNodeContents(l), o.setEnd(l, 4), o.setStart(l, 2), m.compareBoundaryPoints(m.START_TO_END, o) == -1 && m.compareBoundaryPoints(m.END_TO_START, o) == 1 ? a.compareBoundaryPoints = function(a, b) {
            return b = b.nativeRange || b, a == b.START_TO_END ? a = b.END_TO_START : a == b.END_TO_START && (a = b.START_TO_END), this.nativeRange.compareBoundaryPoints(a, b)
          } : a.compareBoundaryPoints = function(a, b) {
            return this.nativeRange.compareBoundaryPoints(a, b.nativeRange || b)
          };
          var p = document.createElement("div");
          p.innerHTML = "123";
          var q = p.firstChild;
          document.body.appendChild(p), m.setStart(q, 1), m.setEnd(q, 2), m.deleteContents(), q.data == "13" && (a.deleteContents = function() {
            this.nativeRange.deleteContents(), h(this)
          }, a.extractContents = function() {
            var a = this.nativeRange.extractContents();
            return h(this), a
          }), document.body.removeChild(p), e.isHostMethod(m, "createContextualFragment") && (a.createContextualFragment = function(a) {
            return this.nativeRange.createContextualFragment(a)
          }), d.getBody(document).removeChild(l), m.detach(), o.detach()
        })(), a.createNativeRange = function(a) {
          return a = h(a, "createNativeRange"), a.createRange()
        }
      }else {
        if(a.features.implementsTextRange) {
          c = function(a) {
            this.textRange = a, this.refresh()
          }, c.prototype = new g(document), c.prototype.refresh = function() {
            var a, b, c, d = i(this.textRange);
            j(this.textRange) ? b = a = k(this.textRange, d, !0, !0).boundaryPosition : (c = k(this.textRange, d, !0, !1), a = c.boundaryPosition, b = k(this.textRange, d, !1, !1, c.nodeInfo).boundaryPosition), this.setStart(a.node, a.offset), this.setEnd(b.node, b.offset)
          }, g.copyComparisonConstants(c);
          var m = function() {
            return this
          }();
          typeof m.Range == "undefined" && (m.Range = c), a.createNativeRange = function(a) {
            return a = h(a, "createNativeRange"), a.body.createTextRange()
          }
        }
      }
      a.features.implementsTextRange && (c.rangeToTextRange = function(a) {
        if(a.collapsed) {
          return l(new f(a.startContainer, a.startOffset), !0)
        }
        var b = l(new f(a.startContainer, a.startOffset), !0), c = l(new f(a.endContainer, a.endOffset), !1), e = d.getDocument(a.startContainer).body.createTextRange();
        return e.setEndPoint("StartToStart", b), e.setEndPoint("EndToEnd", c), e
      }), c.prototype.getName = function() {
        return"WrappedRange"
      }, a.WrappedRange = c, a.createRange = function(b) {
        return b = h(b, "createRange"), new c(a.createNativeRange(b))
      }, a.createRangyRange = function(a) {
        return a = h(a, "createRangyRange"), new g(a)
      }, a.createIframeRange = function(c) {
        return b.deprecationNotice("createIframeRange()", "createRange(iframeEl)"), a.createRange(c)
      }, a.createIframeRangyRange = function(c) {
        return b.deprecationNotice("createIframeRangyRange()", "createRangyRange(iframeEl)"), a.createRangyRange(c)
      }, a.addCreateMissingNativeApiListener(function(b) {
        var c = b.document;
        typeof c.createRange == "undefined" && (c.createRange = function() {
          return a.createRange(c)
        }), c = b = null
      })
    }), rangy.createModule("WrappedSelection", function(a, b) {
      function m(a) {
        return typeof a == "string" ? a == "backward" : !!a
      }
      function n(a, c) {
        if(!a) {
          return window
        }
        if(d.isWindow(a)) {
          return a
        }
        if(a instanceof O) {
          return a.win
        }
        var e = d.getContentDocument(a);
        if(!e) {
          throw b.createError(c + "(): " + "Parameter must be a Window object or DOM node");
        }
        return d.getWindow(e)
      }
      function o(a) {
        return n(a, "getWinSelection").getSelection()
      }
      function p(a) {
        return n(a, "getDocSelection").document.selection
      }
      function D(a, b, c) {
        var d = c ? "end" : "start", e = c ? "start" : "end";
        a.anchorNode = b[d + "Container"], a.anchorOffset = b[d + "Offset"], a.focusNode = b[e + "Container"], a.focusOffset = b[e + "Offset"]
      }
      function E(a) {
        var b = a.nativeSelection;
        a.anchorNode = b.anchorNode, a.anchorOffset = b.anchorOffset, a.focusNode = b.focusNode, a.focusOffset = b.focusOffset
      }
      function F(a) {
        a.anchorNode = a.focusNode = null, a.anchorOffset = a.focusOffset = 0, a.rangeCount = 0, a.isCollapsed = !0, a._ranges.length = 0
      }
      function G(b) {
        var c;
        return b instanceof f ? (c = a.createNativeRange(b.getDocument()), c.setEnd(b.endContainer, b.endOffset), c.setStart(b.startContainer, b.startOffset)) : b instanceof g ? c = b.nativeRange : a.features.implementsDomRange && b instanceof d.getWindow(b.startContainer).Range && (c = b), c
      }
      function H(a) {
        if(!a.length || a[0].nodeType != 1) {
          return!1
        }
        for(var b = 1, c = a.length;b < c;++b) {
          if(!d.isAncestorOf(a[0], a[b])) {
            return!1
          }
        }
        return!0
      }
      function I(a) {
        var c = a.getNodes();
        if(!H(c)) {
          throw b.createError("getSingleElementFromRange: range " + a.inspect() + " did not consist of a single element");
        }
        return c[0]
      }
      function J(a) {
        return!!a && typeof a.text != "undefined"
      }
      function K(a, b) {
        var c = new g(b);
        a._ranges = [c], D(a, c, !1), a.rangeCount = 1, a.isCollapsed = c.collapsed
      }
      function L(b) {
        b._ranges.length = 0;
        if(b.docSelection.type == "None") {
          F(b)
        }else {
          var c = b.docSelection.createRange();
          if(J(c)) {
            K(b, c)
          }else {
            b.rangeCount = c.length;
            var e, f = d.getDocument(c.item(0));
            for(var g = 0;g < b.rangeCount;++g) {
              e = a.createRange(f), e.selectNode(c.item(g)), b._ranges.push(e)
            }
            b.isCollapsed = b.rangeCount == 1 && b._ranges[0].collapsed, D(b, b._ranges[b.rangeCount - 1], !1)
          }
        }
      }
      function M(a, c) {
        var e = a.docSelection.createRange(), f = I(c), g = d.getDocument(e.item(0)), h = d.getBody(g).createControlRange();
        for(var i = 0, j = e.length;i < j;++i) {
          h.add(e.item(i))
        }
        try {
          h.add(f)
        }catch(k) {
          throw b.createError("addRange(): Element within the specified Range could not be added to control selection (does it have layout?)");
        }
        h.select(), L(a)
      }
      function O(a, b, c) {
        this.nativeSelection = a, this.docSelection = b, this._ranges = [], this.win = c, this.refresh()
      }
      function P(a) {
        a.win = a.anchorNode = a.focusNode = a._ranges = null, a.detached = !0
      }
      function R(a, b) {
        var c = Q.length, d, e;
        while(c--) {
          d = Q[c], e = d.selection;
          if(b == "deleteAll") {
            P(e)
          }else {
            if(d.win == a) {
              return b == "delete" ? (Q.splice(c, 1), !0) : e
            }
          }
        }
        return b == "deleteAll" && (Q.length = 0), null
      }
      function T(a, c) {
        var e = d.getDocument(c[0].startContainer), f = d.getBody(e).createControlRange();
        for(var g = 0, h;g < rangeCount;++g) {
          h = I(c[g]);
          try {
            f.add(h)
          }catch(i) {
            throw b.createError("setRanges(): Element within the one of the specified Ranges could not be added to control selection (does it have layout?)");
          }
        }
        f.select(), L(a)
      }
      function Y(a, b) {
        if(a.anchorNode && d.getDocument(a.anchorNode) !== d.getDocument(b)) {
          throw new h("WRONG_DOCUMENT_ERR");
        }
      }
      function Z(a) {
        var b = [], c = new i(a.anchorNode, a.anchorOffset), d = new i(a.focusNode, a.focusOffset), e = typeof a.getName == "function" ? a.getName() : "Selection";
        if(typeof a.rangeCount != "undefined") {
          for(var g = 0, h = a.rangeCount;g < h;++g) {
            b[g] = f.inspect(a.getRangeAt(g))
          }
        }
        return"[" + e + "(Ranges: " + b.join(", ") + ")(anchor: " + c.inspect() + ", focus: " + d.inspect() + "]"
      }
      a.requireModules(["DomUtil", "DomRange", "WrappedRange"]), a.config.checkSelectionRanges = !0;
      var c = "boolean", d = a.dom, e = a.util, f = a.DomRange, g = a.WrappedRange, h = a.DOMException, i = d.DomPosition, j, k, l = "Control", q = a.util.isHostMethod(window, "getSelection"), r = a.util.isHostObject(document, "selection");
      a.features.implementsWinGetSelection = q, a.features.implementsDocSelection = r;
      var s = r && (!q || a.config.preferTextRange);
      s ? (j = p, a.isSelectionValid = function(a) {
        var b = n(a, "isSelectionValid").document, c = b.selection;
        return c.type != "None" || d.getDocument(c.createRange().parentElement()) == b
      }) : q ? (j = o, a.isSelectionValid = function() {
        return!0
      }) : b.fail("Neither document.selection or window.getSelection() detected."), a.getNativeSelection = j;
      var t = j(), u = a.createNativeRange(document), v = d.getBody(document), w = e.areHostProperties(t, ["anchorNode", "focusNode", "anchorOffset", "focusOffset"]);
      a.features.selectionHasAnchorAndFocus = w;
      var x = e.isHostMethod(t, "extend");
      a.features.selectionHasExtend = x;
      var y = typeof t.rangeCount == "number";
      a.features.selectionHasRangeCount = y;
      var z = !1, A = !0;
      e.areHostMethods(t, ["addRange", "getRangeAt", "removeAllRanges"]) && typeof t.rangeCount == "number" && a.features.implementsDomRange && function() {
        var a = window.getSelection();
        if(a) {
          var b = d.getBody(document), c = b.appendChild(document.createElement("div"));
          c.contentEditable = "false";
          var e = c.appendChild(document.createTextNode("Â Â Â ")), f = document.createRange();
          f.setStart(e, 1), f.collapse(!0), a.addRange(f), A = a.rangeCount == 1, a.removeAllRanges();
          var g = f.cloneRange();
          f.setStart(e, 0), g.setEnd(e, 3), g.setStart(e, 2), a.addRange(f), a.addRange(g), z = a.rangeCount == 2, b.removeChild(c), a.removeAllRanges(), f.detach(), g.detach()
        }
      }(), a.features.selectionSupportsMultipleRanges = z, a.features.collapsedNonEditableSelectionsSupported = A;
      var B = !1, C;
      v && e.isHostMethod(v, "createControlRange") && (C = v.createControlRange(), e.areHostProperties(C, ["item", "add"]) && (B = !0)), a.features.implementsControlRange = B, w ? k = function(a) {
        return a.anchorNode === a.focusNode && a.anchorOffset === a.focusOffset
      } : k = function(a) {
        return a.rangeCount ? a.getRangeAt(a.rangeCount - 1).collapsed : !1
      };
      var N;
      e.isHostMethod(t, "getRangeAt") ? N = function(a, b) {
        try {
          return a.getRangeAt(b)
        }catch(c) {
          return null
        }
      } : w && (N = function(b) {
        var c = d.getDocument(b.anchorNode), e = a.createRange(c);
        return e.setStart(b.anchorNode, b.anchorOffset), e.setEnd(b.focusNode, b.focusOffset), e.collapsed !== this.isCollapsed && (e.setStart(b.focusNode, b.focusOffset), e.setEnd(b.anchorNode, b.anchorOffset)), e
      });
      var Q = [];
      a.getSelection = function(a) {
        if(a && a instanceof O) {
          return a.refresh(), a
        }
        a = n(a, "getSelection");
        var b = R(a), c = j(a), d = r ? p(a) : null;
        return b ? (b.nativeSelection = c, b.docSelection = d, b.refresh()) : (b = new O(c, d, a), Q.push({win:a, selection:b})), b
      }, a.getIframeSelection = function(c) {
        return b.deprecationNotice("getIframeSelection()", "getSelection(iframeEl)"), a.getSelection(d.getIframeWindow(c))
      };
      var S = O.prototype;
      if(!s && w && e.areHostMethods(t, ["removeAllRanges", "addRange"])) {
        S.removeAllRanges = function() {
          this.nativeSelection.removeAllRanges(), F(this)
        };
        var U = function(b, c) {
          var d = f.getRangeDocument(c), e = a.createRange(d);
          e.collapseToPoint(c.endContainer, c.endOffset), b.nativeSelection.addRange(G(e)), b.nativeSelection.extend(c.startContainer, c.startOffset), b.refresh()
        };
        y ? S.addRange = function(b, c) {
          if(B && r && this.docSelection.type == l) {
            M(this, b)
          }else {
            if(m(c) && x) {
              U(this, b)
            }else {
              var d;
              z ? d = this.rangeCount : (this.removeAllRanges(), d = 0), this.nativeSelection.addRange(G(b).cloneRange()), this.rangeCount = this.nativeSelection.rangeCount;
              if(this.rangeCount == d + 1) {
                if(a.config.checkSelectionRanges) {
                  var e = N(this.nativeSelection, this.rangeCount - 1);
                  e && !f.rangesEqual(e, b) && (b = new g(e))
                }
                this._ranges[this.rangeCount - 1] = b, D(this, b, X(this.nativeSelection)), this.isCollapsed = k(this)
              }else {
                this.refresh()
              }
            }
          }
        } : S.addRange = function(a, b) {
          m(b) && x ? U(this, a) : (this.nativeSelection.addRange(G(a)), this.refresh())
        }, S.setRanges = function(a) {
          if(B && a.length > 1) {
            T(this, a)
          }else {
            this.removeAllRanges();
            for(var b = 0, c = a.length;b < c;++b) {
              this.addRange(a[b])
            }
          }
        }
      }else {
        if(!(e.isHostMethod(t, "empty") && e.isHostMethod(u, "select") && B && s)) {
          return b.fail("No means of selecting a Range or TextRange was found"), !1
        }
        S.removeAllRanges = function() {
          try {
            this.docSelection.empty();
            if(this.docSelection.type != "None") {
              var a;
              if(this.anchorNode) {
                a = d.getDocument(this.anchorNode)
              }else {
                if(this.docSelection.type == l) {
                  var b = this.docSelection.createRange();
                  b.length && (a = d.getDocument(b.item(0)).body.createTextRange())
                }
              }
              if(a) {
                var c = a.body.createTextRange();
                c.select(), this.docSelection.empty()
              }
            }
          }catch(e) {
          }
          F(this)
        }, S.addRange = function(a) {
          this.docSelection.type == l ? M(this, a) : (g.rangeToTextRange(a).select(), this._ranges[0] = a, this.rangeCount = 1, this.isCollapsed = this._ranges[0].collapsed, D(this, a, !1))
        }, S.setRanges = function(a) {
          this.removeAllRanges();
          var b = a.length;
          b > 1 ? T(this, a) : b && this.addRange(a[0])
        }
      }
      S.getRangeAt = function(a) {
        if(a < 0 || a >= this.rangeCount) {
          throw new h("INDEX_SIZE_ERR");
        }
        return this._ranges[a].cloneRange()
      };
      var V;
      if(s) {
        V = function(b) {
          var c;
          a.isSelectionValid(b.win) ? c = b.docSelection.createRange() : (c = d.getBody(b.win.document).createTextRange(), c.collapse(!0)), b.docSelection.type == l ? L(b) : J(c) ? K(b, c) : F(b)
        }
      }else {
        if(e.isHostMethod(t, "getRangeAt") && typeof t.rangeCount == "number") {
          V = function(b) {
            if(B && r && b.docSelection.type == l) {
              L(b)
            }else {
              b._ranges.length = b.rangeCount = b.nativeSelection.rangeCount;
              if(b.rangeCount) {
                for(var c = 0, d = b.rangeCount;c < d;++c) {
                  b._ranges[c] = new a.WrappedRange(b.nativeSelection.getRangeAt(c))
                }
                D(b, b._ranges[b.rangeCount - 1], X(b.nativeSelection)), b.isCollapsed = k(b)
              }else {
                F(b)
              }
            }
          }
        }else {
          if(!w || typeof t.isCollapsed != c || typeof u.collapsed != c || !a.features.implementsDomRange) {
            return b.fail("No means of obtaining a Range or TextRange from the user's selection was found"), !1
          }
          V = function(a) {
            var b, c = a.nativeSelection;
            c.anchorNode ? (b = N(c, 0), a._ranges = [b], a.rangeCount = 1, E(a), a.isCollapsed = k(a)) : F(a)
          }
        }
      }
      S.refresh = function(a) {
        var b = a ? this._ranges.slice(0) : null, c = this.anchorNode, d = this.anchorOffset;
        V(this);
        if(a) {
          var e = b.length;
          if(e != this._ranges.length) {
            return!0
          }
          if(this.anchorNode != c || this.anchorOffset != d) {
            return!0
          }
          while(e--) {
            if(!f.rangesEqual(b[e], this._ranges[e])) {
              return!0
            }
          }
          return!1
        }
      };
      var W = function(b, c) {
        var d = b.getAllRanges();
        b.removeAllRanges();
        for(var e = 0, f = d.length;e < f;++e) {
          a.DomRange.rangesEqual(c, d[e]) || b.addRange(d[e])
        }
        b.rangeCount || F(b)
      };
      B ? S.removeRange = function(a) {
        if(this.docSelection.type == l) {
          var b = this.docSelection.createRange(), c = I(a), e = d.getDocument(b.item(0)), f = d.getBody(e).createControlRange(), g, h = !1;
          for(var i = 0, j = b.length;i < j;++i) {
            g = b.item(i), g !== c || h ? f.add(b.item(i)) : h = !0
          }
          f.select(), L(this)
        }else {
          W(this, a)
        }
      } : S.removeRange = function(a) {
        W(this, a)
      };
      var X;
      !s && w && a.features.implementsDomRange ? (X = function(a) {
        var b = !1;
        return a.anchorNode && (b = d.comparePoints(a.anchorNode, a.anchorOffset, a.focusNode, a.focusOffset) == 1), b
      }, S.isBackward = function() {
        return X(this)
      }) : X = S.isBackward = function() {
        return!1
      }, S.isBackwards = S.isBackward, S.toString = function() {
        var a = [];
        for(var b = 0, c = this.rangeCount;b < c;++b) {
          a[b] = "" + this._ranges[b]
        }
        return a.join("")
      }, S.collapse = function(b, c) {
        Y(this, b);
        var d = a.createRange(b);
        d.collapseToPoint(b, c), this.setSingleRange(d), this.isCollapsed = !0
      }, S.collapseToStart = function() {
        if(!this.rangeCount) {
          throw new h("INVALID_STATE_ERR");
        }
        var a = this._ranges[0];
        this.collapse(a.startContainer, a.startOffset)
      }, S.collapseToEnd = function() {
        if(!this.rangeCount) {
          throw new h("INVALID_STATE_ERR");
        }
        var a = this._ranges[this.rangeCount - 1];
        this.collapse(a.endContainer, a.endOffset)
      }, S.selectAllChildren = function(b) {
        Y(this, b);
        var c = a.createRange(b);
        c.selectNodeContents(b), this.removeAllRanges(), this.addRange(c)
      }, S.deleteFromDocument = function() {
        if(B && r && this.docSelection.type == l) {
          var a = this.docSelection.createRange(), b;
          while(a.length) {
            b = a.item(0), a.remove(b), b.parentNode.removeChild(b)
          }
          this.refresh()
        }else {
          if(this.rangeCount) {
            var c = this.getAllRanges();
            if(c.length) {
              this.removeAllRanges();
              for(var d = 0, e = c.length;d < e;++d) {
                c[d].deleteContents()
              }
              this.addRange(c[e - 1])
            }
          }
        }
      }, S.getAllRanges = function() {
        var a = [];
        for(var b = 0, c = this._ranges.length;b < c;++b) {
          a[b] = this.getRangeAt(b)
        }
        return a
      }, S.setSingleRange = function(a, b) {
        this.removeAllRanges(), this.addRange(a, b)
      }, S.containsNode = function(a, b) {
        for(var c = 0, d = this._ranges.length;c < d;++c) {
          if(this._ranges[c].containsNode(a, b)) {
            return!0
          }
        }
        return!1
      }, S.toHtml = function() {
        var a = [];
        if(this.rangeCount) {
          for(var b = 0, c = this._ranges.length;b < c;++b) {
            a.push(this._ranges[b].toHtml())
          }
        }
        return a.join("")
      }, S.getName = function() {
        return"WrappedSelection"
      }, S.inspect = function() {
        return Z(this)
      }, S.detach = function() {
        R(this.win, "delete"), P(this)
      }, O.detachAll = function() {
        R(null, "deleteAll")
      }, O.inspect = Z, O.isDirectionBackward = m, a.Selection = O, a.selectionPrototype = S, a.addCreateMissingNativeApiListener(function(b) {
        typeof b.getSelection == "undefined" && (b.getSelection = function() {
          return a.getSelection(b)
        }), b = null
      })
    });
    WebAgent.util.rangy.init()
  };
  var interval = setInterval(function() {
    if(document.body) {
      clearInterval(interval);
      initRangy()
    }
  }, 100)
})();
WebAgent.namespace("WebAgent.util");
(function() {
  var WA = WebAgent, U = WA.util, ELEMENT_NODE = 1, TEXT_NODE = 3;
  var S = WebAgent.util.Selection = {getSelection:function() {
    var ret = null;
    try {
      ret = window.getSelection ? window.getSelection() : WebAgent.util.rangy.getSelection()
    }catch(e) {
    }
    return ret
  }, createRange:function() {
    return document.createRange ? document.createRange() : WebAgent.util.rangy.createRange()
  }, isCaretAtEnd:function(elem) {
  }, getNodeBeforeCaret:function() {
    var sel = this.getSelection(), ret = null;
    if(sel.anchorNode) {
      if(sel.anchorNode.nodeType === ELEMENT_NODE && sel.anchorNode.childNodes.length) {
        if(sel.anchorOffset > 0) {
          ret = sel.anchorNode.childNodes[sel.anchorOffset - 1]
        }else {
          if(sel.anchorNode.previousSibling) {
            ret = sel.anchorNode.previousSibling
          }
        }
      }else {
        if(sel.anchorNode && sel.anchorNode.nodeType === TEXT_NODE && sel.anchorOffset === 0) {
          ret = sel.anchorNode.previousSibling
        }
      }
    }
    if(ret && ret.nodeType === TEXT_NODE && ret.data === "") {
      ret = ret.previousSibling
    }
    return ret
  }, isFocused:function(node) {
    var ret = false;
    try {
      var selAnchorNode = this.getSelection().anchorNode;
      if(selAnchorNode && (selAnchorNode == node || WA.fly(selAnchorNode).isAncestor(node))) {
        ret = true
      }
    }catch(e) {
    }
    return ret
  }}
})();
WebAgent.namespace("WebAgent.util");
(function() {
  var S = WebAgent.util.String = {format:function() {
    var args = WebAgent.toArray(arguments);
    var format = args.shift();
    return format.replace(/\{(\d+)\}/g, function(ignored, i) {
      return args[i]
    })
  }, capitalize:function(value) {
    return value.charAt(0).toUpperCase() + value.substr(1).toLowerCase()
  }, parseTemplate:function(template, data) {
    return template.replace(/\{([^\}]+)\}/g, function(ignored, p) {
      return data[p]
    })
  }, pluralize:function(num, zero, one, two) {
    return num % 10 == 1 && num % 100 !== 11 ? one : num % 10 >= 2 && num % 10 <= 4 && (num % 100 < 10 || num % 100 >= 20) ? two : zero
  }, htmlEntity:function(text) {
    return text ? ("" + text).replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;") : ""
  }, entityDecode:function(text) {
    return(text || "").replace(/&lt;/ig, "<").replace(/&gt;/ig, ">").replace(/&quot;/ig, '"').replace(/&nbsp;/ig, " ")
  }, encodeAmp:function(text) {
    return("" + text || "").replace(/&/g, "&amp;")
  }, stripHtmlEntity:function(text) {
    return(text || "").replace(/&\w+|#\d+;/, "")
  }, ellipsis:function(str, len) {
    if(str.length > len) {
      return str.substr(0, len - 3) + "..."
    }else {
      return str
    }
  }, formatPhone:function(tel) {
    var SEPARATE_COUNTRY_CODE = false;
    if(typeof tel === "string") {
      tel = tel.replace(/\D+/g, "");
      if(tel.length > 3) {
        var country = "017".indexOf(tel.substr(0, 1)) > -1 ? 1 : 2;
        if(tel.substr(0, 1) == "7") {
          tel = "+7 (" + tel.substr(1, 3) + ") " + tel.substr(4)
        }else {
          if(SEPARATE_COUNTRY_CODE) {
            tel = "+" + tel.substr(0, country) + " " + tel.substr(country)
          }else {
            tel = "+" + tel
          }
        }
      }
    }
    return tel
  }, formatDate:function(ts) {
    var tso = new Date;
    var midnight = tso - 36E5 * tso.getHours() - 6E4 * tso.getMinutes() - 1E3 * tso.getSeconds();
    tso = new Date(ts - 0);
    var msg_date = tso.toTimeString().replace(/:\d\d(\s(?:AM|PM))?(?:\s.*)?$/i, "$1");
    if(midnight > tso.valueOf()) {
      var splitter = ".";
      var den = tso.getDate();
      var mes = tso.getMonth() + 1;
      mes += "";
      if(mes.length == 1) {
        mes = "0" + mes
      }
      var god = tso.getYear() + "";
      god = god.slice(1, 3);
      msg_date = den + splitter + mes + splitter + god + " " + msg_date
    }
    return msg_date
  }, quote:function() {
    var cx = /[\u0000\u00ad\u0600-\u0604\u070f\u17b4\u17b5\u200c-\u200f\u2028-\u202f\u2060-\u206f\ufeff\ufff0-\uffff]/g, escapable = /[\\\"\x00-\x1f\x7f-\x9f\u00ad\u0600-\u0604\u070f\u17b4\u17b5\u200c-\u200f\u2028-\u202f\u2060-\u206f\ufeff\ufff0-\uffff]/g, gap, indent, meta = {"\b":"\\b", "\t":"\\t", "\n":"\\n", "\f":"\\f", "\r":"\\r", '"':'\\"', "\\":"\\\\"}, rep;
    return function(string) {
      escapable.lastIndex = 0;
      return escapable.test(string) ? '"' + string.replace(escapable, function(a) {
        var c = meta[a];
        return typeof c === "string" ? c : "\\u" + ("0000" + a.charCodeAt(0).toString(16)).slice(-4)
      }) + '"' : '"' + string + '"'
    }
  }(), trim:function(str) {
    return str.replace(/^\s+|\s+$/g, "")
  }, rsplit:function(str, delimiter, limit) {
    var chunks = str.split(delimiter), ret = [];
    ret.push(chunks.slice(0, chunks.length - limit).join(delimiter));
    ret = ret.concat(chunks.slice(chunks.length - limit));
    return ret
  }, rindexOf:function(str, needle) {
    var length = str.length, reversed = str.split("").reverse().join(""), index = reversed.indexOf(needle);
    if(index == -1) {
      return-1
    }
    return length - index
  }, getCodePointAt:function(s, index) {
    index = index || 0;
    var h = s.charCodeAt(index), l = s.charCodeAt(index + 1);
    if(isNaN(l)) {
      return h.toString(16).toLowerCase()
    }
    return((h - 55296) * 1024 + l - 56320 + 65536).toString(16).toLowerCase()
  }, fromCharCode:function(codePt) {
    if(codePt > 65535) {
      codePt -= 65536;
      return String.fromCharCode(55296 + (codePt >> 10), 56320 + (codePt & 1023))
    }else {
      return String.fromCharCode(codePt)
    }
  }, hexDecode:function(hexx) {
    var hex = hexx.toString();
    var str = "";
    for(var i = 0;i < hex.length;i += 2) {
      str += this.fromCharCode(parseInt(hex.substr(i, 2), 16))
    }
    return str
  }, crc32:function(str) {
    if(!this.crcTable) {
      this.crcTable = makeCRCTable()
    }
    var crcTable = this.crcTable;
    var crc = 0 ^ -1;
    for(var i = 0;i < str.length;i++) {
      crc = crc >>> 8 ^ crcTable[(crc ^ str.charCodeAt(i)) & 255]
    }
    return(crc ^ -1) >>> 0
  }, utf8Decode:function(s) {
    return Utf8Decode(s)
  }, ensureHttpsUrl:function(url) {
    return(url || "").replace("http://", "https://")
  }};
  function Utf8Decode(strUtf) {
    var strUni = strUtf.replace(/[\u00e0-\u00ef][\u0080-\u00bf][\u0080-\u00bf]/g, function(c) {
      var cc = (c.charCodeAt(0) & 15) << 12 | (c.charCodeAt(1) & 63) << 6 | c.charCodeAt(2) & 63;
      return String.fromCharCode(cc)
    });
    strUni = strUni.replace(/[\u00c0-\u00df][\u0080-\u00bf]/g, function(c) {
      var cc = (c.charCodeAt(0) & 31) << 6 | c.charCodeAt(1) & 63;
      return String.fromCharCode(cc)
    });
    return strUni
  }
  var makeCRCTable = function() {
    var c;
    var crcTable = [];
    for(var n = 0;n < 256;n++) {
      c = n;
      for(var k = 0;k < 8;k++) {
        c = c & 1 ? 3988292384 ^ c >>> 1 : c >>> 1
      }
      crcTable[n] = c
    }
    return crcTable
  }
})();
WebAgent.namespace("WebAgent.util");
(function() {
  var swfobject = WebAgent.util.swf = function() {
    var D = "undefined", r = "object", S = "Shockwave Flash", W = "ShockwaveFlash.ShockwaveFlash", q = "application/x-shockwave-flash", R = "SWFObjectExprInst", x = "onreadystatechange", O = window, j = document, t = navigator, T = false, U = [h], o = [], N = [], I = [], l, Q, E, B, J = false, a = false, n, G, m = true, M = function() {
      var aa = typeof j.getElementById != D && typeof j.getElementsByTagName != D && typeof j.createElement != D, ah = t.userAgent.toLowerCase(), Y = t.platform.toLowerCase(), ae = Y ? /win/.test(Y) : /win/.test(ah), ac = Y ? /mac/.test(Y) : /mac/.test(ah), af = /webkit/.test(ah) ? parseFloat(ah.replace(/^.*webkit\/(\d+(\.\d+)?).*$/, "$1")) : false, X = !+"\v1", ag = [0, 0, 0], ab = null;
      if(typeof t.plugins != D && typeof t.plugins[S] == r) {
        ab = t.plugins[S].description;
        if(ab && !(typeof t.mimeTypes != D && t.mimeTypes[q] && !t.mimeTypes[q].enabledPlugin)) {
          T = true;
          X = false;
          ab = ab.replace(/^.*\s+(\S+\s+\S+$)/, "$1");
          ag[0] = parseInt(ab.replace(/^(.*)\..*$/, "$1"), 10);
          ag[1] = parseInt(ab.replace(/^.*\.(.*)\s.*$/, "$1"), 10);
          ag[2] = /[a-zA-Z]/.test(ab) ? parseInt(ab.replace(/^.*[a-zA-Z]+(.*)$/, "$1"), 10) : 0
        }
      }else {
        if(typeof O.ActiveXObject != D) {
          try {
            var ad = new ActiveXObject(W);
            if(ad) {
              ab = ad.GetVariable("$version");
              if(ab) {
                X = true;
                ab = ab.split(" ")[1].split(",");
                ag = [parseInt(ab[0], 10), parseInt(ab[1], 10), parseInt(ab[2], 10)]
              }
            }
          }catch(Z) {
          }
        }
      }
      return{w3:aa, pv:ag, wk:af, ie:X, win:ae, mac:ac}
    }(), k = function() {
      if(!M.w3) {
        return
      }
      if(typeof j.readyState != D && j.readyState == "complete" || typeof j.readyState == D && (j.getElementsByTagName("body")[0] || j.body)) {
        f()
      }
      if(!J) {
        if(typeof j.addEventListener != D) {
          j.addEventListener("DOMContentLoaded", f, false)
        }
        if(M.ie && M.win) {
          j.attachEvent(x, function() {
            if(j.readyState == "complete") {
              j.detachEvent(x, arguments.callee);
              f()
            }
          });
          if(O == top) {
            (function() {
              if(J) {
                return
              }
              try {
                j.documentElement.doScroll("left")
              }catch(X) {
                setTimeout(arguments.callee, 0);
                return
              }
              f()
            })()
          }
        }
        if(M.wk) {
          (function() {
            if(J) {
              return
            }
            if(!/loaded|complete/.test(j.readyState)) {
              setTimeout(arguments.callee, 0);
              return
            }
            f()
          })()
        }
        s(f)
      }
    }();
    function f() {
      if(J) {
        return
      }
      try {
        var Z = j.getElementsByTagName("body")[0].appendChild(C("span"));
        Z.parentNode.removeChild(Z)
      }catch(aa) {
        return
      }
      J = true;
      var X = U.length;
      for(var Y = 0;Y < X;Y++) {
        U[Y]()
      }
    }
    function K(X) {
      if(J) {
        X()
      }else {
        U[U.length] = X
      }
    }
    function s(Y) {
      if(typeof O.addEventListener != D) {
        O.addEventListener("load", Y, false)
      }else {
        if(typeof j.addEventListener != D) {
          j.addEventListener("load", Y, false)
        }else {
          if(typeof O.attachEvent != D) {
            i(O, "onload", Y)
          }else {
            if(typeof O.onload == "function") {
              var X = O.onload;
              O.onload = function() {
                X();
                Y()
              }
            }else {
              O.onload = Y
            }
          }
        }
      }
    }
    function h() {
      if(T) {
        V()
      }else {
        H()
      }
    }
    function V() {
      var X = j.getElementsByTagName("body")[0];
      var aa = C(r);
      aa.setAttribute("type", q);
      var Z = X.appendChild(aa);
      if(Z) {
        var Y = 0;
        (function() {
          if(typeof Z.GetVariable != D) {
            var ab = Z.GetVariable("$version");
            if(ab) {
              ab = ab.split(" ")[1].split(",");
              M.pv = [parseInt(ab[0], 10), parseInt(ab[1], 10), parseInt(ab[2], 10)]
            }
          }else {
            if(Y < 10) {
              Y++;
              setTimeout(arguments.callee, 10);
              return
            }
          }
          X.removeChild(aa);
          Z = null;
          H()
        })()
      }else {
        H()
      }
    }
    function H() {
      var ag = o.length;
      if(ag > 0) {
        for(var af = 0;af < ag;af++) {
          var Y = o[af].id;
          var ab = o[af].callbackFn;
          var aa = {success:false, id:Y};
          if(M.pv[0] > 0) {
            var ae = c(Y);
            if(ae) {
              if(F(o[af].swfVersion) && !(M.wk && M.wk < 312)) {
                w(Y, true);
                if(ab) {
                  aa.success = true;
                  aa.ref = z(Y);
                  ab(aa)
                }
              }else {
                if(o[af].expressInstall && A()) {
                  var ai = {};
                  ai.data = o[af].expressInstall;
                  ai.width = ae.getAttribute("width") || "0";
                  ai.height = ae.getAttribute("height") || "0";
                  if(ae.getAttribute("class")) {
                    ai.styleclass = ae.getAttribute("class")
                  }
                  if(ae.getAttribute("align")) {
                    ai.align = ae.getAttribute("align")
                  }
                  var ah = {};
                  var X = ae.getElementsByTagName("param");
                  var ac = X.length;
                  for(var ad = 0;ad < ac;ad++) {
                    if(X[ad].getAttribute("name").toLowerCase() != "movie") {
                      ah[X[ad].getAttribute("name")] = X[ad].getAttribute("value")
                    }
                  }
                  P(ai, ah, Y, ab)
                }else {
                  p(ae);
                  if(ab) {
                    ab(aa)
                  }
                }
              }
            }
          }else {
            w(Y, true);
            if(ab) {
              var Z = z(Y);
              if(Z && typeof Z.SetVariable != D) {
                aa.success = true;
                aa.ref = Z
              }
              ab(aa)
            }
          }
        }
      }
    }
    function z(aa) {
      var X = null;
      var Y = c(aa);
      if(Y && Y.nodeName == "OBJECT") {
        if(typeof Y.SetVariable != D) {
          X = Y
        }else {
          var Z = Y.getElementsByTagName(r)[0];
          if(Z) {
            X = Z
          }
        }
      }
      return X
    }
    function A() {
      return!a && F("6.0.65") && (M.win || M.mac) && !(M.wk && M.wk < 312)
    }
    function P(aa, ab, X, Z) {
      a = true;
      E = Z || null;
      B = {success:false, id:X};
      var ae = c(X);
      if(ae) {
        if(ae.nodeName == "OBJECT") {
          l = g(ae);
          Q = null
        }else {
          l = ae;
          Q = X
        }
        aa.id = R;
        if(typeof aa.width == D || !/%$/.test(aa.width) && parseInt(aa.width, 10) < 310) {
          aa.width = "310"
        }
        if(typeof aa.height == D || !/%$/.test(aa.height) && parseInt(aa.height, 10) < 137) {
          aa.height = "137"
        }
        j.title = j.title.slice(0, 47) + " - Flash Player Installation";
        var ad = M.ie && M.win ? "ActiveX" : "PlugIn", ac = "MMredirectURL=" + O.location.toString().replace(/&/g, "%26") + "&MMplayerType=" + ad + "&MMdoctitle=" + j.title;
        if(typeof ab.flashvars != D) {
          ab.flashvars += "&" + ac
        }else {
          ab.flashvars = ac
        }
        if(M.ie && M.win && ae.readyState != 4) {
          var Y = C("div");
          X += "SWFObjectNew";
          Y.setAttribute("id", X);
          ae.parentNode.insertBefore(Y, ae);
          ae.style.display = "none";
          (function() {
            if(ae.readyState == 4) {
              ae.parentNode.removeChild(ae)
            }else {
              setTimeout(arguments.callee, 10)
            }
          })()
        }
        u(aa, ab, X)
      }
    }
    function p(Y) {
      if(M.ie && M.win && Y.readyState != 4) {
        var X = C("div");
        Y.parentNode.insertBefore(X, Y);
        X.parentNode.replaceChild(g(Y), X);
        Y.style.display = "none";
        (function() {
          if(Y.readyState == 4) {
            Y.parentNode.removeChild(Y)
          }else {
            setTimeout(arguments.callee, 10)
          }
        })()
      }else {
        Y.parentNode.replaceChild(g(Y), Y)
      }
    }
    function g(ab) {
      var aa = C("div");
      if(M.win && M.ie) {
        aa.innerHTML = ab.innerHTML
      }else {
        var Y = ab.getElementsByTagName(r)[0];
        if(Y) {
          var ad = Y.childNodes;
          if(ad) {
            var X = ad.length;
            for(var Z = 0;Z < X;Z++) {
              if(!(ad[Z].nodeType == 1 && ad[Z].nodeName == "PARAM") && !(ad[Z].nodeType == 8)) {
                aa.appendChild(ad[Z].cloneNode(true))
              }
            }
          }
        }
      }
      return aa
    }
    function u(ai, ag, Y) {
      var X, aa = c(Y);
      if(M.wk && M.wk < 312) {
        return X
      }
      if(aa) {
        if(typeof ai.id == D) {
          ai.id = Y
        }
        if(M.ie && M.win) {
          var ah = "";
          for(var ae in ai) {
            if(ai[ae] != Object.prototype[ae]) {
              if(ae.toLowerCase() == "data") {
                ag.movie = ai[ae]
              }else {
                if(ae.toLowerCase() == "styleclass") {
                  ah += ' class="' + ai[ae] + '"'
                }else {
                  if(ae.toLowerCase() != "classid") {
                    ah += " " + ae + '="' + ai[ae] + '"'
                  }
                }
              }
            }
          }
          var af = "";
          for(var ad in ag) {
            if(ag[ad] != Object.prototype[ad]) {
              af += '<param name="' + ad + '" value="' + ag[ad] + '" />'
            }
          }
          aa.outerHTML = '<object classid="clsid:D27CDB6E-AE6D-11cf-96B8-444553540000"' + ah + ">" + af + "</object>";
          N[N.length] = ai.id;
          X = c(ai.id)
        }else {
          var Z = C(r);
          Z.setAttribute("type", q);
          for(var ac in ai) {
            if(ai[ac] != Object.prototype[ac]) {
              if(ac.toLowerCase() == "styleclass") {
                Z.setAttribute("class", ai[ac])
              }else {
                if(ac.toLowerCase() != "classid") {
                  Z.setAttribute(ac, ai[ac])
                }
              }
            }
          }
          for(var ab in ag) {
            if(ag[ab] != Object.prototype[ab] && ab.toLowerCase() != "movie") {
              e(Z, ab, ag[ab])
            }
          }
          aa.parentNode.replaceChild(Z, aa);
          X = Z
        }
      }
      return X
    }
    function e(Z, X, Y) {
      var aa = C("param");
      aa.setAttribute("name", X);
      aa.setAttribute("value", Y);
      Z.appendChild(aa)
    }
    function y(Y) {
      var X = c(Y);
      if(X && X.nodeName == "OBJECT") {
        if(M.ie && M.win) {
          X.style.display = "none";
          (function() {
            if(X.readyState == 4) {
              b(Y)
            }else {
              setTimeout(arguments.callee, 10)
            }
          })()
        }else {
          X.parentNode.removeChild(X)
        }
      }
    }
    function b(Z) {
      var Y = c(Z);
      if(Y) {
        for(var X in Y) {
          if(typeof Y[X] == "function") {
            Y[X] = null
          }
        }
        Y.parentNode.removeChild(Y)
      }
    }
    function c(Z) {
      var X = null;
      try {
        X = j.getElementById(Z)
      }catch(Y) {
      }
      return X
    }
    function C(X) {
      return j.createElement(X)
    }
    function i(Z, X, Y) {
      Z.attachEvent(X, Y);
      I[I.length] = [Z, X, Y]
    }
    function F(Z) {
      var Y = M.pv, X = Z.split(".");
      X[0] = parseInt(X[0], 10);
      X[1] = parseInt(X[1], 10) || 0;
      X[2] = parseInt(X[2], 10) || 0;
      return Y[0] > X[0] || Y[0] == X[0] && Y[1] > X[1] || Y[0] == X[0] && Y[1] == X[1] && Y[2] >= X[2] ? true : false
    }
    function v(ac, Y, ad, ab) {
      if(M.ie && M.mac) {
        return
      }
      var aa = j.getElementsByTagName("head")[0];
      if(!aa) {
        return
      }
      var X = ad && typeof ad == "string" ? ad : "screen";
      if(ab) {
        n = null;
        G = null
      }
      if(!n || G != X) {
        var Z = C("style");
        Z.setAttribute("type", "text/css");
        Z.setAttribute("media", X);
        n = aa.appendChild(Z);
        if(M.ie && M.win && typeof j.styleSheets != D && j.styleSheets.length > 0) {
          n = j.styleSheets[j.styleSheets.length - 1]
        }
        G = X
      }
      if(M.ie && M.win) {
        if(n && typeof n.addRule == r) {
          n.addRule(ac, Y)
        }
      }else {
        if(n && typeof j.createTextNode != D) {
          n.appendChild(j.createTextNode(ac + " {" + Y + "}"))
        }
      }
    }
    function w(Z, X) {
      if(!m) {
        return
      }
      var Y = X ? "visible" : "hidden";
      if(J && c(Z)) {
        c(Z).style.visibility = Y
      }else {
        v("#" + Z, "visibility:" + Y)
      }
    }
    function L(Y) {
      var Z = /[\\\"<>\.;]/;
      var X = Z.exec(Y) != null;
      return X && typeof encodeURIComponent != D ? encodeURIComponent(Y) : Y
    }
    var d = function() {
      if(M.ie && M.win) {
        window.attachEvent("onunload", function() {
          var ac = I.length;
          for(var ab = 0;ab < ac;ab++) {
            I[ab][0].detachEvent(I[ab][1], I[ab][2])
          }
          var Z = N.length;
          for(var aa = 0;aa < Z;aa++) {
            y(N[aa])
          }
          for(var Y in M) {
            M[Y] = null
          }
          M = null;
          for(var X in swfobject) {
            swfobject[X] = null
          }
          swfobject = null
        })
      }
    }();
    return{registerObject:function(ab, X, aa, Z) {
      if(M.w3 && ab && X) {
        var Y = {};
        Y.id = ab;
        Y.swfVersion = X;
        Y.expressInstall = aa;
        Y.callbackFn = Z;
        o[o.length] = Y;
        w(ab, false)
      }else {
        if(Z) {
          Z({success:false, id:ab})
        }
      }
    }, getObjectById:function(X) {
      if(M.w3) {
        return z(X)
      }
    }, embedSWF:function(ab, ah, ae, ag, Y, aa, Z, ad, af, ac) {
      var X = {success:false, id:ah};
      if(M.w3 && !(M.wk && M.wk < 312) && ab && ah && ae && ag && Y) {
        w(ah, false);
        K(function() {
          ae += "";
          ag += "";
          var aj = {};
          if(af && typeof af === r) {
            for(var al in af) {
              aj[al] = af[al]
            }
          }
          aj.data = ab;
          aj.width = ae;
          aj.height = ag;
          var am = {};
          if(ad && typeof ad === r) {
            for(var ak in ad) {
              am[ak] = ad[ak]
            }
          }
          if(Z && typeof Z === r) {
            for(var ai in Z) {
              if(typeof am.flashvars != D) {
                am.flashvars += "&" + ai + "=" + Z[ai]
              }else {
                am.flashvars = ai + "=" + Z[ai]
              }
            }
          }
          if(F(Y)) {
            var an = u(aj, am, ah);
            if(aj.id == ah) {
              w(ah, true)
            }
            X.success = true;
            X.ref = an
          }else {
            if(aa && A()) {
              aj.data = aa;
              P(aj, am, ah, ac);
              return
            }else {
              w(ah, true)
            }
          }
          if(ac) {
            ac(X)
          }
        })
      }else {
        if(ac) {
          ac(X)
        }
      }
    }, switchOffAutoHideShow:function() {
      m = false
    }, ua:M, getFlashPlayerVersion:function() {
      return{major:M.pv[0], minor:M.pv[1], release:M.pv[2]}
    }, hasFlashPlayerVersion:F, createSWF:function(Z, Y, X) {
      if(M.w3) {
        return u(Z, Y, X)
      }else {
        return undefined
      }
    }, showExpressInstall:function(Z, aa, X, Y) {
      if(M.w3 && A()) {
        P(Z, aa, X, Y)
      }
    }, removeSWF:function(X) {
      if(M.w3) {
        y(X)
      }
    }, createCSS:function(aa, Z, Y, X) {
      if(M.w3) {
        v(aa, Z, Y, X)
      }
    }, addDomLoadEvent:K, addLoadEvent:s, getQueryParamValue:function(aa) {
      var Z = j.location.search || j.location.hash;
      if(Z) {
        if(/\?/.test(Z)) {
          Z = Z.split("?")[1]
        }
        if(aa == null) {
          return L(Z)
        }
        var Y = Z.split("&");
        for(var X = 0;X < Y.length;X++) {
          if(Y[X].substring(0, Y[X].indexOf("=")) == aa) {
            return L(Y[X].substring(Y[X].indexOf("=") + 1))
          }
        }
      }
      return""
    }, expressInstallCallback:function() {
      if(a) {
        var X = c(R);
        if(X && l) {
          X.parentNode.replaceChild(l, X);
          if(Q) {
            w(Q, true);
            if(M.ie && M.win) {
              l.style.display = "block"
            }
          }
          if(E) {
            E(B)
          }
        }
        a = false
      }
    }}
  }()
})();
"use strict";
(function(F) {
  function u(a, b, d) {
    var c = 0, f = [0], h = "", g = null, h = d || "UTF8";
    if("UTF8" !== h && "UTF16BE" !== h && "UTF16LE" !== h) {
      throw"encoding must be UTF8, UTF16BE, or UTF16LE";
    }
    if("HEX" === b) {
      if(0 !== a.length % 2) {
        throw"srcString of HEX type must be in byte increments";
      }
      g = w(a);
      c = g.binLen;
      f = g.value
    }else {
      if("TEXT" === b || "ASCII" === b) {
        g = x(a, h), c = g.binLen, f = g.value
      }else {
        if("B64" === b) {
          g = y(a), c = g.binLen, f = g.value
        }else {
          if("BYTES" === b) {
            g = z(a), c = g.binLen, f = g.value
          }else {
            throw"inputFormat must be HEX, TEXT, ASCII, B64, or BYTES";
          }
        }
      }
    }
    this.getHash = function(a, b, d, h) {
      var g = null, e = f.slice(), k = c, l;
      3 === arguments.length ? "number" !== typeof d && (h = d, d = 1) : 2 === arguments.length && (d = 1);
      if(d !== parseInt(d, 10) || 1 > d) {
        throw"numRounds must a integer >= 1";
      }
      switch(b) {
        case "HEX":
          g = A;
          break;
        case "B64":
          g = B;
          break;
        case "BYTES":
          g = C;
          break;
        default:
          throw"format must be HEX, B64, or BYTES";
      }
      if("SHA-224" === a) {
        for(l = 0;l < d;l += 1) {
          e = t(e, k, a), k = 224
        }
      }else {
        if("SHA-256" === a) {
          for(l = 0;l < d;l += 1) {
            e = t(e, k, a), k = 256
          }
        }else {
          throw"Chosen SHA variant is not supported";
        }
      }
      return g(e, D(h))
    };
    this.getHMAC = function(a, b, d, g, s) {
      var e, k, l, n, p = [], E = [];
      e = null;
      switch(g) {
        case "HEX":
          g = A;
          break;
        case "B64":
          g = B;
          break;
        case "BYTES":
          g = C;
          break;
        default:
          throw"outputFormat must be HEX, B64, or BYTES";
      }
      if("SHA-224" === d) {
        k = 64, n = 224
      }else {
        if("SHA-256" === d) {
          k = 64, n = 256
        }else {
          throw"Chosen SHA variant is not supported";
        }
      }
      if("HEX" === b) {
        e = w(a), l = e.binLen, e = e.value
      }else {
        if("TEXT" === b || "ASCII" === b) {
          e = x(a, h), l = e.binLen, e = e.value
        }else {
          if("B64" === b) {
            e = y(a), l = e.binLen, e = e.value
          }else {
            if("BYTES" === b) {
              e = z(a), l = e.binLen, e = e.value
            }else {
              throw"inputFormat must be HEX, TEXT, ASCII, B64, or BYTES";
            }
          }
        }
      }
      a = 8 * k;
      b = k / 4 - 1;
      if(k < l / 8) {
        for(e = t(e, l, d);e.length <= b;) {
          e.push(0)
        }
        e[b] &= 4294967040
      }else {
        if(k > l / 8) {
          for(;e.length <= b;) {
            e.push(0)
          }
          e[b] &= 4294967040
        }
      }
      for(k = 0;k <= b;k += 1) {
        p[k] = e[k] ^ 909522486, E[k] = e[k] ^ 1549556828
      }
      d = t(E.concat(t(p.concat(f), a + c, d)), a + n, d);
      return g(d, D(s))
    }
  }
  function x(a, b) {
    var d = [], c, f = [], h = 0, g, m, q;
    if("UTF8" === b) {
      for(g = 0;g < a.length;g += 1) {
        for(c = a.charCodeAt(g), f = [], 128 > c ? f.push(c) : 2048 > c ? (f.push(192 | c >>> 6), f.push(128 | c & 63)) : 55296 > c || 57344 <= c ? f.push(224 | c >>> 12, 128 | c >>> 6 & 63, 128 | c & 63) : (g += 1, c = 65536 + ((c & 1023) << 10 | a.charCodeAt(g) & 1023), f.push(240 | c >>> 18, 128 | c >>> 12 & 63, 128 | c >>> 6 & 63, 128 | c & 63)), m = 0;m < f.length;m += 1) {
          for(q = h >>> 2;d.length <= q;) {
            d.push(0)
          }
          d[q] |= f[m] << 24 - h % 4 * 8;
          h += 1
        }
      }
    }else {
      if("UTF16BE" === b || "UTF16LE" === b) {
        for(g = 0;g < a.length;g += 1) {
          c = a.charCodeAt(g);
          "UTF16LE" === b && (m = c & 255, c = m << 8 | c >> 8);
          for(q = h >>> 2;d.length <= q;) {
            d.push(0)
          }
          d[q] |= c << 16 - h % 4 * 8;
          h += 2
        }
      }
    }
    return{value:d, binLen:8 * h}
  }
  function w(a) {
    var b = [], d = a.length, c, f, h;
    if(0 !== d % 2) {
      throw"String of HEX type must be in byte increments";
    }
    for(c = 0;c < d;c += 2) {
      f = parseInt(a.substr(c, 2), 16);
      if(isNaN(f)) {
        throw"String of HEX type contains invalid characters";
      }
      for(h = c >>> 3;b.length <= h;) {
        b.push(0)
      }
      b[c >>> 3] |= f << 24 - c % 8 * 4
    }
    return{value:b, binLen:4 * d}
  }
  function z(a) {
    var b = [], d, c, f;
    for(c = 0;c < a.length;c += 1) {
      d = a.charCodeAt(c), f = c >>> 2, b.length <= f && b.push(0), b[f] |= d << 24 - c % 4 * 8
    }
    return{value:b, binLen:8 * a.length}
  }
  function y(a) {
    var b = [], d = 0, c, f, h, g, m;
    if(-1 === a.search(/^[a-zA-Z0-9=+\/]+$/)) {
      throw"Invalid character in base-64 string";
    }
    f = a.indexOf("=");
    a = a.replace(/\=/g, "");
    if(-1 !== f && f < a.length) {
      throw"Invalid '=' found in base-64 string";
    }
    for(f = 0;f < a.length;f += 4) {
      m = a.substr(f, 4);
      for(h = g = 0;h < m.length;h += 1) {
        c = "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/".indexOf(m[h]), g |= c << 18 - 6 * h
      }
      for(h = 0;h < m.length - 1;h += 1) {
        for(c = d >>> 2;b.length <= c;) {
          b.push(0)
        }
        b[c] |= (g >>> 16 - 8 * h & 255) << 24 - d % 4 * 8;
        d += 1
      }
    }
    return{value:b, binLen:8 * d}
  }
  function A(a, b) {
    var d = "", c = 4 * a.length, f, h;
    for(f = 0;f < c;f += 1) {
      h = a[f >>> 2] >>> 8 * (3 - f % 4), d += "0123456789abcdef".charAt(h >>> 4 & 15) + "0123456789abcdef".charAt(h & 15)
    }
    return b.outputUpper ? d.toUpperCase() : d
  }
  function B(a, b) {
    var d = "", c = 4 * a.length, f, h, g;
    for(f = 0;f < c;f += 3) {
      for(g = f + 1 >>> 2, h = a.length <= g ? 0 : a[g], g = f + 2 >>> 2, g = a.length <= g ? 0 : a[g], g = (a[f >>> 2] >>> 8 * (3 - f % 4) & 255) << 16 | (h >>> 8 * (3 - (f + 1) % 4) & 255) << 8 | g >>> 8 * (3 - (f + 2) % 4) & 255, h = 0;4 > h;h += 1) {
        d = 8 * f + 6 * h <= 32 * a.length ? d + "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/".charAt(g >>> 6 * (3 - h) & 63) : d + b.b64Pad
      }
    }
    return d
  }
  function C(a) {
    var b = "", d = 4 * a.length, c, f;
    for(c = 0;c < d;c += 1) {
      f = a[c >>> 2] >>> 8 * (3 - c % 4) & 255, b += String.fromCharCode(f)
    }
    return b
  }
  function D(a) {
    var b = {outputUpper:!1, b64Pad:"="};
    try {
      a.hasOwnProperty("outputUpper") && (b.outputUpper = a.outputUpper), a.hasOwnProperty("b64Pad") && (b.b64Pad = a.b64Pad)
    }catch(d) {
    }
    if("boolean" !== typeof b.outputUpper) {
      throw"Invalid outputUpper formatting option";
    }
    if("string" !== typeof b.b64Pad) {
      throw"Invalid b64Pad formatting option";
    }
    return b
  }
  function p(a, b) {
    return a >>> b | a << 32 - b
  }
  function I(a, b, d) {
    return a & b ^ ~a & d
  }
  function J(a, b, d) {
    return a & b ^ a & d ^ b & d
  }
  function K(a) {
    return p(a, 2) ^ p(a, 13) ^ p(a, 22)
  }
  function L(a) {
    return p(a, 6) ^ p(a, 11) ^ p(a, 25)
  }
  function M(a) {
    return p(a, 7) ^ p(a, 18) ^ a >>> 3
  }
  function N(a) {
    return p(a, 17) ^ p(a, 19) ^ a >>> 10
  }
  function O(a, b) {
    var d = (a & 65535) + (b & 65535);
    return((a >>> 16) + (b >>> 16) + (d >>> 16) & 65535) << 16 | d & 65535
  }
  function P(a, b, d, c) {
    var f = (a & 65535) + (b & 65535) + (d & 65535) + (c & 65535);
    return((a >>> 16) + (b >>> 16) + (d >>> 16) + (c >>> 16) + (f >>> 16) & 65535) << 16 | f & 65535
  }
  function Q(a, b, d, c, f) {
    var h = (a & 65535) + (b & 65535) + (d & 65535) + (c & 65535) + (f & 65535);
    return((a >>> 16) + (b >>> 16) + (d >>> 16) + (c >>> 16) + (f >>> 16) + (h >>> 16) & 65535) << 16 | h & 65535
  }
  function t(a, b, d) {
    var c, f, h, g, m, q, p, t, s, e, k, l, n, u, E, r, w, x, y, z, A, B, C, D, G, v = [], H, F = [1116352408, 1899447441, 3049323471, 3921009573, 961987163, 1508970993, 2453635748, 2870763221, 3624381080, 310598401, 607225278, 1426881987, 1925078388, 2162078206, 2614888103, 3248222580, 3835390401, 4022224774, 264347078, 604807628, 770255983, 1249150122, 1555081692, 1996064986, 2554220882, 2821834349, 2952996808, 3210313671, 3336571891, 3584528711, 113926993, 338241895, 666307205, 773529912, 1294757372, 
    1396182291, 1695183700, 1986661051, 2177026350, 2456956037, 2730485921, 2820302411, 3259730800, 3345764771, 3516065817, 3600352804, 4094571909, 275423344, 430227734, 506948616, 659060556, 883997877, 958139571, 1322822218, 1537002063, 1747873779, 1955562222, 2024104815, 2227730452, 2361852424, 2428436474, 2756734187, 3204031479, 3329325298];
    e = [3238371032, 914150663, 812702999, 4144912697, 4290775857, 1750603025, 1694076839, 3204075428];
    f = [1779033703, 3144134277, 1013904242, 2773480762, 1359893119, 2600822924, 528734635, 1541459225];
    if("SHA-224" === d || "SHA-256" === d) {
      k = 64, c = (b + 65 >>> 9 << 4) + 15, u = 16, E = 1, G = Number, r = O, w = P, x = Q, y = M, z = N, A = K, B = L, D = J, C = I, e = "SHA-224" === d ? e : f
    }else {
      throw"Unexpected error in SHA-2 implementation";
    }
    for(;a.length <= c;) {
      a.push(0)
    }
    a[b >>> 5] |= 128 << 24 - b % 32;
    a[c] = b;
    H = a.length;
    for(l = 0;l < H;l += u) {
      b = e[0];
      c = e[1];
      f = e[2];
      h = e[3];
      g = e[4];
      m = e[5];
      q = e[6];
      p = e[7];
      for(n = 0;n < k;n += 1) {
        16 > n ? (s = n * E + l, t = a.length <= s ? 0 : a[s], s = a.length <= s + 1 ? 0 : a[s + 1], v[n] = new G(t, s)) : v[n] = w(z(v[n - 2]), v[n - 7], y(v[n - 15]), v[n - 16]), t = x(p, B(g), C(g, m, q), F[n], v[n]), s = r(A(b), D(b, c, f)), p = q, q = m, m = g, g = r(h, t), h = f, f = c, c = b, b = r(t, s)
      }
      e[0] = r(b, e[0]);
      e[1] = r(c, e[1]);
      e[2] = r(f, e[2]);
      e[3] = r(h, e[3]);
      e[4] = r(g, e[4]);
      e[5] = r(m, e[5]);
      e[6] = r(q, e[6]);
      e[7] = r(p, e[7])
    }
    if("SHA-224" === d) {
      a = [e[0], e[1], e[2], e[3], e[4], e[5], e[6]]
    }else {
      if("SHA-256" === d) {
        a = e
      }else {
        throw"Unexpected error in SHA-2 implementation";
      }
    }
    return a
  }
  window.WebAgent && (window.WebAgent.jsSHA = u)
})(this);
WebAgent.namespace("WebAgent.debug");
WebAgent.debug.State = function() {
  var WA = WebAgent;
  var State = WA.extend(Object, {constructor:function() {
    this.items = {};
    this.isReady = false;
    WA.util.DomHelper.whenReady(this._onReady, this)
  }, _onReady:function() {
    this.isReady = true;
    this.el = WA.getBody().createChild({id:"mailru-webagent-debug-state", cls:"mailru-webagent-debug-state"});
    WA.util.Object.each(this.items, function(item, id) {
      item.el = this._createEl(id, item.value)
    }, this)
  }, _createEl:function(id, value) {
    return this.el.createChild({id:this.id + "-" + id, cls:"wa-debug-state-item", children:[{tag:"strong", html:id + ":&nbsp;"}, {tag:"span", html:value || "&nbsp;"}]})
  }, _addItem:function(id, value) {
    if(this.items[id]) {
      WA.error("Duplicate item: " + id)
    }else {
      this.items[id] = {id:id, value:value, el:this.isReady ? this._createEl(id, value) : null}
    }
  }, set:function(id, value) {
    var item = this.items[id];
    if(item) {
      item.value = value;
      if(item.el) {
        item.el.last().update(value)
      }
    }else {
      this._addItem(id, value)
    }
  }, remove:function(id) {
    var item = this.items[id];
    if(item) {
      item.id = null;
      item.el.remove();
      item.el = null;
      item.value = null;
      this.items[id] = null
    }else {
      WA.error("Invalid item: " + id)
    }
  }});
  var state = null;
  if(WA.isDebug) {
    state = new State
  }
  return{set:function(id, value) {
    if(state) {
      state.set(id, value)
    }
    return this
  }, remove:function(id) {
    if(state) {
      state.remove(id)
    }
    return this
  }}
}();
WebAgent.namespace("WebAgent.debug");
(function() {
  var WA = WebAgent;
  var print = function(level, args) {
  };
  var Console = WA.debug.Console = {log:function() {
    return
  }, debug:function() {
    print.call(Console, "debug", arguments)
  }, info:function() {
    print.call(Console, "info", arguments)
  }, warn:function() {
    print.call(Console, "warn", arguments)
  }, error:function() {
    print.call(Console, "error", arguments)
  }}
})();
WebAgent.namespace("WebAgent.i18n");
(function() {
  var WA = WebAgent;
  var U = WA.util;
  WA.tr = WA.i18n.translate = function(key, options) {
    options = options || {};
    if(options.scope) {
      key = options.scope + "." + key
    }
    if(options.context) {
      key = key + "_" + options.context
    }
    var phrase = WA.i18n.getValueByKey(WA.i18n.dict, key);
    if(typeof options.count !== "undefined") {
      phrase = WA.i18n.plural(phrase, options.count)
    }
    if(typeof phrase === "string") {
      phrase = WA.i18n.formatString(phrase, options)
    }else {
      phrase = "[" + key + "]"
    }
    return phrase
  };
  WA.i18n.getValueByKey = function(data, key) {
    var keys = key.split(".");
    while(keys.length) {
      if(data === undefined) {
        break
      }
      data = data[keys.shift()];
      if(keys.length == 0) {
        return data
      }
    }
    return null
  };
  WA.i18n.plural = function(phrase, count) {
    if(typeof phrase == "object" && WA.i18n.dict.pluralRule) {
      var key = WA.i18n.dict.pluralRule(count);
      phrase = phrase[key]
    }
    return phrase
  };
  var formatRE = /\{\{([a-zA-Z0-9_-]+?)\}\}/g;
  WA.i18n.formatString = function(str, values) {
    var formatFunc = function(unused, key) {
      return typeof values[key] != "undefined" ? "" + values[key] : ""
    };
    str = str.replace(formatRE, formatFunc);
    return str
  };
  WA.i18n.lang = "ru";
  WA.i18n.dict = {favoriteCountries:"ru,kz", mainTitle:"Mail.Ru ÐÐ³ÐµÐ½Ñ", titleAnimator:"Ð¡Ð¾Ð¾Ð±ÑÐµÐ½Ð¸Ðµ ({{count}})", cl:{searchContacts:"ÐÐ°Ð¹ÑÐ¸ ÐºÐ¾Ð½ÑÐ°ÐºÑÑ", hide:"Ð¡Ð²ÐµÑÐ½ÑÑÑ", closePopup:"ÐÐ°ÐºÑÑÑÑ Ð¾ÐºÐ½Ð¾", openPopup:"ÐÑÐºÑÑÑÑ Ð² Ð¾ÑÐ´ÐµÐ»ÑÐ½Ð¾Ð¼ Ð¾ÐºÐ½Ðµ", addContact:"ÐÐ¾Ð±Ð°Ð²Ð¸ÑÑ ÐºÐ¾Ð½ÑÐ°ÐºÑ", sendSMS:"ÐÑÐ¿ÑÐ°Ð²Ð¸ÑÑ SMS", options:"ÐÐ°ÑÑÑÐ¾Ð¹ÐºÐ¸", makeCall:"ÐÐ¾Ð·Ð²Ð¾Ð½Ð¸ÑÑ", turnOff:"ÐÑÐºÐ»ÑÑÐ¸ÑÑ", optOnlineContacts:"Ð¢Ð¾Ð»ÑÐºÐ¾ Ð¾Ð½Ð»Ð°Ð¹Ð½ ÐºÐ¾Ð½ÑÐ°ÐºÑÑ", optAllContacts:"ÐÑÐµ ÐºÐ¾Ð½ÑÐ°ÐºÑÑ", optMicroblogOff:"ÐÐµ Ð¾Ð¿Ð¾Ð²ÐµÑÐ°ÑÑ Ð¾ Ð¼Ð¸ÐºÑÐ¾Ð¿Ð¾ÑÑÐ°Ñ", optMicroblogOn:"ÐÐ¿Ð¾Ð²ÐµÑÐ°ÑÑ Ð¾ Ð¼Ð¸ÐºÑÐ¾Ð¿Ð¾ÑÑÐ°Ñ", 
  optSoundOff:"ÐÑÐºÐ»ÑÑÐ¸ÑÑ Ð·Ð²ÑÐºÐ¸", optSoundOn:"ÐÐºÐ»ÑÑÐ¸ÑÑ Ð·Ð²ÑÐºÐ¸", optSettings:"ÐÐ°ÑÑÑÐ¾Ð¹ÐºÐ¸", optAvatarsOn:"ÐÐºÐ»ÑÑÐ¸ÑÑ ÑÐ¾ÑÐ¾ ÐºÐ¾Ð½ÑÐ°ÐºÑÐ¾Ð²", optAvatarsOff:"ÐÑÐºÐ»ÑÑÐ¸ÑÑ ÑÐ¾ÑÐ¾ ÐºÐ¾Ð½ÑÐ°ÐºÑÐ¾Ð²", "optShowActiveDialogs":"ÐÐºÐ»ÑÑÐ¸ÑÑ Ð°ÐºÑÐ¸Ð²Ð½ÑÐµ Ð´Ð¸Ð°Ð»Ð¾Ð³Ð¸", "optHideActiveDialogs":"ÐÑÐºÐ»ÑÑÐ¸ÑÑ Ð°ÐºÑÐ¸Ð²Ð½ÑÐµ Ð´Ð¸Ð°Ð»Ð¾Ð³Ð¸", "titleActive":"ÐÐºÑÐ¸Ð²Ð½ÑÐµ", optPreviewsShow:"ÐÐ¾ÐºÐ°Ð·Ð°ÑÑ ÐºÐ°ÑÑÐ¸Ð½ÐºÐ¸ Ð² Ð´Ð¸Ð°Ð»Ð¾Ð³Ð°Ñ", optPreviewsHide:"Ð¡ÐºÑÑÑÑ ÐºÐ°ÑÑÐ¸Ð½ÐºÐ¸ Ð² Ð´Ð¸Ð°Ð»Ð¾Ð³Ð°Ñ", optBirthdayOn:"Ð¡Ð¾Ð¾Ð±ÑÐ°ÑÑ Ð¾ Ð´Ð½ÑÑ ÑÐ¾Ð¶Ð´ÐµÐ½Ð¸Ñ", optBirthdayOff:"ÐÐµ ÑÐ¾Ð¾Ð±ÑÐ°ÑÑ Ð¾ Ð´Ð½ÑÑ ÑÐ¾Ð¶Ð´ÐµÐ½Ð¸Ñ", optStatusesOff:"ÐÐµ Ð¾Ð¿Ð¾Ð²ÐµÑÐ°ÑÑ Ð¾ ÑÐ¼ÐµÐ½Ðµ ÑÑÐ°ÑÑÑÐ°", 
  optStatusesOn:"ÐÐ¿Ð¾Ð²ÐµÑÐ°ÑÑ Ð¾ ÑÐ¼ÐµÐ½Ðµ ÑÑÐ°ÑÑÑÐ°", tellFriends:"Ð¡ÐºÐ°Ð·Ð°ÑÑ Ð²ÑÐµÐ¼ Ð´ÑÑÐ·ÑÑÐ¼", noResults:"Ð ÐµÐ·ÑÐ»ÑÑÐ°ÑÑ Ð¾ÑÑÑÑÑÑÐ²ÑÑÑ", editStatus:"Ð ÐµÐ´Ð°ÐºÑÐ¸ÑÐ¾Ð²Ð°ÑÑ", teaser:{inviteFriends:"ÐÑÐ¸Ð³Ð»Ð°ÑÐ¸ÑÑ Ð´ÑÑÐ·ÐµÐ¹", peopleYouMayKnow:"ÐÐ¾Ð·Ð¼Ð¾Ð¶Ð½Ð¾ Ð²Ñ Ð·Ð½Ð°ÐºÐ¾Ð¼Ñ?", addFriendsAndChat:"ÐÐ¾Ð±Ð°Ð²Ñ Ð´ÑÑÐ·ÐµÐ¹<br> Ð¸ Ð½Ð°ÑÐ½Ð¸ ÑÐ²Ð¾Ðµ Ð¾Ð±ÑÐµÐ½Ð¸Ðµ<br> Ð¿ÑÑÐ¼Ð¾ ÑÐµÐ¹ÑÐ°Ñ"}}, dialog:{typeMessage:"ÐÐ°Ð¿Ð¸ÑÐ¸ÑÐµ ÑÐ¾Ð¾Ð±ÑÐµÐ½Ð¸Ðµ...", send:"ÐÑÐ¿ÑÐ°Ð²Ð¸ÑÑ", smiles:"Ð¡Ð¼Ð°Ð¹Ð»Ñ", reply:"ÐÑÐ²ÐµÑÐ¸ÑÑ", tellsFriends:"Ð³Ð¾Ð²Ð¾ÑÐ¸Ñ Ð´ÑÑÐ·ÑÑÐ¼", sendingFailed:"Ð¡Ð¾Ð¾Ð±ÑÐµÐ½Ð¸Ðµ Ð½Ðµ Ð¾ÑÐ¿ÑÐ°Ð²Ð»ÐµÐ½Ð¾.", resend:"ÐÐµÑÐµÐ¾ÑÐ¿ÑÐ°Ð²Ð¸ÑÑ", 
  loading:"ÐÐ°Ð³ÑÑÐ¶Ð°ÐµÑÑÑ...", noMessages:"ÐÐ¾ÐºÐ° Ð½ÐµÑ ÑÐ¾Ð¾Ð±ÑÐµÐ½Ð¸Ð¹", grantContactAuth:"ÐÐ²ÑÐ¾ÑÐ¸Ð·Ð¾Ð²Ð°ÑÑ Ð¸ Ð´Ð¾Ð±Ð°Ð²Ð¸ÑÑ ÐºÐ¾Ð½ÑÐ°ÐºÑ", decline:"ÐÑÐºÐ»Ð¾Ð½Ð¸ÑÑ", ignore:"ÐÐ³Ð½Ð¾ÑÐ¸ÑÐ¾Ð²Ð°ÑÑ", spam:"Ð­ÑÐ¾ ÑÐ¿Ð°Ð¼!", preview:"Ð¿ÑÐ¾ÑÐ¼Ð¾ÑÑ", previewMult:"ÐÐ¾ÑÐ¼Ð¾ÑÑÐµÑÑ Ð¼ÑÐ»ÑÑ", sendMult:"ÐÑÐ¿ÑÐ°Ð²Ð¸ÑÑ Ð¼ÑÐ»ÑÑ", sendFile:"ÐÑÐ¿ÑÐ°Ð²Ð¸ÑÑ ÑÐ°Ð¹Ð»", sentYouAFile:"ÐÑÐ¿ÑÐ°Ð²Ð¸Ð»(Ð°) Ð²Ð°Ð¼ ÑÐ°Ð¹Ð»:", viewChatMembers:"ÐÐ¾ÑÐ¼Ð¾ÑÑÐµÑÑ ÑÑÐ°ÑÑÐ½Ð¸ÐºÐ¾Ð² ÑÐ°ÑÐ°", addToChat:"ÐÐ¾Ð±Ð°Ð²Ð¸ÑÑ ÑÑÐ°ÑÑÐ½Ð¸ÐºÐ¾Ð² ÑÐ°ÑÐ°", errorPermission:"ÐÑ Ð½Ðµ Ð¼Ð¾Ð¶ÐµÑÐµ Ð¼ÐµÐ½ÑÑÑ ÑÐ¾ÑÑÐ°Ð² ÑÑÐ¾Ð³Ð¾ ÑÐ°ÑÐ°", errorNoSuchChat:"ÐÑ Ð½Ðµ ÑÐ¾ÑÑÐ¾Ð¸ÑÐµ Ð² ÑÑÐ¾Ð¼ ÑÐ°ÑÐµ", 
  sendSMS:"ÐÑÐ¿ÑÐ°Ð²Ð¸ÑÑ SMS", smsOnlyContact:"ÐÑ Ð¼Ð¾Ð¶ÐµÑÐµ ÑÐ¾Ð»ÑÐºÐ¾ Ð¾ÑÐ¿ÑÐ°Ð²Ð»ÑÑÑ SMS ÑÑÐ¾Ð¼Ñ ÐºÐ¾Ð½ÑÐ°ÐºÑÑ. ÐÐ¾Ð±Ð°Ð²ÑÑÐµ ÐµÐ³Ð¾ Ð² ÐÐ³ÐµÐ½Ñ Ð¸ Ð²Ñ ÑÐ¼Ð¾Ð¶ÐµÑÐµ Ð¾Ð±ÑÐ°ÑÑÑÑ Ñ Ð»ÑÐ±Ð¾Ð³Ð¾ ÐºÐ¾Ð¼Ð¿ÑÑÑÐµÑÐ°.", smsArchive:"ÐÑÑÐ¸Ð² Ð¾ÑÐ¿ÑÐ°Ð²Ð»ÐµÐ½Ð½ÑÑ SMS-ÑÐ¾Ð¾Ð±ÑÐµÐ½Ð¸Ð¹", smsFrom:"SMS Ð¾Ñ Ð½Ð¾Ð¼ÐµÑÐ° {{tel}}", smsTo:"SMS Ð½Ð° Ð½Ð¾Ð¼ÐµÑ {{tel}}", stateRead:"ÐÑÐ¾ÑÐ¸ÑÐ°Ð½Ð¾", stateSent:"ÐÑÐ¿ÑÐ°Ð²Ð»ÐµÐ½Ð¾", stateDelivered:"ÐÐ¾ÑÑÐ°Ð²Ð»ÐµÐ½Ð¾", stateError:"ÐÑÐ¸Ð±ÐºÐ°", stateSending:"ÐÑÐ¿ÑÐ°Ð²Ð»ÑÐµÑÑÑ", seenBy:"ÐÑÐ¾ÑÐ¼Ð¾ÑÑÐµÐ½Ð¾", typing:"Ð¿ÐµÑÐ°ÑÐ°ÐµÑ", lastMaleVisit:"ÐÑÐ» {{date}} {{atTime}}", lastFemaleVisit:"ÐÑÐ»Ð° {{date}} {{atTime}}", 
  lastVisit:"ÐÑÐ»(Ð°) {{date}} {{atTime}}", atTime:"Ð² {{time}}", date:"{{date}}", longTimeAgo:"Ð´Ð°Ð²Ð½Ð¾", hasBirthdayToday:"Ð¡ÐµÐ³Ð¾Ð´Ð½Ñ Ð¿ÑÐ°Ð·Ð´Ð½ÑÐµÑ ÐÐµÐ½Ñ Ð Ð¾Ð¶Ð´ÐµÐ½Ð¸Ñ!", addedYouToCL:"ÐÐ¾Ð»ÑÐ·Ð¾Ð²Ð°ÑÐµÐ»Ñ {{0}} Ð´Ð¾Ð±Ð°Ð²Ð¸Ð»(Ð°) Ð²Ð°Ñ Ð² ÑÐ¿Ð¸ÑÐ¾Ðº ÐºÐ¾Ð½ÑÐ°ÐºÑÐ¾Ð²", youAddToCL:"ÐÑ Ð´Ð¾Ð±Ð°Ð²Ð¸Ð»Ð¸ {{0}} Ð² ÑÐ¿Ð¸ÑÐ¾Ðº ÐºÐ¾Ð½ÑÐ°ÐºÑÐ¾Ð²", nowAvailableFroChat:"ÐÐ°Ñ Ð´ÑÑÐ³ ÑÐµÐ¿ÐµÑÑ Ð´Ð¾ÑÑÑÐ¿ÐµÐ½ Ð´Ð»Ñ ÑÐ°ÑÐ° Ð¸ Ð·Ð²Ð¾Ð½ÐºÐ¾Ð². Ð¡ÐºÐ°Ð¶Ð¸ÑÐµ Ð¿ÑÐ¸Ð²ÐµÑ!", wantFromVerifyedOnly:"{{0}} ÑÐ¾ÑÐµÑ Ð¿Ð¾Ð»ÑÑÐ°ÑÑ ÑÐ¾Ð¾Ð±ÑÐµÐ½Ð¸Ñ ÑÐ¾Ð»ÑÐºÐ¾ Ð¾Ñ Ð¿ÑÐ¾Ð²ÐµÑÐµÐ½Ð½ÑÑ Ð¿Ð¾Ð»ÑÐ·Ð¾Ð²Ð°ÑÐµÐ»ÐµÐ¹. ÐÐ¾Ð¶Ð°Ð»ÑÐ¹ÑÑÐ°, Ð¿Ð¾Ð´ÑÐ²ÐµÑÐ´Ð¸ÑÐµ Ð²Ð°Ñ Ð½Ð¾Ð¼ÐµÑ ÑÐµÐ»ÐµÑÐ¾Ð½Ð° Ð¿Ð¾ ÑÑÑÐ»ÐºÐµ {{1}}", 
  incomingCall:"ÐÑÐ¾Ð´ÑÑÐ¸Ð¹ Ð·Ð²Ð¾Ð½Ð¾Ðº", outgoingCall:"ÐÑÑÐ¾Ð´ÑÑÐ¸Ð¹ Ð·Ð²Ð¾Ð½Ð¾Ðº", msgFailedToRecognize:"ÐÐµ ÑÐ´Ð°Ð»Ð¾ÑÑ ÑÐ°ÑÐ¿Ð¾Ð·Ð½Ð°ÑÑ ÑÐ¾Ð¾Ð±ÑÐµÐ½Ð¸Ðµ.", msgFailedToRecognizeTryLater:"Ð¡Ð¾Ð¾Ð±ÑÐµÐ½Ð¸Ðµ ÑÐ°ÑÐ¿Ð¾Ð·Ð½Ð°ÐµÑÑÑ. ÐÐ¾Ð²ÑÐ¾ÑÐ¸ÑÐµ Ð¿Ð¾Ð·Ð¶Ðµ.", msgFailedToPlayRecord:"ÐÐµ ÑÐ´Ð°ÐµÑÑÑ Ð²Ð¾ÑÐ¿ÑÐ¾Ð¸Ð·Ð²ÐµÑÑÐ¸ Ð·Ð°Ð¿Ð¸ÑÑ.", msgRecordIsNotReadyYet:"ÐÐ°Ð½Ð½ÑÐµ Ð½Ðµ Ð¿Ð¾Ð»ÑÑÐµÐ½Ñ. ÐÐ¾Ð¿ÑÐ¾Ð±ÑÐ¹ÑÐµ Ð¿Ð¾Ð·Ð¶Ðµ.", tools:{photo:"Ð¤Ð¾ÑÐ¾", profile:"ÐÐ½ÐºÐµÑÐ°", spam:"Ð¡Ð¿Ð°Ð¼", ignore:"ÐÐ³Ð½Ð¾ÑÐ¸ÑÐ¾Ð²Ð°ÑÑ", rename:"ÐÐµÑÐµÐ¸Ð¼ÐµÐ½Ð¾Ð²Ð°ÑÑ", remove:"Ð£Ð´Ð°Ð»Ð¸ÑÑ", leave:"ÐÐ¾ÐºÐ¸Ð½ÑÑÑ ÑÐ°Ñ", notifyOff:"Ð¡ÐºÑÑÐ²Ð°ÑÑ ÑÐ²ÐµÐ´Ð¾Ð¼Ð»ÐµÐ½Ð¸Ñ", notifyOn:"ÐÐ¾ÐºÐ°Ð·ÑÐ²Ð°ÑÑ ÑÐ²ÐµÐ´Ð¾Ð¼Ð»ÐµÐ½Ð¸Ñ", 
  actions:"ÐÐµÐ¹ÑÑÐ²Ð¸Ñ", cancel:"ÐÑÐ¼ÐµÐ½Ð°", add:"ÐÐ¾Ð±Ð°Ð²Ð¸ÑÑ"}}, profile:{addContact:"ÐÐ¾Ð±Ð°Ð²Ð¸ÑÑ Ð² ÑÐ¿Ð¸ÑÐ¾Ðº ÐºÐ¾Ð½ÑÐ°ÐºÑÐ¾Ð²", close:"ÐÐ°ÐºÑÑÑÑ", birthdate:"ÐÐ°ÑÐ° ÑÐ¾Ð¶Ð´ÐµÐ½Ð¸Ñ", email:"Ð­Ð»ÐµÐºÑÑÐ¾Ð½Ð½Ð°Ñ Ð¿Ð¾ÑÑÐ°", home:"ÐÐµÑÑÐ¾ Ð¶Ð¸ÑÐµÐ»ÑÑÑÐ²Ð°"}, phoneBinding:{yourPhone:"ÐÐ°Ñ ÑÐµÐ»ÐµÑÐ¾Ð½", switchOn:"ÐÐ¾Ð´ÑÐ²ÐµÑÐ´Ð¸ÑÑ", codeFromSMS:"ÐÐ¾Ð´ Ð¸Ð· SMS", phone:"Ð¢ÐµÐ»ÐµÑÐ¾Ð½", modify:"ÐÐ·Ð¼ÐµÐ½Ð¸ÑÑ", yourCode:"ÐÐ°Ñ ÐºÐ¾Ð´", wrongCode:"ÐÐµÐ²ÐµÑÐ½ÑÐ¹ ÐºÐ¾Ð´", incorrectNumber:"ÐÐ¾Ð¼ÐµÑ Ð½ÐµÐºÐ¾ÑÑÐµÐºÑÐµÐ½", SMSCodeSent:"ÐÑ Ð¾ÑÐ¿ÑÐ°Ð²Ð¸Ð»Ð¸ SMS Ñ ÐºÐ¾Ð´Ð¾Ð¼.", sendAgain:"ÐÑÐ¿ÑÐ°Ð²Ð¸ÑÑ ÑÐ½Ð¾Ð²Ð°", ok:"ÐÐº"}, chat:{createChat:"Ð¡Ð¾Ð·Ð´Ð°ÑÑ Ð³ÑÑÐ¿Ð¿Ð¾Ð²Ð¾Ð¹ ÑÐ°Ñ", 
  consistPermission:"Ð¡Ð¾ÑÑÐ°Ð² ÑÑÐ°ÑÑÐ½Ð¸ÐºÐ¾Ð² ÑÐ°ÑÐ° Ð¾Ð¿ÑÐµÐ´ÐµÐ»ÑÐµÑÑÑ", permOnlyMe:"Ð¢Ð¾Ð»ÑÐºÐ¾ Ð¼Ð½Ð¾Ð¹", permAll:"ÐÐ½Ð¾Ð¹ Ð¸ Ð´ÑÑÐ³Ð¸Ð¼Ð¸ ÑÑÐ°ÑÑÐ½Ð¸ÐºÐ°Ð¼Ð¸", newChat:"ÐÐ¾Ð²ÑÐ¹ Ð³ÑÑÐ¿Ð¿Ð¾Ð²Ð¾Ð¹ ÑÐ°Ñ", theme:"Ð¢ÐµÐ¼Ð° ÑÐ°ÑÐ°", addUsers:"ÐÐ¾Ð±Ð°Ð²Ð¸ÑÑ Ð¿Ð¾Ð»ÑÐ·Ð¾Ð²Ð°ÑÐµÐ»ÐµÐ¹ Ð² ÑÐ°Ñ", needSelect:"ÐÐµÐ¾Ð±ÑÐ¾Ð´Ð¸Ð¼Ð¾ Ð²ÑÐ±ÑÐ°ÑÑ ÑÐ¾ÑÑ Ð±Ñ Ð¾Ð´Ð½Ð¾Ð³Ð¾ ÑÑÐ°ÑÑÐ½Ð¸ÐºÐ°", message:{"add":"{{0}} Ð´Ð¾Ð±Ð°Ð²Ð¸Ð» Ð² ÑÐ°Ñ Ð½Ð¾Ð²ÑÑ ÑÑÐ°ÑÑÐ½Ð¸ÐºÐ¾Ð²: {{1}}", "del":"{{0}} Ð¸ÑÐºÐ»ÑÑÐ¸Ð» Ð¸Ð· ÑÐ°ÑÐ° ÑÑÐ°ÑÑÐ½Ð¸ÐºÐ¾Ð²: {{1}}", "invite":"{{0}} Ð´Ð¾Ð±Ð°Ð²Ð¸Ð» Ð²Ð°Ñ Ð² Ð³ÑÑÐ¿Ð¿Ð¾Ð²Ð¾Ð¹ ÑÐ°Ñ", "turnOut":"{{0}} Ð¸ÑÐºÐ»ÑÑÐ¸Ð» Ð²Ð°Ñ Ð¸Ð· ÑÐ°ÑÐ°", "attached":"{{0}} Ð¿ÑÐ¸ÑÐ¾ÐµÐ´Ð¸Ð½Ð¸Ð»ÑÑ Ðº ÑÐ°ÑÑ", 
  "detached":"{{0}} Ð¿Ð¾ÐºÐ¸Ð½ÑÐ» ÑÐ°Ñ", "turnOutSelf":"ÐÑ Ð¿Ð¾ÐºÐ¸Ð½ÑÐ»Ð¸ ÑÐ°Ñ", "rename":'{{0}} ÑÐ¼ÐµÐ½Ð¸Ð»(Ð°) Ð½Ð°Ð·Ð²Ð°Ð½Ð¸Ðµ ÑÐ°ÑÐ° Ð½Ð° "{{1}}"', "modifyAbout":'{{0}} ÑÐ¼ÐµÐ½Ð¸Ð»(Ð°) Ð¾Ð¿Ð¸ÑÐ°Ð½Ð¸Ðµ ÑÐ°ÑÐ° Ð½Ð° "{{1}}"', "changeIcon":"{{0}} ÑÐ¼ÐµÐ½Ð¸Ð»(Ð°) ÐºÐ°ÑÑÐ¸Ð½ÐºÑ ÑÐ°ÑÐ°", "youRename":'ÐÑ ÑÐ¼ÐµÐ½Ð¸Ð»Ð¸ Ð½Ð°Ð·Ð²Ð°Ð½Ð¸Ðµ ÑÐ°ÑÐ° Ð½Ð° "{{1}}"', "youModifyAbout":'ÐÑ ÑÐ¼ÐµÐ½Ð¸Ð»Ð¸ Ð¾Ð¿Ð¸ÑÐ°Ð½Ð¸Ðµ ÑÐ°ÑÐ° Ð½Ð° "{{1}}"', "youChangeIcon":"ÐÑ ÑÐ¼ÐµÐ½Ð¸Ð»Ð¸ ÐºÐ°ÑÑÐ¸Ð½ÐºÑ ÑÐ°ÑÐ°", "destroyed":"ÐÐ¾Ð½ÑÐµÑÐµÐ½ÑÐ¸Ñ ÑÐ´Ð°Ð»ÐµÐ½Ð°"}}, search:{title:"ÐÐ¾Ð¸ÑÐº Ð¸ Ð´Ð¾Ð±Ð°Ð²Ð»ÐµÐ½Ð¸Ðµ ÐºÐ¾Ð½ÑÐ°ÐºÑÐ¾Ð²", search:"ÐÐ¾Ð¸ÑÐº", back:"ÐÐ°Ð·Ð°Ð´", advancedSearch:"Ð Ð°ÑÑÐ¸ÑÐµÐ½Ð½ÑÐ¹ Ð¿Ð¾Ð¸ÑÐº", 
  peopleYouMayKnow:"ÐÐ¾Ð·Ð¼Ð¾Ð¶Ð½Ð¾ Ð²Ñ Ð·Ð½Ð°ÐºÐ¾Ð¼Ñ", possiblyClassmate:"ÐÐ¾Ð·Ð¼Ð¾Ð¶Ð½Ð¾, Ð²Ð°Ñ Ð¾Ð´Ð½Ð¾ÐºÐ»Ð°ÑÑÐ½Ð¸Ðº", possiblyGroupmate:"ÐÐ¾Ð·Ð¼Ð¾Ð¶Ð½Ð¾, Ð²Ð°Ñ Ð¾Ð´Ð½Ð¾Ð³ÑÑÐ¿Ð¿Ð½Ð¸Ðº", possiblyColleague:"ÐÐ¾Ð·Ð¼Ð¾Ð¶Ð½Ð¾, Ð²Ð°Ñ ÐºÐ¾Ð»Ð»ÐµÐ³Ð°", youHaveMutualFriends:"Ð£ Ð²Ð°Ñ ÐµÑÑÑ Ð¾Ð±ÑÐ¸Ðµ Ð´ÑÑÐ·ÑÑ Ð² ÐÐ¾ÐµÐ¼ Ð¼Ð¸ÑÐµ", yourSubscriber:"Ð­ÑÐ¾Ñ ÑÐµÐ»Ð¾Ð²ÐµÐº Ð¿Ð¾Ð´Ð¿Ð¸ÑÐ°Ð½ Ð½Ð° Ð²Ð°Ñ Ð±Ð»Ð¾Ð³", yourFavorite:"Ð§ÐµÐ»Ð¾Ð²ÐµÐº Ð¸Ð· Ð²Ð°ÑÐµÐ³Ð¾ ÑÐ¿Ð¸ÑÐºÐ° Ð¸Ð·Ð±ÑÐ°Ð½Ð½ÑÑ", hisFavorite:"ÐÑ Ñ ÑÐµÐ»Ð¾Ð²ÐµÐºÐ° Ð² ÑÐ¿Ð¸ÑÐºÐµ Ð¸Ð·Ð±ÑÐ°Ð½Ð½ÑÑ", hisSubscriber:"ÐÑ Ð¿Ð¾Ð´Ð¿Ð¸ÑÐ°Ð½Ñ Ð½Ð° Ð±Ð»Ð¾Ð³ ÑÑÐ¾Ð³Ð¾ ÑÐµÐ»Ð¾Ð²ÐµÐºÐ°", correspondy:"ÐÑ Ð¾Ð±Ð¼ÐµÐ½Ð¸Ð²Ð°Ð»Ð¸ÑÑ Ð¿Ð¸ÑÑÐ¼Ð°Ð¼Ð¸ Ñ ÑÑÐ¸Ð¼ ÑÐµÐ»Ð¾Ð²ÐµÐºÐ¾Ð¼", 
  yourFriend:"ÐÐ°Ñ Ð´ÑÑÐ³ Ð² ÐÐ¾ÐµÐ¼ Ð¼Ð¸ÑÐµ", yourFriendsFriend:"ÐÑÑÐ³ Ð²Ð°ÑÐµÐ³Ð¾ Ð´ÑÑÐ³Ð° Ð² ÐÐ¾ÐµÐ¼ Ð¼Ð¸ÑÐµ", yourICQFriend:"ÐÑÑÐ³ Ð²Ð°ÑÐµÐ³Ð¾ Ð´ÑÑÐ³Ð° Ð² ICQ", yourOKFriend:"ÐÑÑÐ³ Ð²Ð°ÑÐµÐ³Ð¾ Ð´ÑÑÐ³Ð° Ð² ÐÐ´Ð½Ð¾ÐºÐ»Ð°ÑÑÐ½Ð¸ÐºÐ°Ñ", profile:"ÐÐ½ÐºÐµÑÐ°", add:"ÐÐ¾Ð±Ð°Ð²Ð¸ÑÑ", youSearched:"ÐÑ Ð¸ÑÐºÐ°Ð»Ð¸", noResults:"ÐÐ¸ÑÐµÐ³Ð¾ Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½Ð¾", backToSearchParams:"ÐÐµÑÐ½ÑÑÑÑÑ Ðº Ð¿Ð°ÑÐ°Ð¼ÐµÑÑÐ°Ð¼ Ð¿Ð¾Ð¸ÑÐºÐ°", typeEmail:"Ð£ÐºÐ°Ð¶Ð¸ÑÐµ e-mail Ð¸Ð»Ð¸ Ð½Ð¾Ð¼ÐµÑ ICQ", email:"E-mail Ð¸Ð»Ð¸ Ð½Ð¾Ð¼ÐµÑ ICQ", goSearch:"ÐÐ°Ð¹ÑÐ¸", name:"ÐÐ¼Ñ", lastname:"Ð¤Ð°Ð¼Ð¸Ð»Ð¸Ñ", sex:"ÐÐ¾Ð»", age:"ÐÐ¾Ð·ÑÐ°ÑÑ", country:"Ð¡ÑÑÐ°Ð½Ð°", state:"Ð ÐµÐ³Ð¸Ð¾Ð½", 
  city:"ÐÐ¾ÑÐ¾Ð´", wrongEmail:"ÐÐµÐ¿ÑÐ°Ð²Ð¸Ð»ÑÐ½ÑÐ¹ e-mail Ð¸Ð»Ð¸ Ð½Ð¾Ð¼ÐµÑ ICQ", searchProfile:"ÐÐ¾Ð¸ÑÐº Ð¿Ð¾ Ð°Ð½ÐºÐµÑÐµ", searchOnMap:"ÐÐ°Ð¹ÑÐ¸ Ð¿Ð¾ ÐºÐ°ÑÑÐµ", male:"Ð¼ÑÐ¶ÑÐºÐ¾Ð¹", female:"Ð¶ÐµÐ½ÑÐºÐ¸Ð¹", from:"Ð¾Ñ", to:"Ð´Ð¾", anyCountry:"ÐÑÐ±Ð°Ñ ÑÑÑÐ°Ð½Ð°", anyState:"ÐÑÐ±Ð¾Ð¹ ÑÐµÐ³Ð¸Ð¾Ð½", anyCity:"ÐÑÐ±Ð¾Ð¹ Ð³Ð¾ÑÐ¾Ð´", any:"ÐÑÐ±Ð¾Ð¹", notFamiliar:"ÐÐµ Ð·Ð½Ð°ÐºÐ¾Ð¼Ñ", fourtySecondCousin:"Ð¡ÐµÐ´ÑÐ¼Ð°Ñ Ð²Ð¾Ð´Ð° Ð½Ð° ÐºÐ¸ÑÐµÐ»Ðµ", close:"ÐÐ°ÐºÑÑÑÑ", next:"Ð¡Ð»ÐµÐ´ÑÑÑÐ¸Ð¹", previous:"ÐÑÐµÐ´ÑÐ´ÑÑÐ¸Ð¹", alreadyInList:'ÐÐ¾Ð»ÑÐ·Ð¾Ð²Ð°ÑÐµÐ»Ñ <span class="nwa-special-nick">{{nick}}</span> ÑÐ¶Ðµ Ð½Ð°ÑÐ¾Ð´Ð¸ÑÑÑ Ð² ÑÐ¿Ð¸ÑÐºÐµ ÐºÐ¾Ð½ÑÐ°ÐºÑÐ¾Ð²', 
  openChat:"ÐÑÐºÑÑÑÑ Ð´Ð¸Ð°Ð»Ð¾Ð³", noParameters:"Ð±ÐµÐ· Ð¿Ð°ÑÐ°Ð¼ÐµÑÑÐ¾Ð²"}, sms:{typeText:"ÐÐ²ÐµÐ´Ð¸ÑÐµ ÑÐµÐºÑÑ", saveAsContact:"Ð¡Ð¾ÑÑÐ°Ð½Ð¸ÑÑ ÐºÐ¾Ð½ÑÐ°ÐºÑ?", save:"Ð¡Ð¾ÑÑÐ°Ð½Ð¸ÑÑ", nope:"ÐÐµ Ð½Ð°Ð´Ð¾", typeName:"ÐÐ²ÐµÐ´Ð¸ÑÐµ Ð¸Ð¼Ñ Ð¸Ð»Ð¸ Ð½Ð¾Ð¼ÐµÑ ÑÐµÐ»ÐµÑÐ¾Ð½Ð°", send:"ÐÑÐ¿ÑÐ°Ð²Ð¸ÑÑ", phone:"Ð¢ÐµÐ»ÐµÑÐ¾Ð½", sendSMS:"ÐÑÐ¿ÑÐ°Ð²Ð¸ÑÑ SMS", autoTranslit:"ÐÐ²ÑÐ¾ÑÑÐ°Ð½ÑÐ»Ð¸Ñ", exceed:{one:"ÐÐ¸ÑÐ½Ð¸Ð¹", few:"ÐÐ¸ÑÐ½Ð¸Ñ", many:"ÐÐ¸ÑÐ½Ð¸Ñ"}, remain:{one:"ÐÑÑÐ°Ð»ÑÑ", few:"ÐÑÑÐ°Ð»Ð¾ÑÑ", many:"ÐÑÑÐ°Ð»Ð¾ÑÑ"}, symbols:{one:"{{prefix}} {{count}} ÑÐ¸Ð¼Ð²Ð¾Ð»", few:"{{prefix}} {{count}} ÑÐ¸Ð¼Ð²Ð¾Ð»Ð°", many:"{{prefix}} {{count}} ÑÐ¸Ð¼Ð²Ð¾Ð»Ð¾Ð²"}, 
  nextTry:{one:"Ð¡Ð»ÐµÐ´ÑÑÑÐ°Ñ SMS ÑÐµÑÐµÐ· {{count}} ÑÐµÐºÑÐ´Ð½Ñ", few:"Ð¡Ð»ÐµÐ´ÑÑÑÐ°Ñ SMS ÑÐµÑÐµÐ· {{count}} ÑÐµÐºÑÐ½Ð´Ñ", many:"Ð¡Ð»ÐµÐ´ÑÑÑÐ°Ñ SMS ÑÐµÑÐµÐ· {{count}} ÑÐµÐºÑÐ½Ð´"}, userPhones:"Ð¢ÐµÐ»ÐµÑÐ¾Ð½Ñ Ð¿Ð¾Ð»ÑÐ·Ð¾Ð²Ð°ÑÐµÐ»Ñ"}, dialer:{phoneBook:"Ð¢ÐµÐ»ÐµÑÐ¾Ð½Ð½Ð°Ñ ÐºÐ½Ð¸Ð³Ð°", cabinet:"ÐÐ¸ÑÐ½ÑÐ¹ ÐºÐ°Ð±Ð¸Ð½ÐµÑ", callTariff:"Ð¡ÑÐ¾Ð¸Ð¼Ð¾ÑÑÑ Ð·Ð²Ð¾Ð½ÐºÐ¾Ð²", pay:"ÐÐ¾Ð¿Ð¾Ð»Ð½Ð¸ÑÑ", phoneOrName:"Ð¢ÐµÐ»ÐµÑÐ¾Ð½ Ð¸Ð»Ð¸ Ð¸Ð¼Ñ", phone:"Ð¢ÐµÐ»ÐµÑÐ¾Ð½", youreCalling:"Ð Ð´Ð°Ð½Ð½ÑÐ¹ Ð¼Ð¾Ð¼ÐµÐ½Ñ Ð²Ñ Ð·Ð²Ð¾Ð½Ð¸ÑÐµ.", tariff:"Ð¢Ð°ÑÐ¸Ñ", connecting:"Ð¡Ð¾ÐµÐ´Ð¸Ð½ÐµÐ½Ð¸Ðµ...", minutes:"Ð¼Ð¸Ð½", searchContacts:"ÐÐ°Ð¹ÑÐ¸ ÐºÐ¾Ð½ÑÐ°ÐºÑÑ", contacts:"ÐÐ¾Ð½ÑÐ°ÐºÑÑ", 
  hangupAndDialNumber:"ÐÐ¾Ð»Ð¾Ð¶Ð¸ÑÑ ÑÑÑÐ±ÐºÑ Ð¸ Ð¿Ð¾Ð·Ð²Ð¾Ð½Ð¸ÑÑ Ð½Ð° Ð½Ð¾Ð¼ÐµÑ", dialNumber:"ÐÐ¾Ð·Ð²Ð¾Ð½Ð¸ÑÑ Ð½Ð° Ð½Ð¾Ð¼ÐµÑ", currencyRub:"ÑÑÐ±."}, voip:{voiceCalls:"ÐÐ¾Ð»Ð¾ÑÐ¾Ð²ÑÐµ Ð·Ð²Ð¾Ð½ÐºÐ¸", waitingAnswer:"ÐÐ¶Ð¸Ð´Ð°Ð½Ð¸Ðµ Ð¾ÑÐ²ÐµÑÐ°", connecting:"Ð¡Ð¾ÐµÐ´Ð¸Ð½ÐµÐ½Ð¸Ðµ...", hangup:"ÐÐ°Ð²ÐµÑÑÐ¸ÑÑ", expand:"Ð Ð°Ð·Ð²ÐµÑÐ½ÑÑÑ", incomingCall:"ÐÑÐ¾Ð´ÑÑÐ¸Ð¹ Ð²ÑÐ·Ð¾Ð²", voiceCall:"ÐÐ¾Ð»Ð¾ÑÐ¾Ð²Ð¾Ð¹ Ð·Ð²Ð¾Ð½Ð¾Ðº (Ð±ÐµÑÐ¿Ð»Ð°ÑÐ½Ð¾)", videoCall:"ÐÐ¸Ð´ÐµÐ¾Ð·Ð²Ð¾Ð½Ð¾Ðº Ð½Ð° ÐºÐ¾Ð¼Ð¿ÑÑÑÐµÑ (Ð±ÐµÑÐ¿Ð»Ð°ÑÐ½Ð¾)", answer:"ÐÑÐ²ÐµÑÐ¸ÑÑ", answerVideo:"ÐÑÐ²ÐµÑÐ¸ÑÑ Ñ Ð²Ð¸Ð´ÐµÐ¾", decline:"ÐÑÐºÐ»Ð¾Ð½Ð¸ÑÑ", msg:{swfRequired:"ÐÐµÐ¾Ð±ÑÐ¾Ð´Ð¸Ð¼Ð¾ Ð½Ð°Ð»Ð¸ÑÐ¸Ðµ Flash player<br> Ð½Ðµ Ð½Ð¸Ð¶Ðµ Ð²ÐµÑÑÐ¸Ð¸ {{ver}}", 
  swfVideoRequired:"ÐÐµÐ¾Ð±ÑÐ¾Ð´Ð¸Ð¼Ð¾ Ð½Ð°Ð»Ð¸ÑÐ¸Ðµ Flash player<br> Ð½Ðµ Ð½Ð¸Ð¶Ðµ Ð²ÐµÑÑÐ¸Ð¸ {{ver_vid}}", swfPstnRequired:"ÐÐµÐ¾Ð±ÑÐ¾Ð´Ð¸Ð¼Ð¾ Ð½Ð°Ð»Ð¸ÑÐ¸Ðµ Flash player<br> Ð½Ðµ Ð½Ð¸Ð¶Ðµ Ð²ÐµÑÑÐ¸Ð¸ {{ver_pstn}}", swfRequiredIncoming:"ÐÑÐ¾Ð´ÑÑÐ¸Ð¹ Ð²ÑÐ·Ð¾Ð². ÐÐ»Ñ Ð¾ÑÐ²ÐµÑÐ°<br> Ð½ÐµÐ¾Ð±ÑÐ¾Ð´Ð¸Ð¼Ð¾ Ð½Ð°Ð»Ð¸ÑÐ¸Ðµ Flash player", install:"Ð£ÑÑÐ°Ð½Ð¾Ð²Ð¸ÑÑ", lineIsBusy:"ÐÐ¸Ð½Ð¸Ñ Ð·Ð°Ð½ÑÑÐ°", unavailable:"ÐÐ±Ð¾Ð½ÐµÐ½Ñ Ð½ÐµÐ´Ð¾ÑÑÑÐ¿ÐµÐ½", callDeclined:"Ð¡Ð¾Ð±ÐµÑÐµÐ´Ð½Ð¸Ðº Ð¾ÑÐ¼ÐµÐ½Ð¸Ð» Ð²ÑÐ·Ð¾Ð²", noResponding:"Ð¡Ð¾Ð±ÐµÑÐµÐ´Ð½Ð¸Ðº Ð½Ðµ Ð¾ÑÐ²ÐµÑÐ°ÐµÑ", noAnswer:"ÐÐ¾Ð¼ÐµÑ Ð½Ðµ Ð¾ÑÐ²ÐµÑÐ°ÐµÑ Ð¸Ð»Ð¸ Ð½ÐµÐ´Ð¾ÑÑÐ°ÑÐ¾ÑÐ½Ð¾ Ð´ÐµÐ½ÐµÐ³ Ð´Ð»Ñ Ð·Ð²Ð¾Ð½ÐºÐ°", wrongNumber:"ÐÐµÐ¿ÑÐ°Ð²Ð¸Ð»ÑÐ½ÑÐ¹ Ð½Ð¾Ð¼ÐµÑ", 
  notEnoughMoney:"ÐÐµÐ´Ð¾ÑÑÐ°ÑÐ¾ÑÐ½Ð¾ Ð´ÐµÐ½ÐµÐ³ Ð½Ð° ÑÑÐµÑÑ", microphoneNotAllowed:"ÐÐµÐ¾Ð±ÑÐ¾Ð´Ð¸Ð¼Ð¾ ÑÐ°Ð·ÑÐµÑÐ¸ÑÑ<br> Ð´Ð¾ÑÑÑÐ¿ Ðº Ð¼Ð¸ÐºÑÐ¾ÑÐ¾Ð½Ñ", micIsBusy:"ÐÐ¸ÐºÑÐ¾ÑÐ¾Ð½ Ð·Ð°Ð½ÑÑ Ð´ÑÑÐ³Ð¸Ð¼ Ð¿ÑÐ¸Ð»Ð¾Ð¶ÐµÐ½Ð¸ÐµÐ¼", camIsBusy:"ÐÐ°Ð¼ÐµÑÐ° Ð·Ð°Ð½ÑÑÐ° Ð´ÑÑÐ³Ð¸Ð¼ Ð¿ÑÐ¸Ð»Ð¾Ð¶ÐµÐ½Ð¸ÐµÐ¼", camNotFound:"ÐÐµÐ±ÐºÐ°Ð¼ÐµÑÐ° Ð½Ðµ ÑÑÑÐ°Ð½Ð¾Ð²Ð»ÐµÐ½Ð°", micNotFound:"ÐÐ¸ÐºÑÐ¾ÑÐ¾Ð½ Ð½Ðµ ÑÑÑÐ°Ð½Ð¾Ð²Ð»ÐµÐ½", incompatible:"ÐÑÐ¾Ð³ÑÐ°Ð¼Ð¼Ð° ÑÐ¾Ð±ÐµÑÐµÐ´Ð½Ð¸ÐºÐ° Ð½Ðµ Ð¿Ð¾Ð´Ð´ÐµÑÐ¶Ð¸Ð²Ð°ÐµÑ Ð·Ð²Ð¾Ð½ÐºÐ¸", noHardware:"Ð£ ÑÐ¾Ð±ÐµÑÐµÐ´Ð½Ð¸ÐºÐ° Ð½Ðµ ÑÑÑÐ°Ð½Ð¾Ð²Ð»ÐµÐ½Ð° Ð²ÐµÐ±ÐºÐ°Ð¼ÐµÑÐ°", microphoneUnknown:"ÐÐµÐ¾Ð±ÑÐ¾Ð´Ð¸Ð¼Ð¾ Ð¿Ð¾Ð´Ð¾Ð¹ÑÐ¸ Ðº Ð¼Ð¸ÐºÑÐ¾ÑÐ¾Ð½Ñ :)", networkError:"ÐÑÐ¾Ð¸Ð·Ð¾ÑÐ»Ð° ÑÐµÑÐµÐ²Ð°Ñ Ð¾ÑÐ¸Ð±ÐºÐ°,<br> Ð¿Ð¾Ð¿ÑÐ¾Ð±ÑÐ¹ÑÐµ Ð¿Ð¾Ð·Ð¶Ðµ", 
  networkError2:"ÐÐµ ÑÐ´Ð°Ð»Ð¾ÑÑ Ð¿Ð¾Ð´ÐºÐ»ÑÑÐ¸ÑÑÑÑ Ðº ÑÐµÑÐ²ÐµÑÑ, Ð¿Ð¾Ð¿ÑÐ¾Ð±ÑÐ¹ÑÐµ ÐµÑÐµ ÑÐ°Ð·", networkError3:"ÐÐµ ÑÐ´Ð°Ð»Ð¾ÑÑ Ð¿Ð¾Ð´ÐºÐ»ÑÑÐ¸ÑÑÑÑ Ðº ÑÐµÑÐ²ÐµÑÑ, Ð¿Ð¾Ð¿ÑÐ¾Ð±ÑÐ¹ÑÐµ Ð¿Ð¾Ð·Ð²Ð¾Ð½Ð¸ÑÑ Ð¿Ð¾Ð·Ð¶Ðµ", networkError4:"ÐÑÐ¸Ð±ÐºÐ°, Ð¿ÐµÑÐµÐ»Ð¾Ð³Ð¸Ð½ÑÑÐµÑÑ Ð² Ð°Ð³ÐµÐ½ÑÐµ", networkError5:"ÐÑÐ¾Ð¸Ð·Ð¾ÑÐ»Ð° Ð¾ÑÐ¸Ð±ÐºÐ°,<br> Ð¿Ð¾Ð¿ÑÐ¾Ð±ÑÐ¹ÑÐµ ÐµÑÐµ ÑÐ°Ð·", cancelCall:"ÐÑ ÑÐ¾Ð±Ð¸ÑÐ°ÐµÑÐµÑÑ Ð·Ð°Ð²ÐµÑÑÐ¸ÑÑ ÑÐµÐºÑÑÐ¸Ð¹ Ð·Ð²Ð¾Ð½Ð¾Ðº"}, history:{callStart:"ÐÐ°ÑÐ°Ð»ÑÑ ÑÐ°Ð·Ð³Ð¾Ð²Ð¾Ñ", callIncoming:"ÐÐ²Ð¾Ð½Ð¾Ðº Ð¾Ñ Ð²Ð°ÑÐµÐ³Ð¾ ÑÐ¾Ð±ÐµÑÐµÐ´Ð½Ð¸ÐºÐ°", callOutgoing:"ÐÑ Ð·Ð²Ð¾Ð½Ð¸ÑÐµ ÑÐ¾Ð±ÐµÑÐµÐ´Ð½Ð¸ÐºÑ. ÐÐ¶Ð¸Ð´Ð°Ð½Ð¸Ðµ Ð¾ÑÐ²ÐµÑÐ°...", callDecline:"ÐÑ Ð¾ÑÐºÐ»Ð¾Ð½Ð¸Ð»Ð¸ Ð·Ð²Ð¾Ð½Ð¾Ðº", callUserDecline:"Ð¡Ð¾Ð±ÐµÑÐµÐ´Ð½Ð¸Ðº Ð¾ÑÐºÐ»Ð¾Ð½Ð¸Ð» Ð²Ð°Ñ Ð·Ð²Ð¾Ð½Ð¾Ðº", 
  callEnd:"ÐÐ²Ð¾Ð½Ð¾Ðº Ð·Ð°Ð²ÐµÑÑÐµÐ½", callSrvError:"ÐÑÐ¾Ð¸Ð·Ð¾ÑÐ»Ð° Ð½ÐµÐ¿ÑÐµÐ´Ð²Ð¸Ð´ÐµÐ½Ð½Ð°Ñ Ð¾ÑÐ¸Ð±ÐºÐ°", callUserCancel:"Ð¡Ð¾Ð±ÐµÑÐµÐ´Ð½Ð¸Ðº Ð¾ÑÐ¼ÐµÐ½Ð¸Ð» Ð·Ð²Ð¾Ð½Ð¾Ðº"}, allowMicrophoneAdvise:'ÐÐ¾Ð¶Ð°Ð»ÑÐ¹ÑÑÐ°, ÑÐ°Ð·ÑÐµÑÐ¸ÑÐµ Ð¸ÑÐ¿Ð¾Ð»ÑÐ·Ð¾Ð²Ð°Ð½Ð¸Ðµ Ð²Ð°ÑÐµÐ³Ð¾ Ð¼Ð¸ÐºÑÐ¾ÑÐ¾Ð½Ð°, Ð½Ð°Ð¶Ð°Ð² "Ð Ð°Ð·ÑÐµÑÐ¸ÑÑ" Ð² Ð²ÐµÑÑÐ½ÐµÐ¹ Ð¿Ð°Ð½ÐµÐ»Ð¸ Ð±ÑÐ°ÑÐ·ÐµÑÐ°', allowCameraAdvise:'ÐÐ¾Ð¶Ð°Ð»ÑÐ¹ÑÑÐ°, ÑÐ°Ð·ÑÐµÑÐ¸ÑÐµ Ð¸ÑÐ¿Ð¾Ð»ÑÐ·Ð¾Ð²Ð°Ð½Ð¸Ðµ Ð²Ð°ÑÐµÐ¹ ÐºÐ°Ð¼ÐµÑÑ, Ð½Ð°Ð¶Ð°Ð² "Ð Ð°Ð·ÑÐµÑÐ¸ÑÑ" Ð² Ð²ÐµÑÑÐ½ÐµÐ¹ Ð¿Ð°Ð½ÐµÐ»Ð¸ Ð±ÑÐ°ÑÐ·ÐµÑÐ°'}, promo:{installAgent:"Ð£ÑÑÐ°Ð½Ð¾Ð²Ð¸ ÐÐ³ÐµÐ½Ñ Ð½Ð° ÐºÐ¾Ð¼Ð¿ÑÑÑÐµÑ", checkNewMail:"ÐÐ³ÐµÐ½Ñ Ð¿ÑÐ¾Ð²ÐµÑÐ¸Ñ Ð¿Ð¾ÑÑÑ Ð·Ð° ÑÐµÐ±Ñ Ð¸ ÑÐ¾Ð¾Ð±ÑÐ¸Ñ Ð¾ Ð½Ð¾Ð²ÑÑ Ð¿Ð¸ÑÑÐ¼Ð°Ñ", notifications:"Ð£Ð²ÐµÐ´Ð¾Ð¼Ð»ÐµÐ½Ð¸Ñ Ð¾ Ð¿Ð¾ÑÑÐµ, Ð²Ð¸Ð´ÐµÐ¾Ð·Ð²Ð¾Ð½ÐºÐ¸, ÑÐ¾Ð¾Ð±ÑÐµÐ½Ð¸Ñ Ð¸ Ð±ÐµÑÐ¿Ð»Ð°ÑÐ½ÑÐµ SMS", 
  freeSms:"ÐÐµÑÐ¿Ð»Ð°ÑÐ½ÑÐµ SMS", sendFromAgent:"Ð¾ÑÐ¿ÑÐ°Ð²Ð»ÑÐ¹ÑÐµ Ð¸Ð· ÐÐµÐ±-ÐÐ³ÐµÐ½ÑÐ°.", birthday:"Ð¡ÐµÐ³Ð¾Ð´Ð½Ñ Ð¿ÑÐ°Ð·Ð´Ð½ÑÐµÑ ÑÐ²Ð¾Ð¹<br> ÐÐµÐ½Ñ ÑÐ¾Ð¶Ð´ÐµÐ½Ð¸Ñ!", tomorrowBirthday:"ÐÐ°Ð²ÑÑÐ° Ð¿ÑÐ°Ð·Ð´Ð½ÑÐµÑ ÑÐ²Ð¾Ð¹<br> ÐÐµÐ½Ñ ÑÐ¾Ð¶Ð´ÐµÐ½Ð¸Ñ!"}, sticker:{sticker:"Ð¡ÑÐ¸ÐºÐµÑ", stickers:"Ð¡ÑÐ¸ÐºÐµÑÑ", refresh:"ÐÐ±Ð½Ð¾Ð²Ð¸ÑÑ", install:"Ð£ÑÑÐ°Ð½Ð¾Ð²Ð¸ÑÑ", download:"Ð¡ÐºÐ°ÑÐ°ÑÑ", add:"ÐÐ¾Ð±Ð°Ð²Ð¸ÑÑ", remove:"Ð£Ð´Ð°Ð»Ð¸ÑÑ", tryNow:"ÐÐ¾Ð¿ÑÐ¾Ð±Ð¾Ð²Ð°ÑÑ", installed:"Ð£ÑÑÐ°Ð½Ð¾Ð²Ð»ÐµÐ½Ð¾", forFree:"ÐÐµÑÐ¿Ð»Ð°ÑÐ½Ð¾", stickerPackNotFound:"Ð¡ÑÐ¸ÐºÐµÑÐ¿Ð°Ðº Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½", showcase:"ÐÐ¸ÑÑÐ¸Ð½Ð°"}, auth:{authorization:"ÐÐ²ÑÐ¾ÑÐ¸Ð·Ð°ÑÐ¸Ñ", minimize:"Ð¡Ð²ÐµÑÐ½ÑÑÑ", 
  email:"ÐÐ°Ñ email", password:"ÐÐ°ÑÐ¾Ð»Ñ", rememberMe:"ÐÐ°Ð¿Ð¾Ð¼Ð½Ð¸ÑÑ Ð¼ÐµÐ½Ñ", lostPassword:"ÐÐ°Ð±ÑÐ»Ð¸ Ð¿Ð°ÑÐ¾Ð»Ñ?"}, box:{ok:"ÐK", ok_yes:"ÐÐ°", cancel:"ÐÑÐ¼ÐµÐ½Ð¸ÑÑ", ignore:"ÐÐ³Ð½Ð¾ÑÐ¸ÑÐ¾Ð²Ð°ÑÑ", spam:"Ð¡Ð¿Ð°Ð¼", spamConfirm:"ÐÐ°, ÑÑÐ¾ ÑÐ¿Ð°Ð¼", remove:"Ð£Ð´Ð°Ð»Ð¸ÑÑ", save:"Ð¡Ð¾ÑÑÐ°Ð½Ð¸ÑÑ", leave:"ÐÐ¾ÐºÐ¸Ð½ÑÑÑ", goOnline:"ÐÐºÐ»ÑÑÐ¸ÑÑ ÐÐ³ÐµÐ½Ñ?", goOnlineForce:"ÐÐºÐ»ÑÑÐ¸ÑÑ ÐÐ³ÐµÐ½Ñ? ÐÑÑÐ³Ð¸Ðµ ÐºÐ»Ð¸ÐµÐ½ÑÑ Ð±ÑÐ´ÑÑ Ð¾ÑÐºÐ»ÑÑÐµÐ½Ñ", askedAuth:"Ð·Ð°Ð¿ÑÐ¾ÑÐ¸Ð» Ð°Ð²ÑÐ¾ÑÐ¸Ð·Ð°ÑÐ¸Ñ", grantAuth:"ÐÐ²ÑÐ¾ÑÐ¸Ð·Ð¾Ð²Ð°ÑÑ Ð¸ Ð´Ð¾Ð±Ð°Ð²Ð¸ÑÑ", ignoreUser:'ÐÐ³Ð½Ð¾ÑÐ¸ÑÐ¾Ð²Ð°ÑÑ Ð¿Ð¾Ð»ÑÐ·Ð¾Ð²Ð°ÑÐµÐ»Ñ <span class="nwa-special-nick">{{nick}}</span> ?', 
  spamUser:'ÐÐ¾Ð¶Ð°Ð»Ð¾Ð²Ð°ÑÑÑÑ Ð½Ð° Ð¿Ð¾Ð»ÑÐ·Ð¾Ð²Ð°ÑÐµÐ»Ñ <span class="nwa-special-nick">{{nick}}</span> Ð¸ ÑÐ´Ð°Ð»Ð¸ÑÑ Ð¸Ð· ÐºÐ¾Ð½ÑÐ°ÐºÑÐ¾Ð²?', removeUser:'Ð£Ð´Ð°Ð»Ð¸ÑÑ <span class="nwa-special-nick">{{nick}}</span> Ð¸Ð· ÑÐ¿Ð¸ÑÐºÐ° ÐºÐ¾Ð½ÑÐ°ÐºÑÐ¾Ð²?', leaveChat:'ÐÐ¾ÐºÐ¸Ð½ÑÑÑ ÑÐ°Ñ <span class="nwa-special-nick">{{nick}}</span>?', editStatuses:"Ð ÐµÐ´Ð°ÐºÑÐ¸ÑÐ¾Ð²Ð°Ð½Ð¸Ðµ ÑÑÐ°ÑÑÑÐ¾Ð²"}, status:{online:"ÐÐ½Ð»Ð°Ð¹Ð½", chat:"ÐÐ¾ÑÐ¾Ð² Ð¿Ð¾Ð±Ð¾Ð»ÑÐ°ÑÑ", away:"ÐÑÐ¾ÑÐµÐ»", dnd:"ÐÐµ Ð±ÐµÑÐ¿Ð¾ÐºÐ¾Ð¸ÑÑ", offline:"ÐÑÐºÐ»ÑÑÑÐ½", auth:"ÐÐµ Ð°Ð²ÑÐ¾ÑÐ¸Ð·Ð¾Ð²Ð°Ð½", gray:"ÐÐµ Ð°Ð²ÑÐ¾ÑÐ¸Ð·Ð¾Ð²Ð°Ð½", conf:"ÐÑÑÐ¿ÑÐ°Ñ", tel:"Ð¢ÐµÐ»ÐµÑÐ¾Ð½", 
  mobile:"Ð¡ Ð¼Ð¾Ð±Ð¸Ð»ÑÐ½Ð¾Ð³Ð¾", unknown:"ÐÐµ Ð¾Ð¿ÑÐµÐ´ÐµÐ»ÑÐ½", invisible:"ÐÐµÐ²Ð¸Ð´Ð¸Ð¼ÑÐ¹", "icq_online":"ÐÐ½Ð»Ð°Ð¹Ð½", "icq_offline":"ÐÑÐºÐ»ÑÑÑÐ½", "icq_unknown":"ÐÐµ Ð°Ð²ÑÐ¾ÑÐ¸Ð·Ð¾Ð²Ð°Ð½", "icq_unauth":"ÐÐµ Ð°Ð²ÑÐ¾ÑÐ¸Ð·Ð¾Ð²Ð°Ð½", "icq_invisible":"ÐÐµÐ²Ð¸Ð´Ð¸Ð¼ÑÐ¹", "icq_busy":"ÐÐ°Ð½ÑÑ", "icq_chat":"ÐÐ¾ÑÐ¾Ð² Ð¿Ð¾Ð±Ð¾Ð»ÑÐ°ÑÑ", "icq_occupied":"ÐÐµ Ð±ÐµÑÐ¿Ð¾ÐºÐ¾Ð¸ÑÑ", "icq_dnd":"ÐÐµ Ð±ÐµÑÐ¿Ð¾ÐºÐ¾Ð¸ÑÑ", "icq_na":"ÐÐµÐ´Ð¾ÑÑÑÐ¿ÐµÐ½", "icq_mobile":"Ð¡ Ð¼Ð¾Ð±Ð¸Ð»ÑÐ½Ð¾Ð³Ð¾", "icq_home":"ÐÐ¾Ð¼Ð°", "icq_work":"ÐÐ° ÑÐ°Ð±Ð¾ÑÐµ", "icq_sad":"Ð Ð´ÐµÐ¿ÑÐµÑÑÐ¸Ð¸", "icq_shop":"ÐÐ°Ð³Ð°Ð·Ð¸Ð½Ñ", "icq_duck":"Ð Ð²Ð°Ð½Ð½Ð¾Ð¹", "icq_tired":"Ð£ÑÑÐ°Ð»", 
  "icq_party":"ÐÐµÑÐµÑÐ¸Ð½ÐºÐ°", "icq_beer":"ÐÐ¸Ð²Ð¾", "icq_think":"ÐÑÐ¼Ð°Ñ", "icq_eating":"ÐÑÑÐ°Ñ", "icq_tv":"Ð¢ÐµÐ»ÐµÐ²Ð¸Ð·Ð¾Ñ", "icq_friends":"ÐÑÑÐ·ÑÑ", "icq_coffee":"ÐÐ¾ÑÐµ", "icq_music":"ÐÑÐ·ÑÐºÐ°", "icq_business":"ÐÐµÐ»Ð°", "icq_cinema":"ÐÐ¸Ð½Ð¾", "icq_fun":"Ð Ð°Ð·Ð²Ð»ÐµÐºÐ°ÑÑÑ", "icq_phone":"ÐÐ° ÑÐµÐ»ÐµÑÐ¾Ð½Ðµ", "icq_game":"ÐÐ³ÑÐ°Ñ", "icq_study":"Ð£ÑÑÑÑ", "icq_sick":"ÐÐ¾Ð»ÐµÑ", "icq_sleeping":"Ð¡Ð¿Ð»Ñ", "icq_surfing":"ÐÑÑÑÐ²Ð°ÑÑÑ", "icq_internet":"Ð Ð¸Ð½ÑÐµÑÐ½ÐµÑÐµ", "icq_working":"Ð Ð°Ð±Ð¾ÑÐ°Ñ", "icq_typing":"ÐÐ¸ÑÑ", "icq_angry":"ÐÐ»Ð¾Ð¹", "icq_weekend":"ÐÑÐ´ÑÑÐ°Ñ", 
  "icq_psp":"ÐÑÐ¸ÑÑÐ°Ð²ÐºÐ°", "icq_on_mobile":"ÐÐ° Ð¼Ð¾Ð±Ð¸Ð»ÑÐ½Ð¾Ð¼", "icq_asleep":"ÐÐ°ÑÑÐ¿Ð°Ñ", "icq_wc":"Ð ÑÑÐ°Ð»ÐµÑÐµ", "icq_question":"ÐÐ¾Ð¿ÑÐ¾Ñ", "icq_way":"Ð Ð¿ÑÑÐ¸", "icq_love":"ÐÑÐ±Ð¾Ð²Ñ", "icq_in_love":"ÐÐ»ÑÐ±Ð»ÑÐ½", "icq_search":"ÐÑÑ", "icq_diary":"ÐÐ½ÐµÐ²Ð½Ð¸Ðº", 5:"ÐÐ¾Ð¼Ð°", 18:"ÐÐ° ÑÐ°Ð±Ð¾ÑÐµ", 19:"ÐÐ° Ð²ÑÑÑÐµÑÐµ", 7:"ÐÐ´Ðµ Ñ?!", 10:"ÐÑÐ»ÑÑ", 47:"Ð ÑÐ°ÐºÐµÑÐµ", 22:"Ð Ð°Ð±Ð¾ÑÐ°Ñ", 26:"Ð Ð¸Ð½ÑÑÐ¸ÑÑÑÐµ", 24:"Ð¢ÐµÐ»ÐµÑÐ¾Ð½", 27:"Ð ÑÐºÐ¾Ð»Ðµ", 23:"Ð¡Ð¿Ð»Ñ", 4:"ÐÐ¾Ð»ÐµÑ", 9:"ÐÐ¾ÑÐ¾Ð²Ð»Ñ", 6:"ÐÐ¼", 21:"ÐÑÑ ÐºÐ¾ÑÐµ", 20:"ÐÐ¸Ð²Ð¾", 17:"ÐÑÑÑ", 8:"ÐÐ°Ð½ÑÑÐ¾!", 15:"ÐÐ¾Ð´Ð½ÑÐµ Ð¿ÑÐ¾ÑÐµÐ´ÑÑÑ", 16:"ÐÐ³ÑÐ°Ñ", 
  28:"ÐÑ Ð¾ÑÐ¸Ð±Ð»Ð¸ÑÑ Ð½Ð¾Ð¼ÐµÑÐ¾Ð¼", 51:"ÐÐµÐ»ÐºÐ°", 52:"ÐÐ²ÐµÐ·Ð´Ð°", 46:"Ð§ÐµÑÐµÐ¿", 12:"Ð¯ ÐºÑÐµÐ²ÐµÐ´ÐºÐ¾", 13:"ÐÐ¾ÑÐµÑÑÐ»ÑÑ", 11:"Ð¯ Ð¿ÑÐ¸ÑÐµÐ»ÐµÑ", 14:"Ð¡Ð¾ÑÐµÐ» Ñ ÑÐ¼Ð°", 48:"ÐÐ¾ÑÑÐºÐ¾Ð¹ Ð·Ð²ÐµÑÑ", 53:"ÐÑÐ·ÑÐºÐ°", 29:"ÐÐµÑÐµÐ»Ð¾", 30:"Ð£ÑÐ¼ÑÐ»ÐºÐ°", 32:"Ð Ð°Ð´Ð¾ÑÑÐ½ÑÐ¹", 33:"ÐÑÐºÐ°ÑÐ¸Ðº", 40:"ÐÑÐ±Ð¾Ð²Ñ", 41:"Ð¡Ð¿Ð»Ñ", 34:"Ð¢Ð¾ÑÐºÐ°", 35:"ÐÐ»Ð°ÑÑ", 36:"ÐÐ°Ð°Ð°Ð°!", 37:"ÐÐ»Ð¾Ð¹", 38:"ÐÐµÐ¼Ð¾Ð½", 39:"ÐÐ¾Ð¿ÐºÐ°", 42:"ÐÑÐ»Ð¸ÑÐ½Ð¾!", 43:"ÐÐ¾Ð±ÐµÐ´Ð°!", 49:"ÐÑÑÑÐ¾!", 44:"ÐÑÐºÐ¸Ñ", 45:"ÐÐ¾ÐºÐ°!", 50:"Ð¤Ñ!"}, notify:{authRequest:"ÐÐ°Ð¿ÑÐ¾Ñ Ð°Ð²ÑÐ¾ÑÐ¸Ð·Ð°ÑÐ¸Ð¸", reply:"ÐÑÐ²ÐµÑÐ¸ÑÑ", newMessage:"ÐÐ¾Ð²Ð¾Ðµ ÑÐ¾Ð¾Ð±ÑÐµÐ½Ð¸Ðµ", microblog:"ÐÐ¸ÐºÑÐ¾Ð±Ð»Ð¾Ð³", 
  timeElapsed:"{{time}} Ð½Ð°Ð·Ð°Ð´", postedMicroblog:"ÐÐ°Ð¿Ð¸ÑÐ°Ð» Ð¼Ð¸ÐºÑÐ¾Ð¿Ð¾ÑÑ", youHaveSticker:"ÐÐ°Ð¼ Ð¿ÑÐ¸ÑÐ»Ð°Ð»Ð¸ ÑÑÐ¸ÐºÐµÑ"}, file:{downloadFile:"Ð¡ÐºÐ°ÑÐ°ÑÑ ÑÐ°Ð¹Ð»", typeFile:"ÑÐ°Ð¹Ð»", typeImage:"Ð¸Ð·Ð¾Ð±ÑÐ°Ð¶ÐµÐ½Ð¸Ðµ", errorAbort:"ÐÐ°Ð³ÑÑÐ·ÐºÐ° Ð¿ÑÐµÑÐ²Ð°Ð½Ð°", errorNotFound:"Ð¤Ð°Ð¹Ð» Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½", errorInit:"ÐÑÐ¸Ð±ÐºÐ° Ð¿ÑÐ¸ Ð¾ÑÐ¿ÑÐ°Ð²ÐºÐµ (#2)", errorReadFile:"ÐÑÐ¸Ð±ÐºÐ° ÑÑÐµÐ½Ð¸Ñ ÑÐ°Ð¹Ð»Ð°", errorUpload:"ÐÑÐ¸Ð±ÐºÐ° Ð¿ÑÐ¸ Ð¾ÑÐ¿ÑÐ°Ð²ÐºÐµ (#4)", errorSending:"ÐÑÐ¸Ð±ÐºÐ° Ð¿ÑÐ¸ Ð¾ÑÐ¿ÑÐ°Ð²ÐºÐµ (#5)", errorFileTooLarge:"Ð Ð°Ð·Ð¼ÐµÑ ÑÐ°Ð¹Ð»Ð° ÑÐ»Ð¸ÑÐºÐ¾Ð¹ Ð±Ð¾Ð»ÑÑÐ¾Ð¹"}, time:{today:"ÑÐµÐ³Ð¾Ð´Ð½Ñ", justNow:"ÑÐ¾Ð»ÑÐºÐ¾ ÑÑÐ¾", 
  yesterday:"Ð²ÑÐµÑÐ°", years:{one:"{{count}} Ð³Ð¾Ð´", few:"{{count}} Ð³Ð¾Ð´Ð°", many:"{{count}} Ð»ÐµÑ"}, months:{one:"{{count}} Ð¼ÐµÑÑÑ", few:"{{count}} Ð¼ÐµÑÑÑÐ°", many:"{{count}} Ð¼ÐµÑÑÑÐµÐ²"}, days:{one:"{{count}} Ð´ÐµÐ½Ñ", few:"{{count}} Ð´Ð½Ñ", many:"{{count}} Ð´Ð½ÐµÐ¹"}, hours:{one:"{{count}} ÑÐ°Ñ", few:"{{count}} ÑÐ°ÑÐ°", many:"{{count}} ÑÐ°ÑÐ¾Ð²"}, minutes:{one:"{{count}} Ð¼Ð¸Ð½ÑÑÐ°", few:"{{count}} Ð¼Ð¸Ð½ÑÑÑ", many:"{{count}} Ð¼Ð¸Ð½ÑÑ"}}, zodiac:{ololo:"ÐÐ»Ð¾Ð»Ð¾ÑÐµÐ½ÑÐºÐ°", aries:"ÐÐ²ÐµÐ½", taurus:"Ð¢ÐµÐ»ÐµÑ", gemini:"ÐÐ»Ð¸Ð·Ð½ÐµÑÑ", cancer:"Ð Ð°Ðº", leo:"ÐÐµÐ²", 
  virgo:"ÐÐµÐ²Ð°", libra:"ÐÐµÑÑ", scorpio:"Ð¡ÐºÐ¾ÑÐ¿Ð¸Ð¾Ð½", sagittarius:"Ð¡ÑÑÐµÐ»ÐµÑ", capricorn:"ÐÐ¾Ð·ÐµÑÐ¾Ð³", aquarius:"ÐÐ¾Ð´Ð¾Ð»ÐµÐ¹", pisces:"Ð ÑÐ±Ñ"}, sex:{f:"ÐÐµÐ½ÑÐ¸Ð½Ð°", m:"ÐÑÐ¶ÑÐ¸Ð½Ð°"}, month_gen:{"0":"Ð½ÑÐ»ÑÐ¼Ð±ÐµÑÑ", 1:"ÑÐ½Ð²Ð°ÑÑ", 2:"ÑÐµÐ²ÑÐ°Ð»Ñ", 3:"Ð¼Ð°ÑÑÐ°", 4:"Ð°Ð¿ÑÐµÐ»Ñ", 5:"Ð¼Ð°Ñ", 6:"Ð¸ÑÐ½Ñ", 7:"Ð¸ÑÐ»Ñ", 8:"Ð°Ð²Ð³ÑÑÑÐ°", 9:"ÑÐµÐ½ÑÑÐ±ÑÑ", 10:"Ð¾ÐºÑÑÐ±ÑÑ", 11:"Ð½Ð¾ÑÐ±ÑÑ", 12:"Ð´ÐµÐºÐ°Ð±ÑÑ"}, short_month_gen:{"0":"Ð½ÑÐ».", 1:"ÑÐ½Ð².", 2:"ÑÐµÐ²Ñ.", 3:"Ð¼Ð°ÑÑÐ°", 4:"Ð°Ð¿Ñ.", 5:"Ð¼Ð°Ñ", 6:"Ð¸ÑÐ½Ñ", 7:"Ð¸ÑÐ»Ñ", 8:"Ð°Ð²Ð³.", 9:"ÑÐµÐ½Ñ.", 10:"Ð¾ÐºÑ.", 11:"Ð½Ð¾ÑÐ±.", 12:"Ð´ÐµÐº."}, at_day:{"0":"Ð² Ð²Ð¾ÑÐºÑÐµÑÐµÐ½ÑÐµ", 
  1:"Ð² Ð¿Ð¾Ð½ÐµÐ´ÐµÐ»ÑÐ½Ð¸Ðº", 2:"Ð²Ð¾ Ð²ÑÐ¾ÑÐ½Ð¸Ðº", 3:"Ð² ÑÑÐµÐ´Ñ", 4:"Ð² ÑÐµÑÐ²ÐµÑÐ³", 5:"Ð² Ð¿ÑÑÐ½Ð¸ÑÑ", 6:"Ð² ÑÑÐ±Ð±Ð¾ÑÑ"}, msgHistoryLoading:"ÐÑÑÐ¾ÑÐ¸Ñ ÑÐµÐ¹ÑÐ°Ñ Ð·Ð°Ð³ÑÑÐ·Ð¸ÑÑÑ...", msgServerHistory:'Ð¡ÐµÑÐ²ÐµÑÐ½Ð¾Ðµ ÑÑÐ°Ð½ÐµÐ½Ð¸Ðµ Ð¸ÑÑÐ¾ÑÐ¸Ð¸ Ð¾ÑÐºÐ»ÑÑÐµÐ½Ð¾, Ð¸Ð·Ð¼ÐµÐ½Ð¸ÑÑ Ð½Ð°ÑÑÑÐ¾Ð¹ÐºÐ¸ Ð¼Ð¾Ð¶Ð½Ð¾ <a href="{{href}}">ÑÑÑ</a>', msgMultSupport:"Ð¡Ð¾Ð±ÐµÑÐµÐ´Ð½Ð¸Ðº Ð¿ÑÐ¸ÑÐ»Ð°Ð» Ð²Ð°Ð¼ Ð¼ÑÐ»ÑÑ :{{alt}}:, Ð¾Ð´Ð½Ð°ÐºÐ¾ Ñ Ð²Ð°Ñ ÑÑÑÐ°Ð½Ð¾Ð²Ð»ÐµÐ½Ð° ÑÑÑÐ°ÑÐµÐ²ÑÐ°Ñ Ð²ÐµÑÑÐ¸Ñ Mail.Ru ÐÐ³ÐµÐ½ÑÐ° Ð±ÐµÐ· Ð¿Ð¾Ð´Ð´ÐµÑÐ¶ÐºÐ¸ Ð¼ÑÐ»ÑÑÐ¾Ð². ÐÐ°Ð³ÑÑÐ·Ð¸ÑÑ ÑÐ°Ð¼ÑÑ Ð½Ð¾Ð²ÑÑ Ð²ÐµÑÑÐ¸Ñ Ð²Ñ Ð¼Ð¾Ð¶ÐµÑÐµ Ð·Ð´ÐµÑÑ: http://agent.mail.ru/", msgTooLong:"Ð¡Ð»Ð¸ÑÐºÐ¾Ð¼ Ð´Ð»Ð¸Ð½Ð½Ð¾Ðµ ÑÐ¾Ð¾Ð±ÑÐµÐ½Ð¸Ðµ", 
  msgTooLongAndCut:"Ð¡Ð¾Ð¾Ð±ÑÐµÐ½Ð¸Ðµ ÑÐ»Ð¸ÑÐºÐ¾Ð¼ Ð´Ð»Ð¸Ð½Ð½Ð¾Ðµ, Ð¾Ð½Ð¾ Ð¾Ð±ÑÐµÐ·Ð°Ð½Ð¾.", msgFlashFail:"ÐÐµ ÑÐ´Ð°ÐµÑÑÑ Ð·Ð°Ð³ÑÑÐ·Ð¸ÑÑ ÑÐ¾Ð»Ð¸Ðº", msgFlashInstall:"Ð£ÑÑÐ°Ð½Ð¾Ð²Ð¸ÑÐµ flash Ð¿Ð»ÐµÐµÑ Ð´Ð»Ñ Ð¿ÑÐ¾ÑÐ¼Ð¾ÑÑÐ° Ð¼ÑÐ»ÑÑÐ°", msgAddMePlease:"ÐÐ´ÑÐ°Ð²ÑÑÐ²ÑÐ¹ÑÐµ. ÐÐ¾Ð¶Ð°Ð»ÑÐ¹ÑÑÐ°, Ð´Ð¾Ð±Ð°Ð²ÑÑÐµ Ð¼ÐµÐ½Ñ Ð² ÑÐ¿Ð¸ÑÐ¾Ðº Ð²Ð°ÑÐ¸Ñ ÐºÐ¾Ð½ÑÐ°ÐºÑÐ¾Ð².", msgInvalidUser:"ÐÐ»Ñ Ð¿ÑÐ¾Ð´Ð¾Ð»Ð¶ÐµÐ½Ð¸Ñ ÑÐ°Ð±Ð¾ÑÑ Ð½ÐµÐ¾Ð±ÑÐ¾Ð´Ð¸Ð¼Ð¾ Ð¾Ð±Ð½Ð¾Ð²Ð¸ÑÑ ÑÑÑÐ°Ð½Ð¸ÑÑ.", msgTooManyConnections:"Ð¡Ð»Ð¸ÑÐºÐ¾Ð¼ Ð¼Ð½Ð¾Ð³Ð¾ Ð¿Ð¾Ð´ÐºÐ»ÑÑÐµÐ½Ð¸Ð¹ Ð¾Ñ ÑÐµÐºÑÑÐµÐ³Ð¾ Ð¿Ð¾Ð»ÑÐ·Ð¾Ð²Ð°ÑÐµÐ»Ñ.", msgNetworkError:"Ð¡ÐµÑÐ²Ð¸Ñ Ð²ÑÐµÐ¼ÐµÐ½Ð½Ð¾ Ð½ÐµÐ´Ð¾ÑÑÑÐ¿ÐµÐ½. ÐÐ¾Ð²ÑÐ¾ÑÐ½Ð°Ñ Ð¿Ð¾Ð¿ÑÑÐºÐ° Ð¿Ð¾Ð´ÐºÐ»ÑÑÐµÐ½Ð¸Ñ Ð¿ÑÐ¾Ð¸Ð·Ð¾Ð¹Ð´ÐµÑ ÑÐµÑÐµÐ· {{delay}} ÑÐµÐº. ÐÐ»Ð¸ÐºÐ½Ð¸ÑÐµ, ÑÑÐ¾Ð±Ñ Ð¿Ð¾Ð¿ÑÐ¾Ð±Ð¾Ð²Ð°ÑÑ Ð¿Ð¾Ð´ÐºÐ»ÑÑÐ¸ÑÑÑÑ ÑÐµÐ¹ÑÐ°Ñ.", 
  msgPartFew:"Ð½ÐµÑÐºÐ¾Ð»ÑÐºÐ¾", pluralRule:function(n) {
    return n % 10 == 1 && n % 100 != 11 ? "one" : U.Array.indexOf([2, 3, 4], n % 10) >= 0 && U.Array.indexOf([12, 13, 14], n % 100) < 0 ? "few" : "many"
  }}
})();
WebAgent.namespace("WebAgent.ui");
(function() {
  var WA = WebAgent;
  var U = WA.util;
  var UI = WA.ui;
  UI.Component = WA.extend(Object, {isComponent:true, constructor:function(config) {
    this.initialConfig = config || {};
    this.id = this.initialConfig.id;
    this.rendered = false;
    this.autoRender = this.initialConfig.autoRender || false;
    this.beforeShowEvent = new WA.util.Event;
    this.beforeShowEvent.on(this._onBeforeShow, this);
    this.beforeHideEvent = new WA.util.Event;
    this.beforeHideEvent.on(this._onBeforeHide, this);
    this.showEvent = new WA.util.Event;
    this.showEvent.on(this._onShow, this);
    this.hideEvent = new WA.util.Event;
    this.hideEvent.on(this._onHide, this);
    this.renderEvent = new WA.util.Event;
    this.initComponent()
  }, getId:function() {
    if(!this.id) {
      if(this.el) {
        var id = this.el.getId();
        if(id) {
          this.id = id
        }else {
          this.id = this.el.dom.id = WA.generateId()
        }
      }else {
        this.id = WA.generateId()
      }
    }
    return this.id
  }, getEl:function() {
    return this.el
  }, initComponent:function() {
  }, render:function(ct) {
    this.container = WA.get(ct);
    if(!this.el) {
      if(this.autoEl) {
        this.el = this.container.createChild(this.autoEl)
      }else {
        this._onRender(this.container)
      }
    }
    var id = this.el.getId();
    if(id) {
      if(this.id && this.id !== id) {
        WA.error("Different ids: " + this.id + ", " + id)
      }else {
        this.id = id
      }
    }else {
      if(this.id) {
        this.el.dom.id = this.id
      }
    }
    if(this.initialConfig.cls) {
      this.el.addClass(this.initialConfig.cls)
    }
    if(this.initialConfig.fadeIn && !WA.isIE) {
      this.el.addClass("nwa_fadein")
    }
    this.rendered = true;
    this._onAfterRender();
    this.renderEvent.fire(this)
  }, _onRender:function(ct) {
    WA.abstractError()
  }, _onAfterRender:function() {
  }, isVisible:function() {
    return this.rendered && this.el.isVisible()
  }, setVisible:function(visible) {
    if(!this.rendered && this.autoRender !== false && visible) {
      this.render(WA.isBoolean(this.autoRender) ? WA.getBody() : this.autoRender)
    }
    if(visible !== this.isVisible()) {
      var p = visible ? "show" : "hide";
      var beforeEvent = this["before" + U.String.capitalize(p) + "Event"];
      if(beforeEvent.fire(this) !== false) {
        this.el.setVisible(visible);
        if(this.initialConfig.fadeIn && !WA.isIE) {
          if(visible) {
            WA.setTimeout(WA.createDelegate(function() {
              this.el.setStyle("opacity", 1)
            }, this), 10)
          }else {
            this.el.setStyle("opacity", 0)
          }
        }
        var event = this[p + "Event"];
        event.fire(this)
      }
      return this
    }
  }, toggle:function() {
    this.setVisible(!this.isVisible())
  }, show:function() {
    return this.setVisible(true)
  }, hide:function() {
    return this.setVisible(false)
  }, _onBeforeShow:function(me) {
  }, _onBeforeHide:function(me) {
  }, _onShow:function(me) {
    if(this.initialConfig.modal) {
      if(WA.isIE) {
        this.overlayEl = (this.initialConfig.overlay || this.container).createChild({tag:"div", cls:"nwa-overlay-div"}, true)
      }else {
        (this.initialConfig.overlay || this.container).addClass("nwa-overlay")
      }
    }
    if(this.initialConfig.hideOnEscape) {
      WA.getDoc().on("keydown", this._onEscape, this)
    }
  }, _onHide:function(me) {
    if(this.initialConfig.modal) {
      (this.initialConfig.overlay || this.container).removeClass("nwa-overlay");
      if(this.overlayEl) {
        this.overlayEl.remove()
      }
    }
    WA.getDoc().un("keydown", this._onEscape, this)
  }, _onEscape:function(e) {
    if(e.keyCode == 27) {
      this.hide()
    }
  }, destroy:function() {
    this.initialConfig = null;
    this.beforeShowEvent.removeAll();
    this.beforeShowEvent = null;
    this.beforeHideEvent.removeAll();
    this.beforeHideEvent = null;
    this.showEvent.removeAll();
    this.showEvent = null;
    this.hideEvent.removeAll();
    this.hideEvent = null;
    this.renderEvent.removeAll();
    this.renderEvent = null;
    this.container = null;
    if(this.rendered) {
      this.el.remove();
      this.el = null
    }
  }})
})();
WebAgent.namespace("WebAgent.ui");
(function() {
  var WA = WebAgent;
  var UI = WA.ui;
  UI.Container = WA.extend(UI.Component, {defaultType:null, initComponent:function() {
    UI.Container.superclass.initComponent.call(this);
    this._initItems()
  }, _initItems:function() {
    var items = this.initialConfig.items || [];
    delete this.initialConfig.items;
    this.items = [];
    WA.util.Array.each(items, function(item) {
      this.items.push(this._lookupItemComponent(item))
    }, this)
  }, _lookupItemComponent:function(cmp) {
    return this._lookupComponent(cmp, this.defaultType)
  }, _lookupComponent:function(cmp, defaultType) {
    if(defaultType && !WA.isFunction(cmp.render)) {
      return new defaultType(cmp)
    }else {
      return cmp
    }
  }, _onAfterRender:function() {
    UI.Container.superclass._onAfterRender.call(this);
    WA.util.Array.each(this.items, function(item, index) {
      this._renderItem(this.el, item, index)
    }, this)
  }, _renderItem:function(container, item, index) {
    item.render(container)
  }, getItemById:function(id) {
    var ret = null;
    WA.util.Array.each(this.items, function(item) {
      if(item.initialConfig.altId === id) {
        ret = item
      }
    }, this);
    return ret
  }, _destroyItem:function(item) {
    item.destroy()
  }, destroy:function() {
    while(this.items.length > 0) {
      this._destroyItem(this.items.shift())
    }
    this.items = null;
    UI.Container.superclass.destroy.call(this)
  }})
})();
WebAgent.namespace("WebAgent.ui");
(function() {
  var WA = WebAgent;
  var UI = WA.ui;
  UI.Window = WA.extend(UI.Container, {initComponent:function() {
    UI.Window.superclass.initComponent.call(this);
    this.closeAction = this.closeAction || this.initialConfig.closeAction || "destroy";
    this.closeBtn = new WA.ui.Button({cls:"nwa-window__close", handler:function() {
      this.close()
    }, scope:this});
    this._initToolbar("bbar")
  }, _initToolbar:function(key) {
    var config = this.initialConfig[key];
    if(config) {
      var defaultType = UI.Toolbar;
      if(WA.isArray(config)) {
        this[key] = this._lookupComponent({items:config}, defaultType)
      }else {
        this[key] = this._lookupComponent(config, defaultType)
      }
      this[key].renderEvent.on(function(bar) {
        bar.el.addClass("nwa-window-" + key)
      })
    }
  }, _onRender:function(container) {
    var id = this.getId();
    var ids = {header:id + "-header", body:id + "-body", footer:id + "-footer"};
    var cssPrefix = "nwa-window";
    var items = [{id:ids.header, cls:cssPrefix + "__header", html:this.initialConfig.title}, {id:ids.body, cls:cssPrefix + "__body"}];
    if(this.bbar) {
      items.push({id:ids.footer, cls:cssPrefix + "__footer"})
    }
    this.el = container.createChild({cls:cssPrefix, style:"display: none", children:items});
    this.header = WA.get(ids.header);
    if(this.closeBtn) {
      this.closeBtn.render(ids.header)
    }
    this.body = WA.get(ids.body);
    if(this.bbar) {
      this.bbar.render(ids.footer)
    }
  }, _renderItem:function(container, item, index) {
    UI.Window.superclass._renderItem.call(this, this.body, item, index)
  }, close:function() {
    this[this.closeAction]()
  }, destroy:function() {
    if(this.bbar) {
      this.bbar.destroy();
      this.bbar = null
    }
    UI.Window.superclass.destroy.call(this)
  }})
})();
WebAgent.namespace("WebAgent.ui");
(function() {
  var WA = WebAgent;
  var UI = WA.ui;
  var U = WA.util;
  UI.Button = WA.extend(UI.Component, {initComponent:function() {
    UI.Button.superclass.initComponent.call(this);
    var menu = this.initialConfig.menu;
    if(menu) {
      if(menu.render) {
        this.menu = menu
      }else {
        if(WA.isArray(menu)) {
          this.menu = new UI.menu.Menu({items:menu})
        }else {
          this.menu = new UI.menu.Menu(menu)
        }
      }
      delete this.initialConfig.menu
    }
    this.disabled = !!this.initialConfig.disabled
  }, _onRender:function(ct) {
    this.el || (this.el = ct.createChild({tag:"button", cls:"nwa-button " + (this.initialConfig.disabled && this.initialConfig.disabledCls ? this.initialConfig.disabledCls : ""), title:this.initialConfig.tooltip || "", html:this.initialConfig.text}));
    if(this.initialConfig.disabled) {
      this.el.setAttribute("disabled", "disabled")
    }
    if(this.menu) {
      this.menu.setControlElement(this.el)
    }
  }, disable:function() {
    if(!this.disabled) {
      this.disabled = true;
      this.el.setAttribute("disabled", "disabled");
      if(this.initialConfig.disabledCls) {
        this.el.addClass(this.initialConfig.disabledCls)
      }
    }
  }, enable:function() {
    if(this.disabled) {
      this.disabled = false;
      this.el.removeAttribute("disabled");
      this.el.removeClass(this.initialConfig.disabledCls)
    }
  }, _onAfterRender:function() {
    UI.Button.superclass._onAfterRender.call(this);
    this.el.on(this.initialConfig.clickEvent || "click", this._onClick, this)
  }, _onClick:function(e) {
    if(e.button === 0 && !this.disabled) {
      if(e && this.initialConfig.preventDefault !== false) {
        e.preventDefault()
      }
      var handler = this.initialConfig.handler;
      if(handler) {
        handler.call(this.initialConfig.scope || this, this, e)
      }
      if(this.menu) {
        if(!this.menu.rendered) {
          this.menu.render(this.container)
        }
        this.menu.toggle()
      }
    }
  }, setText:function(text) {
    this.el.update(U.String.htmlEntity(this.initialConfig.text = text))
  }, getText:function() {
    return this.initialConfig.text
  }, destroy:function() {
    this.el.un(this.initialConfig.clickEvent || "click", this._onClick, this);
    if(this.menu) {
      this.menu.destroy();
      this.menu = null
    }
    UI.Button.superclass.destroy.call(this)
  }});
  UI.ToggleButton = WA.extend(UI.Button, {_pressedClassName:"nwa-button_pressed", state:false, _onRender:function(ct) {
    UI.ToggleButton.superclass._onRender.call(this, ct);
    if(this.state) {
      this.el.addClass(this._pressedClassName)
    }
    if(this.initialConfig.linkedLayer) {
      this.initialConfig.linkedLayer.showEvent.on(function() {
        this.setState(true)
      }, this);
      this.initialConfig.linkedLayer.hideEvent.on(function() {
        this.setState(false)
      }, this)
    }
  }, _onClick:function(e) {
    UI.ToggleButton.superclass._onClick.call(this, e);
    var newState = !this.state;
    var stateHandler = this.initialConfig.stateHandler;
    if(stateHandler && stateHandler.call(this.initialConfig.scope || this, newState, this) !== false) {
      this.setState(newState)
    }
  }, setState:function(newState) {
    this.state = newState;
    this.el.removeClass(this._pressedClassName);
    if(this.state) {
      this.el.addClass(this._pressedClassName)
    }
  }});
  UI.LinkButton = WA.extend(UI.Button, {_onRender:function(ct) {
    var children = [];
    if(this.initialConfig.iconCls) {
      children.push({tag:"div", cls:"nwa-img-button " + this.initialConfig.iconCls, align:"top", title:this.initialConfig.tooltip || ""})
    }
    children.push({tag:"span", html:U.String.htmlEntity(this.initialConfig.text || "")});
    var linkConfig = {tag:"a", cls:"nwa-button " + (this.initialConfig.disabled && this.initialConfig.disabledCls ? this.initialConfig.disabledCls : ""), href:"javascript:void(0)", children:children};
    if(this.initialConfig.linkAttributes) {
      WA.apply(linkConfig, this.initialConfig.linkAttributes)
    }
    this.el = ct.createChild(linkConfig)
  }, setText:function(text) {
    this.initialConfig.text = text;
    if(this.rendered) {
      var lastEl = this.el.last();
      lastEl.update(U.String.htmlEntity(this.initialConfig.text))
    }
  }, setIconCls:function(cls) {
    if(this.rendered) {
      this.el.first().removeClass(this.initialConfig.iconCls).addClass(cls)
    }
    this.initialConfig.iconCls = cls
  }});
  UI.ImageButton = WA.extend(UI.Button, {initComponent:function() {
    UI.ImageButton.superclass.initComponent.call(this);
    this.initialConfig.iconCls = this.initialConfig.iconCls || " "
  }, _onRender:function(ct) {
    UI.ImageButton.superclass._onRender.call(this, ct);
    this.el.createChild({tag:"span", cls:"nwa-img-button " + (this.initialConfig.iconCls || ""), title:this.initialConfig.tooltip || "", html:"&nbsp;"})
  }, setIconCls:function(cls) {
    if(this.rendered) {
      this.el.first().removeClass(this.initialConfig.iconCls).addClass(cls)
    }
    this.initialConfig.iconCls = cls
  }});
  UI.TabButton = WA.extend(UI.Button, {_onRender:function(ct) {
    var buttonConfig = {tag:"div", cls:"nwa-button-tab", children:[{tag:"div", cls:"nwa-button-tab__inner ", title:this.initialConfig.title || "", children:[{tag:"span", cls:"nwa-button-tab__icon " + (this.initialConfig.defaultIconCls || "") + " " + (this.initialConfig.iconCls || "")}, {tag:"span", cls:"nwa-button-tab__nick", html:U.String.htmlEntity(this.initialConfig.text || "")}]}, {tag:"div", cls:"nwa-msg-counter"}]};
    if(this.initialConfig.closable) {
      buttonConfig.children.push({tag:"div", cls:"nwa-button-tab__close nwa_action_close", children:[{tag:"span"}]})
    }
    if(this.initialConfig.fader) {
      buttonConfig.children[0].children.push({tag:"div", cls:"nwa-button-tab__nick-fadeout"})
    }
    if(this.initialConfig.tabAttributes) {
      WA.apply(buttonConfig, this.initialConfig.tabAttributes)
    }
    this.el = ct.createChild(buttonConfig)
  }, setState:function() {
  }, setText:function(text) {
    this.initialConfig.text = text;
    if(this.rendered) {
      var lastEl = this.el.first().first().next();
      lastEl.update(U.String.htmlEntity(this.initialConfig.text))
    }
  }, setTitle:function(title) {
    if(this.rendered) {
      this.el.first().setAttribute("title", title)
    }
  }, setCount:function(val) {
    if(this.rendered) {
      var countEl = this.el.first().next();
      countEl.update(val)
    }
  }, setIconCls:function(cls) {
    if(this.rendered) {
      this.el.first().first().dom.className = "nwa-button-tab__icon " + (this.initialConfig.defaultIconCls || "") + " " + cls
    }
    this.initialConfig.iconCls = cls
  }, setAttr:function(name, value) {
    this.el.setAttribute(name, value)
  }});
  UI.FileButton = WA.extend(UI.Button, {_onRender:function(ct) {
    this.el = ct.createChild({tag:"div", cls:"nwa-button " + (this.initialConfig.disabled && this.initialConfig.disabledCls ? this.initialConfig.disabledCls : ""), title:this.initialConfig.tooltip || "", html:'<span></span><input title="' + (this.initialConfig.tooltip || "") + '" type="file" />'})
  }, _onAfterRender:function() {
    this.fileNode = this.el.first().next().on("change", this._onChange, this);
    this.fileNode.on("click", this._onClick, this)
  }, clear:function() {
    this.fileNode.dom.value = null
  }, _onChange:function(e) {
    var handler = this.initialConfig.change;
    handler && handler.call(this.initialConfig.scope || this, this.fileNode, e)
  }})
})();
WebAgent.namespace("WebAgent.ui");
(function() {
  var WA = WebAgent;
  var UI = WA.ui;
  var U = WA.util;
  UI.TextField = WA.extend(UI.Component, {initComponent:function() {
    UI.TextField.superclass.initComponent.call(this);
    this.hintText = this.initialConfig.hintText || "";
    this.hintClass = this.initialConfig.hintClass || "nwa_hint_msg";
    this.clientValue = "";
    this.focusEvent = new WA.util.Event;
    this.blurEvent = new WA.util.Event
  }, textVal:function(value, preventHint) {
    return this.val(value, preventHint)
  }, _onRender:function(ct) {
    var config = this.initialConfig;
    var o;
    if(config.multiline) {
      o = {tag:"textarea", cls:"nwa-textfield"}
    }else {
      o = {tag:"input", type:"text", autocomplete:"off", cls:"nwa-textfield"}
    }
    if(config.maxLength) {
      o.maxlength = config.maxLength
    }
    if(config.placeholder) {
      o.placeholder = config.placeholder
    }
    this.el = ct.createChild(o)
  }, val:function(value, preventHint) {
    if(typeof value === "undefined") {
      if(this.rendered) {
        return this.el.dom.value === this.hintText ? "" : this.el.dom.value
      }
      return null
    }
    if(this.rendered && !this.el.dom.disabled) {
      this.el.dom.value = value || "";
      if(preventHint !== true || this.el.dom.value != "") {
        this._checkHintValue()
      }
    }
  }, fix:function(state) {
    this.el.dom.disabled = state !== false
  }, _onAfterRender:function() {
    this.el.dom.value = this.initialConfig.value || "";
    this._checkHintValue();
    if(this.hintText && this.el.dom.value == this.hintText) {
      this.el.addClass(this.hintClass)
    }
    this.el.on("focus", this._onFocus, this);
    this.el.on("blur", this._onBlur, this)
  }, getCursor:function() {
    var pos = 0;
    if(document.selection) {
      this.focus();
      var sel = document.selection.createRange();
      sel.moveStart("character", -this.el.dom.value.length);
      pos = sel.text.length
    }else {
      if(this.el.dom.selectionStart || this.el.dom.selectionStart == "0") {
        pos = this.el.dom.selectionStart
      }
    }
    return pos
  }, focus:function(pos) {
    try {
      if(pos > -1) {
        if(this.el.dom.createTextRange) {
          var textRange = this.el.dom.createTextRange();
          textRange.collapse(true);
          textRange.moveEnd("character", pos);
          textRange.moveStart("character", pos);
          textRange.select()
        }else {
          if(this.el.dom.setSelectionRange) {
            this.el.dom.setSelectionRange(pos, pos)
          }
        }
      }else {
        this.el.dom.focus()
      }
    }catch(e) {
    }
  }, blur:function() {
    try {
      this.el.dom.blur()
    }catch(e) {
    }
  }, select:function() {
    this.el.dom.select()
  }, _onFocus:function() {
    if(this.hintText && this.el.dom.value === this.hintText) {
      this.el.dom.value = ""
    }
    this.el.removeClass(this.hintClass);
    this.focusEvent.fire(this)
  }, _onBlur:function() {
    this._checkHintValue();
    this.blurEvent.fire(this)
  }, _checkHintValue:function() {
    var domValue = U.String.trim(this.el.dom.value);
    if(this.hintText) {
      if(domValue === "" || domValue == this.hintText) {
        this.el.addClass(this.hintClass);
        this.el.dom.value = this.hintText
      }else {
        this.el.removeClass(this.hintClass)
      }
    }
  }, destroy:function() {
    this.focusEvent.removeAll();
    this.focusEvent = null;
    this.blurEvent.removeAll();
    this.blurEvent = null;
    UI.TextField.superclass.destroy.call(this)
  }});
  UI.NameBox = WA.extend(UI.Component, {constructor:function() {
    UI.NameBox.superclass.constructor.apply(this, arguments);
    this._editMode = false;
    this.editOk = new U.Event
  }, _onRender:function(ct) {
    this.el = ct.createChild({cls:"nwa-namebox", children:[{cls:"nwa-namebox__label"}, {cls:"nwa-namebox__fadeout"}]})
  }, _sanitize:function(val) {
    return val.replace(/(\\|\/|<|>)/g, "")
  }, _editOn:function() {
    if(this._editMode) {
      return
    }
    if(!this.editField) {
      this.editField = new UI.TextField({cls:"nwa-namebox__input"});
      this.editField.render(this.el);
      this.editField.getEl().on("click", function(e) {
        e.stopEvent()
      });
      this.editField.getEl().on("keydown", function(e) {
        if(e.keyCode == 13) {
          var val = U.String.trim(this._sanitize(this.editField.val()));
          if(val != "") {
            this.setName(val);
            this.editOk.fire(val);
            this._editOff()
          }else {
            this.editField.val(val)
          }
          e.preventDefault()
        }else {
          if(e.keyCode == 27) {
            this._editOff()
          }
        }
      }, this);
      this.editField.blurEvent.on(function() {
        this._editOff()
      }, this)
    }
    this._editMode = true;
    this.el.addClass("nwa-namebox_editor");
    this.editField.val(U.String.entityDecode(this.el.first().dom.innerHTML));
    this.editField.focus();
    this.editField.select()
  }, _editOff:function() {
    if(!this._editMode) {
      return
    }
    this._editMode = false;
    this.editField.blur();
    this.el.removeClass("nwa-namebox_editor")
  }, setName:function(val) {
    this.el.first().update(U.String.htmlEntity(val))
  }, edit:function(force) {
    if(force !== false) {
      this._editOn()
    }else {
      this._editOff()
    }
  }})
})();
WebAgent.namespace("WebAgent.ui");
(function() {
  var WA = WebAgent, UI = WA.ui, U = WA.util, S, KEY_CODES = {ENTER:13, BACKSPACE:8, ARR_LEFT:37, ARR_UP:38, ARR_RIGHT:39, ARR_DOWN:40}, LINK_START_RE = /(www\.|https?:\/\/)[\-\w\d_]+$/, ELEMENT_NODE = 1, TEXT_NODE = 3, WHEEL_STEP = 15;
  S = UI.SmilesTextField = WA.extend(UI.TextField, {constructor:function() {
    UI.SmilesTextField.superclass.constructor.apply(this, arguments)
  }, smileBeforeNode:null, _onRender:function(ct) {
    var config = this.initialConfig, o = {tag:"div", cls:"nwa-textfield nwa-textfield_rich", contenteditable:"true"};
    if(config.multiline) {
      o.cls += " new-textfield_multiline"
    }
    if(config.maxLength) {
      o.maxlength = config.maxLength
    }
    this.el = ct.createChild(o);
    this.el.on("keydown", this._onKeydown, this);
    this.el.on("keyup", this._onKeyup, this);
    this.el.on("keypress", this._onKeypress, this);
    this.el.on("click", this._onClick, this);
    this.el.on("mousemove", this._onMousemove, this);
    this.el.on("focus", this._onFocus, this);
    this.el.on("blur", this._onBlur, this);
    this.el.on("contextmenu", this._onContextMenu, this);
    this.el.on("DOMMouseScroll", this._wheel, this);
    this.el.on("mousewheel", this._wheel, this);
    this._timer = new U.DelayedTask({fn:function() {
      this._removeInlineStyles();
      this._timer.start()
    }, interval:500, scope:this});
    this._timer.start();
    this._preventSmilesEditing(this.el)
  }, _wheel:function(e) {
    e.preventDefault();
    e = e.browserEvent;
    var delta = e.wheelDelta ? e.wheelDelta / 120 : -e.detail / 3;
    this.el.dom.scrollTop += delta > 0 ? -WHEEL_STEP : WHEEL_STEP
  }, val:function(value, preventHint) {
    this._lastAnchorNode = this._lastAnchorOffset = null;
    if(value === undefined) {
      if(this.rendered) {
        return this.el.dom.innerHTML === this.hintText ? "" : this.el.dom.innerHTML
      }
      return null
    }
    if(this.rendered) {
      this.el.dom.innerHTML = value || "";
      if(preventHint !== true || this.el.dom.innerHTML !== "") {
        this._checkHintValue()
      }
    }
  }, textVal:function(value, preventHint) {
    var start = +new Date;
    if(value === undefined) {
      var ret = null;
      if(this.rendered) {
        if(this.el.dom.innerHTML === this.hintText) {
          return""
        }
        ret = this.el.dom.innerHTML;
        ret = ret.replace(/(\n|\r\n)/g, "");
        ret = ret.replace(/(?:<br[^>]*>)?\s*(?:<\/(?:div|p|h\d|td|table)[^>]*>)+/gi, "<br/>");
        ret = ret.replace(/([^>]|[^/r]>|[^b]r\/?>)<div[^>]*>/gi, "$1<br/>");
        ret = ret.replace(/<br[^>]*>/gi, "\n");
        ret = ret.replace(/<xml[^>]*>.+<\/xml>/g, "");
        ret = ret.replace(/<style[^>]*>.+<\/style>/g, "");
        ret = WA.Emoji.stripTagsExceptSmiles(ret);
        ret = ret.replace(/(\s*\n\s*)+$/g, "");
        ret = WA.Emoji.recoilProccessedMessage(ret);
        ret = U.String.entityDecode(ret);
        ret = ret.replace(/&(\w+|#\d+);?/g, function(m) {
          if(m.match(/&amp;?/)) {
            return"&"
          }
          return""
        })
      }
      return ret
    }
    if(this.rendered) {
      this.el.dom.innerText = value || "";
      if(preventHint !== true || this.el.dom.innerText != "") {
        this._checkHintValue()
      }
    }
  }, focus:function(force) {
    try {
      this.el.dom.focus()
    }catch(e) {
    }
    if(!U.Selection.isFocused(this.el.dom) || force) {
      this._setCaret()
    }
  }, _removeInlineStyles:function() {
    U.DomHelper.htmlTree(this.el.dom, function(el) {
      if(el.getAttribute("style")) {
        el.setAttribute("style", null)
      }
    })
  }, _setCaret:function() {
    var sel = U.Selection.getSelection(), range = U.Selection.createRange();
    if(this._lastAnchorNode && this._lastAnchorNode.parentNode) {
      try {
        range.setStart(this._lastAnchorNode, this._lastAnchorOffset)
      }catch(e) {
        range.setStart(this.el.dom, this.el.dom.childNodes.length)
      }
    }else {
      range.setStart(this.el.dom, this.el.dom.childNodes.length)
    }
    range.collapse(true);
    sel.removeAllRanges();
    sel.addRange(range)
  }, _saveCaretPosition:function() {
    var sel = U.Selection.getSelection();
    if(sel) {
      this._lastAnchorNode = sel.anchorNode;
      this._lastAnchorOffset = sel.anchorOffset
    }else {
      this._lastAnchorNode = this._lastAnchorOffset = null
    }
  }, _onFocus:function() {
    if(this.hintText && this.el.dom.innerHTML === this.hintText) {
      this.el.dom.innerHTML = "";
      this._setCaret()
    }
    this.el.removeClass(this.hintClass);
    this.focusEvent.fire(this)
  }, _onBlur:function() {
    var sel = U.Selection.getSelection();
    if(!sel) {
      return
    }
    this._checkHintValue();
    this.blurEvent.fire(this)
  }, _checkHintValue:function() {
    if(WA.isWebKit && U.Selection.isFocused(this.el.dom)) {
      return
    }
    var domValue = U.String.trim(this.el.dom.innerHTML.replace(/<br\/?>/gi, ""));
    if(this.hintText) {
      if(domValue === "" || domValue == this.hintText) {
        this.el.addClass(this.hintClass);
        this.el.dom.innerHTML = this.hintText
      }else {
        this.el.removeClass(this.hintClass)
      }
    }
  }, _onContextMenu:function(e) {
    this._mouseClickHandler(e)
  }, _onClick:function(e) {
    this._mouseClickHandler(e);
    this._saveCaretPosition()
  }, _mouseClickHandler:function(e) {
    var target = e.getTarget(), sel, range, caretToLeft;
    if(target.tagName.toLowerCase() == "img") {
      sel = U.Selection.getSelection();
      range = U.Selection.createRange();
      caretToLeft = target.offsetX < target.width / 2;
      if(caretToLeft) {
        if(target.previousSibling) {
          range.setStartAfter(target.previousSibling)
        }else {
          range.setStart(sel.anchorNode, 0)
        }
        this.smileBeforeNode = target
      }else {
        range.setStartAfter(target)
      }
      range.collapse(true);
      sel.removeAllRanges();
      sel.addRange(range)
    }else {
      if(!WA.isIE) {
        this.focus()
      }
    }
  }, _onMousemove:function(e) {
    var bE = e.browserEvent, target = e.getTarget(), offsetX;
    if(target.className.indexOf("nwa-smile_inline") >= 0 || target.className.indexOf("nwa-emoji_inline") >= 0) {
      if(bE.offsetX) {
        offsetX = bE.offsetX
      }else {
        if(bE.layerX) {
          offsetX = bE.layerX
        }
      }
      target.offsetX = offsetX
    }
  }, _onKeydown:function(e) {
    e.stopPropagation();
    var sel = U.Selection.getSelection();
    if(!sel) {
      return
    }
    var nodeBeforeCaret = U.Selection.getNodeBeforeCaret(), range = U.Selection.createRange(), textSmileNode;
    this.smileBeforeNode = null;
    if(sel.isCollapsed && nodeBeforeCaret && nodeBeforeCaret.nodeType === ELEMENT_NODE && e.keyCode === KEY_CODES.BACKSPACE) {
      if(this._isSmile(nodeBeforeCaret)) {
        if(nodeBeforeCaret.getAttribute("data-immutable")) {
          nodeBeforeCaret.parentNode.removeChild(nodeBeforeCaret)
        }else {
          textSmileNode = this._deleteSmile(this.el.dom, nodeBeforeCaret);
          range.setStartAfter(textSmileNode);
          range.collapse(true);
          sel.removeAllRanges();
          sel.addRange(range);
          this._justDeletedSmile = true
        }
        e.stopEvent()
      }
    }
  }, _checkScroll:function(e) {
    var dom = this.el.dom, height = dom.clientHeight, maxScrollTop = dom.scrollHeight - height;
    if(e.keyCode == KEY_CODES.ARR_UP && dom.scrollTop < 12 && dom.scrollTop != 0) {
      dom.scrollTop = 0
    }else {
      if(maxScrollTop - dom.scrollTop < 12 && dom.scrollTop != maxScrollTop) {
        dom.scrollTop = maxScrollTop
      }
    }
  }, _onKeypress:function(e) {
    e.stopPropagation();
    var bE = e.browserEvent, charCode = bE.keyCode ? bE.keyCode : bE.which, symbol = U.String.trim(String.fromCharCode(charCode)), shouldCheck = true, arrowsCodes = [KEY_CODES.ARR_LEFT, KEY_CODES.ARR_RIGHT];
    this._changed = true;
    if(U.Array.indexOf(arrowsCodes, charCode) > 0) {
      shouldCheck = false
    }
    if(!(symbol && true)) {
      shouldCheck = false
    }
    this._shouldCheckForSmiles = shouldCheck
  }, _onKeyup:function(e) {
    e.stopPropagation();
    this._saveCaretPosition();
    var sel = U.Selection.getSelection();
    if(!sel) {
      return
    }
    var range = U.Selection.createRange(), textNode = sel.anchorNode, textBeforeCaret, smileTextCodeMatch, smileTextCodeLength, smileNode, smileCode, value;
    this._replaceImgTags(this.el.dom);
    this._replaceLinkTags(this.el.dom);
    if(textNode && textNode.data) {
      textBeforeCaret = textNode.data.substr(0, sel.anchorOffset)
    }
    if(textNode && textNode.data && !LINK_START_RE.test(textNode.data) && (smileTextCodeMatch = WA.Emoji.smileCodeLastRE.exec(textBeforeCaret))) {
      value = textNode.data.substr(0, sel.anchorOffset).replace(WA.Emoji.smileCodeLastRE, function(ignored, code) {
        smileCode = code;
        return WA.Emoji.shortcutToChar(code)
      });
      value = WA.DialogsAgent.buildPlainHtmlMessage(value);
      smileTextCodeLength = smileTextCodeMatch.shift().length;
      smileNode = U.DomHelper.elementFromHtml(value);
      if(smileCode && smileNode.tagName.toLowerCase() == "img") {
        smileNode.setAttribute("data-origin", smileCode)
      }
      WA.Emoji.insertSmile(smileNode);
      textNode.data = textNode.data.substr(0, textNode.data.length - smileTextCodeLength)
    }
    this._shouldCheckForSmiles = false;
    if(WA.isIE) {
      this.checkScroll()
    }
  }, _getSmileText:function(dom) {
    var code = dom.getAttribute("data-origin");
    return code
  }, _deleteSmile:function(dom, smileNode) {
    var text = this._getSmileText(smileNode), textSmileNode = document.createTextNode(text), parent = smileNode.parentNode;
    parent.replaceChild(textSmileNode, smileNode);
    return textSmileNode
  }, _isSmile:function(dom) {
    return dom.className.indexOf("nwa-smile_inline") > -1 || dom.className.indexOf("nwa-emoji_inline") > -1
  }, checkScroll:function() {
    var sel = WA.util.Selection.getSelection(), range = sel.getRangeAt(0), dummyNode = document.createElement("span"), domEl = this.getEl().dom, isCaretVisible;
    WA.apply(dummyNode.style, {"height":"0", "width":"0"});
    range.insertNode(dummyNode);
    dummyOffsetTop = dummyNode.offsetTop;
    dummyNode.parentNode.removeChild(dummyNode);
    isCaretVisible = domEl.clientHeight + domEl.scrollTop >= dummyOffsetTop + 15;
    if(!isCaretVisible) {
      domEl.scrollTop = dummyOffsetTop
    }
  }, _replaceLinkTags:function(dom) {
    var links = dom.getElementsByTagName("a");
    if(links.length) {
      for(var i = 0;i < links.length;i++) {
        var link = links[i];
        var linkTextNode = document.createTextNode(link.href);
        link.parentNode.replaceChild(linkTextNode, link)
      }
    }
  }, _replaceImgTags:function(dom) {
    var nodes = dom.getElementsByTagName("img");
    for(var i = 0;i < nodes.length;i++) {
      var node = nodes.item(i);
      if(node.className.indexOf("nwa-emoji_inline") > -1) {
        continue
      }
      var textNode = document.createTextNode(" " + node.src);
      node.parentNode.replaceChild(textNode, node);
      i--
    }
  }, _stopEventHandler:function(e) {
    e.stopEvent()
  }, _preventSmilesEditing:function(el) {
    el.on("resizestart", this._stopEventHandler);
    el.on("drop", this._stopEventHandler);
    el.on("dragover", this._stopEventHandler);
    el.on("dragstart", this._stopEventHandler);
    if(!WA.isIE && document.execCommand) {
      try {
        document.execCommand("enableObjectResizing", false, false)
      }catch(e) {
      }
    }
  }})
})();
WebAgent.namespace("WebAgent.ui");
(function() {
  var WA = WebAgent;
  var UI = WA.ui;
  UI.Layer = WA.extend(UI.Component, {constructor:function(cfg) {
    cfg = cfg || {};
    UI.Layer.superclass.constructor.apply(this, arguments);
    this.initialConfig.hideOnEscape = cfg.hideOnEscape !== false
  }, autoEl:{tag:"div", style:"display: none"}, _onShow:function() {
    UI.Layer.superclass._onShow.call(this);
    if(this.initialConfig.autoHide !== false) {
      WA.getBody().on("mousedown", this._onClick, this)
    }
  }, _onHide:function() {
    UI.Layer.superclass._onHide.call(this);
    if(this.initialConfig.autoHide !== false) {
      WA.getBody().un("mousedown", this._onClick, this)
    }
  }, _onAncestorClick:function(el, isSelf, e) {
  }, _onClick:function(e) {
    if(!this.isVisible() || e.button !== 0) {
      return
    }
    var isAncestor = false;
    var isSelf = false;
    var target = e.getTarget(true);
    if(target) {
      isSelf = this.el.equals(target);
      isAncestor = isSelf || this.el.contains(target)
    }
    if(isAncestor) {
      this._onAncestorClick(target, isSelf, e);
      if(this.initialConfig.hideOnClick) {
        this.hide()
      }
    }else {
      if(this.initialConfig.hideOnEscape) {
        this.hide()
      }
    }
  }, destroy:function() {
    if(this.initialConfig.autoHide !== false) {
      WA.getBody().un("mousedown", this._onClick, this)
    }
    UI.Layer.superclass.destroy.call(this)
  }})
})();
WebAgent.namespace("WebAgent.ui.menu");
(function() {
  var WA = WebAgent;
  var UI = WA.ui;
  var M = UI.menu;
  var Layer = WA.extend(UI.Layer, {constructor:function(menu, config) {
    this.menu = menu;
    this.controlEl = config.controlEl || [];
    if(this.controlEl && this.controlEl.length == null) {
      this.controlEl = [this.controlEl]
    }
    Layer.superclass.constructor.call(this, config)
  }, _onAncestorClick:function(el, isSelf, e) {
    if(!isSelf) {
      var c = el;
      var index = null;
      while(c && !c.equals(this.menu.el)) {
        index = parseInt(c.getAttribute("menu_index"));
        if(WA.isNumber(index)) {
          this.menu.itemClickEvent.fire(this, this.menu.items[index], e);
          break
        }else {
          c = c.parent()
        }
      }
    }
  }, _onClick:function(e) {
    if(this.initialConfig.autoHide === false) {
      return true
    }
    var target = e.getTarget(true);
    for(var i = 0, len = this.controlEl.length;i < len;i++) {
      if(this.controlEl[i].contains(target)) {
        return false
      }
    }
    Layer.superclass._onClick.call(this, e)
  }});
  var Menu = M.Menu = WA.extend(UI.Container, {initComponent:function() {
    Menu.superclass.initComponent.call(this);
    this.controlEl = this.initialConfig.controlEl || null;
    this.itemClickEvent = new WA.util.Event
  }, _onRender:function(container) {
    this.layer = new Layer(this, {hideOnClick:this.initialConfig.hideOnClick !== false, hideOnEscape:this.initialConfig.hideOnEscape !== false, fadeIn:this.initialConfig.fadeIn === true, controlEl:this.controlEl, autoHide:this.initialConfig.autoHide !== false});
    this.layer.hideEvent.on(function() {
      this.hideEvent.fire()
    }, this);
    this.layer.render(container);
    this.el = this.layer.el.createChild({cls:"nwa-menu"});
    if(this.initialConfig.useScroll) {
      this.scrollBar = new UI.ScrollBar({source:this.el, autoRender:this.layer.el})
    }
  }, _lookupItemComponent:function(cmp) {
    if(cmp === "-") {
      return new M.Separator(this, cmp)
    }else {
      if(cmp instanceof M.Item) {
        return cmp
      }else {
        var defaultType = this.defaultType || M.Button;
        return this._lookupComponent(cmp, defaultType)
      }
    }
  }, _renderItem:function(container, item, index) {
    var ct = this._getItemRenderContainer();
    Menu.superclass._renderItem.call(this, ct, item, index);
    item.el.setAttribute("menu_index", index)
  }, _getItemRenderContainer:function() {
    return this.el
  }, isVisible:function() {
    return this.rendered && this.layer.isVisible()
  }, setControlElement:function(el) {
    this.controlEl = el
  }, _onShow:function(me) {
    Menu.superclass._onShow.call(this, me);
    this.layer.show();
    if(this.scrollBar) {
      this.scrollBar.sync()
    }
    if(WA.isIE) {
      this._reflowItems()
    }
  }, _reflowItems:function() {
    WA.util.Array.each(this.items, function(item, index) {
      if(item.reflow) {
        item.reflow()
      }
    }, this)
  }, _onHide:function(me) {
    Menu.superclass._onHide.call(this, me);
    this.layer.hide()
  }, destroy:function() {
    this.itemClickEvent.removeAll();
    this.itemClickEvent = null;
    if(this.scrollBar) {
      this.scrollBar.destroy()
    }
    this.layer.destroy();
    this.layer = null;
    Menu.superclass.destroy.call(this)
  }});
  M.Item = WA.extend(Object, {constructor:function(config) {
    this.initialConfig = config
  }, render:function(container) {
    this._onRender(container);
    this.el.addClass("nwa-menu-item")
  }, _onRender:function(container) {
    WA.abstractError()
  }, destroy:function() {
    this.initialConfig = null;
    if(this.el) {
      this.el.remove();
      this.el = null
    }
  }});
  M.Separator = WA.extend(M.Item, {_onRender:function(container) {
    this.el = container.createChild({cls:"nwa-menu-separator"})
  }});
  M.Button = WA.extend(M.Item, {constructor:function(config) {
    var cfg = WA.applyIf({clickEvent:"mousedown", disabledCls:"nwa-button-item_disabled"}, config);
    this.button = new UI.LinkButton(cfg);
    M.Button.superclass.constructor.call(this, cfg)
  }, _onRender:function(container) {
    this.el = container.createChild({cls:"nwa-menu-button"});
    this.button.render(this.el)
  }, reflow:function(container) {
    if(this.button) {
      this.button.destroy();
      this.button = new UI.LinkButton(this.initialConfig);
      this.button.render(this.el)
    }
  }, destroy:function() {
    this.button.destroy();
    this.button = null;
    M.Button.superclass.destroy.call(this)
  }});
  M.Image = WA.extend(M.Item, {_onRender:function(container) {
    var config = this.initialConfig;
    var o = {tag:"div", title:config.title || ""};
    if(config.path) {
      o.style = "background-image: url(" + config.path + ")"
    }
    if(config.cls) {
      o.cls = config.cls
    }
    this.el = container.createChild(o);
    if(config.text) {
      this.el.update(config.text)
    }
  }});
  M.IMG = WA.extend(M.Item, {_onRender:function(container) {
    var config = this.initialConfig;
    var o = {tag:"img", title:config.title};
    if(config.path) {
      o.src = config.path
    }
    if(config.cls) {
      o.cls = config.cls
    }
    this.el = container.createChild(o)
  }})
})();
WebAgent.namespace("WebAgent.ui.menu");
(function() {
  var WA = WebAgent;
  var M = WA.ui.menu;
  M.ImageMenu = WA.extend(M.Menu, {defaultType:M.Image, _onAfterRender:function() {
    M.ImageMenu.superclass._onAfterRender.call(this);
    this.el.addClass("nwa-image-menu");
    var ct = this._getItemRenderContainer();
    ct.createChild({cls:"nwa-clear-both"})
  }})
})();
WebAgent.namespace("WebAgent.ui");
(function() {
  var WA = WebAgent;
  var UI = WA.ui;
  UI.Toolbar = WA.extend(UI.Container, {defaultType:UI.Button, _onRender:function(ct) {
    this.el = ct.createChild({cls:"wa-toolbar", tag:"table", cellspacing:0, children:[{tag:"tr", id:this.getId() + "-row"}]});
    this.rowEl = WA.get(this.getId() + "-row")
  }, _lookupItemComponent:function(cmp) {
    if(WA.isString(cmp)) {
      return cmp
    }else {
      return UI.Toolbar.superclass._lookupItemComponent.call(this, cmp)
    }
  }, _renderItem:function(container, item, index) {
    var cls = ["wa-toolbar-item"];
    if(index === 0) {
      cls.push("wa-toolbar-item-first")
    }else {
      if(index === this.items.length - 1) {
        cls.push("wa-toolbar-item-last")
      }
    }
    var ct = this.rowEl.createChild({tag:"td", cls:cls.join(" ")});
    if(item === "->") {
      ct.addClass("wa-toolbar-spacer")
    }else {
      UI.Toolbar.superclass._renderItem.call(this, ct, item, index)
    }
  }, _destroyItem:function(item) {
    if(item.isComponent) {
      item.container.remove();
      UI.Toolbar.superclass._destroyItem.call(this, item)
    }
  }})
})();
WebAgent.namespace("WebAgent.ui");
(function() {
  var WA = WebAgent;
  var U = WA.util;
  var UI = WA.ui;
  var SIGNAL_MESSAGE = "message";
  var SIGNAL_CALL_IN = "callIn";
  var SIGNAL_CALL_OUT = "callOut";
  var SOUND_FOLDER = WA.imgPath + "images/";
  UI.Beep = WA.extend(UI.Component, {initComponent:function() {
    UI.Beep.superclass.initComponent.call(this);
    this.useSwf = !window.Audio;
    this.mp3Url = SOUND_FOLDER + "message2.mp3?1";
    this.oggUrl = SOUND_FOLDER + "message.ogg?1";
    this.swfUrl = SOUND_FOLDER + "message.swf?1";
    this.swfMethod = "beep"
  }, _onRender:function(ct) {
    if(this.useSwf) {
      this._renderSwf(ct)
    }else {
      this._renderAudio(ct)
    }
  }, _renderAudio:function(ct) {
    this.el = ct.createChild({style:"position:absolute; left: -10000px", children:[{tag:"audio", preload:"auto", autobuffer:"true", children:[{tag:"source", src:this.mp3Url, type:"audio/mp3"}, {tag:"source", src:this.oggUrl, type:"audio/ogg"}]}]});
    this._audio = this.el.first()
  }, _renderSwf:function(ct) {
    var id = "waFlash_" + this.swfMethod;
    this.el = ct.createChild({id:id});
    WA.util.swf.embedSWF(this.swfUrl, id, "1", "1", "7", false, false, {name:id, allowScriptAccess:"always"}, {allowScriptAccess:"always"}, null);
    WA.setTimeout(function() {
      this._obj = WA.get(id)
    }, 1, this)
  }, play:function() {
    if(this.rendered) {
      var method = this.useSwf ? this._playSwf : this._playAudio;
      WA.setTimeout(method, 1, this)
    }
  }, _playSwf:function() {
    if(!U.Object.checkChain(this, ["_obj", "dom", this.swfMethod])) {
      this._obj = WA.get("waFlash_" + this.swfMethod)
    }
    if(U.Object.checkChain(this, ["_obj", "dom", this.swfMethod])) {
      try {
        if(this._obj) {
          this._obj.dom[this.swfMethod]()
        }
      }catch(e) {
      }
    }
  }, _playAudio:function() {
    if(this._audio && this._audio.dom.play) {
      this._audio.dom.play()
    }
  }});
  UI.BeepCallIn = WA.extend(UI.Beep, {initComponent:function() {
    UI.BeepCallIn.superclass.initComponent.call(this);
    this.mp3Url = SOUND_FOLDER + "call_in.mp3";
    this.oggUrl = SOUND_FOLDER + "call_in.ogg";
    this.swfUrl = SOUND_FOLDER + "call_in.swf";
    this.swfMethod = "call_in"
  }});
  UI.BeepCallOut = WA.extend(UI.Beep, {initComponent:function() {
    UI.BeepCallOut.superclass.initComponent.call(this);
    this.mp3Url = SOUND_FOLDER + "call_waiting.mp3";
    this.oggUrl = SOUND_FOLDER + "call_waiting.ogg";
    this.swfUrl = SOUND_FOLDER + "call_waiting.swf";
    this.swfMethod = "call_waiting"
  }});
  var Beep = WA.extend(Object, {constructor:function() {
    this.on = true;
    this[SIGNAL_MESSAGE] = new UI.Beep;
    this[SIGNAL_CALL_IN] = new UI.BeepCallIn;
    this[SIGNAL_CALL_OUT] = new UI.BeepCallOut
  }, render:function(ct) {
    this[SIGNAL_MESSAGE].render(ct);
    this[SIGNAL_CALL_IN].render(ct);
    this[SIGNAL_CALL_OUT].render(ct)
  }, unmute:function(val) {
    this.on = val
  }, play:function(signal) {
    signal = signal || SIGNAL_MESSAGE;
    if(this.on && this[signal]) {
      this[signal].play()
    }
  }});
  WA.Beep = new Beep
})();
WebAgent.namespace("WebAgent.ui");
(function() {
  var WA = WebAgent;
  var UI = WA.ui;
  var U = WA.util;
  UI.Collection = WA.extend(UI.Component, {initComponent:function() {
    this.children = this.initialConfig
  }, append:function(name, component) {
    this.children[name] = component
  }, _onRender:function(ct) {
    this.el = ct;
    U.Object.each(this.children, function(component) {
      component.render(ct)
    }, this)
  }, each:function(fn, scope) {
    U.Object.each(this.children, fn, scope)
  }})
})();
WebAgent.namespace("WebAgent.ui");
(function() {
  var WA = WebAgent;
  var UI = WA.ui;
  UI.Label = WA.extend(UI.Component, {initComponent:function() {
    this.title = this.initialConfig.title;
    this.child = this.initialConfig.child
  }, _onRender:function(ct) {
    this.el = ct.createChild({cls:"nwa-twocol__row" + (this.initialConfig.cls ? " " + this.initialConfig.cls : ""), children:this.title ? [{cls:"nwa-twocol__label", children:this.title}, {cls:"nwa-twocol__value"}] : ""});
    this.child.render(this.el.last() || this.el)
  }})
})();
WebAgent.namespace("WebAgent.ui");
(function() {
  var WA = WebAgent;
  var U = WA.util;
  var UI = WA.ui;
  UI.Select = WA.extend(UI.Component, {initComponent:function() {
    this.options = this.initialConfig.options || [];
    this.changeEvent = new U.Event
  }, _onRender:function(ct) {
    this.el = ct.createChild({tag:"select"});
    this._renderOptions();
    this.setValue(this.initialConfig.defaultValue || "-1");
    if(this.initialConfig.attributes) {
      U.Object.each(this.initialConfig.attributes, function(value, key) {
        this.el.setAttribute(key, value)
      }, this)
    }
  }, _onChangeEvent:function() {
    var value = this.getValue();
    if(this._value != value) {
      this._value = value;
      this.changeEvent.fire(value)
    }
  }, __renderList:function(list) {
    var html = [];
    if(list.length && WA.isIE) {
      html.push(U.String.format('<option value="{1}" style="display:none">{0}</option>', list[0][0], list[0][1]))
    }
    U.Array.each(list, function(option) {
      html.push(U.String.format('<option value="{1}">{0}</option>', option[0], option[1]))
    }, this);
    return html
  }, _renderOptions:function() {
    var html = this.__renderList(this.options);
    this.el.update(html.join(""));
    this.el.un("change", this._onChangeEvent, this);
    var parent = this.el.parent();
    html = parent.dom.innerHTML;
    this.el.remove();
    this.el = parent.createChild(html);
    this.el.on("change", this._onChangeEvent, this)
  }, update:function(list) {
    this.options = list;
    this._renderOptions()
  }, setValue:function(value) {
    if(this.getValue != value) {
      this.el.dom.value = value;
      this._value = value;
      return true
    }
    return false
  }, getValue:function() {
    return this.el.dom.value
  }, val:function() {
    return this.getValue()
  }, getTitle:function() {
    return(this.el.dom[this.el.dom.selectedIndex] || {innerHTML:""}).innerHTML
  }, disable:function() {
    this.el.update("").dom.disabled = true
  }, enable:function() {
    this.el.dom.disabled = false
  }})
})();
WebAgent.namespace("WebAgent.ui");
(function() {
  var WA = WebAgent, UI = WA.ui, MIN_SLIDER_SIZE = 30, WHEEL_STEP = 40;
  UI.ScrollBar = WA.extend(UI.Component, {initComponent:function() {
    UI.ScrollBar.superclass.initComponent.call(this);
    this.sourceEl = this.initialConfig.source || null;
    this.sliderSize = 0;
    this.sliderStart = 0;
    this.contentSpace = 0;
    this.mouseStart = 0;
    this.trackSize = 0;
    this.sliderSpace = 0;
    this.rate = 1;
    this.deferredUpdate = false;
    this._syncTimer = null
  }, render:function(ct) {
    if(!UI.ScrollBar.hasNativeSupport()) {
      this.sourceEl = null;
      return
    }
    UI.ScrollBar.superclass.render.call(this, ct)
  }, _onRender:function(ct) {
    var config = this.initialConfig;
    this.container = ct;
    this.sourceEl = this.sourceEl || ct;
    this.sourceEl.addClass("nwa-scrollbar__source");
    this.el = ct.createChild({tag:"div", style:"display:none", cls:"nwa-scrollbar", children:[{tag:"div", cls:"nwa-scrollbar__view", children:{tag:"div", cls:"nwa-scrollbar__slider", children:{tag:"div", cls:"nwa-scrollbar__slider-view"}}}]}, true);
    this.track = this.el.first();
    this.slider = this.track.first();
    this._initEvents()
  }, _initEvents:function() {
    this.slider.on("mousedown", this._start, this);
    this.track.on("mousedown", this._drag, this);
    this.container.on("DOMMouseScroll", this._wheel, this);
    this.container.on("mousewheel", this._wheel, this);
    if(this.initialConfig.watchResize) {
      WA.fly(window).on("afterresize", this.sync, this)
    }
  }, _start:function(e) {
    if(e) {
      e.preventDefault();
      this.mouseStart = e.pageY
    }
    this.dragging = true;
    this.el.addClass("nwa-scrollbar_captured");
    this.sliderStart = parseInt(this.slider.dom.style.top);
    WA.getDoc().on("mousemove", this._drag, this);
    WA.getDoc().on("mouseup", this._end, this);
    this.slider.on("mouseup", this._end, this);
    return false
  }, _drag:function(e) {
    if(e.type == "mousedown") {
      if(this.dragging) {
        return false
      }
      this.sliderStart = -Math.floor(this.sliderSize / 2);
      this.mouseStart = this.track.offset()["top"]
    }else {
      e.preventDefault()
    }
    if(this.rate < 1) {
      var sliderTop = Math.min(this.sliderSpace, Math.max(0, this.sliderStart + e.pageY - this.mouseStart));
      this._scrollContent(sliderTop * this.scrollRatio);
      this._moveSlider(sliderTop)
    }
    return false
  }, _end:function(e) {
    WA.getDoc().un("mousemove", this._drag, this);
    WA.getDoc().un("mouseup", this._end, this);
    this.slider.un("mouseup", this._end, this);
    this.el.removeClass("nwa-scrollbar_captured");
    this.dragging = false;
    if(this.deferredUpdate) {
      this._onSourceUpdate()
    }
    return false
  }, _wheel:function(e) {
    if(this.rate >= 1) {
      return false
    }
    e.preventDefault();
    e = e.browserEvent;
    var delta = e.wheelDelta ? e.wheelDelta / 120 : -e.detail / 3;
    var deltaScroll = Math.min(this.contentSpace, Math.max(0, this.sourceEl.dom.scrollTop - delta * WHEEL_STEP));
    this._scrollContent(deltaScroll);
    this._onSourceUpdate()
  }, pauseDrag:function() {
    if(this.dragging) {
      this._paused = {mouseStart:this.mouseStart + parseInt(this.slider.dom.style.top) - this.sliderStart};
      this._end()
    }
  }, resumeDrag:function() {
    if(this._paused) {
      this.mouseStart = this._paused.mouseStart;
      this._paused = false;
      this._start()
    }
  }, sync:function() {
    this._syncTimer = WA.setTimeout(this._sync, 10, this)
  }, _sync:function() {
    if(this.dragging) {
      this.deferredUpdate = true;
      return
    }
    this._onSourceUpdate()
  }, setSource:function(sourceEl) {
    if(this.sourceEl) {
      this.sourceEl.removeClass("nwa-scrollbar__source")
    }
    this.sourceEl = sourceEl;
    this.sourceEl.addClass("nwa-scrollbar__source");
    this._onSourceUpdate()
  }, _onSourceUpdate:function() {
    this.deferredUpdate = false;
    if(!this.sourceEl) {
      this.hide();
      return
    }
    var contentView = this.sourceEl.dom.offsetHeight, contentSize = this.sourceEl.dom.scrollHeight;
    this.rate = contentView / contentSize;
    if(this.rate >= 1) {
      this.hide();
      return
    }
    this.show();
    this.trackSize = this.track.dom.clientHeight;
    if(this.trackSize < MIN_SLIDER_SIZE) {
      this.hide();
      return
    }
    this.sliderSize = Math.max(MIN_SLIDER_SIZE, Math.floor(this.trackSize * this.rate));
    this.sliderSpace = this.trackSize - this.sliderSize;
    this.contentSpace = contentSize - contentView;
    this.scrollRatio = this.contentSpace / this.sliderSpace;
    var sliderTop = Math.min(Math.floor(this.sourceEl.dom.scrollTop * this.sliderSpace / this.contentSpace), this.sliderSpace);
    this.slider.setHeight(this.sliderSize);
    this._moveSlider(sliderTop)
  }, _moveSlider:function(delta) {
    this.slider.setStyle("top", delta + "px")
  }, _scrollContent:function(delta) {
    this.sourceEl.dom.scrollTop = delta
  }, destroy:function() {
    if(this._syncTimer) {
      clearTimeout(this._syncTimer)
    }
    WA.fly(window).un("afterresize", this.sync, this);
    this.sourceEl = null;
    UI.ScrollBar.superclass.destroy.call(this)
  }});
  UI.ScrollBar.hasNativeSupport = function() {
    return!!("getBoundingClientRect" in document.documentElement)
  }
})();
WebAgent.namespace("WebAgent.ui");
(function() {
  var WA = WebAgent;
  var UI = WA.ui;
  var U = WA.util;
  var ITEM_TMPL = '<div class="nwa-acompl-item" wa-index="{index}" id="{id}{index}">{title}<div class="nwa-acompl-item-fadeout"></div></div>';
  var List = WA.extend(UI.Layer, {initComponent:function() {
    this.autoEl = false;
    this._index = -1;
    this.selectEvent = new U.Event;
    this.uniqueId = "nwaAcomplItem" + ("" + Math.random()).substr(2);
    this._list = []
  }, _onRender:function(ct) {
    this.el = ct.createChild({cls:"nwa-autocompl-list"})
  }, _onAfterRender:function() {
    List.superclass._onAfterRender.apply(this, arguments);
    this.el.on("mouseup", this._onMouseUp, this).on("mousemove", this._onMouseMove, this)
  }, _onMouseUp:function(ev) {
    var index = ev.getTarget(false).getAttribute("wa-index");
    this.selectEvent.fire(index)
  }, _onMouseMove:function(ev) {
    var index = ev.getTarget(false).getAttribute("wa-index");
    if(index !== null) {
      this.sel(index)
    }
  }, sel:function(index) {
    if(index === undefined) {
      if(!this._list || !this._list.length || this._index == -1) {
        return-1
      }else {
        return this._index % this._list.length
      }
    }else {
      if(this._list && this._list.length && this._index != index) {
        this._toggleHilight(this._index, false);
        this._toggleHilight(index, true);
        this._index = index
      }
    }
  }, selDown:function() {
    this.sel(this.sel() + 1)
  }, selUp:function() {
    var index = this.sel() - 1;
    if(index < 0) {
      index = this._list.length - 1
    }
    this.sel(index)
  }, _onShow:function() {
    this.sel(0)
  }, _toggleHilight:function(index, action) {
    if(index != -1 && this._list && this._list.length) {
      if(index > 0) {
        index = index % this._list.length
      }
      var el = WA.get(this.uniqueId + index);
      if(action === true) {
        el.addClass("nwa-acompl-hilight")
      }else {
        if(action === false) {
          el.removeClass("nwa-acompl-hilight")
        }
      }
    }
  }, update:function(list) {
    this._list = list;
    this._index = -1;
    var html = [];
    U.Array.each(list, function(item, index) {
      html.push(U.String.parseTemplate(ITEM_TMPL, {index:index, title:U.String.htmlEntity(item), id:this.uniqueId}))
    }, this);
    this.el.update(html.join(""))
  }, destroy:function() {
    this.selectEvent.removeAll();
    this.selectEvent = null;
    this.onKeyDownEvent.removeAll();
    this.onKeyDownEvent = null;
    List.superclass.destroy.call(this)
  }});
  UI.Autocomplete = WA.extend(UI.TextField, {initComponent:function() {
    UI.Autocomplete.superclass.initComponent.call(this);
    this.selectedEvent = new U.Event;
    this.changeEvent = new U.Event;
    this._list = new List;
    this._list.selectEvent.on(this._onListItemSelect, this);
    this._items = this.initialConfig.items || [];
    this._checkChangeTask = new U.DelayedTask({interval:250, fn:this._checkChange, scope:this})
  }, search:function(value, mail, noAutoSelect, preventDropDown) {
    var res = [], list = [];
    var numberValue = (value || "").replace(/[\(\) \[\]+-]+/g, "");
    if(!numberValue || numberValue.match(/\D/)) {
      numberValue = false
    }
    if(value) {
      value = value.toLowerCase()
    }
    if(mail) {
      this._mail = mail
    }
    var alterValue = WA.util.KeyMapping.translate(value);
    U.Array.each(this._items, function(item) {
      var search = item.search;
      if(!mail && (search.indexOf(value) != -1 || numberValue && search.indexOf(numberValue) != -1 || search.indexOf(alterValue) != -1) || mail && item.mail === mail) {
        list.push(item.title);
        res.push(item);
        if(this.initialConfig.listMaxLen && res.length >= this.initialConfig.listMaxLen) {
          return false
        }
      }
    }, this);
    this._searchResult = res;
    this._list.hide();
    if(preventDropDown && res.length) {
      this._onListItemSelect(0)
    }else {
      if(preventDropDown && value) {
        this.val(value)
      }else {
        if(res.length > 1 || noAutoSelect && res.length == 1) {
          this._list.update(list);
          this._list.show()
        }else {
          if(!preventDropDown && res.length == 0) {
            this._list.update([])
          }else {
            if(res.length) {
              this._onListItemSelect(0)
            }
          }
        }
      }
    }
  }, toggleArrow:function(show) {
    if(this.arrow) {
      this.rootEl.toggleClass("nwa-acompl_expandable", show)
    }
  }, getSelectionInfo:function() {
    var item = null;
    if(this._index != -1) {
      item = this._searchResult[this._index]
    }
    return{item:item, value:this.val()}
  }, _checkChange:function() {
    var val = this.val();
    if(this._val != val) {
      this._val = val;
      this.changeEvent.fire(val);
      this.search(val, false, true)
    }
    this._checkChangeTask.start()
  }, _onRender:function(ct) {
    var config = this.initialConfig;
    var textfield = {tag:"input", type:"text", cls:"nwa-textfield"};
    if(config.maxLength) {
      textfield.maxlength = config.maxLength
    }
    this.rootEl = ct.createChild({cls:"nwa-acompl", children:[textfield]});
    if(config.arrow) {
      this.arrow = this.rootEl.createChild({tag:"button", title:WA.tr("sms.userPhones"), cls:"nwa-button nwa-acompl__arrow"})
    }
    this.el = this.rootEl.first();
    this._list.render(this.rootEl)
  }, _onAfterRender:function() {
    UI.Autocomplete.superclass._onAfterRender.apply(this, arguments);
    this._val = this.val();
    this._checkChangeTask.start();
    this.el.on("keydown", this._onKeyDown, this);
    if(this.arrow) {
      this.arrow.on("click", this._onMouseClick, this)
    }
    this._list.show();
    this._list.hide()
  }, _onListItemSelect:function(index) {
    this._list.show();
    this._list.hide();
    this._index = index;
    if(index != -1) {
      var value = this._val = this._searchResult[this._index].tel;
      this.val(value);
      this.changeEvent.fire()
    }
    this.selectedEvent.fire();
    this.close()
  }, _onMouseClick:function(e) {
    if(!this._mail) {
      return
    }
    if(this._list.isVisible()) {
      this._list.hide()
    }else {
      this.search(false, this._mail, true);
      this._list.show()
    }
    e.stopPropagation()
  }, _onKeyDown:function(ev) {
    switch(ev.keyCode) {
      case 27:
        this._list.hide();
        break;
      case 40:
        if(!this._list.isVisible()) {
          this._list.show()
        }else {
          this._list.selDown()
        }
        break;
      case 38:
        if(!this._list.isVisible()) {
          this._list.show()
        }else {
          this._list.selUp()
        }
        break;
      case 13:
        var sel = this._list.sel();
        if(!this._list.isVisible() && sel != -1) {
          this._list.show()
        }else {
          this._onListItemSelect(sel)
        }
        break;
      case 9:
        this._onListItemSelect(-1);
        break;
      default:
        return
    }
    ev.stopEvent()
  }, updateList:function(list) {
    this._items = list;
    this.close()
  }, close:function() {
    this._list.show();
    this._list.hide()
  }, destroy:function() {
    this.changeEvent.removeAll();
    this.changeEvent = null;
    this._list.destroy();
    this._checkChangeTask.stop();
    UI.Autocomplete.superclass.destroy.call(this)
  }})
})();
WebAgent.namespace("WebAgent.ui");
(function() {
  var WA = WebAgent, UI = WA.ui, U = WA.util, WHEEL_STEP = 5;
  UI.Slider = WA.extend(UI.Component, {initComponent:function() {
    UI.Slider.superclass.initComponent.call(this);
    this.barCls = this.initialConfig.barCls || "";
    this.minVal = this.initialConfig.minVal || 0;
    this.maxVal = this.initialConfig.maxVal || 100;
    this.stepVal = this.initialConfig.stepVal || 1;
    this.initVal = this.initialConfig.initVal || 50;
    this.sliderSize = 0;
    this.sliderStart = 0;
    this.mouseStart = 0;
    this.trackSize = 0;
    this.ratio = 1;
    this._lastVal = this.initVal;
    this._initialized = false;
    this._hideTimeout = 0;
    this._showTimeout = 0;
    this.initialConfig.fadeIn = true;
    this.changeEvent = new U.Event
  }, _onRender:function(ct) {
    this.container = ct;
    this.el = ct.createChild({cls:"nwa-slider", style:"display:none;", children:[{tag:"div", cls:"nwa-slider__view", children:{tag:"div", cls:"nwa-slider__bar", children:{tag:"div", cls:"nwa-slider__bar-view"}}}]});
    this.track = this.el.first();
    this.bar = this.track.first();
    this._initEvents()
  }, _initEvents:function() {
    this.bar.on("mousedown", this._start, this);
    this.track.on("mousedown", this._drag, this);
    this.container.on("DOMMouseScroll", this._wheel, this);
    this.container.on("mousewheel", this._wheel, this)
  }, _onShow:function() {
    if(this._initialized) {
      return
    }
    this._initialized = true;
    this.trackSize = this.track.dom.clientHeight;
    this.sliderSize = this.bar.dom.clientHeight;
    this.sliderSpace = this.trackSize - this.sliderSize;
    this.bar.setHeight(this.sliderSize);
    this.ratio = (this.maxVal - this.minVal) / this.sliderSpace;
    this._moveSlider(this.sliderSpace - Math.floor(this.initVal / this.ratio))
  }, _start:function(e) {
    e.preventDefault();
    this.dragging = true;
    this.el.addClass("nwa-slider_captured");
    this.mouseStart = e.pageY;
    this.sliderStart = parseInt(this.bar.dom.style.top);
    WA.getDoc().on("mousemove", this._drag, this);
    WA.getDoc().on("mouseup", this._end, this);
    this.bar.on("mouseup", this._end, this);
    return false
  }, _drag:function(e) {
    if(e.type == "mousedown") {
      if(this.dragging) {
        return false
      }
      this.sliderStart = -Math.floor(this.sliderSize / 2);
      this.mouseStart = this.track.offset()["top"]
    }else {
      e.preventDefault()
    }
    var sliderTop = Math.min(this.sliderSpace, Math.max(0, this.sliderStart + e.pageY - this.mouseStart));
    this._moveSlider(sliderTop);
    this._checkChange(sliderTop);
    return false
  }, _checkChange:function(sliderTop) {
    sliderTop = this.sliderSpace - sliderTop;
    var val = Math.round(this.minVal + this.ratio * sliderTop);
    if(this.stepVal > 1) {
      val = Math.round(val / this.stepVal) * this.stepVal
    }
    if(val != this._lastVal) {
      this.changeEvent.fire(val);
      this._lastVal = val
    }
  }, _end:function(e) {
    WA.getDoc().un("mousemove", this._drag, this);
    WA.getDoc().un("mouseup", this._end, this);
    this.bar.un("mouseup", this._end, this);
    this.el.removeClass("nwa-slider_captured");
    this.dragging = false;
    return false
  }, _wheel:function(e) {
    e.preventDefault();
    e = e.browserEvent;
    var delta = e.wheelDelta ? e.wheelDelta / 120 : -e.detail / 3;
    var sliderTop = Math.min(this.sliderSpace, Math.max(0, parseInt(this.bar.dom.style.top) - delta * WHEEL_STEP));
    this._moveSlider(sliderTop);
    this._checkChange(sliderTop)
  }, _moveSlider:function(delta) {
    this.bar.setStyle("top", delta + "px")
  }, show:function(force) {
    clearTimeout(this._showTimeout);
    clearTimeout(this._hideTimeout);
    if(force === true) {
      if(this.el || this.initialConfig.autoRender) {
        UI.Slider.superclass.show.call(this)
      }
    }else {
      this._showTimeout = WA.setTimeout(function() {
        if(this.el || this.initialConfig.autoRender) {
          UI.Slider.superclass.show.call(this)
        }
      }, 500, this)
    }
  }, hide:function(force) {
    clearTimeout(this._showTimeout);
    clearTimeout(this._hideTimeout);
    if(force === true) {
      if(this.el) {
        UI.Slider.superclass.hide.call(this)
      }
    }else {
      this._hideTimeout = WA.setTimeout(function() {
        if(this.el) {
          UI.Slider.superclass.hide.call(this)
        }
      }, 1E3, this)
    }
  }, val:function(val) {
    if(val != null) {
      if(this.sliderSpace > 0) {
        this._moveSlider(this.sliderSpace - Math.floor(val / this.ratio))
      }
    }else {
      var sliderTop = this.sliderSpace - parseInt(this.bar.dom.style.top);
      val = Math.round(this.minVal + this.ratio * sliderTop);
      if(this.stepVal > 1) {
        val = Math.round(val / this.stepVal) * this.stepVal
      }
      return val
    }
  }, destroy:function() {
    UI.Slider.superclass.destroy.call(this)
  }});
  UI.Volume = WA.extend(UI.Slider, {constructor:function(config) {
    config = U.Object.extend(config || {}, {initVal:50, stepVal:10});
    this.controlEl = config.controlEl || [];
    if(this.controlEl && this.controlEl.length == null) {
      this.controlEl = [this.controlEl]
    }
    if(this.controlEl[0]) {
      this.controlEl[0].on("mouseover", this.show, this).on("mouseout", this.hide, this).on("click", this.toggleMute, this)
    }
    UI.Volume.superclass.constructor.call(this, config)
  }, _onRender:function(ct) {
    UI.Volume.superclass._onRender.call(this, ct);
    this.el.on("mouseover", this.show, this).on("mouseout", this.hide, this)
  }, _onClick:function(e) {
    if(!this.isVisible() || e.button !== 0) {
      return
    }
    var target = e.getTarget(true);
    if(target.dom.id == "nwaVoipSwf") {
      return false
    }
    for(var i = 0, len = this.controlEl.length;i < len;i++) {
      if(this.controlEl[i].contains(target)) {
        return false
      }
    }
    if(!target || !this.el.equals(target) && !this.el.contains(target)) {
      this.hide(true)
    }
  }, _onHide:function() {
    WA.getBody().un("mousedown", this._onClick, this)
  }, _onShow:function() {
    WA.getBody().on("mousedown", this._onClick, this);
    UI.Volume.superclass._onShow.call(this)
  }, _checkChange:function(sliderTop) {
    UI.Volume.superclass._checkChange.call(this, sliderTop);
    if(this.controlEl[0]) {
      this.controlEl[0].toggleClass(this.initialConfig.muteCls, this._lastVal == this.minVal)
    }
  }, controlAction:function(action) {
    if(action == "over") {
      this.show()
    }else {
      if(action == "out") {
        this.hide()
      }else {
        if(action == "click") {
          this.toggleMute()
        }
      }
    }
  }, toggleMute:function() {
    if(!this.isVisible()) {
      this.show(true);
      return
    }
    if(this.val() > this.minVal) {
      if(this.controlEl[0]) {
        this.controlEl[0].addClass(this.initialConfig.muteCls)
      }
      this.changeEvent.fire(this.minVal);
      this.val(this.minVal)
    }else {
      if(this._lastVal > this.minVal) {
        if(this.controlEl[0]) {
          this.controlEl[0].removeClass(this.initialConfig.muteCls)
        }
        this.changeEvent.fire(this._lastVal);
        this.val(this._lastVal)
      }
    }
  }});
  UI.Dragger = WA.extend(UI.Component, {constructor:function(config) {
    config = config || {};
    this.dragStart = [0, 0];
    this.mouseStart = [0, 0];
    this.el = config.el;
    this.bar = config.bar || config.el;
    this.bar.on("mousedown", this._start, this);
    this.lastPosition = null;
    UI.Dragger.superclass.constructor.call(this, config)
  }, _start:function(e) {
    e.preventDefault();
    this.mouseStart = [e.pageX, e.pageY];
    this.dragStart = [this.el.dom.offsetLeft, this.el.dom.offsetTop];
    WA.getDoc().on("mousemove", this._drag, this);
    WA.getDoc().on("mouseup", this._end, this);
    this.bar.on("mouseup", this._end, this);
    return false
  }, _drag:function(e) {
    e.preventDefault();
    this.lastPosition = [this.dragStart[0] + e.pageX - this.mouseStart[0], this.dragStart[1] + e.pageY - this.mouseStart[1]];
    this.dragTo();
    return false
  }, dragTo:function(pos) {
    pos = pos || this.lastPosition;
    if(!pos) {
      return
    }
    this.el.setStyle({left:pos[0] + "px", top:pos[1] + "px", right:"auto", bottom:"auto"});
    this.lastPosition = pos
  }, _end:function(e) {
    WA.getDoc().un("mousemove", this._drag, this);
    WA.getDoc().un("mouseup", this._end, this);
    this.bar.un("mouseup", this._end, this);
    return false
  }})
})();
WebAgent.namespace("WebAgent.ui");
(function() {
  var WA = WebAgent, UI = WA.ui, U = WA.util, MENU = WA.ui.menu, VISIBLE_TABS_LIMIT = 7, VISIBLE_TABS_LIMIT_NEWSTYLE = 4;
  UI.TabBox = WA.extend(UI.Layer, {constructor:function(config) {
    this.uid = WA.uniq();
    var cfg = WA.applyIf(config || {}, {externalResources:false, cls:"", clsTab:"", clsTabLayer:"", hideOnClick:true, fadeIn:true, flatStyle:false, tabOrientation:"top", dataSource:{}});
    this.dataSource = config.dataSource;
    this.dataSource.init();
    this.controlEl = cfg.controlEl || [];
    if(this.controlEl && this.controlEl.length == null) {
      this.controlEl = [this.controlEl]
    }
    this._tabs = new Tabs({dataSource:this.dataSource, orientation:cfg.tabOrientation, cls:cfg.flatStyle ? "nwa-multitabs_flat" : "nwa-multitabs_oldschool", tabsVisible:cfg.flatStyle ? VISIBLE_TABS_LIMIT_NEWSTYLE : VISIBLE_TABS_LIMIT, navigationAlwaysVisible:!!cfg.flatStyle});
    this.embedMode = !cfg.hideOnClick;
    cfg.cls = "nwa-tabbox nwa-tabbox_o-" + cfg.tabOrientation + " " + cfg.cls;
    UI.TabBox.superclass.constructor.call(this, cfg);
    this.itemClickEvent = new U.Event
  }, _onAncestorClick:function(el, isSelf, e) {
    if(!isSelf) {
      var c = el;
      var index = null;
      while(this.activeTab && c && !c.equals(this.activeTab.el)) {
        index = parseInt(c.getAttribute("menu_index"));
        if(WA.isNumber(index)) {
          var code = this.activeTab.items[index].initialConfig.item_code;
          if(code && this.dataSource.itemClicked(code) !== false) {
            this.itemClickEvent.fire(code);
            e.stopEvent();
            return false
          }
          break
        }else {
          c = c.parent()
        }
      }
    }
  }, setControlElement:function(el) {
    this.controlEl = el && el.length == null && [el] || el
  }, _onClick:function(e) {
    var target = e.getTarget(true);
    for(var i = 0, len = this.controlEl.length;i < len;i++) {
      if(this.controlEl[i].contains(target)) {
        return false
      }
    }
    if(this._tabs.rendered && this._tabs.el.contains(target)) {
      return true
    }
    UI.TabBox.superclass._onClick.call(this, e)
  }, selectTab:function(tabnum, selectById) {
    if(selectById) {
      tabnum = this.dataSource.getSetIndexById(tabnum)
    }
    if(tabnum > -1) {
      this._tabs.setFocus(tabnum)
    }
  }, _onAfterRender:function(el) {
    this._tabs.tabChangeEvent.on(this._onTabChangeEvent, this);
    this._tabs.render(this.el);
    this.updateTabsData();
    this.contentsBlock = this.el.last().last();
    this.dataSource.dataChangeEvent.on(function() {
      this.updateTabsData()
    }, this);
    if(this.embedMode) {
      this.el.on("mousedown", this._onClickEvent, this)
    }
  }, updateTabsData:function() {
    var tabsCount = this.tabsCount = this.dataSource.getSetCount();
    var data = [];
    if(tabsCount == 0) {
      return
    }
    for(var i = 0;i < tabsCount;i++) {
      var setId = this.dataSource.getSetId(i);
      var setData = this.dataSource.getSetData(i);
      data.push({cls:this.initialConfig.clsTab + "_" + setId, icon:setData && setData.icon || "", id:setId})
    }
    this._tabs.refreshTabsData(data)
  }, _onClickEvent:function(e) {
    if(e.button !== 0) {
      return
    }
    var isAncestor = false;
    var isSelf = false;
    var target = e.getTarget(true);
    if(target) {
      isSelf = this.el.equals(target);
      isAncestor = isSelf || this.el.contains(target)
    }
    if(isAncestor) {
      this._onAncestorClick(target, isSelf, e)
    }
  }, _onTabChangeEvent:function(setIndex, tabId) {
    if(this.activeTab) {
      this.activeTab.hide();
      this.activeTab.destroy()
    }
    var data = this.dataSource.formatSetItems(setIndex);
    this.activeTab = new TabLayer({externalUrl:this.initialConfig.externalResources, items:data, cls:this.initialConfig.clsTabLayer + setIndex, useScroll:true});
    this.activeTab.render(this.el);
    this.activeTab.show()
  }, destroy:function() {
    this.itemClickEvent.removeAll();
    this.itemClickEvent = null;
    if(this.dataSource) {
      this.dataSource.destroy()
    }
    UI.TabBox.superclass.destroy.call(this)
  }});
  var TabLayer = WA.extend(MENU.Menu, {defaultType:MENU.Image, constructor:function(config) {
    var cfg = WA.applyIf({hideOnClick:false, hideOnEscape:false, fadeIn:false, autoHide:false}, config || {});
    if(config.externalUrl) {
      this.defaultType = MENU.IMG
    }
    cfg.cls = "nwa-tabbox__layer " + cfg.cls;
    TabLayer.superclass.constructor.call(this, cfg)
  }});
  var Tabs = WA.extend(UI.Component, {constructor:function(cfg) {
    this.cfg = cfg || {};
    this.navigationAlwaysVisible = !!cfg.navigationAlwaysVisible;
    this.cls = cfg.cls || "";
    this.clsTab = cfg.clsTab || "";
    this.clsTabPrev = cfg.clsTabPrev || "";
    this.clsTabNext = cfg.clsTabNext || "";
    this.tabsVisible = cfg.tabsVisible || 4;
    this.orientation = cfg.orientation || "top";
    Tabs.superclass.constructor.apply(this, arguments);
    this.tabChangeEvent = new U.Event;
    this._list = [];
    this._tabs = [];
    this._index = -1;
    this._startTab = 0;
    this.useNavigation = false
  }, _onRender:function(el) {
    this.el = el.createChild({cls:"nwa-multitabs nwa-multitabs_o-" + this.orientation + " " + this.cls});
    this.el.on("click", this._onClickEvent, this);
    this._renderTabs()
  }, _onClickEvent:function(el) {
    var trg = el.getTarget(true);
    trg = trg.hasClass("nwa-multitabs__tab") && trg || trg.parent();
    var index = trg.getAttribute("data-tab-index");
    var tabId = trg.getAttribute("data-tab");
    if(index == "prev") {
      if(this._startTab < 1) {
        return
      }
      this._startTab = this._startTab - (!this.navigationAlwaysVisible && this._startTab == 2 ? 2 : 1)
    }else {
      if(index == "next") {
        if(this._startTab >= this._list.length - this.tabsVisible) {
          return
        }
        this._startTab = this._startTab + (!this.navigationAlwaysVisible && this._startTab == 0 ? 2 : 1)
      }else {
        if(index != null) {
          this.setFocus(index, tabId)
        }
      }
    }
    this._refreshTabsVisibility()
  }, _refreshTabsVisibility:function() {
    if(!this.useNavigation) {
      return
    }
    this.prevEl.setVisible(this._startTab > 0 || this.navigationAlwaysVisible);
    this.prevEl.toggleClass("nwa-multitabs__disabled", this._startTab < 1);
    this.nextEl.setVisible(this._startTab < this._list.length - this.tabsVisible || this.navigationAlwaysVisible);
    this.nextEl.toggleClass("nwa-multitabs__disabled", this._startTab >= this._list.length - this.tabsVisible);
    U.Array.each(this._tabs, function(tab, i) {
      tab.setVisible(i >= this._startTab && i < this._startTab + this.tabsVisible - (!this.navigationAlwaysVisible && this._startTab > 0 && this._startTab < this._list.length - this.tabsVisible))
    }, this)
  }, refreshTabsData:function(tabsDataArray) {
    this._list = tabsDataArray;
    if(this.el) {
      this._renderTabs()
    }
  }, _renderTabs:function() {
    this.el.update("");
    this._tabs = [];
    this._index = -1;
    this._startTab = 0;
    if(this._list.length > this.tabsVisible) {
      this.useNavigation = true
    }
    U.Array.each(this._list, function(tab, i) {
      this._tabs.push(this._createTabElement(tab, i))
    }, this);
    if(this.useNavigation) {
      this.prevEl = this._createTabElement({cls:"nwa-multitabs__prev " + this.clsTabPrev, id:"_prev"}, "prev", true);
      this.nextEl = this._createTabElement({cls:"nwa-multitabs__next " + this.clsTabNext, id:"_next"}, "next");
      this._refreshTabsVisibility()
    }
    if(this._list.length) {
      this.setFocus(0)
    }
  }, _createTabElement:function(tab, i, atTheBeginning) {
    var tabIcon = tab.icon ? '<img src="' + tab.icon + '"/>' : '<span class="nwa-multitabs__tabspan"></span>';
    return this.el.createChild({tag:"div", cls:"nwa-multitabs__tab " + (tab.cls || ""), "data-tab-index":i, "data-tab":tab.id, html:tabIcon}, atTheBeginning)
  }, setTabsData:function(tabsDataArray) {
    this._list = tabsDataArray
  }, setFocus:function(index, tabId) {
    if(this._index != index) {
      if(this._index != -1) {
        this._tabs[this._index].removeClass("nwa-multitabs__active")
      }
      this._tabs[index].addClass("nwa-multitabs__active");
      this._index = index;
      this.tabChangeEvent.fire(index, tabId)
    }
  }})
})();
WebAgent.namespace("WebAgent.data");
(function() {
  var WA = WebAgent;
  var U = WA.util;
  var ArrayUtils = U.Array;
  WA.data.Record = WA.extend(Object, {constructor:function(fields, data) {
    this.fields = fields;
    this.data = [];
    ArrayUtils.each(this.fields, function(fieldName) {
      this.data.push(data[fieldName])
    }, this)
  }, hasField:function(fieldName) {
    return ArrayUtils.indexOf(this.fields, fieldName) != -1
  }, get:function(fieldName) {
    var index = ArrayUtils.indexOf(this.fields, fieldName);
    if(index != -1) {
      return this.getAt(index)
    }else {
      return null
    }
  }, getAt:function(index) {
    return this.data[index]
  }})
})();
WebAgent.namespace("WebAgent.data");
(function() {
  WebAgent.data.Statuses = {"icq_online":["", "ÐÐ½Ð»Ð°Ð¹Ð½"], "icq_offline":["", "ÐÑÐºÐ»ÑÑÑÐ½"], "icq_unauth":["", "ÐÐµ Ð°Ð²ÑÐ¾ÑÐ¸Ð·Ð¾Ð²Ð°Ð½"], "icq_invisible":["", "ÐÐµÐ²Ð¸Ð´Ð¸Ð¼ÑÐ¹"], "icq_busy":["", "ÐÐ°Ð½ÑÑ"], "icq_chat":["status_chat", "ÐÐ¾ÑÐ¾Ð² Ð¿Ð¾Ð±Ð¾Ð»ÑÐ°ÑÑ"], "icq_dnd":["", "ÐÐµ Ð±ÐµÑÐ¿Ð¾ÐºÐ¾Ð¸ÑÑ"], "icq_occupied":["", "ÐÐµ Ð±ÐµÑÐ¿Ð¾ÐºÐ¾Ð¸ÑÑ"], "icq_mobile":["", "Ð¡ Ð¼Ð¾Ð±Ð¸Ð»ÑÐ½Ð¾Ð³Ð¾"], "icq_unknown":["", "ÐÐµ Ð°Ð²ÑÐ¾ÑÐ¸Ð·Ð¾Ð²Ð°Ð½"], "icq_home":["0icqmood63", "ÐÐ¾Ð¼Ð°"], "icq_work":["0icqmood64", "ÐÐ° ÑÐ°Ð±Ð¾ÑÐµ"], "icq_sad":["0icqmood72", "Ð Ð´ÐµÐ¿ÑÐµÑÑÐ¸Ð¸"], "icq_shop":["0icqmood0", 
  "ÐÐ°Ð³Ð°Ð·Ð¸Ð½Ñ"], "icq_duck":["0icqmood1", "Ð Ð²Ð°Ð½Ð½Ð¾Ð¹"], "icq_tired":["0icqmood2", "Ð£ÑÑÐ°Ð»"], "icq_party":["0icqmood3", "ÐÐµÑÐµÑÐ¸Ð½ÐºÐ°"], "icq_beer":["0icqmood4", "ÐÐ¸Ð²Ð¾"], "icq_think":["0icqmood5", "ÐÑÐ¼Ð°Ñ"], "icq_eating":["0icqmood6", "ÐÑÑÐ°Ñ"], "icq_tv":["0icqmood7", "Ð¢ÐµÐ»ÐµÐ²Ð¸Ð·Ð¾Ñ"], "icq_friends":["0icqmood8", "ÐÑÑÐ·ÑÑ"], "icq_coffee":["0icqmood9", "ÐÐ¾ÑÐµ"], "icq_music":["0icqmood10", "ÐÑÐ·ÑÐºÐ°"], "icq_business":["0icqmood11", "ÐÐµÐ»Ð°"], "icq_cinema":["0icqmood12", "ÐÐ¸Ð½Ð¾"], "icq_fun":["0icqmood13", "Ð Ð°Ð·Ð²Ð»ÐµÐºÐ°ÑÑÑ"], 
  "icq_phone":["0icqmood14", "ÐÐ° ÑÐµÐ»ÐµÑÐ¾Ð½Ðµ"], "icq_game":["0icqmood81", "ÐÐ³ÑÐ°Ñ"], "icq_study":["0icqmood16", "Ð£ÑÑÑÑ"], "icq_sick":["0icqmood17", "ÐÐ¾Ð»ÐµÑ"], "icq_sleeping":["0icqmood70", "Ð¡Ð¿Ð»Ñ"], "icq_surfing":["0icqmood19", "ÐÑÑÑÐ²Ð°ÑÑÑ"], "icq_internet":["0icqmood20", "Ð Ð¸Ð½ÑÐµÑÐ½ÐµÑÐµ"], "icq_working":["0icqmood21", "Ð Ð°Ð±Ð¾ÑÐ°Ñ"], "icq_typing":["0icqmood22", "ÐÐ¸ÑÑ"], "icq_angry":["0icqmood23", "ÐÐ»Ð¾Ð¹"], "icq_weekend":["0icqmood66", "ÐÑÐ´ÑÑÐ°Ñ"], "icq_psp":["0icqmood15", "ÐÑÐ¸ÑÑÐ°Ð²ÐºÐ°"], "icq_on_mobile":["0icqmood71", 
  "ÐÐ° Ð¼Ð¾Ð±Ð¸Ð»ÑÐ½Ð¾Ð¼"], "icq_asleep":["0icqmood18", "ÐÐ°ÑÑÐ¿Ð°Ñ"], "icq_wc":["0icqmood68", "Ð ÑÑÐ°Ð»ÐµÑÐµ"], "icq_question":["0icqmood77", "ÐÐ¾Ð¿ÑÐ¾Ñ"], "icq_way":["0icqmood83", "Ð Ð¿ÑÑÐ¸"], "icq_love":["0icqmood61", "ÐÑÐ±Ð¾Ð²Ñ"], "icq_in_love":["0icqmood76", "ÐÐ»ÑÐ±Ð»ÑÐ½"], "icq_search":["0icqmood85", "ÐÑÑ"], "icq_diary":["0icqmood84", "ÐÐ½ÐµÐ²Ð½Ð¸Ðº"], "mrim_away":[""], "mrim_chat":[""], "mrim_occupied":[""], "mrim_invisible":[""], "mrim_offline":[""], "mrim_online":[""], "mrim_unauth":[""]};
  WebAgent.data.CommonMoods = ["shop", "duck", "tired", "party", "beer", "think", "eating", "tv", "coffee", "music", "business", "fun", "phone", "game", "study", "sick", "sleeping", "surfing", "internet", "working", "typing", "angry", "weekend", "psp", "on_mobile", "asleep", "wc", "question", "way", "love", "in_love"];
  WebAgent.data.StatusList = ["icq_online", "icq_invisible", "icq_home", "icq_work", "icq_shop", "icq_duck", "icq_tired", "icq_beer", "icq_think", "icq_tv", "icq_weekend", "icq_music", "icq_on_mobile", "icq_working", "icq_phone", "icq_psp", "icq_study", "icq_sick", "icq_asleep", "icq_internet", "icq_angry", "icq_surfing", "icq_fun", "icq_party", "icq_in_love", "icq_wc", "icq_sleeping", "icq_sad", "icq_question", "icq_eating", "icq_game", "icq_typing"];
  WebAgent.data.MoodTitles = ["ÐÐ°Ð³Ð°Ð·Ð¸Ð½Ñ", "Ð Ð²Ð°Ð½Ð½Ð¾Ð¹", "Ð£ÑÑÐ°Ð»", "ÐÐµÑÐµÑÐ¸Ð½ÐºÐ°", "ÐÐ¸Ð²Ð¾", "ÐÑÐ¼Ð°Ñ", "ÐÑÑÐ°Ñ", "Ð¢ÐµÐ»ÐµÐ²Ð¸Ð·Ð¾Ñ", "ÐÑÑÐ·ÑÑ", "ÐÐ¾ÑÐµ", "ÐÑÐ·ÑÐºÐ°", "ÐÐµÐ»Ð°", "ÐÐ¸Ð½Ð¾", "Ð Ð°Ð·Ð²Ð»ÐµÐºÐ°ÑÑÑ", "ÐÐ° ÑÐµÐ»ÐµÑÐ¾Ð½Ðµ", "ÐÐ³ÑÐ°Ñ", "Ð£ÑÑÑÑ", "ÐÐ¾Ð»ÐµÑ", "Ð¡Ð¿Ð»Ñ", "ÐÑÑÑÐ²Ð°ÑÑÑ", "Ð Ð¸Ð½ÑÐµÑÐ½ÐµÑÐµ", "Ð Ð°Ð±Ð¾ÑÐ°Ñ", "ÐÐ¸ÑÑ", "ÐÐ»Ð¾Ð¹", "ÐÑÐ´ÑÑÐ°Ñ", "ÐÑÐ¸ÑÑÐ°Ð²ÐºÐ°", "ÐÐ° Ð¼Ð¾Ð±Ð¸Ð»ÑÐ½Ð¾Ð¼", "ÐÐ°ÑÑÐ¿Ð°Ñ", "Ð ÑÑÐ°Ð»ÐµÑÐµ", "ÐÐ¾Ð¿ÑÐ¾Ñ", "Ð Ð¿ÑÑÐ¸", "ÐÑÐ±Ð¾Ð²Ñ", "ÐÐ»ÑÐ±Ð»ÑÐ½", "ÐÑÑ", "ÐÐ½ÐµÐ²Ð½Ð¸Ðº"];
  WebAgent.data.MoodIds = ["0icqmood0", "0icqmood1", "0icqmood2", "0icqmood3", "0icqmood4", "0icqmood5", "0icqmood6", "0icqmood7", "0icqmood8", "0icqmood9", "0icqmood10", "0icqmood11", "0icqmood12", "0icqmood13", "0icqmood14", "0icqmood81", "0icqmood16", "0icqmood17", "0icqmood70", "0icqmood19", "0icqmood20", "0icqmood21", "0icqmood22", "0icqmood23", "0icqmood66", "0icqmood15", "0icqmood71", "0icqmood18", "0icqmood68", "0icqmood77", "0icqmood83", "0icqmood61", "0icqmood76", "0icqmood85", "0icqmood84"];
  WebAgent.data.MoodList = ["status_icq_shop", "status_icq_duck", "status_icq_tired", "status_icq_party", "status_icq_beer", "status_icq_think", "status_icq_eating", "status_icq_tv", "status_icq_friends", "status_icq_coffee", "status_icq_music", "status_icq_business", "status_icq_cinema", "status_icq_fun", "status_icq_phone", "status_icq_game", "status_icq_study", "status_icq_sick", "status_icq_sleeping", "status_icq_surfing", "status_icq_internet", "status_icq_working", "status_icq_typing", "status_icq_angry", 
  "status_icq_weekend", "status_icq_psp", "status_icq_on_mobile", "status_icq_asleep", "status_icq_wc", "status_icq_question", "status_icq_way", "status_icq_love", "status_icq_in_love", "status_icq_search", "status_icq_diary"]
})();
WebAgent.namespace("WebAgent.data");
(function() {
  WebAgent.data.EmojiSets = ["people", "nature", "objects", "places", "symbols"];
  WebAgent.data.EmojiData = {"people":["1f604", "1f603", "1f600", "1f60a", "263a", "1f609", "1f60d", "1f618", "1f61a", "1f617", "1f619", "1f61c", "1f61d", "1f61b", "1f633", "1f601", "1f614", "1f60c", "1f612", "1f61e", "1f623", "1f622", "1f602", "1f62d", "1f62a", "1f625", "1f630", "1f605", "1f613", "1f629", "1f62b", "1f628", "1f631", "1f620", "1f621", "1f624", "1f616", "1f606", "1f60b", "1f637", "1f60e", "1f634", "1f635", "1f632", "1f61f", "1f626", "1f627", "1f608", "1f47f", "1f62e", "1f62c", "1f610", 
  "1f615", "1f62f", "1f636", "1f607", "1f60f", "1f611", "1f472", "1f473", "1f46e", "1f477", "1f482", "1f476", "1f466", "1f467", "1f468", "1f469", "1f474", "1f475", "1f471", "1f47c", "1f478", "1f63a", "1f638", "1f63b", "1f63d", "1f63c", "1f640", "1f63f", "1f639", "1f63e", "1f479", "1f47a", "1f648", "1f649", "1f64a", "1f480", "1f47d", "1f4a9", "1f525", "2728", "1f31f", "1f4ab", "1f4a5", "1f4a2", "1f4a6", "1f4a7", "1f4a4", "1f4a8", "1f442", "1f440", "1f443", "1f445", "1f444", "1f44d", "1f44e", "1f44c", 
  "1f44a", "270a", "270c", "1f44b", "270b", "1f450", "1f446", "1f447", "1f449", "1f448", "1f64c", "1f64f", "261d", "1f44f", "1f4aa", "1f6b6", "1f3c3", "1f483", "1f46b", "1f46a", "1f46c", "1f46d", "1f48f", "1f491", "1f46f", "1f646", "1f645", "1f481", "1f64b", "1f486", "1f487", "1f485", "1f470", "1f64e", "1f64d", "1f647", "1f3a9", "1f451", "1f452", "1f45f", "1f45e", "1f461", "1f460", "1f462", "1f455", "1f454", "1f45a", "1f457", "1f3bd", "1f456", "1f458", "1f459", "1f4bc", "1f45c", "1f45d", "1f45b", 
  "1f453", "1f380", "1f302", "1f484", "1f49b", "1f499", "1f49c", "1f49a", "2764", "1f494", "1f497", "1f493", "1f495", "1f496", "1f49e", "1f498", "1f48c", "1f48b", "1f48d", "1f48e", "1f464", "1f465", "1f4ac", "1f463", "1f4ad"], "nature":["1f436", "1f43a", "1f431", "1f42d", "1f439", "1f430", "1f438", "1f42f", "1f428", "1f43b", "1f437", "1f43d", "1f42e", "1f417", "1f435", "1f412", "1f434", "1f411", "1f418", "1f43c", "1f427", "1f426", "1f424", "1f425", "1f423", "1f414", "1f40d", "1f422", "1f41b", "1f41d", 
  "1f41c", "1f41e", "1f40c", "1f419", "1f41a", "1f420", "1f41f", "1f42c", "1f433", "1f40b", "1f404", "1f40f", "1f400", "1f403", "1f405", "1f407", "1f409", "1f40e", "1f410", "1f413", "1f415", "1f416", "1f401", "1f402", "1f432", "1f421", "1f40a", "1f42b", "1f42a", "1f406", "1f408", "1f429", "1f43e", "1f490", "1f338", "1f337", "1f340", "1f339", "1f33b", "1f33a", "1f341", "1f343", "1f342", "1f33f", "1f33e", "1f344", "1f335", "1f334", "1f332", "1f333", "1f330", "1f331", "1f33c", "1f310", "1f31e", "1f31d", 
  "1f31a", "1f311", "1f312", "1f313", "1f314", "1f315", "1f316", "1f317", "1f318", "1f31c", "1f31b", "1f319", "1f30d", "1f30e", "1f30f", "1f30b", "1f30c", "1f320", "2b50", "2600", "26c5", "2601", "26a1", "2614", "2744", "26c4", "1f300", "1f301", "1f308", "1f30a"], "objects":["1f38d", "1f49d", "1f38e", "1f392", "1f393", "1f38f", "1f386", "1f387", "1f390", "1f391", "1f383", "1f47b", "1f385", "1f384", "1f381", "1f38b", "1f389", "1f38a", "1f388", "1f38c", "1f52e", "1f3a5", "1f4f7", "1f4f9", "1f4fc", 
  "1f4bf", "1f4c0", "1f4bd", "1f4be", "1f4bb", "1f4f1", "260e", "1f4de", "1f4df", "1f4e0", "1f4e1", "1f4fa", "1f4fb", "1f50a", "1f509", "1f508", "1f507", "1f514", "1f515", "1f4e2", "1f4e3", "23f3", "231b", "23f0", "231a", "1f513", "1f512", "1f50f", "1f510", "1f511", "1f50e", "1f4a1", "1f526", "1f506", "1f505", "1f50c", "1f50b", "1f50d", "1f6c1", "1f6c0", "1f6bf", "1f6bd", "1f527", "1f529", "1f528", "1f6aa", "1f6ac", "1f4a3", "1f52b", "1f52a", "1f48a", "1f489", "1f4b0", "1f4b4", "1f4b5", "1f4b7", 
  "1f4b6", "1f4b3", "1f4b8", "1f4f2", "1f4e7", "1f4e5", "1f4e4", "2709", "1f4e9", "1f4e8", "1f4ef", "1f4eb", "1f4ea", "1f4ec", "1f4ed", "1f4ee", "1f4e6", "1f4dd", "1f4c4", "1f4c3", "1f4d1", "1f4ca", "1f4c8", "1f4c9", "1f4dc", "1f4cb", "1f4c5", "1f4c6", "1f4c7", "1f4c1", "1f4c2", "2702", "1f4cc", "1f4ce", "2712", "270f", "1f4cf", "1f4d0", "1f4d5", "1f4d7", "1f4d8", "1f4d9", "1f4d3", "1f4d4", "1f4d2", "1f4da", "1f4d6", "1f516", "1f4db", "1f52c", "1f52d", "1f4f0", "1f3a8", "1f3ac", "1f3a4", "1f3a7", 
  "1f3bc", "1f3b5", "1f3b6", "1f3b9", "1f3bb", "1f3ba", "1f3b7", "1f3b8", "1f47e", "1f3ae", "1f0cf", "1f3b4", "1f004", "1f3b2", "1f3af", "1f3c8", "1f3c0", "26bd", "26be", "1f3be", "1f3b1", "1f3c9", "1f3b3", "26f3", "1f6b5", "1f6b4", "1f3c1", "1f3c7", "1f3c6", "1f3bf", "1f3c2", "1f3ca", "1f3c4", "1f3a3", "2615", "1f375", "1f376", "1f37c", "1f37a", "1f37b", "1f378", "1f379", "1f377", "1f374", "1f355", "1f354", "1f35f", "1f357", "1f356", "1f35d", "1f35b", "1f364", "1f371", "1f363", "1f365", "1f359", 
  "1f358", "1f35a", "1f35c", "1f372", "1f362", "1f361", "1f373", "1f35e", "1f369", "1f36e", "1f366", "1f368", "1f367", "1f382", "1f370", "1f36a", "1f36b", "1f36c", "1f36d", "1f36f", "1f34e", "1f34f", "1f34a", "1f34b", "1f352", "1f347", "1f349", "1f353", "1f351", "1f348", "1f34c", "1f350", "1f34d", "1f360", "1f346", "1f345", "1f33d"], "places":["1f3e0", "1f3e1", "1f3eb", "1f3e2", "1f3e3", "1f3e5", "1f3e6", "1f3ea", "1f3e9", "1f3e8", "1f492", "26ea", "1f3ec", "1f3e4", "1f307", "1f306", "1f3ef", "1f3f0", 
  "26fa", "1f3ed", "1f5fc", "1f5fe", "1f5fb", "1f304", "1f305", "1f303", "1f5fd", "1f309", "1f3a0", "1f3a1", "26f2", "1f3a2", "1f6a2", "26f5", "1f6a4", "1f6a3", "2693", "1f680", "2708", "1f4ba", "1f681", "1f682", "1f68a", "1f689", "1f69e", "1f686", "1f684", "1f685", "1f688", "1f687", "1f69d", "1f68b", "1f683", "1f68e", "1f68c", "1f68d", "1f699", "1f698", "1f697", "1f695", "1f696", "1f69b", "1f69a", "1f6a8", "1f693", "1f694", "1f692", "1f691", "1f690", "1f6b2", "1f6a1", "1f69f", "1f6a0", "1f69c", 
  "1f488", "1f68f", "1f3ab", "1f6a6", "1f6a5", "26a0", "1f6a7", "1f530", "26fd", "1f3ee", "1f3b0", "2668", "1f5ff", "1f3aa", "1f3ad", "1f4cd", "1f6a9", "1f1ef-1f1f5", "1f1f0-1f1f7", "1f1e9-1f1ea", "1f1e8-1f1f3", "1f1fa-1f1f8", "1f1eb-1f1f7", "1f1ea-1f1f8", "1f1ee-1f1f9", "1f1f7-1f1fa", "1f1ec-1f1e7"], "symbols":["30-20e3", "31-20e3", "32-20e3", "33-20e3", "34-20e3", "35-20e3", "36-20e3", "37-20e3", "38-20e3", "39-20e3", "1f51f", "1f522", "1f523", "2b06", "2b07", "2b05", "27a1", "1f520", "1f521", 
  "1f524", "2197", "2196", "2198", "2199", "2194", "2195", "1f504", "25c0", "25b6", "1f53c", "1f53d", "21a9", "21aa", "2139", "23ea", "23e9", "23eb", "23ec", "2935", "2934", "1f197", "1f500", "1f501", "1f502", "1f195", "1f199", "1f192", "1f193", "1f196", "1f4f6", "1f3a6", "1f201", "1f22f", "1f233", "1f235", "1f234", "1f232", "1f250", "1f239", "1f23a", "1f236", "1f21a", "1f6bb", "1f6b9", "1f6ba", "1f6bc", "1f6be", "1f6b0", "1f6ae", "1f17f", "267f", "1f6ad", "1f237", "1f238", "1f202", "24c2", "1f6c2", 
  "1f6c4", "1f6c5", "1f6c3", "1f251", "3299", "3297", "1f191", "1f198", "1f194", "1f6ab", "1f51e", "1f4f5", "1f6af", "1f6b1", "1f6b3", "1f6b7", "1f6b8", "26d4", "2733", "2747", "274e", "2705", "2734", "1f49f", "1f19a", "1f4f3", "1f4f4", "1f170", "1f171", "1f18e", "1f17e", "1f4a0", "27bf", "267b", "2648", "2649", "264a", "264b", "264c", "264d", "264e", "264f", "2650", "2651", "2652", "2653", "26ce", "1f52f", "1f3e7", "1f4b9", "1f4b2", "1f4b1", "a9", "ae", "2122", "274c", "203c", "2049", "2757", "2753", 
  "2755", "2754", "2b55", "1f51d", "1f51a", "1f519", "1f51b", "1f51c", "1f503", "1f55b", "1f567", "1f550", "1f55c", "1f551", "1f55d", "1f552", "1f55e", "1f553", "1f55f", "1f554", "1f560", "1f555", "1f556", "1f557", "1f558", "1f559", "1f55a", "1f561", "1f562", "1f563", "1f564", "1f565", "1f566", "2716", "2795", "2796", "2797", "2660", "2665", "2663", "2666", "1f4ae", "1f4af", "2714", "2611", "1f518", "1f517", "27b0", "3030", "303d", "1f531", "25fc", "25fb", "25fe", "25fd", "25aa", "25ab", "1f53a", 
  "1f532", "1f533", "26ab", "26aa", "1f534", "1f535", "1f53b", "2b1c", "2b1b", "1f536", "1f537", "1f538", "1f539"]}
})();
WebAgent.namespace("WebAgent.rpc");
(function() {
  var WA = WebAgent, U = WA.util;
  var rpc, rpcOld;
  var baseRemoteEvent = new WA.util.Event;
  var CONST_SHIFT = 743965913;
  var onError = function(e) {
    WA.error(e)
  };
  var Rpc = WA.extend(Object, {constructor:function(id) {
    this.id = id;
    this.remoteEvent = new WA.util.Event;
    baseRemoteEvent.on(this._onBaseRemoteEvent, this)
  }, _onBaseRemoteEvent:function(options) {
    var id = options.id;
    if(id === this.id) {
      this.remoteEvent.fire(options.method, options.params);
      return false
    }
  }, __moveRpc:function(p) {
    rpc && rpc.__position(p)
  }, __backRpc:function() {
    rpc && rpc.__back()
  }, invoke:function(method, params, successFn, errorFn) {
    var actualRpc = this.id == "OldStorage" ? rpcOld : rpc;
    if(actualRpc) {
      var options = {id:this.id, method:method, params:params};
      actualRpc.invoke(options, successFn || WA.emptyFn, errorFn || onError)
    }else {
      if(WA.isFunction(errorFn)) {
        try {
          WA.error("RPC isn't ready yet")
        }catch(e) {
          errorFn(e)
        }
      }
    }
  }});
  var RPC_WAITING_TIMEOUT = 5E3;
  var waitingTimer;
  var needHttp;
  var forceCleanCookie;
  function stopWaiting() {
    if(waitingTimer) {
      clearTimeout(waitingTimer);
      waitingTimer = null
    }
  }
  function startWaiting(timeout, onTimeout) {
    stopWaiting();
    waitingTimer = WA.setTimeout(function() {
      waitingTimer = null;
      onTimeout()
    }, timeout)
  }
  var inited = false;
  var onReadyEvent = new WA.util.Event;
  var isReady = false;
  var onBeforeReadyEvent = new WA.util.Event;
  var isBeforeReady = false;
  WA.rpc.Local = {createRpc:function(id) {
    return new Rpc(id)
  }, init:function() {
    if(!inited) {
      inited = true;
      var emailHash = U.String.crc32(WA.ACTIVE_MAIL) + CONST_SHIFT;
      var path;
      if(WA.isLocalhost) {
        path = WA.resPath + "/rpc.html?" + WA.resProps
      }else {
        path = "https://" + emailHash + ".webagent.mail.ru/webim/agent/rpc.html?" + WA.resProps
      }
      if(needHttp) {
        path = path.replace(/^https:\/\//, "http://")
      }
      if(forceCleanCookie) {
        path = path + "&forceCleanCookie=1"
      }
      var config = {remote:path, onLoadSrc:function() {
        stopWaiting()
      }, onReady:function() {
        isBeforeReady = true;
        onBeforeReadyEvent.fire()
      }, onLoad:function() {
        U.Mnt.flushInterval("rpc")
      }};
      U.Mnt.interval("rpc");
      rpc = new easyXDM.Rpc(config, {acl:"^https?:\\/\\/[\\w\\.]+\\.mail\\.ru(?:[\\/\\?].*)?$", local:{invoke:function(options) {
        baseRemoteEvent.fire(options)
      }}, remote:{invoke:{}}});
      if(WA.isProblemStrictSafari && !WA.isSecure && !needHttp) {
        startWaiting(RPC_WAITING_TIMEOUT, WA.createDelegate(function() {
          needHttp = true;
          forceCleanCookie = true;
          rpc.destroy();
          rpc = null;
          inited = false;
          this.init()
        }, this))
      }
    }
  }, initOld:function(cb) {
    if(this._oldStrgInited) {
      return
    }
    this._oldStrgInited = true;
    var path = "https://" + WA.SAFE_ACTIVE_MAIL + ".webagent.mail.ru/webim/agent/rpc.html?" + WA.resProps;
    if(needHttp) {
      path = path.replace(/^https:\/\//, "http://")
    }
    if(forceCleanCookie) {
      path = path + "&forceCleanCookie=1"
    }
    var config = {remote:path, onLoadSrc:function() {
      stopWaiting()
    }, onReady:function() {
      WA.setTimeout(function() {
        cb && cb()
      }, 100)
    }, onLoad:function() {
    }};
    rpcOld = new easyXDM.Rpc(config, {acl:"^https?:\\/\\/[\\w\\.]+\\.mail\\.ru(?:[\\/\\?].*)?$", local:{invoke:function(options) {
      baseRemoteEvent.fire(options)
    }}, remote:{invoke:{}}});
    if(WA.isProblemStrictSafari && !WA.isSecure && !needHttp) {
      waitingTimer || startWaiting(RPC_WAITING_TIMEOUT, WA.createDelegate(function() {
        needHttp = true;
        forceCleanCookie = true;
        rpcOld.destroy();
        rpcOld = null;
        this._oldStrgInited = false;
        this.initOld(cb)
      }, this))
    }
  }, beforeReady:function(fn, scope) {
    if(isBeforeReady) {
      fn.call(scope || window)
    }else {
      onBeforeReadyEvent.on(fn, scope, {single:true})
    }
  }, proceedLoad:function(n) {
    isReady = true;
    onReadyEvent.fire()
  }, whenReady:function(fn, scope) {
    if(isReady) {
      fn.call(scope || window)
    }else {
      onReadyEvent.on(fn, scope, {single:true})
    }
  }}
})();
(function() {
  var WA = WebAgent;
  var U = WA.util;
  var JSON = WA.getJSON();
  var MIGRATE_OLD_STRG_IF_POSSIBLE = true;
  var Storage = WA.extend(Object, {constructor:function(invoker) {
    this.rpc = WA.rpc.Local.createRpc(invoker || "Storage");
    this.mutesMigratedEvent = new U.Event
  }, migrateOldMutes:function(oldS, needTest) {
    function setMigratedFlag() {
      this.save({"notify.migrated":1}, {success:function() {
        WA.log("###notify# migrated!")
      }, failure:function(e) {
        WA.log("###strg# migrate error:", e)
      }, scope:this})
    }
    if(oldS["notify.blacklist"]) {
      if(needTest) {
        this.load(["notify.migrated"], {failure:function(e) {
          WA.log("###cannot load newstrg", e)
        }, success:function(s) {
          WA.log("###load newstrg", s["notify.migrated"]);
          if(!s["notify.migrated"]) {
            this.mutesMigratedEvent.fire(oldS["notify.blacklist"]);
            setMigratedFlag.call(this)
          }
        }, scope:this})
      }else {
        this.mutesMigratedEvent.fire(oldS["notify.blacklist"]);
        setMigratedFlag.call(this)
      }
    }else {
      setMigratedFlag.call(this)
    }
  }, migrateOldStorage:function() {
    this.oldRpc.invoke("load", ["socket.session", "authWaitingList", "status.forced", "status.forced_title", "status.requested", "status.requested_title", "status.disabled_requested", "sync$clist_agent$hide_offline", "sync$clist_agent$status_alerts_off", "sync$clist_agent$birthday_off", "sync$clist_agent$hide_previews", "sync$clist_agent$show_avatars", "sync$clist_agent$play_sound", "sync$clist_agent$hide_active_dialogs", "notify.blacklist"], function(s) {
      if(s["socket.session"]) {
        WA.log("###strg# found old storage", s["socket.session"], s);
        delete s["socket.session"];
        this.save(s, {success:function() {
          WA.log("###strg# migrated!")
        }, failure:function(e) {
          WA.log("###strg# migrate error:", e);
          U.Mnt.log({reason:"breaklog", login:WA.ACTIVE_MAIL, text:"strgmigrate:fail", errorMessage:e && (e.description || e.message || "" + e), errorStack:e && (e.stack || e.fileName + ":" + (e.line || e.lineNumber))})
        }, scope:this})
      }else {
        WA.log("###strg# NOT found old storage", s)
      }
      this.migrateOldMutes(s, true);
      WA.rpc.Local.proceedLoad(2)
    }.bind(this), function(e) {
      WA.log("###error load old strg", e);
      WA.rpc.Local.proceedLoad(3)
    }.bind(this))
  }, tt:function() {
    this.oldRpc.invoke("load", ["socket.session"], function(s) {
      if(s["socket.session"]) {
        WA.log("###strg# found old storage", s["socket.session"], s)
      }else {
        WA.log("###strg# NOT found old storage", s)
      }
    }.bind(this), function(e) {
      WA.log("###error load old strg", e)
    }.bind(this))
  }, init:function() {
    WA.rpc.Local.init();
    WA.rpc.Local.beforeReady(function() {
      if(WA.isLocalhost || !MIGRATE_OLD_STRG_IF_POSSIBLE) {
        WA.rpc.Local.proceedLoad(0);
        return
      }
      this.load(["socket.session", "notify.migrated"], {failure:function(e) {
        WA.log("###cannot load newstrg", e)
      }, success:function(s) {
        WA.log("###load newstrg", s["socket.session"], s);
        if(s["socket.session"]) {
          WA.rpc.Local.proceedLoad(1);
          if(!s["notify.migrated"]) {
            this.oldRpc = WA.rpc.Local.createRpc("OldStorage");
            WA.rpc.Local.initOld(function() {
              this.oldRpc.invoke("load", ["notify.blacklist"], this.migrateOldMutes.bind(this))
            }.bind(this))
          }
        }else {
          this.oldRpc = WA.rpc.Local.createRpc("OldStorage");
          WA.rpc.Local.initOld(this.migrateOldStorage.bind(this))
        }
      }, scope:this})
    }, this)
  }, whenReady:function(fn, scope) {
    WA.setTimeout(function() {
      WA.rpc.Local.whenReady(fn, scope)
    }, 1, this)
  }, _onError:function(e) {
    WA.error(e)
  }, _createDelegatedCallbacks:function(callback) {
    var createDelegate = WA.createDelegate;
    var onError = createDelegate(this._onError, this);
    var cb;
    callback = callback || {};
    if(WA.isFunction(callback)) {
      cb = {success:callback, failure:onError}
    }else {
      cb = {success:callback.success || WA.emptyFn, failure:callback.failure || onError, scope:callback.scope}
    }
    var scope = callback.scope || window;
    var successFn = createDelegate(cb.success, scope);
    var errorFn = createDelegate(cb.failure, scope);
    return{successFn:successFn, errorFn:errorFn}
  }, _callRpc:function(method, params, callback) {
    var cb = this._createDelegatedCallbacks(callback);
    this.rpc.invoke(method, params, cb.successFn, cb.errorFn)
  }, save:function(data, callback) {
    this._callRpc("save", data, callback)
  }, load:function(key, callback) {
    this._callRpc("load", key, callback)
  }, remove:function(key) {
    this._callRpc("remove", key)
  }, clear:function() {
    this._callRpc("clear")
  }, destroy:function() {
  }, modify:function(key, cb, scope) {
    this.load(key, {success:function(storage) {
      var dump = {};
      WA.apply(dump, storage);
      cb.call(scope || window, storage);
      var res = U.Object.diff(dump, storage);
      if(res) {
        this.save(res)
      }
    }, scope:this})
  }, modifyObject:function(key, cb, scope) {
    this.modify(key, function(storage) {
      U.Object.each(storage, function(value, key) {
        if(value == "undefined") {
          value = "{}";
          U.Mnt.log({reason:"breaklog", text:"modifyObject2_fail: key=" + key})
        }
        storage[key] = JSON.parse(value || "{}")
      }, this);
      cb.call(scope || window, storage);
      U.Object.each(storage, function(value, key) {
        storage[key] = JSON.stringify(value)
      }, this)
    })
  }});
  WebAgent.Storage = new Storage;
  WebAgent.AccountStorage = WebAgent.Storage;
  WebAgent.HugeStorage = new Storage("HugeStorage");
  var SessionStorage = WA.extend(Storage, {_ifSessionExist:function(cb, elseCb, scope) {
    if(WA.ConnectionFacade) {
      WA.ConnectionFacade.getSessionId(function(session) {
        if(session == null || session == "") {
          elseCb.call(scope || window)
        }else {
          cb.call(scope || window, session)
        }
      }, this)
    }else {
      if(WA.isDebug) {
        WA.error("OH SHI~")
      }
      WA.setTimeout(function() {
        cb.call(scope || window, session)
      }, 1)
    }
  }, save:function(data, callback) {
    this._ifSessionExist(function(session) {
      WA.util.Object.each(data, function(value, key) {
        value = session + ";" + value;
        data[key] = value
      });
      SessionStorage.superclass.save.call(this, data, callback)
    }, function() {
      var cb = this._createDelegatedCallbacks(callback);
      cb.errorFn()
    }, this)
  }, load:function(key, callback) {
    var topkey = key;
    this._ifSessionExist(function(session) {
      var cb = this._createDelegatedCallbacks(callback);
      SessionStorage.superclass.load.call(this, key, {success:function(storage) {
        if(WA.isObject(storage)) {
          var res = {};
          WA.util.Object.each(storage, function(value, key) {
            value = value || "";
            var i = WA.isString(value) ? value.indexOf(";") : -1;
            if(i > -1 && value.substr(0, i) == session) {
              res[key] = value.substr(i + 1)
            }else {
              res[key] = ""
            }
          });
          cb.successFn(res)
        }else {
          var i = storage.indexOf(";");
          if(storage.substr(0, i) == session) {
            cb.successFn(storage.substr(i + 1))
          }else {
            cb.successFn("")
          }
        }
      }, failure:cb.errorFn, scope:this})
    }, function() {
      var cb = this._createDelegatedCallbacks(callback);
      if(WA.isObject(key)) {
        var res = {};
        WA.util.Object.each(key, function(value) {
          res[value] = ""
        });
        cb.successFn(res)
      }else {
        cb.successFn("")
      }
    }, this)
  }});
  WebAgent.SessionStorage = new SessionStorage;
  WebAgent.HugeSessionStorage = new SessionStorage("HugeStorage")
})();
(function() {
  var WA = WebAgent;
  var U = WA.util;
  var FM = WA.extend(WA.Activatable, {constructor:function() {
    FM.superclass.constructor.call(this);
    this.focused = false;
    this.focusing = false;
    this.focusEvent = new U.Event;
    this.blurEvent = new U.Event;
    this.rpc = WA.rpc.Local.createRpc("FocusManager");
    this.rpc.remoteEvent.on(this._onRemoteEvent, this)
  }, _listenUserEvents:function() {
    if(!this.userEventsInited) {
      this.userEventsInited = true;
      WA.fly(window).on("focus", this._onWindowFocus, this)
    }
  }, _onWindowFocus:function() {
    this._tryToFocus()
  }, _onMouseMove:function() {
    this._tryToFocus()
  }, _focusingDone:function() {
    this.focusing = false
  }, _tryToFocus:function() {
    if(!this.focused && !this.focusing && this.isActive()) {
      this.focusing = true;
      this.rpc.invoke("tryToFocus")
    }
  }, _onRemoteEvent:function(method, params) {
    if("focus" === method) {
      this._focus()
    }else {
      if("blur" === method) {
        this._blur()
      }else {
        if("focusingDone" === method) {
          this._focusingDone()
        }
      }
    }
  }, _focus:function() {
    if(!this.focused && this.isActive()) {
      this.focused = true;
      this.focusEvent.fire()
    }
  }, _blur:function() {
    if(this.focused) {
      this.focused = false;
      this.blurEvent.fire()
    }
  }, activate:function(onActivate, scope, forceFocus) {
    this._listenUserEvents();
    var fn = WA.isFunction(onActivate) ? WA.createDelegate(onActivate, scope || this) : WA.emptyFn;
    return FM.superclass.activate.call(this, {fn:fn, forceFocus:forceFocus})
  }, _onActivate:function(params) {
    WA.getBody().on("mousemove", this._onMouseMove, this);
    this.rpc.invoke("activate", {forceFocus:params.forceFocus}, params.fn, params.fn);
    WA.debug.State.set("FM.activated", true)
  }, _onDeactivate:function() {
    WA.getBody().un("mousemove", this._onMouseMove, this);
    this._blur();
    this.rpc.invoke("deactivate");
    WA.debug.State.set("FM.activated", false)
  }, ifFocused:function(trueFn, elseFn, scope) {
    trueFn = trueFn || WA.emptyFn;
    elseFn = elseFn || WA.emptyFn;
    scope = scope || window;
    var successFn = WA.createDelegate(function(focused) {
      if(focused) {
        trueFn.call(this)
      }else {
        elseFn.call(this)
      }
    }, scope);
    var errorFn = function(e) {
      WA.debug.Console.debug("FocusManager.ifFocused() error: " + e)
    };
    this.rpc.invoke("ifFocused", null, successFn, errorFn)
  }});
  WA.FocusManager = new FM;
  var FocusBlurWorkaround = WA.extend(Object, {constructor:function() {
    this.focusEvent = new U.Event;
    this.blurEvent = new U.Event;
    this._intermediateFocus = document.hasFocus ? document.hasFocus() : false;
    this.focus = false;
    WA.fly(window).on("blur", this._onIntermediateBlur, this).on("focus", this._onIntermediateFocus, this);
    WA.getBody().on("mousedown", this._onIntermediateMouseMove, this).on("keydown", this._onIntermediateMouseMove, this);
    this._delayedFocusEvent = new U.DelayedTask({interval:100, fn:this._onFocusEvent, scope:this});
    this._delayedFocusEvent.start()
  }, _onMouseMove:function() {
    this._onIntermediateMouseMove()
  }, _onIntermediateMouseMove:function() {
    if(this._delayedFocusEvent.isStarted() && !this._intermediateFocus || !("_intermediateFocus" in this)) {
      this._intermediateFocus = true;
      this._delayedFocusEvent.stop();
      this._onFocusEvent()
    }
  }, _onIntermediateBlur:function(event) {
    this._intermediateFocus = false;
    this._delayedFocusEvent.start()
  }, _onIntermediateFocus:function(event) {
    this._intermediateFocus = true;
    this._delayedFocusEvent.start()
  }, _onFocusEvent:function() {
    this._delayedFocusEvent.stop();
    if(this.focus != this._intermediateFocus) {
      this.focus = this._intermediateFocus;
      if(this.focus) {
        this.focusEvent.fire()
      }else {
        this.blurEvent.fire()
      }
    }
  }, activate:function() {
    WA.getBody().on("mousemove", this._onMouseMove, this)
  }, deactivate:function() {
    WA.getBody().un("mousemove", this._onMouseMove, this)
  }});
  WA.WindowFocus = new FocusBlurWorkaround
})();
(function() {
  var WA = WebAgent;
  var U = WA.util;
  var COLORS = ["FF0000", "FF7373", "CA4242", "F47B5A", "990000", "FF6665", "FFA500", "FFD700", "F7A90D", "E69200", "FF9010", "BD954E", "FFEA00", "EFD54C", "DFEA07", "E1CB00", "D6D094", "B1EE78", "1CD920", "5DB82A", "81D8D0", "088DA5", "008000", "0092D0", "389BFF", "0099CC", "6897BB", "3E687A", "457FCF", "9CC7FF", "0166CC", "0000FF", "46C5FC", "4356BC", "73799B", "FC62B4", "800180", "B682D8", "B44FF2", "D852AE", "E8A2C4", "2F0E77"];
  var STATIC_DOMAIN = "avt.imgsmail.ru";
  var TPL_AVATAR = '<div class="icq-avatarbox {1}" style="{0}"></div>';
  var _imageCache = {};
  var _loadingCache = {};
  var _requestHash;
  var icqTypes = ["ceilBigBuddyIcon", "floorBigBuddyIcon", "floorLargeBuddyIcon"];
  var mailTypes = ["_avatarsmall", "_avatar", "_avatar128", "_avatarbig"];
  var typeSizes = {"_avatarsmall":45, "_avatar":90, "_avatar128":128, "_avatarbig":200};
  function _hashCode(str) {
    return U.String.crc32(str)
  }
  function getColor(email) {
    return"#" + COLORS[_hashCode(email) % 42]
  }
  function getStandardAgentSize(px) {
    var s;
    if(px <= 45) {
      s = "_avatarsmall"
    }else {
      if(px <= 90) {
        s = "_avatar"
      }else {
        if(px <= 128) {
          s = "_avatar128"
        }else {
          s = "_avatarbig"
        }
      }
    }
    return s
  }
  function getStandardSize(px) {
    var s;
    if(px <= 64) {
      s = "ceilBigBuddyIcon"
    }else {
      if(px <= 128) {
        s = "floorBigBuddyIcon"
      }else {
        s = "floorLargeBuddyIcon"
      }
    }
    return s
  }
  function createSymbolAvatar(symbol, color, size, invert) {
    var testCanvas = document.createElement("canvas");
    testCanvas.style.cssText = "position:absolute;left:-1000px;top:-1000px;width:" + size + "px;height:" + size + "px;";
    testCanvas.width = testCanvas.height = size;
    document.body.appendChild(testCanvas);
    testCanvas = testCanvas.getContext("2d");
    testCanvas.font = size * 3 / 4 + "px Arial";
    testCanvas.fillStyle = invert ? "#FFFFFF" : color;
    testCanvas.fillRect(0, 0, size, size);
    testCanvas.textAlign = "center";
    testCanvas.textBaseline = "middle";
    testCanvas.fillStyle = invert ? color : "#FFFFFF";
    testCanvas.fillText(symbol.toUpperCase(), size / 2, size / 2);
    var ava = testCanvas.canvas.toDataURL();
    testCanvas.canvas.parentNode.removeChild(testCanvas.canvas);
    return ava
  }
  var _letterCache = {};
  function getSymbolUrl(mail, nick, size, invert) {
    var id = (nick || "").substr(0, 4) + mail + size;
    if(!_letterCache[id]) {
      var firstSymbol = id.replace(/\s/g, "").charAt(0);
      var emo = WA.Emoji.shift(id, true);
      _letterCache[id] = createSymbolAvatar(emo || firstSymbol, getColor(mail), size || 90, invert)
    }
    return _letterCache[id]
  }
  function generateRequestHash() {
    _requestHash = Math.round(Math.random() * 1E5);
    WA.SessionStorage.save({avatar_hash:_requestHash})
  }
  function getRequestHash() {
    if(!_requestHash) {
      WA.SessionStorage.load(["avatar_hash"], {success:function(data) {
        if(data) {
          _requestHash = data["avatar_hash"]
        }
      }});
      if(!_requestHash) {
        generateRequestHash()
      }
    }
    return _requestHash
  }
  function loadAvatarImage(url, mail, uid, avatar, cb) {
    if(_loadingCache[url]) {
      return _loadingCache[url]
    }
    var rid = "" + WA.uniq();
    _loadingCache[url] = rid;
    var rnd = WA.isUIN(mail) || WA.MainAgent.isChat(mail) ? "&r=" + getRequestHash() : "?r=" + getRequestHash();
    U.DomHelper.testUrlAsImage(url.replace(/_avatar([a-z0-9]*)$/, "_mrimavatar$1") + rnd, function(_url, success, img) {
      if(_loadingCache[url] !== rid) {
        return
      }
      if(success) {
        avatar.url = _url;
        avatar.size = {width:img.width, height:img.height};
        _imageCache[url] = {url:_url, size:avatar.size};
        var icons = document.querySelectorAll(".icqAva_" + uid);
        for(var i = 0, l = icons.length;i < l;i++) {
          icons[i].style.cssText = "background-image:url(" + _url + ")"
        }
        delete _loadingCache[url];
        cb && cb.call(this, avatar)
      }
    });
    return uid
  }
  function _createAvatarHtml(style, cls) {
    return U.String.format(TPL_AVATAR, style, cls)
  }
  function applyDefaultAvatar(mail, size, avaEl) {
    var url = getSymbolUrl(mail, "", size || 200, false);
    avaEl.setStyle("background-image", "url(" + url + ")")
  }
  function makeAvatar(mail, nick, sizeType, avaEl) {
    mail = mail.replace("@uin.icq", "");
    var urlId = mail, parts = mail.match(/([^@]+)@(.+)/i), isChat = WA.MainAgent.isChat(mail), imageSize = null, avatar = {}, uid = "", size = typeSizes[sizeType] || 200, cls = [], realUrl = null, url = "";
    if(WA.isUIN(mail) || isChat) {
      sizeType = getStandardSize(size);
      realUrl = urlId = "//api.icq.net/expressions/get?s=" + WA.ACTIVE_MAIL + "&t=" + mail + "&f=native&type=" + sizeType
    }else {
      if(parts) {
        realUrl = urlId = "//" + STATIC_DOMAIN + "/" + parts[2] + "/" + parts[1] + "/" + sizeType
      }
    }
    if(_imageCache[urlId]) {
      imageSize = _imageCache[urlId].size;
      uid = mail.replace(/[\@\.]/g, "") + "_" + sizeType;
      url = _imageCache[urlId].url
    }else {
      if(urlId != mail) {
        uid = mail.replace(/[\@\.]/g, "") + "_" + sizeType;
        loadAvatarImage(urlId, mail, uid, avatar)
      }
      realUrl = getSymbolUrl(mail, nick, size, isChat);
      url = realUrl
    }
    if(avaEl) {
      avaEl.addClass("icqAva_" + uid)
    }
    uid && cls.push("icqAva_" + uid);
    avatar = {size:imageSize, url:url, className:cls.join(" "), realUrl:realUrl, toString:function() {
      return this.url
    }};
    return avatar
  }
  function _updateAvatar(urlId, mail, sizeType) {
    urlId = urlId + sizeType;
    if(_imageCache[urlId] || _loadingCache[urlId]) {
      delete _imageCache[urlId];
      delete _loadingCache[urlId]
    }
    if(urlId != mail) {
      var uid = mail.replace(/[\@\.]/g, "") + "_" + sizeType;
      if(document.querySelector(".icqAva_" + uid)) {
        loadAvatarImage(urlId, mail, uid, {})
      }
    }
  }
  function updateAvatar(mail, size) {
    mail = mail.replace("@uin.icq", "");
    var isChat = WA.MainAgent.isChat(mail), isUIN = WA.isUIN(mail);
    generateRequestHash();
    var urlId = mail, parts = mail.match(/([^@]+)@(.+)/i);
    if(isUIN || isChat) {
      urlId = "//api.icq.net/expressions/get?s=" + WA.ACTIVE_MAIL + "&t=" + mail + "&f=native&type="
    }else {
      if(parts) {
        urlId = "//" + STATIC_DOMAIN + "/" + parts[2] + "/" + parts[1] + "/"
      }else {
        return
      }
    }
    if(!size) {
      var types = isChat || isUIN ? icqTypes : mailTypes, l = types.length;
      while(l--) {
        _updateAvatar(urlId, mail, types[l])
      }
    }else {
      _updateAvatar(urlId, mail, isUIN || isChat ? getStandardSize(size) : getStandardAgentSize(size))
    }
  }
  WA.Ava = {make:makeAvatar, update:updateAvatar, getColor:getColor, makeDefault:applyDefaultAvatar};
  WA.makeAvatar = makeAvatar
})();
(function() {
  var WA = WebAgent, U = WA.util, S = WA.AccountStorage;
  var STATUS_MAX_LENGTH = 125;
  var STORAGE_KEY = "ystatuses";
  var OLD_SPRITE_STATUSES = ["offline", "yellow", "away", "dnd", "online", "invisible", "gray", "message-static", "auth", "typing", "chat", "status_chat", "unknown", "mobile", "message-blink", "tel", "message", "popup", "icq_away"];
  var XS = WA.extend(Object, {constructor:function() {
    this._statusIndex = {};
    U.Object.each(WA.data.Statuses, function(val, key) {
      if(val[0]) {
        this._statusIndex[val[0]] = key
      }
    }, this);
    this.updateEvent = new U.Event
  }, _onSyncTriggerEvent:function(syncRecord) {
    if(syncRecord.isChanged("data")) {
      var data = syncRecord.get("data");
      if(data) {
        U.Array.each(JSON.parse(data), function(xs, index) {
          U.Array.each(xs, function(value, i) {
          }, this)
        }, this);
        this.updateEvent.fire(this.currentStatuses)
      }
    }
  }, getState:function(status) {
    var state = "online";
    if(status == "invisible") {
      state = "invisible"
    }
    if(status == "offline") {
      state = "offline"
    }
    return state
  }, getMoodId:function(status) {
    if(status.indexOf("icq_") == -1) {
      status = "icq_" + status
    }
    return WA.data.Statuses[status][0]
  }, getMoodText:function(status) {
    if(status.indexOf("icq_") == -1) {
      status = "icq_" + status
    }
    return WA.tr("status." + status)
  }, decodeMood:function(str) {
    if(str.substr(0, 4) == "http") {
      str = (str.match(/\&id=([0-9a-f]+)\&/) || ["", ""])[1]
    }else {
      str = str.substr(4)
    }
    var moodId = U.String.hexDecode(str.substr(4));
    return this._statusIndex[moodId] ? this._statusIndex[moodId].substr(4) : ""
  }, decodeMoodTitle:function(str) {
    var title = U.String.hexDecode(str.substr(8));
    try {
      title = U.String.utf8Decode(title)
    }catch(e) {
      U.Mnt.flog("mood", str);
      if(WA.isProduction) {
        U.Mnt.catchException(e, "mood")
      }
    }
    return title
  }, getStatusTitle:function(status, title) {
    title = title || WA.tr("status." + status, {defaultNull:1}) || WA.tr("status.icq_" + status, {defaultNull:1}) || status;
    if(title == "undefined" && status == "offline") {
      title = WA.tr("status.offline")
    }
    return title
  }, buildCssClass:function(status, forceIcqStatus) {
    if(!status) {
      status = "online"
    }
    var internalStatus = status.indexOf("icq_") === 0;
    var isUIN = forceIcqStatus === true || internalStatus;
    if(!internalStatus && status != "message") {
      if(this._statusIndex[status]) {
        status = this._statusIndex[status]
      }else {
        if(isUIN || U.Array.indexOf(WebAgent.data.CommonMoods, status) > -1) {
          status = "icq_" + status
        }
      }
    }
    status = status.replace("mrim_", "");
    status = status.replace("gtalk_", "");
    if(status == "icq_gray" || status == "icq_auth") {
      status = "icq_unknown"
    }
    if(status == "auth") {
      status = "gray"
    }
    if(status != "message" && isUIN && status != "icq_away" && !WA.data.Statuses[status]) {
      status = "icq_online"
    }
    if(WA.data.Statuses[status]) {
      return"nwa-new-status icq-status_" + status
    }
    if(U.Array.indexOf(OLD_SPRITE_STATUSES, status) == -1) {
      status = "online"
    }
    return"nwa-old-status wa-cl-status-" + status
  }, eoc:null});
  WA.Statuses = new XS
})();
(function() {
  var WA = WebAgent;
  var U = WA.util;
  var EMOJI_SHORTCUTS = {"*+*":"1f469", ":-)":"1f600", ":)":"1f600", ":-D":"1f604", ":D":"1f604", ";-)":"1f609", ";)":"1f609", "8-)":"1f60e", ":-*":"1f618", ":*":"1f618", ":P":"1f61b", ":-P":"1f61b", "%-)":"1f61c", ":-(":"1f61f", ":(":"1f61f", "o_O":"1f633"};
  var EMOJI_REG_ALL = /\ud83c[\udde8-\uddfa]\ud83c[\udde7-\uddfa]|\ud83c[\udc04-\ude51]|\ud83c[\udf00-\udfff]|\ud83d[\udc00-\ude4f]|\ud83d[\ude80-\udeff]|[0-9]\u20e3|[\u203c-\u3299\ue50a\uf8ff\u00a9\u00ae]/g;
  var EMOJI_REG_FIRST = new RegExp("^(" + EMOJI_REG_ALL.source + ")");
  var EMOJI_FORMAT = '<img class="nwa-emoji_inline nwa-emo-{0}" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" unselectable="on" data-immutable="true">';
  var BIG_EMOJI_SPRITE_URL = WA.imagePath + "emoji/s";
  var BIG_EMOJI_NUMBER = 672 / 96;
  var Emoji = WA.Emoji = {};
  Emoji.insertSmile = function(smileNode) {
    var sel = U.Selection.getSelection(), range = sel.getRangeAt(0);
    range.insertNode(smileNode);
    range.setEndAfter(smileNode);
    range.collapse(false);
    sel.removeAllRanges();
    sel.addRange(range)
  };
  var escapeChars = function() {
    var chars = "(){}[]|+:*$?";
    var tmp = [];
    var i = 0;
    while(i < chars.length) {
      tmp.push("\\" + chars.charAt(i));
      i++
    }
    var re = new RegExp("(" + tmp.join("|") + ")", "g");
    return function(text) {
      return text.replace(re, "\\$1")
    }
  }();
  var smileShortcuts = [], shortcutCodes = {};
  U.Object.each(EMOJI_SHORTCUTS, function(val, key) {
    key = escapeChars(key);
    shortcutCodes[key] = val;
    smileShortcuts.push(key)
  }, this);
  Emoji.smileCodeLastRE = new RegExp("(" + smileShortcuts.join("|") + ")$");
  Emoji.smileAliasCheckRE = new RegExp("(" + smileShortcuts.join("|") + ")", "g");
  Emoji.recoilProccessedMessage = function() {
    var emojiCb = function(all, name) {
      return Emoji.nameToChar(name)
    };
    var emojiRegExp = /<img[^>]*class="[-_\w\d\s]*nwa\-emo\-([\-_\w\d]+)[^>]*>/gi;
    return function(text) {
      text = text.replace(emojiRegExp, emojiCb);
      text = text.replace(new RegExp("\x00", "g"), "");
      return text
    }
  }();
  Emoji.stripTagsRE = /<[^>]+>/g;
  Emoji.stripTagsExceptSmilesCb = function(m) {
    if(m.indexOf("nwa-emoji_inline") >= 0) {
      return m
    }
    return""
  };
  Emoji.stripTagsExceptSmiles = function(text) {
    return text.replace(Emoji.stripTagsRE, Emoji.stripTagsExceptSmilesCb)
  };
  Emoji.isEmojiSupported = function(name) {
    if(!Emoji.index) {
      Emoji.index = {};
      for(var i = 0;i < WA.data.EmojiSets.length;i++) {
        for(var j = 0, len = WA.data.EmojiData[WA.data.EmojiSets[i]].length;j < len;j++) {
          Emoji.index[WA.data.EmojiData[WA.data.EmojiSets[i]][j]] = 1
        }
      }
    }
    return!!Emoji.index[name]
  };
  Emoji.discover = function(s) {
    s = (s || "").replace(WA.Emoji.smileAliasCheckRE, function(ignored, code) {
      return WA.Emoji.shortcutToChar(code)
    });
    return WA.Emoji.parse(s)
  };
  Emoji.parse = function(s) {
    s = s || "";
    s = s.replace(EMOJI_REG_ALL, function(a) {
      var name = Emoji.getNameByCode(a);
      return name ? Emoji.nameToHTML(name) : a
    });
    return s
  };
  Emoji.shift = function(s, returnCode) {
    var ret = null;
    var a = EMOJI_REG_FIRST.exec(s || "");
    if(a) {
      ret = returnCode ? a[0] : Emoji.getNameByCode(a[0])
    }
    return ret
  };
  Emoji.getAvatarStyle = function(name, size) {
    var data = WA.data.EmojiBigData[name], spriteNewSize = BIG_EMOJI_NUMBER * size;
    return["background-size:" + spriteNewSize + "px " + spriteNewSize + "px", "background-image:url(" + BIG_EMOJI_SPRITE_URL + data[2] + ".png)", "background-position:-" + (data[0] * size + spriteNewSize) + "px -" + data[1] * size + "px"].join(";") + ";"
  };
  Emoji.getNameByCode = function(a) {
    var name;
    if(a.length == 4) {
      name = U.String.getCodePointAt(a) + "-" + U.String.getCodePointAt(a, 2)
    }else {
      if(a.length == 2 && a[1] == "â£") {
        name = a.charCodeAt(0).toString(16) + "-20e3"
      }else {
        name = U.String.getCodePointAt(a)
      }
    }
    if(name && Emoji.isEmojiSupported(name)) {
      Emoji.initSmiles();
      return name
    }
  };
  Emoji.codeToHTML = Emoji.nameToHTML = function(name) {
    return U.String.format(EMOJI_FORMAT, name)
  };
  Emoji.codeToClass = function(name) {
    return"nwa-emo-" + name
  };
  Emoji.shortcutToChar = function(cut) {
    return Emoji.nameToChar(EMOJI_SHORTCUTS[cut])
  };
  Emoji.nameToChar = function(name) {
    var chr, code = parseInt(name, 16);
    if(name.indexOf("-20e3") == 2) {
      chr = U.String.fromCharCode(parseInt(name.substr(0, 2), 16)) + "â£"
    }else {
      if(name.length = 11) {
        chr = U.String.fromCharCode(parseInt(name.substr(0, 5), 16)) + U.String.fromCharCode(parseInt(name.substr(6, 5), 16))
      }else {
        chr = U.String.fromCharCode(code)
      }
    }
    return chr
  };
  var smilesLoaded = false;
  Emoji.initSmiles = function() {
    if(smilesLoaded) {
      return
    }
    smilesLoaded = true;
    WA.log("##### initSmiles #####");
    var head = document.getElementsByTagName("head")[0];
    if(!head) {
      return
    }
    var el = head.getElementsByTagName("*")[0];
    if(!el) {
      return
    }
    var style = document.createElement("link"), cssFileName = WA.isRetina ? "emoji@2x.css" : "emoji.css";
    style.type = "text/css";
    style.rel = "stylesheet";
    style.href = WA.resDomain + WA.resPath + "/" + cssFileName;
    head.insertBefore(style, el)
  }
})();
(function() {
  var WA = WebAgent, U = WA.util;
  var MESSAGE_HTML = '<div data-action="sticker" data-pack="{0}" class="nwa-smile_sticker-wrap" style="background-image: url({1})"><sub data-type="sticker" data-id="{2}" style="display:none;"></sub></div>';
  var REMOVED_HTML = '<div class="nwa-smile_sticker-wrap"></div>';
  WA.Sticker = {_showcaseData:null, _contentData:null, _packs:{}, _content:{}, _requestedPacks:{}, _altPackList:null, _removedStickers:{}, showcaseDataReadyEvent:new U.Event, packDataReadyEvent:new U.Event, packInstalledEvent:new U.Event, packChangedEvent:new U.Event, loadErrorEvent:new U.Event, getShowcaseList:function() {
    return this._showcaseList
  }, getShowcasePreview:function(packId) {
    return this._packs[packId]
  }, getPackName:function(packId) {
    var name = "";
    if(this._packs[packId]) {
      name = this._packs[packId].name
    }else {
      if(this._altPackList) {
        U.Array.each(this._altPackList, function(set) {
          if(set.id == packId) {
            name = set.name;
            return false
          }
        }, this)
      }
    }
    return name
  }, isCustomPack:function(packId) {
    var ret = null;
    if(this._altPackList) {
      U.Array.each(this._altPackList, function(set) {
        if(set.id == packId) {
          ret = !!set.usersticker;
          return false
        }
      }, this)
    }
    return ret
  }, getAllPackContent:function() {
    return this._content
  }, getAltPackList:function() {
    return this._altPackList
  }, getBasePreviewUrl:function() {
    return this._basePreviewUrl || "//c.icq.com/store"
  }, getStickerPreviewUrl:function(packId, stickerId, minSize) {
    if(WA.isRetina) {
      minSize *= 2
    }
    var applicableSize = "small";
    if(minSize > 60) {
      applicableSize = "medium"
    }
    if(minSize > 90) {
      applicableSize = "large"
    }
    return this.getBasePreviewUrl() + "/stickers/" + packId + "/" + stickerId + "/preview/" + applicableSize
  }, getStickerUrl:function(packId, stickerId) {
    var applicableSize = "medium";
    if(WA.isRetina) {
      applicableSize = "large"
    }
    return this.getBasePreviewUrl() + "/stickers/" + packId + "/" + stickerId + "/" + applicableSize
  }, getPackIconUrl:function(packId, minSize) {
    if(WA.isRetina) {
      minSize *= 2
    }
    var applicableSize = "small";
    if(minSize > 90) {
      applicableSize = "medium"
    }
    if(minSize > 135) {
      applicableSize = "large"
    }
    return this.getBasePreviewUrl() + "/stickers/" + packId + "/listicon/" + applicableSize
  }, getStickerPickerIconUrl:function(packId, minSize) {
    if(WA.isRetina) {
      minSize *= 2
    }
    var applicableSize = "small";
    if(minSize > 32) {
      applicableSize = "medium"
    }
    if(minSize > 48) {
      applicableSize = "large"
    }
    return this.getBasePreviewUrl() + "/stickers/" + packId + "/sticker-picker/" + applicableSize
  }, getStickerCode:function(packId, stickerId) {
    return"ext:" + packId + ":sticker:" + stickerId
  }, _checkStickerIsAvailable:function(sId) {
    var a = sId.split(":");
    var url = this.getStickerUrl(a[1], a[3]);
    U.DomHelper.testUrlAsImage(url, function(url, res) {
      if(res === false) {
        this._removedStickers[sId] = 1;
        this.loadErrorEvent.fire(sId, url)
      }
    }, this)
  }, getStickerHTML:function(sId) {
    var a = sId.split(":");
    if(this._removedStickers[sId]) {
      return REMOVED_HTML
    }
    this._checkStickerIsAvailable(sId);
    return U.String.format(MESSAGE_HTML, a[1], this.getStickerUrl(a[1], a[3]), sId)
  }, _cbQueue:[], resetShowcaseData:function() {
    if(!this._showcaseRequesting) {
      this._forceShowcaseRequest = true
    }
  }, resetContentData:function() {
    this._forceContentRequest = true;
    this.requestContent()
  }, requestShowcase:function(cb, forceRequest) {
    forceRequest = forceRequest || this._forceShowcaseRequest || false;
    if(this._showcaseData && !forceRequest) {
      cb && cb();
      return
    }
    cb && this._cbQueue.push(cb);
    if(this._showcaseRequesting) {
      return
    }
    this._forceShowcaseRequest = false;
    this._showcaseRequesting = true;
    var _updateShowcaseData = function(data) {
      this._showcaseRequesting = false;
      this._showcaseData = data.data;
      this._showcaseList = this._showcaseData.top || [];
      this._packs = this._packs || {};
      U.Array.each(this._showcaseList, function(pack) {
        this._packs[pack.id] = pack
      }, this);
      while(this._cbQueue.length) {
        var cb = this._cbQueue.shift();
        cb.call()
      }
    }.bind(this);
    WA.StoreApi.getShowcase(_updateShowcaseData)
  }, requestPackInfo:function(packId, cb, forceRequest) {
    if(!forceRequest && this._packs[packId] && this._content && this._content[packId]) {
      cb && cb(true);
      return
    }
    if(this._requestedPacks[packId]) {
      return
    }
    this._requestedPacks[packId] = true;
    WA.StoreApi.getPackInfo(packId, function(data) {
      delete this._requestedPacks[packId];
      if(data && data.data) {
        var basePreviewUrl = data.base_url.replace(/^(https?\:)/, "");
        data = data.data;
        this._packs[data.id] = data;
        this._basePreviewUrl = this._basePreviewUrl || basePreviewUrl;
        this._content = {};
        this._content[data.id] = data.content
      }
      cb && cb(true)
    }.bind(this), function() {
      delete this._requestedPacks[packId];
      cb && cb(false)
    }.bind(this))
  }, requestContent:function(cb, forceRequest) {
    if(forceRequest) {
      this._forceContentRequest = true
    }
    if(this._contentData && !this._forceContentRequest) {
      this.packDataReadyEvent.fire();
      cb && cb(this._contentData);
      return
    }
    this._forceContentRequest = false;
    WA.StoreApi.getContent(function(data) {
      var sets = data.stickers.sets;
      this._basePreviewUrl = data.base_url.replace(/^(https?\:)/, "");
      this._altPackList = data.stickers.sets;
      this._contentData = data;
      this._content = {};
      U.Array.each(sets, function(set) {
        this._content[set.id] = set.content
      }, this);
      this.packDataReadyEvent.fire();
      cb && cb()
    }.bind(this), function() {
      this.packDataReadyEvent.fire()
    }.bind(this))
  }, isPackInstalled:function(packId, cb) {
    this.requestShowcase(function() {
      var installed = false;
      if(this._showcaseList) {
        U.Array.each(this._showcaseList, function(pack) {
          if(pack.id == packId) {
            installed = pack.purchased;
            return false
          }
        }, this)
      }
      cb && cb(installed)
    }.bind(this))
  }, requestInstallPack:function(packId, storeId, cb) {
    WA.StoreApi.installPack(storeId, function(data) {
      if(data.status == 200) {
        this._forceShowcaseRequest = true;
        this._forceContentRequest = true;
        this.packInstalledEvent.fire(packId);
        this.packChangedEvent.fire(packId, false)
      }
      cb && cb(data)
    }.bind(this))
  }, requestRemovePack:function(packId, cb) {
    WA.StoreApi.removePack(packId, function(data) {
      if(data.status == 200) {
        this._forceShowcaseRequest = true;
        this._forceContentRequest = true;
        this.packInstalledEvent.fire(packId);
        this.packChangedEvent.fire(packId, false)
      }
      cb && cb(data)
    }.bind(this))
  }}
})();
(function() {
  var WA = WebAgent, U = WA.util, Us = U.String;
  var PREVIEW_MIN_HEIGHT = 48;
  var PREVIEW_MAX_HEIGHT = 1E3;
  var PREVIEW_MIN_WIDTH = 48;
  var PREVIEW_ARTICLE_MIN_HEIGHT = 80;
  var DIRECT_ARTICLE_MAX_WIDTH = 220;
  var DIRECT_ARTICLE_MIN_WIDTH = 200;
  var PREVIEW_ARTICLE_MIN_WIDTH = 220;
  var IMAGE_PREVIEW_HTML = '<div style="{img_style}" class="icq-snippet__image {img_cls}"></div>';
  var FILE_PREVIEW_HTML = '<div style="{file_style}" class="icq-snippet__file"></div>';
  var SNIPPET_BOX_HTML = '<div class="icqSnippet icq-snippet {wrap_cls}" style="{wrap_style}" data-content="{content_type}" data-url="{data_url}">                    <a class="icq-snippet__link icqSnippetLink" rel="nofollow noopener noreferrer" target="_blank" href="{url}">                        {preview}                        <div class="icq-snippet__title">                            <span>{title}</span>                            <div class="icq-snippet__domain" style="{domain_style}">{domain}</div>                        </div>                    </a>                    <div class="nwa-button icq-snippet__forward icqForward" data-url="{data_url}"></div>                </div>';
  var _loadingCache = {};
  WA.snippet = {FLAG_TEXT_MIX:1, FLAG_TEXT_BEFORE:2, FLAG_TEXT_AFTER:4, loadEvent:new U.Event, _infoCache:{}, urlHasSnippet:function(url) {
    var info = this._infoCache[url];
    return!!(info && (info.contentType == "file" || info.images || info.title))
  }, _fetchUrlObj:function(url, info) {
    return{reqUrl:url, contentType:info.content_type, domain:info.domain || "", title:info.title || "", favicon:info.favicon && Us.ensureHttpsUrl(info.favicon[0].preview_url) || null, snippet:info.snippet, images:info.images}
  }, _requestSnippetInfo:function(url, infoCallback) {
    if(this._infoCache[url]) {
      infoCallback && infoCallback(this._infoCache[url]);
      return this._infoCache[url]
    }
    if(_loadingCache[url]) {
      return
    }
    _loadingCache[url] = 1;
    WA.SnippetAPI.getUrlInfo(url, function(info) {
      if(info) {
        this._infoCache[url] = this._fetchUrlObj(url, info)
      }
      delete _loadingCache[url];
      infoCallback && infoCallback(this._infoCache[url]);
      this.loadEvent.fire(url)
    }.bind(this))
  }, getPreviewCode:function(url, infoCallback, flags) {
    var urlInfo = this._requestSnippetInfo(url, infoCallback);
    if(urlInfo) {
      return this.generateHTML(url, flags) || ""
    }
  }, getTitle:function(url, infoCallback) {
    var urlInfo = this._requestSnippetInfo(url, infoCallback);
    return urlInfo && urlInfo.title || ""
  }, generateHTML:function(url, flags) {
    var info = this._infoCache[url];
    if(!info || info.error) {
      return""
    }
    flags = flags || 0;
    var blockMaxWidth = WA.DialogsAgent.getMediaBlockMaxSize();
    var blockMinWidth = PREVIEW_MIN_WIDTH;
    var blockMaxHeight = PREVIEW_MAX_HEIGHT;
    var blockMinHeight = PREVIEW_MIN_HEIGHT;
    var isDirectMediaLink = info.contentType == "image" || info.contentType == "gif" || info.contentType == "video";
    var isDirectDomainLink = info.contentType == "article" && url.match(/^https?:\/\/[\w\.-]+\/?$/i);
    if(isDirectMediaLink) {
      info.title = ""
    }else {
      if(info.contentType == "file") {
        info.title = info.title || url
      }
    }
    if(!info.images && !info.title) {
      return""
    }
    var _previewHTML = "", wrapContainerWidth = blockMaxWidth;
    if(info.images) {
      if(flags & WA.snippet.FLAG_TEXT_MIX) {
        blockMinHeight = blockMinWidth = blockMaxHeight = blockMaxWidth
      }else {
        if(isDirectDomainLink && blockMaxWidth > DIRECT_ARTICLE_MAX_WIDTH) {
          blockMaxWidth = DIRECT_ARTICLE_MAX_WIDTH
        }
        if(!isDirectMediaLink) {
          blockMinWidth = isDirectDomainLink ? DIRECT_ARTICLE_MIN_WIDTH : PREVIEW_ARTICLE_MIN_WIDTH
        }
        if(blockMinWidth > blockMaxWidth) {
          blockMinWidth = blockMaxWidth
        }
        if(!isDirectMediaLink) {
          blockMinHeight = PREVIEW_ARTICLE_MIN_HEIGHT;
          blockMaxHeight = blockMaxWidth
        }
      }
      var w = info.images[0].preview_width, h = info.images[0].preview_height, k = h / w, isVerticalImage = k >= 1, previewWidth = w, previewBlockWidth, previewHeight = h, previewBlockHeight;
      if(previewWidth > blockMaxWidth) {
        previewWidth = blockMaxWidth;
        previewHeight = Math.floor(k * previewWidth)
      }
      if(previewHeight > blockMaxHeight || previewHeight < blockMinHeight) {
        previewHeight = previewHeight > blockMaxHeight ? blockMaxHeight : blockMinHeight;
        previewWidth = Math.floor(previewHeight / k)
      }
      if(previewWidth < blockMinWidth) {
        previewWidth = blockMinWidth;
        previewHeight = Math.floor(k * previewWidth)
      }
      previewBlockWidth = previewWidth > blockMaxWidth ? blockMaxWidth : previewWidth;
      previewBlockHeight = previewHeight > blockMaxHeight ? blockMaxHeight : previewHeight;
      _previewHTML = U.String.parseTemplate(IMAGE_PREVIEW_HTML, {url:Us.ensureHttpsUrl(info.images[0].preview_url), img_cls:info.contentType.indexOf("video") > -1 ? "icq-snippet__play" : "", img_style:"background-image: url(" + Us.ensureHttpsUrl(info.images[0].preview_url) + ");background-size: " + previewWidth + "px auto;width:" + previewBlockWidth + "px;height:" + previewBlockHeight + "px"});
      wrapContainerWidth = previewBlockWidth
    }else {
      if(info.contentType == "file") {
        _previewHTML = U.String.parseTemplate(FILE_PREVIEW_HTML, {file_style:"width:" + wrapContainerWidth + "px"})
      }
    }
    var wrapCls = "";
    wrapCls += info.images ? " icq-snippet_image" : "";
    wrapCls += info.title ? " icq-snippet_title" : "";
    wrapCls += info.domain ? " icq-snippet_domain" : "";
    wrapCls += info.favicon ? " icq-snippet_favicon" : "";
    wrapCls += flags & WA.snippet.FLAG_TEXT_AFTER ? " icq-snippet_underline" : "";
    wrapCls += flags & WA.snippet.FLAG_TEXT_BEFORE && !info.images ? " icq-snippet_aboveline" : "";
    return U.String.parseTemplate(SNIPPET_BOX_HTML, {url:info.reqUrl, content_type:info.contentType, data_url:encodeURIComponent(info.reqUrl), preview:_previewHTML, title:Us.htmlEntity(info.title || ""), domain:info.domain || "", domain_style:info.favicon ? "background-image:url(" + info.favicon + ");" : "", wrap_cls:wrapCls, wrap_style:"width: " + wrapContainerWidth + "px;"})
  }}
})();
WebAgent.XDRequest = function() {
  var WA = WebAgent;
  var extend = WA.extend;
  var JSON = WA.getJSON();
  var SERVER_PROVIDER_VERSION = 10;
  var LOCALHOST_PARAMS = "usedBranch=master&path=" + encodeURIComponent("webim/agent/release/501") + "&xdm_e=http%3A%2F%2Fwebagent.localhost.mail.ru&xdm_c=default1&xdm_p=1";
  var XDXHR = extend(Object, {constructor:function(domain) {
  }, request:function(opts, cb, cbError) {
  }});
  var XHRViaEasyXDM = extend(Object, {constructor:function(domain) {
    this._domain = domain;
    this._reloadInterval = 1E3;
    this._reloadMaxInt = 1 * 60 * 1E3;
    this._isReady = false;
    this._requests = [];
    this._rpc = new easyXDM.Rpc({remote:"https://" + domain + "/communicate.html?build=" + SERVER_PROVIDER_VERSION + "&" + (WA.isLocalhost ? LOCALHOST_PARAMS : WA.resProps), acl:"^https?:\\/\\/[\\w\\.]+\\.mail\\.ru(?:[\\/\\?].*)?$", onLoadSrc:WA.createDelegate(function() {
      if(!this._isReady) {
        clearTimeout(this._startWaitingTimer);
        this._readyTimer = WA.setTimeout(function() {
          this._onNotReadyFrame()
        }, 1E3, this)
      }
    }, this), onReady:WA.createDelegate(function() {
      WA.debug.Console.log("onReady", this._isReady);
      clearTimeout(this._readyTimer);
      clearTimeout(this._retryTimer);
      clearTimeout(this._startWaitingTimer);
      this._isReady = true;
      this._reloadInterval = 1E3;
      WA.util.Array.each(this._requests, function(it) {
        this._rpc.request(it.opts, function(resp) {
          it.cb.apply(window, arguments);
          if(resp.status != 200) {
          }
        }, it.er)
      }, this);
      this._requests = []
    }, this)}, {remote:{request:{}}});
    this._startWaiting()
  }, _startWaiting:function() {
    this._startWaitingTimer = WA.setTimeout(function() {
      if(!this._isReady) {
        this._onNotReadyFrame()
      }
    }, 5E3, this)
  }, _refreshFrame:function() {
    this._rpc.refreshFrame();
    this._startWaiting()
  }, _onNotReadyFrame:function() {
    WA.debug.Console.log("_onNotReadyFrame", this._isReady);
    if(this._isReady) {
      return
    }
    var interval = this._reloadInterval * 2 < this._reloadMaxInt ? this._reloadInterval *= 2 : this._reloadMaxInt;
    WA.util.Array.each(this._requests, function(it) {
      it.er({data:{status:418, errorData:{reconnect_timeout:interval}}})
    });
    this._requests = [];
    clearTimeout(this._startWaitingTimer);
    this._retryTimer = WA.setTimeout(function() {
      this._refreshFrame()
    }, interval, this)
  }, request:function(opts, cb, cbError, scope) {
    cb = WA.createDelegate(cb || function() {
    }, scope);
    var log = function(resp) {
    };
    opts.data || (opts.data = {});
    opts.data["x-email"] = WA.ACTIVE_MAIL;
    var cbErrorWrapped = WA.createDelegate(function(resp) {
      cbError && cbError.call(scope || window, resp.data);
      log(resp.data)
    }, scope);
    if(this._isReady) {
      this._rpc.request(opts, function(resp) {
        cb.apply(window, arguments);
        if(resp.status != 200) {
          log(resp)
        }
      }, cbErrorWrapped)
    }else {
      this._requests.push({er:cbErrorWrapped, cb:cb, opts:opts})
    }
  }});
  var XDR = function() {
    this._XHR = XHRViaEasyXDM
  };
  XDR.prototype = {_XHR:false, _domains:{}, getInstance:function(domain) {
    if(!this._domains[domain]) {
      this._domains[domain] = new this._XHR(domain)
    }
    return this._domains[domain]
  }};
  return new XDR
}();
WebAgent.namespace("WebAgent.conn");
(function() {
  var WA = WebAgent;
  var U = WA.util;
  var k = "ic1pzYNtEU6dDnEQ";
  var SESSION_TIMEOUT = 60 * 5;
  var caps = "09461358-4C7F-11D1-8222-444553540000";
  var LANG_MAP = {ru:"ru-RU", uk:"uk-UA"};
  var API_HOST = "https://icqapi.mail.ru/";
  var RAPI_HOST = "rapi.mail.ru";
  var PYMK_HOST = "pymk.mail.ru";
  var LOGIN_URL = "https://icq.com/siteim/icqbar/php/proxy_jsonp.php";
  var LOGIN_GATE_URL = "https://icqapilogin.mail.ru/auth/mrimLogin";
  var LOGIN_GATE_HOST = "icqapilogin.mail.ru";
  var LOGIN_GATE_PAGE = "/auth/mrimLogin";
  var GET_TOKEN_URL = "https://icq.com/siteim/icqbar/php/proxy_jsonp_connect.php";
  var PHONE_URL = "https://www.icq.com/smsreg/requestPhoneValidation.php";
  var ATTACH_PHONE_URL = "https://www.icq.com/smsreg/attachPhoneNumber.php";
  var CODE_URL = "https://www.icq.com/smsreg/loginWithPhoneNumber.php";
  var STATISTICS_URL = "https://stat.icq.in/stat";
  var SENDIM_METHOD_POST = true;
  var FETCH_EVENTS_TIMEOUT = 3E4;
  var locale = LANG_MAP[(WA.useLang || "ru").substr(0, 2).toLowerCase()];
  var deviceId;
  var selfProfileUniq;
  var dialogEventsList = ["bday", "addedToBuddyList", "buddyReg", "buddyFound", "voip"];
  function encodeURIComponentFull(s) {
    return encodeURIComponent(s).replace(/\~/g, "%7E").replace(/\(/g, "%28").replace(/\)/g, "%29").replace(/\!/g, "%21").replace(/\'/g, "%27").replace(/\*/g, "%2A")
  }
  function getXhr() {
    return new XMLHttpRequest
  }
  function getDeviceId(cb) {
    if(deviceId) {
      return cb()
    }
    WA.Storage.modify(["icqDeviceId"], function(s) {
      deviceId = s.icqDeviceId;
      if(!deviceId) {
        deviceId = [Math.random().toString(16).substring(2, 8), Math.random().toString(16).substring(2, 14).replace(/(.{4})(?=.)/g, "$1-"), Math.random().toString(16).substring(2, 14)].join("-");
        s.icqDeviceId = deviceId
      }
      cb()
    })
  }
  function getSessionData(cb, scope) {
    WA.Storage.modifyObject(["icqConnect"], function(s) {
      cb.call(scope || null, s.icqConnect)
    })
  }
  function resetSessionData(cb, scope) {
    WA.Storage.remove(["icqConnect"], function() {
      cb.call(scope || null)
    })
  }
  function createReqId() {
    return WA.uniq() + "-" + WA.now()
  }
  function makeSignedUrl(url, params, method, signKey) {
    method = method || "GET";
    var keys = Object.keys(params).sort();
    var get = [];
    for(var i = 0;i < keys.length;i++) {
      var k = keys[i];
      get[get.length] = k + "=" + encodeURIComponent(params[k])
    }
    get = get.join("&");
    if(signKey) {
      var baseString = method + "&" + encodeURIComponent(url) + "&" + encodeURIComponent(get);
      var shaObj = new WA.jsSHA(baseString, "TEXT");
      var sig_sha256 = shaObj.getHMAC(signKey, "TEXT", "SHA-256", "B64");
      get = get + "&sig_sha256=" + encodeURIComponent(sig_sha256)
    }
    var sep = url.indexOf("?") > 0 ? "&" : "?";
    return url + sep + get
  }
  function signUrl(url, params, method, cb, scope) {
    getSessionData(function(s) {
      params = WA.applyIf(params || {}, {a:s.a, k:k, client:"icq", ts:WA.nowFixed()});
      url = makeSignedUrl(url, params, method || "GET", s.sessionKey);
      cb.call(scope || null, url)
    })
  }
  function makeJsonpRequest(url, params, callbackParamName, callback, scope, onError, signKey) {
    var uniq = "c" + WA.uniq();
    var cbUniqName = "jscb_tmp_" + uniq;
    var scriptUrl = "";
    var timer;
    params = params || {};
    params[callbackParamName] = "WebAgent." + cbUniqName;
    WA[cbUniqName] = function(data) {
      if(timer) {
        clearTimeout(timer)
      }
      delete WA[cbUniqName];
      U.Mnt.wrapTryCatch(function() {
        callback && callback.call(scope || window, data)
      });
      var script = document.querySelector('script[src="' + scriptUrl + '"]');
      if(script) {
        document.body.removeChild(script)
      }
    };
    var script = WA.getBody().dom.appendChild(document.createElement("script"));
    WA.get(script).on("error", function(e) {
      if(timer) {
        clearTimeout(timer)
      }
      onError && onError.call(scope || window, e)
    }, WA);
    script.type = "text/javascript";
    var keys = Object.keys(params).sort();
    var get = [];
    for(var i = 0;i < keys.length;i++) {
      var k = keys[i];
      get[get.length] = k + "=" + encodeURIComponentFull(params[k])
    }
    get = get.join("&");
    if(signKey) {
      var baseString = "GET&" + encodeURIComponentFull(url) + "&" + encodeURIComponentFull(get);
      var shaObj = new WA.jsSHA(baseString, "TEXT");
      var sig_sha256 = shaObj.getHMAC(signKey, "TEXT", "SHA-256", "B64");
      get = get + "&sig_sha256=" + encodeURIComponentFull(sig_sha256)
    }
    var sep = url.indexOf("?") > 0 ? "&" : "?";
    scriptUrl = url + sep + get;
    script.src = scriptUrl;
    return uniq
  }
  function clearJsonpRequest(rid) {
    var cbUniqName = "jscb_tmp_" + rid;
    if(WA[cbUniqName]) {
      WA.log("TRY TO CLEAR ACTIVE REQUEST: " + rid);
      return
    }
    return delete WA[cbUniqName]
  }
  function chainParams(params) {
    params = params || {};
    var pairs = [];
    Object.keys(params).forEach(function(key) {
      pairs.push(encodeURIComponent(key) + "=" + encodeURIComponent(params[key]))
    });
    return pairs.join("&")
  }
  function transformIcqUin(uin, back) {
    if(back) {
      if(uin.indexOf("@uin.icq") !== -1) {
        uin = uin.replace("@uin.icq", "")
      }
    }else {
      if(uin.indexOf("@") === -1 && uin.charAt(0) !== "+") {
        uin = uin + "@uin.icq"
      }
    }
    return uin
  }
  function parseHistoryMessage(el, uin, persons, chatModifiedEvents, chatMemberEvents, buddyInfo, theirsLastDelivered, theirsLastRead) {
    el.time = WA.getFixedTS(el.time);
    if(el.chat && el.chat.sender) {
      el.chat.sender = transformIcqUin(el.chat.sender)
    }
    var fromEmail = el.outgoing ? WA.ACTIVE_MAIL : uin, sender = el.chat && !el.outgoing ? el.chat.sender || fromEmail : fromEmail, text = el.text || "", state = "5", arch_id = el.msgId, timestamp = el.time, isEvent = el["class"] === "event", eventInfo, eventType;
    if(theirsLastDelivered && theirsLastRead) {
      if(theirsLastDelivered < arch_id) {
        state = 3
      }else {
        if(theirsLastRead < arch_id) {
          state = 4
        }
      }
    }
    var senderFriendly = WA.CLD.getFriendlyName(sender) || persons[sender] && persons[sender].friendly || buddyInfo[sender] && buddyInfo[sender].friendly;
    if(el.chat) {
      el.chat.mail = uin;
      el.chat.timestamp = timestamp;
      el.chat.msgId = arch_id;
      el.chat.eventTypeId = el.eventTypeId;
      if(text) {
        if(el.chat.modifiedInfo || el.chat.memberEvent) {
          el["class"] = "event";
          isEvent = true
        }
        if(el.chat.memberEvent) {
          chatMemberEvents.push(["chatMember", el.chat])
        }else {
          if(el.chat.modifiedInfo || isEvent) {
            chatModifiedEvents.push(["chatModified", el.chat])
          }
        }
      }else {
        if(el.chat.memberEvent) {
          if(el.chat.memberEvent.members) {
            isEvent = true;
            eventType = el.chat.memberEvent.type;
            chatMemberEvents.push(["chatMember", el.chat]);
            var members = [];
            U.Array.each(el.chat.memberEvent.members, function(it, i) {
              el.chat.memberEvent.members[i] = it = transformIcqUin(it);
              members.push(WA.CLD.getFriendlyName(it) || persons[it] && persons[it].friendly || it)
            });
            var self = (el.chat.memberEvent.members.join(",").replace(/\@uin\.icq/g, "") + ",").indexOf(sender.replace("@uin.icq", "") + ",") > -1;
            eventInfo = {members:members, self:self, sender:senderFriendly || sender}
          }
        }else {
          if(el.chat.modifiedInfo) {
            el.chat.mail = uin;
            chatModifiedEvents.push(["chatModified", el.chat]);
            if(el.chat.modifiedInfo.name || el.chat.modifiedInfo.about) {
              isEvent = true;
              eventType = el.chat.modifiedInfo.name ? "rename" : "modify";
              eventInfo = {name:el.chat.modifiedInfo.name, about:el.chat.modifiedInfo.about, sender:senderFriendly || sender}
            }else {
              if(el.chat.modifiedInfo.avatarLastModified) {
                isEvent = true;
                eventType = "changeIcon";
                eventInfo = {sender:senderFriendly || sender}
              }
            }
          }
        }
      }
    }
    if(isEvent && !eventInfo) {
      U.Array.each(dialogEventsList, function(key) {
        if(el[key]) {
          eventType = key;
          eventInfo = {sender:el.outgoing ? WA.CLD.getFriendlyName(uin) || buddyInfo[uin] && buddyInfo[uin].friendly || persons[uin] && persons[uin].friendly || uin : senderFriendly || sender};
          eventInfo[key] = el[key];
          return false
        }
      }, this)
    }
    if(el.parts) {
      U.Array.each(el.parts, function(it) {
        if(it.sn) {
          it.sn = transformIcqUin(it.sn);
          it.friendly = it.friendly || persons[it.sn] && persons[it.sn].friendly || WA.CLD.getFriendlyName(it.sn)
        }
      })
    }
    var msg = {from:fromEmail, sender:sender, senderFriendly:senderFriendly, timestamp:timestamp, arch_id:arch_id, state:state, event:eventType || isEvent, info:eventInfo, hidden:!!el.hidden, parts:el.parts, parse:el.parse, wid:el.wid, mid:el.msgId, text:text};
    if(el.chat && el.chat.modifiedInfo) {
      msg.modifiedInfo = el.chat.modifiedInfo
    }
    WimIdCache[el.msgId] = el.wid;
    if(el.sticker) {
      msg.sticker = el.sticker.id
    }
    return msg
  }
  var WimIdCache = WA.WimIdCache = {};
  var EventGuide = WA.extend(Object, {_buddyInfo:{}, _statusGuide:{"icq":{"away":"away", "na":"dnd", "occupied":"dnd", "offline":"offline", "online":"online", "unknown":"gray", "invisible":"invisible", "mobile":"mobile"}, "mra":{"away":"away", "dnd":"occupied", "offline":"offline", "online":"online"}, "fb":{"offline":"offline", "online":"online"}}, translateEvent:new U.Event, eachEvent:function(events, cb, scope) {
    var resultEvents = [];
    U.Array.each(events, function(event) {
      resultEvents = resultEvents.concat(this._translateEvent(event, cb, scope) || [])
    }, this);
    return resultEvents
  }, translateResponse:function(method, data) {
    var resultEvents = [], uniq = data.uniq || 0, buddies = [];
    switch(method) {
      case "presence/get":
        if(data.users) {
          U.Array.each(data.users, function(item) {
            resultEvents.push(["contactStatus", this._fetchBuddyContactStatus(item)])
          }, this)
        }
        if(data.groups) {
          this._cacheBuddies(data.groups);
          resultEvents.push(["contactList", this._makeClist()])
        }
        break;
      case "buddylist/addBuddy":
        U.Array.each(data.results || [], function(res) {
          if(res.buddy) {
            res.buddy = transformIcqUin(res.buddy)
          }
          if(res.resultCode == 0) {
            resultEvents.push(["contactAddSuccess", {email:res.buddy}])
          }else {
            resultEvents.push(["contactAddFail", {email:res.buddy, message:"exists"}])
          }
        }, this);
        break;
        break;
      case "im/sendIM":
        if(data.msgId && data.uniq) {
          resultEvents.push(["messageSent", {message_id:data.uniq, wimId:data.msgId, arch_id:data.histMsgId, time:data.ts}])
        }
        break;
      case "im/sendSticker":
        if(data.msgId && data.uniq) {
          resultEvents.push(["messageSent", {message_id:data.uniq, wimId:data.msgId, arch_id:data.histMsgId, time:data.ts}])
        }
        break;
      case "presence/setState":
        if(data.myInfo) {
          if(data.myInfo.state) {
            resultEvents.push(["myInfo", this.fetchMyInfo(data.myInfo)])
          }
        }
        break;
      case "memberDir/get":
        if(data.infoArray) {
          U.Array.each(data.infoArray, function(profile) {
            var buddy = this._makeBuddy(profile.profile);
            if(selfProfileUniq && uniq == selfProfileUniq) {
              selfProfileUniq = null;
              resultEvents.push(["wpSelf", buddy])
            }
            resultEvents.push(["wp", {uniq:uniq, result:[buddy]}])
          }, this)
        }
        break;
      case "memberDir/search":
        if(data.results) {
          if(data.results.infoArray && data.results.nTotal > 0) {
            U.Array.each(data.results.infoArray, function(profile) {
              buddies.push(this._makeBuddy(profile.profile))
            }, this)
          }
          resultEvents.push(["wp", {uniq:uniq, result:buddies}])
        }
        break;
      case "aim/endSession":
        resultEvents.push(["logout", {}]);
        break;
      case "getChatHome":
        resultEvents.push(["liveChats", data]);
        break;
      case "getChatInfo":
        var uins = [];
        U.Array.each(data.members, function(it, n, arr) {
          it.sn = transformIcqUin(it.sn);
          uins.push(it.sn);
          arr[n] = U.Object.extend({email:it.sn, role:it.role || "member"}, it.anketa || {})
        });
        data.membersList = uins;
        resultEvents.push(["chatInfo", data]);
        break;
      case "getChatBlocked":
        U.Array.each(data.list, function(it, i, arr) {
          it.sn = transformIcqUin(it.sn);
          arr[i] = U.Object.extend({email:it.sn}, it.anketa || {})
        });
        data.sn = transformIcqUin(data.requestParams.sn);
        resultEvents.push(["blockedMembers", data]);
        break;
      case "createChat":
        break;
      case "getHistory":
        if(data.messages) {
          var uin = transformIcqUin(data.requestParams.sn);
          var historyBack = data.requestParams.count == -20;
          var theirsLastRead, theirsLastDelivered;
          var historyObj = {email:uin, lastRead:data.yours && data.yours.lastRead || null, historyBack:historyBack, history:[], patchVersion:data.patchVersion, patchRequested:data.requestParams.count == 1 || data.requestParams.count == -1 && data.requestParams.fromMsgId == -1, getModifiedMsg:data.requestParams.tillMsgId};
          if(data.theirs) {
            historyObj.theirs = data.theirs;
            theirsLastRead = data.theirs.lastRead;
            theirsLastDelivered = data.theirs.lastDelivered
          }
          if(data.requestParams.patchVersion !== "init") {
            historyObj.patch = data.patch
          }
          var chatMemberEvents = [];
          var chatModifiedEvents = [];
          var persons = {}, msg;
          U.Array.each(data.persons || [], function(it) {
            it.sn = transformIcqUin(it.sn);
            persons[it.sn] = {aimId:it.sn, friendly:it.friendly}
          });
          historyObj.persons = persons;
          U.Array.each(data.messages, function(el) {
            msg = parseHistoryMessage(el, uin, persons, chatModifiedEvents, chatMemberEvents, this._buddyInfo, theirsLastDelivered, theirsLastRead);
            historyObj.history.push(["message", msg])
          }, this);
          if(chatMemberEvents.length) {
            data.chatMemberEvents = chatMemberEvents
          }
          if(chatModifiedEvents.length) {
            data.chatModifiedEvents = chatModifiedEvents
          }
          resultEvents.push(["contactHistory", historyObj])
        }
        break;
      case "getPymk":
        var res = [];
        U.Array.each(data.pymk || [], function(it, i) {
          it.anketa.aimId = transformIcqUin(it.sn);
          it.anketa.friendlyName = it.anketa.nickname;
          it.anketa.aboutMe = it.anketa.aboutMeCut;
          it.anketa.homeAddress = [it.anketa];
          res[i] = this._makeBuddy(it.anketa);
          res[i].mutualFriends = it.mutualFriends;
          res[i].stamp = it.stamp
        }, this);
        resultEvents.push(["searchSuggests", {result:res, newTag:data.newTag, requestParams:data.requestParams}]);
        break;
      case "getSnapHome":
        resultEvents.push(["allSnaps", data]);
        break;
      case "getUserSnaps":
        resultEvents.push(["userSnaps", data])
    }
    return resultEvents
  }, _translateEvent:function(event) {
    var resultEvents = [], buddy;
    var eventData = event.eventData;
    switch(event.type) {
      case "buddylist":
        if(eventData.groups) {
          this._cacheBuddies(eventData.groups);
          resultEvents.push(["contactList", this._makeClist()])
        }
        break;
      case "permitDeny":
        if(eventData.ignores) {
          this._cacheIgnores(eventData.ignores);
          resultEvents.push(["permitDeny", eventData]);
          if(this.__cacheCL) {
            resultEvents.push(["contactList", this._makeClist()])
          }
        }
        break;
      case "typing":
        if(eventData.typingStatus != "typing") {
          break
        }
        eventData.aimId = transformIcqUin(eventData.aimId);
        var sender;
        if(eventData.MChat_Attrs && eventData.MChat_Attrs.sender) {
          if(eventData.MChat_Attrs.options && eventData.MChat_Attrs.options.senderName) {
            sender = eventData.MChat_Attrs.options && eventData.MChat_Attrs.options.senderName
          }else {
            sender = transformIcqUin(eventData.MChat_Attrs.sender)
          }
        }
        resultEvents.push(["typingNotify", {from:eventData.aimId, sender:sender, timestamp:WA.now(), composing:true, message_id:WA.uniq()}]);
        break;
      case "mchat":
        var res = [];
        U.Array.each(eventData.mchats || [], function(mchat) {
          if(mchat.method === "create") {
            res.push(mchat)
          }
        });
        resultEvents.push(["chatCreated", res]);
        break;
      case "hiddenChat":
        eventData.sn = transformIcqUin(eventData.aimId);
        resultEvents.push(["hiddenChat", eventData]);
        break;
      case "snapsEvent":
        resultEvents.push(["snapsEvent", eventData]);
        break;
      case "histDlgState":
        eventData.sn = transformIcqUin(eventData.sn);
        if(eventData.messages) {
          var histData = {messages:eventData.messages, persons:eventData.persons, requestParams:{sn:eventData.sn}, yours:eventData.yours};
          eventData.historyPart = this.translateResponse("getHistory", histData)[0][1]
        }
        eventData.persons && U.Array.each(eventData.persons, function(p) {
          resultEvents.push(["contactStatus", {email:p.sn, nickname:p.friendly}])
        });
        resultEvents.push(["historyState", eventData]);
        resultEvents.push(["archSync", {"with":eventData.sn, count:eventData.unreadCnt, starting:eventData.starting}]);
        if(histData) {
          if(histData.chatMemberEvents) {
            resultEvents.push.apply(resultEvents, histData.chatMemberEvents)
          }
          if(histData.chatModifiedEvents) {
            resultEvents.push.apply(resultEvents, histData.chatModifiedEvents)
          }
        }
        break;
      case "presence":
        resultEvents.push(["contactStatus", this._fetchBuddyContactStatus(eventData, true)]);
        break;
      case "myInfo":
        if(eventData.state) {
          resultEvents.push(["myInfo", this.fetchMyInfo(eventData)])
        }
        break;
      case "sessionEnded":
        resultEvents.push(["logout", {endCode:eventData.endCode, offReason:eventData.offReason}]);
        break;
      case "userAddedToBuddyList":
        eventData.requester = transformIcqUin(eventData.requester);
        var authValue = {from:eventData.requester, authRequested:eventData.authRequested, timestamp:WA.now(), nickname:eventData.displayAIMid || eventData.requester, text:eventData.msg || WA.tr("msgAddMePlease"), request:{authorize:!!eventData.authRequested, delivery:true}};
        resultEvents.push(["authRequest", authValue]);
        break;
      case "sentIM":
        break;
      case "imState":
        resultEvents.push(["imStates", eventData.imStates]);
        break;
      case "apps":
        if(eventData.appsData && eventData.appsData.store) {
          resultEvents.push(["storeCommand", eventData.appsData.store])
        }
        break;
      case "service":
      ;
      case "lifestream":
        break;
      default:
        WA.log("icq origin", event.type, event.eventData);
        break
    }
    return resultEvents
  }, _fetchMessageObject:function(data) {
    if(data.aimId) {
      data.aimId = transformIcqUin(data.aimId)
    }
    if(!data.source && data.aimId) {
      data.source = {aimId:data.aimId, friendly:data.friendly}
    }
    var isSystemMessage = !!data.hidden, sender = {aimId:data.source.aimId, friendly:data.source.friendly};
    if(data.MChat_Attrs && data.MChat_Attrs.sender) {
      isSystemMessage = !!data.MChat_Attrs.method;
      sender = {aimId:data.MChat_Attrs.sender, friendly:data.MChat_Attrs.senderName};
      var pre = data.MChat_Attrs.senderName + ": ";
      if(data.message.indexOf(pre) === 0) {
        data.message = data.message.substr(pre.length)
      }
    }
    var m = {"from":data.source.aimId, "timestamp":data.timestamp, "sender":sender.aimId, "senderFriendly":sender.friendly, "text":this._fetchMessageText(data), "wid":data.msgId};
    if(isSystemMessage) {
      m.hidden = true
    }
    if(data.stickerId) {
      m.sticker = data.stickerId
    }
    return m
  }, fetchMyInfo:function(eventData) {
    var status = eventData.state, statusTitle = null;
    if(status == "online" && eventData.expressions && eventData.expressions.mood) {
      status = WA.Statuses.decodeMood(eventData.expressions.mood);
      statusTitle = eventData.expressions.moodTitle ? WA.Statuses.decodeMoodTitle(eventData.expressions.moodTitle) : status
    }
    eventData.aimId = transformIcqUin(eventData.aimId);
    return{aimId:eventData.aimId, email:eventData.aimId, status:status, statusTitle:statusTitle, phone:eventData.attachedPhoneNumber, official:!!eventData.official, nickname:eventData.friendly || eventData.displayId || eventData.aimId, userpic:eventData.expressions && eventData.expressions.buddyIcon}
  }, _makeStatusTitle:function(status, title, lastSeen) {
    if(!title) {
      title = status.replace(/^icq_/, "");
      if(title === "away" && lastSeen) {
        title = U.Date.formatLastSeenData(lastSeen)
      }
    }
    return title
  }, _fetchBuddyContactStatus:function(buddy, wasChange) {
    var status, statusTitle, aimId = transformIcqUin(buddy.aimId);
    status = this._resolveStatus(buddy);
    statusTitle = this._makeStatusTitle(status, buddy.statusMsg || buddy.moodTitle, buddy.lastseen);
    return{"email":aimId, "lastseen":buddy.lastseen, "onlineTime":buddy.onlineTime, "status":{"type":status, title:statusTitle}, "nickname":buddy.friendly || WA.CLD.getFriendlyName(aimId) || "", "userpic":buddy.buddyIcon, "abContactName":buddy.abContactName, "abPhoneNumber":buddy.abPhoneNumber, "mute":buddy.mute && 1, "official":buddy.official || 0, "change":!!wasChange}
  }, _fetchMessageText:function(data) {
    return data.rawMsg && data.rawMsg.base64Msg && window.atob && atob(data.rawMsg.base64Msg) || data.message && data.message.replace(/<[^>]+>/g, "") || ""
  }, _resolveStatus:function(buddy) {
    var type = buddy.service || buddy.userType;
    if(buddy.state === "offline" && buddy.lastseen && U.Date.getElapsed(new Date(buddy.lastseen * 1E3)) / 1E3 < U.Date.DAY) {
      buddy.state = "away"
    }
    switch(type) {
      case "icq":
        var mood = buddy.moodIcon && WA.Statuses.decodeMood(buddy.moodIcon);
        return"icq_" + (mood || buddy.state);
      case "interop":
        return this._statusGuide.icq[buddy.state] || buddy.state;
      case "facebook":
        return"fb_" + (this._statusGuide.fb[buddy.state] || buddy.state);
      case "sms":
        return"tel";
      default:
        return type + "_" + buddy.state
    }
  }, _makeBuddy:function(profile) {
    var bd = profile.birthDate || null;
    if(bd) {
      var bdo = new Date(bd * 1E3);
      bd = bdo.getFullYear() + "-" + (bdo.getMonth() + 1) + "-" + bdo.getDate()
    }
    var location = profile.homeAddress && profile.homeAddress[0] || {};
    profile.aimId = transformIcqUin(profile.aimId);
    var statusType = profile.online == "true" && "online";
    if(!statusType && WA.CLD.inList(profile.aimId)) {
      statusType = WA.CLD.getInfo(profile.aimId).status.indexOf("offline") > -1 ? "offline" : "online"
    }
    return{email:profile.aimId, nickname:profile.friendlyName || profile.displayId, friendly:profile.friendlyName, firstname:profile.firstname || profile.firstName, lastname:profile.lastname || profile.lastName, sex:{unknown:0, male:1, female:2}[profile.gender], aboutMe:profile.aboutMe, birthday:bd, zodiac:0, city:location.city, status:{type:statusType || "online"}, country_id:location.country}
  }, _makeClist:function() {
    var groups = this.__cacheCL;
    var uniqueUINs = {};
    var status, statusTitle, res = [];
    U.Array.each(groups, function(group) {
      U.Array.each(group.buddies, function(buddy) {
        if(uniqueUINs[buddy.aimId]) {
          return
        }
        uniqueUINs[buddy.aimId] = 1;
        if(this.__cacheIgnores && this.__cacheIgnores[buddy.aimId]) {
          return
        }
        if(buddy.aimId.indexOf("+") !== 0) {
          status = this._resolveStatus(buddy);
          statusTitle = this._makeStatusTitle(status, buddy.statusMsg || buddy.moodTitle, buddy.lastseen);
          res.push(WA.contactToArray({email:buddy.aimId, nick:buddy.friendly, needAuth:buddy.state === "unknown", status:status, statusTitle:statusTitle, lastseen:buddy.lastseen, onlineTime:buddy.onlineTime, mute:buddy.mute && 1, official:buddy.official || 0}))
        }
      }, this)
    }, this);
    return res
  }, _cacheIgnores:function(ignores) {
    this.__cacheIgnores = {};
    if(ignores && ignores.length) {
      U.Array.each(ignores, function(sn) {
        this.__cacheIgnores[sn] = 1
      }, this)
    }
  }, _cacheBuddies:function(groups) {
    this.__cacheCL = groups;
    U.Array.each(groups, function(group) {
      U.Array.each(group.buddies, function(buddy) {
        buddy.aimId = transformIcqUin(buddy.aimId);
        if(buddy.aimId.indexOf("+") !== 0) {
          this._buddyInfo[buddy.aimId] = buddy
        }
      }, this)
    }, this);
    return this.__cacheCL
  }});
  var API = WA.extend(Object, {constructor:function() {
    this.triggerEvent = new U.Event;
    this.beforeTriggerEvent = new U.Event;
    this.afterTriggerEvent = new U.Event;
    this.beforeSendEvent = new U.Event;
    this.afterSendEvent = new U.Event;
    this._lastMethodCall = "";
    this._eGuide = new EventGuide;
    this.triggerEvent.relay(this._eGuide.translateEvent)
  }, fetchMyInfo:function(data) {
    return this._eGuide.fetchMyInfo(data)
  }, onAimsidReceived:function() {
    if(!this.__cacheCL) {
      this.getContactList()
    }
  }, _send:function(method, data, cb, scope, uniq, postMethod) {
    var sid = null, reqId = data.r || createReqId();
    this.beforeSendEvent.fire(function(_s) {
      sid = _s
    }, method);
    if(!sid) {
      WA.log("Sending " + method + " failed, aimsid is NULL");
      cb && cb.call(scope || window, false);
      return
    }
    U.Object.extend(data, {f:"json", aimsid:sid, r:reqId});
    this._lastMethodCall = method;
    if(postMethod) {
      var req = getXhr();
      req.open("POST", API_HOST + method, true);
      req.setRequestHeader("Content-Type", "application/x-www-form-urlencoded");
      req.onreadystatechange = function() {
        if(req.readyState == 4) {
          var status = req.status;
          var resp = req.responseText;
          if(status == 200) {
            resp = resp.replace(/\u2028/g, "\\u2028").replace(/\u2029/g, "\\u2029");
            if("im/sendIMim/sendSticker".indexOf(method) > -1) {
              resp = resp.replace(/(histMsgId|beforeHistMsgId)":\s*(\d{15,})\s*(?=[\,\}\]])/g, '$1": "$2"')
            }
            resp = eval("(" + (resp || "{}") + ")");
            var success = this._handleResponse(method, resp, uniq || 0);
            this.afterSendEvent.fire(method, success);
            var code = resp.response && resp.response.statusCode;
            cb && cb.call(scope || window, !!success, code);
            return
          }
          cb && cb.call(scope || window, false)
        }
      }.bind(this);
      req.send(chainParams(data))
    }else {
      makeJsonpRequest(API_HOST + method, data, "c", function(respData) {
        var success = this._handleResponse(method, respData, uniq || 0);
        this.afterSendEvent.fire(method, success);
        var code = respData.response && respData.response.statusCode;
        cb && cb.call(scope || window, !!success, code)
      }, this, function(e) {
        cb && cb.call(scope || window, false)
      })
    }
    return reqId
  }, _fireEvents:function(resultEvents) {
    if(resultEvents.length) {
      this.beforeTriggerEvent.fire();
      U.Array.each(resultEvents, function(event) {
        this.triggerEvent.fire(event[0], event[1])
      }, this);
      this.afterTriggerEvent.fire()
    }
  }, _handleResponse:function(aimMethod, respData, uniq) {
    if(respData && respData.response) {
      var translatedEvents;
      var data = respData.response.data;
      if(respData.response.statusCode == 200) {
        if(data) {
          data.uniq = uniq;
          translatedEvents = this._eGuide.translateResponse(aimMethod, data);
          this._fireEvents(translatedEvents)
        }
        return true
      }else {
        if(respData.response.statusCode == "401") {
          WA.log("401: Authentication Required");
          this.triggerEvent.fire("logout", {endCode:410, offReason:respData.response.statusText})
        }else {
          if(respData.response.statusCode == "602") {
            WA.log("602: Target not available", data);
            if(data) {
              data.uniq = uniq;
              var translatedEvents = this._eGuide.translateResponse(aimMethod, data);
              this._fireEvents(translatedEvents)
            }
          }else {
            if(respData.response.statusCode) {
              U.Mnt.err("http" + parseInt(respData.response.statusCode))
            }else {
              WA.log("##########  WE HAVE RESPONSE ERROR:", respData)
            }
          }
        }
      }
    }
  }, fetchEvents:function(url, cb, scope, fail, quickResponse, hiddenMode) {
    var params = {f:"json", timeout:quickResponse ? 500 : FETCH_EVENTS_TIMEOUT};
    if(hiddenMode) {
      params.bg = 1;
      params.hidden = 1
    }
    this._rid = makeJsonpRequest(url, params, "c", function(data) {
      clearJsonpRequest(this._rid);
      delete this._rid;
      var resp = data && data.response;
      if(!resp) {
        fail && fail.call(scope || window, "connectTimeout")
      }else {
        if(resp.statusCode != 200) {
          fail && fail.call(scope || window, "http", resp.statusCode)
        }else {
          cb && cb.call(scope || window, resp.data)
        }
      }
    }, scope, function(data) {
      clearJsonpRequest(this._rid);
      delete this._rid;
      fail && fail.call(scope || window, "interrupted")
    })
  }, eachEvent:function(events) {
    var translatedEvents = this._eGuide.eachEvent(events);
    this._fireEvents(translatedEvents)
  }, send:function(method, data, cb, scope) {
    data = data || {};
    WA.log("!!!---send is calling---", method, data);
    switch(method) {
      case "message":
        if(data.composing) {
          method = "sendTyping"
        }else {
          if(data.text) {
            method = "sendMessage"
          }
        }
        break;
      case "sms":
        method = "sendSMS";
        break;
      case "user/status":
        method = "setState";
        var status = this._eGuide._statusGuide.mra[data.type] || data.type;
        var invis = status == "invisible";
        data = {view:invis ? "online" : status, invisible:invis};
        break;
      case "history":
        break;
      case "wp":
        WA.log("wp", data);
        if(data.email) {
          method = "getProfile"
        }else {
          method = "searchProfile"
        }
        break;
      case "contact":
        if(data.operation == "modify") {
          method = "modifyContact"
        }else {
          if(data.operation == "ignore") {
            method = "ignoreContact"
          }else {
            if(data.operation == "add") {
              if(data.auth) {
                method = "authorizeContact"
              }else {
                method = "addContact"
              }
            }else {
              if(data.operation == "remove") {
                method = "removeContact"
              }
            }
          }
        }
        break;
      case "contactlist":
        method = "getContactList";
        break;
      case "setSessionParam":
        method = "setSessionParam";
        break;
      case "webrtcMsg":
        method = "voip/webrtcMsg";
        data = {uuid:"094613514C7F11D18222444553540000", guid:0, subtype:"", signalling_json:""};
        break;
      case "logout":
        method = "endSession";
        break;
      default:
    }
    this[method] ? this[method](data, cb, scope) : this._send(method, data, cb, scope)
  }, setTimezone:function() {
    var tz = (new Date).getTimezoneOffset();
    return this._send("timezone/set", {TimeZoneOffset:-tz * 60})
  }, getContactList:function(data, cb, scope) {
    if(this.__cacheCL) {
      this._fireEvents([["contactList", this._makeClist()]]);
      return
    }
    var params = {bl:1, friendly:1};
    return this._send("presence/get", params, cb, scope)
  }, sendMessage:function(data, cb, scope) {
    if(data.sms) {
      return this.sendSMS(data, cb, scope)
    }
    var params = {t:transformIcqUin(data.to, 1), message:data.text, r:data.r || null};
    if(data.parse) {
      params.parse = JSON.stringify(data.parse)
    }
    return this._send("im/sendIM", params, cb, scope, data.message_id, SENDIM_METHOD_POST)
  }, sendSticker:function(data, cb, scope) {
    var params = {t:transformIcqUin(data.to, 1), stickerId:data.code, offlineIM:1, r:data.r || null};
    return this._send("im/sendSticker", params, cb, scope, data.message_id, SENDIM_METHOD_POST)
  }, sendTyping:function(data, cb, scope) {
    var params = {t:transformIcqUin(data.to, 1), typingStatus:"typing"};
    return this._send("im/setTyping", params, cb, scope)
  }, sendSMS:function(data, cb, scope) {
    var phone = data.tel.substr(0, 1) == "+" ? data.tel : "+" + data.tel;
    var params = {t:phone, message:data.text, offlineIM:true, r:data.r || null};
    this._send("im/sendIM", params, cb, scope)
  }, setState:function(data, cb, scope) {
    return this._send("presence/setState", data, cb, scope)
  }, setStatus:function(data, cb, scope) {
    return this._send("presence/setStatus", data, cb, scope)
  }, getContactStatus:function(data, cb, scope) {
    var params = {t:transformIcqUin(data.email, 1), k:k, statusMsg:1, friendly:1, location:0, presenceIcon:0};
    return this._send("presence/get", params, cb, scope)
  }, getProfile:function(data, cb, scope) {
    var params = {t:transformIcqUin(data.email, 1), locale:locale, infoLevel:"mid"};
    if(data.email == WA.ACTIVE_MAIL) {
      selfProfileUniq = data.uniq = data.uniq || WA.uniq()
    }
    return this._send("memberDir/get", params, cb, scope, data.uniq)
  }, searchProfile:function(data, cb, scope) {
    var match = [];
    data.firstname && match.push("firstName=" + data.firstname);
    data.lastname && match.push("lastName=" + data.lastname);
    data.keyword && match.push("keyword=" + data.keyword.replace(/\s+/g, "%20").replace(/(\%20)*,(\%20)*/g, " "));
    data.sex && match.push("gender=" + ["", "male", "female"][data.sex]);
    (data.ageFrom || data.ageUntil) && match.push("age=" + (data.ageFrom || 0) + "-" + (data.ageUntil || ""));
    data.ageRange && match.push("age=" + data.ageRange.replace(/\s/g, ""));
    data.country && match.push("homeAddress.country=" + data.country.toUpperCase());
    data.online && match.push("online=" + !!data.online);
    if(match.length === 1 && data.online) {
      match.push("age=18-100")
    }
    var params = {match:match.join(","), locale:locale, infoLevel:"mid", nToGet:data.num || 20, nToSkip:data.from || 0};
    return this._send("memberDir/search", params, cb, scope, data.uniq)
  }, updateProfile:function(key, value, cb, scope) {
    var keys = {friendly:"friendlyName", firstname:"firstName", lastname:"lastName", birthday:"birthDate", sex:"gender", city:"homeAddress", country_id:"homeAddress"};
    var values = {birthday:function(v) {
      return Math.floor(new Date(v) / 1E3)
    }, sex:function(v) {
      return["unknown", "male", "female"][v] || "unknown"
    }, city:function(v) {
      return"[{city=" + v + "}]"
    }, country_id:function(v) {
      return"[{country=" + v.toUpperCase() + "}]"
    }};
    keys["nick"] = keys.friendly;
    var params = {"set":(keys[key] || key) + "=" + (values[key] ? values[key](value) : value)};
    return this._send("memberDir/update", params, cb, scope)
  }, addContact:function(data, cb, scope) {
    var params = {group:"General", buddy:transformIcqUin(data.email, 1), preAuthorized:true, authorizationMsg:WA.tr("msgAddMePlease")};
    return this._send("buddylist/addBuddy", params, cb, scope)
  }, requestAuthorization:function(data, cb, scope) {
    var params = {t:transformIcqUin(data.email, 1), authorizationMsg:WA.tr("msgAddMePlease")};
    return this._send("buddylist/requestAuthorization", params, cb, scope)
  }, authorizeContact:function(data, cb, scope) {
    var params = {group:"General", authorized:true, t:transformIcqUin(data.email, 1)};
    return this._send("buddylist/authorizeUser", params, cb, scope)
  }, removeContact:function(data, cb, scope) {
    var params = {allGroups:true, buddy:transformIcqUin(data.email, 1)};
    return this._send("buddylist/removeBuddy", params, cb, scope)
  }, addChatMembers:function(data, cb, scope) {
    if(!data.members || !data.members.length) {
      cb && cb.call(scope || window, 400);
      return
    }
    var members = [];
    U.Array.each(data.members, function(it) {
      members.push(transformIcqUin(it[0], 1))
    });
    var params = {chat_id:transformIcqUin(data.email, 1), members:members.join(";")};
    return this._send("mchat/AddChat", params, cb, scope)
  }, delChatMembers:function(data, cb, scope) {
    if(!data.members || !data.members.length) {
      cb && cb.call(scope || window, 400);
      return
    }
    var members = [];
    U.Array.each(data.members, function(it) {
      members.push(transformIcqUin(it[0], 1))
    });
    var params = {chat_id:transformIcqUin(data.email, 1), chat_name:data.chatName, members:members.join(";")};
    return this._send("mchat/DelMembers", params, cb, scope)
  }, hideActiveDialog:function(data, cb, scope) {
    var params = {buddy:transformIcqUin(data.email, 1), lastMsgId:data.lastMsgId};
    return this._send("buddylist/hideChat", params, cb, scope)
  }, muteContact:function(data, cb, scope) {
    var params = {buddy:transformIcqUin(data.email, 1), eternal:data.mute};
    return this._send("buddylist/Mute", params, cb, scope)
  }, ignoreContact:function(data, cb, scope) {
    var params = {};
    params[data.unignore ? "pdIgnoreRemove" : "pdIgnore"] = transformIcqUin(data.email, 1);
    return this._send("preference/setPermitDeny", params, cb, scope)
  }, spamContact:function(data, cb, scope) {
    var params = {t:transformIcqUin(data.email, 1), spimType:"spim", spimEvent:data.decline ? "decline" : "user"};
    return this._send("im/reportSPIM", params, cb, scope)
  }, modifyContact:function(data, cb, scope) {
    var params = {allGroups:true, t:transformIcqUin(data.email, 1), friendly:data.nickname, serviceName:"aim"};
    return this._send("buddylist/setBuddyAttribute", params, cb, scope)
  }, setSessionParam:function(data, cb, scope) {
    var params = {includePresenceFields:"aimId=1,displayId=1,friendly=1,friendlyName=1,state=1,userType=1,statusMsg=1,statusTime=1,lastseen=1,ssl=1,moodTitle=1,moodIcon=1,buddyIcon=1,mute=1"};
    return this._send("aim/setSessionParam", params, cb, scope)
  }, signedGetRequest:function(url, params, cb, scope) {
    signUrl(url, params, "GET", function(sUrl) {
      makeJsonpRequest(sUrl, params, "callback", cb, scope, null)
    })
  }, tryLoginByMpopCookie:function(cb, scope, fail) {
    WA.log("Trying mpop login...");
    var mpop, m = /Mpop=([^;]+)/.exec(document.cookie.toString());
    if(m) {
      mpop = m[0]
    }
    if(!mpop) {
      fail && fail.call(scope || window);
      return
    }
    var params = {clientName:"webagent", clientVersion:500, devId:k, r:createReqId(), f:"json"};
    WA.XDRequest.getInstance(LOGIN_GATE_HOST).request({method:"POST", url:LOGIN_GATE_PAGE, data:params}, function(res) {
      WA.log("###GATELOGIN2:", res);
      var resp = res.data.replace(/\u2028/g, "\\u2028").replace(/\u2029/g, "\\u2029");
      resp = eval("(" + resp + ")");
      if(resp && resp.response && resp.response.statusCode == 200) {
        U.Mnt.err("mpopLoginOk");
        cb && cb.call(scope || window, resp.response.data)
      }else {
        if(resp && resp.response && resp.response.statusCode) {
          this._sendLoginFailStats(resp.response.statusCode);
          fail && fail.call(scope || window, resp)
        }else {
          this._sendLoginFailStats();
          fail && fail.call(scope || window, resp)
        }
      }
    }, function(res) {
      if(res && res.status) {
        this._sendLoginFailStats(res.status);
        if(res.status === 418) {
        }
      }else {
        this._sendLoginFailStats(900)
      }
      WA.log("LOGIN BY COOKIE FAILED", res);
      fail && fail.call(scope || window, res)
    }, this)
  }, _sendLoginFailStats:function(status) {
    if(this.__failStatSent) {
      U.Mnt.err("mpopLoginFailRepeat");
      return
    }
    this.__failStatSent = true;
    var now = WA.now();
    WA.Storage.load(["failLogSent"], {success:function(storage) {
      var lastSent = storage["failLogSent"] || 0;
      if(now - lastSent > 20 * 60 * 60) {
        U.Mnt.err("mpopLoginFail" + (status ? "Status" + status : ""));
        WA.Storage.save({"failLogSent":now});
        U.Mnt.log({reason:"breaklog", login:WA.ACTIVE_MAIL, text:"bympopfails" + (status ? 1 : 0)})
      }else {
        U.Mnt.err("mpopLoginFailRepeat")
      }
    }, failure:function() {
      U.Mnt.err("mpopLoginFail" + (status ? "Status" + status : ""));
      U.Mnt.log({reason:"breaklog", login:WA.ACTIVE_MAIL, text:"bympopfail0"})
    }, scope:this})
  }, tryLoginByParams:function(params, cb, scope, fail) {
    WA.log("Trying params login...");
    makeJsonpRequest(LOGIN_URL, params, "callback", function(data) {
      if(data.statusCode == 200) {
        cb && cb.call(scope || window, data)
      }else {
        WA.log("LOGIN BY PARAMS FAILED", data);
        fail && fail.call(scope || window)
      }
    }, scope, fail)
  }, tryLoginByCookie:function(cb, scope, fail) {
    WA.log("Trying cookie login...");
    var params = {cookielogin:1, language:locale, time:Math.floor(new Date / 1E3), remember:1};
    makeJsonpRequest(LOGIN_URL, params, "callback", function(data) {
      if(data.statusCode == 200) {
        cb && cb.call(scope || window, data)
      }else {
        WA.log("LOGIN BY COOKIE FAILED", data);
        fail && fail.call(scope || window)
      }
    }, scope, fail)
  }, requestPhoneCode:function(phoneNumber, cbSuccess, cbFail, scope) {
    var params = {msisdn:phoneNumber, f:"jsonp", locale:locale, countryCode:"ru", k:k, version:1, platform:"web", client:"icq", r:1};
    makeJsonpRequest(PHONE_URL, params, "callback", function(resp) {
      resp = resp.response;
      if(resp && resp.statusCode == 200) {
        var data = resp.data;
        cbSuccess && cbSuccess.call(scope || window, data.msisdn, data.trans_id)
      }else {
        cbFail && cbFail.call(scope || window, resp && resp.statusCode)
      }
    }, this, function(res) {
      cbFail && cbFail.call(scope || window)
    })
  }, getTokenByPhoneCode:function(phoneNumber, transId, code, cbSuccess, cbFail) {
    var params = {msisdn:phoneNumber, trans_id:transId, sms_code:code, f:"jsonp", locale:locale, k:k, platform:"web", create_account:1, client:"icq", r:1};
    makeJsonpRequest(CODE_URL, params, "callback", function(resp) {
      resp = resp.response;
      if(resp && resp.statusCode == 200) {
        var data = resp.data;
        WA.log("We got token: " + data.token.a);
        cbSuccess && cbSuccess(data)
      }else {
        cbFail && cbFail(resp && resp.statusCode)
      }
    }, this, function(res) {
      cbFail && cbFail.call();
      WA.log("Error", res)
    })
  }, requestAttachPhoneCode:function(phoneNumber, transId, code, cbSuccess) {
    var params = {msisdn:phoneNumber, trans_id:transId, sms_code:code, f:"jsonp", k:k, ts:WA.nowFixed(), r:WA.uniq()};
    var sessionKey;
    getSessionData(function(s) {
      sessionKey = s.sessionKey;
      params.a = s.a
    });
    var url = makeSignedUrl(ATTACH_PHONE_URL, params, "POST", sessionKey);
    var req = getXhr();
    req.open("POST", url, true);
    req.withCredentials = true;
    req.onreadystatechange = function() {
      if(req.readyState == 4) {
        cbSuccess && cbSuccess(req.status)
      }
    }.bind(this);
    req.send("")
  }, validateSid:function(cb, scope) {
    return this._send("aim/validateSid", {k:k}, cb, scope)
  }, startSession:function(a, ts, sessionKey, cb, scope, fail) {
    getDeviceId(function() {
      var params = {a:decodeURIComponent(a), ts:ts, k:k, f:"json", view:"online", clientName:"webagent", language:locale, deviceId:deviceId, sessionTimeout:SESSION_TIMEOUT, assertCaps:caps.replace(/\-/g, ""), events:"myInfo,presence,buddylist,typing,hiddenChat,snapsEvent,hist,mchat,sentIM,imState,dataIM,offlineIM,userAddedToBuddyList,service,lifestream,apps,permitDeny", includePresenceFields:"aimId,displayId,friendly,friendlyName,state,userType,statusMsg,statusTime,lastseen,ssl,moodTitle,moodIcon,buddyIcon,mute,abContactName,abPhones,official,quiet"};
      makeJsonpRequest(API_HOST + "aim/startSession", params, "c", cb, scope, fail, sessionKey)
    })
  }, endSession:function(cb, scope) {
    WA.IcqRapi.invalidateToken();
    return this._send("aim/endSession", {}, cb, scope)
  }, eoc:null});
  var RAPI = WA.extend(Object, {authToken:null, clientId:null, _authorizing:false, constructor:function() {
    this.triggerEvent = new U.Event;
    this.beforeTriggerEvent = new U.Event;
    this.afterTriggerEvent = new U.Event;
    this.beforeSendEvent = new U.Event;
    this._eGuide = new EventGuide
  }, _getClientId:function(cb) {
    if(this.clientId) {
      return cb.call(this)
    }
    WA.AccountStorage.load(["clientId"], {success:function(s) {
      this.clientId = s.clientId || null;
      if(this.clientId) {
        return cb.call(this)
      }
      var post = {method:"addClient", reqId:createReqId(), authToken:this.authToken, params:{ua:{app:"agent", os:"win", version:"0.1", build:"1", label:"webagent"}}};
      post = JSON.stringify(post);
      WA.XDRequest.getInstance(RAPI_HOST).request({method:"POST", url:"/", data:{stringifiedData:post}}, function(res) {
        var resp = res.data.replace(/\u2028/g, "\\u2028").replace(/\u2029/g, "\\u2029");
        resp = eval("(" + resp + ")");
        var fullCode = 5E4, majorCode;
        if(resp && resp.status) {
          fullCode = resp.status.code;
          majorCode = Math.floor(fullCode / 100);
          if(majorCode == 402) {
            this.invalidateToken()
          }else {
            if(majorCode == 400) {
              U.Mnt.log({reason:"rapi", method:"addClient", code:fullCode, text:resp.status.reason})
            }else {
              if(majorCode == 405) {
                this._rateLimitReached = WA.now()
              }else {
                this.clientId = resp.results && resp.results.clientId || null;
                WA.AccountStorage.save({clientId:this.clientId || ""});
                if(this.clientId) {
                  return cb.call(this, true)
                }
              }
            }
          }
        }
        cb.call(this, false, fullCode)
      }, function() {
        cb.call(this, false)
      }, this)
    }, scope:this})
  }, invalidateToken:function() {
    this.authToken = null;
    WA.SessionStorage.save({rapiToken:""})
  }, _getAuthToken:function(cb) {
    WA.SessionStorage.load(["rapiToken"], {success:function(strg) {
      this.authToken = strg.rapiToken || this.authToken || null;
      if(this.authToken) {
        return cb.call(this)
      }
      if(this._authorizing) {
        return cb.call(this, false)
      }
      getSessionData(WA.createDelegate(function(s) {
        if(!s.a) {
          return
        }
        this._authorizing = true;
        var params = {a:s.a, k:k, ts:WA.nowFixed()};
        var host = "https://" + RAPI_HOST;
        var url = makeSignedUrl(host + "/genToken", params, "POST", s.sessionKey);
        WA.log("_getAuthToken url - ", url);
        WA.XDRequest.getInstance(RAPI_HOST).request({method:"POST", url:url.replace(host, ""), data:{stringifiedData:""}}, function(res) {
          this._authorizing = false;
          var resp = res.data.replace(/\u2028/g, "\\u2028").replace(/\u2029/g, "\\u2029");
          if(resp) {
            resp = eval("(" + resp + ")")
          }
          var fullCode = 5E4, majorCode;
          if(res.status == 200 && resp && resp.status) {
            fullCode = resp.status.code;
            majorCode = Math.floor(fullCode / 100);
            if(majorCode == 405) {
              this._rateLimitReached = WA.now()
            }else {
              if(majorCode == 400) {
                if(fullCode == 40006) {
                  resetSessionData()
                }else {
                  if(fullCode == 40004) {
                    WA.serverTimeDiff = 0
                  }
                }
                U.Mnt.log({reason:"rapi", method:"genToken", code:fullCode, text:resp.status.reason})
              }else {
                this.authToken = resp.results && resp.results.authToken || "";
                WA.SessionStorage.save({rapiToken:this.authToken});
                if(this.authToken) {
                  return cb.call(this)
                }
              }
            }
            if(majorCode) {
              U.Mnt.err("gentoken" + majorCode)
            }
          }
          cb.call(this, false, fullCode)
        }, function() {
          this._authorizing = false;
          cb.call(this, false)
        }, this)
      }, this))
    }, failure:function() {
      cb.call(this, false)
    }, scope:this})
  }, _fireEvents:function(resultEvents) {
    if(resultEvents.length) {
      this.beforeTriggerEvent.fire();
      U.Array.each(resultEvents, function(event) {
        this.triggerEvent.fire(event[0], event[1])
      }, this);
      this.afterTriggerEvent.fire()
    }
  }, _handleResponse:function(resp, status, requestParams, requestMethod) {
    if(status != 200) {
      U.Mnt.err("rhttp" + status);
      return 0
    }
    resp = resp.replace(/\u2028/g, "\\u2028").replace(/\u2029/g, "\\u2029");
    resp = eval("(" + resp + ")");
    var fullCode = 5E4, majorCode;
    if(resp && resp.status) {
      fullCode = resp.status.code;
      majorCode = Math.floor(fullCode / 100);
      if(majorCode == 200 && resp.results) {
        resp.results.requestParams = requestParams;
        var translatedEvents = this._eGuide.translateResponse(resp.method, resp.results);
        this._fireEvents(translatedEvents)
      }else {
        if(majorCode == 402) {
          WA.log("Bad Auth");
          this.invalidateToken()
        }else {
          if(majorCode == 403) {
            WA.log("Bad Client");
            this.clientId = null;
            WA.AccountStorage.save({clientId:""})
          }else {
            if(majorCode == 405) {
              this._rateLimitReached = WA.now()
            }else {
              if(majorCode == 401 || majorCode == 404) {
              }
            }
          }
        }
      }
      if(majorCode && majorCode != 200) {
        U.Mnt.log({reason:"rapi", method:requestMethod, code:fullCode, text:resp.status.reason})
      }
    }
    return fullCode
  }, _sendRequest:function(reqId, method, params, cb) {
    var post = {method:method, reqId:reqId, clientId:+this.clientId, authToken:this.authToken, params:params};
    var host = RAPI_HOST;
    if(method == "getPymk" || method === "excludePymk") {
      host = PYMK_HOST
    }
    var sendData = JSON.stringify(post);
    WA.XDRequest.getInstance(host).request({method:"POST", url:"/", data:{stringifiedData:sendData}}, function(res) {
      U.Mnt.wrapTryCatch(function() {
        var statusCode = this._handleResponse(res.data, res.status, params, method) || 0;
        cb.call(this, statusCode)
      }, this)
    }, function() {
      cb.call(this, 0)
    }, this)
  }, uploadAvatar:function(chatId, file, cb, cbFail) {
    var sid = null;
    this.beforeSendEvent.fire(function(_s) {
      sid = _s
    });
    var url = ["//api.icq.net/expressions/upload?aimsid=", sid, "&f=json&type=largeBuddyIcon&r=1&livechat=1"];
    if(chatId) {
      url[2] = "&f=json&type=largeBuddyIcon&t=" + chatId;
      if(chatId === WA.ACTIVE_MAIL) {
        url[2] = "&f=json&type=largeBuddyIcon"
      }
    }
    url = url.join("");
    var headers = [["X-Requested-With", "XMLHttpRequest"]];
    var onFail = function(id, status) {
      U.Mnt.wrapTryCatch(function() {
        cbFail && cbFail(id, status)
      })
    };
    var req = getXhr();
    req.open("POST", url, true);
    req.withCredentials = true;
    headers.forEach(function(el) {
      req.setRequestHeader(el[0], el[1])
    });
    req.upload.addEventListener("progress", function(e) {
      WA.log("progress", e.loaded, e.total)
    }.bind(this), false);
    req.addEventListener("error", onFail.bind(undefined, 4), false);
    req.addEventListener("abort", onFail.bind(undefined, 0), false);
    req.onreadystatechange = function() {
      if(req.readyState != 4) {
        return
      }
      var status = req.status;
      var resp = req.responseText;
      if(status == 206 || status == 200) {
        if(cb) {
          resp = resp.replace(/\u2028/g, "\\u2028").replace(/\u2029/g, "\\u2029");
          if(resp) {
            resp = eval("(" + resp + ")")
          }
          U.Mnt.wrapTryCatch(function() {
            cb(status, resp.response)
          })
        }
      }else {
        onFail(5, status)
      }
    };
    req.send(file)
  }, _sendingTries:{}, send:function(method, params, cb, scope) {
    var reqId = createReqId();
    this._sendingTries[reqId] = 0;
    var sid = null;
    this.beforeSendEvent.fire(function(_s) {
      sid = _s
    }, method);
    U.Object.extend(params, {aimSid:sid});
    var cbRequest = function(fullCode) {
      var resultCode = Math.floor(fullCode / 100);
      if(this._sendingTries[reqId] < 3 && !(resultCode == 200 || resultCode == 401 || resultCode == 404 || resultCode == 405 || resultCode == 400)) {
        this._trySend(reqId, method, params, cbRequest)
      }else {
        delete this._sendingTries[reqId];
        cb && cb.call(scope || window, resultCode, reqId, fullCode)
      }
    }.bind(this);
    this._trySend(reqId, method, params, cbRequest);
    return reqId
  }, _isRateLimitTriggered:function() {
    return!!this._rateLimitReached && WA.now() - this._rateLimitReached < 60 * 60
  }, _trySend:function(reqId, method, params, cb) {
    if(this._authorizing) {
      WA.log("setting timeout", reqId);
      WA.setTimeout(function() {
        this._trySend(reqId, method, params, cb)
      }, 2E3, this);
      return
    }
    if(this._sendingTries[reqId] && this._isRateLimitTriggered()) {
      return
    }
    this._sendingTries[reqId]++;
    this._getAuthToken(function(success, fullCode) {
      if(success === false) {
        return cb(fullCode)
      }
      this._getClientId(function(success, fullCode) {
        if(success === false) {
          return cb(fullCode)
        }
        this._sendRequest(reqId, method, params, cb)
      })
    })
  }, getHistory:function(data, cb, scope) {
    if(data.msgId && data.msgId != -1 && !/^[0-9]+$/.test("" + data.msgId)) {
      WA.log("**TRY TO GET HISTORY WITH WRONG ID", data.msgId);
      return
    }
    var params = {sn:transformIcqUin(data.email, 1), fromMsgId:"" + (data.msgId || -1), count:data.count || -20, lang:locale, patchVersion:data.patchVersion || "init"};
    if(data.tillMsgId) {
      params.tillMsgId = data.tillMsgId
    }
    return this.send("getHistory", params, cb, scope)
  }, delHistory:function(data, cb, scope) {
    if(data.msgId && data.msgId != -1 && !/^[0-9]+$/.test("" + data.msgId)) {
      WA.log("**TRY TO GET HISTORY WITH WRONG ID", data.msgId);
      return
    }
    var params = {sn:transformIcqUin(data.email, 1), uptoMsgId:"" + (data.msgId || -1)};
    this.send("delHistory", params, cb, scope)
  }, delMessage:function(data, cb, scope) {
    if(!data.msgId || !data.email) {
      return
    }
    var params = {sn:transformIcqUin(data.email, 1), msgId:"" + data.msgId};
    if(data.shared) {
      params.shared = true
    }
    this.send("delMsg", params, cb, scope)
  }, getLiveChats:function(data, cb, scope) {
    data = data || {};
    var params = {memberLimit:data.memberLimit || 5};
    if(data.tag) {
      params.tag = data.tag
    }
    this.send("getChatHome", params, cb, scope)
  }, joinChat:function(data, cb, scope) {
    data = data || {};
    var params = {stamp:data.stamp};
    params.stamp && this.send("joinChatAlpha", params, cb, scope)
  }, getChatInfo:function(data, cb, scope) {
    var params = {sn:data.email};
    if(data.limit) {
      params.memberLimit = data.limit
    }
    this.send("getChatInfo", params, cb, scope)
  }, getBlockedMembers:function(chat_id, cb, scope) {
    var params = {sn:chat_id};
    this.send("getChatBlocked", params, cb, scope)
  }, addChatMembers:function(data, cb, scope) {
    if(!data.members || !data.members.length) {
      cb && cb.call(scope || window, 400);
      return
    }
    var members = [];
    U.Array.each(data.members, function(it) {
      members.push({sn:transformIcqUin(it[0], 1)})
    });
    var params = {sn:data.email, members:members};
    this.send("addChatMembers", params, cb, scope)
  }, modifyChat:function(data, cb, scope) {
    var readyToSend, params = {sn:data.email};
    if(typeof data.about === "string") {
      readyToSend = true;
      params.about = data.about
    }
    if(typeof data.name === "string") {
      readyToSend = true;
      params.name = data.name
    }
    if(typeof data["public"] === "boolean") {
      readyToSend = true;
      params["public"] = data["public"]
    }
    readyToSend && this.send("modChatAlpha", params, cb, scope)
  }, modifyChatMember:function(data, cb, scope) {
    var params = {sn:data.email, memberSn:transformIcqUin(data.member, 1), role:"member"};
    if(data.role) {
      params.role = data.role
    }
    this.send("modChatMemberAlpha", params, cb, scope)
  }, blockChatMembers:function(data, cb, scope) {
    var members = [];
    if(data.member) {
      members = [{sn:transformIcqUin(data.member, 1)}]
    }else {
      if(data.members) {
        members = data.members
      }
    }
    var params = {sn:data.email, members:members};
    members.length && this.send("blockChatMembers", params, cb, scope)
  }, unblockChatMembers:function(data, cb, scope) {
    var members = [];
    if(data.member) {
      members = [{sn:transformIcqUin(data.member, 1)}]
    }else {
      if(data.members) {
        members = data.members
      }
    }
    var params = {sn:data.email, members:members};
    members.length && this.send("unblockChatMembers", params, cb, scope)
  }, createChat:function(data, cb, scope) {
    var members = [];
    U.Array.each(data.members, function(it) {
      members.push({sn:transformIcqUin(it[0], 1)})
    });
    var params = {name:data.name || data.members[0][1] + ", " + data.members[1][1], members:members};
    if(data.live) {
      params.live = true
    }
    if(data["public"]) {
      params["public"] = true
    }
    if(data.about) {
      params.about = data.about
    }
    if(data.avatarId) {
      params.avatarId = data.avatarId
    }
    this.send("createChat", params, cb, scope)
  }, setDialogState:function(data, cb, scope) {
    var params = {sn:transformIcqUin(data.email, 1), lastRead:data.msgId};
    if(params.lastRead) {
      this.send("setDlgStateWim", params, cb, scope)
    }
  }, delChatMembers:function(data, cb, scope) {
    if(!data.members || !data.members.length) {
      cb && cb.call(scope || window, 400);
      return
    }
    var members = [];
    U.Array.each(data.members, function(it) {
      members.push({sn:transformIcqUin(it[0], 1)})
    });
    var params = {sn:data.email, members:members};
    this.send("delChatMembers", params, cb, scope)
  }, getSuggests:function(data, cb, scope) {
    var params = {tag:data.tag || "init"};
    this.send("getPymk", params, cb, scope)
  }, excludeSuggest:function(data, cb, scope) {
    if(!data.sn || !data.stamp) {
      return
    }
    var params = {sn:transformIcqUin(data.sn, 1), stamp:data.stamp};
    this.send("excludePymk", params, cb, scope)
  }, getUserSnaps:function(mail, params, cb, scope) {
    var data = {sn:transformIcqUin(mail, 1)};
    if(typeof params.count === "number" && !isNaN(params.count)) {
      data.count = params.count
    }
    if(params.from) {
      data.fromSnapId = params.from
    }
    this.send("getUserSnaps", data, cb, scope)
  }, getAllSnaps:function(cb, scope) {
    this.send("getSnapHome", {}, cb, scope)
  }, setSnapViewed:function(userId, snapId, cb, scope) {
    if(!userId || !snapId) {
      return
    }
    this.send("snapViewed", {sn:transformIcqUin(userId, 1), snapId:snapId}, cb, scope)
  }, removeSnaps:function(snapIds, cb, scope) {
    this.send("delSnaps", {snapIds:snapIds}, cb, scope)
  }, eoc:null});
  var STORE_BASE_URL = "https://store-agent.mail.ru";
  var STORE_GET_SHOWCASE = STORE_BASE_URL + "/store/showcase";
  var STORE_GET_CONTENT = STORE_BASE_URL + "/openstore/contentlist";
  var STORE_GET_PACK_INFO = STORE_BASE_URL + "/openstore/packinfo";
  var STORE_INSTALL_PACK = STORE_BASE_URL + "/store/buy/free";
  var STORE_REMOVE_PACK = STORE_BASE_URL + "/store/deletepurchase";
  var StoreAPI = WA.extend(Object, {commonParams:{lang:"ru_RU", client:"agent", agent:1, platform:"web"}, _send:function(url, params, cb, cbFail) {
    getSessionData(function(s) {
      WA.apply(params, {a:s.a, k:k, ts:WA.nowFixed()}, this.commonParams);
      makeJsonpRequest(url, params, "callback", cb, null, cbFail, s.sessionKey)
    }, this)
  }, getShowcase:function(cb, cbFail) {
    this._send(STORE_GET_SHOWCASE, {}, cb, cbFail)
  }, getContent:function(cb, cbFail) {
    this._send(STORE_GET_CONTENT, {}, cb, cbFail)
  }, getPackInfo:function(packId, cb, cbFail) {
    this._send(STORE_GET_PACK_INFO, {id:packId}, cb, cbFail)
  }, installPack:function(storeId, cb) {
    this._send(STORE_INSTALL_PACK, {product:storeId}, cb)
  }, removePack:function(packId, cb) {
    this._send(STORE_REMOVE_PACK, {product_id:packId}, cb)
  }});
  var FILES_BASE_URL = "https://files-agent.mail.ru";
  var FILES_UPLOAD_INIT = FILES_BASE_URL + "/files/init";
  var FILES_GETINFO = FILES_BASE_URL + "/getinfo";
  var FILES_GETSPEECH = FILES_BASE_URL + "/speechtotext/";
  var FILES_GETSNAPINFO = FILES_BASE_URL + "/getsnapinfo";
  var FileAPI = WA.extend(Object, {progressEvent:new U.Event, getSnapInfo:function(snapId, cb) {
    var params = {ttl_id:snapId};
    signUrl(FILES_GETSNAPINFO, params, "GET", function(sUrl) {
      try {
        var req = getXhr();
        req.open("GET", sUrl, true);
        req.withCredentials = true;
        req.addEventListener("error", function() {
          cb && cb()
        }, false);
        req.onreadystatechange = function() {
          if(req.readyState != 4) {
            return
          }
          var res = null;
          if(req.status == 200) {
            var resp = req.responseText;
            resp = resp.replace(/\u2028/g, "\\u2028").replace(/\u2029/g, "\\u2029");
            resp = eval("(" + resp + ")");
            if(resp && resp.file_list && resp.file_list.length) {
              res = [resp.file_list[0]];
              U.Array.each(["author_uin", "expire", "create_date", "snap_id", "author_name"], function(key) {
                res[0][key] = resp[key]
              })
            }
          }
          U.Mnt.wrapTryCatch(function() {
            cb && cb(res)
          })
        };
        req.send()
      }catch(ex) {
      }
    })
  }, getFileInfo:function(fileId, cb) {
    var params = {file_id:fileId, client:"icq", email:WA.ACTIVE_MAIL};
    try {
      var req = getXhr();
      req.open("GET", FILES_GETINFO + "?" + WA.makeGet(params), true);
      req.withCredentials = true;
      req.addEventListener("error", function() {
        cb && cb()
      }, false);
      req.onreadystatechange = function() {
        if(req.readyState != 4) {
          return
        }
        var res = null;
        if(req.status == 200) {
          var resp = req.responseText;
          resp = resp.replace(/\u2028/g, "\\u2028").replace(/\u2029/g, "\\u2029");
          resp = eval("(" + resp + ")");
          if(resp && resp.file_list && resp.file_list.length) {
            res = resp.file_list
          }
        }
        U.Mnt.wrapTryCatch(function() {
          cb && cb(res)
        })
      };
      req.send()
    }catch(ex) {
      params.f = "jsonp";
      WA.makeJsonpRequest(FILES_GETINFO, params, "callback", function(data) {
        var res = null;
        if(data && data.file_list && data.file_list.length) {
          res = data.file_list
        }
        U.Mnt.wrapTryCatch(function() {
          cb && cb(res)
        })
      }, this)
    }
  }, initUploadUrl:function(name, size, cb, cbFail) {
    getSessionData(function(s) {
      var params = {a:s.a, k:k, ts:WA.nowFixed(), size:size, filename:name, client:"webagent", email:WA.ACTIVE_MAIL, f:"jsonp"};
      makeJsonpRequest(FILES_UPLOAD_INIT, params, "callback", cb, this, cbFail, s.sessionKey)
    }, this)
  }, uploadBytes:function(url, name, blob, start, end, total, cb, cbFail) {
    var headers = [["Content-Type", "application/octet-stream"], ["X-Requested-With", "XMLHttpRequest"], ["Content-Disposition", 'attachment; filename="' + encodeURIComponentFull(name) + '"'], ["Content-Range", "bytes " + start + "-" + end + "/" + total]];
    var onFail = function(id, status) {
      U.Mnt.wrapTryCatch(function() {
        cbFail && cbFail(id, status)
      })
    };
    signUrl(url, null, "POST", function(sUrl) {
      var req = getXhr();
      req.open("POST", sUrl, true);
      req.withCredentials = true;
      headers.forEach(function(el) {
        req.setRequestHeader(el[0], el[1])
      });
      req.upload.addEventListener("progress", WA.createDelegate(function(e) {
        if(e.lengthComputable) {
          this.progressEvent.fire(e.loaded, e.total)
        }
      }, this), false);
      req.addEventListener("error", WA.createDelegate(onFail, undefined, [4]), false);
      req.addEventListener("abort", WA.createDelegate(onFail, undefined, [0]), false);
      req.onreadystatechange = function() {
        if(req.readyState != 4) {
          return
        }
        var status = req.status;
        var resp = req.responseText;
        if(status == 206 || status == 200) {
          resp = resp.replace(/\u2028/g, "\\u2028").replace(/\u2029/g, "\\u2029");
          if(resp) {
            resp = eval("(" + resp + ")")
          }
          U.Mnt.wrapTryCatch(function() {
            cb(status, resp)
          })
        }else {
          onFail(5, status)
        }
      };
      req.send(blob)
    }, this)
  }, getSpeechById:function(fileId, cb, cbFail) {
    getSessionData(function(s) {
      var params = {a:s.a, k:k, ts:WA.nowFixed(), f:"jsonp"};
      makeJsonpRequest(FILES_GETSPEECH + fileId, params, "callback", function(res) {
        if(res.status == 200) {
          cb(res.text)
        }else {
          cbFail && cbFail(res.status)
        }
      }, null, cbFail, s.sessionKey)
    }, this)
  }});
  var SNIPPET_INFO_URL = "//icqsnip.go.mail.ru/snippet";
  var SnippetAPI = WA.extend(Object, {getUrlInfo:function(url, cb) {
    var params = {url:url, v:1, domain:1};
    try {
      var req = getXhr();
      req.open("GET", SNIPPET_INFO_URL + "?" + WA.makeGet(params), true);
      req.addEventListener("error", function() {
        cb && cb()
      }, false);
      req.onreadystatechange = function() {
        if(req.readyState != 4) {
          return
        }
        var res = null;
        if(req.status == 200) {
          var resp = req.responseText;
          resp = resp.replace(/\u2028/g, "\\u2028").replace(/\u2029/g, "\\u2029");
          resp = eval("(" + resp + ")");
          if(resp && resp.status == "OK") {
            res = resp.doc
          }else {
            if(resp.status == "ERROR") {
              res = {error:1}
            }
          }
        }
        U.Mnt.wrapTryCatch(function() {
          cb && cb(res)
        })
      };
      req.send()
    }catch(ex) {
    }
  }});
  function sendStatistics(uin) {
    getDeviceId(function() {
      var tzHours = -(new Date).getTimezoneOffset() / 60;
      var path = WA.resPath.split("/");
      var lang = (navigator.language || navigator.browserLanguage || navigator.userLanguage || "").substr(0, 5);
      var params = {app:"agent", version:path[path.length - 1], branch:"release", platform:"web", osVersion:"", timezone:(tzHours >= 0 ? "+" : "-") + Math.floor(Math.abs(tzHours)), language:lang, region:"", network:"", uin:uin || "", ua:navigator.userAgent, devId:k, deviceId:deviceId, r:WA.uniq()};
      var get = [];
      Object.keys(params).forEach(function(k) {
        get.push(k + "=" + encodeURIComponentFull(params[k]))
      });
      (new Image).src = STATISTICS_URL + "?" + get.join("&")
    })
  }
  WA.IcqApi = WA.conn.Api = new API;
  WA.IcqRapi = WA.conn.Rapi = new RAPI;
  WA.StoreApi = new StoreAPI;
  WA.FileApi = new FileAPI;
  WA.SnippetAPI = new SnippetAPI;
  WA.StatisticsApi = {send:sendStatistics}
})();
WebAgent.namespace("WebAgent.conn");
(function() {
  var WA = WebAgent;
  var U = WA.util;
  var S = WA.Storage;
  var FM = WA.FocusManager;
  var SESSION_EXPIRE_DELAY = 12E4;
  var MAX_RESTORE_INT = 1 * 60 * 1E3;
  var LongPoller = WA.extend(Object, {_restore_int:1E3, constructor:function() {
    this.triggerEvent = new U.Event;
    this.errorEvent = new U.Event;
    this.beforeConnectEvent = new U.Event;
    this._delay = 0;
    this._url = "";
    this.polled = false;
    this.connected = false;
    this.interruptedMode = true;
    this.restoringMode = false;
    this._fetchDelayTask = new U.DelayedTask({fn:this._fetchEvents, scope:this})
  }, connect:function(url, delay) {
    WA.log("_poller.connect() connected=" + this.connected + ", polled=" + this.polled);
    if(!this.connected) {
      if(this.polled) {
        this.beforeConnectEvent.fire(this._url);
        this.connected = true
      }else {
        url = url.replace("http://", "//");
        this.beforeConnectEvent.fire(url);
        this._delay = delay = delay || 0;
        this._url = url;
        this._fetchDelayTask.start(delay);
        this.connected = true
      }
    }else {
      WA.log("Poller.connect: already connected")
    }
  }, disconnect:function() {
    this.connected = false
  }, _fetchEvents:function() {
    this.polled = true;
    WA.IcqApi.fetchEvents(this._url, this._onResponse, this, this._onError, !!this.interruptedMode, !!this.hiddenMode)
  }, _onResponse:function(data) {
    this.polled = false;
    this.interruptedMode = false;
    if(this.restoringMode && !this.connected) {
      if(data) {
        this.connected = true
      }
    }
    this.restoringMode = false;
    if(!this.connected || !data) {
      WA.log("Response ignored (disconnected)");
      return
    }
    if(data && !data.fetchBaseURL && !data.events) {
      return
    }
    if(!this.emptyEventsRecived) {
      if(data.events && !data.events.length) {
        this.emptyEventsRecived = true
      }else {
        this.interruptedMode = true
      }
    }
    this._url = data.fetchBaseURL;
    this._delay = data.timeToNextFetch;
    this._restore_int = 1E3;
    this.triggerEvent.fire(data, this.emptyEventsRecived);
    if(this._url) {
      this._fetchDelayTask.start(data.timeToNextFetch)
    }
  }, _onError:function(type, param) {
    WA.log("FETCH EVENTS ERROR", type, param);
    this.polled = false;
    switch(type) {
      case "interrupted":
      ;
      case "connectTimeout":
        U.Mnt.err("timeout");
        this._onHttpError(1);
        break;
      case "http":
        this._onHttpError(param);
        break;
      default:
        this._fetchDelayTask.start(this._delay)
    }
  }, _onHttpError:function(errCode, errdata) {
    WA.log("S._onHttpError: ", errCode);
    this.interruptedMode = true;
    if(errCode != 460) {
      var interval = errdata && errdata.reconnect_timeout || (this._restore_int * 2 < MAX_RESTORE_INT ? this._restore_int *= 2 : MAX_RESTORE_INT);
      this.errorEvent.fire(errCode, interval);
      this.restoringMode = true;
      this._fetchDelayTask.start(1E3 + interval)
    }else {
      this.errorEvent.fire(errCode)
    }
  }, forceFetch:function() {
    if(this.connected && this.interruptedMode && !this.polled) {
      this._fetchDelayTask.stop();
      if(this._restore_int * 2 < MAX_RESTORE_INT) {
        this._restore_int /= 2
      }
      this._fetchDelayTask.start(1)
    }
  }});
  var ICQ = WA.extend(Object, {constructor:function() {
    this.triggerEvent = new U.Event;
    this.requestReadyEvent = new U.Event;
    this.beforeReadyEvent = new U.Event;
    this.readyEvent = new U.Event;
    this.beforeResponseEvent = new U.Event;
    this.afterResponseEvent = new U.Event;
    this.afterStartEvent = new U.Event;
    this.errorEvent = new U.Event;
    this.requestable = false;
    this.stateEvent = new U.Event;
    this.statusChangedEvent = new U.Event;
    this._poller = new LongPoller;
    this._poller.triggerEvent.on(this._onPollerEvent, this);
    this._poller.errorEvent.on(this._onPollerError, this);
    this._poller.beforeConnectEvent.on(this._onPollerConnectEvent, this);
    FM.focusEvent.on(this.restore, this);
    FM.blurEvent.on(this._shutdown, this);
    this.triggerEvent.relay(WA.IcqApi.triggerEvent);
    this.beforeResponseEvent.relay(WA.IcqApi.beforeTriggerEvent);
    this.afterResponseEvent.relay(WA.IcqApi.afterTriggerEvent);
    WA.IcqApi.beforeSendEvent.on(function(cb) {
      cb && cb.call(window, this.aimsid)
    }, this);
    this.triggerEvent.relay(WA.IcqRapi.triggerEvent);
    this.beforeResponseEvent.relay(WA.IcqRapi.beforeTriggerEvent);
    this.afterResponseEvent.relay(WA.IcqRapi.afterTriggerEvent);
    WA.IcqRapi.beforeSendEvent.on(function(cb) {
      cb && cb.call(window, this.aimsid)
    }, this);
    this.aimsid = null
  }, _onPollerConnectEvent:function(data) {
  }, _onPollerError:function(errCode, interval) {
    WA.log("--------ICQ._onPollerError()", errCode);
    this.requestable = false;
    if(errCode === 1) {
      this.errorEvent.fire("connectInterrupt", interval)
    }else {
      if(errCode == 460) {
        this.disconnect();
        WA.log("#OFFPAGE#222# poller error 460");
        WA.log("### RESTORE AFTER 460 ###");
        this.forceRestore()
      }
    }
  }, _onPollerEvent:function(data, startEventsRecived) {
    S.save({"socket.date":+new Date});
    if(!this.requestable) {
      this.requestable = true;
      this.requestReadyEvent.fire(true)
    }
    S.modifyObject(["icqConnect"], function(storage) {
      var s = storage.icqConnect;
      s.respTs = WA.ts();
      s.fetchUrl = data.fetchBaseURL;
      s.delay = data.timeToNextFetch;
      var aimsid = data.fetchBaseURL && data.fetchBaseURL.match(/aimsid=([0-9\.:]+:([^@:]+@[0-9a-zA-ZÐ°-ÑÐ-Ð¯\-\.]+|[0-9]+))/) || null;
      var ts = data.fetchBaseURL && data.fetchBaseURL.match(/&rnd=([0-9]{10,})\.[0-9]+/) || null;
      if(aimsid && aimsid[1] != this.aimsid) {
        WA.log("####### !!!!!!  AIMSID CHANGED !!!!!!! ###### from " + this.aimsid + " to " + aimsid[1], ts);
        s.aimsid = this.aimsid = aimsid[1];
        if(ts) {
          s.ts = ts[1]
        }
      }
    }, this);
    U.Mnt.wrapTryCatch(function() {
      WA.IcqApi.eachEvent(data.events)
    });
    if(!this._startEventsRecived && startEventsRecived) {
      this._startEventsRecived = true;
      this.afterStartEvent.fire()
    }
  }, _startSession:function(data, failCb, scope, secondTry) {
    WA.log("### startSession called");
    this._startingSession = true;
    this.aimsid = data.aimsid;
    data.ts = WA.nowFixed();
    WA.IcqApi.startSession(data.a, data.ts, data.sessionKey, function(resp) {
      this._startingSession = false;
      WA.log("##startSession resp=", resp);
      resp = resp && resp.response;
      if(resp && resp.statusCode == 200) {
        if(resp.data) {
          var aimId = resp.data.myInfo.aimId;
          WA.log("$$$ aimId:", aimId, WA.ACTIVE_MAIL);
          if(aimId !== WA.ACTIVE_MAIL) {
            if(!this._userWithWrongAimsid) {
              U.Mnt.log({reason:"breaklog", module:"userclbug2", amail:WA.ACTIVE_MAIL, cmail:WA.getUserCookieLogin(), aimId:aimId, text:"wrongAimId"});
              U.Mnt.err("wrongSessionAimid")
            }else {
              U.Mnt.log({reason:"breaklog", module:"userclbug2", amail:WA.ACTIVE_MAIL, cmail:WA.getUserCookieLogin(), aimId:aimId, text:"wrongAimIdExit"});
              return
            }
            this._userWithWrongAimsid = true;
            S.remove(["icqConnect"], function() {
            });
            WA.setTimeout(this._relogin, 300, this);
            return
          }else {
            if(this._userWithWrongAimsid) {
              delete this._userWithWrongAimsid;
              U.Mnt.log({reason:"breaklog", module:"userclbug2", aimId:aimId, text:"savedAimId"})
            }
          }
        }
        resp.data.a = data.a;
        resp.data.sessionKey = data.sessionKey;
        this._onLoginSuccess(resp.data)
      }else {
        if(resp && resp.statusCode > 0) {
          if(resp && resp.statusCode == 400 && !secondTry) {
            WA.serverTimeDiff = WA.now() - resp.data.ts;
            this._startSession(data, failCb, scope, true);
            return
          }else {
            if(resp && resp.statusCode == 401) {
              S.remove(["icqConnect"], function() {
              });
              failCb && failCb.call(scope || this)
            }else {
              if(resp && resp.statusCode > 439 && resp.statusCode < 453) {
                WA.log("*** " + resp.statusCode + " ***", resp.data);
                this.logout(true);
                this.__setReady()
              }else {
                this.logout();
                this.__setReady()
              }
            }
          }
          return
        }
        WA.log("###startSession fail, call failCb()");
        failCb ? failCb.call(scope || this) : this.__setReady()
      }
    }, this, function(e) {
      this._startingSession = false;
      WA.log("Unknown error", e);
      failCb ? failCb.call(scope || this) : this.__setReady()
    })
  }, isConnecting:function() {
    return this.logginIn || this._startingSession || this.connecting
  }, _relogin:function(failCb) {
    WA.log("--------ICQ._relogin()");
    if(this.logginIn || this._startingSession) {
      WA.log("[TRYING TO REPEAT LOGIN]");
      return
    }
    var data;
    S.modifyObject(["icqConnect"], function(storage) {
      data = storage.icqConnect;
      if(data && data.a && data.sessionKey) {
        this._startSession(data, function() {
          if(!this.__authSuccess) {
            this._mpopLogin(failCb)
          }else {
            WA.log("### AUTH OK, but StartSession failed!!!!!")
          }
        }, this)
      }else {
        if(1) {
          WA.log("###CANT FIND TOKEN, USE LOGINBYMPOPCOOKIE");
          this._mpopLogin(failCb)
        }else {
          if(failCb) {
            failCb()
          }
        }
      }
    }, this)
  }, _mpopLogin:function(failCb, secondTry) {
    if(this.logginIn) {
      return
    }
    if(WA.ACTIVE_MAIL !== WA.getUserCookieLogin()) {
      if(!secondTry) {
        WA.log("###Warning: cookie is wrong:", WA.ACTIVE_MAIL, WA.getUserCookieLogin());
        U.Mnt.log({reason:"breaklog", module:"userclbug2", amail:WA.ACTIVE_MAIL, cmail:WA.getUserCookieLogin(), text:"mpoploginwait"});
        WA.setTimeout(function() {
          this._mpopLogin(failCb, true)
        }, 1E3, this)
      }else {
        WA.log("###Warning: cookie is wrong AGAIN:", WA.ACTIVE_MAIL, WA.getUserCookieLogin());
        U.Mnt.log({reason:"breaklog", module:"userclbug2", amail:WA.ACTIVE_MAIL, cmail:WA.getUserCookieLogin(), text:"mpoploginstop"});
        failCb && failCb();
        U.Mnt.err("mpopLoginFailCookie")
      }
      return
    }else {
      if(secondTry) {
        U.Mnt.log({reason:"breaklog", module:"userclbug2", amail:WA.ACTIVE_MAIL, cmail:WA.getUserCookieLogin(), text:"mpoplogingo"})
      }
    }
    this.logginIn = true;
    this.__authSuccess = false;
    WA.IcqApi.tryLoginByMpopCookie(function(data) {
      WA.log("AUTH OK");
      this.__authSuccess = true;
      this.logginIn = false;
      WA.serverTimeDiff = WA.now() - data.hostTime;
      this._startSession({a:data.token.a, ts:data.hostTime, sessionKey:data.sessionKey}, failCb)
    }, this, function(data) {
      this.logginIn = false;
      WA.log("### CANNOT AUTHORIZE MPOP:", data.statusText);
      this.errorEvent.fire("invalidUser");
      failCb && failCb.call()
    })
  }, __setReady:function() {
    this.isReady = true;
    this.readyEvent.fire()
  }, startNewSession:function(data, fromAuthPage) {
    WA.log("###startNewSession", data, fromAuthPage);
    var myInfo = WA.IcqApi.fetchMyInfo(data.myInfo);
    var diff = WA.now() - data.ts;
    WA.serverTimeDiff = diff;
    U.Mnt.err("startSession");
    U.Mnt.log({loginInfo:1, state:data.myInfo.state, status:myInfo.status, aimid:myInfo.aimId, timediff:diff});
    S.save({"socket.date":+new Date, "socket.session":Math.round(Math.random() * 1E5), "server_time_diff":diff, firstload:fromAuthPage ? 1 : 0});
    if(myInfo.official) {
      S.save({"status.official":1})
    }
    S.modifyObject(["icqConnect"], function(storage) {
      storage.icqConnect = {aimsid:data.aimsid, fetchUrl:data.fetchBaseURL, sessionKey:data.sessionKey, ts:data.ts, respTs:WA.ts(), phone:myInfo.phone || "", a:data.a}
    }, this)
  }, _onLoginSuccess:function(data) {
    WA.log("SUCCESS LOGIN!", data);
    this.aimsid = data.aimsid;
    var myInfo = WA.IcqApi.fetchMyInfo(data.myInfo);
    WA.IcqApi.setTimezone();
    this.startNewSession(data);
    this.triggerEvent.fire("myInfo", myInfo);
    this._poller.connect(data.fetchBaseURL);
    this.connecting = false
  }, logout:function(forceReload) {
    WA.log("--------ICQ.logout()", forceReload);
    this.disconnect();
    S.remove(["icqConnect"], function() {
    })
  }, connected:function() {
    return this._poller.connected
  }, isValid:function(cb, elseCb, scope) {
    S.load(["socket.date"], {success:function(storage) {
      var now = +new Date;
      if(now - (storage["socket.date"] || 0) < SESSION_EXPIRE_DELAY) {
        cb.call(scope || window)
      }else {
        elseCb.call(scope || window)
      }
    }, scope:this})
  }, explainHttpError:function(errno) {
    WA.debug.Console.log("explainHttpError ", errno);
    if(errno == 0) {
      return"connectInterrupt"
    }else {
      if(errno == 503) {
        return"connectInterrupt"
      }else {
        if(errno >= 500 && errno < 599) {
          return"serviceUnavailable"
        }else {
          if(errno >= 400 && errno < 499) {
            switch(errno) {
              case 410:
                return"sessionLost";
              case 400:
              ;
              case 403:
              ;
              case 404:
                return"invalidUser";
              case 413:
                return"tooManyConnections";
              case 418:
                return"frameLoadingError";
              default:
                return"serverNotUnderstand"
            }
          }else {
            return"otherErrors"
          }
        }
      }
    }
  }, isRequestable:function() {
    return this.requestable
  }, restore:function() {
    WA.log("--------ICQ.restore()", !this._poller.restoringMode);
    if(this._poller.restoringMode) {
      return
    }
    this.forceRestore()
  }, forceRestore:function() {
    WA.log("--------ICQ.forceRestore()", this.connected());
    this._shuttingDown = false;
    if(this.connected()) {
      WA.log("ALREADY CONNECTED");
      this._poller.forceFetch();
      this.__setReady();
      return
    }
    this.isValid(function() {
      this.connecting = true;
      WA.log("Facade.restore: isValid true");
      S.load(["socket.restoreDate"], {success:function(storage) {
        var now = +new Date;
        var restoreInterval = now - (storage["socket.restoreDate"] || 0);
        if(restoreInterval < 0) {
          S.save({"socket.restoreDate":0});
          this.connecting = false
        }else {
          if(restoreInterval >= 5E3) {
            this._restoreValidConnection()
          }else {
            WA.setTimeout(this._ifActual(this._restoreValidConnection, this), 5E3 - restoreInterval, this)
          }
        }
        WA.log("SETTING WA.ConnectionFacade.connected = true", restoreInterval);
        this.__setReady()
      }, scope:this})
    }, function() {
      WA.log("Facade.restore: isValid=false");
      this.__setReady()
    }, this)
  }, getSessionId:function(cb, scope) {
    S.load(["socket.session"], function(storage) {
      cb.call(scope || window, storage["socket.session"])
    })
  }, getClist:function(errCb, scope) {
    WA.IcqApi.getContactList({}, function(success) {
      if(!success) {
        errCb && errCb.call(scope || window)
      }
    }, this)
  }, _fireErrorEvent:function(mess) {
    WA.log("--------ICQ._fireErrorEvent()", mess);
    this.networkErrorEvent.fire(mess)
  }, _onNetworkError:function(err, interval) {
    WA.log("--------ICQ._onNetworkError()", err, interval)
  }, getAttachedPhone:function(cb) {
    var phone;
    S.modifyObject(["icqConnect"], function(storage) {
      phone = storage && storage.icqConnect && storage.icqConnect.phone || "";
      cb(phone)
    }, this)
  }, setAttachedPhone:function(phone) {
    S.modifyObject(["icqConnect"], function(storage) {
      storage.icqConnect.phone = phone
    }, this)
  }, disconnect:function(endSession) {
    WA.log("--------ICQ.disconnect()", endSession);
    if(this.connected() === false && !this._shuttingDown) {
      return
    }
    this.requestable = false;
    this._shuttingDown = false;
    this._poller.disconnect();
    S.save({"socket.date":0});
    if(endSession) {
      WA.IcqApi.endSession(function() {
        S.save({"status.forced":"", "status.requested":"offline"})
      }, this)
    }
  }, relogin:function() {
    return this._relogin()
  }, _shutdown:function() {
    WA.log("--------ICQ._shutdown()", this.connected());
    if(this.connected() === false) {
      return
    }
    this.requestable = false;
    this._shuttingDown = true;
    this._poller.disconnect()
  }, _ifActual:function(cb, scope) {
    return WA.createDelegate(function() {
      var args = arguments;
      FM.ifFocused(function() {
        cb.apply(scope || window, args)
      }, function() {
        this._shutdown()
      }, this)
    }, this)
  }, _restoreValidConnection:function() {
    WA.log("--------ICQ._restoreValidConnection()");
    S.save({"socket.restoreDate":+new Date});
    S.modifyObject(["icqConnect"], function(storage) {
      var s = storage.icqConnect;
      var now = WA.ts();
      var elapsed = now - (s.respTs || 0);
      var left = s.delay - elapsed;
      if(left < 0) {
        left = 0
      }
      this.aimsid = s.aimsid;
      WA.IcqApi.onAimsidReceived();
      this.requestable = true;
      this.requestReadyEvent.fire(true);
      this._poller.connect(s.fetchUrl, left);
      this.connecting = false;
      this.__setReady()
    }, this)
  }, goAway:function(force) {
    delete this._poller.hiddenMode;
    if(force !== false) {
      this._poller.hiddenMode = true;
      WA.IcqApi.setState({view:"offline"})
    }
  }, _offlineMessages:[], confirmOfflineDelivery:function(id) {
    this._offlineMessages.push(id)
  }, discardEvents:function() {
  }, continueEvents:function() {
  }, check410:function() {
  }, send:function(method, params, cb, scope) {
    WA.IcqApi.send(method, params, cb, scope)
  }, _onAfterResponseEvent:function() {
    if(this._preventUserInfo) {
      this._preventUserInfo = false
    }
    if(this._offlineMessages.length) {
      this.send("message", {uidl:this._offlineMessages.join(";"), delivered:1});
      this._offlineMessages = []
    }
  }});
  WA.ConnectionFacade = WA.conn.ConnectionFacade = new ICQ
})();
WebAgent.namespace("WebAgent.conn");
WebAgent.conn.Connection = function() {
  var WA = WebAgent;
  var U = WA.util;
  var SOCK = WA.conn.Socket;
  var JSON = WA.getJSON();
  var Conn = WA.extend(Object, {constructor:function() {
    this.triggerEvent = new U.Event;
    this.beforeResponseEvent = (new U.Event).relay(SOCK.beforeResponseEvent);
    this.afterResponseEvent = (new U.Event).relay(SOCK.afterResponseEvent);
    SOCK.afterResponseEvent.on(this._onAfterResponseEvent, this);
    SOCK.triggerEvent.on(function() {
      try {
        this._onEvent.apply(this, arguments)
      }catch(ex) {
        U.Mnt.catchException(ex)
      }
    }, this)
  }, __mailifierResult:false, __mailifier:function(tel) {
    if(tel && tel.indexOf("tel:") == 0) {
      this.__mailifierLast = tel.substr(4, tel.length - 4);
      tel = this.__mailifierLast + "@tel.agent";
      this.__mailifierResult = true
    }else {
      this.__mailifierResult = false
    }
    return tel
  }, _onEvent:function(type, value, eventlist, eventindex) {
    var res, isChat, voip = [], stick;
    if(value && value.identifier) {
      value.email = this.__mailifier(value.identifier)
    }
    if(type == "contactListState") {
      WA.debug.Console.log("contactListState ", value)
    }
    switch(type) {
      case "contactList":
        for(var i = value.length;i--;) {
          if(value[i][0].indexOf("@uin.icq") != -1 && value[i][3].indexOf("status_") == -1) {
            value[i][3] = "icq_" + value[i][3]
          }
          value[i][0] = this.__mailifier(value[i][0]);
          if(this.__mailifierResult && !value[i][1]) {
            value[i][1] = this.__mailifierLast
          }
        }
        break;
      case "contact":
        if(value.status) {
          type = "contactStatus";
          if(WA.MainAgent.isTel(value.email)) {
            value.status.type = "tel";
            if(!("nickname" in value) || typeof value.nickname != "string") {
              value.nickname = this.__mailifierLast
            }
          }
          if(!("nickname" in value) || typeof value.nickname != "string") {
            value.nickname = value.email
          }
          if("email" in value && value.email.indexOf("@uin.icq") != -1) {
            value.status.type = "icq_" + value.status.type
          }
        }
        break;
      case "history":
        value.history = value.messages || [];
        try {
          JSON.stringify(value.history)
        }catch(e) {
          U.Mnt.log("active_dialogs_error, history_assign_value_messages")
        }
        if(value.history) {
          type = "contactHistory";
          isChat = WA.MainAgent.isChat(value.email);
          U.Array.each(value.history, function(el) {
            if(el[1].text && !el[1].mult && el[1].text.match(/^ÐÐ°Ð¼ Ð¿ÑÐ¸ÑÐ»Ð°Ð»Ð¸ ÑÑÐ¸ÐºÐµÑ\. Ð§ÑÐ¾Ð±Ñ Ð¿Ð¾ÑÐ¼Ð¾ÑÑÐµÑÑ Ð¿ÐµÑÐµÐ¹Ð´Ð¸ÑÐµ Ð¿Ð¾ ÑÑÑÐ»ÐºÐµ/)) {
              stick = el[1].text.match(/https?\:\/\/www.icq.com\/storeview\/ext_(\d+)_sticker_(\d+)/);
              if(stick[1] && stick[2]) {
                el[1].mult = {tag:WA.Sticker.getStickerCode(stick[1], stick[2])}
              }
            }
            if(!("text" in el[1])) {
              el[1].text = ""
            }
            if("to" in el[1]) {
              el[1].from = WA.ACTIVE_MAIL;
              delete el[1].to
            }
            var tmp;
            if("sender" in el[1]) {
              el[1].text = el[1].sender + ":\n" + el[1].text
            }else {
              if(isChat && (tmp = el[1].text.match(/([^:]+):\n([^@\n]+@[^@\n]+):\n([\s\S]*)/))) {
                el[1].text = tmp[2] + ":\n" + tmp[3]
              }
            }
            if("mult" in el[1]) {
              el[1].text = el[1].mult.tag;
              if("sender" in el[1]) {
                el[1].text = el[1].sender + ":\n" + el[1].text
              }
            }
            el[1].timestamp = WA.getFixedTS(el[1].timestamp)
          })
        }else {
          if(WA.isDebug) {
            throw"unknow server event";
          }
        }
        break;
      case "call":
        if(value == "talk") {
          type = "voipTalk";
          break
        }
        if(value.session && value.session.ice) {
          this._onEvent("call", {ice:value.session.ice})
        }
        if(U.Object.checkChain(value, ["session", "rtmp", "addresses"], null, voip) && U.Object.checkChain(value, ["session", "session_id"], null, voip)) {
          type = "voip";
          value = {id:value.session.id, rtmp:(voip[0].value + ";").split(";")[0], stream:voip[1].value, video:value.session.video, email:value.session.from}
        }else {
          if(value.session && value.session.ice) {
            type = "voip";
            value = {webrtc:1, id:value.session.id, video:value.session.video, email:value.session.from}
          }else {
            if(value.sdp) {
              type = "sdpMessage"
            }else {
              if(value.ice) {
                type = "voipIce";
                value = {ice:value.ice}
              }else {
                if(value.decline && value.decline == "DECLINE") {
                  type = value.id > 0 ? "voipRequestDecline" : "voipDecline";
                  value = {status:value.decline, id:value.id || 0}
                }else {
                  if(value.decline && (value.decline == "NORESP" || value.decline == "BADNUM" || value.decline == "BUSY")) {
                    type = "voipPstn";
                    value = {com:value.decline}
                  }else {
                    if(value.error || value.decline) {
                      type = "voipError";
                      value = {status:value.error || value.decline, id:value.id || 0}
                    }else {
                      if(value.video == 1 || value.video == 0) {
                        type = "voipVideo"
                      }
                    }
                  }
                }
              }
            }
          }
        }
        break;
      case "iq":
        if(value.body) {
          if(value.body.contact) {
            res = value.body.contact;
            res.identifier && (res.email = this.__mailifier(res.identifier));
            var prefix = "contact";
            if(WA.MainAgent.isTel(res.email)) {
              prefix = "tel"
            }
            if(res.unignore && res.unignore.success) {
              type = prefix + "UnignoreSuccess";
              value = res.email
            }else {
              if(res.unignore && res.unignore.error) {
                type = prefix + "UnignoreFail";
                value = {message:res.add.error, mail:res.email}
              }else {
                if(res.add && res.add.success) {
                  type = prefix + "AddSuccess";
                  value = res
                }else {
                  if(res.add && res.add.error) {
                    type = prefix + "AddFail";
                    value = {message:res.add.error, mail:res.email}
                  }else {
                    if(res.modify && res.modify.success) {
                      type = prefix + "ModifySuccess";
                      value = {phones:res.phones, email:res.email}
                    }else {
                      if(value.type == "set" && res.add && WA.MainAgent.isChat(res.email) && res.nickname && !WA.SA.get(res.email).nick) {
                        type = "contactStatus";
                        value = {email:res.email, nickname:res.nickname, status:{type:"gray", title:WA.tr("status.auth")}}
                      }
                    }
                  }
                }
              }
            }
          }else {
            if(value.body.username) {
              type = "contactMail";
              value = {id:value.id, mail:value.body.username}
            }else {
              if(value.body.mchat) {
                var res = value.body.mchat;
                if(res.error) {
                  type = "mchatError";
                  value = {iq:value.id, from:value.from, error:res.error}
                }else {
                  if(res.success) {
                    value = {iq:value.id, from:value.from};
                    type = "mchatSuccess";
                    if(res.id) {
                      value.id = res.id;
                      type = "mchatCreated"
                    }
                  }else {
                    if(res.op) {
                      type = "mchatResult";
                      value.id && (res.iq = value.id);
                      res.from = value.from;
                      value = res;
                      if((res.from + "").indexOf("@") == -1) {
                        res.from = WA.ACTIVE_MAIL;
                        res.op = res.op == "add" ? "attached" : "detached"
                      }
                      var chatMessage = WA.CreateConference.formatChatEventMessage(res.op, res.from, res.members);
                      if(chatMessage && res.from !== WA.ACTIVE_MAIL) {
                        this._onEvent("message", {from:res.id, timestamp:res.timestamp || WA.now(), text:chatMessage, request:res.op == "invite" ? {authorize:true} : false})
                      }
                      if(res.op == "create") {
                        type = "mchatCreated"
                      }
                    }else {
                      if(res.members) {
                        type = "mchatMembers";
                        value = {iq:value.id, members:res.members};
                        if(res.owner) {
                          value.owner = res.owner
                        }
                      }
                    }
                  }
                }
              }
            }
          }
        }
        break;
      case "sms":
        if(value.delivery_status) {
          type = "smsDeliveryStatus";
          value.from = this.__mailifier(value.from);
          value.tel = this.__mailifierLast;
          value.text = value.delivery_status
        }else {
          if(value.text) {
            value.from = this.__mailifier(value.from);
            value.tel = this.__mailifierLast
          }
        }
        var prevevent = eventlist[eventindex - 1];
        if(!prevevent || prevevent[0] != "contact" || prevevent[1].identifier != value.from && prevevent[1].email != value.from && prevevent[1].phones && U.Array.indexOf(prevevent[1].phones, value.tel) == -1) {
          this._onEvent("contact", {identifier:value.from, status:{type:"offline"}, nickname:this.__mailifierLast, phones:[this.__mailifierLast]})
        }
        break;
      case "message":
        isChat = value.from && WA.MainAgent.isChat(value.from);
        if(value.timestamp) {
          value.timestamp = WA.getFixedTS(value.timestamp)
        }
        var tmp;
        if(isChat && "sender" in value) {
          value.origText = value.text;
          value.text = value.sender + ":\n" + value.text
        }
        if(value.composing) {
          type = "typingNotify"
        }else {
          if(value.request && value.request.authorize) {
            type = "authRequest";
            if(!WA.SA.get(value.from).nick) {
              var uniq = Math.round(Math.random() * 999999);
              this._modifyAuthWaitingList(function(list) {
                list[uniq] = value;
                return list
              }, this);
              var params = {email:value.from, uniq:uniq};
              WA.conn.Socket.send("wp", params);
              return
            }
          }else {
            if(value.error) {
              type = "messageError"
            }else {
              if(value.delivered) {
                type = "messageDelivered";
                U.Mnt.countRB(1348707)
              }else {
                if(value.text && !value.mult && (value.origText || value.text).match(/^ÐÐ°Ð¼ Ð¿ÑÐ¸ÑÐ»Ð°Ð»Ð¸ ÑÑÐ¸ÐºÐµÑ\. Ð§ÑÐ¾Ð±Ñ Ð¿Ð¾ÑÐ¼Ð¾ÑÑÐµÑÑ Ð¿ÐµÑÐµÐ¹Ð´Ð¸ÑÐµ Ð¿Ð¾ ÑÑÑÐ»ÐºÐµ/)) {
                  stick = (value.origText || value.text).match(/https?\:\/\/www.icq.com\/storeview\/ext_(\d+)_sticker_(\d+)/);
                  if(stick[1] && stick[2]) {
                    value.mult = {tag:WA.Sticker.getStickerCode(stick[1], stick[2])}
                  }
                }else {
                  if(!("text" in value)) {
                    value.text = ""
                  }
                }
              }
            }
          }
        }
        break;
      case "wp":
        if(value.uniq) {
          if(value.error) {
          }else {
            if(value.uniq) {
              this._modifyAuthWaitingList(function(list) {
                if(list[value.uniq]) {
                  var contact = value.result[0];
                  var status = WA.SA.get(contact.email);
                  this.triggerEvent.fire("contactStatus", {email:contact.email, nickname:WA.MainAgent.WP2Nick(contact), status:{type:status.status || "gray", title:status.statusTitle || WA.tr("status.auth")}});
                  this.triggerEvent.fire("authRequest", list[value.uniq]);
                  SOCK.afterResponseEvent.fire();
                  delete list[value.uniq]
                }
                return list
              }, this)
            }
          }
        }
        break;
      case "userInfo":
        if(this._preventUserInfo) {
          return
        }
        this._preventUserInfo = true;
        break;
      case "now":
        if(value > 0) {
          var tsDiff = Math.round(+new Date / 1E3) - value;
          WA.serverTimeDiff = tsDiff;
          WA.Storage.save({"server_time_diff":tsDiff})
        }
        break
    }
    this.triggerEvent.fire(type, value)
  }, _modifyAuthWaitingList:function(cb, scope) {
    WA.Storage.load(["authWaitingList"], function(storage) {
      var list = JSON.parse(storage["authWaitingList"] || "{}");
      if("length" in list) {
        list = {}
      }
      list = cb.call(scope || window, list);
      WA.Storage.save({authWaitingList:JSON.stringify(list)})
    })
  }, getSessionId:function(cb, scope) {
    SOCK.isValid(function() {
      SOCK.getSessionId(cb, scope)
    }, function() {
      cb.call(scope || window, null)
    }, this)
  }, getClist:function(onSuccess, onError, scope) {
    SOCK.send("contactlist", {}, function(success) {
      if(success) {
        onSuccess && onSuccess.call(scope || window)
      }else {
        onError && onError.call(scope || window)
      }
    }, this)
  }, getMailById:function(id) {
    SOCK.send("username", {"verify-uid":id, "iq-id":id}, function(success) {
    }, this)
  }, _offlineMessages:[], confirmOfflineDelivery:function(id) {
    this._offlineMessages.push(id)
  }, _onAfterResponseEvent:function() {
    if(this._preventUserInfo) {
      this._preventUserInfo = false
    }
    if(this._offlineMessages.length) {
      SOCK.send("message", {uidl:this._offlineMessages.join(";"), noread:1, delivered:1});
      this._offlineMessages = []
    }
  }});
  return SOCK ? new Conn : null
}();
WebAgent.namespace("WebAgent.conn");
WebAgent.conn.UserState = function() {
  var WA = WebAgent;
  var S = WA.Storage;
  var SOCK = WA.conn.ConnectionFacade;
  var U = WA.util;
  var FM = WA.FocusManager;
  var JSON = WA.getJSON();
  var AUTO_AWAY_TIMEOUT = 30 * 1E3;
  function intervalMessage(interval) {
    return Math.ceil((interval || 0) / 1E3) || WA.tr("msgPartFew")
  }
  var AutoAway = WA.extend(WA.ui.Component, {DISABLE_AUTOAWAY:false, constructor:function() {
    FM.focusEvent.on(this._onFocus, this);
    FM.blurEvent.on(this._onBlur, this);
    this.checker = new U.DelayedTask({interval:1E3, fn:this._onCheck, scope:this})
  }, activate:function() {
    if(this.DISABLE_AUTOAWAY) {
      return
    }
    WA.getBody().on("mousemove", this._onUserEvents, this).on("mousedown", this._onUserEvents, this).on("keydown", this._onUserEvents, this)
  }, deactivate:function() {
    if(this.DISABLE_AUTOAWAY) {
      return
    }
    WA.getBody().un("mousemove", this._onUserEvents, this).un("mousedown", this._onUserEvents, this).un("keydown", this._onUserEvents, this)
  }, _onFocus:function(isTimeout) {
    if(this.DISABLE_AUTOAWAY) {
      return
    }
    WA.SessionStorage.load(["autoaway"], {success:function(storage) {
      this.isAway = !!storage["autoaway"];
      this._focused = true;
      if(!isTimeout && !this.isAway) {
        this._onUserEvents()
      }
      this.checker.start();
      WA.debug.Console.log("AUTOAWAY: focus, isAway=", this.isAway)
    }, scope:this})
  }, _onBlur:function() {
    this._focused = false;
    this.checker.stop();
    WA.debug.Console.log("AUTOAWAY: blur")
  }, _onUserEvents:function() {
    if(this._focused) {
      this._date = +new Date;
      if(this.isAway) {
        this._onComeback()
      }
    }
  }, _onCheck:function() {
    if(!this.isAway && +new Date - this._date > AUTO_AWAY_TIMEOUT) {
      this._onAway()
    }
    this.checker.start()
  }, _onComeback:function() {
    this.isAway = false;
    WA.SessionStorage.save({"autoaway":""});
    WA.ConnectionFacade.goAway(false)
  }, _onAway:function() {
    this.isAway = true;
    WA.SessionStorage.save({"autoaway":"1"});
    WA.ConnectionFacade.goAway(true)
  }});
  WA.AutoAway = new AutoAway;
  var UserState = WA.extend(Object, {constructor:function() {
    this._restore_int = 1E3;
    this._lastCheckDate = 0;
    this.permanentShutdownEvent = new U.Event;
    this.networkErrorEvent = new U.Event;
    this.readyEvent = new U.Event;
    this.disconnectedEvent = new U.Event;
    this.statusChangedEvent = new U.EventConfirm;
    this.statusChangedEvent.on(function(status) {
      WA.debug.Console.log("statusChangedEvent ", status)
    });
    SOCK.readyEvent.on(this._onSocketReady, this);
    SOCK.triggerEvent.on(this._onServerEvent, this);
    SOCK.requestReadyEvent.on(this._onSocketRequestable, this);
    SOCK.errorEvent.on(this._onNetworkError, this)
  }, init:function() {
    this.sync = WA.Synchronizer.registerComponent("user_state", ["data"], false);
    this.sync.triggerEvent.on(this._onSync, this)
  }, _onSync:function(data) {
    if(data.isChanged("data")) {
      data = JSON.parse(data.get("data") || "false");
      if(data) {
        if(data.connectionsLimit) {
          this.permanentShutdownEvent.fire({isShowInfo:true, info:WA.tr("msgTooManyConnections")})
        }
      }
    }
  }, _saveState:function(state) {
    this.sync.write("date", JSON.stringify(state))
  }, _clearState:function() {
    this.sync.write("date", "")
  }, isValidUser:function() {
    if(WA.getUserLogin()) {
      return true
    }else {
      this._onInvalidUser();
      return false
    }
  }, _fireErrorEvent:function(mess) {
    if(!this._needFireError) {
      if(!this._needFireErrorTimer) {
        var timeout = WA.isFF ? 25E3 : 3E3;
        this._needFireErrorTimer = WA.setTimeout(function() {
          delete this._needFireErrorTimer;
          this.networkErrorEvent.fire(mess)
        }, timeout, this)
      }
      this._needFireError = true
    }else {
      clearTimeout(this._needFireErrorTimer);
      delete this._needFireErrorTimer;
      this.networkErrorEvent.fire(mess)
    }
  }, _onNetworkError:function(err, interval) {
    WA.debug.Console.log("net err ", err, interval);
    if(this._checkTimer) {
      clearTimeout(this._checkTimer);
      delete this._checkTimer
    }
    var __errorFromUS = this.__errorFromUS;
    this.__errorFromUS = false;
    switch(err) {
      case "otherErrors":
        SOCK.connected() || SOCK.restore();
      case "connectInterrupt":
        clearTimeout(this._resetNeedFireErrorTimer);
        if(!__errorFromUS) {
          this._fireErrorEvent(intervalMessage(interval));
          return
        }
        if(!SOCK.connected()) {
          this._fireErrorEvent(intervalMessage(interval))
        }
        break;
      case "invalidUser":
        this._onInvalidUser(WA.tr("msgInvalidUser"));
        break;
      case "connectTimeout":
      ;
      case "sessionLost":
        if(WA.getUserLogin() != WA.ACTIVE_MAIL) {
          this._onInvalidUser(WA.tr("msgInvalidUser"))
        }else {
          clearTimeout(this._resetNeedFireErrorTimer);
          this._fireErrorEvent(WA.tr("msgPartFew"));
          this._checkConnectivity()
        }
        break;
      case "serviceUnavailable":
        clearTimeout(this._resetNeedFireErrorTimer);
        this._fireErrorEvent(intervalMessage(this.serviceUnavailableDelay));
        this._checkTimer = WA.setTimeout(WA.createDelegate(function() {
          delete this._checkTimer;
          FM.ifFocused(function() {
            this._checkConnectivity()
          }, function() {
          }, this)
        }, this), this.serviceUnavailableDelay);
        this.serviceUnavailableDelay = 1E4;
        break;
      case "serverNotUnderstand":
        break;
      case "frameLoadingError":
        clearTimeout(this._resetNeedFireErrorTimer);
        this.networkErrorEvent.fire(intervalMessage(interval), err);
        __errorFromUS && this._checkConnectivity();
        this._needFireError = true;
        break;
      case "tooManyConnections":
        this.permanentShutdownEvent.fire({isShowInfo:true, info:WA.tr("msgTooManyConnections")});
        break
    }
  }, _onInvalidUser:function(info) {
    SOCK.disconnect();
    this.invalidUser = true;
    if(WA.allowAuth || WA.isPopup) {
      this.permanentShutdownEvent.fire({reason:"showAuthForm"})
    }else {
      if(info) {
        this.permanentShutdownEvent.fire({reason:"noAuth", isShowInfo:true, info:info})
      }
    }
    if(WA.isPopup) {
    }
  }, _onSocketRequestable:function(force) {
    WA.log("###US._onSocketRequestable", force);
    S.load(["status.forced", "status.forced_title"], {success:function(storage) {
      if(storage["status.forced"]) {
        this._setStatus(storage["status.forced"], storage["status.forced_title"])
      }
    }, scope:this});
    if(force && this._needFireErrorTimer) {
      clearTimeout(this._needFireErrorTimer);
      delete this._needFireErrorTimer
    }
  }, isReady:false, _onServerEvent:function(type, value) {
    switch(type) {
      case "logout":
        this.connected = false;
        if(value && value.endCode == 9) {
        }
        this.statusChangedEvent.fire({success:function() {
          SOCK.disconnect();
          this.disconnectedEvent.fire()
        }, scope:this}, "offline", null);
        return false;
        break
    }
  }, getStatus:function(cb, scope) {
    S.load(["status.requested", "status.forced", "status.requested_title", "status.forced_title"], {success:function(storage) {
      var st = storage["status.forced"] || storage["status.requested"] || "online";
      var st_title = storage["status.forced_title"] || storage["status.requested_title"] || "";
      cb.call(scope || window, st, st_title)
    }, scope:this})
  }, getActualStatus:function(cb, scope) {
    S.load(["status.disabled"], {success:function(storage) {
      if(storage["status.disabled"] && !WA.isPopup) {
        cb.call(scope || window, "disabled")
      }else {
        this.getStatus(cb, scope)
      }
    }, scope:this})
  }, getState:function(cb, scope) {
    S.load(["status.disabled", "status.disabled_requested"], {success:function(storage) {
      WA.setTimeout(function() {
        if("enabled" in WA && WA.enabled ^ !storage["status.disabled"]) {
          storage["status.disabled"] = ["1", ""][+WA.enabled];
          S.save(storage)
        }
        if(storage["status.disabled"] && !WA.isPopup) {
          cb.call(scope || window, "disabled")
        }else {
          SOCK.isValid(function() {
            cb.call(scope || window, "online")
          }, function() {
            this.getActualStatus(function(status) {
              if(status == "offline" && storage["status.disabled_requested"]) {
                cb.call(scope || window, "offline")
              }else {
                cb.call(scope || window)
              }
            }, this)
          }, this)
        }
      }, 1, this)
    }, scope:this})
  }, checkConnectivity:function() {
    if(this._statusRequested || new Date - this._lastCheckDate < 3E3) {
      return
    }
    if(this._restore_int > 1E3) {
      this._restore_int = this._restore_int / 2
    }
    if(this.serviceUnavailableDelay > 2E3) {
      this.serviceUnavailableDelay = 2E3
    }
    if(this._checkTimer) {
      clearTimeout(this._checkTimer);
      delete this._checkTimer
    }
    this._checkConnectivity(true)
  }, _onSocketReady:function() {
    WA.debug.Console.log("_onSocketReady, SOCK.connected: ", SOCK.connected());
    if(SOCK.connected()) {
      this.connected = true;
      this.isReady = true;
      this.readyEvent.fire()
    }else {
      this._checkConnectivity()
    }
  }, _commitEnabledStatus:function(storage, enabled) {
    var props = {}, saveProps = false;
    if(typeof enabled == "boolean" && enabled != !storage["status.disabled"]) {
      props["status.disabled"] = ["1", ""][+enabled];
      saveProps = true
    }
    if(!storage["status.disabled_requested"]) {
      props["status.disabled_requested"] = 1;
      saveProps = true
    }
    if(saveProps) {
      S.save(props)
    }
  }, _jimDomain:"jiml.mail.ru", _checkConnectivity:function() {
    if(this._logginIn || this._statusRequested || new Date - this._lastCheckDate < 3E3) {
      return
    }
    if(WA.ConnectionFacade.isConnecting()) {
      return false
    }
    if(this.invalidUser) {
      return false
    }
    WA.log("_checkConnectivity()", WA.ConnectionFacade.isConnecting());
    if(SOCK.connected()) {
      WA.log("return ONLINE");
      this.connected = true;
      this.statusChangedEvent.fire(null, "online", null)
    }else {
      S.load(["status.otherClientDate", "status.requested", "status.forced", "status.forced_title", "status.requested_title", "status.disabled", "status.disabled_requested", "status.disabled_check_date"], {success:function(storage) {
        var st = storage["status.forced"] || storage["status.requested"] || "online";
        var st_title = storage["status.forced_title"] || storage["status.requested_title"] || "";
        var onUserStatus = function(status) {
          WA.log("###US.onUserStatus", st, status);
          this._commitForcedStatus(storage["status.forced"], storage["status.forced_title"], !status.online);
          status.enabled = status.enabled !== false;
          this._commitEnabledStatus(storage, status.enabled);
          if(storage["status.forced"] && storage["status.forced"] != "offline") {
            WA.ConnectionFacade.relogin();
            this.connected = true
          }else {
            if(status.multilogin || !status.online) {
              if(st != "offline") {
                WA.ConnectionFacade.relogin();
                this.connected = true
              }else {
                this.connected = false
              }
            }else {
              this.connected = false
            }
          }
          this.isReady = true;
          if(this.connected) {
            this.statusChangedEvent.fire(null, st, st_title)
          }else {
            this.statusChangedEvent.fire(null, "offline", null)
          }
          this.readyEvent.fire(this.connected)
        };
        if(st != "offline") {
          if(WA.isPopup || !storage["status.disabled"]) {
            WA.log("###US._getUserStatus");
            this._getUserStatus(onUserStatus, function(status, explain, errdata) {
              this.__errorFromUS = true;
              this._onNetworkError(explain, errdata && errdata.reconnect_timeout)
            }, this)
          }
        }else {
          this.statusChangedEvent.fire(null, "offline", null)
        }
      }, scope:this})
    }
  }, _commitForcedStatus:function(forcedStatus, forcedTitle, saveRequested) {
    if(forcedStatus) {
      S.save({"status.forced":"", "status.forced_title":""});
      if(saveRequested) {
        S.save({"status.requested":forcedStatus, "status.requested_title":forcedTitle || ""})
      }
    }
  }, getForcedJim:function() {
    var m = ("" + document.location).match(/wa_(?:force_)?jim=([^&#]+)/i);
    if(m) {
      return m[1]
    }else {
      if(document.location.host.match(/^.+\.dev\.mail\.ru$/)) {
        return"jim1.dev.mail.ru"
      }else {
        if(false) {
          return"jimtest.mail.ru"
        }
      }
    }
  }, _getUserStatus:function(cb, scope) {
    this.getUserStatus(cb, function(status, explain, errdata) {
      this.__errorFromUS = true;
      this._onNetworkError(explain, errdata && errdata.reconnect_timeout)
    }, this)
  }, getUserStatus:function(cbSuccess, cbFail, scope) {
    var respCb = WA.createDelegate(function(response) {
      this._statusRequested = false;
      if(!response) {
        response = {}
      }
      if(!response.status) {
        response.status = 0
      }
      if(response.status == 200 && !response.data) {
        response.status = 0
      }
      if(response.status != 200) {
        cbFail.call(scope || window, response.status, SOCK.explainHttpError(response.status), response.errorData)
      }else {
        this._restore_int = 1E3;
        var status;
        U.Mnt.errorReason(response.data, function() {
          status = eval("(" + response.data + ")")[0][1].body.user.status
        });
        cbSuccess.call(scope || window, status)
      }
    }, this);
    this._statusRequested = true;
    this._lastCheckDate = +new Date;
    WA.XDRequest.getInstance(this.getForcedJim() || this._jimDomain).request({url:"/user/status", data:WA.isProblemSafari ? {forcedStatus:1} : {}}, respCb, respCb)
  }, _setStatus:function(status, title, forceStateChange) {
    WA.log("###US._setStatus called", status);
    WA.debug.Console.log("_setStatus: ", status, " connected:", this.connected);
    if(this.connected && status == "offline") {
      this.statusChangedEvent.fire({success:function() {
        SOCK.disconnect();
        WA.IcqApi.endSession(this._checkChangeSuccess, this);
        this.connected = false;
        this.disconnectedEvent.fire()
      }, scope:this}, status, null)
    }else {
      if(this.connected && status != "offline") {
        this.statusChangedEvent.fire(null, status, title);
        if(status == "invisible") {
          if(forceStateChange) {
            WA.IcqApi.setState({view:"invisible"}, this._checkChangeSuccess, this)
          }
        }else {
          if(forceStateChange) {
            WA.IcqApi.setState({view:"online"})
          }
          var params = {mood:"", statusMsg:"", title:""};
          if(status != "online") {
            params = {mood:WA.Statuses.getMoodId(status), title:title, statusMsg:WA.Statuses.getMoodText(status)}
          }
          WA.IcqApi.setStatus(params, this._checkChangeSuccess, this)
        }
      }else {
        if(!this.connected && status != "offline") {
          this.statusChangedEvent.fire(null, status, title)
        }
      }
    }
  }, setStatus:function(status, title) {
    WA.log("###US.setStatus()", status);
    this.getStatus(function(currentStatus) {
      S.save({"status.forced":status, "status.forced_title":title});
      var forceStateChange = (currentStatus == "invisible" || status == "invisible") && status != currentStatus;
      this._setStatus(status, title, forceStateChange)
    }, this)
  }, _checkChangeSuccess:function(success, response) {
    if(success) {
      S.load(["status.forced", "status.forced_title"], {success:function(storage) {
        this._commitForcedStatus(storage["status.forced"], storage["status.forced_title"], true)
      }, scope:this})
    }else {
      if(WA.isDebug) {
        WA.error("Unable to change status")
      }
    }
  }});
  return new UserState
}();
WebAgent.namespace("WebAgent.conn");
(function() {
  var WA = WebAgent;
  var CONN = WA.ConnectionFacade;
  WebAgent.conn.ConnectionRoster = WA.extend(Object, {constructor:function() {
    CONN.triggerEvent.on(this._onConnectionTriggerEvent, this);
    CONN.beforeResponseEvent.on(this._onBeforeConnectionResponse, this);
    CONN.afterResponseEvent.on(this._onAfterConnectionResponse, this)
  }, _onBeforeConnectionResponse:function() {
  }, _onAfterConnectionResponse:function() {
  }, _onConnectionTriggerEvent:function(type, value) {
    var method = "_onConnection" + type.substr(0, 1).toUpperCase() + type.substr(1);
    if(this[method]) {
      this[method].call(this, value)
    }
  }, destroy:function() {
    CONN.triggerEvent.un(this._onConnectionTriggerEvent, this);
    CONN.beforeResponseEvent.un(this._onBeforeConnectionResponse, this);
    CONN.afterResponseEvent.un(this._onAfterConnectionResponse, this)
  }})
})();
(function() {
  var WA = WebAgent;
  var U = WA.util;
  var UI = WA.ui;
  var GuidePopup = new (WA.extend(WA.ui.Component, {_onRender:function(ct) {
    this.el = ct.createChild({cls:"nwa-guide", children:[{cls:"nwa-guide__header", children:[{children:"ÐÑÐ¸Ð½Ð¾ÑÐ¸Ð¼ ÑÐ²Ð¾Ð¸ Ð¸Ð·Ð²Ð¸Ð½ÐµÐ½Ð¸Ñ, Ð¸Ð·-Ð·Ð° Ð¿Ð¾ÑÐ»ÐµÐ´Ð½Ð¸Ñ Ð¾Ð±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ð¹ Chrome, Ð´Ð»Ñ Ð²ÐºÐ»ÑÑÐµÐ½Ð¸Ñ Ð·Ð²ÑÐºÐ°<br/>Ð¿ÑÐ¸ Ð·Ð²Ð¾Ð½ÐºÐµ, Ð½ÐµÐ¾Ð±ÑÐ¾Ð´Ð¸Ð¼Ð¾ Ð²ÑÐ¿Ð¾Ð»Ð½Ð¸ÑÑ 4 Ð¿ÑÐ¾ÑÑÑÑ Ð´ÐµÐ¹ÑÑÐ²Ð¸Ñ"}, {cls:"nwa-guide__header-close"}]}, {cls:"nwa-guide__body", children:[{children:'ÐÑÐ»Ð¸ Ð¿Ð¾ÑÐ»Ðµ ÑÑÐ¸Ñ Ð´ÐµÐ¹ÑÑÐ²Ð¸Ð¹ Ð¿ÑÐ¾Ð±Ð»ÐµÐ¼Ð° ÑÐ¾ÑÑÐ°Ð½ÑÐµÑÑÑ, ÑÐ»ÐµÐ´ÑÐ¹ÑÐµ Ð¸Ð½ÑÑÑÑÐºÑÐ¸ÑÐ¼ Ð½Ð° ÑÑÐ¾Ð¹ ÑÑÑÐ°Ð½Ð¸ÑÐµ (<a target="_blank" href="http://agent.mail.ru/chromefaq ">ÑÑÑÐ»ÐºÐ°</a>)'}]}]});
    this.headerEl = this.el.first();
    this.headerEl.last().on("click", this.hide, this)
  }, hide:function() {
    if(this.el) {
      this.el.removeClass("nwa-guide_shown");
      this._onHide()
    }
  }, show:function() {
    if(this.el) {
      this.el.addClass("nwa-guide_shown");
      this._onShow()
    }
  }}))({hideOnEscape:true});
  WA.showGuidePopup = function() {
    if(!GuidePopup.rendered) {
      GuidePopup.render(WA.ma.el)
    }
    GuidePopup.show()
  };
  var MediaHint = WA.extend(WA.ui.Component, {constructor:function(config) {
    MediaHint.superclass.constructor.apply(this, arguments);
    this.closeEvent = new U.Event
  }, _onRender:function(ct) {
    this.el = ct.createChild({cls:"nwa-mediahint", children:[{cls:"nwa-mediahint__text", html:""}, {cls:"nwa-mediahint__close"}, {cls:"nwa-mediahint__img"}, {tag:"button", cls:"nwa-button nwa-mediahint__ok", html:WA.tr("box.ok")}]})
  }, _onAfterRender:function() {
    this.el.on("click", this._onClick, this)
  }, _onClick:function(e) {
    var trg = e.getTarget(true);
    if(trg.hasClass("nwa-mediahint__close") || trg.hasClass("nwa-mediahint__ok")) {
      WA.Voip.rtcLog("mediahint close");
      this.closeEvent.fire();
      this.hide()
    }
  }, show:function(offsetLeft, withCam) {
    WA.Voip.rtcLog("mediahint show");
    MediaHint.superclass.show.apply(this, arguments);
    this.el.toggleClass("nwa-mediahint_camera", !!withCam);
    this.el.first().update(withCam ? WA.tr("voip.allowCameraAdvise") : WA.tr("voip.allowMicrophoneAdvise"));
    this.el.setStyle({left:offsetLeft - 305 + "px"})
  }, destroy:function() {
    MediaHint.superclass.destroy.apply(this, arguments);
    this.closeEvent.removeAll();
    this._el && this._el.remove()
  }});
  var VoipView = WA.extend(WA.ui.Component, {constructor:function(config) {
    VoipView.superclass.constructor.apply(this, arguments);
    this.swfDOM = null;
    this.dragger = null;
    this.expanded = false;
    this.swfPath = config.swfPath;
    this.swfVersionRequired = config.swfVersionRequired;
    this.minimizeEvent = new U.Event
  }, _onRender:function(ct) {
    this.el = ct.createChild({cls:"nwa-vcall", children:[{cls:"nwa-vcall__header", children:[{cls:"nwa-vcall__header-avatar"}, {cls:"nwa-vcall__header-mini", "data-action":"minimize"}, {cls:"nwa-vcall__header-close", "data-action":"hangup"}]}, {cls:"nwa-vcall__body", children:[{cls:"nwa-vcall__body-avatar"}, {cls:"nwa-vcall__bottom"}, {id:"nwaVoipSwf"}]}]});
    U.swf.embedSWF(this.swfPath, "nwaVoipSwf", "100%", "100%", this.swfVersionRequired, false, {cb:"WebAgent.Voip.swfCb"}, {name:"nwaVoipSwf", allowScriptAccess:"always", allowFullScreen:"true", loop:"false", bgcolor:"#E7F1F8"}, {"class":"nwa-vcall__swf", allowScriptAccess:"always", allowFullScreen:"true", bgcolor:"#E7F1F8"}, null);
    this.swfDOM = WA.get("nwaVoipSwf").dom;
    this.headerEl = this.el.first();
    this.statusField = this.headerEl.createChild({cls:"nwa-vcall__header-status", children:{tag:"span"}});
    this.nameBox = this.headerEl.createChild({cls:"nwa-namebox", children:[{tag:"div", cls:"nwa-namebox__label"}, {tag:"div", cls:"nwa-namebox__fadeout"}]});
    this.callControls = new CallControls;
    this.callControls.render(this.el);
    this.el.on("click", this._onClick, this);
    this.vol = new UI.Volume({muteCls:"nwa-voip-volume_mute", autoRender:this.headerEl.next()});
    this.vol.changeEvent.on(function(val) {
      U.Mnt.countRB(WA.Voip._call.videoCall ? 1379025 : 1216815);
      WA.Voip.volume(Math.round(val / 10) / 10)
    });
    this.dragger = new UI.Dragger({el:this.el, bar:this.headerEl})
  }, updateInfo:function(info) {
    this.mail = info.mail;
    this.nick = info.nick
  }, hide:function(callEnd) {
    if(callEnd) {
      this.expanded = false
    }
    if(this.el) {
      this.el.removeClass("nwa-vcall_expanded").removeClass("nwa-vcall_shown").removeAttribute("style")
    }
  }, useWebRTC:function(force) {
    this._RTCMode = force !== false;
    if(this._RTCMode && this.rendered && !this._elRTC) {
      this._elRTC = "";
      var html = '<video class="nwa-rtc-panel__video" id="vidRemote" autoplay></video>                        <video id="vidSource" muted="true" class="nwa-rtc-panel__smallvideo" autoplay></video>';
      this._elRTC = this.headerEl.next().createChild({cls:"nwa-rtccall nwa_fullscreen_ready"}).update(html);
      this.videoWrap = this._elRTC.first();
      this.srcVideo = document.getElementById("vidSource");
      this.remoteVideo = document.getElementById("vidRemote");
      this.videoWrap.on("dblclick", this.toggleFullscreen, this)
    }
    this.el.toggleClass("nwa-vcall_webrtc", !!this._RTCMode)
  }, toggleLocal:function(stream, audioOnly) {
    this.attachMediaStream(this.srcVideo, stream);
    if(stream) {
      this.srcVideo.play()
    }
    this.srcVideo.style.display = stream ? "block" : "none";
    WA.get(this.srcVideo).toggleClass("nwa-rtccall_audioonly", audioOnly)
  }, toggleRemote:function(stream) {
    this.attachMediaStream(this.remoteVideo, stream);
    if(stream) {
      this.remoteVideo.play()
    }
    this.remoteVideo.style.display = stream ? "block" : "none"
  }, toggleFullscreen:function() {
    WA.RTCTools.toggleFullscreenMode(this.videoWrap.dom)
  }, attachMediaStream:function(videoObj, stream) {
    stream = stream || null;
    if(navigator.mozGetUserMedia) {
      videoObj.mozSrcObject = stream
    }else {
      videoObj.src = stream ? webkitURL.createObjectURL(stream) : ""
    }
  }, stopVideo:function() {
    this.srcVideo.pause();
    this.remoteVideo.pause();
    this.attachMediaStream(this.srcVideo, null);
    this.attachMediaStream(this.remoteVideo, null)
  }, show:function(viewState, delaySwf) {
    viewState = U.Object.extend({video:0, hasPermission:0}, viewState || {});
    if(this.el) {
      if(viewState.hasPermission || this._RTCMode) {
        if(viewState.video) {
          this._expandVideo(delaySwf)
        }else {
          this.hide()
        }
      }else {
        this.el.removeClass("nwa-vcall_expanded").addClass("nwa-vcall_shown")
      }
    }
  }, _expandVideo:function(delaySwf) {
    if(this.el) {
      this.nameBox.first().update(U.String.htmlEntity(this.nick || this.mail));
      var iconUrl = WA.makeAvatar(this.mail, this.nick, "_avatar32", this.headerEl.first());
      this.headerEl.first().setStyle({"background-image":"url(" + iconUrl + ")"});
      var iconUrl180 = WA.makeAvatar(this.mail, this.nick, "_avatar180", this.headerEl.next().first());
      this.headerEl.next().first().setStyle({"background-image":"url(" + iconUrl180 + ")"});
      this.statusField.first().setAttribute("title", U.String.htmlEntity(WA.tr("status.online")));
      this.statusField.first().dom.className = WA.buildIconClass("online", true);
      if(this._RTCMode) {
        this.callControls.show()
      }
      if(delaySwf) {
        this.swfDOM.style.width = "1px";
        this.swfDOM.style.height = "1px"
      }
      this.el.addClass("nwa-vcall_shown").addClass("nwa-vcall_expanded");
      if(delaySwf) {
        WA.setTimeout(function() {
          this.swfDOM.style.width = "100%";
          this.swfDOM.style.height = "100%"
        }, 1300, this)
      }
      if(this.dragger.lastPosition == null || !this.expanded) {
        var x = parseInt(WA.getBody().dom.offsetWidth / 2 - this.el.parent().dom.offsetLeft - this.el.dom.offsetWidth / 2), y = WA.isPopup ? 80 : -390;
        this.dragger.dragTo([x, y])
      }else {
        this.dragger.dragTo()
      }
      this.expanded = true
    }
  }, _onClick:function(e) {
    var target = e.getTarget(true);
    if(!target.getAttribute("data-action")) {
      target = target.parent()
    }
    var action = target.getAttribute("data-action");
    if(action === "mute") {
      U.Mnt.countRB(1379026);
      var muted = target.getAttribute("data-muted") == "1";
      target.setAttribute("data-muted", muted ? "0" : "1");
      target.toggleClass("nwa-voip-mute_off", !muted);
      WA.Voip.mute(!muted)
    }else {
      if(action === "minimize") {
        this.hide();
        this.minimizeEvent.fire()
      }else {
        if(action === "hangup") {
          WA.Voip.hangup(true)
        }
      }
    }
  }, externalAction:function(action) {
    if(action.indexOf("volume_") == 0) {
      this.vol.controlAction(action.substr(7))
    }
  }, updateDuration:function(sec) {
    if(this._RTCMode) {
      this.callControls.updateDuration(sec)
    }else {
      WA.Voip.duration(duration2Str(sec))
    }
  }, disable:function() {
  }});
  var DurationBox = WA.extend(WA.ui.Component, {_onRender:function(ct) {
    this.el = ct.createChild({cls:"nwa-el-duration", children:[{tag:"span"}, {tag:"span", cls:"nwa-el-duration-icon"}]})
  }, update:function(s) {
    var text = duration2Str(s);
    this.el.toggleClass("nwa-el-duration_connecting", s <= 0).first().update(text)
  }});
  var CallControls = WA.extend(WA.ui.Component, {constructor:function() {
    CallControls.superclass.constructor.call(this)
  }, _onRender:function(ct) {
    this.el = ct.createChild({cls:"nwa-voip-talk", children:[{tag:"button", cls:"nwa-voip-mute", "data-action":"mute"}, {tag:"button", cls:"nwa-voip-volume", "data-action":"volume"}, {tag:"button", cls:"nwa-el-hangup", html:"<span>" + WA.tr("voip.hangup") + "</span>", "data-action":"hangup"}]});
    this.duration = new DurationBox;
    this.duration.render(this.el);
    this.vol = new UI.Volume({controlEl:this.el.first().next(), muteCls:"nwa-voip-volume_mute", autoRender:this.el});
    this.vol.changeEvent.on(function(val) {
      U.Mnt.countRB(WA.Voip._call.videoCall ? 1379025 : 1216815);
      WA.Voip.volume(Math.round(val / 10) / 10)
    });
    this.talkStarted = false
  }, updateDuration:function(s) {
    if(this.rendered) {
      this.duration.update(s)
    }
  }});
  var VoiceCallPanel = WA.extend(CallControls, {_onRender:function(ct) {
    VoiceCallPanel.superclass._onRender.apply(this, arguments);
    this.el.on("click", this._onClick, this)
  }, _onClick:function(e) {
    var target = e.getTarget(true);
    if(!target.getAttribute("data-action")) {
      target = target.parent()
    }
    var action = target.getAttribute("data-action");
    if(action === "mute") {
      U.Mnt.countRB(1216818);
      var muted = target.getAttribute("data-muted") == "1";
      target.setAttribute("data-muted", muted ? "0" : "1");
      target.toggleClass("nwa-voip-mute_off", !muted);
      WA.Voip.mute(!muted)
    }else {
      if(action === "hangup") {
        WA.Voip.hangup(true)
      }
    }
  }});
  var CallTab = WA.extend(WA.ui.Component, {_onRender:function(ct) {
    this.el = ct.createChild({cls:"nwa-voip-tab", children:[{cls:"nwa-voip-tab-avatar"}, {tag:"button", cls:"nwa-el-green", "data-action":"expand", html:"<span>" + WA.tr("voip.expand") + "</span>"}, {tag:"button", cls:"nwa-el-hangup", "data-action":"hangup", html:"<span>" + WA.tr("voip.hangup") + "</span>"}]}, true);
    this.el.on("click", this._onClick, this);
    this._nameBox = new UI.NameBox;
    this._nameBox.render(this.el);
    this.duration = new DurationBox;
    this.duration.render(this.el);
    this.talkStarted = false
  }, _onClick:function(e) {
    var target = e.getTarget(true);
    if(!target.getAttribute("data-action")) {
      target = target.parent()
    }
    var action = target.getAttribute("data-action");
    if(action === "expand") {
      WA.Voip.show();
      this.hide()
    }else {
      if(action === "hangup") {
        WA.Voip.hangup(true)
      }
    }
  }, updateDuration:function(s) {
    if(this.rendered) {
      this.duration.update(s)
    }
  }, setUserInfo:function(userInfo) {
    this.el.first().setStyle({"background-image":"url(" + WA.makeAvatar(userInfo.mail, userInfo.nick, "_avatar32", this.el.first()) + ")"});
    this._nameBox.setName(userInfo.nick)
  }});
  function duration2Str(s) {
    var sec = s % 60;
    if(s == -1) {
      return WA.tr("voip.waitingAnswer")
    }
    return s > 0 ? Math.floor(s / 60) + ":" + (sec > 9 ? sec : "0" + sec) : WA.tr("voip.connecting")
  }
  WA.VoipView = VoipView;
  WA.VoipView.MediaHint = MediaHint;
  WA.VoipView.VoiceCallPanel = VoiceCallPanel;
  WA.VoipView.CallTab = CallTab;
  WA.VoipView.DurationBox = DurationBox
})();
(function() {
  var WA = WebAgent;
  var U = WA.util;
  var SOCK = WA.conn.Socket;
  var ConnectionRoster = WA.conn.ConnectionRoster;
  var JSON = WA.getJSON();
  var GLOBAL_RTC_CALLS_ENABLED = false;
  if(navigator.mozGetUserMedia) {
    MediaStream.prototype.getVideoTracks = function() {
      return[]
    };
    MediaStream.prototype.getAudioTracks = function() {
      return[]
    }
  }else {
    if(navigator.webkitGetUserMedia && window.webkitRTCPeerConnection && window.webkitMediaStream) {
      if(!webkitMediaStream.prototype.getVideoTracks) {
        webkitMediaStream.prototype.getVideoTracks = function() {
          return this.videoTracks
        };
        webkitMediaStream.prototype.getAudioTracks = function() {
          return this.audioTracks
        }
      }
      if(!webkitRTCPeerConnection.prototype.getLocalStreams) {
        webkitRTCPeerConnection.prototype.getLocalStreams = function() {
          return this.localStreams
        };
        webkitRTCPeerConnection.prototype.getRemoteStreams = function() {
          return this.remoteStreams
        }
      }
    }
  }
  var RTCTools = {STUN:"stun:217.69.129.215:49152", VoiceSTUN:"94.100.186.134:2041", MozSTUN:"stun:23.21.150.121", isMozRTC:!!navigator.mozGetUserMedia, mediaConstraints:{"mandatory":{"OfferToReceiveAudio":true, "OfferToReceiveVideo":true}}, mediaConstraintsAudioOnly:{"mandatory":{"OfferToReceiveAudio":true, "OfferToReceiveVideo":false}}, isRTCSupported:!!(navigator.webkitGetUserMedia && window.webkitRTCPeerConnection && window.webkitMediaStream), isRTCEnabled:function() {
    return this.isRTCSupported && GLOBAL_RTC_CALLS_ENABLED
  }, attachMediaStream:function(videoObj, stream) {
    stream = stream || null;
    if(this.isMozRTC) {
      videoObj.mozSrcObject = stream
    }else {
      videoObj.src = stream ? webkitURL.createObjectURL(stream) : null
    }
  }, createRTCPeerConnection:function(ice_config) {
    var PeerConnection = this.isMozRTC ? mozRTCPeerConnection : webkitRTCPeerConnection;
    var pc_constraints = {"optional":[{"DtlsSrtpKeyAgreement":false}]};
    log("Create RTCPeerConnection with config: ", ice_config, " and constraints: ", pc_constraints);
    return new PeerConnection(ice_config, pc_constraints)
  }, createRTCSessionDescription:function(msg) {
    log("Create createRTCSessionDescription for message: ", msg);
    var SessionDescription = this.isMozRTC ? mozRTCSessionDescription : RTCSessionDescription;
    return new SessionDescription(msg)
  }, createRTCIceCandidate:function(msg) {
    var IceCandidate = this.isMozRTC ? mozRTCIceCandidate : RTCIceCandidate;
    log("Create IceCandidate with config: ", {sdpMLineIndex:msg.label, candidate:msg.candidate});
    return new IceCandidate({sdpMLineIndex:msg.label, sdpMid:msg.label == 0 ? "audio" : "video", candidate:msg.candidate})
  }, getUserMedia:function(successCb, failureCb, withVideo) {
    var getUserMedia = this.isMozRTC ? navigator.mozGetUserMedia : navigator.webkitGetUserMedia;
    getUserMedia.call(navigator, {video:!!withVideo, audio:true}, successCb, failureCb)
  }, createOffer:function(connection, successCb, failureCb, audioOnly) {
    var constraints = audioOnly ? this.mediaConstraintsAudioOnly : this.mediaConstraints;
    if(this.isMozRTC) {
      constraints.mandatory.MozDontOfferDataChannel = true
    }
    log("Create Offer with constraints: ", constraints);
    connection.createOffer(function(sessionDescription) {
      log("CREATE OFFER ###########################", sessionDescription);
      successCb(sessionDescription)
    }, failureCb, constraints)
  }, createAnswer:function(connection, successCb, failureCb, audioOnly) {
    var constraints = audioOnly ? this.mediaConstraintsAudioOnly : this.mediaConstraints;
    log("Create Answer with constraints: ", constraints);
    connection.createAnswer(function(sessionDescription) {
      log("CREATE ANSWER ###########################", sessionDescription);
      successCb(sessionDescription)
    }, failureCb, constraints)
  }, isFullscreenSupported:!!(document.cancelFullScreen && document.fullScreenEnabled === true || document.webkitCancelFullScreen && document.webkitFullscreenEnabled === true || document.mozCancelFullScreen && document.mozFullScreenEnabled === true), isFullscreenMode:function() {
    return this.isFullscreenSupported && (document.fullScreen === true || document.webkitIsFullScreen === true || document.mozFullScreen === true)
  }, toggleFullscreenMode:function(el) {
    log("toggleFullscreenMode", this.isFullscreenSupported);
    if(!this.isFullscreenSupported) {
      return false
    }
    if(this.isFullscreenMode()) {
      if(document.cancelFullScreen) {
        document.cancelFullScreen()
      }else {
        if(document.webkitCancelFullScreen) {
          document.webkitCancelFullScreen()
        }else {
          if(document.mozCancelFullScreen) {
            document.mozCancelFullScreen()
          }
        }
      }
    }else {
      if(el.requestFullScreen) {
        el.requestFullScreen()
      }else {
        if(el.mozRequestFullScreen) {
          el.mozRequestFullScreen()
        }else {
          if(el.webkitRequestFullscreen) {
            el.webkitRequestFullscreen()
          }
        }
      }
    }
    return true
  }, muteAudio:function(stream, mute) {
    var audioTracks = stream.getAudioTracks();
    for(i = 0;i < audioTracks.length;i++) {
      audioTracks[i].enabled = mute === false
    }
  }};
  var RTCAbstraction = WA.extend(ConnectionRoster, {conn:null, remoteStream:null, localStream:null, started:false, requestingPermissions:false, incoming:false, candidateQueue:[], iceConfig:{}, audioOnly:false, remoteStreamEvent:new U.Event, connectedEvent:new U.Event, sdpEvent:new U.Event, errorEvent:new U.Event, constructor:function() {
    RTCAbstraction.superclass.constructor.apply(this, arguments)
  }, _onConnectionSdpMessage:function(value) {
    var sdp = JSON.parse(value.sdp);
    try {
      this._handleSdpMessage(sdp, value.sdp)
    }catch(e) {
      WA.Voip.rtcLog("SDPHANDLE FAIL", "" + e)
    }
  }, _onConnectionVoipIce:function(value) {
    log("_onConnectionIce..", value);
    this.iceConfig = {"iceServers":value.ice}
  }, connect:function(userEmail, stream, audioOnly) {
    if(this.started) {
      WA.Voip.rtcLog("inc connecting FAIL");
      return
    }
    this.started = true;
    this.audioOnly = !!audioOnly;
    log("INCOMING audioonly=" + audioOnly, this.audioOnly);
    this.initLocal(userEmail, stream);
    if(!this.conn) {
      WA.Voip.rtcLog("inc createoffer FAIL");
      this.errorEvent.fire();
      return
    }
    WA.Voip.rtcLog("inc createoffer");
    RTCTools.createOffer(this.conn, function(descr) {
      WA.Voip.rtcLog("inc sendoffer");
      this._sendMessage(descr)
    }.bind(this), function() {
      WA.Voip.rtcLog("inc createoffer FAILED")
    }, this.audioOnly)
  }, initLocal:function(userEmail, stream) {
    this.localStream = stream;
    this._createPeerConnection();
    log("ADD LOCAL STREAM", stream);
    this.conn.addStream(this.localStream)
  }, _handleSdpMessage:function(msg, txtMsg) {
    var descr;
    if(!this.conn) {
      if(msg.type === "offer") {
        WA.Voip.rtcLog("outgoing LOST OFFER")
      }else {
        if(msg.type === "answer") {
          WA.Voip.rtcLog("inc LOST ANSWER")
        }else {
          WA.Voip.rtcLog("any LOST SDP")
        }
      }
      this.errorEvent.fire();
      return
    }
    if(msg.type === "offer" && !this.started) {
      this.started = true;
      this.incoming = true;
      descr = RTCTools.createRTCSessionDescription(msg);
      log("GOT OFFER!!!", msg, descr, this.audioOnly);
      this.conn.setRemoteDescription(descr);
      RTCTools.createAnswer(this.conn, this._sendMessage.bind(this), function(e) {
        log("Create answer FAILED!", e)
      }, this.audioOnly);
      this.sdpEvent.fire("offer")
    }else {
      if(msg.type === "answer" && this.started) {
        this.waitingForAnswer = false;
        this._sendCandidates();
        descr = RTCTools.createRTCSessionDescription(msg);
        log("GOT ANSWER!!!", msg, descr);
        this.conn.setRemoteDescription(descr);
        this.sdpEvent.fire("answer")
      }else {
        if(msg.type === "set-offer" && this.started) {
          msg.type = "offer";
          descr = RTCTools.createRTCSessionDescription(msg);
          log("GOT SET-OFFER!!!", msg, descr);
          this.conn.setLocalDescription(descr)
        }else {
          if(msg.type === "set-answer" && this.started) {
            msg.type = "answer";
            descr = RTCTools.createRTCSessionDescription(msg);
            log("GOT SET-ANSWER!!!", msg, descr);
            this.conn.setLocalDescription(descr)
          }else {
            if(msg.type === "candidate" && this.started) {
              descr = RTCTools.createRTCIceCandidate(msg);
              this.conn.addIceCandidate(descr)
            }else {
              if(msg.type === "bye" && this.started) {
                log("Remote hangup.");
                this.sdpEvent.fire("bye");
                this.bye(false)
              }else {
                WA.Voip.rtcLog("SDP UNKNOWN", txtMsg)
              }
            }
          }
        }
      }
    }
  }, _createPeerConnection:function() {
    if(this.conn) {
      log("CONN: ALREADY EXISTS!!!!!!!!!!!!!!!!!!!!!!!!!!!");
      return
    }
    this.conn = RTCTools.createRTCPeerConnection(this.iceConfig);
    this.conn.onicecandidate = this._onIceCandidate.bind(this);
    this.conn.onaddstream = this._onRemoteStreamAdded.bind(this);
    this.conn.onremovestream = this._onRemoteStreamRemoved.bind(this);
    this.conn.onsignalingstatechange = function(e) {
      log("ON onsignalingstatechange ", e)
    };
    this.conn.oniceconnectionstatechange = this._onIceStateChange.bind(this);
    this.conn.signalingState = function(e) {
      log("ON signalingState ", e)
    }
  }, _onIceCandidate:function(e) {
    clearTimeout(this._sendTimer);
    if(!e.candidate) {
      clearTimeout(this._sendTimer);
      this._sendCandidates();
      return
    }
    this.candidateQueue.push(e.candidate);
    this._sendTimer = WA.setTimeout(this._sendCandidates, 200, this)
  }, _onIceStateChange:function(e) {
    if(!this.conn) {
      return false
    }
    var state = this.conn.iceConnectionState;
    log("ON ICE State change: ", state);
    if(state == "connected") {
      this.connectedEvent.fire()
    }else {
      if(state == "disconnected") {
        this.errorEvent.fire()
      }
    }
  }, _sendCandidates:function() {
    if(this.candidateQueue.length > 0) {
      var packs = [];
      WA.each(this.candidateQueue, function(candidate) {
        packs.push({type:"candidate", label:candidate.sdpMLineIndex, id:candidate.sdpMid, candidate:candidate.candidate})
      });
      this._sendMessage(packs);
      this.candidateQueue = []
    }
  }, _onRemoteStreamAdded:function(e) {
    this.remoteStream = e.stream;
    log("onRemoteStreamAdded", e);
    this.remoteStreamEvent.fire(this.remoteStream)
  }, _onRemoteStreamRemoved:function(e) {
    this.remoteStream = null;
    log("onRemoteStreamRemoved")
  }, bye:function(manual) {
    if(manual === true) {
    }
    this.candidateQueue = [];
    this.started = false;
    this.incoming = false;
    if(this.conn) {
      log("CONN: CLOSE");
      this.conn.close()
    }
    this.conn = null
  }, _sendMessage:function(msg) {
    if(!msg.length) {
      msg = [msg]
    }
    SOCK.send("call;sdp", {sdp:JSON.stringify(msg)}, function(isOk, resp) {
      log("SRVRESP:", isOk, resp);
      if(!isOk) {
        this.errorEvent.fire()
      }
    }, this)
  }});
  var RTC = WA.extend(Object, {requestingPermissions:false, mediaEvent:new U.Event, constructor:function() {
    this.abstraction = new RTCAbstraction;
    this.abstraction.remoteStreamEvent.on(function(stream) {
      this.mediaEvent.fire({type:"remoteStreamAdd", stream:stream})
    }, this);
    this.abstraction.connectedEvent.on(function() {
      this.mediaEvent.fire({type:"connected"})
    }, this);
    this.abstraction.errorEvent.on(function() {
      this.mediaEvent.fire({type:"serverError"})
    }, this);
    this.abstraction.sdpEvent.on(function(sdp) {
      this.mediaEvent.fire({type:"sdp", value:sdp})
    }, this)
  }, startOutgoing:function(email, stream, audioOnly) {
    log("START OUTGOING audioOnly=" + audioOnly);
    this.abstraction.audioOnly = audioOnly;
    this.abstraction.initLocal(email, stream, audioOnly)
  }, bye:function(manual) {
    this._clearUserMediaCb();
    this.abstraction.bye(manual)
  }, checkMic:function(successCb, failureCb, withCam) {
    this._mediaAllowCb = successCb;
    this._mediaDenyCb = failureCb;
    if(this.requestingPermissions) {
      return
    }
    this.requestingPermissions = true;
    RTCTools.getUserMedia(this._onGetUserMediaAllow.bind(this), this._onGetUserMediaDeny.bind(this), withCam)
  }, _onGetUserMediaAllow:function(stream) {
    this.requestingPermissions = false;
    this.localStream = stream;
    WA.fireSharedEvent("voipRtcMediaAllowed", {});
    var VTracks = stream.getVideoTracks();
    var ATracks = stream.getAudioTracks();
    if(this._mediaAllowCb) {
      this._mediaAllowCb.call(this, stream, [ATracks, VTracks])
    }else {
      if(stream) {
        stream.stop()
      }
    }
    this._clearUserMediaCb()
  }, _onGetUserMediaDeny:function(e) {
    this.requestingPermissions = false;
    WA.fireSharedEvent("voipRtcMediaDenied", {});
    if(this._mediaDenyCb) {
      this._mediaDenyCb.call(this, e)
    }
    this._clearUserMediaCb()
  }, _clearUserMediaCb:function() {
    this._mediaAllowCb = null;
    this._mediaDenyCb = null
  }, call:function(email, stream, audioOnly) {
    this.abstraction.connect(email, stream, audioOnly)
  }});
  function log() {
  }
  if(RTCTools.isRTCSupported) {
    WA.VoipRTC = new RTC
  }
  WA.RTCTools = RTCTools
})();
(function() {
  var WA = WebAgent;
  var U = WA.util;
  var UI = WA.ui;
  var SOCK = WA.conn.Socket;
  var ConnectionRoster = WA.conn.ConnectionRoster;
  var VoipCallState = {INIT:0, STARTED:1, MIC_REQUESTING:2, SESSION_REQUESTING:3, SESSION_RECEIVED:4, INC_INIT:6, RTMP_REQUESTING:7, RTMP_CONNECTED:8, RTMP_TALK:9, INC_MIC_REQUESTING:10, INC_MIC_ALLOWED:11};
  var VoipCallType = {PSTN:1, OUTGOING:2, INCOMING:3, PSTN_RTC:4};
  var DEBUG = false;
  var SWF_PATH = WA.resDomain + WA.resPath.replace(/\/u\//, "/r/") + "/voip.swf" + WA.suffix;
  var SWF_VERSION_REQUIRED = "10.1";
  var SWF_VERSION_PSTN = "11.0";
  var SWF_VERSION_VIDEO = "11.0";
  var VoipCall = WA.extend(ConnectionRoster, {constructor:function(config) {
    VoipCall.superclass.constructor.apply(this, arguments);
    this.id = 0;
    this._swf = config.swf;
    this.remoteID = this.phoneNumber = config.email || config.tel;
    this.RTCMode = !!config.RTCMode;
    this.callId = config.id;
    this.remoteVideo = false;
    this.errorEvent = new U.Event;
    this.messageEvent = new U.Event;
    this.changeStateEvent = new U.Event;
    this.started = false;
    this._connected = false;
    this._outgoingWaitTimer = 0;
    this._connectTimer = 0;
    this._retryTimer = 0;
    this.isAgentCall = false;
    this.videoCall = false;
    this.withCam = false;
    this._talkStart = 0;
    this.duration = 0;
    this.hasCamera = false;
    this.userInfo = config.userInfo || {};
    this.micWasAllowed = false;
    this.state = VoipCallState.INIT;
    this.durationUpdate = new U.DelayedTask({interval:1E3, fn:this._updateDuration, scope:this});
    this.ringerWaiting = new U.DelayedTask({interval:4E3, fn:function() {
      WA.Beep.play("callOut");
      this.ringerWaiting.start()
    }, scope:this})
  }, startCall:function() {
  }, onMicAllowed:function() {
    this.micWasAllowed = true
  }, setUser:function(nick, status) {
    this.userInfo = {nick:nick, status:status}
  }, connected:function() {
    this.state = VoipCallState.RTMP_CONNECTED;
    this._connected = true;
    clearTimeout(this._connectTimer);
    clearTimeout(this._retryTimer)
  }, _onConnectionVoipError:function(val) {
    if(!val.id && val.status) {
      this.errorEvent.fire(val.status, {category:"jim", tel:this.phoneNumber});
      if(val.status == "ERROR") {
        if(this._call.RTCMode) {
          U.Mnt.countRB(4972890)
        }else {
          U.Mnt.countRB(this.videoCall ? 1379014 : 1316736)
        }
      }
      if(val.status == "INCOMPATIBLE_VERS") {
        U.Mnt.countRB(this.videoCall ? 1379015 : 1316738)
      }
    }
  }, _onConnectionVoip:function(value) {
    this._rtmp = value.rtmp;
    this._stream = value.stream;
    if(this._rtmp && this._stream) {
      this.state = VoipCallState.SESSION_RECEIVED;
      this._call({video:value.video})
    }else {
      this.errorEvent.fire("voipSessionRequestFail", {category:"jim", rtmp:value.rtmp, stream:value.stream})
    }
  }, _onConnectionVoipVideo:function(value) {
    if(this.videoCall && value.video == 0 && !this.withCam) {
      this.videoCall = false;
      WA.Voip.show()
    }else {
      if(!this.videoCall && value.video == 1) {
        this.videoCall = true;
        WA.Voip.show()
      }
    }
    this.changeStateEvent.fire({video:this.videoCall});
    if(!this.RTCMode && WA.Voip._swfReady) {
      this._swf.switchVideo(!!value.video)
    }
  }, _call:function() {
  }, delayCall:function() {
    this._retryTimer = WA.setTimeout(function() {
      this._swf.callToSession(this._stream, this._rtmp, !this.isAgentCall, this.videoCall)
    }, 1500, this)
  }, hangup:function(manual) {
    if(this.state >= VoipCallState.SESSION_REQUESTING && manual) {
      WA.Voip.sendDecline()
    }
    if(WA.Voip._swfReady) {
      this._swf.hangup();
      if(this._stream) {
        return!!this._connected
      }
    }
  }, setInfo:function() {
    if(this.RTCMode) {
      return
    }
    if(WA.Voip._swfReady && this.phoneNumber && this.phoneNumber.indexOf("@") > -1) {
      var iconUrl = WA.makeAvatar(this.phoneNumber, "", "_avatar180");
      try {
        this._swf.setInfo(iconUrl, WA.isRetina)
      }catch(e) {
      }
    }
  }, onSwfLoad:function(swf) {
    if(!this.RTCMode) {
      this._swf = swf;
      this._checkMic()
    }
  }, _checkMic:function() {
    if(WA.Voip._swfReady && this.phoneNumber) {
      this.state = VoipCallState.MIC_REQUESTING;
      this.ping();
      WA.Voip.show();
      WA.setTimeout(function() {
        this._swf.checkMic(this.videoCall)
      }, 100, this)
    }
  }, ping:function() {
    if(WA.Voip._swfReady) {
      this._pongTimer = WA.setTimeout(function() {
        this.errorEvent.fire("swfCrashDetected", {category:"local", state:this.state, tel:this.phoneNumber})
      }, 100, this);
      this._swf.ping()
    }
  }, pong:function() {
    clearTimeout(this._pongTimer);
    this._pingTimer = WA.setTimeout(this.ping, 1E3, this)
  }, talk:function() {
    this.state = VoipCallState.RTMP_TALK;
    this.ringerWaiting.stop();
    this._talkStart = +new Date;
    this.durationUpdate.start();
    WA.Voip.event("callTalk", {email:this.remoteID})
  }, _updateDuration:function() {
    this.duration = Math.ceil((new Date - this._talkStart) / 1E3);
    this.changeStateEvent.fire({time:this.duration});
    this.durationUpdate.start()
  }, _sendCallStart:function(params, cb, scope) {
    if(this.RTCMode) {
      params.webrtc = "on"
    }
    SOCK.send("call;start", params, function(success) {
      cb && cb.call(scope || window, success);
      if(!success) {
        this.errorEvent.fire("voipSessionRequestFail", {category:"jim", tel:this.remoteID})
      }
    }, this)
  }, cameraDetected:function() {
    this.hasCamera = true
  }, cameraNotFound:function(type) {
    this.hasCamera = false;
    if(!this.RTCMode) {
      if(this.videoCall) {
        U.Mnt.countRB(1378996)
      }
    }
    this.errorEvent.fire(type, {category:"local"})
  }, destroy:function() {
    this.ringerWaiting.stop();
    this.durationUpdate.stop();
    clearTimeout(this._connectTimer);
    clearTimeout(this._retryTimer);
    clearTimeout(this._pingTimer);
    clearTimeout(this._pongTimer);
    clearTimeout(this._outgoingWaitTimer);
    this.changeStateEvent.fire({ended:true});
    this.errorEvent.removeAll();
    this.messageEvent.removeAll();
    this.changeStateEvent.removeAll();
    this._swf = null;
    VoipCall.superclass.destroy.apply(this, arguments)
  }});
  var PstnCall = WA.extend(VoipCall, {constructor:function(config) {
    this.isPSTN = true;
    PstnCall.superclass.constructor.apply(this, arguments)
  }, startCall:function(waitForEngineLoad) {
    this.state = VoipCallState.STARTED;
    if(waitForEngineLoad !== true) {
      this._checkMic()
    }
    this.changeStateEvent.fire({time:-1})
  }, onMicAllowed:function() {
    this.micWasAllowed = true;
    this._requestSession()
  }, _requestSession:function() {
    this.state = VoipCallState.SESSION_REQUESTING;
    var params = {flashver:U.swf.ua.pv.join("."), ua:navigator.userAgent, tel:this.phoneNumber};
    this._sendCallStart(params)
  }, _call:function() {
    this.changeStateEvent.fire({time:0});
    if(WA.Voip._swfReady && this._rtmp && this._stream) {
      this.state = VoipCallState.RTMP_REQUESTING;
      this._connectTimer = WA.setTimeout(function() {
        this.errorEvent.fire("rtmpConnectFail", {category:"rtmp", tel:this.phoneNumber})
      }, 25E3, this);
      this._swf.callToSession(this._stream, this._rtmp, true, false)
    }
  }, talk:function() {
    PstnCall.superclass.talk.call(this);
    U.Mnt.countRB(1127443)
  }});
  var PstnRtcCall = WA.extend(VoipCall, {constructor:function(config) {
    PstnRtcCall.superclass.constructor.apply(this, arguments);
    this.isPSTN = true;
    this.isAgentCall = true;
    this.videoCall = this.withCam = !!config.video
  }, startCall:function() {
    this.state = VoipCallState.STARTED;
    this._checkMic();
    this.changeStateEvent.fire({time:-1})
  }, _checkMic:function() {
    this.state = VoipCallState.MIC_REQUESTING;
    WA.fireSharedEvent("voipRtcGetUserMedia", {email:this.remoteID, camera:false, pstn:true});
    WA.VoipRTC.checkMic(this.onMicAllowed.bind(this), function() {
      if(!WA.Voip.inTalk()) {
        return
      }
      this.errorEvent.fire("micUnAllowed", {category:"local"})
    }.bind(this), this.withCam)
  }, onMicAllowed:function(stream) {
    if(!WA.Voip.inTalk()) {
      if(stream) {
        stream.stop()
      }
      return
    }
    WA.Voip.view.toggleLocal(stream, true);
    this.RTCstream = stream;
    this._requestSession()
  }, _requestSession:function() {
    this.state = VoipCallState.SESSION_REQUESTING;
    var params = {flashver:U.swf.ua.pv.join("."), ua:navigator.userAgent, tel:this.phoneNumber};
    this._sendCallStart(params)
  }, _call:function(params) {
    this.changeStateEvent.fire({time:0});
    this.state = VoipCallState.RTMP_REQUESTING;
    this._connectTimer = WA.setTimeout(function() {
      this.errorEvent.fire("rtmpConnectFail", {category:"rtmp", tel:this.phoneNumber})
    }, 3E4, this);
    WA.VoipRTC.startOutgoing(this.phoneNumber, this.RTCstream, true)
  }, _onConnectionVoip:function(value) {
    if(value) {
      this.state = VoipCallState.SESSION_RECEIVED;
      this._call({video:false})
    }else {
      this.errorEvent.fire("voipSessionRequestFail", {category:"jim"})
    }
  }, _onConnectionVoipDecline:function(val) {
    this.errorEvent.fire("declined", {category:"jim", tel:this.phoneNumber})
  }, _onConnectionVoipTalk:function() {
    this.talk()
  }, _onConnectionVoipPstn:function(val) {
    if(val.com == "talk") {
      this.talk()
    }else {
      if(val.com == "NORESP") {
        this.messageEvent.fire("BYE NO RESPONDING");
        WA.Voip.hangup()
      }else {
        if(val.com == "BADNUM") {
          this.messageEvent.fire("BYE WRONG NUMBER");
          WA.Voip.hangup()
        }else {
          if(val.com == "BUSY") {
            this.messageEvent.fire("BYE BUSY");
            WA.Voip.hangup()
          }
        }
      }
    }
  }, hangup:function(manual, silent) {
    if(this.state >= VoipCallState.SESSION_REQUESTING && manual && !silent) {
      WA.Voip.sendDecline()
    }
    WA.Voip.view.stopVideo();
    if(this.RTCstream) {
      this.RTCstream.stop()
    }
    WA.VoipRTC.bye(manual)
  }, talk:function() {
    PstnCall.superclass.talk.call(this);
    U.Mnt.countRB(1127443)
  }});
  var OutgoingCall = WA.extend(VoipCall, {constructor:function(config) {
    OutgoingCall.superclass.constructor.apply(this, arguments);
    this.isAgentCall = true;
    this.videoCall = this.withCam = !!config.video
  }, startCall:function(waitForEngineLoad) {
    this.state = VoipCallState.STARTED;
    if(waitForEngineLoad !== true) {
      this._checkMic()
    }
    WA.Voip.event("callOutgoing", {email:this.remoteID});
    this.changeStateEvent.fire({time:-1})
  }, _checkMic:function() {
    if(WA.Voip._swfReady && this.remoteID) {
      this.state = VoipCallState.MIC_REQUESTING;
      this.ping();
      WA.Voip.show();
      WA.setTimeout(function() {
        this._swf.checkMic(this.videoCall)
      }, 100, this)
    }
  }, onMicAllowed:function() {
    this.micWasAllowed = true;
    this._requestSession()
  }, _requestSession:function() {
    this.state = VoipCallState.SESSION_REQUESTING;
    this.ringerWaiting.startNow();
    U.Mnt.countRB(this.videoCall ? 1379002 : 1277225);
    this._outgoingWaitTimer = WA.setTimeout(function() {
      this.errorEvent.fire("AcceptTimedOut", {category:"jim"})
    }, 1E5, this);
    var params = {flashver:U.swf.ua.pv.join("."), ua:navigator.userAgent, email:this.phoneNumber};
    if(this.withCam) {
      params.video = 1
    }
    this._sendCallStart(params)
  }, _call:function(params) {
    U.Mnt.countRB(this.videoCall ? 1379006 : 1287322);
    if(WA.Voip._swfReady && this._rtmp && this._stream) {
      clearTimeout(this._outgoingWaitTimer);
      this.state = VoipCallState.RTMP_REQUESTING;
      if(params.video) {
        if(!this.videoCall) {
          this.changeStateEvent.fire({video:true})
        }
        this.videoCall = true;
        this.remoteVideo = true;
        WA.Voip.show()
      }
      this._connectTimer = WA.setTimeout(function() {
        this.errorEvent.fire("rtmpConnectFail", {category:"rtmp", tel:this.remoteID})
      }, 3E4, this);
      this.changeStateEvent.fire({time:0});
      this._swf.callToSession(this._stream, this._rtmp, false, this.videoCall)
    }
  }, talk:function() {
    OutgoingCall.superclass.talk.call(this);
    U.Mnt.countRB(this.videoCall ? 1379016 : 1216797)
  }, _onConnectionVoip:function(value) {
    this._rtmp = value.rtmp;
    this._stream = value.stream;
    if(this._rtmp && this._stream) {
      this.state = VoipCallState.SESSION_RECEIVED;
      this._call({video:value.video})
    }else {
      this.errorEvent.fire("voipSessionRequestFail", {category:"jim", rtmp:value.rtmp, stream:value.stream})
    }
  }, _onConnectionVoipDecline:function(val) {
    if(this.state == VoipCallState.SESSION_REQUESTING) {
      U.Mnt.countRB(this.videoCall ? 1379013 : 1290628);
      WA.Voip.event("callUserDecline", {email:this.remoteID})
    }else {
      if(this.state > VoipCallState.SESSION_REQUESTING) {
        WA.Voip.event("callUserHangup", {email:this.remoteID})
      }
    }
    this.errorEvent.fire("declined", {category:"jim", tel:this.remoteID})
  }, hangup:function(manual, silent) {
    if(this.state >= VoipCallState.SESSION_REQUESTING && manual && !silent) {
      WA.Voip.sendDecline()
    }
    if(manual) {
      if(this.state == VoipCallState.SESSION_REQUESTING) {
        WA.Voip.event("callCancel", {email:this.remoteID})
      }else {
        WA.Voip.event("callHangup", {email:this.remoteID})
      }
      if(this.state < VoipCallState.SESSION_REQUESTING) {
        U.Mnt.countRB(this.videoCall ? 1378998 : 1290642)
      }else {
        if(this.state == VoipCallState.SESSION_REQUESTING) {
          U.Mnt.countRB(this.videoCall ? 1379008 : 1290644)
        }
      }
    }
    if(WA.Voip._swfReady) {
      this._swf.hangup();
      if(this._stream) {
        return!!this._connected && !silent
      }
    }
  }});
  var OutgoingRtcCall = WA.extend(VoipCall, {constructor:function(config) {
    OutgoingRtcCall.superclass.constructor.apply(this, arguments);
    this.RTCMode = true;
    this.isAgentCall = true;
    this.videoCall = this.withCam = !!config.video
  }, startCall:function() {
    this.state = VoipCallState.MIC_REQUESTING;
    WA.fireSharedEvent("voipRtcGetUserMedia", {email:this.remoteID, camera:this.withCam});
    WA.Voip.rtcLog("outgoing checkMic");
    WA.VoipRTC.checkMic(this.onMicAllowed.bind(this), this.onMicDenied.bind(this), this.withCam);
    WA.Voip.event("callOutgoing", {email:this.remoteID});
    this.changeStateEvent.fire({time:-1})
  }, onMicAllowed:function(stream, tracks) {
    if(!WA.Voip.inTalk()) {
      if(stream) {
        stream.stop()
      }
      return
    }
    WA.Voip.rtcLog("outgoing mediaAllowed");
    if(this.withCam && (!tracks[1] || tracks[1].length == 0)) {
      WA.Voip.rtcLog("outgoing noCamera");
      U.Mnt.countRB(4972853);
      if(stream) {
        stream.stop()
      }
      this.errorEvent.fire("camNotFound", {category:"local"});
      return
    }
    WA.Voip.show();
    WA.Voip.view.toggleLocal(stream, !this.withCam);
    this.RTCstream = stream;
    this._requestSession()
  }, onMicDenied:function() {
    if(!WA.Voip.inTalk()) {
      return
    }
    WA.Voip.rtcLog("outgoing mediaDenied");
    this.errorEvent.fire("micUnAllowed", {category:"local"})
  }, _requestSession:function() {
    this.state = VoipCallState.SESSION_REQUESTING;
    this.ringerWaiting.startNow();
    WA.Voip.rtcLog("outgoing requestSession");
    U.Mnt.countRB(4972861);
    this._outgoingWaitTimer = WA.setTimeout(function() {
      this.errorEvent.fire("AcceptTimedOut", {category:"jim"})
    }, 1E5, this);
    var params = {flashver:U.swf.ua.pv.join("."), ua:navigator.userAgent, email:this.remoteID};
    if(this.withCam) {
      params.video = 1
    }
    this._sendCallStart(params)
  }, _call:function(params) {
    U.Mnt.countRB(4972863);
    clearTimeout(this._outgoingWaitTimer);
    this.state = VoipCallState.RTMP_REQUESTING;
    if(params.video) {
      if(!this.videoCall) {
        this.changeStateEvent.fire({video:true})
      }
      this.videoCall = true;
      this.remoteVideo = true;
      WA.Voip.show()
    }
    this._connectTimer = WA.setTimeout(function() {
      this.errorEvent.fire("rtcConnectFail", {category:"rtc", tel:this.remoteID})
    }, 3E4, this);
    this.changeStateEvent.fire({time:0});
    WA.Voip.rtcLog("outgoing connecting");
    WA.VoipRTC.startOutgoing(this.remoteID, this.RTCstream, !this.remoteVideo)
  }, connected:function() {
    this._connected = true;
    clearTimeout(this._connectTimer);
    this.talk()
  }, talk:function() {
    OutgoingRtcCall.superclass.talk.call(this);
    SOCK.send("call;talk", {}, function(success) {
    }, this);
    WA.Voip.rtcLog("outgoing talk");
    U.Mnt.countRB(4972900)
  }, _onConnectionVoip:function(value) {
    if(value && value.id) {
      return
    }
    if(value && value.webrtc) {
      this.state = VoipCallState.SESSION_RECEIVED;
      this._call({video:!!value.video})
    }else {
      WA.Voip.rtcLog("outgoing flash_answer");
      this.errorEvent.fire("rtcConnectFail", {category:"jim"})
    }
  }, _onConnectionVoipDecline:function(val) {
    if(this.state == VoipCallState.SESSION_REQUESTING) {
      U.Mnt.countRB(4972870);
      WA.Voip.rtcLog("outgoing declined");
      WA.Voip.event("callUserDecline", {email:this.remoteID})
    }else {
      if(this.state > VoipCallState.SESSION_REQUESTING) {
        WA.Voip.event("callUserHangup", {email:this.remoteID})
      }
    }
    this.errorEvent.fire("declined", {category:"jim", tel:this.remoteID})
  }, hangup:function(manual, silent) {
    if(this.state >= VoipCallState.SESSION_REQUESTING && manual && !silent) {
      WA.Voip.sendDecline()
    }
    if(manual) {
      if(this.state == VoipCallState.SESSION_REQUESTING) {
        WA.Voip.event("callCancel", {email:this.remoteID})
      }else {
        WA.Voip.event("callHangup", {email:this.remoteID})
      }
      if(this.state < VoipCallState.SESSION_REQUESTING) {
        WA.Voip.rtcLog("outgoing hangup before request");
        U.Mnt.countRB(4972856)
      }else {
        if(this.state == VoipCallState.SESSION_REQUESTING) {
          WA.Voip.rtcLog("outgoing hangup requesting");
          U.Mnt.countRB(5155810)
        }else {
          if(this.state > VoipCallState.SESSION_REQUESTING && this.state < VoipCallState.RTMP_TALK) {
            WA.Voip.rtcLog("outgoing hangup connecting")
          }
        }
      }
    }
    WA.Voip.view.stopVideo();
    if(this.RTCstream) {
      this.RTCstream.stop()
    }
    WA.VoipRTC.bye(manual);
    WA.Voip.rtcLog("outgoing bye")
  }});
  var IncomingCall = WA.extend(VoipCall, {constructor:function(config) {
    IncomingCall.superclass.constructor.apply(this, arguments);
    this._rtmp = config.rtmp;
    this._stream = config.stream;
    this.remoteVideo = config.video;
    this.videoCall = config.video || config.camera;
    this.withCam = config.camera;
    this.requestId = this.callId = config.id;
    this.incomingCall = true;
    this.isAgentCall = true;
    this.state = VoipCallState.INC_INIT
  }, onSwfLoad:function(swf) {
    this._swf = swf;
    this.startCall()
  }, startCall:function(waitForEngineLoad) {
    if(waitForEngineLoad !== true) {
      this._checkMic()
    }
    this.changeStateEvent.fire({time:0})
  }, onMicAllowed:function() {
    if(!WA.Voip.inTalk()) {
      return
    }
    this.micWasAllowed = true;
    this.state = VoipCallState.INC_MIC_ALLOWED;
    this.changeStateEvent.fire({time:0});
    var sendParams = {ua:navigator.userAgent, id:this.callId};
    if(this.withCam) {
      sendParams.video = 1
    }
    this._sendCallStart(sendParams);
    this.state = VoipCallState.RTMP_REQUESTING;
    if(WA.Voip._swfReady) {
      this._connectTimer = WA.setTimeout(function() {
        this.errorEvent.fire("rtmpConnectFail", {category:"rtmp"})
      }, 3E4, this);
      WA.setTimeout(function() {
        try {
          this._swf.callToSession(this._stream, this._rtmp, false, this.videoCall)
        }catch(ex) {
        }
      }, 80, this)
    }
  }, talk:function() {
    IncomingCall.superclass.talk.call(this);
    U.Mnt.countRB(this.videoCall ? 1379018 : 1216800)
  }, _onConnectionVoip:function() {
  }, _onConnectionVoipDecline:function(val) {
    this.errorEvent.fire("declined", {category:"jim", tel:this.remoteID});
    WA.Voip.event("callUserHangup", {email:this.remoteID})
  }, _onConnectionVoipRequestDecline:function(val) {
    if(val.id > 0 && val.id == this.requestId) {
      this.errorEvent.fire("declined", {category:"jim", tel:this.remoteID});
      WA.Voip.event("callUserHangup", {email:this.remoteID})
    }
  }, connected:function() {
    IncomingCall.superclass.connected.apply(this, arguments);
    if(this.micWasAllowed) {
      this._swf.publishStream()
    }
  }, _checkMic:function() {
    this.state = VoipCallState.INC_MIC_REQUESTING;
    this.ping();
    WA.Voip.show();
    this._swf.checkMic(this.withCam)
  }, cameraNotFound:function(type) {
    this.hasCamera = false
  }, hangup:function(manual, silent) {
    if(manual) {
      if(!silent) {
        if(this.state == VoipCallState.INC_MIC_REQUESTING) {
          WA.Voip.sendDecline({id:this.requestId})
        }else {
          WA.Voip.sendDecline()
        }
      }
      WA.Voip.event("callHangup", {email:this.remoteID})
    }
    if(WA.Voip._swfReady) {
      this._swf.hangup();
      if(this._stream) {
        return!!this._connected && !silent
      }
    }
  }});
  var IncomingRtcCall = WA.extend(VoipCall, {constructor:function(config) {
    IncomingRtcCall.superclass.constructor.apply(this, arguments);
    this.RTCMode = true;
    this.incomingCall = true;
    this.isAgentCall = true;
    this.requestId = this.callId = config.id;
    this.remoteVideo = config.video;
    this.withCam = config.camera;
    this.videoCall = this.remoteVideo || this.withCam;
    this.state = VoipCallState.INC_INIT
  }, startCall:function() {
    this.state = VoipCallState.INC_MIC_REQUESTING;
    this.changeStateEvent.fire({time:0});
    WA.Voip.rtcLog("inc checkMic");
    WA.fireSharedEvent("voipRtcGetUserMedia", {email:this.remoteID, camera:this.withCam});
    WA.VoipRTC.checkMic(this.onMicAllowed.bind(this), this.onMicDenied.bind(this), this.withCam)
  }, onMicAllowed:function(stream, tracks) {
    if(!WA.Voip.inTalk()) {
      if(stream) {
        stream.stop()
      }
      return
    }
    this.state = VoipCallState.INC_MIC_ALLOWED;
    WA.Voip.rtcLog("inc mediaAllowed");
    if(this.withCam && (!tracks[1] || tracks[1].length == 0)) {
      WA.Voip.rtcLog("inc nocamera");
      this.errorEvent.fire("camNotFound", {category:"local"});
      return
    }
    this.RTCstream = stream;
    WA.Voip.show();
    WA.Voip.view.toggleLocal(this.RTCstream, !this.withCam);
    var sendParams = {ua:navigator.userAgent, id:this.callId};
    if(this.withCam) {
      sendParams.video = 1
    }
    this.changeStateEvent.fire({time:0});
    this.state = VoipCallState.RTMP_REQUESTING;
    WA.Voip.rtcLog("inc connecting");
    this._connectTimer = WA.setTimeout(function() {
      this.errorEvent.fire("rtcConnectFail", {category:"rtc", tel:this.remoteID})
    }, 3E4, this);
    this._sendCallStart(sendParams, function(success) {
      if(success) {
        WA.VoipRTC.call(this.remoteID, this.RTCstream, !this.remoteVideo)
      }
    }, this)
  }, onMicDenied:function() {
    if(!WA.Voip.inTalk()) {
      return
    }
    WA.Voip.rtcLog("inc mediaDenied");
    this.errorEvent.fire("micUnAllowed", {category:"local"})
  }, connected:function() {
    this._connected = true;
    clearTimeout(this._connectTimer);
    this.talk()
  }, talk:function() {
    IncomingRtcCall.superclass.talk.call(this);
    SOCK.send("call;talk", {}, function(success) {
    }, this);
    WA.Voip.rtcLog("inc talk");
    U.Mnt.countRB(4972908)
  }, _onConnectionVoip:function() {
  }, _onConnectionVoipDecline:function(val) {
    this.errorEvent.fire("declined", {category:"jim", tel:this.remoteID});
    WA.Voip.event("callUserHangup", {email:this.remoteID})
  }, _onConnectionVoipRequestDecline:function(val) {
    if(val.id > 0 && val.id == this.requestId) {
      this.errorEvent.fire("declined", {category:"jim", tel:this.remoteID});
      WA.Voip.event("callUserHangup", {email:this.remoteID})
    }
  }, hangup:function(manual, silent) {
    WA.Voip.view.stopVideo();
    if(this.RTCstream) {
      this.RTCstream.stop()
    }
    WA.VoipRTC.bye(manual);
    WA.Voip.rtcLog("inc bye");
    if(manual) {
      if(!silent) {
        if(this.state == VoipCallState.INC_MIC_REQUESTING) {
          WA.Voip.sendDecline({id:this.requestId})
        }else {
          WA.Voip.sendDecline()
        }
      }
      WA.Voip.event("callHangup", {email:this.remoteID})
    }
  }});
  var IncomingCallRequest = WA.extend(ConnectionRoster, {constructor:function(id, email, video, RTCMode) {
    IncomingCallRequest.superclass.constructor.apply(this, arguments);
    this.id = id;
    this.closeEvent = new U.Event;
    this.incomingDialog = new WA.IncomingCallDialog({video:video, RTCMode:RTCMode});
    this.incomingDialog.actionEvent.on(function(action) {
      if(action == "voice" || action == "video") {
        if(RTCMode) {
          WA.Voip.rtcLog("inc accept");
          U.Mnt.countRB(4972907)
        }else {
          if(action == "video") {
            U.Mnt.countRB(WA.Voip.inTalk() ? 1379022 : 1379017)
          }else {
            U.Mnt.countRB(WA.Voip.inTalk() ? 1216805 : 1216798)
          }
        }
        this.closeEvent.fire("accept", action == "video", id)
      }else {
        if(RTCMode) {
          WA.Voip.rtcLog("inc decline")
        }
        if(video) {
          U.Mnt.countRB(WA.Voip.inTalk() ? 1379023 : 1379019)
        }else {
          U.Mnt.countRB(WA.Voip.inTalk() ? 1216808 : 1216801)
        }
        this.decline();
        this.closeEvent.fire("decline")
      }
    }, this);
    this.incomingDialog.open(email, WA.SA.get(email).nick, WA.SA.get(email).status);
    this.ringer = new U.DelayedTask({interval:4E3, fn:function() {
      WA.Beep.play("callIn");
      this.ringer.start()
    }, scope:this});
    this.ringer.startNow();
    WA.Voip.event("callIncoming", {email:email})
  }, _onConnectionVoipRequestDecline:function(val) {
    if(val.id > 0 && val.id == this.id) {
      if(WA.Voip.inTalk()) {
        U.Mnt.countRB(WA.Voip._call.videoCall ? 1379032 : 1216841)
      }
      this.closeEvent.fire("cancel")
    }
  }, _onConnectionVoipError:function(val) {
    if(val.id > 0 && val.id == this.id) {
      if(WA.Voip.inTalk()) {
        U.Mnt.countRB(WA.Voip._call.videoCall ? 1379032 : 1216841)
      }
      this.closeEvent.fire("cancel")
    }
  }, decline:function() {
    WA.Voip.sendDecline({id:this.id})
  }, destroy:function() {
    if(this.incomingDialog) {
      this.incomingDialog.destroy()
    }
    this.ringer.stop();
    this.closeEvent.removeAll();
    IncomingCallRequest.superclass.destroy.apply(this, arguments)
  }});
  var VoipChecker = WA.extend(ConnectionRoster, {constructor:function() {
    VoipChecker.superclass.constructor.apply(this, arguments);
    this.incomingEvent = new U.Event
  }, _onConnectionVoip:function(value) {
    if(value.id && value.email) {
      this.incomingEvent.fire(value)
    }
  }});
  var Voip = WA.extend(Object, {constructor:function() {
    this._call = null;
    this._swfReady = false;
    this._swfLoadTimeout = 0;
    this.isCompatible = U.swf.hasFlashPlayerVersion(SWF_VERSION_REQUIRED);
    this.isCompatiblePSTN = U.swf.hasFlashPlayerVersion(SWF_VERSION_PSTN);
    this.isCompatibleVideo = U.swf.hasFlashPlayerVersion(SWF_VERSION_VIDEO);
    this.isSwfInstalled = U.swf.getFlashPlayerVersion().major > 0;
    this.requestQueue = {};
    this.isCompatibleWebRTC = WA.RTCTools.isRTCEnabled();
    this.RTCModeOn = false;
    this.callEvent = new U.Event;
    this.updateActivityEvent = new U.Event;
    this.voipChecker = new VoipChecker;
    this.voipChecker.incomingEvent.on(this._onIncomingCallRequest, this);
    this.view = new WA.VoipView({swfPath:SWF_PATH, swfVersionRequired:SWF_VERSION_REQUIRED});
    this.view.renderEvent.on(function() {
    }, this);
    this.view.minimizeEvent.on(function() {
      if(this._call) {
        this._call.changeStateEvent.fire({minimized:true})
      }
    }, this);
    if(this.isCompatibleWebRTC) {
      WA.VoipRTC.mediaEvent.on(function(e) {
        if(!this.inTalk()) {
          WA.Voip.rtcLog("unexpected " + e.type);
          return
        }
        if(e.type == "remoteStreamAdd") {
          this.view.toggleRemote(e.stream)
        }else {
          if(e.type == "connected") {
            this._call.connected()
          }else {
            if(e.type == "serverError") {
              this._call.errorEvent.fire("srvError", {category:"jim"})
            }else {
              if(e.type == "sdp") {
                if(e.value == "offer") {
                  if(!this._call.isPSTN) {
                    WA.Voip.rtcLog("outgoing recvoffer")
                  }else {
                    WA.Voip.rtcLog("PSTN recvoffer")
                  }
                }
                if(e.value == "answer" && !this._call.isPSTN) {
                  WA.Voip.rtcLog("inc recvanswer")
                }
              }
            }
          }
        }
      }, this)
    }
    if(window.onbeforeunload) {
      WA.fly(window).on("beforeunload", this._onWindowUnload, this)
    }else {
      window.onbeforeunload = WA.createDelegate(this._onWindowUnload, this)
    }
  }, _onWindowUnload:function() {
    this._beforeUnloadOccurred = true;
    this._declineRequests();
    if(this._call) {
      WA.Voip.voipLog("leavePage");
      return WA.tr("dialer.youreCalling")
    }
  }, createCallObject:function(params) {
    params = params || {};
    this.render();
    var isRTCCall = WA.Voip.isCompatibleWebRTC && params.remoteRTCReady;
    if(!isRTCCall) {
      if(!WA.Voip.isCompatible) {
        WA.Voip.voipLog("flashRequired", {web:params.webcall ? 1 : 0, incom:params.incoming ? 1 : 0, swfver:U.swf.getFlashPlayerVersion().major});
        if(WA.Voip.isSwfInstalled) {
          U.Mnt.countRB(params.video ? 1378994 : 1299859)
        }else {
          U.Mnt.countRB(params.video ? 1378992 : 1299860)
        }
        this.event("flashRequired", params);
        return
      }else {
        if(params.video && !WA.Voip.isCompatibleVideo) {
          U.Mnt.countRB(1378994);
          this.event("flashRequired", params);
          return
        }
      }
    }
    this.RTCModeOn = !!isRTCCall;
    this._createCallObjectLow(params);
    if(!this._call && params.incoming) {
      WA.Voip.sendDecline({id:params.id, status:"ERROR"});
      return
    }
    return this._call
  }, _createCallObjectLow:function(params) {
    if(this.inTalk()) {
      this.hangup(true, true);
      if(this.inTalk()) {
        return
      }
    }
    this.view.useWebRTC(this.RTCModeOn);
    var callType = VoipCallType.PSTN;
    if(params.webcall) {
      callType = params.incoming ? VoipCallType.INCOMING : VoipCallType.OUTGOING
    }
    params.RTCMode = this.RTCModeOn;
    params.swf = this._swfReady && this.view.swfDOM;
    switch(callType) {
      case VoipCallType.PSTN:
        this._call = this.RTCModeOn ? new PstnRtcCall(params) : new PstnCall(params);
        break;
      case VoipCallType.OUTGOING:
        this._call = this.RTCModeOn ? new OutgoingRtcCall(params) : new OutgoingCall(params);
        break;
      case VoipCallType.INCOMING:
        this._call = this.RTCModeOn ? new IncomingRtcCall(params) : new IncomingCall(params);
        break
    }
    this._call.errorEvent.on(this._onCallError, this);
    this._call.changeStateEvent.on(this._onCallStateChange, this);
    WA.Voip.event("createCall", {call:this._call});
    return this._call
  }, startCall:function() {
    this.micCb = {};
    delete this._waitForEngineLoad;
    if(this._call.RTCMode || this._swfReady) {
      this._call.startCall()
    }else {
      this._call.startCall(true);
      this._waitForEngineLoad = true
    }
  }, askHWPermissions:function(RTCMode, withCam, successCb, failCb) {
    if(RTCMode) {
      WA.VoipRTC.checkMic(successCb, failCb, withCam)
    }else {
      if(this._swfReady) {
        WA.Voip.show();
        this.micCb = {success:successCb, fail:failCb};
        WA.setTimeout(function() {
          this._swf.checkMic(withCam)
        }, 100, this)
      }
    }
  }, _onCallError:function(type, params) {
    this.voipLog(type);
    if(this._call) {
      this._call.messageEvent.fire(type)
    }
    if(type == "declined") {
      this.hangup(false);
      return
    }
    WA.fireSharedEvent("voipHangup", {});
    if(this._call) {
      if(this._call.isAgentCall && !this._call.incomingCall && !this._call.isPSTN) {
        if(type == "micUnAllowed" || type == "micIsBusy" || type == "micNotFound") {
          if(this._call.RTCMode) {
            U.Mnt.countRB(4972853)
          }else {
            U.Mnt.countRB(this._call.videoCall ? 1396204 : 1296661)
          }
        }else {
          if(type == "AcceptTimedOut") {
            if(this._call.RTCMode) {
              WA.Voip.rtcLog("outgoing timedout");
              U.Mnt.countRB(4972868)
            }else {
              U.Mnt.countRB(this._call.videoCall ? 1379010 : 1299829)
            }
          }else {
            if(this._call.RTCMode) {
              WA.Voip.rtcLog("any error " + type)
            }
          }
        }
      }
      if(this._call.isAgentCall && params && params.category != "jim") {
        if(type == "micNotFound" && this._call.incomingCall) {
          WA.Voip.sendDecline({id:this._call.requestId, status:"NOHARDWARE"})
        }else {
          if(type == "camNotFound" && this._call.incomingCall) {
            WA.Voip.sendDecline({id:this._call.requestId, status:"NOHARDWARE"})
          }else {
            if(type == "micUnAllowed" && this._call.incomingCall) {
              WA.Voip.sendDecline({id:this._call.requestId})
            }else {
              if(this._call.state >= VoipCallState.RTMP_CONNECTED) {
                if(type == "micUnAllowed") {
                  WA.Voip.sendDecline()
                }else {
                  WA.Voip.sendDecline({status:"CONNECTION_BROKEN"})
                }
              }else {
                if(this._call.state >= VoipCallState.SESSION_REQUESTING) {
                  WA.Voip.sendDecline({status:"INIT_FAILED"})
                }
              }
            }
          }
        }
      }
      if(type != "swfCrashDetected") {
        this._call.hangup(false)
      }
    }
    this._onCallDone()
  }, _onCallStateChange:function(state) {
    if(state.time !== undefined) {
      this.view.updateDuration(state.time)
    }
  }, inTalk:function() {
    return!!this._call
  }, decline:function(call) {
    if(call) {
      call.hangup(true);
      call.destroy()
    }
  }, hangup:function(manual, silent) {
    WA.fireSharedEvent("voipHangup", {});
    if(manual && this._call) {
      this.voipLog("hangup")
    }
    if(this._call) {
      if(this._call.hangup(manual, silent) !== true || manual === false) {
        this._onCallDone()
      }
    }
  }, mute:function(state) {
    if(this.view.swfDOM && this._swfReady) {
      this.view.swfDOM.gain(state ? 0 : 50)
    }
  }, volume:function(level) {
    if(this.view.swfDOM && this._swfReady) {
      this.view.swfDOM.volume(level)
    }
  }, duration:function(str) {
    if(!this.RTCModeOn && this.view.swfDOM && this._swfReady) {
      if(this.__lastDuration === str) {
        return
      }
      this.__lastDuration = str;
      WA.setTimeout(function() {
        this.view.swfDOM.updateDuration(str)
      }, 80, this)
    }
  }, tone:function(key) {
    if(this.view.swfDOM && /^[0-9\*\#]$/.test(key) && this._swfReady) {
      this.view.swfDOM.tone(key)
    }
  }, _onCallDone:function() {
    WA.Voip.event("callEnd", {email:this._call && this._call.phoneNumber});
    clearTimeout(this._swfLoadTimeout);
    if(!this._swfReady) {
    }
    this.view.hide(true);
    if(this._call) {
      this._call.destroy()
    }
    this._call = null
  }, render:function() {
    if(!this.view.rendered) {
      this._swfLoadTimeout = WA.setTimeout(function() {
        this.view.disable();
        if(this._call && !this._call.RTCMode) {
          this._call.errorEvent.fire("swfLoadTimeout", {category:"local", url:SWF_PATH})
        }
      }, 2E4, this);
      this.view.render(WA.ma.el)
    }
  }, show:function(delaySwf) {
    if(this._call) {
      this._call.setInfo()
    }
    this.view.updateInfo({mail:this._call.phoneNumber, nick:this._call.userInfo.nick});
    this.view.show({video:this._call && this._call.videoCall, hasPermission:!!this.microphoneAllowed}, delaySwf || false)
  }, _onIncomingCallRequest:function(params) {
    var email = params.email, id = params.id;
    if(params.webrtc && this.isCompatibleWebRTC) {
      WA.Voip.rtcLog("inc request");
      params.remoteRTCReady = true;
      params.RTCMode = true
    }else {
      if(params.webrtc) {
        WA.Voip.sendDecline({id:params.id, status:"INCOMPATIBLE_VERS"});
        WA.ma.dialogsWindow.openCallDialog({email:email, incompatible:1});
        return
      }else {
        params.RTCMode = false;
        if(!this.isCompatible) {
          WA.Voip.sendDecline({id:params.id, status:"INCOMPATIBLE_VERS"});
          WA.ma.dialogsWindow.openCallDialog({email:email, incompatible:1});
          return
        }
      }
    }
    this.render();
    var request = new IncomingCallRequest(id, email, params.video, params.RTCMode);
    request.closeEvent.on(function(type, withCam) {
      if(type == "accept") {
        params.camera = withCam;
        WA.ma.dialogsWindow.openCallDialog(params);
        WA.Voip.event("callAccept", {email:email});
        this.updateActivityEvent.fire(email)
      }else {
        if(type == "decline") {
          WA.Voip.event("callDecline", {email:email})
        }else {
          this.updateActivityEvent.fire(email)
        }
      }
      request.destroy();
      delete this.requestQueue[id]
    }, this);
    this.requestQueue[id] = request
  }, voipLog:function(type, params) {
    params = U.Object.extend(params || {}, {type:type, videoLog:1});
    if(this._call) {
      U.Object.extend(params, {state:this._call.state, tel:this._call.phoneNumber, dur:this._call.duration});
      !this._call.isPSTN ? params.web = 1 : params.pstn = 1;
      params.author = WA.ACTIVE_MAIL;
      if(this._call.isAgentCall) {
        params.incom = this._call.incomingCall ? 1 : 0;
        params.video = this._call.videoCall ? 1 : 0;
        params.rtcmode = this._call.RTCMode ? 1 : 0
      }
    }
    U.Mnt.log(params)
  }, rtcLog:function(type, add) {
    var params = {reason:"breaklog", from:WA.ACTIVE_MAIL, dur:this._call ? this._call.duration : 0, state:this._call ? this._call.state : 0, remote:WA.Voip._call ? WA.Voip._call.remoteID : "NO", incom:this._call && this._call.incomingCall ? 1 : 0, text:"webrtc8: " + type};
    if(add) {
      params.add = "" + add
    }
    if(WA.isOpera) {
      params.opera = "1"
    }
    U.Mnt.log(params)
  }, event:function(type, params) {
    this.callEvent.fire(type, params)
  }, sendDecline:function(params) {
    params = U.Object.extend({status:"DECLINE"}, params || {});
    SOCK.send("call;decline", params, function(success) {
    }, this)
  }, _declineRequests:function() {
    for(var requestId in this.requestQueue) {
      if(this.requestQueue[requestId] instanceof IncomingCallRequest) {
        this.requestQueue[requestId].decline();
        this.requestQueue[requestId].destroy();
        delete this.requestQueue[requestId]
      }
    }
  }, deactivate:function() {
    if(this._call) {
      this.voipLog("Unexpected Deactivate");
      if(this._call.RTCMode) {
        WA.Voip.rtcLog("Deactivate")
      }
    }
    this._declineRequests();
    this.hangup(true)
  }, db:function() {
    DEBUG = true;
    if(this._swfReady && this.view.swfDOM) {
      this.view.swfDOM.debugOn()
    }
    return"OK"
  }, swfCb:function(type, param1) {
    if(DEBUG && type != "ping") {
      WA.log("swfCb:", type, param1)
    }
    if(type == "ready") {
      clearTimeout(this._swfLoadTimeout);
      this._swfReady = true;
      this.view.updateDuration(-1);
      if(DEBUG) {
        this.db()
      }
    }
    if(!this._call) {
      return
    }
    switch(type) {
      case "flash":
        if(param1 == "NetConnection.Connect.Closed") {
          this._onCallDone()
        }else {
          if(param1 == "NetConnection.Connect.Success") {
            this._call.connected()
          }else {
            if(param1 == "NetConnection.Connect.NetworkChange") {
              this.voipLog("NetworkChange")
            }
          }
        }
        break;
      case "error":
        this._call.errorEvent.fire(param1, {category:"rtmp"});
        break;
      case "server":
        if(param1 == "TALK") {
          SOCK.send("call;talk", {}, function(success) {
          }, this);
          this._call.talk()
        }else {
          if(param1 == "BYE") {
            if(this._call.duration == 0) {
              if(this._call.isAgentCall) {
                WA.Voip.sendDecline({status:"ERROR"})
              }else {
                this._call.messageEvent.fire("noAnswer");
                WA.Voip.sendDecline()
              }
            }else {
              WA.Voip.sendDecline()
            }
            this.hangup()
          }else {
            this._call.messageEvent.fire(param1)
          }
        }
        break;
      case "ready":
        if(this._waitForEngineLoad === true) {
          delete this._waitForEngineLoad
        }
        this._call.onSwfLoad(this.view.swfDOM);
        break;
      case "event":
        if(param1 == "micAllowed" || param1 == "micAlreadyAllowed") {
          this.microphoneAllowed = true;
          if(this._call.micWasAllowed) {
            return
          }
          this.show(true);
          this._call.onMicAllowed()
        }else {
          if(param1 == "micUnAllowed") {
            this.view.hide(true);
            this._call.errorEvent.fire(param1, {category:"local"})
          }else {
            if(param1 == "camFound") {
              this._call.cameraDetected()
            }else {
              if(param1 == "camIsBusy" || param1 == "camNotFound") {
                this._call.cameraNotFound(param1)
              }else {
                if(param1 == "inactivityDetected") {
                  U.Mnt.countRB(1399270);
                  this.voipLog(param1)
                }else {
                  if(param1 == "inactivityMicDetected" && this.microphoneAllowed) {
                    this.voipLog(param1);
                    if(WA.isChrome) {
                      if(this.inTalk()) {
                        this.voipLog("chromeBugPopup");
                        WA.showGuidePopup()
                      }else {
                        this.voipLog("chromeBugPopupFalse")
                      }
                    }
                  }else {
                    if(param1 == "alreadyConnected") {
                      this._call.delayCall()
                    }
                  }
                }
              }
            }
          }
        }
        break;
      case "ping":
        this._call.pong();
        break;
      case "user":
        if(param1 == "volume_click" || param1 == "volume_over" || param1 == "volume_out") {
          this.view.externalAction(param1)
        }else {
          if(param1 == "mute") {
            U.Mnt.countRB(1216818)
          }else {
            if(param1 == "hangup") {
              WA.Voip.hangup(true)
            }
          }
        }
        break;
      case "crash":
        this._call.errorEvent.fire("flash_crash", {category:"local", beforeUnload:!!this._beforeUnloadOccurred});
        break
    }
  }, destroy:function() {
    this.voipChecker.destroy()
  }});
  WA.Voip = new Voip;
  var msgCtx = {scope:"voip.msg", ver:SWF_VERSION_REQUIRED, ver_pstn:SWF_VERSION_PSTN, ver_vid:SWF_VERSION_VIDEO};
  WA.Voip.infoMessages = {flashRequired:WA.tr("swfRequired", msgCtx) + ' <a href="http://www.adobe.com/go/getflashplayer/" target="_blank">' + WA.tr("install", msgCtx) + "</a>", flashVideoRequired:WA.tr("swfVideoRequired", msgCtx) + ' <a href="http://www.adobe.com/go/getflashplayer/" target="_blank">' + WA.tr("install", msgCtx) + "</a>", flashRequiredPSTN:WA.tr("swfPstnRequired", msgCtx) + ' <a href="http://www.adobe.com/go/getflashplayer/" target="_blank">' + WA.tr("install", msgCtx) + "</a>", flashRequiredIncoming:WA.tr("swfRequiredIncoming", 
  msgCtx) + '<br><a href="http://www.adobe.com/go/getflashplayer/" target="_blank">' + WA.tr("install", msgCtx) + "</a>", micUnAllowed:WA.tr("microphoneNotAllowed", msgCtx), micIsBusy:WA.tr("micIsBusy", msgCtx), camIsBusy:WA.tr("camIsBusy", msgCtx), micNotFound:WA.tr("micNotFound", msgCtx), camNotFound:WA.tr("camNotFound", msgCtx), swfLoadTimeout:WA.tr("networkError", msgCtx), "NetConnection.Connect.Failed":WA.tr("networkError2", msgCtx), rtmpConnectFail:WA.tr("networkError3", msgCtx), rtcConnectFail:WA.tr("networkError3", 
  msgCtx), voipSessionRequestFail:WA.tr("networkError4", msgCtx), INCOMPATIBLE_VERS:WA.tr("incompatible", msgCtx), BadClient:WA.tr("networkError5", msgCtx), BadEngine:WA.tr("networkError5", msgCtx), unknown:WA.tr("networkError5", msgCtx), rtmpBye:WA.tr("callDeclined", msgCtx), AcceptTimedOut:WA.tr("noResponding", msgCtx), NOHARDWARE:WA.tr("noHardware", msgCtx), "BYE NO RESPONDING":WA.tr("unavailable", msgCtx), noAnswer:WA.tr("noAnswer", msgCtx), "BYE WRONG NUMBER":WA.tr("wrongNumber", msgCtx), notEnoughMoney:WA.tr("notEnoughMoney", 
  msgCtx), "BYE BUSY":WA.tr("lineIsBusy", msgCtx), declined:WA.tr("callDeclined", msgCtx)};
  WA.Voip.infoIcons = {flashRequired:"flash", flashRequiredIncoming:"flash", flashVideoRequired:"flash", "BYE BUSY":"line", notEnoughMoney:"money", "BYE NO RESPONDING":"user", noAnswer:"user", AcceptTimedOut:"user", error:"error"};
  WA.Voip.historyMessages = {callTalk:WA.tr("voip.history.callStart"), callIncoming:WA.tr("voip.history.callIncoming"), callOutgoing:WA.tr("voip.history.callOutgoing"), callDecline:WA.tr("voip.history.callDecline"), callUserDecline:WA.tr("voip.history.callUserDecline"), callEnd:WA.tr("voip.history.callEnd"), callSrvError:WA.tr("voip.history.callSrvError"), callUserCancel:WA.tr("voip.history.callUserCancel")}
})();
WebAgent.Invalidator = function() {
  var WA = WebAgent;
  var Invalidator = WA.extend(WA.Activatable, {constructor:function() {
    this.invalidateEvent = new WA.util.Event;
    this.activate()
  }, invalidate:function() {
    if(this.isActive()) {
      WA.debug.State.set("invalidate_on", new Date);
      this.invalidateEvent.fire()
    }
  }});
  return new Invalidator
}();
WebAgent.Synchronizer = function() {
  var WA = WebAgent;
  var U = WA.util;
  var RequestGroup = WA.extend(Object, {constructor:function() {
    this.count = 0;
    this.items = [];
    this.allData = {}
  }, add:function(id, fn, scope) {
    this.count++;
    this.items.push({id:id, fn:fn, scope:scope});
    return this
  }, _onItemReady:function(data, item) {
    this.count--;
    this.allData[item.id] = data;
    if(this.count == 0) {
      this.readyFn(this.allData);
      this._destroy()
    }
  }, _invokeItem:function(item) {
    var ctx = {ready:WA.createDelegate(this._onItemReady, this, [item], 1)};
    item.fn.call(item.scope || window, ctx)
  }, request:function(readyFn, scope) {
    if(this.count > 0) {
      this.readyFn = WA.createDelegate(readyFn, scope || window);
      U.Array.each(this.items, this._invokeItem, this)
    }else {
      WA.error("Add items!")
    }
  }, _destroy:function() {
    this.readyFn = null;
    this.allData = null;
    this.items = null
  }});
  var SYNC_RECORD_UNCHANGED = "UNCHANGED_" + (new Date).getTime();
  var SyncRecord = WA.extend(WA.data.Record, {isChanged:function(fieldName) {
    return this.hasField(fieldName) && this.get(fieldName) !== SYNC_RECORD_UNCHANGED
  }});
  var ComponentSynchronizer = WA.extend(Object, {constructor:function(owner, id, keys, sessional, isHuge) {
    this.owner = owner;
    this.id = id;
    this._initKeys(keys);
    this.sessional = sessional || false;
    this.hugeStorage = isHuge || false;
    this.triggerEvent = new U.Event;
    this.destroyEvent = new U.Event;
    this.canShowDebugState = false
  }, _initKeys:function(keys) {
    this.keys = WA.isArray(keys) ? keys : [keys];
    this.localData = {};
    U.Array.each(this.keys, function(k) {
      this.localData[k] = ""
    }, this)
  }, getId:function() {
    return this.id
  }, getKeys:function() {
    return this.keys
  }, setData:function(storageData) {
    var data = {};
    var canFire = false;
    var keys = this.getKeys();
    U.Array.each(keys, function(key) {
      var value = storageData[key];
      if(this.localData[key] !== value) {
        this.localData[key] = data[key] = value;
        canFire = true
      }else {
        data[key] = SYNC_RECORD_UNCHANGED
      }
    }, this);
    if(this.canShowDebugState) {
      var debugData = [];
      U.Object.each(this.localData, function(v, k) {
        debugData.push(k + ": " + v)
      });
      WA.debug.State.set("Sync." + this.getId(), debugData.join(", "))
    }
    if(canFire) {
      this.triggerEvent.fire(new SyncRecord(keys, data))
    }
  }, write:function(key, value, cb, scope) {
    this.owner.write(this, key, value, cb, scope)
  }, read:function(cb, scope) {
    this.owner.read(this, cb, scope)
  }, isSessional:function() {
    return this.sessional
  }, isHugeStorage:function() {
    return this.hugeStorage
  }, whenReady:function(fn, scope) {
    this.owner.whenReady(this, fn, scope)
  }, showDebugState:function() {
    this.canShowDebugState = true
  }, destroy:function() {
    this.id = null;
    this.owner = null;
    this.keys = null;
    this.localData = null;
    this.triggerEvent.removeAll();
    this.triggerEvent = null;
    this.destroyEvent.fire(this);
    this.destroyEvent.removeAll();
    this.destroyEvent = null
  }});
  var Synchronizer = WA.extend(Object, {_prefix:"sync", constructor:function() {
    this.dataChecker = new U.DelayedTask({interval:500, fn:this._onDataCheck, scope:this});
    this.syncs = []
  }, registerComponent:function(id, keys, sessional, isHuge) {
    var index = U.Array.indexOfBy(this.syncs, function(sync) {
      return id === sync.getId()
    });
    if(index != -1) {
      WA.error("Duplicate synchronizers: " + id)
    }
    var sync = new ComponentSynchronizer(this, id, keys, sessional !== false, !!isHuge);
    this.syncs.push(sync);
    sync.destroyEvent.on(this._onDestroySync, this);
    return sync
  }, _onDestroySync:function(sync) {
    U.Array.removeBy(this.syncs, function(entry) {
      return entry.getId() === sync.getId()
    }, this)
  }, startUp:function(delay) {
    this.dataChecker.start(delay);
    WA.debug.State.set("Sync.state", "working")
  }, stop:function() {
    this.dataChecker.stop();
    WA.debug.State.set("Sync.state", "stopped")
  }, _generateStorageKey:function(sync, key) {
    return[this._prefix, sync.getId(), key].join("$")
  }, _generateStorageKeys:function(sync) {
    return U.Array.transform(sync.getKeys(), function(id) {
      return this._generateStorageKey(sync, id)
    }, this)
  }, _onDataCheck:function() {
    WA.FocusManager.ifFocused(function() {
      this.dataChecker.start()
    }, function() {
      var prepareFn = function(isSessional, isHugeStorage) {
        var keys = [];
        U.Array.each(this.syncs, function(sync) {
          if(sync.isSessional() === isSessional && sync.isHugeStorage() == isHugeStorage) {
            keys = keys.concat(this._generateStorageKeys(sync))
          }
        }, this);
        var Storage = this._getSyncStorageParams(isSessional, isHugeStorage);
        return function(ctx) {
          Storage.load(keys, {success:function(data) {
            ctx.ready(data)
          }, failure:function(e) {
            WA.error(e)
          }, scope:this})
        }
      };
      var onReady = function(data) {
        U.Array.each(this.syncs, function(sync) {
          var p = sync.isSessional() ? "sessional" : "usual";
          if(sync.isHugeStorage()) {
            p = "huge" + p
          }
          var syncData = this._getSyncData(sync, data[p]);
          sync.setData(syncData)
        }, this);
        this.dataChecker.start()
      };
      (new RequestGroup).add("sessional", prepareFn.call(this, true, false), this).add("usual", prepareFn.call(this, false, false), this).add("hugesessional", prepareFn.call(this, true, true), this).add("hugeusual", prepareFn.call(this, false, true), this).request(onReady, this)
    }, this)
  }, _getSyncData:function(sync, storageData) {
    var keys = sync.getKeys();
    var storageKeys = this._generateStorageKeys(sync);
    var data = {};
    U.Array.each(storageKeys, function(storageKey, index) {
      data[keys[index]] = storageData[storageKey]
    });
    return data
  }, _getSyncStorageParams:function(isSessional, isHugeStorage) {
    var storageType = isSessional ? "SessionStorage" : "Storage";
    if(isHugeStorage) {
      storageType = "Huge" + storageType
    }
    return WA[storageType]
  }, _getSyncStorage:function(sync) {
    return this._getSyncStorageParams(sync.isSessional(), sync.isHugeStorage())
  }, write:function(sync, key, value, cb, scope) {
    WA.FocusManager.ifFocused(function() {
      var data = U.Object.pair(this._generateStorageKey(sync, key), value);
      this._getSyncStorage(sync).save(data, {success:function() {
        if(WA.isFunction(cb)) {
          cb.call(scope || window)
        }
      }, failure:WA.createDelegate(function(e, errorInfo) {
      }, this, [[sync.getId(), key, value].join(" ")], 1), scope:this})
    }, null, this)
  }, read:function(sync, cb, scope) {
    var keys = this._generateStorageKeys(sync);
    this._getSyncStorage(sync).load(keys, {success:function(storageData) {
      var data = this._getSyncData(sync, storageData);
      cb.call(scope || window, new SyncRecord(sync.getKeys(), data))
    }, failure:WA.createDelegate(function(e, errorInfo) {
      if(e) {
        e = JSON.stringify(e)
      }
      WA.error(e + ", info: [" + errorInfo + "]")
    }, this, [[sync.getId(), keys].join(" ")], 1), scope:this})
  }, whenReady:function(sync, fn, scope) {
    this._getSyncStorage(sync).whenReady(fn, scope)
  }});
  return new Synchronizer
}();
WebAgent.ChangeLog = function() {
  var WA = WebAgent;
  var U = WA.util;
  var JSON = WA.getJSON();
  var readyEvent = new U.Event;
  var ChangeLog = WA.extend(WA.Activatable, {constructor:function() {
    this.sequenceId = -2;
    this.data = [];
    this.sync = WA.Synchronizer.registerComponent("changelog", ["data"]);
    this.updateEvent = new U.Event;
    this.updateEvent.on(function(data) {
      WA.debug.State.set("changelog-id", this.sequenceId).set("changelog-data", JSON.stringify(data))
    }, this)
  }, _onReady:function() {
    this.sync.read(function(syncRecord) {
      this._onSyncRestore(syncRecord);
      if(this._isReady()) {
        readyEvent.fire()
      }else {
        WA.error("Initialization failed")
      }
      this.sync.triggerEvent.on(this._onSyncTriggerEvent, this);
      WA.ConnectionFacade.triggerEvent.on(this._onConnectionTriggerEvent, this);
      WA.ConnectionFacade.afterResponseEvent.on(this._onSocketAfterResponseEvent, this);
      WA.Invalidator.invalidateEvent.on(this._onInvalidate, this)
    }, this)
  }, _isReady:function() {
    return this.sequenceId >= 0
  }, whenReady:function(fn, scope) {
    if(this._isReady()) {
      fn.call(scope)
    }else {
      readyEvent.on(fn, scope, {single:true})
    }
  }, _onActivate:function() {
    if(!this._isReady()) {
      if(this.sequenceId === -2) {
        this.sync.whenReady(this._onReady, this)
      }else {
        this.sync.read(this._onSyncRestore, this)
      }
    }
  }, _onDeactivate:function() {
    this._clear()
  }, _onInvalidate:function() {
    if(this.isActive()) {
      this._clear();
      this.sync.read(this._onSyncRestore, this)
    }
  }, getSequenceId:function() {
    return this.sequenceId
  }, get:function(mail) {
    var index = this._logIndexOf(mail);
    return this.data[index]
  }, _onConnectionTriggerEvent:function(type, value) {
    if(type === "contactStatus" && this.data && value.status) {
      this._log(value)
    }
  }, _onSocketAfterResponseEvent:function() {
    this._commit()
  }, _logIndexOf:function(mail) {
    return U.Array.indexOfBy(this.data, function(logItem) {
      return logItem.email === mail
    })
  }, logAction:function(action, data) {
    var o = WA.applyIf({action:action}, data);
    WA.applyIf(o, {status:{type:null}});
    this._log(o);
    this._commit()
  }, _log:function(data) {
    if(!this.isActive()) {
      return
    }
    var index = this._logIndexOf(data.email);
    if(index != -1) {
      this.data[index].nick = data.nickname;
      this.data[index].status = data.status.type;
      this.data[index].statusTitle = data.status.title;
      this.data[index].lastSeen = data.lastseen
    }else {
      index = this.data.length;
      this.data.push({email:data.email, status:data.status.type, statusTitle:data.status.title || null, nick:data.nickname, action:data.action, lastSeen:data.lastseen})
    }
    if(data.tel) {
      this.data[index].tel = data.tel
    }
    if(data.features) {
      this.data[index].features = data.features
    }
  }, _commit:function() {
    if(!this.isActive()) {
      return
    }
    if(this._isReady()) {
      if(this.sequenceId === Number.MAX_VALUE) {
        this.sequenceId = 0
      }else {
        this.sequenceId += 1
      }
      var newData = JSON.stringify({id:this.sequenceId, data:this.data});
      this.sync.write("data", newData, function() {
        this.updateEvent.fire(this.data);
        this.data = []
      }, this)
    }
  }, _clear:function() {
    this.sequenceId = -1;
    this.data = []
  }, _parseData:function(str) {
    return JSON.parse(str || "null")
  }, _parseSeqId:function(v) {
    return parseInt(v || 0)
  }, _onSyncRestore:function(syncRecord) {
    var o = this._parseData(syncRecord.get("data"));
    if(!o) {
      this.sequenceId = 0
    }else {
      this.sequenceId = this._parseSeqId(o.id)
    }
    WA.debug.State.set("changelog-id", this.sequenceId)
  }, _onSyncTriggerEvent:function(syncRecord) {
    if(!this.isActive()) {
      return
    }
    if(syncRecord.isChanged("data")) {
      var o = this._parseData(syncRecord.get("data"));
      if(o) {
        var sequenceId = this._parseSeqId(o.id);
        if(sequenceId !== 0 && this.sequenceId !== -1 && Math.abs(sequenceId - this.sequenceId) > 1) {
          WA.Invalidator.invalidate()
        }else {
          this.sequenceId = sequenceId
        }
        this.data = o.data;
        this.updateEvent.fire(this.data, true)
      }
    }
  }});
  return new ChangeLog
}();
(function() {
  var WA = WebAgent;
  var JSON = WA.getJSON();
  var U = WA.util;
  var TYPING_STATE = "typingNotify";
  var MESSAGE_STATE = "message";
  var TYPING_INTERVAL = 15E3;
  var CS = WA.extend(WA.Activatable, {constructor:function() {
    this.data = {};
    this.datacClearedWhileStarting = false;
    this._needFireUpdateEvent = false;
    this.typings = {};
    this.beforeUpdateEvent = new WA.util.Event;
    this.updateEvent = new WA.util.Event;
    this.sync = WA.Synchronizer.registerComponent("constates", ["data"], true);
    this.sync.triggerEvent.on(this._onSyncTriggerEvent, this);
    WA.ConnectionFacade.triggerEvent.on(this._onConnectionTriggerEvent, this);
    WA.ConnectionFacade.afterResponseEvent.on(this._onAfterConnectionResponse, this);
    WA.conn.UserState.statusChangedEvent.on(function(status) {
      if(status == "offline") {
        this.data = {};
        U.Object.each(this.typings, function(task) {
          task.stop()
        }, this);
        this.typings = {};
        this._fireUpdateEvent(true)
      }
    }, this)
  }, _fireUpdateEvent:function(forceUpdate) {
    if(this.isActive()) {
      this._needFireUpdateEvent = false;
      var data = WA.apply({}, this.data);
      this.beforeUpdateEvent.fire(data);
      this.updateEvent.fire(data, !!forceUpdate)
    }else {
      this._needFireUpdateEvent = true
    }
  }, getStates:function(email) {
    var o = this.data[email];
    return o ? o.states : null
  }, getUnread:function(email) {
    var o = this.data[email];
    return o ? o.unread : null
  }, hasUnread:function() {
    var unread = false;
    WA.util.Object.each(this.data, function(entry, email) {
      if(this.getUnread(email) > 0) {
        unread = true;
        return false
      }
    }, this);
    return unread
  }, updateRecent:function(recent) {
    WA.util.Object.each(recent, function(r, email) {
      if(!this.data[email]) {
        this.data[email] = {states:[]}
      }
      this.data[email].recent = r.lastMessageDate;
      if(!WA.CLD.inList(email)) {
        this.data[email].nick = r.friendly
      }
    }, this);
    this._fireUpdateEvent();
    this._saveSyncData()
  }, _saveSyncData:function() {
    var data = {};
    WA.util.Object.each(this.data, function(entry, email) {
      if(entry.states.length || entry.unread || entry.recent) {
        data[email] = entry
      }
    });
    if(this.isActive()) {
      this.sync.write("data", JSON.stringify(data))
    }
  }, removeState:function(email, state) {
    this._removeState(email, state)
  }, removeStates:function(emails, state) {
    if(WA.isArray(emails) && emails.length > 0) {
      var statefulEmails = [];
      WA.util.Array.each(emails, function(m) {
        if(this.getStates(m)) {
          statefulEmails.push(m)
        }
      }, this);
      var len = statefulEmails.length;
      if(len > 0) {
        var silentOptions = {suppressEvent:true, sync:false};
        WA.util.Array.each(statefulEmails, function(m, index) {
          if(len - 1 === index) {
            this.removeState(m, state)
          }else {
            this._removeState(m, state, silentOptions)
          }
        }, this)
      }
    }
  }, _removeState:function(email, state, options) {
    var states = this.getStates(email);
    if(states) {
      WA.util.Array.remove(states, state);
      options = options || {};
      if(options.suppressEvent !== true) {
        this._fireUpdateEvent()
      }
      if(options.sync !== false) {
        this._saveSyncData()
      }
    }
  }, saveUnread:function(email, count) {
    if(!this.data[email]) {
      this.data[email] = {states:[]}
    }
    this.data[email].unread = count;
    if(count == 0) {
      this._removeState(email, WA.ContactStates.MESSAGE_STATE)
    }else {
      this._saveState(email, WA.ContactStates.MESSAGE_STATE)
    }
  }, _saveState:function(email, state) {
    var states = this.getStates(email);
    if(!states) {
      this.data[email] = {states:[state]};
      this._saveState(email, state);
      return
    }
    if(state === MESSAGE_STATE) {
      WA.util.Array.remove(states, TYPING_STATE);
      WA.util.Array.remove(states, MESSAGE_STATE)
    }
    if(WA.util.Array.indexOf(states, state) == -1) {
      states.push(state)
    }
    if(state === TYPING_STATE) {
      this._processTyping(email)
    }
    this._fireUpdateEvent();
    this._saveSyncData()
  }, _processTyping:function(email, interval) {
    if(this.data[email]) {
      var typing = this.typings[email];
      if(!typing) {
        typing = this.typings[email] = new WA.util.DelayedTask({interval:interval || TYPING_INTERVAL, fn:WA.createDelegate(function(m) {
          delete this.typings[m];
          if(this.data[m]) {
            delete this.data[m].typing
          }
          this._removeState(m, TYPING_STATE, {sync:false})
        }, this, [email], 0)})
      }
      typing.start();
      this.data[email].typing = (new Date).getTime()
    }
  }, _getFriendly:function(value) {
    var nick;
    if(value.persons) {
      var ind = U.Array.indexOfBy(value.persons, function(it) {
        return it.sn === value.sn
      });
      if(ind > -1) {
        nick = value.persons[ind].friendly
      }
    }
    return nick
  }, _onConnectionTriggerEvent:function(type, value) {
    if(type == "archSync") {
      if(!this.datacClearedWhileStarting && value.starting) {
        this.datacClearedWhileStarting = true;
        this.data = {}
      }
      this.saveUnread(value["with"], value.count)
    }
    if(type == "historyState") {
      if(!this.datacClearedWhileStarting && value.starting) {
        this.datacClearedWhileStarting = true;
        this.data = {}
      }
      var lastMessageDate = value.messages && value.messages[0].time || 0;
      if(lastMessageDate) {
        if(!this._recentDialogs) {
          this._recentDialogs = {}
        }
        this._recentDialogs[value.sn] = {lastMessageDate:lastMessageDate, friendly:this._getFriendly(value)}
      }
    }
    if(type == "hiddenChat") {
      if(this.data[value.sn]) {
        delete this.data[value.sn].recent;
        this._fireUpdateEvent();
        this._saveSyncData()
      }
    }
    if(WA.util.Array.indexOf([TYPING_STATE, MESSAGE_STATE], type) != -1) {
      this._saveState(value.from, type)
    }
  }, _onAfterConnectionResponse:function() {
    if(this._recentDialogs) {
      this.updateRecent(this._recentDialogs);
      delete this._recentDialogs
    }
  }, _onActivate:function() {
    this.sync.whenReady(function() {
      if(!this.datacClearedWhileStarting) {
        this.sync.read(this._onSyncTriggerEvent, this)
      }
      if(this._needFireUpdateEvent) {
        this._fireUpdateEvent();
        this._saveSyncData()
      }
    }, this)
  }, _onDeactivate:function() {
    this.datacClearedWhileStarting = false;
    WA.util.Object.each(this.data, function(entry, email) {
      if(WA.util.Array.indexOf(this.getStates(email) || [], TYPING_STATE) != -1) {
        this._removeState(email, TYPING_STATE, {suppressEvent:true, sync:false})
      }
    }, this)
  }, _onSyncTriggerEvent:function(syncRecord) {
    if(syncRecord.isChanged("data")) {
      var data = JSON.parse(syncRecord.get("data") || "null");
      if(data) {
        this.data = data;
        WA.util.Object.each(data, function(entry, email) {
          if(WA.util.Array.indexOf(this.getStates(email) || [], TYPING_STATE) != -1) {
            var typing = parseInt(this.data[email].typing) || TYPING_INTERVAL;
            var delta = (new Date).getTime() - typing;
            if(delta >= 0 && delta < TYPING_INTERVAL) {
              this._processTyping(email, TYPING_INTERVAL - delta)
            }else {
              this._removeState(email, TYPING_STATE, {suppressEvent:true, sync:false})
            }
          }
        }, this);
        this._fireUpdateEvent()
      }
    }
    if(this._needFireUpdateEvent) {
      this._fireUpdateEvent();
      this._saveSyncData()
    }
  }});
  WA.ContactStates = new CS;
  WA.ContactStates.TYPING_STATE = TYPING_STATE;
  WA.ContactStates.MESSAGE_STATE = MESSAGE_STATE
})();
(function() {
  var WA = WebAgent;
  var U = WA.util;
  var UI = WA.ui;
  var ConnectionRoster = WA.conn.ConnectionRoster;
  var SOCK = WA.ConnectionFacade;
  var __preventSearchStatistics = true;
  var FRIENDSHIP_TYPES = ["", WA.tr("search.possiblyClassmate"), WA.tr("search.possiblyGroupmate"), WA.tr("search.possiblyColleague"), WA.tr("search.youHaveMutualFriends"), WA.tr("search.yourSubscriber"), WA.tr("search.yourFavorite"), WA.tr("search.hisFavorite"), WA.tr("search.hisSubscriber"), "", WA.tr("search.correspondy"), WA.tr("search.correspondy"), WA.tr("search.correspondy"), WA.tr("search.correspondy"), WA.tr("search.yourFriend"), WA.tr("search.yourFriendsFriend"), WA.tr("search.yourICQFriend"), 
  WA.tr("search.yourOKFriend"), WA.tr("search.peopleYouMayKnow")];
  var TAB_HTML = '<div class="nwa-button_blue nwa-add__tab" wa-tabindex="{1}"><span class="nwa-button" wa-tabindex="{1}">{0}</span></div>';
  var ACTIVE_TAB_HTML = '<div class="nwa-white-plate nwa-add__tab_active" wa-tabindex="{1}"><span class="nwa-button" wa-tabindex="{1}">{0}</span></div>';
  var SEARCH_RESULT_HTML = '<div class="nwa-suggest-item nwa-add__search-item">                                        <div class="nwa-add__search-item__userpic {avatarClass}" wa-action="userpic" wa-name="{name}" wa-mail="{mail}" style="background-image:url({avatar});"></div>                                        <div class="nwa-add__search-item__info">                                            <div class="nwa-add__search-item__name {status}">{name}<div class="nwa-add__search-item__name-fader"></div></div>{relation}                                            <div class="nwa-add__search-item__buttons">                                                <span class="nwa-add__search-item__button nwa-add__btn-profile" wa-action="profile" wa-mail="{mail}">' + 
  WA.tr("search.profile") + '</span>                                                <span class="nwa-add__search-item__button nwa-add__btn-add" wa-action="add" wa-mail="{mail}" wa-name="{name}">' + WA.tr("search.add") + "</span>{nofriends}                                            </div>                                        </div>                                    </div>";
  var SEARCH_RESULT_TOP = '<div class="nwa-add__title2">' + WA.tr("search.youSearched") + ' <span>{title}</span><div class="nwa-add__title2-fader"></div></div></div><div class="nwa-add__return"><a wa-action="back" href="javascript: void(0);">' + WA.tr("search.backToSearchParams") + "</a></div>";
  var SEARCH_EMPTY = '<div class="nwa-add__title2">' + WA.tr("search.noResults") + "</div>";
  var geoBase, geoBaseRequested, geoBaseCallbacks = [];
  WA.getCountryById = function(id, cb) {
    if(id) {
      var _cb = cb;
      cb = function() {
        var ind = U.Array.indexOfBy(geoBase, function(it) {
          return it[2].toLowerCase() === id.toLowerCase()
        });
        var res = geoBase[ind] && geoBase[ind][1];
        _cb && _cb(res);
        return res
      }
    }
    if(geoBase) {
      return cb && cb(geoBase)
    }else {
      geoBaseCallbacks.push(cb);
      if(!geoBaseRequested) {
        geoBaseRequested = true;
        WA.updateCountryCodes = function(base) {
          geoBase = base;
          U.Array.each(geoBaseCallbacks, function(cbItem) {
            cbItem(geoBase)
          });
          geoBaseCallbacks = []
        };
        var script = document.createElement("script");
        script.src = WA.resDomain + WA.resPath.replace(/(\/[^\/]+){2}$/, "/") + "geo/countries." + (WA.i18n.lang || "ru") + ".js?1";
        script.charset = "utf-8";
        script.type = "text/javascript";
        WA.getBody().appendChild(script)
      }
    }
  };
  var Tabs = WA.extend(UI.Component, {constructor:function() {
    Tabs.superclass.constructor.apply(this, arguments);
    this.tabChangeEvent = new U.Event;
    this._list = [];
    this._index = 0
  }, _onRender:function(el) {
    this.el = el.createChild({cls:"nwa-add__tabs"});
    this.el.on("click", this._onClickEvent, this);
    this._redraw()
  }, _onClickEvent:function(el) {
    var trg = el.getTarget(true);
    var index = +trg.getAttribute("wa-tabindex");
    if(!isNaN(index)) {
      if(this.setFocus(index)) {
        this.tabChangeEvent.fire(index)
      }
    }
  }, _redraw:function() {
    var html = [];
    U.Array.each(this._list, function(title, i) {
      html.push(U.String.format(i == this._index ? ACTIVE_TAB_HTML : TAB_HTML, title, i))
    }, this);
    this.el.update(html.join(""))
  }, addTab:function(title) {
    this._list.push(title)
  }, setFocus:function(index) {
    if(this._index != index) {
      this._index = index;
      this._redraw();
      return true
    }
  }});
  var PlateSearch = WA.extend(UI.Component, {constructor:function() {
    PlateSearch.superclass.constructor.apply(this, arguments);
    this.searchEvent = new U.Event;
    this._emailField = new UI.TextField({placeholder:WA.tr("search.typeEmail"), cls:"nwa-textfield nwa-textfield_thin nwa-addcontact__search-field"});
    this._emailSearch = new UI.Button({cls:"nwa-button nwa-button_orange nwa-addcontact__search-button", text:WA.tr("search.goSearch")});
    this._params = new UI.Collection({firstname:new UI.Label({title:WA.tr("search.name") + ":", child:new UI.TextField({cls:"nwa-textfield nwa-addcontact__search-field"})}), lastname:new UI.Label({title:WA.tr("search.lastname") + ":", child:new UI.TextField({cls:"nwa-textfield nwa-addcontact__search-field"})}), sex:new UI.Label({title:WA.tr("search.sex") + ":", child:new UI.Component}), age:new UI.Label({title:WA.tr("search.age") + ":", child:new UI.Component}), country:new UI.Label({title:WA.tr("search.country") + 
    ":", child:new UI.Select({cls:"nwa-textfield nwa-addcontact__search-select"})})});
    this._country = this._params.children.country.child;
    this._paramsSearch = new UI.Button({cls:"nwa-button nwa-button_orange nwa-addcontact__search-button", text:WA.tr("search.goSearch")})
  }, _onRender:function(el) {
    this.el = el.createChild({style:"display:block", children:[{cls:"nwa-white-plate nwa-add__white1", children:[{cls:"nwa-add__search-button"}, {cls:"nwa-add__search-input"}, {cls:"nwa-add__error", children:WA.tr("search.wrongEmail")}]}, {cls:"nwa-white-plate nwa-add__white2", children:[{cls:"nwa-add__title", children:WA.tr("search.searchProfile") + ":"}, {cls:"nwa-twocol"}, {cls:"nwa-add__map", children:[{tag:"a", href:"http://maps.mail.ru/?units&origin=webagent", target:"_blank", children:WA.tr("search.searchOnMap")}]}, 
    {cls:"nwa-add__search-button", children:[]}]}]});
    this.el.first().on("keyup", function(ev) {
      if(ev.keyCode == 13) {
        this._searchEmail()
      }
    }, this);
    this._emailSearchErrorEl = this.el.first().last();
    this.el.last().on("keyup", function(ev) {
      if(ev.keyCode == 13) {
        this._searchParams()
      }
    }, this);
    this._paramsSearch.render(this.el.first().next().last());
    this._paramsSearch.el.on("click", this._searchParams, this);
    this._emailSearch.render(this.el.first().first());
    this._emailSearch.el.on("click", this._searchEmail, this);
    this._params.children.sex.child.autoEl = [{tag:"input", type:"radio", "wa-name":"sex", "wa-value":"1", name:"waSearchSex", id:"nwaSearchSexMale"}, {tag:"label", "for":"nwaSearchSexMale", children:" " + WA.tr("search.male")}, {tag:"input", type:"radio", "wa-name":"sex", "wa-value":"2", name:"waSearchSex", id:"nwaSearchSexFemale"}, {tag:"label", "for":"nwaSearchSexFemale", children:" " + WA.tr("search.female")}];
    this._params.children.age.child.autoEl = [{tag:"input", cls:"nwa-textfield nwa-addcontact__search-field nwa-add__input-short", type:"text", "wa-name":"ageFrom", id:"nwaSearchAgeFrom"}, {tag:"label", cls:"nwa-add__search-txt", children:WA.tr("search.to"), "for":"nwaSearchAgeUntil"}, {tag:"input", cls:"nwa-textfield nwa-addcontact__search-field nwa-add__input-short", type:"text", "wa-name":"ageUntil", id:"nwaSearchAgeUntil"}];
    this._params.render(this.el.first().next().first().next());
    this._params.children.sex.child.el.parent().addClass("nwa-twocol__value__label");
    this.reset();
    this._emailField.render(this.el.first().first().next())
  }, _onShow:function() {
    this._emailField.focus()
  }, _searchEmail:function() {
    var val = U.String.trim(this._emailField.val());
    if(val) {
      if(this.searchEvent.fire({email:val}) === false) {
        this._emailSearchErrorEl.show()
      }else {
        this._emailSearchErrorEl.hide()
      }
    }else {
      this._emailSearchErrorEl.show()
    }
  }, _searchParams:function() {
    var opts = {};
    var isEmpty = true;
    var location = [];
    this._params.each(function(item, key) {
      if(item.child.val) {
        if(item.child.val()) {
          opts[key] = item.child.val();
          isEmpty = false;
          if(item.child.getTitle) {
            location.push(item.child.getTitle())
          }
        }
      }else {
        item.child.el.parent().each(function(el) {
          var name = el.getAttribute("wa-name");
          var type = el.getAttribute("type");
          var value = el.getAttribute("wa-value");
          if(name && type == "radio") {
            if(el.dom.checked) {
              opts[name] = value;
              isEmpty = false
            }
          }else {
            if(name && el.dom.value) {
              opts[name] = el.dom.value;
              isEmpty = false
            }
          }
        })
      }
    }, this);
    if(isEmpty) {
      opts.isEmpty = true;
      opts.ageFrom = 1
    }
    this.searchEvent.fire(opts, location.join(", "))
  }, reset:function() {
    this._country.setValue("");
    var list = this.el.dom.getElementsByTagName("input");
    U.Array.each(list, function(el) {
      if(el.getAttribute("type") == "text") {
        el.value = ""
      }
      if(el.getAttribute("type") == "radio") {
        el.checked = false
      }
    });
    this._emailField.val("");
    this._emailSearchErrorEl.hide()
  }, _onAfterRender:function() {
    WA.getCountryById(false, WA.createDelegate(this._setGeobase, this))
  }, __update:function(select, t, prefix) {
    var list = [];
    var primaryCountries = [];
    var primaryCountriesKeys = {};
    var favCountries = WA.tr("favoriteCountries", {defaultNull:true});
    if(favCountries) {
      primaryCountries = favCountries.split(",")
    }
    U.Array.each(primaryCountries, function(c, i) {
      primaryCountriesKeys[c] = i
    });
    primaryCountries = [];
    U.Array.each(t, function(it) {
      if(primaryCountriesKeys.hasOwnProperty(it[2])) {
        primaryCountries[primaryCountriesKeys[it[2]]] = [it[1], it[2]]
      }else {
        list.push([it[1], it[2]])
      }
    });
    primaryCountries.unshift([prefix, ""]);
    list = primaryCountries.concat(list);
    select.update(list)
  }, _setGeobase:function(data) {
    this._base = data;
    this._country.enable();
    this.__update(this._country, this._base, WA.tr("search.anyCountry"))
  }});
  var PlateResult = WA.extend(UI.Component, {constructor:function() {
    PlateResult.superclass.constructor.apply(this, arguments);
    this.showProfileEvent = new U.Event;
    this.showUserpicEvent = new U.Event;
    this.noFriendsEvent = new U.Event;
    this.addEvent = new U.Event;
    this.backEvent = new U.Event
  }, _onRender:function(el) {
    this.el = el.createChild({style:"display: none;", cls:"nwa-white-plate nwa-add__white3 nwa-add__search-result", children:[{cls:"nwa-add__search-result-inner"}]});
    this._contEl = this.el.first();
    this.scrollBar = new WA.ui.ScrollBar({source:this._contEl});
    this.scrollBar.render(this.el)
  }, _onAfterRender:function() {
    this._contEl.on("click", this._onClickEvent, this)
  }, _onClickEvent:function(el) {
    var trg = el.getTarget(true);
    var action = trg.getAttribute("wa-action");
    var mail = trg.getAttribute("wa-mail");
    var stamp = trg.getAttribute("wa-stamp");
    var name = trg.getAttribute("wa-name");
    switch(action) {
      case "back":
        this.backEvent.fire();
        break;
      case "userpic":
        this.showUserpicEvent.fire(mail, name);
        break;
      case "profile":
        this.showProfileEvent.fire(mail, this._suggestData);
        break;
      case "add":
        this.addEvent.fire(mail, false, this._suggestData);
        break;
      case "nofriends":
        this.noFriendsEvent.fire(mail, stamp, trg);
        break
    }
  }, setTitle:function(txt) {
    this._contEl.update(U.String.parseTemplate(SEARCH_RESULT_TOP, {title:U.String.htmlEntity(txt)}));
    this.scrollBar.sync()
  }, update:function(list) {
    if(this.rendered) {
      if(!list || list.length == 0) {
        this.el.removeClass("nwa-preloader");
        this._contEl.createChild(SEARCH_EMPTY)
      }else {
        var html = [];
        U.Array.each(list, function(contact) {
          var t = contact.email.match(/([^@]+)@([^\.]+)/);
          var isUIN = contact.email.indexOf("@uin.icq") != -1;
          var status = contact.status && contact.status.type || "online";
          if(isUIN) {
            status = "icq_" + status
          }
          var name = WA.MainAgent.WP2Nick(contact);
          var avatar = WA.makeAvatar(contact.email, name, "_avatarsmall");
          html.push(U.String.parseTemplate(SEARCH_RESULT_HTML, {avatar:avatar.url, avatarClass:avatar.className, name:U.String.htmlEntity(name), relation:"", nofriends:"", mail:contact.email, status:WA.Statuses.buildCssClass(status)}))
        });
        this.el.removeClass("nwa-preloader");
        this._contEl.createChild(html.join(""))
      }
      this.scrollBar.sync()
    }
  }, reset:function() {
    this._contEl.update("");
    this.el.addClass("nwa-preloader")
  }});
  var PlateSuggest = WA.extend(PlateResult, {constructor:function() {
    PlateSuggest.superclass.constructor.apply(this, arguments);
    this.requestContactsInfoEvent = new U.Event;
    this._suggestData = {}
  }, getList:function(cb, scope, withoutInfo) {
    if(!this._xdr) {
      this._xdr = WA.XDRequest.getInstance("mrimraker1.mail.ru")
    }
    var dispatch = WA.createDelegate(function(data) {
      var res = [];
      var nick = data.data.match(/[^\[]+(?=\]\]\>\<\/Nick\>)/g);
      var email = data.data.match(/[^\[]+(?=\]\]\>\<\/Email\>)/g);
      var sex = data.data.match(/[^\[]+(?=\]\]\>\<\/Sex\>)/g);
      var type = data.data.match(/[^\[]+(?=\]\]\>\<\/FriendshipType\>)/g);
      if(!email) {
        cb && cb.call(scope || window, false)
      }else {
        function updateData(hash) {
          for(var i = 0;i < email.length;i++) {
            if(!hash[email[i]]) {
              res.push({email:email[i], nick:nick[i], type:type[i], sex:sex[i], relation:FRIENDSHIP_TYPES[+type[i]] || WA.tr("search.fourtySecondCousin")})
            }
          }
        }
        if(withoutInfo) {
          updateData({});
          return cb && cb.call(scope || window, res)
        }
        this.requestContactsInfoEvent.fire(email, function(contacts) {
          var contactsHash = {};
          U.Array.each(contacts, function(contact) {
            contactsHash[contact[0]] = 1
          });
          updateData(contactsHash);
          cb && cb.call(scope || window, res)
        }, this)
      }
    }, this);
    this._xdr.request({url:"/agent_suggest", data:{nocache:1}}, dispatch, WA.createDelegate(function() {
      this._xdr.request({url:"/agent_suggest", data:{nocache:1}}, dispatch, WA.createDelegate(function() {
        cb && cb.call(scope || window, false)
      }, this))
    }, this))
  }, _onShow:function() {
    this.getList(function(list) {
      var html = [];
      if(list) {
        U.Array.each(list, function(contact) {
          var t = contact.email.match(/([^@]+)@([^\.]+)/);
          var isUIN = contact.email.indexOf("@uin.icq") != -1;
          var status = contact.status && contact.status.type || "online";
          if(isUIN) {
            status = "icq_" + status
          }
          var avatar = WA.makeAvatar(contact.email, contact.nick, "_avatarsmall");
          html.push(U.String.parseTemplate(SEARCH_RESULT_HTML, {avatar:avatar.url, avatarClass:avatar.className, name:U.String.htmlEntity(contact.nick), relation:'<div class="nwa-add__search-item__relation">' + contact.relation + '<div class="nwa-add__search-item__name-fader"></div></div>', nofriends:'<span class="nwa-add__search-item__button nwa-add__btn-remove" wa-action="nofriends" wa-stamp="' + contact.stamp + '" wa-mail="' + contact.email + '">' + WA.tr("search.notFamiliar") + "</span>", mail:contact.email, 
          status:WA.Statuses.buildCssClass(status)}))
        }, this)
      }
      this.el.removeClass("nwa-preloader");
      this._contEl.update(html.join(""));
      this.scrollBar.sync()
    }, this)
  }});
  var PlateCollection = WA.extend(UI.Component, {constructor:function() {
    PlateCollection.superclass.constructor.apply(this, arguments);
    this._collection = []
  }, add:function(plate) {
    this._collection.push(plate)
  }, show:function(index) {
    if(index < this._collection.length) {
      U.Array.each(this._collection, function(plate, i) {
        plate.hide()
      }, this);
      this._collection[index].show()
    }
  }});
  var Abstraction = WA.extend(ConnectionRoster, {constructor:function() {
    Abstraction.superclass.constructor.apply(this, arguments);
    this.updateEvent = new U.Event;
    this.addSuccessEvent = new U.Event;
    this._profiles = {};
    this._waiting = {};
    this._addHistory = {}
  }, search:function(opts) {
    opts.uniq = this._uniq = opts.uniq || Math.round(Math.random() * 999999);
    if(opts.email) {
      WA.IcqApi.getProfile(opts, function(success) {
        if(!success) {
          this.updateEvent.fire([], opts.uniq)
        }
      }, this)
    }else {
      opts.num = 60;
      WA.IcqApi.searchProfile(opts, function(success) {
        if(!success) {
          this.updateEvent.fire([], opts.uniq)
        }
      }, this)
    }
    this.__search = opts
  }, get:function(mail, cb, scope) {
    if(this._profiles[mail]) {
      cb.call(scope || window, this._profiles[mail])
    }else {
      if(!this._waiting[mail]) {
        this._waiting[mail] = [];
        this.search({email:mail})
      }
      this._waiting[mail].push([cb, scope])
    }
  }, _invokeWaitings:function() {
    var dellist = [];
    U.Object.each(this._waiting, function(cbs, mail) {
      if(this._profiles[mail]) {
        U.Array.each(cbs, function(cb) {
          cb[0].call(cb[1] || window, this._profiles[mail])
        }, this);
        dellist.push(mail)
      }
    }, this);
    U.Array.each(dellist, function(mail) {
      delete this._waiting[mail]
    }, this)
  }, _addSuccess:function(mail) {
    var nick = this.__getNick(mail);
    this.addSuccessEvent.fire(mail, nick);
    delete this._addHistory[mail]
  }, _onConnectionContactAddFail:function(value) {
    if(this._addHistory[value.mail]) {
      switch(value.message) {
        case "exists":
          this._addSuccess(value.mail);
          break;
        case "ignored":
          WA.IcqApi.ignoreContact({unignore:true, email:value.mail});
          this._addSuccess(value.mail);
          break
      }
    }
  }, _onConnectionContactAddSuccess:function(value) {
    if(WA.MainAgent.isChat(value.email)) {
      return
    }
    this._addSuccess(value.email);
    if(!__preventSearchStatistics) {
      U.Mnt.countRB(this.__lastSearchEmailSuccess === true ? 2010021 : 2010023)
    }
  }, _collectProfiles:function(value) {
    U.Array.each(value, function(contact) {
      this._profiles[contact.email] = contact
    }, this)
  }, _onConnectionWp:function(value) {
    if(value.uniq && value.uniq == this._uniq) {
      delete this.__lastSearchEmailSuccess;
      if(value.result) {
        if(this.__search && this.__search.email) {
          if(!__preventSearchStatistics) {
            U.Mnt.countRB(2010016)
          }
          this.__lastSearchEmailSuccess = true
        }
        delete this.__search;
        this._collectProfiles(value.result);
        this.updateEvent.fire(value.result, value.uniq);
        this._invokeWaitings()
      }else {
        if(value.error == "unknow") {
          WA.setTimeout(function() {
            return WA.createDelegate(function() {
              this.search(this.__search)
            }, this)
          }.call(this), 5E3)
        }else {
          this.updateEvent.fire([])
        }
      }
    }
  }, __getNick:function(mail) {
    return(this._addHistory[mail] || {nick:mail}).nick
  }, add:function(mail, nick, cb, scope) {
    this._addHistory[mail] = {nick:nick};
    WA.MainAgent.sendAddContact(mail, nick, function(success) {
      cb && cb.call(scope || window, success)
    }, this)
  }});
  WA.AddSearchDialog = WA.extend(UI.Layer, {constructor:function() {
    WA.AddSearchDialog.superclass.constructor.apply(this, arguments);
    this.autoEl = null;
    this.openContactEvent = new U.Event;
    this.addSuccessEvent = new U.Event;
    this.contactInfoRequestEvent = new U.Event;
    this._tabs = new Tabs;
    this._tabs.addTab(WA.tr("search.search"));
    this._tabs.setFocus(0);
    this._tabs.tabChangeEvent.on(this._onTabChangeEvent, this);
    this._search = new PlateSearch;
    this._search.searchEvent.on(this._onSearchEvent, this);
    this._result = new PlateResult;
    this._result.showUserpicEvent.on(this._onShowUserpicEvent, this);
    this._result.showProfileEvent.on(this._onShowProfileEvent, this);
    this._result.noFriendsEvent.on(this._onNoFriendsEvent, this);
    this._result.addEvent.on(this.addNewContact, this);
    this._result.backEvent.on(function() {
      this._plates.show(0)
    }, this);
    this._plates = new PlateCollection;
    this._plates.add(this._search);
    this._plates.add(this._result);
    this._abstraction = new Abstraction;
    this._abstraction.updateEvent.on(this._onUpdate, this);
    this._abstraction.addSuccessEvent.on(this._onAddSuccess, this)
  }, getSuggests:function(cb, scope, withoutInfo) {
  }, _showProfile:function(mail, profile, isSuggest) {
    if(!this._profile) {
      this._profile = new WA.Profile(true, {modal:true, fadeIn:true, overlay:this._mainEl.parent()});
      this._profile.addEvent.on(this.addNewContact, this);
      this._profile.render(this._mainEl)
    }
    this._profile.show(mail, profile, isSuggest)
  }, _hideProfile:function() {
    if(this._profile) {
      this._profile.hide()
    }
  }, _onRender:function(el) {
    this.el = el.createChild({cls:"nwa-add nwa_fadein", style:"opacity: 1", children:[{cls:"nwa-add__plate", children:[{cls:"nwa-add__nick", children:[{tag:"span", children:WA.tr("search.title")}, {cls:"nwa-header__nick-fadeout"}]}, {cls:"nwa-addcontact__close"}]}]});
    this._mainEl = this.el.first();
    this._mainEl.last().on("click", this.hide, this);
    this._tabs.render(this._mainEl);
    this._search.render(this._mainEl);
    this._result.render(this._mainEl);
    this._photo = new WA.PhotoPreview({autoRender:this._mainEl, modal:true})
  }, _onTabChangeEvent:function(index) {
    if(index == 1) {
      index = 2
    }
    __preventSearchStatistics = index == 2;
    this._plates.show(index)
  }, _onShowUserpicEvent:function(mail, name) {
    this._photo.show(mail, name)
  }, _onShowProfileEvent:function(mail, suggestData) {
    if(suggestData && suggestData[mail]) {
      this._showProfile(mail, profile, true)
    }else {
      this._abstraction.get(mail, function(profile) {
        this._showProfile(mail, profile, !!suggestData)
      }, this)
    }
  }, __addContactAndNick:function(mail, nick, cb, scope) {
    this._abstraction.add(mail, nick, cb, scope)
  }, addNewContact:function(mail, nick, suggestData) {
    this.contactInfoRequestEvent.fire([mail], function(contacts) {
      var contact = contacts[0];
      if(!contact) {
        if(suggestData && suggestData[mail] && !nick) {
          nick = WA.MainAgent.WP2Nick(suggestData[mail])
        }
        if(!nick) {
          this._abstraction.get(mail, function(contact) {
            this.__addContactAndNick(mail, WA.MainAgent.WP2Nick(contact), function(success) {
              if(suggestData) {
                if(success) {
                  U.Mnt.countRB(2249803)
                }
              }
            })
          }, this)
        }else {
          this.__addContactAndNick(mail, nick, function(success) {
            if(suggestData) {
              if(success) {
                U.Mnt.countRB(2249803)
              }
            }
          })
        }
      }else {
        if(!this._openDialogConfirm) {
          this._openDialogConfirm = new WA.DialogsAgent.RemoveContactDialog({okButton:WA.tr("search.openChat"), autoRender:this._mainEl})
        }
        this._openDialogConfirm.okEvent.removeAll();
        this._openDialogConfirm.okEvent.on(function() {
          contact.splice(2, 0, false);
          this.openContactEvent.fire.apply(this.openContactEvent, contact);
          this.hide()
        }, this);
        this._openDialogConfirm.show(WA.tr("search.alreadyInList", {nick:contact[1] ? contact[1] + " (" + contact[0] + ")" : contact[0]}))
      }
    }, this)
  }, _onAddSuccess:function(mail, nick) {
    this.openContactEvent.fire(mail, nick);
    this.addSuccessEvent.fire(mail, nick);
    this.hide()
  }, _onNoFriendsEvent:function(mail, stamp, el) {
    el && el.up("nwa-suggest-item").remove();
    if(mail.indexOf("@uin.icq") != -1) {
      return
    }
    if(!this._xdr) {
      this._xdr = WA.XDRequest.getInstance("mrimraker1.mail.ru")
    }
    this.el && this.el.mask();
    var data = {exclude:mail};
    this._xdr.request({url:"/agent_suggest", data:data}, this.el && WA.createDelegate(this.el.unmask, this.el), this.el && WA.createDelegate(this.el.unmask, this.el))
  }, __isIcq:function(uin) {
    var digits = (uin.match(/\d+/g) || []).join("");
    if(!!(uin.indexOf("@") == -1 && digits.length > 4)) {
      return digits
    }else {
      return false
    }
  }, __isValidMail:function(email) {
    return!!email.match(/^[^@]+@([a-z0-9][a-z0-9-]+\.){1,}([a-z0-9][a-z0-9-]{1,})$/i)
  }, searchMail:function(mail, openProfile) {
    if(openProfile) {
      this._openProfileUniq = Math.round(Math.random() * 999999)
    }
    this._onSearchEvent({email:mail, uniq:this._openProfileUniq})
  }, _onUpdate:function(value, uniq) {
    this._result.update(value);
    if(uniq && uniq == this._openProfileUniq) {
      if(value && value.length) {
        this._onShowProfileEvent(value[0].email)
      }
      delete this._openProfileUniq
    }
  }, _onSearchEvent:function(opts, location) {
    var isValid = false;
    if(opts.email) {
      var email = opts.email, uin;
      if(this.__isValidMail(email)) {
        isValid = true
      }else {
        if(uin = this.__isIcq(email)) {
          opts.email = uin + "@uin.icq";
          isValid = true
        }
      }
      if(!__preventSearchStatistics) {
        U.Mnt.countRB(isValid ? 2010015 : 2010014)
      }
    }else {
      if(!__preventSearchStatistics) {
        U.Mnt.countRB(2010017)
      }
      isValid = true
    }
    if(isValid) {
      var searchTitle = email;
      if(!searchTitle) {
        searchTitle = U.String.trim((opts.firstname || "") + " " + (opts.lastname || ""));
        var params = [];
        if(searchTitle) {
          params.push(searchTitle)
        }
        if(opts.sex) {
          params.push(["", WA.tr("sex.m"), WA.tr("sex.f")][+opts.sex])
        }
        if(opts.ageFrom) {
          params.push(WA.tr("search.from") + " " + opts.ageFrom)
        }
        if(opts.ageUntil) {
          params.push(WA.tr("search.to") + " " + opts.ageUntil)
        }
        if(location) {
          params.push(location)
        }
        if(opts.isEmpty) {
          params = [WA.tr("search.noParameters")]
        }
        searchTitle = params.join(", ")
      }
      this._abstraction.search(opts);
      this._result.reset();
      this._result.setTitle(searchTitle);
      this._plates.show(1)
    }else {
      return false
    }
  }, _onHide:function() {
    WA.AddSearchDialog.superclass._onHide.apply(this);
    __preventSearchStatistics = true;
    this._plates.show(0);
    this._search.reset();
    this._tabs.setFocus(0);
    this._hideProfile();
    this._photo.hide();
    this._openDialogConfirm && this._openDialogConfirm.hide()
  }, show:function(tab) {
    WA.AddSearchDialog.superclass.show.apply(this);
    __preventSearchStatistics = false;
    if(typeof tab == "number") {
      this._tabs.setFocus(+(tab == 2));
      this._plates.show(tab);
      __preventSearchStatistics = tab == 2
    }
  }, _onShow:function() {
    __preventSearchStatistics = false;
    U.Mnt.countRB(2010012);
    WA.AddSearchDialog.superclass._onShow.apply(this);
    U.Mnt.countRB(706784);
    this._plates.show(0)
  }})
})();
(function() {
  var SECOND = 1E3, MINUTE = SECOND * 60, HOUR = MINUTE * 60, ACTIVITY_EXPIRATION_TIME = HOUR * 24, ACTIVE_CONTACTS_MAX_LEGTH = 40, ACTIVITY_LIST_REFRESH_TIMEOUT = MINUTE, BIG = 1E16;
  var WA = WebAgent;
  var U = WA.util;
  var JSON = WA.getJSON();
  var SOCK = WA.ConnectionFacade;
  var map = ["email", "nick", "needAuth", "status", "statusTitle", "mute", "lastseen"];
  var mapKeys = {};
  U.Array.each(map, function(it, i) {
    mapKeys[it] = i
  });
  WA.contactMap = map;
  WA.contactMapKeys = mapKeys;
  WA.makeContactArray = function(mail, nick, needAuth) {
    return[mail, nick, !!needAuth, needAuth ? "gray" : ""]
  };
  WA.contactToArray = function(hash, ar) {
    ar || (ar = []);
    U.Array.each(map, function(k, i) {
      if(hash.hasOwnProperty(k)) {
        ar[i] = hash[k]
      }
    });
    ar.length = Math.max(map.length, ar.length);
    return ar
  };
  WA.contactToHash = function(contact, hash) {
    hash || (hash = {});
    U.Array.each(contact, function(v, i) {
      if(map[i] && v != undefined) {
        hash[map[i]] = v
      }
    });
    return hash
  };
  var limitRate = function(fn, rate, scope) {
    var ts = 0, scope = scope || this, delayedTask, delta, now, interval;
    return function() {
      now = +new Date;
      delta = now - ts;
      if(delta > rate) {
        fn.apply(scope, arguments);
        ts = now
      }else {
        if(delayedTask) {
          delayedTask.stop()
        }
        interval = rate - delta;
        delayedTask = new U.DelayedTask({fn:function() {
          fn.apply(scope, arguments);
          ts = +new Date
        }, scope:scope, interval:interval});
        delayedTask.start()
      }
    }
  };
  var ContactListData = WA.extend(Object, {constructor:function() {
    ContactListData.superclass.constructor.apply(this, arguments);
    this._data = {};
    this._friendlyNames = {};
    WA.ConnectionFacade.triggerEvent.on(this._onConnectionTriggerEvent, this)
  }, _onConnectionTriggerEvent:function(type, value) {
    if(type === "contactStatus") {
      if(!this.abData) {
        this.abData = {}
      }
      this.abData[value.email] = {abName:value.abContactName, abPhone:value.abPhoneNumber}
    }
  }, setData:function(mail, data) {
    var nick = this._friendlyNames[mail];
    this._data[mail] = data;
    if(!data[1] && nick) {
      data[1] = nick
    }
    data[1] && (this._friendlyNames[mail] = data[1])
  }, inList:function(mail) {
    return!!this._data[mail]
  }, dropData:function() {
    this._data = {}
  }, getInfo:function(mail) {
    var data = this._data[mail];
    if(data) {
      data = WA.contactToHash(data);
      data.status = WA.MainAgent.getGeneralContactStatus(this._data[mail])
    }
    return data || {}
  }, getInfoArray:function(mail) {
    var data = this._data[mail] || null;
    if(data) {
      data = [data[0], data[1], data[2], WA.MainAgent.getGeneralContactStatus(data)].concat(data.slice(4))
    }
    return data
  }, getAbInfo:function(userId, cb) {
    if(this.abData && this.abData[userId]) {
      cb && cb(this.abData[userId]);
      return this.abData[userId]
    }
    WA.IcqApi.getContactStatus({email:userId}, function(resp) {
      if(cb && this.abData) {
        cb(this.abData[userId])
      }
    }.bind(this))
  }, getMute:function(mail) {
    return this._data[mail] && this._data[mail][5]
  }, getFriendlyName:function(mail) {
    return this._data[mail] && this._data[mail][1] || this._friendlyNames[mail] || ""
  }, getAuthStatus:function(mail) {
    return this._data[mail] && {needAuth:this._data[mail][2], status:this._data[mail][3]}
  }, saveFriendly:function(mail, friendly) {
    this._friendlyNames[mail] = friendly;
    if(this._data[mail] && this._data[mail][1] !== friendly) {
      this._data[mail][1] = friendly;
      return true
    }
  }});
  var _activityManagerInstance;
  var getActivityManager = WA.getActivityManager = function() {
    if(!_activityManagerInstance) {
      _activityManagerInstance = new ActivityManager
    }
    return _activityManagerInstance
  };
  var ActivityManager = WA.extend(Object, {constructor:function() {
    this.updateActivityEvent = new U.Event;
    this.activityList = {};
    WA.ContactStates.beforeUpdateEvent.on(function(data) {
      this.activityList = {};
      WA.util.Object.each(data, function(entry, email) {
        if(entry.recent) {
          this.activityList[email] = {recent:entry.recent, nick:entry.nick}
        }
      }, this)
    }, this)
  }, getActivity:function(email) {
    if(email in this.activityList) {
      return this.activityList[email].recent
    }
    return 0
  }, updateContactStatus:function(contact) {
  }, getActiveCount:function() {
    return U.Object.getLength(this.activityList)
  }, getActiveList:function() {
    return WA.apply({}, this.activityList)
  }});
  var CompareManager = {_data:{}, getKey:function(contact, useActivity) {
    var email = contact[0], sortName = this._data[email];
    var statusMod = contact[3].search(/(?:icq_)?offline|gray|unknown|tel/) === 0 ? "2" : "1";
    if(!sortName || sortName[0] != statusMod) {
      sortName = statusMod + this._getContactIndex(contact) + (contact[1] || email).toLowerCase() + "_" + email;
      this._data[email] = sortName
    }
    if(useActivity) {
      var lastActivity = getActivityManager().getActivity(email);
      var sortTS = lastActivity ? "" + (lastActivity - BIG) : "";
      sortName = sortTS + sortName
    }
    return sortName
  }, resetKey:function(email) {
    delete this._data[email]
  }, _getContactIndex:function(contact) {
    var gr;
    if(WA.MainAgent.isChat(contact[0])) {
      gr = 4
    }else {
      if(WA.MainAgent.isTel(contact[0])) {
        gr = 3
      }else {
        if(contact[2]) {
          gr = 2
        }
      }
    }
    return gr || 1
  }};
  var AbstractData = WA.extend(WA.Activatable, {constructor:function() {
    this.data = null;
    this.loadEvent = new U.Event;
    this.updateActivityEvent = new U.Event;
    this.hideActiveDialogs = false;
    WA.Invalidator.invalidateEvent.on(this._onInvalidate, this);
    WA.ChangeLog.updateEvent.on(this._onChangeLogUpdate, this)
  }, _onActivate:function() {
    this.loadEvent.resume()
  }, _onDeactivate:function() {
    this.data = null;
    this.loadEvent.suspend()
  }, getRange:function(from, to) {
    this.requestParams = {from:from, to:to};
    if(this.isActive() && WA.isNumber(from) && WA.isNumber(to)) {
      WA.ChangeLog.whenReady(this._onGetRange, this)
    }
  }, _onGetRange:function() {
    WA.abstractError()
  }, _sortContactList:function(data) {
    var start = +new Date;
    var len = data.length, a = [], matched = 0, gr, n, i, email;
    data = data.sort();
    for(i = 0;i < len;i++) {
      email = data[i][0];
      gr = this._getSortGr(data[i]);
      n = data[i][1] || email;
      a[i] = gr + n.toLowerCase() + "_" + i
    }
    a = a.sort();
    var ret = [];
    U.Array.each(a, function(entry) {
      var tmp = entry.split("_");
      var index = tmp[tmp.length - 1];
      ret.push(data[index])
    });
    return ret
  }, _applyChangeLogTo:function(data, log) {
    var updated = false;
    if(log.length > 0) {
      U.Array.each(log, function(logItem) {
        CompareManager.resetKey(logItem.email);
        if(logItem.action === "remove") {
          var index = U.Array.indexOfBy(data, function(dataItem) {
            return dataItem[0] === logItem.email
          });
          if(index != -1) {
            data.splice(index, 1);
            updated = true
          }
        }
      });
      this.data = data;
      U.Array.each(data, function(dataItem) {
        var email = dataItem[0];
        var index = U.Array.indexOfBy(log, function(logItem) {
          var isFound = logItem.email === email;
          if(isFound) {
            if(logItem.action) {
              if(logItem.action === "rename") {
                dataItem[1] = logItem.nick || logItem.email;
                updated = true
              }
              if(logItem.action === "add") {
                logItem.action = null;
                U.Mnt.log({reason:"breaklog", text:"doublecontact: login=" + WA.ACTIVE_MAIL + " mail=" + email})
              }
              return false
            }
          }
          return isFound
        });
        if(index != -1) {
          var newStatus = log[index].status;
          var t = newStatus + dataItem[3];
          if(t.indexOf("offline") != -1 && newStatus != dataItem[3]) {
            updated = true
          }
          dataItem[1] = log[index].nick;
          dataItem[2] = 0;
          dataItem[3] = newStatus;
          dataItem[4] = log[index].statusTitle;
          dataItem[6] = log[index].lastSeen;
          dataItem[7] = log[index].features;
          CLData.setData(dataItem[0], dataItem)
        }
      }, this);
      U.Array.each(log, function(logItem) {
        if(logItem.action === "add") {
          data.push([logItem.email, logItem.nick || logItem.email, 1, logItem.status || "offline", logItem.statusTitle, logItem.tel ? [logItem.tel] : null, logItem.features || 0]);
          updated = true
        }
      })
    }
    return updated
  }, _fireLoadEvent:function(data, length) {
    return this.loadEvent.fire(this, data, length)
  }, _onInvalidate:function() {
    this.data = null
  }, _onChangeLogUpdate:function(log) {
    if(this.data) {
      if(this._applyChangeLogTo(this.data, log)) {
        var data = this._sortContactList(this.data, true);
        this.data = data
      }
      this._initVisibleData(this.data, this.data.length)
    }
  }, _sliceListData:function(data, from, to) {
    to = Math.min(to, data.length);
    return data.slice(from, to)
  }, _extractVisibleArea:function(data) {
    return data
  }, _initVisibleData:function(data, length) {
    var reqParams = this.requestParams;
    if(reqParams) {
      var visibleData = this._sliceListData(data, reqParams.from, reqParams.to);
      this._fireLoadEvent(visibleData, length)
    }
  }, _getSortGr:function(contact) {
    var gr;
    if(WA.MainAgent.isChat(contact[0])) {
      gr = 5
    }else {
      if(WA.MainAgent.isTel(contact[0])) {
        gr = 4
      }else {
        if(contact[2]) {
          gr = 3
        }else {
          if(contact[3] == "offline" || contact[3] == "icq_offline") {
            gr = 2
          }else {
            gr = 1
          }
        }
      }
    }
    return gr
  }, destroy:function() {
    this.loadEvent.removeAll();
    this.loadEvent = null;
    WA.Invalidator.invalidateEvent.un(this._onInvalidate, this);
    WA.ChangeLog.updateEvent.un(this._onChangeLogUpdate, this)
  }, cast2data:function(cast) {
    return[cast.mail || cast.email, cast.nick, +(cast.status == "gray" || cast.status == "icq_gray"), cast.status, cast.statusTitle, cast.phones, cast.features]
  }});
  var RemoteData = WA.extend(AbstractData, {_prefix:"clist_", constructor:function() {
    RemoteData.superclass.constructor.call(this);
    this._clistReceivedEvent = new U.Event;
    this.data = null;
    this.fullLength = null;
    this.chatInfo = {};
    this.selfContactData = {};
    this._requestedMails = {};
    this._requestedUniqs = {};
    this.activityManager = getActivityManager();
    this.storageListReader = new WA.util.DelayedTask;
    this.canShowOffline = true;
    WA.ConnectionFacade.triggerEvent.on(this._onConnectionTriggerEvent, this);
    this.searchReadyEvent = new U.Event;
    this.searchPhoneReadyEvent = new U.Event;
    this.searchPhonebookReadyEvent = new U.Event;
    this.searchConfPartyReadyEvent = new U.Event;
    this.sync = WA.Synchronizer.registerComponent("clist", ["varea_version"]);
    this.sync.triggerEvent.on(this._onSyncTriggerEvent, this);
    WA.ContactStates.updateEvent.on(this._onContactStatesUpdate, this)
  }, _sortContactList:function(data, noActive) {
    var len = data.length, a = [], activeList = {}, i, email, tmp;
    data = data.slice(0);
    if(!noActive && !this.hideActiveDialogs) {
      var lastActivity, matched = 0;
      activeList = this.activityManager.getActiveList();
      tmp = [];
      for(var x in activeList) {
        if(activeList.hasOwnProperty(x)) {
          tmp.push([activeList[x].recent, x])
        }
      }
      tmp = tmp.sort(function(a, b) {
        return a[0] < b[0]
      });
      for(i = 0, len = tmp.length;i < len;i++) {
        if(i >= ACTIVE_CONTACTS_MAX_LEGTH) {
          delete activeList[tmp[i][1]]
        }
      }
    }
    len = data.length;
    var dataIndex = {}, useActivity;
    CLData.dropData();
    for(i = 0;i < len;i++) {
      email = data[i][0];
      useActivity = false;
      CLData.setData(data[i][0], data[i]);
      if(email in activeList) {
        if(activeList.hasOwnProperty(email)) {
          useActivity = true;
          delete activeList[email]
        }
      }
      a[i] = CompareManager.getKey(data[i], useActivity);
      dataIndex[a[i]] = i
    }
    if(!noActive && !this.hideActiveDialogs) {
      for(email in activeList) {
        if(activeList.hasOwnProperty(email)) {
          tmp = WA.makeContactArray(email, activeList[email].nick, true);
          i = data.push(tmp) - 1;
          a[i] = CompareManager.getKey(data[i], true);
          dataIndex[a[i]] = i
        }
      }
    }
    a.sort();
    var ret = [];
    U.Array.each(a, function(entry) {
      var t = data[dataIndex[entry]];
      t[8] = entry;
      ret.push(t)
    });
    return ret
  }, _onActivate:function() {
    this.searchReadyEvent.resume();
    RemoteData.superclass._onActivate.call(this);
    WA.log("CLIST _onActivate");
    this.getRange(0, 0)
  }, _onDeactivate:function() {
    this.fullLength = null;
    this.searchReadyEvent.suspend();
    RemoteData.superclass._onDeactivate.call(this)
  }, _isReady:function() {
    return WA.isArray(this.data) && WA.isNumber(this.fullLength)
  }, _isFullData:function() {
    return this._isReady()
  }, _getListFromServer:function() {
    if(!WA.isProblemStrictSafari) {
      return
    }
    if(!this.__loadingFromServer && this.requestParams) {
      this.__loadingFromServer = true;
      WA.FocusManager.blurEvent.on(function() {
        if(this.__loadingFromServer) {
          this.__loadingFromServer = false
        }
      }, this, {single:true});
      WA.ConnectionFacade.getClist(null, function() {
        this.__loadingFromServer = false;
        this.__loadingFail = true
      }, this)
    }
  }, _getChatMembers:function(mail, cb, scope) {
    if(!this._requestedMails[mail]) {
      this._requestedMails[mail] = cb ? {clbk:cb, scope:scope} : {};
      WA.IcqRapi.getChatInfo({email:mail}, function(status) {
        if(status !== 200) {
          delete this._requestedMails[mail];
          delete this.chatInfo[mail]
        }
      }, this)
    }else {
      if(!("clbk" in this._requestedMails[mail]) && cb) {
        this._requestedMails[mail].clbk = cb;
        this._requestedMails[mail].scope = scope
      }
    }
  }, _onSuccessReconnect:function() {
    if(this.__loadingFail) {
      this.__loadingFail = false;
      this._getListFromServer()
    }
  }, _onConnectionTriggerEvent:function(type, value) {
    if(type === "chatInfo") {
      var mail = value.sn;
      var details = this._requestedMails[mail];
      if(mail && details) {
        delete this._requestedMails[mail];
        this.chatInfo[mail] = {members:value.membersList || [], membersData:value.members || [], locked:value.controlled && (!value.you || value.you.role !== "admin")};
        details.clbk && details.clbk.call(details.scope || window)
      }
    }else {
      if(type === "contactList") {
        var data = this._sortContactList(value, true);
        this._saveListToStorage(this._extractVisibleArea(data), data.length, function() {
          this._saveLocalListData(data, data.length);
          var query = this.__searchQuery;
          if(query) {
            this.search(query)
          }
          if(this.__searchPhone) {
            this.searchPhone(this.__searchPhone)
          }
          this._clistReceivedEvent.fire(data);
          this.__loadingFromServer = false;
          WA.debug.State.set("clist.status", "loaded from <strong>server</strong>")
        })
      }else {
        if(type == "contactModifySuccess") {
          var phones = value.phones;
          if(phones && this.data) {
            U.Array.each(this.data, function(entry) {
              if(value.email == entry[0]) {
                entry[5] = phones
              }
            })
          }
        }else {
          if(type == "archSync") {
          }
        }
      }
    }
  }, _getListFromStorage:function(cb) {
    var keys = [this._prefix + "list", this._prefix + "list_length"];
    WA.SessionStorage.load(keys, {success:function(data) {
      var list = data[this._prefix + "list"];
      var length = data[this._prefix + "list_length"];
      cb.call(this, list ? this._parseListFromStorage(list) : null, parseInt(length))
    }, failure:function(e) {
    }, scope:this})
  }, _saveListToStorage:function(data, fullLength, cb) {
    var serialized = JSON.stringify(data);
    var pfx = this._prefix;
    var params = {};
    if(!WA.isProblemStrictSafari) {
      params[pfx + "list"] = serialized
    }
    params[pfx + "list_length"] = fullLength;
    WA.SessionStorage.save(params, {success:function() {
      this.sync.write("varea_version", (new Date).getTime());
      if(WA.isFunction(cb)) {
        cb.call(this)
      }
    }, scope:this})
  }, _initVisibleData:function(data, length) {
    data = this._sortContactList(data);
    length = data.length;
    if(this.canShowOffline) {
      RemoteData.superclass._initVisibleData.call(this, data, length)
    }else {
      var onlineContacts = [];
      U.Array.indexOfBy(data, function(contact) {
        if(WA.MainAgent.isChat(contact[0]) || !contact[2] && contact[3] !== "offline" && contact[3] !== "icq_offline") {
          onlineContacts.push(contact)
        }
      });
      if(onlineContacts.length > 0) {
        RemoteData.superclass._initVisibleData.call(this, onlineContacts, onlineContacts.length)
      }else {
        RemoteData.superclass._initVisibleData.call(this, data, length)
      }
    }
  }, _saveLocalListData:function(data, fullLength) {
    this.data = data;
    this.fullLength = fullLength;
    this._clistReceivedEvent.fire(data);
    this._initVisibleData(this.data, this.fullLength)
  }, _parseListFromStorage:function(storageData) {
    return eval(storageData)
  }, _onGetRange:function() {
    this.storageListReader.stop();
    WA.debug.State.set("clist.status", "loading...");
    if(!this._isReady()) {
      WA.debug.State.set("clist.status", "not ready yet: loading...");
      WA.FocusManager.ifFocused(function() {
        WA.debug.State.set("clist.status", "loading from storage...");
        this._getListFromStorage(function(storageData, fullLength) {
          if(!this._isReady()) {
            if(!storageData) {
              WA.debug.State.set("clist.status", "loading from server...");
              this._getListFromServer()
            }else {
              WA.debug.State.set("clist.status", "loaded from <strong>storage</strong>");
              this._saveLocalListData(storageData, fullLength)
            }
          }
        })
      }, function() {
        WA.debug.State.set("clist.status", "inactive window; loading...");
        this.storageListReader.start(1E3, function() {
          this._getListFromStorage(function(storageData, fullLength) {
            if(!this.data) {
              if(storageData) {
                this._saveLocalListData(storageData, fullLength)
              }else {
                if(WA.isProblemStrictSafari) {
                  this._onGetRange()
                }else {
                  this.storageListReader.start(1E3)
                }
              }
            }
          })
        }, this)
      }, this)
    }else {
      if(this._isFullData()) {
        this._initVisibleData(this.data, this.data.length)
      }else {
        this.data = null;
        var reqParams = this.requestParams;
        this.getRange(reqParams.from, reqParams.to)
      }
    }
  }, _onInvalidate:function() {
    RemoteData.superclass._onInvalidate.call(this);
    this.fullLength = null;
    this._trySaveCurrentListToStorage()
  }, _trySaveCurrentListToStorage:function() {
    WA.FocusManager.ifFocused(function() {
      var data = this._sortContactList(this.data || [], true);
      this._saveListToStorage(this._extractVisibleArea(data || []), this.fullLength || 0)
    }, null, this)
  }, _onChangeLogUpdate:function(log) {
    if(this._isReady() && log.length > 0) {
      if(this._applyChangeLogTo(this.data, log)) {
        var data = this._sortContactList(this.data, true);
        this.data = data
      }
      U.Array.each(log, function(logItem) {
        if(logItem.action === "remove") {
          this.fullLength--
        }else {
          if(logItem.action === "add") {
            this.fullLength++
          }
        }
      }, this);
      this._initVisibleData(this.data, this.fullLength);
      this._trySaveCurrentListToStorage()
    }else {
      if(log.length) {
        U.Array.each(log, function(logItem) {
          CompareManager.resetKey(logItem.email)
        })
      }
    }
  }, _onContactStatesUpdate:function(contactStates, forceUpdate) {
    if(this._isReady()) {
      var isAffected = forceUpdate || false;
      var data = this._extractVisibleArea(this.data);
      U.Array.each(data, function(entry) {
        if(WA.ContactStates.getStates(entry[0])) {
          isAffected = true;
          return false
        }
      }, this);
      if(isAffected) {
        this._initVisibleData(this.data, this.fullLength)
      }
    }
  }, _onSyncTriggerEvent:function(syncRecord) {
    if(syncRecord.isChanged("varea_version")) {
      var isStorageReaderStarted = this.storageListReader.isStarted();
      this.storageListReader.stop();
      this._getListFromStorage(function(storageData, fullLength) {
        var reqParams = this.requestParams;
        if(storageData && !this._isFullData() && reqParams && reqParams.from === 0) {
          this._saveLocalListData(storageData, fullLength)
        }else {
          if(isStorageReaderStarted) {
            this.storageListReader.start()
          }
        }
      })
    }
  }, getPhoneList:function(cb, scope) {
    var newData = [];
    if(this._isFullData()) {
      U.Array.each(this.data, function(item) {
        if(item[5] && item[5].length) {
          newData.push(item)
        }
      }, this);
      cb.call(scope || window, newData)
    }else {
      this._clistReceivedEvent.on(function() {
        U.Array.each(this.data, function(item) {
          if(item[5] && item[5].length) {
            newData.push(item)
          }
        }, this);
        cb.call(scope || window, newData)
      }, this, {single:true});
      if(!this.requestParams) {
        this.getRange(0, 0)
      }
      this._getListFromServer()
    }
  }, __addSelfToMailList:function(list, mail) {
    var ready, self = [mail, this.selfContactData.nick || mail, 0, this.selfContactData.status, this.selfContactData.statusTitle];
    U.Array.each(list, function(it, ind) {
      if(self[1].toLowerCase() < (it[1] || it[0]).toLowerCase() || it[2]) {
        list.splice(ind, 0, self);
        ready = true;
        return false
      }
    });
    if(!ready) {
      list.push(self)
    }
  }, getParticipantsList:function(cb, scope, mail, rev) {
    if(mail && !this.chatInfo[mail]) {
      this._getChatMembers(mail)
    }
    if(this._isFullData()) {
      if(mail && !this.chatInfo[mail]) {
        return this._getChatMembers(mail, function() {
          this.getParticipantsList(cb, scope, mail, rev)
        }, this)
      }
      var newData = [], filteredData = [], filter = mail && this.chatInfo[mail].members, membersData = mail && this.chatInfo[mail].membersData || [];
      if(filter) {
        var mails = {};
        U.Array.each(filter, function(it, i) {
          if(membersData[i] && membersData[i].email === it) {
            mails[it] = [it, membersData[i].friendly || membersData[i].nickname, 1]
          }else {
            mails[it] = [it, null, 1]
          }
        });
        var filterF = function(item) {
          if(mails[item[0]]) {
            delete mails[item[0]];
            return true
          }else {
            return false
          }
        }
      }
      U.Array.each(this.data, function(item) {
        if(!WA.MainAgent.isChat(item[0]) && !WA.MainAgent.isTel(item[0])) {
          if(filter) {
            if(filterF(item)) {
              newData.push(item)
            }else {
              if(!item[2]) {
                filteredData.push(item)
              }
            }
          }else {
            if(!item[2]) {
              newData.push(item)
            }
          }
        }
      }, this);
      if(!rev) {
        U.Object.each(mails, function(it, key) {
          if(WA.ACTIVE_MAIL != key) {
            newData.push(it)
          }else {
            this.__addSelfToMailList(newData, key)
          }
        }, this)
      }
      cb.call(scope || window, filter && rev ? filteredData : newData)
    }else {
      this._clistReceivedEvent.on(function() {
        this.getParticipantsList(cb, scope, mail, rev)
      }, this, {single:true});
      if(!this.requestParams) {
        this.getRange(0, 0)
      }
      this._getListFromServer()
    }
  }, updateChatMembers:function(data) {
    if(!data) {
      return this.chatInfo = {}
    }
    if(this.chatInfo[data.mail]) {
      var ind, members = this.chatInfo[data.mail].members, membersData = this.chatInfo[data.mail].membersData, added = data.type == "add";
      if(members && data.members && !added) {
        U.Array.each(data.members, function(it) {
          ind = U.Array.indexOf(members, it);
          if(ind !== -1) {
            if(membersData && membersData[ind] && membersData[ind].email === members[ind]) {
              this.chatInfo[data.mail].membersData.splice(ind, 1)
            }
            members.splice(ind, 1)
          }
        }, this)
      }else {
        delete this.chatInfo[data.mail]
      }
    }
  }, getContactsInfo:function(maillist, cb, scope, raw) {
    raw = raw || false;
    WA.log("###getContactsInfo", maillist, this._isFullData());
    if(this._isReady()) {
      var contacts = [];
      U.Array.each(this.data, function(entry) {
        var index = U.Array.indexOf(maillist, entry[0]);
        if(index != -1) {
          if(!raw) {
            contacts.push([entry[0], entry[1], WA.MainAgent.getGeneralContactStatus(entry), entry[4] || entry[3], entry[7] || 0])
          }else {
            contacts.push(entry[0])
          }
        }
      });
      cb.call(scope || window, contacts)
    }else {
      this._clistReceivedEvent.on(function() {
        this.getContactsInfo(maillist, cb, scope)
      }, this, {single:true});
      if(!this.requestParams) {
        this.getRange(0, 0)
      }
      this._getListFromServer()
    }
  }, getContactsInfoByNum:function(numlist, cb, scope) {
    if(this._isFullData()) {
      var newData = [], data = this._sortContactList(this.data);
      U.Array.each(numlist, function(num) {
        num = data[num];
        newData.push(num && [num[0], num[1], WA.MainAgent.getGeneralContactStatus(num), num[4] || num[3], num[7] || 0])
      }, this);
      cb.call(scope || window, newData)
    }else {
      this._clistReceivedEvent.on(function() {
        this.getContactsInfoByNum(numlist, cb, scope)
      }, this, {single:true});
      if(!this.requestParams) {
        this.getRange(0, 0)
      }
      this._getListFromServer()
    }
  }, search:function(query) {
    if(this._isFullData()) {
      var MAX = 9;
      var filteredData = [];
      var q = (query || "").toLowerCase();
      var alterQuery = WA.util.KeyMapping.translate(q);
      var data = RemoteData.superclass._sortContactList.call(this, this.data);
      var searchCache = {};
      U.Array.each(data, function(entry) {
        if(filteredData.length >= MAX) {
          return false
        }
        var mail = entry[0].toLowerCase();
        var nick = (entry[1] || "").toLowerCase();
        if(nick != mail && (nick.indexOf(q) != -1 || nick.indexOf(alterQuery) != -1)) {
          searchCache[mail] = 1;
          filteredData.push(entry)
        }
      });
      U.Array.each(data, function(entry) {
        if(filteredData.length >= MAX) {
          return false
        }
        var mail = entry[0].toLowerCase();
        if(!searchCache[mail] && (mail.indexOf(q) != -1 || mail.indexOf(alterQuery) != -1)) {
          filteredData.push(entry)
        }
      });
      this.searchReadyEvent.fire(filteredData, query)
    }else {
      this.__searchQuery = query;
      this._getListFromServer()
    }
  }, searchConfParty:function(query, mail, rev) {
    if(mail && !this.chatInfo[mail]) {
      this._getChatMembers(mail)
    }
    if(this._isFullData()) {
      if(mail && !this.chatInfo[mail]) {
        return this._getChatMembers(mail, function() {
          this.searchConfParty(query, mail, rev)
        }, this)
      }
      var newData = [], filteredData = [], filter = mail && this.chatInfo[mail].members, membersData = mail && this.chatInfo[mail].membersData || [];
      if(filter) {
        var mails = {};
        U.Array.each(filter, function(it, i) {
          if(membersData[i]) {
            mails[it] = [it, membersData[i].friendly || membersData[i].nickname, 1]
          }else {
            mails[it] = [it, null, 1]
          }
        });
        var filterF = function(item) {
          if(mails[item[0]]) {
            delete mails[item[0]];
            return true
          }else {
            return false
          }
        }
      }
      var MAX = 9;
      var q = (query || "").toLowerCase();
      var alterQuery = WA.util.KeyMapping.translate(q);
      U.Array.each(this.data, function(entry) {
        if(MAX > 0 && (rev ? filteredData : newData).length === MAX) {
          return false
        }
        if(WA.MainAgent.isChat(entry[0]) || WA.MainAgent.isTel(entry[0])) {
          return
        }
        var mail = entry[0].toLowerCase();
        var nick = (entry[1] || "").toLowerCase();
        if(mail.indexOf(q) != -1 || nick.indexOf(q) != -1 || mail.indexOf(alterQuery) != -1 || nick.indexOf(alterQuery) != -1) {
          if(filter) {
            if(filterF(entry)) {
              newData.push(entry)
            }else {
              if(!entry[2]) {
                filteredData.push(entry)
              }
            }
          }else {
            if(!entry[2]) {
              newData.push(entry)
            }
          }
        }
      });
      if(newData.length !== MAX && !rev) {
        U.Object.each(mails, function(it, key) {
          if(MAX > 0 && newData.length === MAX) {
            return
          }
          var mail = it[0].toLowerCase();
          var nick = (it[1] || "").toLowerCase();
          if(mail.indexOf(q) != -1 || nick.indexOf(q) != -1 || mail.indexOf(alterQuery) != -1 || nick.indexOf(alterQuery) != -1) {
            if(WA.ACTIVE_MAIL == key) {
              this.__addSelfToMailList(newData, key)
            }else {
              newData.push(it)
            }
          }
        }, this)
      }
      this.searchConfPartyReadyEvent.fire(this, {data:rev ? filteredData : newData, query:query})
    }else {
      this._getListFromServer()
    }
  }, searchPhonebook:function(query) {
    if(this._isFullData()) {
      var MAX = 10;
      var filteredData = [], pItem;
      var q = (query || "").toLowerCase();
      var queryTel = q.replace(/\+/g, "");
      if(queryTel.match(/\D+/g) != null) {
        queryTel = ""
      }
      var alterQuery = WA.util.KeyMapping.translate(q);
      U.Array.each(this.data, function(item) {
        if(filteredData.length >= MAX) {
          return false
        }
        var nick = (item[1] || item[0] || "").toLowerCase();
        var phones = item[5];
        if(phones && phones.length) {
          if(nick.indexOf(q) != -1 || nick.indexOf(alterQuery) != -1) {
            U.Array.each(phones, function(tel) {
              pItem = U.Array.clone(item);
              pItem[5] = [tel];
              filteredData.push(pItem)
            }, this)
          }else {
            if(queryTel.length) {
              U.Array.each(phones, function(tel) {
                var trimtel = tel.replace(/\D+/g, "");
                if(trimtel.indexOf(queryTel) != -1) {
                  pItem = U.Array.clone(item);
                  pItem[5] = [tel];
                  filteredData.push(pItem)
                }
              }, this)
            }
          }
        }
      }, this);
      filteredData = filteredData.slice(0, MAX);
      this.searchPhonebookReadyEvent.fire(this, {data:filteredData, query:query})
    }
  }, searchPhone:function(query) {
    if(this._isFullData()) {
      var MAX = 8;
      var filteredData = [];
      var q = query || "";
      U.Array.each(this.data, function(item) {
        if(filteredData.length >= MAX) {
          return false
        }
        var phones = item[5];
        if(phones && phones.length) {
          U.Array.each(phones, function(tel) {
            var trimtel = tel.replace(/\D+/g, "");
            if(trimtel.indexOf(q) != -1) {
              var pItem = U.Array.clone(item);
              pItem[5] = [tel];
              filteredData.push(pItem)
            }
          }, this)
        }
      }, this);
      filteredData = filteredData.slice(0, MAX);
      this.searchPhoneReadyEvent.fire(this, {data:filteredData, query:query})
    }else {
      this.__searchPhone = query;
      this._getListFromServer()
    }
  }, cancelSearch:function() {
    this.__searchQuery = null;
    this.__searchPhone = null
  }, setOfflineContactsVisibility:function(canShow) {
    if(this.canShowOffline !== canShow) {
      this.canShowOffline = canShow;
      if(this._isReady()) {
        this._initVisibleData(this.data, this.fullLength)
      }
    }
  }, reloadList:function() {
    if(this._isReady()) {
      this._initVisibleData(this.data, this.fullLength)
    }
  }, destroy:function() {
    WA.error("It is horrible!")
  }});
  var SearchData = WA.extend(AbstractData, {_onDeactivate:function() {
    SearchData.superclass._onDeactivate.call(this);
    this.cancelSearch()
  }, setData:function(data, query) {
    this.data = data;
    this.__searchQuery = query;
    this.getRange(0, this.data.length)
  }, _onGetRange:function() {
    this._initVisibleData(this.data, this.data.length)
  }, _fireLoadEvent:function(data, length) {
    if(this.__searchQuery) {
      return SearchData.superclass._fireLoadEvent.call(this, {query:this.__searchQuery, data:data}, length)
    }
  }, cancelSearch:function() {
    this.data = null;
    this.__searchQuery = null
  }});
  var CLData = WA.CLD = new ContactListData;
  WA.ContactListAbstraction = WA.extend(WA.Activatable, {constructor:function() {
    this.loadEvent = new U.Event;
    this.countEvent = new U.Event;
    this.remoteData = new RemoteData;
    this.remoteData.loadEvent.on(this._onRemoteDataLoad, this);
    this.remoteData.searchReadyEvent.on(this._onSearchReady, this);
    this.contactDataReceivedEvent = (new U.Event).relay(this.remoteData._clistReceivedEvent);
    this.searchData = new SearchData;
    this.searchReadyEvent = (new U.Event).relay(this.searchData.loadEvent);
    this.searchPhoneReadyEvent = (new U.Event).relay(this.remoteData.searchPhoneReadyEvent);
    this.searchPhonebookReadyEvent = (new U.Event).relay(this.remoteData.searchPhonebookReadyEvent);
    this.searchConfPartyReadyEvent = (new U.Event).relay(this.remoteData.searchConfPartyReadyEvent);
    this.sync = WA.Synchronizer.registerComponent("clist_abstr", ["activity"]);
    this.sync.triggerEvent.on(this._onSyncTriggerEvent, this);
    WA.ConnectionFacade.triggerEvent.on(this._onConnectionTriggerEvent, this);
    this.limitRateReloadList = limitRate(function() {
      this.reloadList()
    }, 1500, this)
  }, _onActivate:function() {
    this.loadEvent.resume();
    this.countEvent.resume();
    this.searchReadyEvent.resume();
    if(typeof this.__onlineCount__ != "undefined") {
      this.countEvent.fire(this.__onlineCount__, this.__totalCount__);
      delete this.__onlineCount__;
      delete this.__totalCount__
    }
    this.remoteData.activate();
    this.searchData.activate()
  }, _onDeactivate:function() {
    this.loadEvent.suspend();
    this.countEvent.suspend();
    this.searchReadyEvent.suspend();
    this.remoteData.deactivate();
    this.searchData.deactivate()
  }, _onSyncTriggerEvent:function(syncRecord) {
  }, _onSyncActivity:function() {
    this.reloadList()
  }, _onRemoteDataLoad:function(ignored, data, length) {
    this.loadEvent.fire(data, length, this.remoteData.fullLength)
  }, _onConnectionTriggerEvent:function(type, value) {
    if(!this.isActive()) {
      if(type === "contactListState") {
        this.__onlineCount__ = parseInt(value.onlineCount);
        this.__totalCount__ = parseInt(value.totalCount)
      }
      return
    }
    if(type === "contactListState") {
      this.countEvent.fire(parseInt(value.onlineCount), parseInt(value.totalCount))
    }
    if(type === "contactStatus") {
      if(value.persons) {
        var needUpdate;
        U.Array.each(value.persons, function(p) {
          if(!p.friendly) {
            return
          }
          if(CLData.saveFriendly(p.sn, p.friendly)) {
            needUpdate = true
          }
        })
      }
      value.status && this.remoteData.activityManager.updateContactStatus(value)
    }
    if(type === "contactAddSuccess") {
      if(WA.MainAgent.isChat(value.email)) {
        this.addContact(value.email, value.nickname)
      }
    }
  }, updateActivity:function(contact) {
  }, updateUnreadContact:function(contact, type) {
  }, getList:function(from, to) {
    this.remoteData.getRange(from, to)
  }, _onSearchReady:function(data, query) {
    this.searchData.setData(data, query)
  }, search:function(query) {
    if(query) {
      this.remoteData.search(query)
    }
  }, searchPhone:function(query) {
    if(query) {
      this.remoteData.searchPhone(query)
    }
  }, searchPhonebook:function(query) {
    if(query) {
      this.remoteData.searchPhonebook(query)
    }
  }, searchConfParty:function(query, filter, rev) {
    if(query) {
      this.remoteData.searchConfParty(query, filter, rev)
    }
  }, cancelSearch:function() {
    this.remoteData.cancelSearch();
    this.searchData.cancelSearch()
  }, setOfflineContactsVisibility:function(canShow) {
    this.remoteData.setOfflineContactsVisibility(canShow)
  }, reloadList:function() {
    this.remoteData.reloadList()
  }, removeContact:function(email, callback) {
    callback = callback || {};
    var cb = function(success, response) {
      if(success) {
        WA.ChangeLog.logAction("remove", {email:email});
        if(WA.isFunction(callback.success)) {
          callback.success.call(callback.scope || this, email, response)
        }
      }else {
        if(WA.isFunction(callback.failure)) {
          callback.failure.call(callback.scope || this, email, response)
        }
      }
    };
    if(WA.MainAgent.isChat(email)) {
      U.Mnt.countRB(3828474)
    }
    WA.IcqApi.removeContact({email:email}, cb, this)
  }, renameContact:function(email, newNick, callback) {
    callback = callback || {};
    var cb = function(success, response) {
      if(success) {
        WA.ChangeLog.logAction("rename", {email:email, nickname:newNick});
        if(WA.isFunction(callback.success)) {
          callback.success.call(callback.scope || this, email, response)
        }
      }else {
        if(WA.isFunction(callback.failure)) {
          callback.failure.call(callback.scope || this, email, response)
        }
      }
    };
    if(WA.MainAgent.isChat(email)) {
      WA.IcqRapi.modifyChat({email:email, name:newNick}, cb, this)
    }else {
      WA.IcqApi.modifyContact({email:email, nickname:newNick}, cb, this)
    }
  }, updateSelfContactData:function(data) {
    this.remoteData.selfContactData = U.Object.extend(this.remoteData.selfContactData, data);
    data.nick && CLData.saveFriendly(WA.ACTIVE_MAIL, data.nick)
  }, addContact:function(email, nick, tel, chat) {
    var contact = {email:email, nickname:nick};
    if(tel) {
      contact.tel = tel
    }
    if(chat) {
      this.remoteData.chatInfo[email] = chat
    }
    WA.ChangeLog.logAction("add", contact)
  }, getContactsInfo:function(maillist, cb, scope, raw) {
    this.remoteData.getContactsInfo(maillist, cb, scope, raw)
  }, getContactsInfoByNum:function(numlist, cb, scope) {
    this.remoteData.getContactsInfoByNum(numlist, cb, scope)
  }, getPhoneList:function(cb, scope) {
    this.remoteData.getPhoneList(cb, scope)
  }, getParticipantsList:function(cb, scope, filter, rev) {
    this.remoteData.getParticipantsList(cb, scope, filter, rev)
  }, updateChatMembers:function(data) {
    this.remoteData.updateChatMembers(data)
  }});
  WA.ContactListAbstraction.ACTIVE_CONTACTS_MAX_LEGTH = ACTIVE_CONTACTS_MAX_LEGTH
})();
(function() {
  var WA = WebAgent;
  var U = WA.util;
  var DH = U.DomHelper;
  var LINE_HEIGHT = 25;
  var CONTACT_STATE_STATUS_MAP = {};
  CONTACT_STATE_STATUS_MAP[WA.ContactStates.TYPING_STATE] = "typing";
  CONTACT_STATE_STATUS_MAP[WA.ContactStates.MESSAGE_STATE] = "message";
  WA.ContactListAgent = WA.Activatable.extend(WA.ui.Component, {initComponent:function() {
    WA.ContactListAgent.superclass.initComponent.call(this);
    this.contactSelectEvent = new U.Event;
    this.playSoundEvent = new U.Event;
    this.statusAlertsOptionEvent = new U.Event;
    this.previewsToggleOptionEvent = new U.Event;
    this.popupChangeVisibleEvent = new U.Event;
    this.statusMenuToggleEvent = new U.Event;
    this.subDialogOpenEvent = new U.Event;
    this.closeDialogEvent = new U.Event;
    this.abstraction = new WA.ContactListAbstraction;
    this.abstraction.loadEvent.on(this._renderList, this);
    this.contactDataReceivedEvent = (new U.Event).relay(this.abstraction.contactDataReceivedEvent);
    this.abstraction.countEvent.on(this._onCountEvent, this);
    this.addContactDialog = new WA.AddSearchDialog;
    this.addContactDialog.addSuccessEvent.on(this.abstraction.addContact, this.abstraction);
    this.addContactDialog.openContactEvent.on(this._openContact, this);
    this.addContactDialog.contactInfoRequestEvent.on(this.abstraction.getContactsInfo, this.abstraction);
    this.addContactDialog.hideEvent.on(function() {
      this.btnAddContact.setState(false)
    }, this);
    this.subDialogOpenEvent.relay(this.addContactDialog.showEvent);
    this.createChatDialog = new WA.CreateConference(this.abstraction);
    this.createChatDialog.hideEvent.on(function() {
      this.btnCreateChat.setState(false)
    }, this);
    this.createChatDialog.addContactEvent.on(this.abstraction.addContact, this.abstraction);
    this.createChatDialog.openContactEvent.on(this._openContact, this);
    this.createChatDialog.abstraction.addContactFromConf.on(this.addContactDialog.addNewContact, this.addContactDialog);
    this.subDialogOpenEvent.relay(this.createChatDialog.showEvent);
    this.visible = false;
    this.searchMode = false;
    this.soundOff = false;
    this.showOffline = false;
    this.statusAlertsOff = true;
    this.showAvatars = false;
    this.hideActiveDialogs = false;
    this.hidePreviews = false;
    this.totalCount = null;
    this.sync = WA.Synchronizer.registerComponent("clist_agent", ["hide_offline", "play_sound", "show_avatars", "hide_previews", "hide_active_dialogs", "status_alerts_off"], false);
    this.sync.triggerEvent.on(this._onSyncTriggerEvent, this);
    this.offsetChecker = new U.DelayedTask({interval:50, fn:function() {
      this._checkOffset();
      this.offsetChecker.start()
    }, scope:this});
    this.searchField = new WA.ContactListAgent.SearchField(this.abstraction, {cls:"nwa-search__field", placeholder:WA.tr("cl.searchContacts")});
    this.searchField.selectEvent.on(this._openContact, this);
    this.searchField.searchStartEvent.on(this._onSearchStart, this);
    this.searchField.searchEndEvent.on(this._onSearchEnd, this);
    this.searchField.setShowAvatars(this.showAvatars);
    WA.Invalidator.invalidateEvent.on(this._onInvalidate, this);
    this.onlineConfirmSuccessEvent = new U.Event;
    this.onlineConfirmDeclineEvent = new U.Event
  }, _onSearchStart:function() {
    this.spacerEl.hide();
    this.clistEl.addClass("nwa-clist_search_mode");
    this.scrollBar.setSource(this.searchField.searchResults.getEl());
    this.searchMode = true
  }, _onSearchEnd:function() {
    this.clistEl.removeClass("nwa-clist_search_mode");
    this.spacerEl.show();
    this.scrollBar.setSource(this.clistEl);
    this.searchMode = false
  }, _onCountEvent:function(onlineCount, totalCount) {
    this.totalCount = totalCount;
    if(this.__waitForTotalCount === true) {
      var val = totalCount >= 80;
      this.sync.write("status_alerts_off", val ? "1" : "0");
      delete this.__waitForTotalCount;
      this._setStatusAlertsVisibility(val)
    }
  }, _onRender:function(ct) {
    var mail = WA.ACTIVE_MAIL;
    this.el = ct.createChild({tag:"div", cls:"nwa-agent", children:[{tag:"div", cls:"nwa-agent__shadow", children:[{tag:"div", id:"nwaHeader", cls:"nwa-header", children:[{tag:"div", cls:"nwa-header__avatar"}, {tag:"div", cls:"nwa-header__mini", title:WA.tr("cl.hide")}, {tag:"div", cls:"nwa-header__popup", title:WA.isPopup ? WA.tr("cl.closePopup") : WA.tr("cl.openPopup")}]}, {tag:"div", cls:"nwa-search", children:[{tag:"div", id:"nwaSearch", cls:"nwa-search__wrap"}]}, {tag:"div", id:"nwaClist", cls:"nwa-clist", 
    children:[{tag:"div", id:"nwaClistWrap", cls:"nwa-clist__wrap"}, {id:"nwaClistTeaser", cls:"nwa-teaser"}]}, {tag:"div", id:"nwaToolbar", cls:"nwa-toolbar"}]}]});
    var buttonsCt = WA.get("nwaToolbar");
    var headerCont = WA.get("nwaHeader");
    this.btnAddContact = new WA.ui.ToggleButton({cls:"nwa-toolbar__add-contact", handler:this._onAddContactClick, stateHandler:function() {
      return false
    }, scope:this, text:"<span>&nbsp;</span>"});
    this.btnAddContact.render(buttonsCt);
    this.btnCreateChat = new WA.ui.ToggleButton({cls:"nwa-toolbar__create-chat", handler:this._onCreateChatClick, stateHandler:function() {
      return false
    }, scope:this, text:"<span>&nbsp;</span>"});
    this.btnCreateChat.render(buttonsCt);
    this.spacerEl = WA.get("nwaClistWrap");
    this.clistEl = WA.get("nwaClist");
    this.teaserEl = WA.get("nwaClistTeaser");
    this.teaserEl.on("click", this._onTeaserClick, this);
    this.clistEl.toggleClass("nwa-cl_avatars", this.showAvatars);
    this.scrollBar = new WA.ui.ScrollBar({source:this.clistEl, watchResize:WA.isPopup});
    this.scrollBar.render(this.el.first());
    this.spacerEl.on("click", this._onContactClick, this);
    this.searchField.render(WA.get("nwaSearch"));
    this.searchField.resultTo(this.clistEl);
    var items = [{text:WA.tr("cl.optOnlineContacts"), id:"optOffline", iconCls:"nwa-toolbar__options-menu__offline", handler:this._onToggleOfflineClick, scope:this}, {text:WA.tr("cl.optStatusesOff"), id:"optStatusAlerts", iconCls:"nwa-toolbar__options-menu__statuses wa-statuses-alerts-off", handler:this._onToggleStatusAlertsClick, scope:this}, {id:"optSound", text:WA.tr("cl.optSoundOff"), iconCls:"nwa-toolbar__options-menu__sound", handler:this._onToggleSoundClick, scope:this}, {id:"optSettings", 
    text:WA.tr("cl.optSettings"), iconCls:"nwa-toolbar__options-menu__settings", handler:function() {
      window.open("//e.mail.ru/settings/agent")
    }, scope:this}, {id:"optAvatars", text:WA.tr("cl.optAvatarsOn"), iconCls:"nwa-toolbar__options-menu__avatars", handler:this._onToggleAvatarsClick, scope:this}, {id:"optActiveDialogs", text:"ÐÐºÐ»ÑÑÐ¸ÑÑ Ð°ÐºÑÐ¸Ð²Ð½ÑÐµ Ð´Ð¸Ð°Ð»Ð¾Ð³Ð¸", iconCls:"nwa-toolbar__options-menu__active-dialogs", handler:this._onToggleActiveDialogsClick, scope:this}, {id:"optPreviews", text:"Ð¡ÐºÑÑÑÑ ÐºÐ°ÑÑÐ¸Ð½ÐºÐ¸ Ð² Ð´Ð¸Ð°Ð»Ð¾Ð³Ð°Ñ", iconCls:"nwa-toolbar__options-menu__previews", handler:this._onTogglePreviewsClick, scope:this}];
    var localStorage_waUseBranch = false;
    try {
      localStorage_waUseBranch = window.localStorage && localStorage.waUseBranch
    }catch(ex) {
    }
    if(localStorage_waUseBranch) {
      items.push({text:WA.tr("cl.turnOff") + " " + localStorage_waUseBranch, handler:function() {
        localStorage.waUseBranch = "";
        document.location = ("" + document.location).replace(/\bwa_use_branch=[^&]+&?/, "")
      }})
    }
    var optionsMenu = this.optionsMenu = new WA.ui.menu.Menu({cls:"nwa-toolbar__options-menu", fadeIn:true, items:items});
    optionsMenu.showEvent.on(function() {
      WA.get("optOffline").last().update(this.showOffline ? WA.tr("cl.optOnlineContacts") : WA.tr("cl.optAllContacts"));
      WA.get("optOffline").toggleClass("wa-show-offline-contacts", this.showOffline);
      WA.get("optSound").last().update(this.soundOff ? WA.tr("cl.optSoundOff") : WA.tr("cl.optSoundOn"));
      WA.get("optSound").toggleClass("wa-no-play-sound", this.soundOff);
      WA.get("optAvatars").last().update(this.showAvatars ? WA.tr("cl.optAvatarsOff") : WA.tr("cl.optAvatarsOn"));
      WA.get("optPreviews").last().update(this.hidePreviews ? WA.tr("cl.optPreviewsShow") : WA.tr("cl.optPreviewsHide"));
      WA.get("optActiveDialogs").last().update(!this.hideActiveDialogs ? WA.tr("cl.optHideActiveDialogs") : WA.tr("cl.optShowActiveDialogs"));
      WA.get("optActiveDialogs").toggleClass("wa-show-active-dialogs-off", this.hideActiveDialogs);
      WA.get("optStatusAlerts").last().update(this.statusAlertsOff ? WA.tr("cl.optStatusesOn") : WA.tr("cl.optStatusesOff"));
      WA.get("optStatusAlerts").toggleClass("wa-statuses-alerts-off", !this.statusAlertsOff);
      this.openOptionsBtn.setState(true)
    }, this);
    optionsMenu.hideEvent.on(function() {
      this.openOptionsBtn.setState(false)
    }, this);
    this.openOptionsBtn = new WA.ui.ToggleButton({cls:"nwa-toolbar__options", menu:optionsMenu, tooltip:WA.tr("cl.options"), text:"<span>&nbsp;</span>"});
    this.openOptionsBtn.render(buttonsCt);
    this._nameBox = new WA.ui.NameBox;
    this._nameBox.render(headerCont);
    this._nameBox.setName(WA.ACTIVE_MAIL);
    WA.Ava.makeDefault(WA.ACTIVE_MAIL, 64, this._nameBox.el.parent().first());
    this.statusToggleBtn = new WA.ui.Button({cls:"nwa-toolbar__status", scope:this, text:'<span class="nwa-button__l"></span><span class="nwa-button__r"></span><span class="nwa-button__fadeout"></span>', handler:function() {
      this.statusMenuToggleEvent.fire()
    }});
    this.statusToggleBtn.render(buttonsCt);
    headerCont.on("click", this._onHeaderClick, this);
    this.el.on("DOMMouseScroll", function(e) {
      e.stopEvent()
    })
  }, getContactsInfo:function(maillist, cb, scope, raw) {
    this.abstraction.getContactsInfo(maillist, cb, scope, raw)
  }, setSelfNick:function(nick) {
    this._nameBox.setName(nick);
    this.abstraction.updateSelfContactData({nick:nick});
    var avaEl = this._nameBox.el.parent().first();
    var avatar = WA.makeAvatar(WA.ACTIVE_MAIL, WA.DialogsAbstraction.nick, "_avatar32");
    avaEl.addClass(avatar.className);
    avaEl.setStyle("background-image", "url(" + avatar.url + ")")
  }, setStatus:function(status) {
    var statusTitle = WA.MainAgent.statuses[status];
    this.statusToggleBtn.el.first().dom.className = WA.Statuses.buildCssClass(status);
    this.statusToggleBtn.el.first().next().update(U.String.htmlEntity(statusTitle));
    this.abstraction.updateSelfContactData({status:status, statusTitle:statusTitle})
  }, _onAfterRender:function() {
    this._onlineConfirmDialog = new WA.DialogsAgent.RemoveContactDialog({title:WA.tr("box.goOnline"), okButton:WA.tr("box.ok_yes"), autoRender:this.el});
    var wasOk;
    this._onlineConfirmDialog.showEvent.on(function() {
      wasOk = false
    }, this);
    this._onlineConfirmDialog.hideEvent.on(function() {
      this.deactivate();
      if(!wasOk) {
        U.Mnt.countRB(1313952);
        this.onlineConfirmDeclineEvent.fire()
      }
    }, this);
    this._onlineConfirmDialog.okEvent.on(function() {
      wasOk = true;
      U.Mnt.countRB(1313951);
      this.onlineConfirmSuccessEvent.fire()
    }, this);
    this.sync.whenReady(function() {
      this.sync.read(this._onSyncTriggerEvent, this)
    }, this)
  }, _onHeaderClick:function(e) {
    var trg = e.getTarget(true);
    if(trg.hasClass("nwa-header__popup")) {
      this.popupChangeVisibleEvent.fire();
      return
    }
    if(trg.hasClass("nwa-header__avatar") && e.ctrlKey && this.searchField && String.fromCharCode(103, 105, 109, 109, 101, 33, 106, 111, 121) == this.searchField.val()) {
      this.el.parent().addClass("nwa-agent_dyn");
      return
    }
    if(trg.up("nwa-header__msg")) {
      return
    }
    this.setVisible(WA.isPopup)
  }, _onContactClick:function(e) {
    var el = e.getTarget(true);
    var removeFromActive = el.hasClass("nwa-cl-contact-unrecent-button");
    var mail = el.getAttribute("mail");
    if(!mail) {
      el = el.parent();
      mail = el.getAttribute("mail")
    }
    if(mail) {
      if(removeFromActive) {
        this.closeDialogEvent.fire(mail);
        return
      }
      var status = el.getAttribute("status");
      var statusTitle = el.getAttribute("title");
      var nick = el.getAttribute("nick");
      var features = parseInt(el.getAttribute("features"));
      var phones = el.getAttribute("phones").split(",");
      phones = phones.length && phones[0] ? phones : null;
      this._openContact(mail, nick, false, status, statusTitle, features, phones)
    }
  }, _openContact:function(mail, nick, openSms, status, statusTitle, features, phones) {
    if(openSms) {
    }else {
      this.contactSelectEvent.fire(mail, nick || mail, status, statusTitle, features, phones)
    }
  }, _onToggleStatusAlertsClick:function(button) {
    delete this.__waitForTotalCount;
    var val = !this.statusAlertsOff;
    if(val) {
      U.Mnt.countRB(1732280)
    }
    this.sync.write("status_alerts_off", val ? "1" : "0");
    this._setStatusAlertsVisibility(val)
  }, _setStatusAlertsVisibility:function(val) {
    this.statusAlertsOptionEvent.fire(val);
    this.statusAlertsOff = val
  }, _onToggleOfflineClick:function(button) {
    var canShow = !this.showOffline;
    this.sync.write("hide_offline", canShow ? "" : "1");
    this._setOfflineContactsVisibility(canShow)
  }, _setOfflineContactsVisibility:function(canShow) {
    this.abstraction.setOfflineContactsVisibility(canShow);
    this.showOffline = canShow
  }, _onToggleSoundClick:function(button) {
    var canPlay = !this.soundOff;
    this.sync.write("play_sound", canPlay ? "" : "1");
    this._setSoundPlayToggle(canPlay)
  }, _setSoundPlayToggle:function(canPlay) {
    this.playSoundEvent.fire(canPlay);
    this.soundOff = canPlay
  }, _onToggleActiveDialogsClick:function(button) {
    var val = !this.hideActiveDialogs;
    this.sync.write("hide_active_dialogs", val ? "1" : "");
    this._toggleActiveDialogs(val)
  }, _toggleActiveDialogs:function(val) {
    this.hideActiveDialogs = val;
    this.abstraction.remoteData.hideActiveDialogs = val;
    this.abstraction.reloadList()
  }, _onToggleAvatarsClick:function(button) {
    var val = !this.showAvatars;
    this.sync.write("show_avatars", val ? "1" : "");
    this._toggleAvatars(val)
  }, _toggleAvatars:function(force) {
    this.showAvatars = force;
    this.searchField.setShowAvatars(this.showAvatars);
    this.createChatDialog.setShowAvatars(this.showAvatars);
    this.clistEl.toggleClass("nwa-cl_avatars", force);
    this.abstraction.reloadList()
  }, _onTogglePreviewsClick:function(button) {
    var val = !this.hidePreviews;
    this.sync.write("hide_previews", val ? "1" : "");
    this._togglePreviews(val)
  }, _togglePreviews:function(val) {
    this.previewsToggleOptionEvent.fire(val);
    this.hidePreviews = val
  }, _onSyncTriggerEvent:function(syncRecord) {
    var val;
    if(syncRecord.isChanged("status_alerts_off")) {
      var valInit = syncRecord.get("status_alerts_off");
      if(!WA.isString(valInit)) {
        valInit = ""
      }
      if(valInit === "") {
        if(this.totalCount === null) {
          this.__waitForTotalCount = true;
          val = true
        }else {
          val = this.totalCount >= 80;
          this.sync.write("status_alerts_off", val ? "1" : "0")
        }
      }else {
        val = valInit === "1"
      }
      this._setStatusAlertsVisibility(val)
    }
    if(syncRecord.isChanged("hide_offline")) {
      var hideOffline = syncRecord.get("hide_offline") === "1";
      this._setOfflineContactsVisibility(!hideOffline)
    }
    if(syncRecord.isChanged("play_sound")) {
      var playSound = syncRecord.get("play_sound") === "1";
      this._setSoundPlayToggle(!playSound)
    }
    if(syncRecord.isChanged("show_avatars")) {
      val = syncRecord.get("show_avatars") === "1";
      this._toggleAvatars(val)
    }
    if(syncRecord.isChanged("hide_active_dialogs")) {
      val = syncRecord.get("hide_active_dialogs") === "1";
      this._toggleActiveDialogs(val)
    }
    if(syncRecord.isChanged("hide_previews")) {
      val = syncRecord.get("hide_previews") === "1";
      this._togglePreviews(val)
    }
  }, _checkOffset:function() {
    var top = this.clistEl.dom.scrollTop;
    var height = this.clistEl.dom.parentNode.scrollHeight;
    if(height != this._height || top != this._top) {
      var changed = false;
      if(WA.resizeableLayout && height != this._height) {
        this._height = height;
        this._blockSize = Math.ceil(height / LINE_HEIGHT);
        this._blockHeight = this._blockSize * LINE_HEIGHT;
        changed = true
      }
      if(top !== this._top) {
        this._top = top
      }
      var bottom = top + height;
      var from = Math.ceil(bottom / this._blockHeight) - 1;
      var to = from + 2;
      if(from != 0) {
        from--
      }
      if(this._from != from || this._to != to) {
        this._from = from;
        this._to = to;
        changed = true
      }
      if(changed) {
        this._contactsOffset = from * this._blockHeight;
        this.abstraction.getList(from * this._blockSize, to * this._blockSize)
      }
    }
  }, _getContactState:function(contact, defStatus) {
    var email = contact[0];
    var states = WA.ContactStates.getStates(email);
    if(states && states.length > 0) {
      var lastState = states[states.length - 1];
      var ret = CONTACT_STATE_STATUS_MAP[lastState];
      if(ret) {
        return ret
      }
    }
    return defStatus
  }, __getContactUnread:function(contact) {
    var unread = WA.ContactStates.getUnread(contact[0]);
    return unread || 0
  }, _describeContact:function(contact, i, offset, isActive) {
    offset = this._contactsOffset + i * LINE_HEIGHT + offset * LINE_HEIGHT;
    var email = contact[0];
    var status = WA.MainAgent.getGeneralContactStatus(contact);
    var statusTitle = contact[4];
    if(!statusTitle) {
      statusTitle = status.replace(/^icq_/, "");
      var lastSeen = contact[6];
      var lastSeenDate = lastSeen && new Date(lastSeen * 1E3);
      if(lastSeenDate && U.Date.getElapsed(lastSeenDate) / 1E3 < U.Date.DAY) {
        statusTitle = U.Date.formatLastSeenData(lastSeen)
      }
    }
    statusTitle = WA.MainAgent.statuses[statusTitle] || statusTitle;
    var statusClass = WA.Statuses.buildCssClass(this._getContactState(contact, status), WA.isUIN(email));
    var nick = contact[1] || email;
    var emailTitle = status == "chat" || status == "tel" ? statusTitle : email.replace("@uin.icq", "");
    var unread = this.__getContactUnread(contact);
    var haveTel = WA.isArray(contact[5]) && contact[5].length && contact[5][0];
    var avatar = WA.makeAvatar(email, contact[1], "_avatar22");
    var userpic = this.showAvatars ? "background-image: url(" + avatar.url + ");" : "";
    var avatarClass = this.showAvatars ? avatar.className : "";
    var features = contact[7] || 0;
    var phones = haveTel && contact[5] && contact[5].join(",") || "";
    return[offset, DH.htmlEntities(status), email, DH.htmlEntities(nick), this._generateItemId(email), DH.htmlEntities(statusTitle), DH.htmlEntities(emailTitle), statusClass, unread > 999 ? "999+" : unread, unread > 0 ? " nwa-cl-contact_unread" : "", userpic, avatarClass, isActive ? " nwa-cl-contact-active" : "", features, phones, DH.htmlEntities(contact[8])]
  }, _contactTmpl:['<div style="top: {0}px" class="nwa-cl-contact{9}{12}" status="{1}" mail="{2}" id="{4}" nick="{3}" title="{5}" features="{13}" phones="{14}">', '<span class="nwa-cl-contact-avatar {11}" title="{6}" style="{10}"></span>', '<span class="nwa-cl-contact-icon {7}" title="{5}"></span>', '<span class="nwa-cl-contact-nick" title="{6}">{3}</span>', '<div class="nwa-header__nick-fadeout"></div>', '<div class="nwa-cl-contact-unrecent-button" title="' + WA.tr("profile.close") + '"></div>', 
  '<span class="nwa-msg-counter">{8}</span>', "</div>"].join(""), _subtitleTmpl:['<div style="top: {2}px" class="nwa-cl-subtitle nwa-cl-subtitle_{1}">', '<span class="nwa-cl-subtitle-text">{0}</span>', "</div>"].join(""), _renderList:function(visibleArea, listLength, fullLength) {
    var start = +new Date;
    var activityManager = this.abstraction.remoteData.activityManager;
    if(!WA.isNumber(this._clistLength) && (listLength > 10 || WA.isDebug)) {
      this.el.removeClass("wa-mdf-shortclist")
    }
    if(this._clistLength !== listLength) {
      this._clistLength = listLength;
      this.spacerEl.dom.style.height = LINE_HEIGHT * this._clistLength + "px"
    }
    var from = this.abstraction.remoteData.requestParams ? this.abstraction.remoteData.requestParams.from : 0, html = [];
    var activeCount = activityManager.getActiveCount(), activeIndex = activeCount - from, drawSubtitles = !this.hideActiveDialogs && activeIndex > 0, activeBlockEnded = false;
    if(drawSubtitles) {
      html[0] = U.String.format(this._subtitleTmpl, WA.tr("cl.titleActive"), "active", 0)
    }
    U.Array.each(visibleArea, function(contact, i) {
      if(drawSubtitles && !activeBlockEnded && i >= activeIndex) {
        activeBlockEnded = true;
        html[html.length] = U.String.format(this._subtitleTmpl, "All", "all", this._contactsOffset + LINE_HEIGHT * (i + 1))
      }
      var args = this._describeContact(contact, i, drawSubtitles ? activeBlockEnded ? 2 : 1 : 0, drawSubtitles && !activeBlockEnded);
      args.unshift(this._contactTmpl);
      html[html.length] = U.String.format.apply(U.String, args)
    }, this);
    html = html.join("");
    if(this.spacerEl.dom.innerHTML != html) {
      this.spacerEl.update(html);
      this.scrollBar.sync()
    }
    this._showTeaser(fullLength, visibleArea)
  }, _showTeaser:function(count, contacts) {
    if(typeof count === "undefined") {
      return
    }
    if(count === this.__lastListLength) {
      return
    }
    this.__lastListLength = count;
    this.teaserEl.hide()
  }, _renderSuggests:function(suggests, showInvite) {
    var SUGGEST_HTML = '<div class="nwa-teaser__close"></div><div class="nwa-teaser__suggests">{items}</div><span class="nwa-teaser__text">{msg}</span>                     <button class="nwa-teaser__invite">' + WA.tr("cl.teaser.inviteFriends") + "</button>", SUGGEST_ITEM_HTML = '<div class="nwa-teaser__suggests-item {avatarClass}" title="{nick}" data-mail="{mail}" style="background-image:url({avatar});"></div>';
    var items = [], html = "";
    if(suggests.length > 0) {
      U.Array.each(suggests, function(contact) {
        var avatar = WA.makeAvatar(contact.email, contact.nick, "_avatarsmall");
        items.push(U.String.parseTemplate(SUGGEST_ITEM_HTML, {avatar:avatar.url, avatarClass:avatar.className, nick:U.String.htmlEntity(contact.nick), mail:contact.email}))
      });
      U.Mnt.countRB(1658018)
    }else {
      if(!showInvite) {
        return
      }
    }
    U.Mnt.countRB(showInvite ? 1658076 : 1658081);
    html = U.String.parseTemplate(SUGGEST_HTML, {items:items.join(""), msg:showInvite ? WA.tr("cl.teaser.addFriendsAndChat") : WA.tr("cl.teaser.peopleYouMayKnow")});
    this.teaserEl.toggleClass("nwa-teaser_noinvite", !showInvite);
    this.teaserEl.toggleClass("nwa-teaser_nosuggests", suggests.length == 0);
    this.teaserEl.update(html);
    this.teaserEl.show()
  }, _onTeaserClick:function(e) {
    var trg = e.getTarget(true);
    if(trg.hasClass("nwa-teaser__invite")) {
      this._onAddContactClick()
    }else {
      if(trg.hasClass("nwa-teaser__suggests-item")) {
        U.Mnt.countRB(1658069);
        this.addContactDialog.addNewContact(trg.getAttribute("data-mail"), null, true)
      }else {
        if(trg.hasClass("nwa-teaser__close")) {
          this.__teaserClosed = true;
          this.teaserEl.hide();
          WA.Storage.save({"cl_teaser":WA.now()});
          U.Mnt.countRB(1658074)
        }
      }
    }
  }, _onBeforeShow:function() {
    return this.isActive()
  }, _onShow:function() {
    this.visible = true;
    this._checkOffset();
    this.offsetChecker.start();
    this.scrollBar.sync();
    if(WA.Voip.inTalk()) {
      U.Mnt.countRB(1216822)
    }
  }, _onHide:function() {
    this.visible = false;
    this.offsetChecker.stop();
    this._height = -1;
    this._top = -1;
    this.searchField.stop();
    this.addContactDialog.hide()
  }, _resetScroll:function() {
    this.clistEl.dom.scrollTop = 0
  }, _onInvalidate:function() {
    this._resetScroll();
    delete this._height;
    if(this.visible) {
      this._checkOffset()
    }
  }, _onAddContactClick:function() {
    var dlg = this.addContactDialog;
    if(!dlg.rendered) {
      dlg.render(this.el.parent())
    }
    this.btnAddContact.setState(!dlg.isVisible());
    dlg.setVisible(!dlg.isVisible())
  }, _onCreateChatClick:function() {
    var dlg = this.createChatDialog;
    if(!dlg.rendered) {
      dlg.render(this.el.parent())
    }
    this.btnCreateChat.setState(!dlg.isVisible());
    dlg.setVisible(!dlg.isVisible())
  }, openAddDialog:function() {
    this._onAddContactClick();
    this.show()
  }, searchContact:function(mail, openProfile) {
    this.openAddDialog();
    this.addContactDialog.searchMail(mail, openProfile)
  }, _generateItemId:function(email) {
    return"wa-clist-spacer-item-" + email.replace(/@|\./g, "_")
  }, activate:function(cb, scope) {
    return WA.ContactListAgent.superclass.activate.call(this, {cb:cb, scope:scope})
  }, minimize:function() {
    this.hide()
  }, _onActivate:function(params) {
    this.abstraction.activate();
    if(WA.isFunction(params.cb)) {
      params.cb.call(params.scope || window)
    }
  }, _onDeactivate:function() {
    this.abstraction.deactivate();
    this.searchField.abort();
    this.hide();
    this._resetScroll();
    delete this._height
  }, actualize:function(cb, scope) {
    cb && cb.call(scope || window);
    this.createChatDialog.abstraction.checkUpdate()
  }, enableUserEvents:function() {
  }, disableUserEvents:function() {
  }, onlineConfirm:function(title) {
    this._renderList([], 0);
    this.activate();
    this.show();
    this._onlineConfirmDialog.show(title)
  }})
})();
(function() {
  var WA = WebAgent;
  var U = WA.util;
  var SELECTED_ITEM_CLS = "nwa-search-results__item_selected";
  var SearchResults = WA.ContactListAgent.SearchResults = WA.extend(WA.ui.Component, {autoEl:{tag:"div", style:"display: none"}, initComponent:function() {
    SearchResults.superclass.initComponent.call(this);
    this.__cursor = 0;
    this.selectEvent = new U.Event
  }, setData:function(data) {
    if(!this.isVisible()) {
      this.show()
    }
    if(data.data.length > 0) {
      var html = U.Array.transform(data.data, function(contact, index) {
        return this.__renderSearchResult(contact, index, data.query)
      }, this).join("");
      this.el.update(html)
    }else {
      this.el.update("&nbsp;" + WA.tr("cl.noResults"))
    }
  }, _onAfterRender:function() {
    SearchResults.superclass._onAfterRender.call(this);
    this.el.on("mouseover", this._onMouseOver, this);
    this.el.on("click", this._onClick, this)
  }, __renderSearchResult:function(contact, index, query) {
    var mail = contact[0];
    var nick = U.DomHelper.htmlEntities(contact[1] || mail);
    query = (query || "").toLowerCase();
    var hlMail = "";
    if(!WA.MainAgent.isChat(mail) && !WA.MainAgent.isTel(mail)) {
      hlMail = mail;
      var inMail = hlMail.indexOf(query);
      if(inMail != -1) {
        hlMail = hlMail.substr(0, inMail) + "<strong>" + hlMail.substr(inMail, query.length) + "</strong>" + hlMail.substr(inMail + query.length)
      }
    }
    if(!contact[1] && hlMail == "") {
      contact[1] = mail
    }
    if(contact[1]) {
      var hlNick = contact[1] ? nick : hlMail;
      var inNick = nick.toLowerCase().indexOf(query);
      if(contact[1] && inNick != -1) {
        hlNick = nick.substr(0, inNick) + "<strong>" + nick.substr(inNick, query.length) + "</strong>" + nick.substr(inNick + query.length)
      }
      if(hlMail) {
        hlMail = " (" + hlMail + ")"
      }
    }else {
      hlNick = ""
    }
    var avatar = this.showAvatars && WA.makeAvatar(mail, contact[1], "_avatar22");
    var status = WA.MainAgent.getGeneralContactStatus(contact) || "";
    var statusTitle = contact[4] || status.replace(/^icq_/, "");
    statusTitle = WA.MainAgent.statuses[statusTitle] || statusTitle;
    return U.String.format('<div id="{4}" class="nwa-search-results__item {3}" nick="{0}" mail="{1}" status="{2}" title="{11}" features="{12}" idx="{5}">' + '<span class="nwa-cl-contact-avatar {10}" title="{0}" style="{9}"></span>' + '<span class="nwa-cl-contact-icon {8}"></span><span>{6}{7}</span></div>', nick, mail, U.DomHelper.htmlEntities(status), index === this.__cursor ? SELECTED_ITEM_CLS : "", this.__generateItemId(index), index, hlNick, hlMail, WA.Statuses.buildCssClass(status, WA.isUIN(mail)), 
    avatar ? "background-image: url(" + avatar.url + ");" : "", avatar ? avatar.className : "", U.DomHelper.htmlEntities(statusTitle), contact[7] || 0)
  }, __generateItemId:function(index) {
    return this.getId() + "-item-" + index
  }, __getItemAt:function(index) {
    return WA.get(this.__generateItemId(index))
  }, __getCurrentEl:function() {
    return this.__getItemAt(this.__cursor)
  }, __setCursor:function(newEl) {
    var index = parseInt(newEl.getAttribute("idx"));
    if(index >= 0 && this.__cursor !== index) {
      var oldEl = this.__getCurrentEl();
      if(oldEl) {
        oldEl.removeClass(SELECTED_ITEM_CLS);
        newEl.addClass(SELECTED_ITEM_CLS);
        this.__cursor = index
      }
    }
  }, moveCursor:function(direction) {
    var oldEl = this.__getCurrentEl();
    if(oldEl) {
      var newEl = oldEl[direction]();
      if(newEl) {
        this.__setCursor(newEl)
      }
    }
  }, _onMouseOver:function(e) {
    var el = e.getTarget(true);
    if(el) {
      this.__setCursor(el)
    }
  }, _onHide:function() {
    this.el.update("");
    this.__cursor = 0
  }, __selectEl:function(el) {
    this.selectEvent.fire(el.getAttribute("mail"), el.getAttribute("nick"), el.getAttribute("status"), el.getAttribute("title"), el.getAttribute("features"))
  }, _onClick:function(e) {
    if(!this.isVisible() || e.button !== 0) {
      return
    }
    var target = e.getTarget(true);
    if(target && this.el.contains(target)) {
      e.stopPropagation();
      var c = target;
      while(c && !c.equals(this.el)) {
        var mail = c.getAttribute("mail");
        if(mail) {
          this.__selectEl(c, target);
          break
        }else {
          c = c.parent()
        }
      }
    }
  }, selectCurrentItem:function() {
    var el = this.__getCurrentEl();
    if(el) {
      this.__selectEl(el)
    }
  }});
  var SearchField = WA.ContactListAgent.SearchField = WA.extend(WA.ui.TextField, {constructor:function(abstraction, config) {
    SearchField.superclass.constructor.call(this, config);
    this.abstraction = abstraction;
    this.abstraction.searchReadyEvent.on(this._onSearchReady, this);
    this.searchStartEvent = new U.Event;
    this.searchEndEvent = new U.Event;
    this.searchDT = new U.DelayedTask;
    this.pasteDT = new U.DelayedTask({fn:function() {
      this._doSearch();
      this.pasteDT.start()
    }, scope:this, interval:200});
    if(config.closeOnBlur) {
      WA.FocusManager.blurEvent.on(function() {
        this._cancelSearch()
      }, this)
    }
    this.searchResults = new SearchResults({cls:"nwa-search-results"});
    this.selectEvent = new U.Event;
    this.searchResults.selectEvent.on(this._onSearchResultSelect, this)
  }, setShowAvatars:function(flag) {
    this.searchResults.showAvatars = flag
  }, resultTo:function(container) {
    this.resultContainer = container
  }, abort:function() {
    this._cancelSearch()
  }, _onSearchResultSelect:function(mail, nick, status, statusTitle, features) {
    WA.setTimeout(this._cancelSearch, 400, this);
    this.selectEvent.fire(mail, nick, false, status, statusTitle, features)
  }, _onRender:function(ct) {
    SearchField.superclass._onRender.call(this, ct);
    this.clearBtn = new WA.ui.Button({cls:"nwa-search__clear", handler:function() {
      this._cancelSearch()
    }, scope:this});
    this.clearBtn.render(ct)
  }, _onAfterRender:function() {
    SearchField.superclass._onAfterRender.call(this);
    this.el.on("keyup", this._onSearchFieldKeyUp, this);
    this.el.on("paste", function(e) {
      WA.setTimeout(this._doSearch, 200, this)
    }, this);
    if(WA.isOpera) {
      this.el.on("mouseup", function(e) {
        if(e.button == 2) {
          this.pasteDT.start()
        }
      }, this)
    }
  }, _cancelSearch:function(stayFocused) {
    this.clearBtn.hide();
    if(stayFocused !== true) {
      this.val("");
      try {
        this.el.dom.blur()
      }catch(e) {
      }
      this._onBlur();
      this.stop()
    }
    this.abstraction.cancelSearch();
    if(this.searchResults.rendered) {
      this.searchResults.hide()
    }
    this.searchEndEvent.fire()
  }, _onSearchReady:function(ignored, data) {
    var sr = this.searchResults;
    if(!sr.rendered) {
      sr.renderEvent.on(WA.createDelegate(this._onSearchReady, this, [ignored, data], 0));
      sr.render(this.resultContainer || this.container)
    }else {
      sr.setData(data);
      this.searchStartEvent.fire()
    }
  }, _onSearchFieldKeyUp:function(e) {
    var keyCode = e.getKeyCode();
    if(keyCode === 38) {
      this.searchResults.moveCursor("prev")
    }else {
      if(keyCode === 40) {
        this.searchResults.moveCursor("next")
      }else {
        if(keyCode === 13) {
          var selectedItem = this.searchResults.selectCurrentItem();
          if(selectedItem) {
            this._onSearchResultSelect(selectedItem.mail, selectedItem.nick, selectedItem.status, selectedItem.title, selectedItem.features)
          }
        }else {
          if(keyCode === 27) {
            e.preventDefault();
            this._cancelSearch()
          }else {
            this.searchDT.start(150, this._doSearch, this)
          }
        }
      }
    }
  }, _doSearch:function() {
    var query = this.val();
    if(query) {
      this.clearBtn.show();
      this.abstraction.search(query)
    }else {
      this._cancelSearch(true)
    }
  }, stop:function() {
    this.pasteDT.stop();
    this.searchDT.stop()
  }, destroy:function() {
    this.searchResults.destroy();
    if(this.clearBtn) {
      this.clearBtn.destroy()
    }
    this.abstraction.searchReadyEvent.un(this._onSearchReady, this);
    this.pasteDT.stop();
    this.searchDT.stop();
    this.selectEvent.removeAll();
    this.searchStartEvent.removeAll();
    this.searchEndEvent.removeAll();
    this.searchEndEvent = this.searchStartEvent = this.selectEvent = null;
    SearchField.superclass.destroy.call(this)
  }})
})();
(function() {
  var WA = WebAgent;
  var U = WA.util;
  var UI = WA.ui;
  WA.IncomingCallDialog = WA.extend(UI.Layer, {constructor:function(config) {
    WA.IncomingCallDialog.superclass.constructor.apply(this, arguments);
    this.initialConfig.hideOnEscape = false;
    this.autoEl = null;
    this.autoRender = WA.ma.el;
    this.incomingVideo = !!config.video;
    this.RTCMode = config.RTCMode;
    this.actionEvent = new U.Event
  }, _onRender:function(el) {
    this.el = el.createChild({cls:"nwa-window nwa-voip", style:"display: none", children:[{cls:"nwa-voip__avatar"}, {cls:"nwa-voip__user", children:[{cls:"nwa-voip__status"}, {cls:"nwa-voip__nick", tag:"span"}, {cls:"nwa-voip__nick-fadeout"}]}, {cls:"nwa-voip__text", html:WA.tr("voip.incomingCall")}, {tag:"button", cls:"nwa-el-green nwa-voip__video", "data-action":"video", html:"<span>" + WA.tr("voip.answerVideo") + "</span>"}, {tag:"button", cls:"nwa-el-green nwa-voip__voice", "data-action":"voice", 
    html:"<span>" + WA.tr("voip.answer") + "</span>"}, {tag:"button", cls:"nwa-el-hangup", "data-action":"decline", html:"<span>" + WA.tr("voip.decline") + "</span>"}, {tag:"button", cls:"nwa-window__close", "data-action":"decline"}]});
    if(WA.Voip.isCompatibleVideo) {
      this.el.addClass("nwa-voip_video")
    }else {
      U.Mnt.countRB(1378994)
    }
    if(WA.IncomingCallDialog.even) {
      this.el.addClass("nwa-voip_even")
    }
    WA.IncomingCallDialog.even = !WA.IncomingCallDialog.even;
    this.avatarEl = this.el.first();
    this.userEl = this.el.first().next();
    this.el.on("mousedown", this._onMouseDown, this)
  }, _onMouseDown:function(e) {
    e.stopPropagation();
    var target = e.getTarget(true);
    if(!target.getAttribute("data-action")) {
      target = target.parent()
    }
    var action = target && target.getAttribute("data-action");
    if(action) {
      this.hide();
      this.actionEvent.fire(action)
    }
  }, open:function(email, nick, status) {
    this.show();
    if(this.RTCMode) {
      this.el.removeClass("nwa-voip_video").toggleClass("nwa-voip_onlyvideo", this.incomingVideo)
    }
    this.avatarEl.setStyle({"background-image":"url(" + WA.makeAvatar(email, nick, "_avatarmedium", this.avatarEl) + ")"});
    this.userEl.first().dom.className = "nwa-voip__status " + WA.buildIconClass(status, true);
    this.userEl.first().next().update(U.String.htmlEntity(nick) || email)
  }, _onClick:function(e) {
  }});
  WA.IncomingCallDialog.even = false
})();
(function() {
  var WA = WebAgent;
  var U = WA.util;
  var UI = WA.ui;
  var SELECTED_ITEM_CLS = "nwa-search-results__item_selected";
  var ConferenceAbstraction;
  var ERRORS = {"permission":WA.tr("dialog.errorPermission"), "noSuchChat":WA.tr("dialog.errorNoSuchChat")};
  var SearchMemberField = WA.extend(WA.ContactListAgent.SearchField, {constructor:function(abstraction, config) {
    SearchMemberField.superclass.constructor.superclass.constructor.call(this, config);
    this.abstraction = abstraction;
    this.searchStartEvent = new U.Event;
    this.searchEndEvent = new U.Event;
    this.selectEvent = new U.Event;
    this.searchDT = new U.DelayedTask;
    this.pasteDT = new U.DelayedTask({fn:function() {
      this._doSearch();
      this.pasteDT.start()
    }, scope:this, interval:200});
    this.searchResults = new SearchResults({cls:"nwa-search-results"});
    this.searchResults.selectEvent.on(this._onSearchResultSelect, this)
  }, _onRender:function(ct) {
    SearchMemberField.superclass._onRender.call(this, ct);
    this.searchResults.render(this.resultContainer || ct);
    this.abstraction.searchConfPartyReadyEvent.on(this._onSearchReady, this)
  }, _doSearch:function() {
    var query = this.val();
    if(query) {
      this.clearBtn.show();
      this.abstraction.searchConfParty(query, this.mail, this.reverted)
    }else {
      this._cancelSearch(true)
    }
  }, _cancelSearch:function(stayFocused) {
    SearchMemberField.superclass._cancelSearch.call(this, stayFocused);
    this.abstraction.getParticipantsList(this._onPartiListReady, this, this.mail, this.reverted)
  }, _onPartiListReady:function(data) {
    var sr = this.searchResults;
    sr.setData({data:data, query:""});
    this.searchStartEvent.fire()
  }, _onSearchResultSelect:function(mail, nick, status, title, features, action) {
    this.selectEvent.fire(mail, nick, status, title, features, action)
  }, eoc:null});
  var SearchResults = WA.extend(WA.ContactListAgent.SearchResults, {constructor:function(config) {
    SearchResults.superclass.constructor.call(this, config);
    this._checked = {}
  }, __renderSearchResult:function(contact, index, query) {
    var mail = contact[0];
    var nick = U.DomHelper.htmlEntities(contact[1] || mail);
    var status = WA.MainAgent.getGeneralContactStatus(contact);
    var tel = contact[5] && contact[5][0] || "";
    var hlNick = nick;
    var inNick = nick.indexOf(query);
    if(contact[1] && inNick != -1) {
      hlNick = nick.substr(0, inNick) + "<strong>" + nick.substr(inNick, query.length) + "</strong>" + nick.substr(inNick + query.length)
    }
    var addedClass = [];
    if(index === this.__cursor) {
      addedClass.push(SELECTED_ITEM_CLS)
    }
    if(contact[2] && !contact[3]) {
      addedClass.push("nwa-search-results__item_noauth")
    }else {
      if(mail == WA.ACTIVE_MAIL) {
        addedClass.push("nwa-search-results__item_self")
      }else {
        if(status == "offline" || !(contact[7] & WA.FEATURE_FLAG_WEB_CALL)) {
          addedClass.push("nwa--search-results__item_nofeatures")
        }else {
          if(!(contact[7] & WA.FEATURE_FLAG_VIDEO)) {
            addedClass.push("nwa--search-results__item_novideo")
          }
        }
      }
    }
    var avatar = this.showAvatars && !WA.MainAgent.isTel(mail) && WA.makeAvatar(mail, nick, "_avatar22");
    return U.String.format('<div id="{4}" class="nwa-search-results__item {3}" nick="{0}" mail="{1}" status="{2}" idx="{5}" title="{10}" features="{11}">' + '<span class="nwa-cl-contact-avatar {8}" title="{0}" style="{7}"></span>' + '<span class="nwa-cl-contact-icon {6}"></span><span>{9}</span>' + '<span class="nwa-cl-actions">' + '<span class="nwa-cl-action_fadeout"></span>' + '<span action="videocall" class="nwa-cl-action_video_call"></span>' + '<span action="voicecall" class="nwa-cl-action_voice_call"></span>' + 
    '<span action="message" class="nwa-cl-action_message"></span>' + '<span class="nwa-cl-action_profile"></span>' + '<span action="add" class="nwa-cl-action_add"></span>' + '<span action="remove" class="nwa-cl-action_remove"></span>' + '</span><span class="nwa-cl-action_checkbox">' + '<span class="nwa-cl-action_fadeout"></span>' + '<input type="checkbox" {12}/>' + "</span></div>", nick, mail, U.DomHelper.htmlEntities(status), addedClass.join(" "), this.__generateItemId(index), index, WA.Statuses.buildCssClass(status, 
    WA.isUIN(mail)), avatar ? "background-image: url(" + avatar.url + ");" : "", avatar ? avatar.className : "", hlNick, U.DomHelper.htmlEntities(contact[3] || "") && mail, contact[7] || 0, this._checked[mail] ? "checked" : "")
  }, clearChecked:function() {
    this._checked = {}
  }, getChecked:function() {
    var res = [];
    U.Object.each(this._checked, function(it, key) {
      it && res.push([key])
    });
    return res
  }, __selectEl:function(el, target) {
    var chkbx = el.dom.getElementsByTagName("input")[0];
    var mail = el.getAttribute("mail");
    if(!target || target.dom.tagName.toString().toLowerCase() != "input") {
      if(chkbx) {
        chkbx.checked = !chkbx.checked;
        mail && (this._checked[mail] = chkbx.checked)
      }
    }else {
      if(chkbx && mail) {
        WA.setTimeout(function() {
          this._checked[mail] = chkbx.checked
        }, 100, this)
      }
    }
    this.selectEvent.fire(el.getAttribute("mail"), el.getAttribute("nick"), el.getAttribute("status"), el.getAttribute("title"), el.getAttribute("features"), target && target.getAttribute("action"))
  }, _onMouseOver:function(e) {
    var el = e.getTarget(true);
    if(el) {
      el = el.up("nwa-search-results__item")
    }
    if(el) {
      this.__setCursor(el)
    }
  }});
  WA.ConferenceParti = WA.extend(UI.Layer, {constructor:function(abstraction) {
    WA.ConferenceParti.superclass.constructor.apply(this, arguments);
    this.initialConfig.fadeIn = false;
    this.initialConfig.hideOnEscape = false;
    this.autoEl = null;
    this.isAdding = false;
    ConferenceAbstraction || (ConferenceAbstraction = abstraction);
    this.abstraction = ConferenceAbstraction;
    this.showAvatars = this.abstraction.showAvatars;
    if(!this.abstraction) {
      return false
    }
    this.selectEvent = new U.Event;
    this.confirmEvent = new U.Event;
    this.errorEvent = new U.Event;
    this.searchField = new SearchMemberField(this.abstraction.clAbstraction, {cls:"nwa-search__field", hintText:WA.tr("dialer.searchContacts"), hintClass:"nwa_hint_msg"});
    this.searchField.searchStartEvent.on(this._onSearchStart, this);
    this.searchField.searchEndEvent.on(this._onSearchEnd, this);
    this.searchField.setShowAvatars(this.showAvatars);
    this.searchField.selectEvent.on(this._onSelectEvent, this);
    this.abstraction.updateEvent.on(this._onUpdateAbstraction, this);
    this.abstraction.toggleAvatarsEvent.on(this.setShowAvatars, this)
  }, _onRender:function(el) {
    this.el = el.createChild({cls:"nwa-multichat__parti" + (this.showAvatars ? " nwa-cl_avatars" : ""), children:[{cls:"nwa-search", children:[{cls:"nwa-search__wrap"}]}, {cls:"nwa-clist"}]});
    this.clistEl = this.el.last();
    this.searchField.resultTo(this.clistEl);
    this.searchField.render(this.clistEl.prev().first());
    this._btnApplySelected = new WA.ui.Button({cls:"nwa-add_to_chat_button", tooltip:this.mail ? WA.tr("dialog.addToChat") : WA.tr("chat.createChat"), scope:this, text:"<span></span>" + (this.mail ? WA.tr("dialog.addToChat") : WA.tr("chat.createChat")), handler:function(obj, e) {
      this.applySelectedItems();
      e.stopPropagation()
    }});
    this._btnApplySelected.render(this.el);
    this.scrollBar = new WA.ui.ScrollBar({source:this.clistEl, watchResize:WA.isPopup});
    this.scrollBar.render(this.clistEl)
  }, _onAfterRender:function() {
    WA.ConferenceParti.superclass._onAfterRender.call(this);
    this._onShow()
  }, _onSearchStart:function() {
    this.clistEl.addClass("nwa-clist_search_mode");
    this.scrollBar.setSource(this.searchField.searchResults.getEl());
    this.searchMode = true
  }, _onSearchEnd:function() {
    this.clistEl.removeClass("nwa-clist_search_mode");
    this.scrollBar.setSource(this.clistEl);
    this.searchMode = false
  }, _onSelectEvent:function(mail, nick, status, title, features, action) {
    if(action != "remove" && WA.ACTIVE_MAIL == mail) {
      return false
    }
    if(!this.isAdding && (status == "gray" || status == "icq_gray") && !action && !title) {
      if(!this._profile) {
        this._profile = new WA.Profile(true, {modal:true, fadeIn:true});
        this._profile.addEvent.on(function(email, name) {
          this.abstraction.onAddContactFromConf(email, name, status, title, features)
        }, this);
        this._profile.render(this.el.parent())
      }else {
        if(this._profile.container.dom !== this.el.parent().dom) {
          this._profile.el.appendTo(this._profile.container = this.el.parent())
        }
      }
      this._profile.show(mail);
      return false
    }
    if(action == "add") {
      this.abstraction.onAddContactFromConf(mail, nick, status, title, features);
      return false
    }
    if(action == "remove") {
      this.abstraction.onConfContactActions("del", [[mail]], this.mail, this.name);
      return false
    }
    if(!action && !this.isAdding) {
      action = "message"
    }
    return this.selectEvent.fire.apply(this.selectEvent, arguments)
  }, setShowAvatars:function(flag) {
    this.showAvatars = flag;
    this.searchField.setShowAvatars(this.showAvatars);
    if(this.el) {
      this.el.toggleClass("nwa-cl_avatars", flag)
    }
  }, applySelectedItems:function() {
    var data = this.searchField.searchResults.getChecked();
    if(this.confirmEvent.fire(data) && this.mail) {
      if(data.length) {
        this.abstraction.onConfContactActions("add", data, this.mail, this.name)
      }
    }
  }, _onHide:function() {
    this.visible = false;
    this.searchField.stop();
    this._profile && this._profile.hide();
    this.searchField.searchResults.hide();
    WA.ConferenceParti.superclass._onHide.apply(this, arguments)
  }, _onShow:function() {
    this.visible = true;
    this.container = this.el.parent();
    this._profile && this._profile.hide();
    this.el.toggleClass("nwa-add__parti", this.isAdding);
    this.searchField.searchResults.el.dom.scrollTop = 0;
    this.searchField.searchResults.clearChecked();
    if(this.mail) {
      this.searchField.reverted = this.isAdding;
      this.searchField.mail = this.mail
    }else {
      this.searchField.mail = false
    }
    this.searchField._cancelSearch();
    this.scrollBar.sync()
  }, _onUpdateAbstraction:function(mail, params) {
    if(mail && mail == this.mail) {
      if(params && params.error) {
        ERRORS[params.error] && this.errorEvent.fire(ERRORS[params.error])
      }else {
        this.visible && this.searchField._doSearch()
      }
    }else {
      if(!mail && this.visible) {
        this.searchField._doSearch()
      }
    }
  }, destroy:function() {
    this.selectEvent.removeAll();
    this.confirmEvent.removeAll();
    this.abstraction.updateEvent.un(this._onUpdateAbstraction, this);
    this.abstraction.toggleAvatarsEvent.un(this.setShowAvatars, this);
    WA.ConferenceParti.superclass.destroy.call(this)
  }})
})();
(function() {
  var WA = WebAgent;
  var U = WA.util;
  var UI = WA.ui;
  var ConnectionRoster = WA.conn.ConnectionRoster;
  var __countsRB = {create:function(params) {
    U.Mnt.countRB(3827680);
    var len = params && params.members && params.members.length;
    if(len == 3) {
      U.Mnt.countRB(3827681)
    }else {
      if(len == 4) {
        U.Mnt.countRB(3827795)
      }else {
        if(len >= 5) {
          U.Mnt.countRB(3827826)
        }
      }
    }
  }, add:function() {
    U.Mnt.countRB(3828427)
  }, del:function(params) {
    if(params.members.indexOf(WA.ACTIVE_MAIL) != -1) {
      U.Mnt.countRB(3828474)
    }else {
      U.Mnt.countRB(3828459)
    }
  }};
  var Abstraction = WA.extend(ConnectionRoster, {constructor:function(clAbstraction) {
    Abstraction.superclass.constructor.apply(this);
    this._requestsParams = {};
    this._cachParams = {};
    this._confPatyChangeTS = 0;
    this._timeouts = {};
    this.showAvatars = false;
    this.clAbstraction = clAbstraction;
    this.createdEvent = new U.Event;
    this.updateEvent = new U.Event;
    this.toggleAvatarsEvent = new U.Event;
    this.addContactFromConf = new U.Event
  }, onAddContactFromConf:function(mail, nick, status, title, features) {
    nick == mail && (nick = null);
    this.addContactFromConf.fire(mail, nick, status, title, features)
  }, onConfContactActions:function(action, data, mail, name) {
    this.send(action, {email:mail, members:data, chatName:name})
  }, send:function(op, params) {
    __countsRB[op] && __countsRB[op](params);
    var scope = op === "create" ? WA.IcqRapi : WA.IcqApi;
    (scope[op + "ChatMembers"] || scope[op + "Chat"]).call(scope, params, function(status) {
      var success = typeof status === "number" ? status === 200 : status;
      if(!success) {
        params.error = "noSuchChat";
        return this._onUpdateConsist(params, true)
      }
    }, this)
  }, checkUpdate:function() {
    WA.Storage.load(["confPatyChangeTS"], WA.createDelegate(function(data) {
      if(this._confPatyChangeTS != data.confPatyChangeTS) {
        this._confPatyChangeTS = data.confPatyChangeTS;
        this._onUpdateConsist()
      }
    }, this))
  }, setShowAvatars:function(flag) {
    if(this.showAvatars != flag) {
      this.showAvatars = flag;
      this.toggleAvatarsEvent.fire(flag)
    }
  }, _onUpdateConsist:function(params, isError) {
    if(isError) {
      return this.updateEvent.fire(params.mail, params)
    }
    if(params && params.mail) {
      params.type = "delMembers,kicked,leave,".indexOf(params.type + ",") > -1 ? "del" : "add";
      if(params.type == "del" && U.Array.indexOf(params.members, WA.ACTIVE_MAIL) != -1) {
        delete params.members
      }
      this.clAbstraction.updateChatMembers(params);
      this.updateEvent.fire(params.mail, params);
      WA.Storage.save({confPatyChangeTS:this._confPatyChangeTS = +new Date})
    }else {
      this.clAbstraction.updateChatMembers();
      this.updateEvent.fire()
    }
  }, _onConnectionChatMember:function(value) {
    this._onUpdateConsist(value)
  }, _onConnectionChatCreated:function(chats) {
    U.Array.each(chats, function(it) {
      this.createdEvent.fire({mail:it.sender, nickname:it.chat_name})
    }, this)
  }, _onConnectionMchatCreated:function(value) {
    var params;
    if(value.iq && this._requestsParams[value.iq] && value.id) {
      params = this._requestsParams[value.iq];
      params.id = value.id;
      delete this._requestsParams[value.iq];
      return this.createdEvent.fire(params)
    }
    if(params = this._cachParams[value.iq]) {
      if(value.id && !params.id) {
        params.id = value.id
      }else {
        if(!value.id && params.id) {
          params.nickname = value.nickname;
          params.members = value.members;
          params.totalitary = value.totalitary
        }
      }
      delete this._cachParams[value.iq]
    }else {
      params = this._cachParams[value.iq] = value
    }
    if(params.id && !this._timeouts[value.iq]) {
      this._timeouts[value.iq] = WA.setTimeout(function() {
        delete this._timeouts[value.iq];
        this.createdEvent.fire(params)
      }, params.members ? 0 : 500, this)
    }
  }});
  WA.CreateConference = WA.extend(UI.Layer, {constructor:function(abstraction) {
    WA.CreateConference.superclass.constructor.apply(this, arguments);
    this.autoEl = null;
    this.openContactEvent = new U.Event;
    this.addContactEvent = new U.Event;
    this.abstraction = new Abstraction(abstraction);
    this.partiList = new WA.ConferenceParti(this.abstraction);
    this.abstraction.createdEvent.on(this._onCreatedSuccess, this);
    this.partiList.isAdding = true;
    this.partiList.confirmEvent.on(this._onConfirm, this);
    this.partiList.hideEvent.on(this.hide, this);
    this._nameBox = new UI.NameBox;
    this._nameField = new UI.TextField({hintText:WA.tr("chat.newChat"), cls:"nwa-textfield nwa-textfield_thin nwa_hint_msg"})
  }, _onRender:function(el) {
    this.el = el.createChild({tag:"div", cls:"nwa-add nwa-chat nwa-multichat", children:[{tag:"div", cls:"nwa-chat__shadow", children:[{tag:"div", cls:"nwa-chat__header", children:[{cls:"nwa-addchat__close"}, {tag:"div", cls:"nwa-create_chat_permission", children:[{tag:"span", html:WA.tr("chat.consistPermission")}, {tag:"div", html:'<input name="permission" type="radio" checked/>' + WA.tr("chat.permAll") + '<input name="permission" type="radio"/>' + WA.tr("chat.permOnlyMe")}]}, {tag:"div", cls:"nwa-create_chat_name", 
    children:[{tag:"span", html:WA.tr("chat.theme")}]}, {tag:"div", cls:"nwa-create_chat_search_title", html:WA.tr("chat.addUsers")}]}]}]});
    var headerEl = this.el.first().first();
    this.statusField = headerEl.createChild({tag:"div", cls:"nwa-chat__header-status", children:[{tag:"span", cls:"wa-cl-status-chat"}]});
    this._nameBox.render(headerEl);
    this._nameBox.setName(WA.tr("chat.newChat"));
    this.partiList.render(this.el.first());
    headerEl.first().on("click", this.hide, this);
    this._nameField.render(headerEl.first().next().next());
    this._permissionParent = headerEl.first().next()
  }, _onHide:function() {
    WA.CreateConference.superclass._onHide.call(this);
    this.partiList.hide()
  }, _onShow:function() {
    WA.CreateConference.superclass._onShow.call(this);
    this.partiList.show()
  }, _onConfirm:function(data) {
    if(!data || !data.length) {
      this._showFormAlert(WA.tr("chat.needSelect"));
      return false
    }
    var inpts = this._permissionParent.dom.getElementsByTagName("input");
    var params = {"name":this._nameField.val() || this._nameField.hintText, "members":data};
    inpts[1].checked && (params.totalitary = "1");
    this.abstraction.send("create", params);
    this.partiList.hide();
    return false
  }, _showFormAlert:function(msg) {
    if(!this._alert) {
      this._alert = new WA.DialogsAgent.AlertDialog({fadeIn:true, modal:true, autoRender:this.el})
    }
    this._alert.show(msg)
  }, _onCreatedSuccess:function(params) {
    this.openContactEvent.fire(params.mail, params.nickname);
    this.addContactEvent.fire(params.mail, params.nickname)
  }, setShowAvatars:function(flag) {
    this.abstraction.setShowAvatars(flag)
  }});
  WA.CreateConference.formatChatEventMessage = function(opname, from, members) {
    var msg = WA.tr("chat.message." + opname, {"0":from, 1:members});
    if(msg && msg[0] != "[") {
      return msg
    }
    return false
  }
})();
(function() {
  var WA = WebAgent;
  var U = WA.util;
  var USE_CHUNKS = true;
  var MEGABYTE = 1048576;
  var MAX_FILE_SIZE = 1500 * MEGABYTE;
  var MAX_CHUNK_SIZE = MEGABYTE;
  var CHUNK_SIZE = MEGABYTE - 1;
  var UPLOAD_INIT_URL = "//files-agent.mail.ru/files/init";
  var GETINFO_URL = "//files-agent.mail.ru/getinfo";
  var PREVIEW_MIN_SIZE = 72;
  var PREVIEW_MAX_SIZE = 194;
  var PREVIEW_DROP_WIDTH = 80;
  var PREVIEW_DROP_HEIGHT = 33;
  var FILE_OBJ_LIVE_TIME = 30 * 60;
  var FILE_BOX_HTML = '{object}                <div class="nwa-file {wrap_cls}" style="{wrap_style}">                    <div class="nwa-file__info">{file_info}</div>                    <div class="nwa-file__icon">{file_extension}</div>                    {file_title}                    <div class="nwa-file__title-fadeout"></div>                    {file_preview}                    {progressbar}                </div>';
  var PROGRESSBAR_HTML = '        <div class="nwa-file__abort" data-id="{id}" data-action="upload-abort"></div>        <div class="nwa-file__progressbar">            <div class="nwa-file__progress" style="width:{progress}%"></div>        </div>';
  var TITLE_HTML = '<a class="nwa-file__title" target="_blank" onclick="WebAgent.util.Mnt.countRB(13169737);" title="' + WA.tr("file.downloadFile") + '" href="{url}">{name}</a>';
  var TITLE_PLAIN_HTML = '<div class="nwa-file__title">{name}</div>';
  var OBJECT_HTML = '<sub data-type="file" data-name="{name}" data-id="{id}" style="display:none;"></sub>';
  var DOWNLOAD_BUTTON_HTML = '<div  class="nwa-file__drop" style="{style}">' + '<a class="nwa-file__drop-download" target="_blank" onclick="WebAgent.util.Mnt.countRB(13169737);" title="' + WA.tr("file.downloadFile") + '" href="{url}"><div></div></a>' + '<a class="nwa-file__drop-preview" target="_blank" href="{url_preview}"><div></div></a>' + "</div>";
  var IMAGE_PREVIEW_HTML = '<a target="_blank" href="{url}" style="{url_style}" class="nwa-file__image"><img style="{img_style}" src="{img}"/></a>';
  function _log(s) {
    U.Mnt.log({reason:"breaklog", module:"uploader", login:WA.ACTIVE_MAIL, text:s})
  }
  function isHostMethod(object, property) {
    var t = typeof object[property];
    return t == "function" || !!(t == "object" && object[property]) || t == "unknown"
  }
  var getXhr = function() {
    if(isHostMethod(window, "XMLHttpRequest")) {
      return function() {
        return new XMLHttpRequest
      }
    }else {
      var item = function() {
        var list = ["Microsoft", "Msxml2", "Msxml3"], i = list.length;
        while(i--) {
          try {
            item = list[i] + ".XMLHTTP";
            var obj = new ActiveXObject(item);
            return item
          }catch(e) {
          }
        }
      }();
      return function() {
        return new ActiveXObject(item)
      }
    }
  }();
  WA.UploaderProgress = WA.extend(Object, {STEP_DELAY:50, STEPS_VALUE:15, constructor:function() {
    this.drawEvent = new U.Event;
    this.startPoint = this.currentPoint = this.endPoint = this.timer = 0
  }, moveTo:function(val) {
    if(val < 0 || val > 100 || val <= this.endPoint) {
      return
    }
    this.endPoint = val;
    this.startPoint = this.currentPoint;
    this._nextStep()
  }, _nextStep:function() {
    if(this.timer) {
      clearTimeout(this.timer)
    }
    this.currentPoint += Math.floor((this.endPoint - this.startPoint) / this.STEPS_VALUE) + 1;
    if(this.currentPoint >= this.endPoint) {
      this.startPoint = this.currentPoint = this.endPoint
    }else {
      this.timer = WA.setTimeout(this._nextStep, this.STEP_DELAY, this)
    }
    this.drawEvent.fire(this.currentPoint)
  }, destroy:function() {
    if(this.timer) {
      clearTimeout(this.timer)
    }
    this.drawEvent.removeAll()
  }});
  WA.fileUploader = WA.extend(Object, {constructor:function(sn) {
    this.uid = Math.round(Math.random() * 999999);
    this.email = sn;
    this.info = {};
    this._chunkInfo = {};
    this._loaded = 0;
    this._dom = null;
    this.progressDomNode = null;
    this.progressHandler = new WA.UploaderProgress;
    this.readyToUploadEvent = new U.Event;
    this.initSuccessEvent = new U.Event;
    this.initFailedEvent = new U.Event;
    this.completedEvent = new U.Event;
    this.progressEvent = new U.Event;
    this.errorEvent = new U.Event;
    WA.FileApi.progressEvent.on(this._updateProgress, this)
  }, start:function(inputDom) {
    this.timestamp = WA.now();
    var file = this.file = inputDom.files && inputDom.files[0];
    if(file && file.size) {
      this._dom = inputDom;
      this.info = {id:this.uid, name:file.name, type:WA.fileTools.getFileType(file.name), bytes:file.size, size:WA.fileTools.formatFileSize(file.size), progress:0};
      WA.fileUploader.startUploadEvent.fire(this.email, this.uid);
      this._init()
    }else {
      this._onError(3)
    }
  }, _init:function() {
    var file = this.file, _this = this;
    if(!file) {
      return
    }
    if(file.size > MAX_FILE_SIZE) {
      this._onError(6, file.size);
      return
    }
    var cb = WA.createDelegate(function(resp) {
      if(resp.data && resp.data.host) {
        this.uploadUrl = "https://" + resp.data.host + resp.data.url;
        this.initSuccessEvent.fire(this.uploadUrl);
        if(this._dom) {
          this._dom.value = null
        }
        this.readyToUploadEvent.fire();
        this._upload()
      }else {
        this._onError(2, "nohost")
      }
    }, this);
    WA.FileApi.initUploadUrl(file.name, file.size, cb, WA.createDelegate(this._onError, this, [2]))
  }, _upload:function() {
    if(!this.file) {
      return
    }
    this.progressHandler.drawEvent.on(this.drawProgress, this);
    WA.fileUploader.progressEvent.fire(this.email, this.uid, 0);
    this._chunkInfo = {items:[], count:1, current:0, currentSize:0};
    if(USE_CHUNKS && window.Blob) {
      this._chunkInfo.count = Math.ceil(this.file.size / CHUNK_SIZE)
    }
    this._uploadNextChunk()
  }, _uploadNextChunk:function() {
    if(!this.file) {
      return
    }
    if(this._chunkInfo.current >= this._chunkInfo.count) {
      return
    }
    var file = this.file, blob, start = this._chunkInfo.current * CHUNK_SIZE, end = start + CHUNK_SIZE;
    this._loaded += this._chunkInfo.currentSize;
    if(end >= file.size || this._chunkInfo.count == 1) {
      end = file.size - 1
    }
    try {
      blob = file.slice(start, end + 1)
    }catch(ex) {
      _log("error=slice_exception");
      blob = file;
      if(file.size > MAX_CHUNK_SIZE) {
        this._onError(6, file.size);
        return
      }
      start = 0;
      end = file.size - 1;
      this._chunkInfo.count = 1
    }
    this._chunkInfo.currentSize = end - start + 1;
    this._chunkInfo.current++;
    this._uploadItem(blob, start, end, file.size)
  }, _uploadItem:function(blob, start, end, total) {
    WA.FileApi.uploadBytes(this.uploadUrl, this.info.name, blob, start, end, total, WA.createDelegate(function(status, resp) {
      if(status == 206) {
        this._uploadNextChunk()
      }else {
        if(resp && resp.data) {
          this._onUploadCompleted(resp.data)
        }else {
          this._onError(5, 200)
        }
      }
    }, this), WA.createDelegate(this._onError, this))
  }, _updateProgress:function(loaded, total) {
    loaded = this._loaded + loaded;
    total = this.info.bytes;
    var u = Math.round(loaded * 100 / total);
    this.progressHandler.moveTo(u)
  }, updateProgressNode:function(dom) {
    if(dom) {
      this.progressDomNode = dom
    }
    this.drawProgress()
  }, drawProgress:function(percentValue) {
    percentValue = percentValue || this.progressHandler.currentPoint;
    if(this.progressDomNode) {
      this.progressDomNode.setStyle("width", percentValue + "%")
    }
  }, abort:function() {
    U.Mnt.countRB(13170035);
    this._onError(0)
  }, _onError:function(errorId, errorStatus) {
    if(!this.file) {
      return
    }
    errorStatus = errorStatus || "";
    if(errorId > 0) {
      U.Mnt.countRB(13170036);
      _log("errid=" + errorId + " msg=" + errorStatus)
    }
    if(errorId == 2 || errorId == 3) {
      if(this._dom) {
        this._dom.value = null
      }
    }
    WA.fileTools.createErrorObject(this.info, errorId);
    this.completedEvent.fire();
    WA.fileUploader.endUploadEvent.fire(this.email);
    this.destroy()
  }, _onUploadCompleted:function(fileInfo) {
    WA.fileTools.destroyUploader(this.uid);
    this.completedEvent.fire(fileInfo);
    WA.fileUploader.endUploadEvent.fire(this.email, fileInfo);
    this.destroy()
  }, destroy:function() {
    delete this.file;
    if(this._req) {
      this._req.abort()
    }
    WA.fileTools.destroyUploader(this.uid);
    this.progressHandler.destroy();
    this.readyToUploadEvent.removeAll();
    this.initSuccessEvent.removeAll();
    this.initFailedEvent.removeAll();
    this.completedEvent.removeAll();
    this.progressEvent.removeAll();
    this.errorEvent.removeAll()
  }});
  WA.fileUploader.startUploadEvent = new U.Event;
  WA.fileUploader.endUploadEvent = new U.Event;
  WA.fileUploader.progressEvent = new U.Event;
  WA.fileTools = {FILE_DOMAINS:["files\\.mail\\.ru", "files\\.icq\\.net", "files\\.icq\\.com", "chat\\.my\\.com/files", "files\\.chat\\.my\\.com"], OBJECT_TAG:"sub", UPLOAD_PREFIX:"upload", FILE_PREFIX:"fileobj", loadEvent:new U.Event, isUploadSupported:function() {
    return!!window.FileReader
  }, sendFile:function(email, fileNode) {
    var upl = new WA.fileUploader(email);
    this._fileUploaders[upl.uid] = upl;
    this._index[email] = this._index[email] || [];
    this._index[email].push(upl.uid);
    upl.start(fileNode);
    return upl
  }, fetchFileObj:function(fileId, serverInfo, url) {
    return{id:fileId, orig_url:url, name:serverInfo.filename, is_previewable:serverInfo.is_previewable, preview:serverInfo.static194, smallpreview:serverInfo["static"], bigpreview:serverInfo.static800, bytes:serverInfo.filesize, size:WA.fileTools.formatFileSize(serverInfo.filesize), mime:serverInfo.mime, type:this.getFileType(serverInfo.filename, serverInfo.mime), url:serverInfo.dlink, expiredTime:WA.now() + FILE_OBJ_LIVE_TIME}
  }, createErrorObject:function(fileInfo, errorCode) {
    var errorMessage = "";
    switch(errorCode) {
      case 0:
        errorMessage = WA.tr("file.errorAbort");
        break;
      case 1:
        errorMessage = WA.tr("file.errorNotFound");
        break;
      case 2:
        errorMessage = WA.tr("file.errorInit");
        break;
      case 3:
        errorMessage = WA.tr("file.errorReadFile");
        break;
      case 4:
        errorMessage = WA.tr("file.errorUpload");
        break;
      case 5:
        errorMessage = WA.tr("file.errorSending");
        break;
      case 6:
        errorMessage = WA.tr("file.errorFileTooLarge");
        break;
      case 7:
        errorMessage = WA.tr("file.errorReadFile");
        break
    }
    fileInfo.errorCode = errorCode;
    fileInfo.errorMsg = errorMessage;
    delete fileInfo.progress;
    this.destroyUploader(fileInfo.id);
    this._fileInfoCache[fileInfo.id] = fileInfo
  }, fileNotFound:function(fileId, url) {
    this.createErrorObject({id:fileId, name:fileId, url:url}, 1)
  }, resolveLinkAsFile:function(url, asObject) {
    var r = new RegExp("^http(?:s)?://(?:" + this.FILE_DOMAINS.join("|") + ")/(?:get/|files/(?:get\\?fileId=)?)?([0-9a-zA-Z_\\-]{32,33}|[0-9a-zA-Z_\\-]{50,})(?:\\n(.+))?$");
    var res = url.match(r);
    return res && res[1] ? asObject ? {text:res[2], id:res[1], url:url.replace("\n" + res[2], "")} : res[1] : false
  }, resolveLinkAsFileText:function(text, reqCallback) {
    var fileId, mess, data = this.resolveLinkAsFile(text, true);
    if(data) {
      fileId = data.id;
      mess = data.text;
      if(mess) {
        text = mess
      }else {
        if(this.isPttFile(fileId)) {
          text = WA.tr("cl.voiceMessage")
        }else {
          if(this.isImageFile(fileId)) {
            text = WA.tr("cl.photo")
          }else {
            if(this.isVideoFile(fileId)) {
              text = WA.tr("cl.video")
            }else {
              var fileInfo = this.getLocalFileInfo(fileId);
              if(fileInfo) {
                text = U.String.htmlEntity(fileInfo.name)
              }else {
                if(reqCallback) {
                  this.requestFileInfo(fileId, data.url, reqCallback)
                }
              }
            }
          }
        }
      }
      return text
    }
  }, setRequestCallback:function(cb) {
    this._requestCallback = cb
  }, getPreviewCode:function(fileId, url) {
    var fileInfo = this.requestFileInfo(fileId, url);
    var prefix = WA.fileTools.isImageFile(fileId) ? "" : '<div class="nwa-message-prefile">' + WA.tr("dialog.sentYouAFile") + "</div>";
    return prefix + "<div>" + this.generateHTML(fileInfo || fileId, url) + "</div>"
  }, _fileInfoCache:{}, isImageFile:function(fileId) {
    var ret = this._isImageId(fileId);
    if(!ret) {
      ret = fileId.length == 32 && this._fileInfoCache[fileId] && this._fileInfoCache[fileId].is_previewable && this._fileInfoCache[fileId].preview
    }
    return ret
  }, _isImageId:function(fileId) {
    var code = fileId.charCodeAt(0);
    return fileId.length == 33 && code > 47 && code < 56
  }, getFileTypeTitle:function(fileId) {
    return WA.tr(this._isImageId(fileId) ? "file.typeImage" : "file.typeFile")
  }, getLocalFileInfo:function(fileId) {
    return this._fileInfoCache[fileId]
  }, getUploadedFileInfo:function(fileId) {
    return this._fileUploaders[fileId] && this._fileUploaders[fileId].info
  }, requestFileInfo:function(fileId, url) {
    if(this._fileInfoCache[fileId]) {
      if(this._fileInfoCache[fileId].expiredTime && this._fileInfoCache[fileId].expiredTime < WA.now()) {
        delete this._fileInfoCache[fileId]
      }else {
        this.loadEvent.fire(fileId);
        return this._fileInfoCache[fileId]
      }
    }
    WA.FileApi.getFileInfo(fileId, function(fileList) {
      if(fileList) {
        this._fileInfoCache[fileId] = this.fetchFileObj(fileId, fileList[0], url)
      }else {
        this.fileNotFound(fileId, url)
      }
      this.loadEvent.fire(fileId)
    }.bind(this))
  }, generateUploaderHTML:function(uid) {
    if(this._fileInfoCache[uid]) {
      return this.generateHTML(this._fileInfoCache[uid])
    }
    if(this._fileUploaders[uid]) {
      return this.generateHTML(this._fileUploaders[uid].info)
    }
    return""
  }, generateHTML:function(fileObj, url) {
    var fileIsNotReady = WA.isString(fileObj), fileIsUploading = fileObj.progress !== undefined, _oldFormat = false, _previewHTML = "", _wrapStyle = "", _wrapClass = [], _objectHTML = "", _progressHTML = "", _titleHTML = "";
    if(fileIsNotReady) {
      fileObj = {id:fileObj, name:fileObj, url:url}
    }
    if(!fileObj.url && url) {
      fileObj.url = url
    }
    if(fileObj.errorCode != null) {
      fileObj.type = "";
      _wrapClass.push("nwa-file_error")
    }
    _titleHTML = U.String.parseTemplate(fileObj.url ? TITLE_HTML : TITLE_PLAIN_HTML, {url:fileObj.url, name:U.String.htmlEntity(fileObj.name)});
    if(fileIsNotReady || fileIsUploading) {
      _objectHTML = U.String.parseTemplate(OBJECT_HTML, {id:fileObj.id, name:fileIsUploading ? this.UPLOAD_PREFIX : this.FILE_PREFIX})
    }
    var size = this.getSizeById(fileObj.id);
    if(!size && fileObj.is_previewable && fileObj.preview) {
      size = [194, 194];
      _oldFormat = true
    }
    if(size) {
      var k = size[0] / size[1], w = size[0], h = size[1];
      if(k >= 1 && w > PREVIEW_MAX_SIZE) {
        w = PREVIEW_MAX_SIZE;
        h = Math.round(w / k)
      }else {
        if(k < 1 && h > PREVIEW_MAX_SIZE) {
          h = PREVIEW_MAX_SIZE;
          w = Math.round(h * k)
        }
      }
      var showPreview = w > 4 && h > 4 && (fileObj.preview || fileIsNotReady);
      if(showPreview) {
        var _pw = w > PREVIEW_MIN_SIZE ? w : PREVIEW_MIN_SIZE, _ph = h > PREVIEW_MIN_SIZE ? h : PREVIEW_MIN_SIZE, _dl = Math.floor((_pw - PREVIEW_DROP_WIDTH) / 2), _dt = Math.floor((_ph - PREVIEW_DROP_HEIGHT) / 2), _ul = w < PREVIEW_MIN_SIZE ? Math.floor((PREVIEW_MIN_SIZE - w) / 2) : 0, _ut = h < PREVIEW_MIN_SIZE ? Math.floor((PREVIEW_MIN_SIZE - h) / 2) : 0;
        _wrapStyle = "width:" + _pw + "px;height:" + _ph + "px;";
        if(_oldFormat) {
          _wrapStyle += "line-height:194px;"
        }
        if(fileObj.preview) {
          _previewHTML = U.String.parseTemplate(IMAGE_PREVIEW_HTML, {url:url || fileObj.orig_url, url_style:_oldFormat ? "position:relative;display:inline-block;vertical-align:middle;line-height:normal;" : "left:" + _ul + "px;top:" + _ut + "px;", img:fileObj.preview, img_style:_oldFormat ? "" : "width:" + w + "px;height:" + h + "px;"});
          _previewHTML += U.String.parseTemplate(DOWNLOAD_BUTTON_HTML, {url:fileObj.url, url_preview:url || fileObj.orig_url, style:"left:" + _dl + "px;top:" + _dt + "px"})
        }
        _wrapClass.push("nwa-file_preview")
      }
    }
    if(fileIsUploading) {
      _progressHTML = U.String.parseTemplate(PROGRESSBAR_HTML, {progress:fileObj.progress, id:fileObj.id});
      _wrapClass.push("nwa-file_uploading")
    }
    return U.String.parseTemplate(FILE_BOX_HTML, {object:_objectHTML, wrap_cls:_wrapClass.join(" "), wrap_style:_wrapStyle, file_info:fileObj.errorMsg || fileObj.size || "", file_extension:fileObj.type || "", file_title:_titleHTML, file_preview:_previewHTML, progressbar:_progressHTML})
  }, getSizeById:function(id) {
    function _dig(s) {
      var a = "0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ";
      return a.indexOf(s)
    }
    if(!WA.isString(id) || !this._isImageId(id)) {
      return null
    }
    var w = _dig(id.charAt(1)) * 62 + _dig(id.charAt(2));
    var h = _dig(id.charAt(3)) * 62 + _dig(id.charAt(4));
    return[w, h]
  }, formatFileSize:function(bytes) {
    if(bytes > MEGABYTE) {
      bytes = (Math.round(bytes * 10 / MEGABYTE) / 10).toString().replace(/\./, ",") + "MB"
    }else {
      bytes = (Math.round(bytes * 10 / 1024) / 10).toString().replace(/\./, ",") + "KB"
    }
    return bytes
  }, _fileUploaders:{}, _index:{}, updateUploaderProgress:function(uid, objectNode) {
    if(this._fileUploaders[uid]) {
      this._fileUploaders[uid].updateProgressNode(WA.get(objectNode).next().last().first())
    }
  }, destroyUploader:function(uid) {
    if(this._fileUploaders[uid]) {
      var email = this._fileUploaders[uid].email;
      if(this._index[email]) {
        var i = this._index[email].indexOf(uid);
        if(i > -1) {
          this._index[email].splice(i, 1)
        }
      }
      delete this._fileUploaders[uid]
    }
  }, getFileUploadersByMail:function(email) {
    if(!this._index[email]) {
      return false
    }
    var ret = [], inds = this._index[email];
    for(var i = 0;i < inds.length;i++) {
      if(this._fileUploaders[inds[i]]) {
        ret.push({id:inds[i], timestamp:this._fileUploaders[inds[i]].timestamp})
      }
    }
    return ret
  }, abort:function(uid) {
    uid && this._fileUploaders[uid] && this._fileUploaders[uid].abort()
  }, getFileType:function(fileName, mimeType) {
    var type = fileName.indexOf(".") > -1 ? fileName.split(".").pop().toLowerCase() : "";
    if(type.length > 4) {
      type = ""
    }
    return type
  }}
})();
WebAgent.UserAttend = function() {
  var WA = WebAgent;
  var U = WA.util;
  var UserAttend = WA.extend(Object, {constructor:function() {
    this.attendEvent = new U.Event;
    WA.fly(window).on("blur", this._onIntermediateBlur, this);
    WA.fly(window).on("focus", this._onIntermediateBlur, this);
    this._attendChecker = new U.DelayedTask({interval:1E3, fn:this._checkAttend, scope:this})
  }, isAttend:false, _userActivityDate:+new Date, _onMouseMove:function() {
    this._userActivityDate = +new Date;
    if(this.__focusTmr) {
      clearTimeout(this.__focusTmr);
      this.__focusTmr = false
    }
  }, _checkAttend:function() {
    var now = +new Date;
    if(now - this._userActivityDate > 1E3 * 60) {
      this._onBlur()
    }
  }, __focusTmr:false, _onIntermediateBlur:function() {
    clearTimeout(this.__focusTmr);
    this.__focusTmr = WA.setTimeout(WA.createDelegate(this._onBlur, this), 10)
  }, _onBlur:function() {
    if(this.isAttend) {
      this.__focusTmr = false;
      this.isAttend = false
    }
  }, onActivity:function() {
    if(!this.isAttend) {
      this.isAttend = true;
      this.attendEvent.fire()
    }
  }, forceActivity:function() {
    this.attendEvent.fire()
  }, activate:function() {
    WA.getBody().on("mousemove", this._onMouseMove, this);
    WA.debug.Console.log("UserAttend.activate");
    WA.get("wa-root").on("click", this.onActivity, this).on("keydown", this.onActivity, this);
    WA.FocusManager.ifFocused(this.onActivity, null, this)
  }, deactivate:function() {
    WA.getBody().un("mousemove", this._onMouseMove, this);
    WA.debug.Console.log("UserAttend.deactivate");
    WA.get("wa-root").un("click", this.onActivity, this).un("keydown", this.onActivity, this);
    this.isAttend = false
  }});
  return new UserAttend
}();
(function() {
  var WA = WebAgent, U = WA.util, ConnectionRoster = WA.conn.ConnectionRoster;
  var ChatController = WA.extend(ConnectionRoster, {constructor:function() {
    ChatController.superclass.constructor.apply(this, arguments);
    this.infoSets = {};
    this.stampMap = {};
    this._blockingMembers = {};
    this._waitingFullData = {};
    this._requestedInfo = {};
    this._requestedBlocked = {};
    this._requestedPending = {};
    this._membersRoleCache = {};
    this._modifyRoleByAction = {"removeAdminRights":"member", "giveAdminRights":"moder", "forbidWriting":"readonly", "allowWriting":"member"};
    this.blockedMembers = {};
    this.infoReadyEvent = new U.Event;
    this.chatCreatedEvent = new U.Event;
    WA.ChangeLog.updateEvent.on(this._onChangeLogUpdate, this)
  }, getCachedChatInfo:function(chat_id) {
    return this.infoSets[chat_id]
  }, getChatInfoByStamp:function(stamp, limit, nocache) {
    if(this.stampMap[stamp] && !nocache) {
      this.getChatInfo(this.stampMap[stamp], limit, nocache)
    }else {
      if(this._requestedInfo[stamp] && (!this._requestedInfo[stamp].limit || limit && this._requestedInfo[stamp].limit >= limit)) {
        return
      }
      this._requestedInfo[stamp] = {limit:limit || 0};
      WA.IcqRapi.getChatInfo({stamp:stamp, limit:limit}, function(status) {
        delete this._requestedInfo[stamp];
        if(status !== 200) {
          this.infoReadyEvent.fire(null, false, status, stamp)
        }
      }, this)
    }
  }, getChatInfo:function(chat_id, limit, nocache, withBlocked) {
    var limitIsOk;
    if(this.infoSets[chat_id]) {
      limitIsOk = limit ? this.infoSets[chat_id].members.length >= limit || this.infoSets[chat_id].membersCount <= limit : this.infoSets[chat_id].members.length >= this.infoSets[chat_id].membersCount
    }
    if(this._waitingFullData[chat_id]) {
      return
    }
    if(!nocache && limitIsOk && (!withBlocked || this.infoSets[chat_id].blockedList)) {
      this.infoReadyEvent.fire(chat_id, true, this.infoSets[chat_id], this.infoSets[chat_id].stamp)
    }else {
      if(withBlocked) {
        this._waitingFullData[chat_id] = {blocked:false, info:false, email:chat_id};
        this.getBlockedMembers(chat_id)
      }
      if(this._requestedInfo[chat_id] && (!this._requestedInfo[chat_id].limit || limit && this._requestedInfo[chat_id].limit >= limit)) {
        return
      }
      this._requestedInfo[chat_id] = {limit:limit || 0};
      WA.IcqRapi.getChatInfo({email:chat_id, limit:limit}, function(status) {
        if(status !== 200) {
          delete this._requestedInfo[chat_id];
          delete this._requestedPending[chat_id];
          if(this._waitingFullData[chat_id]) {
            delete this._waitingFullData[chat_id]
          }
          this.infoReadyEvent.fire(chat_id, false, status, this.infoSets[chat_id] && this.infoSets[chat_id].stamp || null)
        }
      }, this)
    }
  }, getBlockedMembers:function(chat_id) {
    if(this._requestedBlocked[chat_id]) {
      return
    }
    this._requestedBlocked[chat_id] = true;
    WA.IcqRapi.getBlockedMembers(chat_id, function(status, reqId, fullCode) {
      if(status !== 200) {
        delete this._requestedBlocked[chat_id];
        if(this._waitingFullData[chat_id]) {
          delete this._waitingFullData[chat_id]
        }
        this.infoReadyEvent.fire(chat_id, false, status, this.infoSets[chat_id] && this.infoSets[chat_id].stamp || null)
      }
    }, this)
  }, getPendingList:function(chat_id) {
    if(this._requestedPending[chat_id]) {
      return
    }
    this._requestedPending[chat_id] = true;
    WA.IcqRapi.getPendingList(chat_id, function(status) {
      if(status !== 200) {
        delete this._requestedPending[chat_id];
        this.infoReadyEvent.fire(chat_id, false, status, this.infoSets[chat_id] && this.infoSets[chat_id].stamp)
      }
    }, this)
  }, getMemberRole:function(chat_id, member) {
    var res;
    if(this.infoSets[chat_id] && this.infoSets[chat_id].members) {
      var ind = U.Array.indexOfBy(this.infoSets[chat_id].members, function(it) {
        return it.email === member
      });
      if(ind > -1 && this.infoSets[chat_id].members[ind]) {
        res = this.infoSets[chat_id].members[ind]
      }
    }
    if(!res && this._membersRoleCache[chat_id]) {
      res = this._membersRoleCache[chat_id][member]
    }
    return res && res.role || "member"
  }, addMembers:function(chat_id, members, cb, scope) {
    WA.IcqApi.addChatMembers({email:chat_id, members:members}, function(success) {
      cb && cb.call(scope, success)
    }, this)
  }, delMembers:function(chat_id, members, cb, scope) {
    WA.IcqApi.delChatMembers({email:chat_id, members:members}, function(success) {
      cb && cb.call(scope, success)
    }, this)
  }, blockMembers:function(chat_id, members, cb, scope) {
    this._blockingMembers[chat_id] = members;
    WA.IcqRapi.blockChatMembers({email:chat_id, members:members}, function(status) {
      if(status === 200) {
        if(this._waitingFullData[chat_id]) {
          return
        }
        if(this.infoSets[chat_id] && this._blockingMembers[chat_id] && this._blockingMembers[chat_id] === members) {
          this.infoSets[chat_id].blockedCount = (this.infoSets[chat_id].blockedCount || 0) + members.length;
          this.infoSets[chat_id].blockedList = this.infoSets[chat_id].blockedList || [];
          var blocked = {}, newMembers = [];
          U.Array.each(members, function(it) {
            blocked[it.sn] = true;
            this.infoSets[chat_id].blockedList.push({email:it.sn})
          }, this);
          U.Array.each(this.infoSets[chat_id], function(it) {
            if(!blocked[it.email]) {
              newMembers.push(it)
            }
          });
          this.infoSets[chat_id].members = newMembers;
          this.infoReadyEvent.fire(chat_id, true, this.infoSets[chat_id], this.infoSets[chat_id].stamp)
        }
      }
      cb && cb.call(scope, status)
    }, this)
  }, unblockMembers:function(chat_id, members, cb, scope) {
    WA.IcqRapi.unblockChatMembers({email:chat_id, members:members}, function(status) {
      if(status === 200) {
        if(this._waitingFullData[chat_id]) {
          return
        }
        var needFire;
        if(this.infoSets[chat_id]) {
          this.infoSets[chat_id].blockedCount = Math.max(0, (this.infoSets[chat_id].blockedCount || 0) - members.length);
          needFire = true
        }
        if(this.infoSets[chat_id].blockedList) {
          var newBlocked = [], unblocked = {};
          U.Array.each(members, function(it) {
            unblocked[it.sn] = true
          });
          U.Array.each(this.infoSets[chat_id].blockedList, function(it) {
            if(!unblocked[it.email]) {
              newBlocked.push(it)
            }
          });
          this.infoSets[chat_id].blockedList = newBlocked;
          needFire = true
        }
        needFire && this.infoReadyEvent.fire(chat_id, true, this.infoSets[chat_id], this.infoSets[chat_id].stamp)
      }
      cb && cb.call(scope, status)
    }, this)
  }, modifyMember:function(data) {
    WA.IcqRapi.modifyChatMember(data, function(status, reqId, fullCode) {
      if(status === 201 || status === 200) {
        this._onConnectionChatMember({mail:data.email, timestamp:WA.now(), memberEvent:{type:"roleChanged", role:data.role, members:[data.member]}})
      }
    }, this)
  }, resolvePending:function(data) {
    WA.IcqRapi.resolvePending(data)
  }, createChat:function(members, name, cb, scope, optional) {
    var params = {members:members, name:name};
    if(typeof optional === "object") {
      params = U.Object.extend(params, optional)
    }
    WA.IcqRapi.createChat(params, function(status, reqId) {
      cb && cb.call(scope, status, reqId)
    }, this)
  }, onUpdateClistData:function() {
    var chat_ids = [];
    U.Object.each(this.infoSets, function(iSet, chat_id) {
      if(!iSet.members) {
        return
      }
      U.Array.each(iSet.members, function(it) {
        var nick = WA.CLD.getFriendlyName(it.email), inList = !!WA.CLD.getInfoArray(it.email);
        if(nick && it.nickname != nick) {
          if(U.Array.indexOf(chat_ids, chat_id) === -1) {
            chat_ids.push(chat_id)
          }
          it.nickname = nick
        }
        if(it.inCL !== inList) {
          if(U.Array.indexOf(chat_ids, chat_id) === -1) {
            chat_ids.push(chat_id)
          }
          it.inCL = inList
        }
        if(!iSet.blockedList) {
          return
        }
        U.Array.each(iSet.blockedList, function(it) {
          var nick = WA.CLD.getFriendlyName(it.email);
          if(nick && it.nickname != nick) {
            if(U.Array.indexOf(chat_ids, chat_id) === -1) {
              chat_ids.push(chat_id)
            }
            it.nickname = nick
          }
        }, this)
      }, this)
    }, this);
    U.Array.each(chat_ids, function(id) {
      if(this._waitingFullData[id]) {
        return
      }
      this.infoReadyEvent.fire(id, true, this.infoSets[id], this.infoSets[id].stamp)
    }, this)
  }, _onChangeLogUpdate:function(logArr) {
    var chat_ids = [];
    U.Array.each(logArr, function(log) {
      var email = log.email || log.mail;
      var action = log.action;
      if(action === "auth") {
        action = "add"
      }
      if(action !== "add" && action !== "remove" || !email || WA.MainAgent.isChat(email)) {
        return
      }
      U.Object.each(this.infoSets, function(iSet, chat_id) {
        if(!iSet.members) {
          return
        }
        var ind = U.Array.indexOfBy(iSet.members, function(it) {
          return it.email === email
        });
        if(ind > -1) {
          if(U.Array.indexOf(chat_ids, chat_id) === -1) {
            chat_ids.push(chat_id)
          }
          iSet.members[ind].inCL = action === "add"
        }
      }, this)
    }, this);
    U.Array.each(chat_ids, function(id) {
      if(this._waitingFullData[id]) {
        return
      }
      this.infoReadyEvent.fire(id, true, this.infoSets[id], this.infoSets[id].stamp)
    }, this)
  }, _onConnectionChatCreated:function(chats) {
    U.Array.each(chats, function(it) {
      this.chatCreatedEvent.fire(it.sendReqIdStr, WA.makeContactArray(it.sender, it.chat_name))
    }, this)
  }, _onConnectionChatInfo:function(data) {
    WA.ma.contactList.getContactsInfo(data.membersList, function(items) {
      if(items) {
        var ind;
        U.Array.each(data.members, function(it) {
          ind = items.indexOf(it.email);
          if(ind > -1) {
            it.inCL = true;
            it.nickname = WA.CLD.getFriendlyName(it.email);
            items.splice(ind, 1)
          }
        })
      }
      var blocked, pending;
      if(this.infoSets[data.sn]) {
        blocked = this.infoSets[data.sn].blockedList;
        pending = this.infoSets[data.sn].pendingList
      }
      this.infoSets[data.sn] = data;
      this.stampMap[data.stamp] = data.sn;
      delete this._requestedInfo[data.sn];
      delete this._requestedInfo[data.stamp];
      if(blocked) {
        this.infoSets[data.sn].blockedList = blocked
      }
      if(pending) {
        this.infoSets[data.sn].pendingList = pending
      }
      if(this._waitingFullData[data.sn]) {
        this._waitingFullData[data.sn].info = true;
        if(!this._waitingFullData[data.sn].blocked) {
          return
        }
        this.infoSets[data.sn].blockedList = this._waitingFullData[data.sn].blocked;
        delete this._waitingFullData[data.sn]
      }
      if(this._requestedPending[data.sn] && this._requestedPending[data.sn].list) {
        data.pendingList = this._requestedPending[data.sn].list;
        delete this._requestedPending[data.sn]
      }
      this.infoReadyEvent.fire(data.sn, true, data, data.stamp)
    }, this, true)
  }, _onConnectionPendingList:function(data) {
    if(!this.infoSets[data.sn]) {
      this._requestedPending[data.sn] = {list:data.list};
      if(!this._requestedInfo[data.sn]) {
        this._requestedInfo[data.sn] = {limit:1};
        WA.IcqRapi.getChatInfo({email:data.sn, limit:1}, function(status) {
          if(status !== 200) {
            delete this._requestedPending[data.sn];
            delete this._requestedInfo[data.sn];
            if(this._waitingFullData[data.sn]) {
              delete this._waitingFullData[data.sn]
            }
            this.infoReadyEvent.fire(data.sn, false, status, null)
          }
        }, this)
      }
      return
    }
    delete this._requestedPending[data.sn];
    this.infoSets[data.sn].pendingList = data.list;
    this.infoReadyEvent.fire(data.sn, true, this.infoSets[data.sn], this.infoSets[data.sn].stamp)
  }, _onConnectionBlockedMembers:function(data) {
    delete this._requestedBlocked[data.sn];
    if(this._waitingFullData[data.sn]) {
      this._waitingFullData[data.sn].blocked = data.list;
      if(!this._waitingFullData[data.sn].info) {
        return
      }
      delete this._waitingFullData[data.sn]
    }
    if(!this.infoSets[data.sn]) {
      this._waitingFullData[data.sn] = {blocked:data.list, info:false};
      if(!this._requestedInfo[data.sn]) {
        WA.IcqRapi.getChatInfo({email:data.sn, limit:1}, function(status) {
          if(status !== 200) {
            delete this._requestedPending[data.sn];
            delete this._requestedInfo[data.sn];
            if(this._waitingFullData[data.sn]) {
              delete this._waitingFullData[data.sn]
            }
            this.infoReadyEvent.fire(data.sn, false, status, null)
          }
        }, this)
      }
      return
    }
    this.infoSets[data.sn].blockedList = data.list;
    this.infoReadyEvent.fire(data.sn, true, this.infoSets[data.sn], this.infoSets[data.sn].stamp)
  }, _onConnectionChatModified:function(data) {
    if(this.infoSets[data.mail]) {
      var changed;
      if(data.modifiedInfo) {
        if(data.modifiedInfo.hasOwnProperty("about")) {
          this.infoSets[data.mail].about = data.modifiedInfo.about;
          changed = true
        }
        if(data.modifiedInfo.hasOwnProperty("name")) {
          this.infoSets[data.mail].name = data.modifiedInfo.name;
          changed = true
        }
        switch(data.eventTypeId) {
          case "27:39000":
            this.infoSets[data.mail]["public"] = true;
            changed = true;
            break;
          case "27:40000":
            this.infoSets[data.mail]["public"] = false;
            changed = true;
            break;
          case "27:57500":
            this.infoSets[data.mail].ageRestriction = true;
            changed = true;
            break;
          case "27:57600":
            this.infoSets[data.mail].ageRestriction = false;
            changed = true;
            break;
          case "27:57100":
            this.infoSets[data.mail].controlled = this.infoSets[data.mail].joinModeration = true;
            changed = true;
            break;
          case "27:57200":
            this.infoSets[data.mail].joinModeration = false;
            this.infoSets[data.mail].controlled = !!this.infoSets[data.mail].live;
            changed = true;
            break;
          case "27:57700":
            this.infoSets[data.mail].defaultRole = "readonly";
            changed = true;
            break;
          case "27:57800":
            this.infoSets[data.mail].defaultRole = "member";
            changed = true;
            break;
          case "27:57300":
            this.infoSets[data.mail].controlled = this.infoSets[data.mail].live = true;
            changed = true;
            break;
          case "27:57400":
            this.infoSets[data.mail].live = false;
            this.infoSets[data.mail].controlled = !!this.infoSets[data.mail].joinModeration;
            changed = true;
            break
        }
      }else {
        if(this.infoSets[data.mail].members && this.infoSets[data.mail].members.length > 1) {
          this.getChatInfo(data.mail, this.infoSets[data.mail].members.length, true);
          return
        }
      }
      if(changed) {
        if(this._waitingFullData[data.mail]) {
          return
        }
        this.infoReadyEvent.fire(data.mail, true, this.infoSets[data.mail], this.infoSets[data.mail].stamp)
      }
    }
    if(data.modifiedInfo && data.modifiedInfo.avatarLastModified) {
      WA.Ava.update(data.mail)
    }
  }, _onConnectionChatMember:function(data) {
    var infoMembers = this.infoSets[data.mail] && this.infoSets[data.mail].members;
    var changed, needReload;
    if(!data.memberEvent) {
      return
    }
    if(data.memberEvent.type === "roleChanged") {
      var members = {}, timestamp = data.timestamp, arch_id = data.msgId, role = data.memberEvent.role, roleCache = this._membersRoleCache[data.mail] || {};
      U.Array.each(data.memberEvent.members, function(it) {
        var cond = !roleCache[it] || (roleCache[it].arch_id && arch_id ? roleCache[it].arch_id < arch_id : roleCache[it].timestamp <= timestamp);
        if(cond) {
          members[it] = true;
          roleCache[it] = {role:role, timestamp:timestamp, arch_id:arch_id}
        }
      });
      if(infoMembers) {
        U.Array.each(infoMembers, function(it) {
          if(members[it.email]) {
            it.role = role;
            changed = true
          }
        })
      }
      this._membersRoleCache[data.mail] = roleCache
    }else {
      if(infoMembers) {
        var pendingList = this.infoSets[data.mail].pendingList;
        var added = {}, newPending = [];
        U.Array.each(data.memberEvent.members, function(it) {
          var ind = U.Array.indexOfBy(infoMembers, function(memb) {
            return memb.email === it
          });
          if(ind === -1 && "addMembers,invite,".indexOf(data.memberEvent.type + ",") > -1) {
            needReload = true;
            infoMembers.push({email:it, role:"member"});
            this.infoSets[data.mail].membersCount++;
            added[it] = true
          }else {
            if(ind !== -1 && "delMembers,kicked,leave,".indexOf(data.memberEvent.type + ",") > -1) {
              if(it === WA.ACTIVE_MAIL) {
                needReload = true;
                delete this.infoSets[data.mail];
                return false
              }
              changed = true;
              infoMembers.splice(ind, 1);
              this.infoSets[data.mail].membersCount--
            }
          }
        }, this);
        if(pendingList && pendingList.length) {
          U.Array.each(pendingList, function(memb) {
            if(!added[memb.sn]) {
              newPending.push(memb)
            }
          });
          this.infoSets[data.mail].pendingList = newPending
        }
      }
    }
    if(needReload) {
      delete this._blockingMembers[data.mail];
      WA.IcqRapi.getChatInfo({email:data.mail}, function(status) {
        if(status !== 200) {
          if(this._waitingFullData[data.mail]) {
            delete this._waitingFullData[data.mail]
          }
          this.infoReadyEvent.fire(data.mail, false, status, this.infoSets[data.mail] && this.infoSets[data.mail].stamp)
        }
      }, this)
    }else {
      if(changed) {
        if(this._waitingFullData[data.mail]) {
          return
        }
        this.infoReadyEvent.fire(data.mail, true, this.infoSets[data.mail], this.infoSets[data.mail].stamp)
      }
    }
  }});
  WA.chatController = new ChatController
})();
(function() {
  var WA = WebAgent;
  var U = WA.util;
  var SOCK = WA.ConnectionFacade;
  var FM = WA.FocusManager;
  var ConnectionRoster = WA.conn.ConnectionRoster;
  var JSON = WA.getJSON();
  var S = WA.Storage;
  var _firstLoad = true;
  var RELOAD_HISTORY_ON_REFRESH = true;
  var HISTORY_PART_VOLUME = 20;
  var MESSAGE_RESEND_TIMEOUT = 3E3;
  var CRITICAL_ERROR_CODES = [400, 401, 462, 600, 601, 602, 603, 606];
  var chatEventsMap = {"addMembers":["chat.message.attached", "chat.message.add", "chat.message.attached"], "invite":["chat.message.invite", "", "chat.message.attached"], "delMembers":["chat.message.detached", "chat.message.del", "chat.message.detached"], "kicked":["chat.message.turnOut", "", "chat.message.detached"], "leave":["chat.message.detached"], "rename":["chat.message.rename", "", "chat.message.youRename"], "modify":["chat.message.modifyAbout", "", "chat.message.youModifyAbout"], "changeIcon":["chat.message.changeIcon", 
  "", "chat.message.youChangeIcon"]};
  var dialogEventsMap = {"bday":["dialog.hasBirthdayToday"], "addedToBuddyList":["dialog.youAddToCL", "dialog.addedYouToCL"], "buddyReg":["dialog.nowAvailableFroChat"], "buddyFound":["dialog.nowAvailableFroChat"], "voip":["dialog.outgoingCall", "dialog.incomingCall"]};
  function buildEventMessage(mes, isChat) {
    var text = mes.text, eventType = typeof mes.event === "string" ? mes.event : false, eventInfo = mes.info, outgoing = mes.from === WA.ACTIVE_MAIL;
    if(eventInfo) {
      if(!text && isChat) {
        if(eventInfo.members) {
          if(chatEventsMap[eventType]) {
            var members = [], chatMessageType = chatEventsMap[eventType];
            U.Array.each(eventInfo.members, function(it) {
              members.push(it)
            });
            text = WA.tr(chatMessageType[eventInfo.self ? outgoing ? 2 : 0 : 1] || chatMessageType[0], [eventInfo.sender, members.join(", ")])
          }
        }else {
          if(eventInfo.name || eventInfo.about) {
            text = WA.tr(chatEventsMap[eventType][outgoing ? 2 : 0], [eventInfo.sender, eventInfo.name || U.String.ellipsis(eventInfo.about, 40)])
          }else {
            if(eventType === "changeIcon") {
              text = WA.tr(chatEventsMap[eventType][outgoing ? 2 : 0], [eventInfo.sender])
            }
          }
        }
      }else {
        text = WA.tr(dialogEventsMap[eventType][outgoing ? 0 : 1] || dialogEventsMap[eventType][0], [eventInfo.sender, eventInfo[eventType] && eventInfo[eventType].data])
      }
    }
    return WA.Emoji.parse(U.String.htmlEntity(text))
  }
  var object2string = function(object) {
    var ret;
    if(WA.isObject(object)) {
      ret = [];
      U.Object.each(object, function(val, key) {
        ret.push(key + ": " + val)
      });
      ret = "{" + ret.join(", ") + "}"
    }else {
      ret = "" + object
    }
    return ret
  };
  var StatusAccumulator = WA.extend(ConnectionRoster, {constructor:function() {
    StatusAccumulator.superclass.constructor.apply(this, arguments);
    this._log = {};
    this._tel = {}
  }, _onConnectionContactStatus:function(value) {
    if(!this._log[value.email]) {
      this._log[value.email] = {}
    }
    if(value.status) {
      this._log[value.email].status = value.status.type;
      this._log[value.email].statusTitle = value.status.title
    }else {
      var clData = WA.CLD.getInfo(value.email);
      if(clData && clData.status) {
        this._log[value.email].status = clData.status;
        this._log[value.email].statusTitle = clData.statusTitle
      }else {
        this._log[value.email].status = "gray"
      }
    }
    if(value.nickname) {
      this._log[value.email].nick = value.nickname
    }
    if(!this._log[value.email].nick) {
      this._log[value.email].nick = value.email
    }
    if(value.features) {
      this._log[value.email].features = value.features
    }
    var phones = value.phones;
    if(phones) {
      this._log[value.email].phones = U.Array.clone(phones);
      U.Array.each(phones, function(tel) {
        this._tel[tel] = value.email
      }, this)
    }
  }, _onConnectionContactModifySuccess:function(value) {
    var phones = value.phones;
    if(phones) {
      U.Array.each(phones, function(tel) {
        this._tel[tel] = value.email
      }, this)
    }
  }, get:function(mail) {
    if(this._log[mail]) {
      return{nick:this._log[mail].nick, status:this._log[mail].status, statusTitle:this._log[mail].statusTitle, features:this._log[mail].features, phones:U.Array.clone(this._log[mail].phones || []), mail:mail}
    }else {
      return{}
    }
  }, getArray:function(email) {
    var cast = this.get(email);
    if(!cast.mail) {
      return null
    }
    return[email, cast.nick, +(cast.status == "gray" || cast.status == "icq_gray"), cast.status || "", cast.statusTitle || "", U.Array.clone(cast.phones || []), cast.features]
  }, getByTel:function(tel) {
    if(this._tel[tel]) {
      var mail = this._tel[tel];
      return this.get(mail)
    }else {
      return{}
    }
  }, destroy:function() {
    delete this._log;
    delete this._tel;
    StatusAccumulator.superclass.destroy.apply(this, arguments)
  }});
  var SA = WA.SA = new StatusAccumulator;
  var IncomingMessage = WA.IncomingMessage = WA.extend(Object, {constructor:function(value) {
    var message = this._loadSAInfo(value);
    var mail = message.mail || value.from;
    WA.applyIf(message, {nick:value.nickname});
    message.arch_id = value.arch_id;
    message.from = mail;
    message.date = value.timestamp;
    message.text = value.text;
    message.offline = !!value.offline;
    message.unreaded = 1;
    if(value.sticker) {
      message.sticker = value.sticker
    }
    this.data = message
  }, _loadSAInfo:function(value) {
    return SA.get(value.from)
  }});
  var AuthMessage = WA.extend(IncomingMessage, {constructor:function(value) {
    AuthMessage.superclass.constructor.call(this, value);
    WA.applyIf(this.data, {nick:this.data.from, status:"gray"});
    this.data.message_id = value.uidl || value.message_id;
    this.data.auth = 1
  }});
  var ServiceMessage = WA.extend(Object, {constructor:function(value) {
    this.data = {message_id:(Math.random() * 1E7).toFixed(0), voip:true, from:value.from, date:value.date, title:value.title, text:value.text}
  }});
  var DynamicMessage = WA.extend(Object, {constructor:function(value) {
    this.data = {dynamic:true, from:value.from || WA.ACTIVE_MAIL, date:value.date, message_id:value.id, text:"upload"}
  }});
  var OutgoingMessage = WA.OutgoingMessage = WA.extend(ConnectionRoster, {UNDELIVERED_TIMEOUT:30, constructor:function(msg) {
    OutgoingMessage.superclass.constructor.apply(this, arguments);
    var now = WA.now();
    this.mail = msg.mail;
    this.text = msg.text;
    this.resend = msg.resend;
    this.data = {text:msg.text, date:msg.date || WA.TIME_INFINITY, localDate:msg.date || now, from:WA.ACTIVE_MAIL, message_id:(Math.random() * 1E7).toFixed(0), state:1, deliverExpired:0};
    if(WA.isObject(msg.text) && msg.text.pack_id) {
      var code = WA.Sticker.getStickerCode(msg.text.pack_id, msg.text.sticker_id);
      this.data.sticker = code;
      this.data.stickerText = WA.tr("notify.youHaveSticker");
      this.data.text = code
    }
    var timeout = msg.date ? msg.date + this.UNDELIVERED_TIMEOUT - now : this.UNDELIVERED_TIMEOUT;
    this._timer = WA.setTimeout(function() {
      this.data.deliverExpired = 1;
      this.data.date = this.data.localDate;
      if(SOCK.last410 > 0 && now - SOCK.last410 < 31) {
        U.Mnt.countRB(1346377)
      }
      this.updateEvent.fire(this.data.message_id);
      if(timeout > 0) {
        U.Mnt.countRB(1335024)
      }
    }, timeout > 0 ? timeout * 1E3 : 0, this);
    this.updateEvent = new U.Event
  }, send:function() {
    var text = this.data.text, userId = this.mail;
    var req = {to:userId, message_id:this.data.message_id, text:this.data.sticker ? this.data.stickerText : text, parse:this.data.parse || null, r:this.data.requestId || null};
    this.resendCount = this.resendCount || 0;
    if(++this.resendCount > 3) {
      this.data.date = this.data.localDate;
      this.data.deliverExpired = 1;
      this.data.state = -1;
      this.updateEvent.fire(this.data.message_id, "sendError");
      return
    }
    var callBack = function(success, code) {
      if(success) {
        this.updateEvent.fire(this.data.message_id, "sendOk")
      }else {
        if(CRITICAL_ERROR_CODES.indexOf(code) == -1) {
          WA.setTimeout(this.send, MESSAGE_RESEND_TIMEOUT, this)
        }else {
          this.data.date = this.data.localDate;
          this.data.deliverExpired = 1;
          this.data.state = -1;
          this.updateEvent.fire(this.data.message_id, "sendError")
        }
      }
    }.bind(this);
    WA.ma._sendStatistics();
    if(this.data.sticker) {
      req.code = this.data.sticker;
      this.data.requestId = WA.IcqApi.sendSticker(req, callBack)
    }else {
      if(WA.MainAgent.isTel(userId)) {
        req.sms = 1
      }
      this.data.requestId = WA.IcqApi.sendMessage(req, callBack)
    }
    WA.checkClienResolution(true)
  }, _onConnectionMessageSent:function(value) {
    if(value.message_id == this.data.message_id) {
      this.data.date = value.time || this.data.localDate;
      this._updateReadState(value.wimId, value.arch_id);
      this.updateEvent.fire(value.message_id, value.wimId)
    }
  }, _updateReadState:function(wimId, arch_id) {
    if(wimId) {
      this.data.wid = wimId
    }
    if(arch_id) {
      this.data.arch_id = this.data.mid = arch_id
    }
    if(this._timer) {
      clearTimeout(this._timer)
    }
    delete this.data.deliverExpired;
    delete this.data.state
  }, _onConnectionHistoryState:function(data) {
    if(this.mail === data.sn && this.data.wid) {
      if(!this.data.mid && data.messages) {
        var ind = U.Array.indexOfBy(data.messages, function(msg) {
          return msg.wid === this.data.wid
        }, this);
        if(data.messages[ind]) {
          this.data.arch_id = this.data.mid = data.messages[ind].msgId;
          this.data.date = data.messages[ind].time
        }
      }
      if(!this.data.mid) {
        return
      }
      this._updateReadState();
      var message_id = this.data.message_id;
      delete this.data.message_id;
      this.updateEvent.fire(message_id, this.data.wid)
    }
  }, destroy:function() {
    OutgoingMessage.superclass.destroy.apply(this, arguments);
    clearTimeout(this._timer);
    this.updateEvent.removeAll()
  }});
  var History = WA.extend(ConnectionRoster, {constructor:function(dialog) {
    History.superclass.constructor.apply(this, arguments);
    this.dialog = dialog;
    this.dialog.history = this.dialog.history || [];
    this.dialog.statesArch = this.dialog.statesArch || {};
    this.updateEvent = new U.Event;
    this._instances = {};
    this._patchCache = {};
    if(WA.MainAgent.isTel(this.dialog.mail)) {
      this.dialog.historyLoaded = true;
      this.dialog.history || (this.dialog.history = []);
      this.dialog.isTel = true
    }else {
      this._fetchHistory()
    }
  }, _createAuthMessage:function() {
    var cast = this.dialog.cast[this.dialog.mail];
    return WA.apply({from:this.dialog.mail, mail:this.dialog.mail, date:WA.now(), text:WA.tr("msgAddMePlease"), auth:1}, cast || {})
  }, _fetchHistory:function() {
    var now = WA.now();
    if(this.dialog.history) {
      var history = [];
      U.Array.each(this.dialog.history, function(data) {
        if(data.dynamic && !WA.fileTools.getUploadedFileInfo(data.message_id)) {
          return
        }
        if(data.auth) {
          this._has_auth = data.auth
        }
        if(data.from === WA.ACTIVE_MAIL && data.state) {
          var message = new OutgoingMessage({text:data.text, mail:this.dialog.mail, resend:!!data.resend, sticker:!!data.sticker});
          message.data = data;
          message.data.message_id = message.message_id;
          this._instances[message.message_id] = message;
          message.updateEvent.on(this._onMessageUpdate, this)
        }
        history.push(data)
      }, this);
      this.dialog.history = history;
      if(this.dialog.auth && !this._has_auth) {
        this.dialog.historyLoaded = true;
        if(this.dialog.history.length) {
          this.dialog.history[this.dialog.history.length - 1].auth = 1
        }else {
          this.dialog.history.push(this._createAuthMessage())
        }
      }
    }
  }, append:function(message) {
    this.dialog.history || (this.dialog.history = []);
    var updateTabs;
    if(message instanceof DynamicMessage) {
      updateTabs = true;
      if(this._indexOf(message.data, "message_id") > -1) {
        return
      }
    }
    if(message instanceof IncomingMessage && this._indexOf(message.data) > -1) {
      return
    }
    var msgId = message.data.message_id || message.data.arch_id;
    this.dialog.history.push(message.data);
    if(message.data.date) {
      this.dialog.lastMessageDate = message.data.date
    }
    if(message instanceof OutgoingMessage) {
      this._instances[message.data.message_id] = message;
      message.updateEvent.on(this._onMessageUpdate, this);
      updateTabs = true
    }
    if(message instanceof IncomingMessage && message.data.unreaded && !message.data.offline) {
      this.dialog.unreaded = 1;
      if(this.dialog.unreadCount < 999) {
        this.dialog.unreadCount++
      }
      updateTabs = true
    }
    if(message instanceof AuthMessage) {
      this.dialog.auth = true;
      this.dialog.historyLoaded = true
    }
    if(message instanceof IncomingMessage || message instanceof OutgoingMessage) {
      message = message.data.text || "";
      var ytb = /https?:\/\/(?:www\.)?youtu(?:\.be\/|be\.com\/watch\?(?:[^\&=]+=[^\&]*\&)*v=)([a-zA-Z0-9_-]+)/, notImage = /[^\s\n\t:\-]/, isImg = /(?:https?|ftp):\/\/(?:[\w\.-]+(?::\d*)?\/[^\s\?#]+\.(?:jpe?g|png|gif|bmp|tiff?)(?:(?:\?|#)\S*?)?)(?:[\.,\?!:;]*(?:\s|$))/ig;
      message.replace(/(https?:\/\/(?:[\w\.-]+(?::\d*)?(?:\/\S*?)?))(?:[\.,\?!:;]*(?:\s|$))/ig, function(ignored, href, index, all) {
      })
    }
    this.dialog.isRecent = true;
    this.updateEvent.fire(updateTabs)
  }, _onMessageUpdate:function(message_id, wimId) {
    var statesArch = this.dialog.statesArch;
    statesArch[wimId] && U.Array.each(this.dialog.history, function(item) {
      if(item.wid == wimId) {
        item.mid = statesArch[wimId].mid;
        item.arch_id = item.mid;
        item.wid = statesArch[wimId].wid;
        item.timestamp = statesArch[wimId].time;
        delete statesArch[wimId];
        return false
      }
    }, this);
    var message = this._instances[message_id];
    if(message && !message.data.message_id) {
      message.destroy();
      delete statesArch[wimId];
      delete this._instances[message_id]
    }
    this._sort();
    this.updateEvent.fire()
  }, loadPatch:function() {
    if(!this._requested && !this._patchRequested) {
      this._patchRequested = "get_patch";
      WA.IcqRapi.getHistory({email:this.dialog.mail, count:-1, patchVersion:this.dialog.patchVersion}, function(code) {
        if(code !== 200) {
          if(this._patchRequested === "get_patch") {
            this._patchRequested = false
          }
        }
      }, this)
    }
  }, load:function(firstHistMessId) {
    if(!this._requested && (!this.dialog.historyLoaded || typeof this.dialog.historyLoaded != "boolean" && firstHistMessId && this.dialog.historyLoaded !== firstHistMessId)) {
      this._requested = firstHistMessId || true;
      this._patchRequested = true;
      WA.IcqRapi.getHistory({email:this.dialog.mail, msgId:firstHistMessId, patchVersion:this.dialog.patchVersion}, function(code, reqId, fullCode) {
        if(code !== 200) {
          if(!this.dialog.historyLoaded) {
            if(fullCode === 40401) {
              this.dialog.historyLoaded = true;
              this.updateEvent.fire()
            }
          }
          this._requested = false
        }
      }, this)
    }
  }, _repackHistoryItem:function(item, parts, isChat, isUIN) {
    return{from:item.from, text:item.event ? buildEventMessage(item, isChat) : item.text, hidden:!!item.hidden, arch_id:item.arch_id, wid:item.wid || null, mid:item.mid || null, parts:parts, date:item.timestamp, event:item.event, parse:item.parse, sender:item.sender, senderFriendly:item.senderFriendly, sticker:item.sticker || null}
  }, _repack:function(arr) {
    var history = [], email = arr.email, patchCache = this._patchCache, isChat = WA.MainAgent.isChat(email), isUIN = email.indexOf("@uin.icq") > 0, parts;
    if(arr.history) {
      U.Array.each(arr.history, function(item) {
        if(item[1].hidden) {
          WA.log("SYSTEM MSG IGNORED:", item[1].text)
        }else {
          if(patchCache[item[1].arch_id]) {
            delete patchCache[item[1].arch_id]
          }else {
            parts = item[1].parts || null;
            if(parts && parts.length === 0) {
              parts = null
            }
            history.push(this._repackHistoryItem(item[1], parts, isChat, isUIN))
          }
        }
      }, this)
    }
    return history
  }, markAsReaded:function() {
    var lastReadMId;
    if(this.dialog.history) {
      U.Array.each(this.dialog.history, function(msg) {
        if(!msg.mid) {
          return
        }
        if(this.dialog.lastRead && this.dialog.lastRead >= msg.mid) {
          return
        }
        delete msg.unreaded;
        if(!lastReadMId || lastReadMId < msg.mid) {
          lastReadMId = msg.mid || msg.arch_id
        }
      }, this)
    }
    if(lastReadMId) {
      this.dialog.lastRead = lastReadMId;
      WA.IcqRapi.setDialogState({email:this.dialog.mail, msgId:lastReadMId})
    }
    return!!lastReadMId
  }, makeAuthorized:function() {
    var changed = false;
    if(this.dialog.history) {
      U.Array.each(this.dialog.history, function(data, i) {
        if(data.auth) {
          delete data.auth;
          changed = true
        }
      }, this)
    }
    return changed
  }, _sortCb:function(a, b) {
    if(a.arch_id && b.arch_id) {
      if(b.arch_id && a.arch_id > b.arch_id) {
        return 1
      }
      return-1
    }
    if(a.date < b.date) {
      return-1
    }else {
      if(a.date > b.date) {
        return 1
      }
    }
    return 1
  }, _sort:function() {
    if(this.dialog.history && this.dialog.history.sort) {
      this.dialog.history.sort(WA.createDelegate(this._sortCb, this));
      if(WA.isProblemStrictSafari && this.dialog.auth && !this._has_auth) {
        if(this.dialog.history.length) {
          this.dialog.history[this.dialog.history.length - 1].auth = 1
        }else {
          this.dialog.history.push(this._createAuthMessage())
        }
      }
      var lastMsg = this.dialog.history[this.dialog.history.length - 1];
      if(lastMsg && lastMsg.date) {
        this.dialog.lastMessageDate = lastMsg.date
      }
    }
  }, _indexOf:function(message, id_name) {
    id_name || (id_name = "arch_id");
    var arch_id = message[id_name];
    var r = U.Array.indexOfBy(this.dialog.history, function(m) {
      if(arch_id && arch_id != "0" && m[id_name] == arch_id) {
        return true
      }
    }, this);
    return r
  }, removeMessage:function(id, id_name) {
    var mess = {};
    mess[id_name] = id;
    var ind = this._indexOf(mess, id_name);
    if(ind !== -1) {
      mess = this.dialog.history.splice(ind, 1)[0];
      this.updateEvent.fire(true);
      return mess
    }
  }, getSideArchId:function(last) {
    var h = this.dialog.history || [], n = last ? h.length - 1 : 0, i = last ? -1 : 1;
    while(h[n] && !h[n].arch_id) {
      n += i
    }
    return h[n] && (h[n].mid || h[n].arch_id)
  }, _addUniqOnly:function(messages) {
    this.dialog.history || (this.dialog.history = []);
    var cast, isChat = WA.MainAgent.isChat(this.dialog.mail);
    U.Array.each(messages, function(message) {
      var index = this._indexOf(message);
      if(index == -1) {
        if(message.auth) {
          this._has_auth = message.auth
        }
        if(isChat && message.sender && !this.dialog.cast[message.sender]) {
          cast = SA.get(message.sender);
          message.senderFriendly && (cast.nick = message.senderFriendly);
          if(cast.nick) {
            delete cast.email;
            this.dialog.cast[message.sender] = cast
          }
        }
        this.dialog.history.push(message)
      }else {
        if(message.mid) {
          this.dialog.history[index].mid = message.mid;
          this.dialog.history[index].arch_id = message.arch_id;
          if(this.dialog.history[index].state) {
            delete this.dialog.history[index].state
          }
        }
      }
    }, this)
  }, _delHistoryUpto:function(msgId) {
    this.dialog.history || (this.dialog.history = []);
    var anyRemoved, messages = [];
    U.Array.each(this.dialog.history, function(mes) {
      if(!mes.mid && !mes.auth || mes.mid > msgId) {
        messages.push(mes)
      }
    }, this);
    anyRemoved = this.dialog.history.length !== messages.length;
    this.dialog.history = messages;
    if(anyRemoved) {
      this.dialog.historyLoaded = true;
      this.updateEvent.fire(true)
    }
  }, _getModifiedMessages:function(modified) {
    U.Array.each(modified, function(data) {
      WA.IcqRapi.getHistory({email:this.dialog.mail, count:data.count, msgId:data.from, tillMsgId:data.till, patchVersion:this.dialog.patchVersion}, function(code) {
      }, this)
    }, this)
  }, _modifyMessage:function(value) {
    var message = (this._repack(value || {}) || [])[0];
    if(message) {
      var ind = U.Array.indexOfBy(this.dialog.history, function(m) {
        return message.arch_id === m.arch_id
      });
      if(ind > -1) {
        if(message) {
          this.dialog.history.splice(ind, 1, message)
        }else {
          this.dialog.history.splice(ind, 1)
        }
        this.dialog.insertingHistoryFlag = true;
        this.updateEvent.fire(true)
      }
    }
  }, _updateHistoryFromPatch:function(patch) {
    if(!patch || !patch.length) {
      return
    }
    var messages = [], needUpdate, patchCache = this._patchCache, modifiedCache = {}, needTest, modified = [];
    U.Array.each(patch, function(mes) {
      switch(mes.type) {
        case "delete":
          patchCache[mes.msgId] = true;
          break;
        case "modify":
          modifiedCache[mes.msgId] = true
      }
    });
    U.Array.each(this.dialog.history, function(mes) {
      if(!patchCache[mes.arch_id]) {
        messages.push(mes);
        if(needTest) {
          modified.push(messages[messages.length - 3] ? {count:1, from:messages[messages.length - 3].arch_id, till:mes.arch_id} : {count:-1, from:mes.arch_id, till:-1});
          needTest = false
        }
        if(modifiedCache[mes.arch_id]) {
          needTest = true
        }
      }else {
        delete patchCache[mes.arch_id];
        needUpdate = true
      }
    });
    if(needTest) {
      modified.push(messages[messages.length - 2] ? {count:1, from:messages[messages.length - 2].arch_id, till:-1} : {count:-1, from:-1, till:-1});
      needTest = false
    }
    this.dialog.history = messages;
    this._patchCache = patchCache;
    this._getModifiedMessages(modified);
    return needUpdate
  }, _onConnectionContactHistory:function(value, notlast) {
    var historyBack = value.historyBack;
    if(value.email == this.dialog.mail) {
      if(value.getModifiedMsg) {
        value.history && value.history[0] && this._modifyMessage(value);
        return
      }
      if(value.patchRequested) {
        if(this._patchRequested !== "get_patch") {
          return
        }
        if(value.history && value.history.length) {
          value.patchRequested = false;
          notlast = true
        }
      }
      if(value.patchVersion) {
        this.dialog.patchVersion = value.patchVersion
      }
      var updateTabs = !!this._updateHistoryFromPatch(value.patch);
      if(value.patchRequested) {
        this.dialog.insertingHistoryFlag = updateTabs || this.dialog.insertingHistoryFlag;
        if(!value.patch || !value.patch.length) {
          this.dialog.patchVersion = value.patchVersion;
          this._patchRequested = false;
          return
        }
      }else {
        var lastHistory = !notlast && historyBack && (!value.history || value.history.length < HISTORY_PART_VOLUME);
        this.dialog.insertingHistoryFlag = !!(this.dialog.history && this.dialog.history.length);
        if(value.lastRead) {
          this.dialog.lastRead = value.lastRead
        }
        if(value.theirs) {
          if(value.theirs.lastDelivered) {
            this.dialog.theirsLastDelivered = value.theirs.lastDelivered
          }
          if(value.theirs.lastRead) {
            this.dialog.theirsLastRead = value.theirs.lastRead
          }
        }
        var lastMsg = this.dialog.history && this.dialog.history[this.dialog.history.length - 1];
        var needSetAuthMessage = this.dialog.auth && !notlast && !lastMsg && value.history && value.history[0];
        if(needSetAuthMessage) {
          value.history.length = 1
        }
        this._addUniqOnly(this._repack(value));
        this._sort();
        if(needSetAuthMessage) {
          this.dialog.historyLoaded = true;
          this.dialog.history[0].auth = true
        }
        var hasChanges = lastMsg !== (this.dialog.history && this.dialog.history[this.dialog.history.length - 1]);
        if(hasChanges) {
          this.dialog.addingMessageFlag = true
        }
        updateTabs = updateTabs || hasChanges;
        if(!this.dialog.historyLoaded || typeof this.dialog.historyLoaded != "boolean") {
          if(lastHistory) {
            this.dialog.historyLoaded = true
          }else {
            if(notlast) {
              this._requested = undefined
            }
            this.dialog.historyLoaded = typeof this._requested != "boolean" ? this._requested : this.getSideArchId(true)
          }
        }
      }
      this.updateEvent.fire(updateTabs);
      this._requested = false;
      this._patchRequested = false
    }
  }, _onConnectionImStates:function(states) {
    if(!this.dialog.history || !states || !states.length) {
      return
    }
    U.Array.each(this.dialog.history, function(msg) {
      if(!msg.mid) {
        U.Array.each(states, function(data, ind) {
          if(msg.wid === data.msgId) {
            msg.arch_id = msg.mid = data.histMsgId;
            msg.wid = data.msgId;
            delete msg.state;
            data.ts && (msg.timestamp = data.ts);
            states.splice(ind, 1);
            return false
          }
        })
      }
    }, this)
  }, updateState:function(value) {
    var needUpdate, patchVersion;
    if(value.theirs) {
      if(value.theirs.lastRead) {
        if(this.dialog.theirsLastRead !== value.theirs.lastRead) {
          needUpdate = true
        }
        this.dialog.theirsLastRead = value.theirs.lastRead
      }
      if(value.theirs.lastDelivered) {
        if(this.dialog.theirsLastDelivered !== value.theirs.lastDelivered) {
          needUpdate = true
        }
        this.dialog.theirsLastDelivered = value.theirs.lastDelivered
      }
    }
    if(value.delUpto) {
      this._delHistoryUpto(value.delUpto)
    }else {
      this.dialog.isRecent = true
    }
    patchVersion = value.patchVersion || this.dialog.patchVersion || "init";
    value = value && value.historyPart;
    if(value && value.email == this.dialog.mail) {
      var history = [];
      var statesArch = this.dialog.statesArch;
      this.dialog.isRecent = true;
      U.Array.each(value.history || [], function(item) {
        if(item[0] === "message") {
          var msg = item[1];
          if(msg.modifiedInfo) {
            if(msg.modifiedInfo.name && this.dialog.cast[this.dialog.mail]) {
              this.dialog.cast[this.dialog.mail].nick = msg.modifiedInfo.name
            }
          }
          if(msg.from === WA.ACTIVE_MAIL) {
            if(msg.mid >= (value.lastRead || 0)) {
              for(var id in this._instances) {
                if(!this._instances[id].data.arch_id && (this._instances[id].data.text === msg.text || msg.sticker && msg.sticker == this._instances[id].data.sticker)) {
                  statesArch[msg.wid] = {mid:msg.mid, wid:msg.wid, time:msg.time};
                  break
                }
              }
            }
            if(!statesArch[msg.wid]) {
              history.push(item)
            }
          }else {
            history.push(item)
          }
        }
      }, this);
      value.history = history;
      if(history.length) {
        var has_history = this.dialog.history && this.dialog.history.length;
        this._onConnectionContactHistory(value, true);
        if(this.dialog.auth && !has_history && this.dialog.history && this.dialog.history.length) {
          this.dialog.history[this.dialog.history.length - 1].auth = 1;
          this.dialog.historyLoaded = true
        }
      }
    }
    if((!history || !history.length) && needUpdate) {
      this.updateEvent.fire(needUpdate)
    }
    if(this.dialog.patchVersion) {
      if(patchVersion != this.dialog.patchVersion) {
        this.loadPatch()
      }
    }else {
      if(patchVersion) {
        this.dialog.patchVersion = patchVersion
      }
    }
  }, destroy:function() {
    History.superclass.destroy.apply(this, arguments);
    U.Object.each(this._instances, function(message) {
      message.destroy()
    }, this);
    this.updateEvent.removeAll();
    this.__destroyed = true
  }});
  var Dialog = WA.extend(Object, {constructor:function(mail, data) {
    this.data = data || {mail:mail, modifDate:+new Date, lastMessageDate:0, cast:{}, unreadCount:0};
    this.data.unreadCount = WA.ContactStates.getUnread(mail) || 0;
    if(this.data.unreadCount > 0) {
      this.data.unreaded = 1
    }
    this.data.cast[WA.ACTIVE_MAIL] = {nick:WA.DialogsAbstraction.nick || WA.ACTIVE_MAIL};
    this.history = new History(this.data);
    this.history.updateEvent.on(this._onHistoryUpdate, this);
    this.focusedEvent = new U.Event;
    this.callingEvent = new U.Event;
    this.updateEvent = new U.Event;
    this.typingTimeout = new U.DelayedTask({interval:15E3, fn:this._onTypingTimeout, scope:this});
    if(this.data.typing) {
      var now = +new Date;
      var timeout = 15E3 - (now - this.data.typing);
      this.typingTimeout.start(timeout, this._onTypingTimeout, this)
    }
  }, updateSelfNickDialog:function(nick) {
    this.data.cast[WA.ACTIVE_MAIL].nick = nick;
    this.data.modifDate = +new Date;
    this.updateEvent.fire()
  }, _onTypingTimeout:function() {
    if(this.data.typing) {
      delete this.data.typing;
      this.updateEvent.fire(true)
    }
  }, setTyping:function() {
    this.data.typing = +new Date;
    this.updateEvent.fire(true);
    this.typingTimeout.start()
  }, stopTyping:function() {
    if(this.data.typing) {
      this.typingTimeout.stop();
      delete this.data.typing;
      this.updateEvent.fire(true)
    }
  }, setCast:function(nick, status, statusTitle, features, phones) {
    if(!nick) {
      WA.log("###SetCast with empty nick:", this.data.mail, nick, status, statusTitle, features, phones)
    }
    var oldCast = this.data.cast[this.data.mail] || {};
    var cast = {nick:nick || oldCast.nick, status:status === undefined ? oldCast.status : status, statusTitle:statusTitle === undefined ? oldCast.statusTitle : statusTitle, features:features || 0, phones:U.Array.clone(phones || [])};
    this.data.cast[this.data.mail] = cast;
    this.updateEvent.fire(true)
  }, focus:function() {
    this.focusedEvent.fire(this.data.mail, this);
    this.history.load()
  }, calling:function() {
    this.callingEvent.fire(this.data.mail, this)
  }, isUnread:function() {
    return this.data.unreaded
  }, updateCounter:function(count) {
    this.data.unreaded = 1;
    this.data.unreadCount = count;
    this.updateEvent.fire(true)
  }, markAsReaded:function() {
    if(this.history.markAsReaded() || this.data.unreaded) {
      delete this.data.unreaded;
      this.data.unreadCount = 0;
      this.updateEvent.fire(true)
    }
  }, makeAuthorized:function() {
    if(this.history.makeAuthorized() || this.data.auth) {
      delete this.data.auth;
      delete this.data.historyLoaded;
      this.history.load();
      this.data.modifDate = (new Date).getTime();
      this.updateEvent.fire(true)
    }
  }, getHistory:function() {
    return this.history
  }, _onHistoryUpdate:function(updateTabs) {
    this.data.modifDate = +new Date;
    this.updateEvent.fire(updateTabs, true)
  }, destroy:function() {
    this.history.destroy();
    this.focusedEvent.removeAll();
    this.callingEvent.removeAll();
    this.updateEvent.removeAll();
    this.typingTimeout.stop()
  }});
  var DialogsManager = WA.extend(Object, {constructor:function(cache) {
    this._cache = cache;
    this._data = this._cache.data;
    this._instances = {};
    this.MAX_DIALOGS_OPENED = 4;
    if(_firstLoad) {
      _firstLoad = false;
      if(RELOAD_HISTORY_ON_REFRESH && WA.isPopup) {
        this.clearHistory()
      }
    }
    this._fetchDialogs()
  }, _fetchDialogs:function() {
    if(this._data.dialogs && this._data.dialogs.length) {
      U.Array.each(this._data.dialogs, function(dialog) {
        if(dialog.unreaded || dialog.typing) {
          this._makeInstance(dialog.mail)
        }
      }, this);
      var focusedDialog = this.getFocused();
      if(focusedDialog) {
        focusedDialog.history.load()
      }
    }
  }, _indexOfDialog:function(mail) {
    return U.Array.indexOfBy(this._data.dialogs, function(dialog) {
      if(dialog.mail == mail) {
        return true
      }
    })
  }, getIfExist:function(mail) {
    var index = this._indexOfDialog(mail);
    if(index != -1) {
      return this.get(mail)
    }
  }, get:function(mail, keepFocusedPosition) {
    if(mail && !this._instances[mail]) {
      this._makeInstance(mail, keepFocusedPosition)
    }
    return this._instances[mail]
  }, _checkOverflow:function() {
    if(this._data.dialogs.length >= this.MAX_DIALOGS_OPENED) {
      this.close(this._data.dialogs[0].mail === this._data.focused ? this._data.dialogs[1].mail : this._data.dialogs[0].mail)
    }
  }, _makeInstance:function(mail, keepFocusedPosition) {
    var index = this._indexOfDialog(mail), findex = null, cindex = null;
    if(!this._data.dialogs[index]) {
      this._instances[mail] = new Dialog(mail);
      if(keepFocusedPosition && this._data.focused && this._data.dialogs.length >= this.MAX_DIALOGS_OPENED) {
        findex = this._data.focused ? this._indexOfDialog(this._data.focused) : null
      }
      if(this._data.calling && this._data.dialogs.length >= this.MAX_DIALOGS_OPENED) {
        cindex = this._data.calling ? this._indexOfDialog(this._data.calling) : null
      }
      this._data.dialogs.push(this._instances[mail].data);
      if(findex != null && cindex != null && findex < cindex) {
        var tmp = findex;
        findex = cindex;
        cindex = tmp
      }
      if(findex != null) {
        this._moveDialog(findex, findex + 1)
      }
      if(cindex != null) {
        this._moveDialog(cindex, cindex + 1)
      }
      this._data.dialogsModifDate = +new Date
    }else {
      this._instances[mail] = new Dialog(mail, this._data.dialogs[index])
    }
    this._instances[mail].focusedEvent.on(this._onDialogFocused, this);
    this._instances[mail].callingEvent.on(this._onDialogCalling, this);
    this._instances[mail].updateEvent.on(this._onDialogUpdate, this)
  }, _moveDialog:function(index, newIndex) {
    var dialog = this._data.dialogs.splice(index, 1)[0];
    this._data.dialogs.splice(newIndex, 0, dialog)
  }, _onDialogFocused:function(mail, dialog) {
    var len = this._data.dialogs.length;
    var index = this._indexOfDialog(mail);
    if(len - index > this.MAX_DIALOGS_OPENED) {
      this._moveDialog(index, len);
      this._data.dialogsModifDate = +new Date
    }
    this._data.focused = mail;
    this._cache.commit()
  }, _onDialogCalling:function(mail) {
    var len = this._data.dialogs.length;
    var index = this._indexOfDialog(mail);
    if(len - index > this.MAX_DIALOGS_OPENED) {
      this._moveDialog(index, len);
      this._data.dialogsModifDate = +new Date
    }
    if(this._data.focused == mail) {
      this._data.focused = false
    }
    this._data.calling = mail;
    this._cache.commit()
  }, endCall:function() {
    this._data.calling = false;
    this._cache.commit()
  }, blur:function() {
    this._data.focused = false;
    this._cache.commit()
  }, _onDialogUpdate:function(updateTabs, fromHistory) {
    if(updateTabs) {
      this._data.dialogsModifDate = +new Date
    }
    this._cache.commit(fromHistory)
  }, count:function() {
    return this._data.dialogs.length
  }, getFocused:function() {
    if(this._data.focused) {
      return this.get(this._data.focused)
    }else {
      return false
    }
  }, getOpenDialogs:function() {
    for(var i = 1, ret = [], len = this._data.dialogs.length;i < 5 && i <= len;i++) {
      ret.push(this._data.dialogs[len - i].mail)
    }
    return ret
  }, eachDialog:function(fn, scope) {
    U.Array.each(this._data.dialogs, function(dialog, index) {
      var mail = dialog.mail;
      fn.call(scope || this, dialog, mail, index)
    }, this)
  }, updateSelfNick:function(nick) {
    this._cache.preventCommit();
    U.Object.each(this._instances, function(dialog) {
      dialog.updateSelfNickDialog(nick)
    }, this);
    this._cache.permitCommit()
  }, closeAll:function() {
    this.destroy();
    this._instances = {};
    this._data.dialogs = [];
    this._data.focused = false;
    this._data.dialogsModifDate = +new Date;
    this._cache.commit()
  }, close:function(mail, removeFromRecent) {
    if(this._instances[mail]) {
      this._destroyDialog(this._instances[mail])
    }
    var uncommitted;
    if(this._data.focused == mail) {
      this._data.focused = false;
      uncommitted = true
    }
    var index = this._indexOfDialog(mail), lastMsgId = 0;
    if(removeFromRecent) {
      if(index > -1) {
        var hist = this._data.dialogs[index].history;
        if(hist && hist.length && hist[hist.length - 1].mid) {
          lastMsgId = hist[hist.length - 1].mid
        }
      }
      WA.IcqApi.hideActiveDialog({email:mail, lastMsgId:lastMsgId})
    }
    if(index != -1) {
      this._data.dialogs.splice(index, 1);
      this._data.dialogsModifDate = +new Date;
      uncommitted = true
    }
    if(uncommitted) {
      this._cache.commit()
    }
  }, _destroyDialog:function(dialog) {
    dialog.destroy();
    delete this._instances[dialog.data.mail]
  }, destroy:function() {
    U.Object.each(this._instances, this._destroyDialog, this)
  }, clearHistory:function() {
    var now = +new Date;
    if(this._data.dialogs && this._data.dialogs.length) {
      U.Array.each(this._data.dialogs, function(dialog) {
        if(this._instances[dialog.mail]) {
          this._destroyDialog(this._instances[dialog.mail])
        }
        delete dialog.typing;
        delete dialog.historyLoaded;
        delete dialog.history
      }, this);
      this._cache.commit()
    }
  }});
  var DialogsCache = WA.extend(ConnectionRoster, {constructor:function(cache) {
    DialogsCache.superclass.constructor.apply(this, arguments);
    this.updateEvent = new U.Event;
    this.data = {dialogs:[]};
    this.dm = null;
    this._sync = WA.Synchronizer.registerComponent("dialogs", ["data"], true, !WA.isProblemStrictSafari)
  }, activate:function(cb, scope) {
    FM.focusEvent.on(this._onFocus, this);
    this._sync.read(function(data) {
      this._onSyncRead(data);
      this._sync.triggerEvent.on(this._onSync, this);
      cb && cb.call(scope || window)
    }, this)
  }, deactivate:function() {
    FM.focusEvent.un(this._onFocus, this);
    this._sync.triggerEvent.un(this._onSync, this);
    if(this.dm) {
      this.dm.clearHistory();
      this.dm.destroy();
      this.dm = null
    }
    this.data = {dialogs:[]}
  }, _onFocus:function() {
    this._sync.read(this._onSyncRead, this)
  }, _isSyncChanged:function(data) {
    if(data.isChanged("data")) {
      var d = JSON.parse(data.get("data") || "null");
      if(d && d.modifDate && (+this.data.modifDate || 0) < d.modifDate) {
        return d
      }else {
        if(WA.isProblemStrictSafari && d && d.historyLastArchId && (+this.data.historyLastArchId || 0) < +d.historyLastArchId) {
          return d
        }
      }
    }
  }, _onSyncRead:function(data) {
    data = this._isSyncChanged(data);
    if(data) {
      if(this.dm) {
        this.dm.destroy();
        this.dm = null
      }
      this.data = data
    }
    if(!this.dm) {
      this.dm = new DialogsManager(this)
    }
    if(data) {
      this.updateEvent.fire(this.data, 1)
    }
  }, _onSync:function(data) {
    data = this._isSyncChanged(data);
    if(data) {
      if(this.dm) {
        this.dm.destroy();
        this.dm = null
      }
      this.data = data;
      this.updateEvent.fire(this.data, 1)
    }
  }, _onBeforeConnectionResponse:function() {
    this._preventCommit = 1
  }, _onAfterConnectionResponse:function() {
    delete this._preventCommit;
    if(this._uncommitted) {
      this.commit(this.__fromHistory && this.__fromHistory.value)
    }
  }, preventCommit:function() {
    this._preventCommit = true
  }, permitCommit:function() {
    this._preventCommit = false;
    if(this._uncommitted) {
      this.commit(this.__fromHistory && this.__fromHistory.value)
    }
  }, commit:function(fromHistory) {
    if(!this._preventCommit) {
      if(WA.isProblemStrictSafari) {
        U.Array.each(this.data.dialogs, function(it) {
          if(it.history && it.history.length) {
            it = it.history[it.history.length - 1].arch_id;
            if((+this.data.historyLastArchId || 0) < +it) {
              this.data.historyLastArchId = it
            }
          }
        }, this)
      }
      if(!fromHistory || !WA.isProblemStrictSafari) {
        this.data.modifDate = +new Date
      }
      if(this.__fromHistory) {
        delete this.__fromHistory
      }
      delete this._uncommitted;
      this._preventCommit = 1;
      this.updateEvent.fire(this.data);
      if(this._uncommitted) {
        this.updateEvent.fire(this.data)
      }
      delete this._preventCommit;
      if(!this.data || !this.data.dialogs || !this.data.dialogs.length) {
      }
      if(WA.isProblemStrictSafari) {
        var tmp = [];
        U.Array.each(this.data.dialogs, function(it, i) {
          tmp[i] = {history:it.history, historyLoaded:it.historyLoaded};
          delete it.history;
          delete it.historyLoaded
        }, this);
        var sData = JSON.stringify(this.data);
        U.Array.each(this.data.dialogs, function(it, i) {
          if(typeof tmp[i].history !== "undefined") {
            it.history = tmp[i].history
          }
          if(typeof tmp[i].historyLoaded !== "undefined") {
            it.historyLoaded = tmp[i].historyLoaded
          }
        }, this);
        this._sync.write("data", sData)
      }else {
        this._sync.write("data", JSON.stringify(this.data))
      }
    }else {
      this._uncommitted = 1;
      if(!this.__fromHistory || !fromHistory) {
        this.__fromHistory = {value:fromHistory}
      }
    }
  }});
  WA.DialogsAbstraction = WA.extend(ConnectionRoster, {constructor:function() {
    WA.DialogsAbstraction.superclass.constructor.apply(this, arguments);
    this._cache = new DialogsCache;
    this._temporaryDlgData = {};
    this.updateEvent = (new U.Event).relay(this._cache.updateEvent);
    this.incomingMessageEvent = new U.Event;
    this.selfNameReadyEvent = new U.Event;
    this.updateActivityEvent = new U.Event;
    WA.fileUploader.startUploadEvent.on(function(email, uid) {
      this.addDynamicMessage(email, uid)
    }, this);
    WA.fileUploader.endUploadEvent.on(function(email, fileInfo) {
      if(fileInfo) {
        this.postMessage(email, fileInfo.static_url);
        U.Mnt.countRB(13169728)
      }
    }, this);
    WA.Storage.whenReady(function() {
      WA.Storage.load(["selfname", "server_time_diff"], {success:function(storage) {
        if(storage["server_time_diff"]) {
          WA.serverTimeDiff = storage["server_time_diff"]
        }
        if(storage["selfname"]) {
          WA.DialogsAbstraction.nick = storage["selfname"];
          this.selfNameReadyEvent.fire(storage["selfname"])
        }
      }, scope:this})
    }, this)
  }, activate:function(cb, scope) {
    this._cache.activate(cb, scope)
  }, deactivate:function() {
    this._cache.deactivate()
  }, _onConnectionContactStatus:function(value) {
    if(!this._cache.dm) {
      return
    }
    var dialog = this._cache.dm.getIfExist(value.email);
    if(dialog && value.status) {
      if(!value.status) {
        var clData = WA.CLD.getInfo(value.email);
        if(clData && clData.status) {
          dialog.setCast(value.nickname, clData.status, clData.statusTitle, value.features, value.phones)
        }
      }else {
        var lastSeen = value.lastseen, status = lastSeen && U.Date.getElapsed(new Date(lastSeen * 1E3)) / 1E3 < U.Date.DAY && "away" || value.status.type, statusTitle = value.status.title || status === "away" && U.Date.formatLastSeenData(lastSeen);
        dialog.setCast(value.nickname, status, statusTitle, value.features, value.phones)
      }
    }
  }, _onConnectionTypingNotify:function(value) {
    var dialog = this._cache.dm.getIfExist(value.from);
    if(dialog) {
      dialog.setTyping()
    }
  }, _onConnectionAuthRequest:function(value) {
    var email = value.from;
    var message;
    if(WA.MainAgent.isChat(email)) {
      message = new IncomingMessage(value);
      WA.ChangeLog.logAction("add", {email:message.data.from, nickname:message.data.nick || email, status:{type:"online"}})
    }else {
      message = value.authRequested && !WA.CLD.inList(email) && new AuthMessage(value)
    }
    message && this._onConnectionMessage(message)
  }, _onConnectionMessage:function(value) {
    var message = null;
    if(value instanceof IncomingMessage) {
      message = value
    }else {
      message = new IncomingMessage(value)
    }
    var email = message.data.from;
    WA.log("-----_onConnectionMessage", message, email, value);
    if(!email) {
      return
    }
    var muted = WA.CLD.getMute(email);
    var dialog = muted ? this._cache.dm.getIfExist(email) : this._cache.dm.get(email, true);
    WA.log("-----_onConnectionMessage 2", dialog, value);
    if(dialog) {
      dialog.getHistory().dialog.addingMessageFlag = true;
      dialog.setCast(message.data.nick, message.data.status, message.data.statusTitle, message.data.features, message.data.phones);
      if(WA.MainAgent.isChat(email)) {
        var sender = message.data.sender;
        if(sender) {
          var cast = SA.get(sender);
          if(cast.nick) {
            delete cast.mail;
            dialog.data.cast[sender] = cast
          }
        }
      }
      dialog.stopTyping();
      dialog.getHistory().append(message);
      this._messageArrived = email;
      if(message.data.offline) {
        this._offlineMessageArrived = true
      }
      var clistData = this._extractClistData(dialog);
      this.updateActivityEvent.fire(clistData, "new_message")
    }
    if(value.text && WA.fileTools.resolveLinkAsFile(value.text)) {
      U.Mnt.countRB(13169733)
    }
  }, _onConnectionSms:function(value) {
    var msg = new WA.IncomingSMS(value);
    this._onConnectionMessage(msg)
  }, _onConnectionSmsDeliveryStatus:function(value) {
    U.Mnt.log({reason:"sms_udelivery", message:"tel: " + (this.__smsLastNumber || "") + ", " + value.text});
    delete this.__smsLastNumber;
    U.Mnt.countRB(980046);
    U.Mnt.countRB(979807);
    value.from = SA.getByTel(value.tel).mail || value.from;
    this._onConnectionMessage(value)
  }, updateSelfNick:function(nick) {
    WA.DialogsAbstraction.nick = nick;
    S.save({"selfname":nick});
    if(this._cache.dm) {
      this._cache.dm.updateSelfNick(nick)
    }
    this.selfNameReadyEvent.fire(nick)
  }, _onConnectionWpSelf:function(p) {
    var name = "";
    if(p.firstname || p.lastname) {
      name = (p.firstname ? p.firstname + " " : "") + (p.lastname || "")
    }else {
      name = p.nickname || p.friendly
    }
    if(name) {
      this.updateSelfNick(name)
    }
  }, _onConnectionMyInfo:function(value) {
  }, _onConnectionArchSync:function(value) {
    var dialog, clistData;
    if(!this._cache.dm) {
      return
    }
    dialog = this._cache.dm.getIfExist(value["with"]);
    if(value.count > 0) {
      if(dialog) {
        dialog.updateCounter(value.count)
      }
    }else {
      if(value.count == 0) {
        if(dialog) {
          clistData = this._extractClistData(dialog);
          this.updateActivityEvent.fire(clistData, "read_message");
          dialog.markAsReaded()
        }
      }
    }
  }, _onIncomingMessage:function(email, dialog, histData) {
    if(this._isNewMessage(email, histData)) {
      dialog.stopTyping();
      this._messageArrived = email;
      var clistData = this._extractClistData(dialog);
      this.updateActivityEvent.fire(clistData, "new_message")
    }
  }, _isNewMessage:function(email, histData) {
    return!histData.starting && email !== WA.ACTIVE_MAIL && histData.historyPart && (!histData.yours || histData.yours.lastRead < histData.lastMsgId)
  }, _onConnectionHistoryState:function(value) {
    if(!this._cache.dm) {
      return
    }
    var email = value.sn;
    var muted = WA.CLD.getMute(email);
    var dialog = muted || !this._isNewMessage(email, value) ? this._cache.dm.getIfExist(email) : this._cache.dm.get(email, true);
    if(dialog) {
      var saData = SA.get(email);
      if(!saData.nick) {
        WA.log("###EMPTY SA Data for", email)
      }
      if(!WA.MainAgent.isChat(email) && !WA.CLD.inList(email)) {
        WA.log("set auth from _onConnectionHistoryState", saData);
        dialog.data.auth = true
      }else {
        if(dialog.data.auth) {
          dialog.makeAuthorized()
        }
      }
      dialog.setCast(saData.nick, saData.status, saData.statusTitle, saData.features, saData.phones);
      dialog.getHistory().updateState(value);
      if(value.starting) {
        this._offlineMessageArrived = true
      }
      this._onIncomingMessage(email, dialog, value)
    }
  }, _onConnectionStoreCommand:function(value) {
    WA.Sticker.resetShowcaseData();
    WA.Sticker.resetContentData()
  }, _onAfterConnectionResponse:function() {
    if(this._messageArrived) {
      this.incomingMessageEvent.fire(this._offlineMessageArrived, this._messageArrived);
      delete this._messageArrived;
      delete this._offlineMessageArrived
    }
  }, postMessage:function(mail, text, resend, flash, sticker) {
    var dialog = this._cache.dm.get(mail);
    var message = new OutgoingMessage({text:text, mail:mail, resend:!!resend, flash:!!flash, sticker:!!sticker});
    dialog.getHistory().append(message);
    message.send()
  }, postSms:function(mail, tel, text) {
    this.__smsLastNumber = tel;
    var dialog = this._cache.dm.get(mail);
    var message = new WA.OutgoingSMS({text:text, mail:mail, tel:tel});
    dialog.getHistory().append(message);
    message.send();
    var clistData = this._extractClistData(dialog);
    this.updateActivityEvent.fire(clistData)
  }, addServiceMessage:function(email, title, text) {
    var now = WA.now();
    var dialog = this._cache.dm.getIfExist(email);
    if(dialog) {
      dialog.getHistory().append(new ServiceMessage({from:email, title:title, text:text, date:now}))
    }
  }, addDynamicMessage:function(email, id, ts) {
    var dialog = this._cache.dm.getIfExist(email);
    if(dialog) {
      dialog.getHistory().append(new DynamicMessage({from:WA.ACTIVE_MAIL, id:id, date:ts || WA.now()}))
    }
  }, updateHeight:function() {
  }, markAsReaded:function(mail, mid) {
    var dialog, clistData;
    if(this._cache.dm) {
      if(mail) {
        dialog = this._cache.dm.getIfExist(mail)
      }else {
        dialog = this._cache.dm.getFocused();
        mail = dialog && dialog.data.mail
      }
      if(dialog || mid) {
        WA.ContactStates.saveUnread(mail, 0);
        WA.ContactStates.removeState(mail, WA.ContactStates.MESSAGE_STATE);
        if(dialog) {
          clistData = this._extractClistData(dialog);
          this.updateActivityEvent.fire(clistData, "read_message");
          dialog.markAsReaded()
        }else {
          WA.IcqRapi.setDialogState({email:mail, msgId:mid})
        }
      }
    }
  }, makeAuthorized:function() {
    var dialog = this._cache.dm.getFocused();
    dialog.makeAuthorized()
  }, loadHistoryPart:function() {
    var dialog = this._cache.dm && this._cache.dm.getFocused();
    if(dialog && dialog.data.history) {
      dialog.history.load(dialog.history.getSideArchId())
    }
  }, focus:function(mail) {
    var dialog = this._cache.dm.get(mail);
    dialog.focus()
  }, calling:function(mail) {
    var dialog = this._cache.dm.get(mail);
    dialog.calling()
  }, endCall:function() {
    if(this._cache.dm) {
      this._cache.dm.endCall()
    }
  }, blur:function() {
    if(this._cache.dm) {
      this._cache.dm.blur()
    }
  }, closeAll:function() {
    var dm = this._cache.dm;
    var emails = [];
    dm.eachDialog(function(dialog, mail) {
      if(dialog.unreaded) {
        emails.push(mail)
      }
    }, this);
    WA.ContactStates.removeStates(emails, WA.ContactStates.MESSAGE_STATE);
    dm.closeAll()
  }, close:function(mail, removeFromRecent) {
    this._cache.dm.close(mail, removeFromRecent);
    WA.ContactStates.saveUnread(mail, 0);
    WA.ContactStates.removeState(mail, WA.ContactStates.MESSAGE_STATE)
  }, open:function(mail, nick, status, statusTitle, features, phones) {
    this._cache.preventCommit();
    var dialog = this._cache.dm.get(mail);
    if(!WA.MainAgent.isChat(mail) && !WA.CLD.inList(mail)) {
      dialog.data.auth = true
    }
    dialog.setCast(nick || mail, status, statusTitle, features, phones);
    dialog.focus();
    this._cache.permitCommit()
  }, _extractDataFromDialog:function(dlg) {
    var mail = dlg.data.mail;
    var cast = dlg.data.cast[mail];
    return{mail:mail, nick:cast.nick, status:cast.status || "", statusTitle:cast.statusTitle || "", features:cast.features || 0, phones:U.Array.clone(cast.phones || []), unreaded:dlg.data.unreaded}
  }, _extractClistData:function(dlg, isRawData) {
    var cast, mail;
    if(isRawData === true) {
      mail = dlg.mail;
      cast = dlg
    }else {
      mail = dlg.data.mail;
      cast = dlg.data.cast[mail]
    }
    var data = [mail, cast.nick, +(cast.status == "gray" || cast.status == "icq_gray"), cast.status || "", cast.statusTitle || "", U.Array.clone(cast.phones || []), cast.features];
    return data
  }, getFocused:function() {
    if(!this._cache.dm) {
      return false
    }
    var dlg = this._cache.dm.getFocused();
    if(dlg) {
      return this._extractDataFromDialog(dlg)
    }else {
      return false
    }
  }, getOpenDialogs:function() {
    if(this._cache.dm) {
      return this._cache.dm.getOpenDialogs()
    }
    return[]
  }, isFirst:function(mail) {
    return this._cache.dm && this._cache.dm.isFirst(mail)
  }, renameContact:function(mail, newNick) {
    var dlg = this._cache.dm.getIfExist(mail);
    if(dlg) {
      var data = this._extractDataFromDialog(dlg);
      dlg.setCast(newNick, data.status, data.statusTitle, data.features, data.phones)
    }
  }, getDialogCount:function() {
    return this._cache.dm.count()
  }});
  WA.DialogsAbstraction.buildEventMessage = buildEventMessage;
  WA.DialogsAbstraction.MSG_TYPE_TEXT = "text";
  WA.DialogsAbstraction.MSG_TYPE_MULT = "mult";
  WA.DialogsAbstraction.MSG_TYPE_STICKER = "sticker"
})();
(function() {
  var WA = WebAgent, U = WA.util, UI = WA.ui;
  var IMAGE_URL = WA.imgPath + "images";
  var MESSAGE_MAX_LENGTH = 32E3;
  var UPDATE_FILE_LINKS_PERIOD = 30 * 60 * 1E3;
  var TextArea = WA.extend(UI.Component, {constructor:function(config) {
    TextArea.superclass.constructor.apply(this, arguments);
    this.changeEvent = new U.Event;
    this.submitEvent = new U.Event;
    this.expandEvent = new U.Event;
    this.stickerEvent = new U.Event;
    this._field = null;
    this._hintText = WA.tr("dialog.typeMessage");
    this._hintClass = "nwa_hint_msg";
    this.expanded = false;
    this.expandedWidth = 0;
    this._ctrlDate = 0;
    var tail = "%[89A-B][\\dA-F]", utf1 = "%[0-7][\\dA-F]", utf2 = "%(?:C[2-9A-F]|D[\\dA-F])" + tail, utf3 = "%E0%[AB][\\dA-F]" + tail + "|%E[1-9A-C](?:" + tail + "){2}|%ED%[89][\\dA-F]" + tail + "|%E[EF](?:" + tail + "){2}", utf4 = "%F0%[9AB][\\dA-F](?:" + tail + "){2}|%F[1-3](?:" + tail + "){3}|%F4%8[\\dA-F](?:" + tail + "){2}", rfcRegExp = "(?:" + [utf1, utf2, utf3, utf4].join("|") + ")";
    function RFCReplacer(a) {
      return a.replace(/\%/g, "$_$")
    }
    this._textChecker = new U.DelayedTask({interval:300, fn:function() {
      var domEl = this._field.getEl().dom, _fieldVal = this._field.textVal(), parentWidth;
      if(this._value != _fieldVal) {
        this._value = _fieldVal;
        var encodedValue = encodeURIComponent(this._value), encodedValueLength = encodedValue.length, valueLength = this._value.length;
        if(valueLength > MESSAGE_MAX_LENGTH) {
          this._value = this._value.substr(0, MESSAGE_MAX_LENGTH);
          if(this._field instanceof UI.SmilesTextField) {
            this._value = this._value.replace(/(\<[^>]*$)|(<SMILE>[^<]*(<[\/\w]*)?)$/i, function(matched) {
              var ret;
              if(matched.indexOf("<") >= 0 && matched.indexOf("</SMILE>") == -1) {
                ret = ""
              }else {
                ret = matched
              }
              return ret
            });
            this._value = WA.DialogsAgent.buildPlainHtmlMessage(this._value)
          }
          this._field.val(this._value);
          if(!this._alert) {
            this._alert = new WA.DialogsAgent.AlertDialog({fadeIn:true, modal:true, autoRender:this.container})
          }
          this._alert.show(WA.tr("msgTooLongAndCut"))
        }
        if(this._value != "\n") {
          this.changeEvent.fire(this._value)
        }
        var expanded = domEl.scrollHeight > 25;
        if(TextArea.ghostField) {
          TextArea.ghostField.getEl().setWidth(this._field.getEl().parent().getWidth());
          TextArea.ghostField.val(this._value + "w");
          expanded = TextArea.ghostField.getEl().dom.scrollHeight > 25
        }
        if(this._value == "\n") {
          expanded = false
        }
        if(this.expanded != expanded) {
          this.expanded = expanded;
          this.expandEvent.fire(expanded)
        }
      }
      if(this._field instanceof UI.SmilesTextField) {
        if(WA.isFF) {
          if(this.expandedWidth == 0 && domEl.offsetWidth > domEl.scrollWidth) {
            this.expandedWidth = domEl.offsetWidth - domEl.scrollWidth
          }else {
            if(this.expandedWidth > 0 && domEl.offsetWidth == domEl.scrollWidth) {
              this.expandedWidth = 0
            }
          }
          parentWidth = this._field.getEl().parent().getWidth();
          this._field.getEl().setWidth(parentWidth + this.expandedWidth)
        }
      }
      this._textChecker.start()
    }, scope:this})
  }, _onRender:function(ct) {
    this.el = ct.createChild({tag:"div", cls:"nwa-chat__input", children:{tag:"div", cls:"nwa-chat__input-inner", children:{tag:"div", cls:"nwa-chat__input-wrap"}}});
    var submitEl = new UI.Button({cls:"nwa-chat__input-send", handler:function(el, ev) {
      this._submit(ev)
    }, scope:this, tooltip:WA.tr("dialog.send"), text:"<span></span>"});
    submitEl.render(this.el.first());
    this.picturesMenu = new WA.DialogsAgentView.SmileBox;
    this.picturesMenu.itemClickEvent.on(function(smileType, obj) {
      obj = obj || {};
      if(smileType == "emoji") {
        this.addEmoji(obj.id)
      }else {
        if(smileType == "sticker") {
          this.stickerEvent.fire(obj.pack, obj.id)
        }
      }
    }, this);
    this.picturesMenu.render(this.el);
    this._smilesButton = new UI.Button({cls:"nwa-chat__input-smiles", tooltip:WA.tr("dialog.smiles"), menu:this.picturesMenu, text:"<span></span>"});
    this._smilesButton.render(this.el.first());
    this._field = new UI.SmilesTextField({cls:"nwa-chat__input-field", multiline:true, maxLength:MESSAGE_MAX_LENGTH, hintText:this._hintText, hintClass:this._hintClass, rich:true});
    this._field.render(this.el.first().first());
    this._field.getEl().on("keydown", function(ev) {
      if(!ev.shiftKey && ev.keyCode == 13) {
        this._submit(ev);
        ev.stopEvent()
      }
    }, this);
    this._field.focusEvent.on(function() {
      WA.UserAttend.onActivity()
    });
    if(!TextArea.ghostField) {
      TextArea.ghostField = new UI.TextField({cls:"nwa-chat__input-field nwa-input_ghost", multiline:true});
      TextArea.ghostField.render(WA.getBody())
    }
    this._textChecker.start()
  }, openSmilesMenu:function(tabnum, openById) {
    var menu = this._smilesButton && this._smilesButton.menu;
    if(menu) {
      menu.switchMenu(0, tabnum || 0, openById)
    }
  }, openStickerMenu:function(tabnum, openById) {
    var menu = this._smilesButton && this._smilesButton.menu;
    if(menu) {
      menu.switchMenu(1, tabnum || 0, openById)
    }
  }, openShowcase:function(packId) {
    var menu = this._smilesButton && this._smilesButton.menu;
    if(menu) {
      menu.switchMenu(2, packId)
    }
  }, _onKeyUp:function(ev) {
    var now = +new Date;
    if(ev.browserEvent.ctrlKey) {
      this._ctrlDate = now
    }
    if(now - this._ctrlDate < 400 && ev.keyCode == 13) {
      this._submit(ev)
    }
  }, _submit:function(ev) {
    var val = this._field.textVal();
    if(val.match(/\S/)) {
      if(this.submitEvent.fire(val)) {
        var start = +new Date;
        this._field.val("", true);
        this._field.focus()
      }else {
        ev.stopEvent()
      }
      U.Mnt.countRB(706784);
      U.Mnt.rbCountSubmitDomain();
      U.Mnt.countRB(1349355)
    }
  }, set:function(str) {
    this._field.val(str);
    this._value = str
  }, _safeSetFocus:function() {
    this._field.focus()
  }, setFocus:function(deferred) {
    if(!deferred) {
      this._safeSetFocus()
    }else {
      WA.setTimeout(WA.createDelegate(function() {
        this._safeSetFocus()
      }, this), 10)
    }
    this._textChecker.start()
  }, addEmoji:function(id) {
    (new U.DelayedTask({fn:function() {
      this._field._onFocus();
      if(this._field instanceof WebAgent.ui.SmilesTextField) {
        this._field.focus(true)
      }else {
        this.setFocus()
      }
      var value, code = id, sel = U.Selection.getSelection(), range, smileNode;
      value = WA.Emoji.codeToHTML(code);
      smileNode = U.DomHelper.elementFromHtml(value);
      smileNode.setAttribute("data-immutable", true);
      this._field.focus();
      if(WA.isOpera && this._field.el.dom.innerHTML == "<br>") {
        this._field.el.dom.innerHTML = ""
      }
      WA.Emoji.insertSmile(smileNode);
      this._field._saveCaretPosition();
      if(!this._field instanceof WebAgent.ui.SmilesTextField) {
        this._field._onKeyup();
        this._field._onKeyup();
        this._field._onKeyup()
      }else {
        if(WA.isFF) {
          (new U.DelayedTask({fn:function() {
          }, interval:100})).start()
        }
        this._field.checkScroll()
      }
    }, scope:this, interval:10})).start()
  }, deactivate:function() {
    this._textChecker.stop()
  }, destroy:function() {
    this.changeEvent.removeAll();
    this.submitEvent.removeAll();
    this.expandEvent.removeAll();
    this.stickerEvent.removeAll();
    if(this.picturesMenu) {
      this.picturesMenu.destroy()
    }
    TextArea.superclass.destroy.call(this)
  }});
  var History = WA.extend(UI.Component, {constructor:function(email) {
    History.superclass.constructor.apply(this, arguments);
    this.email = email;
    this.isChat = WA.MainAgent.isChat(email);
    this._previews = {};
    this._fileLinksUpdateTimer = null;
    this.topScrolledEvent = new U.Event;
    WA.fileUploader.progressEvent.on(function(email, uid, u) {
      if(email == this.email) {
        this._updateProgress(uid)
      }
    }, this);
    WA.fileUploader.endUploadEvent.on(function(email, fileInfo) {
      if(email == this.email && !fileInfo) {
        this._updateFileLinks()
      }
    }, this);
    WA.snippet.loadEvent.on(this._updateSnippetLinks, this);
    WA.Sticker.loadErrorEvent.on(this._updateStickers, this);
    WA.fileTools.loadEvent.on(this._updateFileLinks, this)
  }, _onRender:function(ct) {
    this.el = ct.createChild({tag:"div", cls:"nwa-chat__history", children:[{tag:"div", cls:"nwa-history"}]});
    this.contsRootEl = this.el.first();
    this.scrollBar = new UI.ScrollBar({source:this.contsRootEl, watchResize:WA.isPopup, autoRender:this.el})
  }, _groupingKey:"", _groupingDate:0, _updateProgress:function(uid) {
    if(!this.contsRootEl) {
      U.Mnt.log({reason:"breaklog", module:"uploader", login:WA.ACTIVE_MAIL, text:"error=contsRootEl not found"});
      return
    }
    var fileObjects = this.contsRootEl.dom.getElementsByTagName(WA.fileTools.OBJECT_TAG);
    var l = fileObjects.length;
    while(l--) {
      if(fileObjects[l].getAttribute("data-type") == "file" && fileObjects[l].getAttribute("data-id") == uid) {
        WA.fileTools.updateUploaderProgress(uid, fileObjects[l]);
        break
      }
    }
  }, _updateStickers:function(sId) {
    if(!this.contsRootEl) {
      return
    }
    var fileObjects = this.contsRootEl.dom.getElementsByTagName(WA.fileTools.OBJECT_TAG);
    var l = fileObjects.length;
    while(l--) {
      if(fileObjects[l].getAttribute("data-type") == "sticker" && fileObjects[l].getAttribute("data-id") == sId) {
        fileObjects[l].parentNode.removeAttribute("style");
        fileObjects[l].parentNode.removeAttribute("data-action");
        fileObjects[l].parentNode.innerHTML = ""
      }
    }
  }, _updateFileLinks:function(fileId) {
    if(!this.contsRootEl) {
      return
    }
    if(this._fileLinksUpdateTimer) {
      clearTimeout(this._fileLinksUpdateTimer)
    }
    var fileObjects = this.contsRootEl.dom.getElementsByTagName(WA.fileTools.OBJECT_TAG);
    var l = fileObjects.length, objId, fileInfo;
    while(l--) {
      if(fileObjects[l].getAttribute("data-type") != "file") {
        continue
      }
      objId = fileObjects[l].getAttribute("data-id");
      fileInfo = objId && WA.fileTools.getLocalFileInfo(objId);
      if(fileInfo) {
        if(WA.fileTools.isImageFile(objId)) {
          var pref = fileObjects[l].parentNode.previousSibling;
          if(pref.className == "nwa-message-prefile") {
            pref.parentNode.removeChild(pref)
          }
        }
        fileObjects[l].parentNode.innerHTML = WA.fileTools.generateHTML(fileInfo)
      }else {
        if(WA.fileTools.UPLOAD_PREFIX == fileObjects[l].getAttribute("data-name")) {
          WA.fileTools.updateUploaderProgress(objId, fileObjects[l])
        }
      }
    }
    this._fileLinksUpdateTimer = WA.setTimeout(this._redrawHistory, UPDATE_FILE_LINKS_PERIOD, this)
  }, _updateSnippetLinks:function(url) {
    if(this._hidePreviews || !this.contsRootEl) {
      return
    }
    var fileObjects = this.contsRootEl.dom.getElementsByTagName("a"), s = this._getScroll(), l = fileObjects.length, origUrl, html, cls;
    while(l--) {
      if(fileObjects[l].className.indexOf("waRawLink") > -1) {
        origUrl = decodeURIComponent(fileObjects[l].getAttribute("data-orig"));
        if(WA.snippet.urlHasSnippet(origUrl)) {
          var parent = fileObjects[l].parentNode;
          html = WA.snippet.generateHTML(origUrl, +fileObjects[l].getAttribute("data-flags"));
          if(parent.innerHTML !== html) {
            parent.innerHTML = html;
            cls = parent.getAttribute("data-class") || "";
            parent.className = cls
          }
        }
      }
    }
    if(s == -1) {
      this._setScroll(-1)
    }
  }, _formatMessageHtml:function(obj, ind, showAuthDialog) {
    var mainCls = [], contentHtml = "", mediaContent = false;
    var isIncoming = obj.fromPersonId != WA.ACTIVE_MAIL;
    var debugInfo = "";
    var hidePreviews = this._hidePreviews;
    var showSnippet = obj.parse && obj.parse.indexOf("url") > -1 || !obj.parse;
    var messageDate = U.String.formatDate(obj.date * 1E3);
    var stateTitle = "";
    if(obj.sticker) {
      mainCls.push("nwa-message_sticker");
      contentHtml = WA.Sticker.getStickerHTML(obj.sticker)
    }else {
      if(obj.voip) {
        mainCls.push("nwa-message_service");
        contentHtml = obj.orig;
        messageDate = obj.title + " " + messageDate
      }else {
        if(obj.dynamic) {
          mainCls.push("nwa-message_dynamic");
          contentHtml = WA.fileTools.generateUploaderHTML(obj.message_id);
          if(!contentHtml) {
            return""
          }
          contentHtml = "<div>" + contentHtml + "</div>"
        }else {
          if(obj.file) {
            mainCls.push("nwa-message_file");
            contentHtml = WA.fileTools.getPreviewCode(obj.file, obj.fileUrl || obj.orig)
          }else {
            if(obj.event) {
              mainCls.push("nwa-message_event");
              contentHtml = '<span class="nwa-message__textblock">' + obj.orig + "</span>"
            }else {
              var msgObj = buildRichMessage(obj.orig, obj.archId, {showPreview:!hidePreviews, showSnippet:showSnippet});
              contentHtml = msgObj.html;
              mediaContent = msgObj.media
            }
          }
        }
      }
    }
    if(showAuthDialog) {
      mainCls.push("nwa-message_auth");
      contentHtml += this._renderAuthMessage(obj)
    }
    if(obj.groupMsg) {
      mainCls.push("nwa-message-group")
    }
    if(!isIncoming) {
      mainCls.push("nwa-message_self");
      if(obj.state == 5) {
        mainCls.push("nwa-message_state-read");
        stateTitle = WA.tr("dialog.stateRead")
      }else {
        if(obj.state == 3) {
          mainCls.push("nwa-message_state-sent");
          stateTitle = WA.tr("dialog.stateSent")
        }else {
          if(obj.state == 4) {
            mainCls.push("nwa-message_state-delivered");
            stateTitle = WA.tr("dialog.stateDelivered")
          }else {
            if(obj.state == -1) {
              mainCls.push("nwa-message_state-error");
              stateTitle = WA.tr("dialog.stateError")
            }else {
              mainCls.push("nwa-message_state-sending");
              stateTitle = WA.tr("dialog.stateSending")
            }
          }
        }
      }
    }
    return U.String.format('<div class="nwa-message {3}" data-from="{4}"><div class="nwa-message__date"><span class="nwa-message__status" title="{5}">&nbsp;</span>' + '<span class="nwa-message__datetime">{0}&nbsp;</span></div>' + '<div class="nwa-message__from"><span>{1}</span><div class="nwa-message__fadeout"></div></div>{2}<br/></div>', messageDate, WA.Emoji.parse(obj.fromName), contentHtml, mainCls.join(" "), this.isChat && isIncoming ? WA.sum(obj.fromPersonId) : "", stateTitle)
  }, _renderMessage:function(m, cast, ind, showAuthDialog, lastDelivered, lastRead) {
    var from = m.sender || m.from;
    var nick = cast[from] && cast[from].nick || from;
    m.text = m.text || "";
    var fDate = m.date == WA.TIME_INFINITY ? m.localDate : m.date;
    var useGroup = false;
    var sms = !!m.tel;
    var isIncoming = m.from != WA.ACTIVE_MAIL;
    var fromPerson = m.sender || m.from;
    var groupingKey = m.from + nick;
    if(m.dynamic || m.event) {
      m.unreaded = false;
      if(m.text == "") {
      }
      this._groupingKey = ""
    }else {
      if(!m.event && isIncoming && this._groupingKey == groupingKey && fDate - this._groupingDate < 60) {
        useGroup = true;
        this._groupingDate = fDate
      }else {
        this._groupingKey = m.event ? "" : groupingKey
      }
    }
    if(!sms) {
      this._groupingDate = fDate
    }else {
      this._groupingDate = 0
    }
    var msgFrom = U.String.htmlEntity(nick);
    if(sms) {
      msgFrom = WA.tr(isIncoming ? "dialog.smsFrom" : "dialog.smsTo", {tel:m.tel})
    }
    if(m.voip) {
      msgFrom = "&nbsp;"
    }
    var state = m.state || 5;
    if(m.arch_id) {
      if(lastDelivered && lastDelivered < m.arch_id) {
        state = 3
      }else {
        if(lastRead < m.arch_id) {
          state = 4
        }
      }
    }
    var fileData = WA.fileTools.resolveLinkAsFile(m.text, true);
    var msgObj = {message_id:m.message_id, archId:m.arch_id, orig:m.text, sticker:m.sticker || false, dynamic:m.dynamic || false, event:m.event || false, parse:m.parse, voip:!!m.voip, state:state, title:m.title || "", file:fileData.id, fileUrl:fileData.url, fileText:fileData.text, fromPersonId:fromPerson, fromName:msgFrom, unread:isIncoming && m.unreaded, groupMsg:useGroup, date:fDate};
    return this._formatMessageHtml(msgObj, ind, showAuthDialog)
  }, _renderPreloader:function() {
    this.contsRootEl.update('<span class="nwa-message__info">' + WA.tr("dialog.loading") + "</span>")
  }, _renderEmpty:function() {
    this.contsRootEl.update('<span class="nwa-message__info">' + WA.tr("dialog.noMessages") + "</span>")
  }, _renderTel:function() {
    this.contsRootEl.update('<span class="nwa-message__info">' + WA.tr("dialog.smsOnlyContact") + '<br><a href="?" data-action="add-tel">' + WA.tr("dialog.tools.add") + "</a></span>")
  }, _renderAuthMessage:function(msg) {
    var html = "", actions = [["add", WA.tr("dialog.grantContactAuth"), "nwa-button nwa-button_blue"], ["cancel", WA.tr("dialog.decline"), "nwa-button_link"], ["ignore", WA.tr("dialog.ignore"), "nwa-button_link"], ["spam", WA.tr("dialog.spam"), "nwa-button_link"]];
    U.Array.each(actions, function(action) {
      html += U.String.format('<button href="javascript:;" data-action="{0}" data-msg-id="{3}" data-text="{4}" class="nwa-message__actions_{0} {2}">{1}</button>', action[0], action[1], action[2], msg.message_id, U.String.htmlEntity(msg.orig || ""))
    }, this);
    return'<div class="nwa-message__actions">' + html + "</div>"
  }, _renderMessages:function(dialog) {
    var html = [], auth = false;
    this._groupingKey = "";
    this._groupingDate = 0;
    if(dialog.isTel) {
      html.push('<span class="nwa-message__info">' + WA.tr("dialog.smsOnlyContact") + '<br><a href="?" data-action="add-tel">' + WA.tr("dialog.tools.add") + '</a></span><br><span class="nwa-message__info">' + WA.tr("dialog.smsArchive") + "</span>")
    }
    if(dialog.historyDisabled) {
      html.push('<span class="nwa-message__info">' + WA.tr("msgServerHistory", {href:"https://e.mail.ru/settings/agent"}) + "</span>")
    }
    var hist = dialog.history, endInd = hist.length;
    var lastRead = dialog.theirsLastRead, lastDelivered = dialog.theirsLastDelivered;
    U.Array.each(dialog.history, function(message, ind) {
      html[html.length] = this._renderMessage(message, dialog.cast, ind, !auth && message.auth, lastDelivered, lastRead);
      if(!auth) {
        auth = message.auth
      }
    }, this);
    html = html.join("");
    if(dialog.historyLoaded !== true) {
      html = '<div  class="nwa-message__info">' + WA.tr("msgHistoryLoading") + "</div>" + html
    }else {
      this._noMoreHistoryFlag = true
    }
    this.contsRootEl.update(html);
    this.contsRootEl.toggleClass("nwa-chat__history_unread", dialog.unreadCount > 0);
    this._updateFileLinks()
  }, _renderHistory:function(dialog, scrollBottomAnyway) {
    this._savedDialogObject = dialog;
    var scrollTop = -1;
    var h = this.contsRootEl.dom.scrollHeight;
    this.scrollBar.pauseDrag();
    if(!scrollBottomAnyway || dialog && dialog.insertingHistoryFlag) {
      scrollTop = this._getScroll()
    }
    var scrollBefore = this._getScroll();
    var scrollBottom = h - this.contsRootEl.dom.clientHeight - scrollTop;
    this.contsRootEl.hide();
    if(!dialog || !dialog.history || dialog.history.length == 0 && !dialog.historyLoaded) {
      this._renderPreloader()
    }else {
      if(dialog.history.length == 0 && dialog.isTel && !dialog.historyDisabled) {
        this._renderTel()
      }else {
        if(dialog.history.length == 0 && !dialog.historyDisabled) {
          this._renderEmpty()
        }else {
          this._renderMessages(dialog)
        }
      }
    }
    this.contsRootEl.show();
    this.contsRootEl.dom.scrollHeight;
    if(dialog && dialog.addingMessageFlag) {
      scrollTop = scrollBefore
    }else {
      if(scrollTop > -1) {
        scrollTop = this.contsRootEl.dom.scrollHeight - this.contsRootEl.dom.clientHeight - scrollBottom
      }
    }
    this._setScroll(scrollTop);
    this.scrollBar.resumeDrag();
    if(dialog) {
      delete dialog.insertingHistoryFlag;
      delete dialog.addingMessageFlag
    }
  }, _redrawHistory:function() {
    if(this._savedDialogObject) {
      this._renderHistory(this._savedDialogObject, false)
    }
  }, _scrollCheck:function() {
    if(this._scrollCheckTimer) {
      return
    }
    this._scrollCheckTimer = WA.setTimeout(function() {
      this._scrollCheckTimer = false;
      if(!this._uniq || this._blured) {
        return
      }
      if(this._getScroll() > -1 && !this._firstScrollFlag) {
        U.Mnt.countRB(1622999);
        this._firstScrollFlag = true
      }
      if(this.contsRootEl.dom.scrollHeight == this.contsRootEl.dom.offsetHeight || this._getScroll() > -1 && this._getScroll() < 200 && (this._noMoreHistoryFlag || U.Mnt.countRB(1623E3) || true)) {
        this.topScrolledEvent.fire()
      }else {
        this._scrollCheck()
      }
    }, 200, this)
  }, _markRead:function() {
    if(this.contsRootEl.hasClass("nwa-chat__history_unread")) {
      var lastEl = this.contsRootEl.last();
      while(lastEl) {
        lastEl = lastEl.removeClass("nwa-message-unread").prev()
      }
      this.contsRootEl.removeClass("nwa-chat__history_unread")
    }
  }, _setScroll:function(h) {
    if(this.contsRootEl.dom.children.length) {
      if(h == -1) {
        this.contsRootEl.dom.scrollTop = this.contsRootEl.dom.scrollHeight
      }else {
        this.contsRootEl.dom.scrollTop = h
      }
    }
    this._refreshScroll()
  }, _refreshScroll:function() {
    this.scrollBar.sync();
    WA.setTimeout(WA.createDelegate(this.scrollBar.sync, this.scrollBar), 400)
  }, _getScroll:function() {
    var e = this.contsRootEl.dom;
    if(e.scrollTop + e.clientHeight == e.scrollHeight) {
      return-1
    }else {
      return e.scrollTop
    }
  }, scrollBottom:function() {
    this._setScroll(-1)
  }, renderHistory:function(dialog, needRedraw, cb, scope) {
    var uniq = dialog.mail + dialog.modifDate;
    if(this._uniq != uniq || needRedraw) {
      this._renderHistory(dialog, true);
      this._uniq = uniq
    }else {
      if(dialog.unreadCount === 0) {
        this._markRead()
      }
    }
    this._scrollCheck()
  }, getLastMessage:function() {
    return this._lastMessage || {}
  }, deactivate:function() {
    delete this._uniq;
    if(this._fileLinksUpdateTimer) {
      clearTimeout(this._fileLinksUpdateTimer);
      this._fileLinksUpdateTimer = null
    }
  }, setTopPadding:function(h) {
    this.el.dom.style.top = h + "px"
  }, destroy:function() {
    WA.snippet.loadEvent.un(this._updateSnippetLinks, this);
    WA.Sticker.loadErrorEvent.un(this._updateStickers, this);
    WA.fileTools.loadEvent.un(this._updateFileLinks, this);
    History.superclass.destroy.call(this)
  }});
  var DialogInfoBubble = WA.extend(UI.Component, {constructor:function() {
    DialogInfoBubble.superclass.constructor.apply(this, arguments);
    this.visibleClass = "nwa-chat__infobubble_vis"
  }, _onRender:function(ct) {
    this.el = ct.createChild({cls:"nwa-chat__infobubble", children:[{cls:"nwa-chat__infobubble-wrap"}, {cls:"nwa-window__close", "data-action":"closebubble"}, {cls:"nwa-chat__infobubble-icon"}]});
    this.el.on("click", function(e) {
      var target = e.getTarget(true);
      if(target.getAttribute("data-action") === "closebubble") {
        this.hide()
      }
    }, this)
  }, show:function(params) {
    if(!this.rendered && this.autoRender !== false) {
      this.render(WA.isBoolean(this.autoRender) ? WA.getBody() : this.autoRender)
    }
    params = U.Object.extend({autoHide:true, msg:"", icon:""}, params || {});
    if(params.icon) {
      this.el.dom.className = "nwa-chat__infobubble nwa-chat__infobubble-" + params.icon
    }
    this.el.first().update(params.msg);
    this.setVisible(true);
    if(this._autoHideTimer) {
      clearTimeout(this._autoHideTimer)
    }
    if(params.autoHide) {
      this._autoHideTimer = WA.setTimeout(this.hide, 4E3, this)
    }
    return this
  }, isVisible:function() {
    return this.el && this.el.hasClass(this.visibleClass)
  }, setVisible:function(visible) {
    if(visible) {
      this.el.addClass(this.visibleClass)
    }else {
      clearTimeout(this._autoHideTimer);
      this.el.removeClass(this.visibleClass)
    }
    return this
  }, destroy:function() {
    if(this._autoHideTimer) {
      clearTimeout(this._autoHideTimer)
    }
    DialogInfoBubble.superclass.destroy.apply(this, arguments)
  }});
  var DialogView = WA.extend(UI.Component, {constructor:function(config, dialog) {
    DialogView.superclass.constructor.call(this, config);
    this.mail = dialog.mail;
    this.nick = dialog.cast[dialog.mail].nick;
    this._typingInfo = false;
    this._previewPhoto = null;
    this.features = parseInt(dialog.cast[dialog.mail].features || WA.SA.get(this.mail).features || 0);
    this.nickEditable = false;
    this.messageEvent = new U.Event;
    this.typingEvent = new U.Event;
    this.unreadedEvent = new U.Event;
    this.authActionEvent = new U.Event;
    this.openAddSearchEvent = new U.Event;
    this.outCallEvent = new U.Event;
    this.contactSelectEvent = new U.Event;
    this.minimizeEvent = new U.Event;
    this.openChatConsistEvent = new U.Event;
    this.closeChatConsistEvent = new U.Event;
    this.updateActivityEvent = new U.Event;
    this._textarea = new TextArea;
    this._textarea.changeEvent.on(this._onMessageChanged, this);
    this._textarea.expandEvent.on(this._onMessageExpand, this);
    this._textarea.submitEvent.on(this._onMessageSubmit, this);
    this.stickerEvent = (new U.Event).relay(this._textarea.stickerEvent);
    this._nameBox = new UI.NameBox;
    this._nameBox.editOk.on(function(newName) {
      this.renameContactEvent.fire(this.mail, newName)
    }, this);
    this.typingNotifyChecker = new U.DelayedTask({interval:1E4, fn:this._onTypingNotifyCheck, scope:this});
    this.tabButton = new UI.TabButton({closable:true, fader:true, defaultIconCls:"", tabAttributes:{mail:dialog.mail}});
    this._history = new History(this.mail);
    this.topScrolledEvent = (new U.Event).relay(this._history.topScrolledEvent);
    this.removeContactEvent = new U.Event;
    this.renameContactEvent = new U.Event;
    this._profile = new WA.Profile(false, {fadeIn:true, modal:true});
    this.requestListEvent = new U.Event;
    this.addContactEvent = new U.Event;
    this._initActionMenuItems()
  }, _historyClick:function(e) {
    var target = e.getTarget(true), id;
    if(target.getAttribute("data-action") === "add-tel") {
      this.openAddSearchEvent.fire();
      e.stopEvent()
    }else {
      if(target.getAttribute("data-action") === "sticker") {
        id = target.getAttribute("data-pack");
        WA.Sticker.isPackInstalled(id, WA.bind(function(result) {
          if(result) {
            this.openStickerMenu(id, true)
          }else {
            this.openShowcase(id)
          }
        }, this))
      }
    }
  }, updateTabInfo:function(dialog) {
    var info = this.fetchDialogInfo(dialog);
    this.el.setAttribute("status", info.status);
    this.tabButton.setText(info.nick || dialog.mail);
    this.tabButton.getEl().toggleClass("nwa-button-tab_offline", info.status == "offline");
    this.tabButton.getEl().toggleClass("nwa-button-tab_message", info.status == "message");
    this.tabButton.getEl().toggleClass("nwa-button-tab_unread", info.unread > 0);
    this.tabButton.setIconCls(WA.Statuses.buildCssClass(info.status, WA.isUIN(dialog.mail)));
    this.tabButton.setTitle(info.statusTitle);
    this.tabButton.setCount(info.unread)
  }, openSmilesMenu:function(tabIndex) {
    this._textarea.openSmilesMenu(tabIndex)
  }, openStickerMenu:function(tabIndex, openById) {
    this._textarea.openStickerMenu(tabIndex, openById)
  }, openShowcase:function(packId) {
    this._textarea.openShowcase(packId)
  }, fetchDialogInfo:function(dialog) {
    var mail = dialog.mail;
    var isChat = WA.MainAgent.isChat(mail);
    var statusTitle = dialog.auth && "auth" || isChat && "chat" || dialog.cast[mail].statusTitle;
    if(!statusTitle) {
      statusTitle = dialog.cast[mail].status && dialog.cast[mail].status.replace(/^icq_/, "") || "gray";
      var lastSeen = WA.CLD.getInfo(mail).lastseen;
      var lastSeenDate = lastSeen && new Date(lastSeen * 1E3);
      if(lastSeenDate && U.Date.getElapsed(lastSeenDate) / 1E3 < U.Date.DAY) {
        statusTitle = U.Date.formatLastSeenData(lastSeen)
      }
    }
    var status = dialog.typing && "typing" || dialog.unreaded && "message" || dialog.auth && "auth" || isChat && "chat" || lastSeen && U.Date.getElapsed(new Date(lastSeen * 1E3)) / 1E3 < U.Date.DAY && "away" || dialog.cast[mail].status || mail.indexOf("@uin.icq") != -1 && "icq_gray" || "gray";
    var oldNick = this.nick;
    this.nick = dialog.cast[mail].nick;
    if(oldNick && !this.nick) {
      WA.log("###Nick lost!", oldNick, this.nick, dialog.cast[mail])
    }
    return{nick:dialog.cast[mail].nick, status:status, statusTitle:WA.MainAgent.statuses[statusTitle] || statusTitle, features:dialog.cast[mail].features, unread:dialog.unreadCount}
  }, updateWindow:function(dialog, needRedraw) {
    var info = this.fetchDialogInfo(dialog);
    this.features = info.features;
    this._updateButtonBar(info);
    this.statusField.first().setAttribute("title", U.String.htmlEntity(info.statusTitle));
    this._nameBox.setName(this.nick || this.mail);
    this.statusField.first().dom.className = WA.Statuses.buildCssClass(info.status, WA.isUIN(this.mail));
    this.status = info.status;
    if(dialog.unreadCount === 0 && this._history.contsRootEl.hasClass("nwa-chat__history_unread")) {
      this._hideChatConsist()
    }
    this._history.renderHistory(dialog, needRedraw)
  }, _ignoreUser:function() {
    if(!this._ignoreDialog) {
      this._ignoreDialog = new WA.DialogsAgent.RemoveContactDialog({autoRender:this.winEl, okButton:WA.tr("box.ignore")});
      this._ignoreDialog.okEvent.on(function() {
        this.authActionEvent.fire({mail:this.mail, action:"ignore"})
      }, this)
    }
    this._ignoreDialog.show(WA.tr("box.ignoreUser", {nick:U.String.htmlEntity(this.nick)}))
  }, toggleBlacklistState:function(state) {
    this._blacklisted = !!state
  }, _toggleBlacklist:function() {
    WA.ma.notify.setEmailBlacklistState(this.mail, !this._blacklisted);
    this.toggleBlacklistState(!this._blacklisted)
  }, _spamUserConfirm:function() {
    if(!this._spamDialog) {
      this._spamDialog = new WA.DialogsAgent.RemoveContactDialog({autoRender:this.winEl, okButton:WA.tr("box.spamConfirm")});
      this._spamDialog.okEvent.on(this._spamUser, this)
    }
    this._spamDialog.show(WA.tr("box.spamUser", {nick:U.String.htmlEntity(this.nick)}))
  }, _spamUser:function() {
    var message = this._history.getLastMessage();
    this.authActionEvent.fire({mail:this.mail, action:"spam", msg_id:message.message_id || 0, text:message.text || ""})
  }, _openProfile:function() {
    this._profile.show(this.mail)
  }, _openPhoto:function(e) {
    e.stopPropagation();
    if(this._previewPhoto == null) {
      this._previewPhoto = new WA.PhotoPreview({mail:this.mail, nick:this.nick, autoRender:this.winEl, fadeIn:true, modal:true})
    }
    this._previewPhoto.show(this.mail, this.nick)
  }, _showLimitAlert:function(msg) {
    if(!this._alert) {
      this._alert = new WA.DialogsAgent.AlertDialog({fadeIn:true, modal:true, autoRender:this.winEl})
    }
    this._alert.show(msg)
  }, _showRemoveDialog:function() {
    if(!this._removeDialog) {
      this._removeDialog = new WA.DialogsAgent.RemoveContactDialog({okButton:WA.MainAgent.isChat(this.mail) ? WA.tr("box.leave") : WA.tr("box.remove"), autoRender:this.winEl});
      this._removeDialog.okEvent.on(function() {
        this.removeContactEvent.fire(this.mail)
      }, this)
    }
    this._removeDialog.show(WA.tr(WA.MainAgent.isChat(this.mail) ? "leaveChat" : "removeUser", {scope:"box", nick:U.String.htmlEntity(this.nick)}))
  }, _showAuthDialog:function(message) {
    var mail = message.from, nick = message.nick || WA.SA.get(mail).nick || mail;
    if(!this._authDialog) {
      this._authDialog = new WA.DialogsAgent.AuthContactDialog({autoRender:this.winEl});
      this._authDialog.okEvent.on(function(action) {
        this.authActionEvent.fire({mail:mail, action:action, nick:nick, msg_id:message.message_id, text:message.text})
      }, this)
    }
    this._authDialog.setMeta({mail:mail, nick:nick});
    this._authDialog.show()
  }, _showInfoBubble:function(msg, icon) {
    this._history.scrollBottom();
    if(!this.infoBubble) {
      this.infoBubble = new DialogInfoBubble({autoRender:this.winEl})
    }
    return this.infoBubble.show({msg:msg, icon:icon, autoHide:true})
  }, _onTypingNotifyCheck:function() {
    var now = +new Date;
    if(this._typingInfo && now - this._typingInfo.date < 9E3) {
      this.typingEvent.fire(this.mail);
      this.typingNotifyChecker.start()
    }else {
      this.typingNotifyChecker.stop()
    }
  }, _onMessageExpand:function(expanded) {
    this.expandTextField(expanded)
  }, _onMessageChanged:function(text) {
    if(text != "") {
      this._typingInfo = {date:+new Date, mail:this.mail};
      this.updateActivityEvent.fire(this.mail);
      if(!this.typingNotifyChecker.isStarted()) {
        this._onTypingNotifyCheck()
      }
    }
  }, _onMessageSubmit:function(text) {
    this._hideChatConsist();
    if(text.length <= MESSAGE_MAX_LENGTH) {
      if(this._call) {
        U.Mnt.countRB(this._call.videoCall ? 1379028 : 1216821)
      }
      this.expandTextField(false);
      this.messageEvent.fire(text);
      this.typingNotifyChecker.stop()
    }else {
      this._showLimitAlert();
      return false
    }
  }, focus:function(data) {
    this.renderWindow();
    this.el.addClass("nwa-dialog_expanded");
    this._history._blured = false;
    this._history.scrollBottom();
    this._history._scrollCheck();
    this._typingInfo = false;
    this._textarea.setFocus(true)
  }, _onRender:function(ct) {
    this.el = ct.createChild({tag:"div", cls:"nwa-dialog", id:"nwaDialog_" + this.mail, mail:this.mail});
    this.tabButton.render(this.el)
  }, blur:function() {
    if(this._removeDialog) {
      this._removeDialog.hide();
      this._removeDialog.destroy();
      this._removeDialog = null
    }
    if(this._alert) {
      this._alert.hide();
      this._alert.destroy();
      this._alert = null
    }
    this._textarea.deactivate();
    this.el.removeClass("nwa-dialog_expanded");
    this._history._blured = true;
    if(this._previewPhoto) {
      this._previewPhoto.hide()
    }
    if(this._swfPreview) {
      this._swfPreview.hide()
    }
    this._profile.hide();
    this._hideChatConsist()
  }, expandTextField:function(force) {
    this.el.toggleClass("nwa-chat_text_expanded", force !== false);
    WA.setTimeout(WA.createDelegate(this._history.scrollBottom, this._history), 200)
  }, _initActionMenuItems:function() {
    var langScope = {scope:"dialog.tools"};
    this._actionMenuItems = {spam:{iconCls:" ", text:WA.tr("spam", langScope), handler:this._spamUserConfirm, scope:this}, ignore:{iconCls:" ", text:WA.tr("ignore", langScope), handler:this._ignoreUser, scope:this}, rename:{altId:"rename", iconCls:" ", text:WA.tr("rename", langScope), handler:this._nameBox.edit, scope:this._nameBox}, del:{iconCls:" ", text:WA.tr(WA.MainAgent.isChat(this.mail) ? "leave" : "remove", langScope), handler:this._showRemoveDialog, scope:this}, profile:{iconCls:"nwa-dialog__tools-profile", 
    text:WA.tr("profile", langScope), handler:this._openProfile, scope:this}, blacklist:{altId:"blacklist", iconCls:" ", text:WA.tr("notifyOff", langScope), handler:this._toggleBlacklist, scope:this}, separate:"-"}
  }, _hideChatConsist:function() {
    if(!this.renderedWin) {
      return
    }
    this._btnChatMembers.setState(false);
    this._btnAddToChat.setState(false);
    this._chatConsistEditor && this._chatConsistEditor.hide()
  }, _onChatConsistOpen:function(isAdding) {
    if(!this._chatConsistEditor) {
      this.openChatConsistEvent.fire(function(ConferenceParti) {
        if(!ConferenceParti) {
          return
        }
        this._chatConsistEditor = ConferenceParti;
        ConferenceParti.isAdding = isAdding;
        ConferenceParti.mail = this.mail;
        ConferenceParti.name = this.nick;
        ConferenceParti.render(this.winEl);
        ConferenceParti.errorEvent.on(this._showLimitAlert, this);
        ConferenceParti.confirmEvent.on(this._hideChatConsist, this)
      }, this)
    }else {
      this._chatConsistEditor.isAdding = isAdding;
      this._chatConsistEditor.visible ? this._chatConsistEditor._onShow() : this._chatConsistEditor.show()
    }
  }, isChatConsistVisible:function() {
    return this._chatConsistEditor && this._chatConsistEditor.visible
  }, renderWindow:function() {
    if(this.renderedWin) {
      return
    }
    WA.Emoji.initSmiles();
    var iconUrl, profileItems = [], isIcq = this.mail.indexOf("@uin.icq") != -1, isChat = WA.MainAgent.isChat(this.mail), isTel = WA.MainAgent.isTel(this.mail);
    var winEl = this.winEl = this.el.createChild({tag:"div", cls:"nwa-chat" + (isChat ? " nwa-multichat" : ""), children:[{tag:"div", cls:"nwa-chat__shadow", children:[{tag:"div", cls:"nwa-chat__header", children:[{tag:"div", cls:"nwa-chat__header-avatar-wrap", children:[{tag:"div", cls:"nwa-chat__header-avatar"}]}, {cls:"nwa-chat__topbar", children:[{tag:"form"}]}, {cls:"nwa-chat__close nwa_action_close"}]}]}]}).first();
    var headerEl = this.headerEl = winEl.first();
    this._topBar = this.headerEl.first().next().first();
    this.statusField = headerEl.createChild({tag:"div", cls:"nwa-chat__header-status", children:[{tag:"span"}]});
    var langScope = {scope:"dialog.tools"};
    var itemRename = this._actionMenuItems.rename;
    if(!this.nickEditable) {
      this._actionMenuItems.rename.disabled = true
    }
    if(isTel) {
      profileItems = [itemRename, this._actionMenuItems.del]
    }else {
      if(isChat) {
        profileItems = [this._actionMenuItems.blacklist, this._actionMenuItems.spam, this._actionMenuItems.ignore, itemRename, this._actionMenuItems.del]
      }else {
        profileItems = [this._actionMenuItems.profile, this._actionMenuItems.separate, this._actionMenuItems.spam, this._actionMenuItems.ignore, itemRename, this._actionMenuItems.del]
      }
    }
    var toolsMenu = this.toolsMenu = new UI.menu.Menu({cls:"nwa-dialog__tools-menu", fadeIn:true, items:profileItems});
    this._tools = new UI.Button({cls:"nwa-chat__header-tools", tooltip:WA.tr("actions", langScope), scope:this, handler:function(obj, e) {
      e.stopPropagation()
    }, menu:toolsMenu});
    toolsMenu.showEvent.on(function() {
      if(isChat) {
        var item = toolsMenu.getItemById("blacklist");
        if(item) {
          item.button.setText(this._blacklisted ? WA.tr("dialog.tools.notifyOn") : WA.tr("dialog.tools.notifyOff"))
        }
        WA.chatController.getChatInfo(this.mail, 1)
      }else {
        WA.CLD.getAbInfo(this.mail, function(data) {
          if(data && this.mail) {
            this.nickEditable = !(data.abName || data.abPhone);
            this.updateToolsMenu()
          }
        }.bind(this))
      }
    }, this);
    this._btnChatMembers = new UI.ToggleButton({cls:"nwa-chat__topbar-button nwa-chat__topbar-members", tooltip:WA.tr("dialog.viewChatMembers"), scope:this, text:"<span></span>", handler:function(obj, e) {
      e.stopPropagation();
      this._btnAddToChat.setState(false);
      obj.setState(!obj.state);
      obj.state ? this._onChatConsistOpen(false) : this._hideChatConsist()
    }});
    this._btnAddToChat = new UI.ToggleButton({cls:"nwa-chat__topbar-button nwa-chat__topbar-add-contact", tooltip:WA.tr("dialog.addToChat"), scope:this, text:"<span></span>", handler:function(obj, e) {
      e.stopPropagation();
      this._btnChatMembers.setState(false);
      obj.setState(!obj.state);
      obj.state ? this._onChatConsistOpen(true) : this._hideChatConsist()
    }});
    this._btnUploadFile = new UI.FileButton({cls:"nwa-chat__topbar-button nwa-chat__topbar-upload", tooltip:WA.tr("dialog.sendFile"), preventDefault:false, handler:function(obj, e) {
      U.Mnt.countRB(13169722)
    }, change:this._onFileUploadChange, scope:this});
    this._btnChatMembers.render(this._topBar);
    this._btnAddToChat.render(this._topBar);
    this._btnUploadFile.render(this._topBar);
    this._nameBox.render(headerEl);
    this._nameBox.setName(this.nick || this.mail);
    this._tools.render(headerEl);
    this._history.render(winEl);
    this._textarea.render(winEl);
    if(isTel) {
      this._textarea.el.hide()
    }
    this._profile.render(winEl);
    this._history.getEl().on("click", this._historyClick, this);
    if(!isTel) {
      var avatar = headerEl.first();
      iconUrl = WA.makeAvatar(this.mail, this.nick, "_avatar" + (WA.isPopup ? 32 : 22), avatar.first());
      avatar.setStyle({cursor:"pointer"}).first().setStyle({"background-image":"url(" + iconUrl + ")"});
      avatar.on("click", this._openPhoto, this)
    }
    this.renderedWin = true
  }, applyChatInfo:function(info) {
    this.nickEditable = !(info.controlled && info.you && info.you.role != "admin");
    this.updateToolsMenu()
  }, updateToolsMenu:function() {
    if(this.nickEditable && this.toolsMenu.isVisible()) {
      var item = this.toolsMenu.getItemById("rename");
      if(item) {
        item.button.enable()
      }
    }
  }, _onFileUploadChange:function(fileNode, e) {
    if(!fileNode.dom.files || !fileNode.dom.files.length) {
      return
    }
    U.Mnt.countRB(13169726);
    this.updateActivityEvent.fire();
    WA.fileTools.sendFile(this.mail, fileNode.dom)
  }, _updateButtonBar:function(info) {
    var isChat = WA.MainAgent.isChat(this.mail), isTel = WA.MainAgent.isTel(this.mail), isSupport = WA.MainAgent.isSupport(this.mail), isUpload = !isSupport && !isTel && WA.fileTools.isUploadSupported();
    this._btnChatMembers.setVisible(isChat);
    this._btnAddToChat.setVisible(isChat);
    this._btnUploadFile.setVisible(isUpload);
    var btns = [];
    isChat && btns.push(this._btnChatMembers) && btns.push(this._btnAddToChat);
    isUpload && btns.push(this._btnUploadFile);
    var btnCount = btns.length;
    this.winEl.toggleClass("nwa-chat_no-topbar", btnCount == 0);
    this._topBar.dom.className = "nwa-chat__topbar nwa-chat__topbar_" + btnCount
  }, _onAfterRender:function() {
    DialogView.superclass._onAfterRender.call(this)
  }, deactivate:function() {
    this.typingNotifyChecker.stop();
    this._history.deactivate();
    this._textarea.deactivate()
  }, _animateClosing:function() {
    if(this.el && !WA.isFF) {
      var tmpEl = '<div class="nwa-dialog nwa-dialog_dummy"></div>';
      tmpEl = U.DomHelper.insertHtml("beforeBegin", this.el.dom, tmpEl, true);
      WA.setTimeout(function() {
        tmpEl.setWidth(0)
      }, 10);
      WA.setTimeout(function() {
        tmpEl.remove()
      }, 1E3)
    }
  }, destroy:function() {
    if(this.infoBubble) {
      this.infoBubble.destroy()
    }
    if(this._chatConsistEditor) {
      this._chatConsistEditor.destroy()
    }
    this._textarea.destroy();
    this._history.destroy();
    this._animateClosing();
    DialogView.superclass.destroy.call(this)
  }});
  var DialogTabs = WA.extend(UI.Component, {constructor:function(config) {
    DialogTabs.superclass.constructor.apply(this, arguments);
    this.MAX_TABS_VISIBLE = 4;
    this.TAB_WIDTH = 207;
    this.TAB_ACTIVE_WIDTH = 307;
    this.TABS_MAX_SUM_WIDTH = this.TAB_WIDTH * (this.MAX_TABS_VISIBLE - 2) + 2 * this.TAB_ACTIVE_WIDTH;
    this.TABS_UPDATE_INTERBAL = 50;
    this.closeTabEvent = new U.Event;
    this.changeFocusEvent = new U.Event;
    this.messageEvent = new U.Event;
    this.renameContactEvent = new U.Event;
    this.removeContactEvent = new U.Event;
    this.typingEvent = new U.Event;
    this.minimizedEvent = new U.Event;
    this.authActionEvent = new U.Event;
    this.contactSelectEvent = new U.Event;
    this.addContactEvent = new U.Event;
    this.updateActivityEvent = new U.Event;
    this.topScrolledEvent = new U.Event;
    this.openChatConsistEvent = new U.Event;
    this.closeChatConsistEvent = new U.Event;
    this.requestListEvent = new U.Event;
    this.openAddSearchEvent = new U.Event;
    this._openedDialogs = [];
    this._previews = {};
    this._dialogs = {};
    this._focused = false;
    this._modifDate = false;
    this._hidePreviews = false;
    this._localData = {};
    this._timer = 0;
    this._hiddenTabsCount = 0;
    WA.chatController.infoReadyEvent.on(this._onChatInfoReady, this)
  }, _onRender:function(ct) {
    this.el = ct.createChild({tag:"div", cls:"nwa-root__dialogs", children:[{tag:"div", id:"nwaDialogs", cls:"nwa-root__dialogs-inner"}]});
    this.el = this.el.first();
    this.el.on("click", this._onClick, this);
    this.el.on("mousedown", this._onMouseDown, this);
    this.el.on("mouseup", this._onMouseUp, this);
    WA.get(window).on("resize", function() {
      if(this._timer == 0) {
        this.refreshTabBar(false, true)
      }
    }, this)
  }, show:function() {
    DialogTabs.superclass.show.apply(this, arguments)
  }, hide:function() {
    DialogTabs.superclass.hide.apply(this, arguments)
  }, _onMouseDown:function(ev) {
    var target = ev.getTarget();
    var mail = target.getAttribute && target.getAttribute("mail");
    if(mail && ev.browserEvent.which == 2) {
      this._wheelClick = mail;
      ev.preventDefault()
    }
  }, _onMouseUp:function(ev) {
    var target = ev.getTarget();
    var mail = target.getAttribute("mail");
    if(ev.browserEvent.which == 2 && this._wheelClick && this._wheelClick == mail) {
      target.className = "wa-tab-close";
      this._onClick(ev)
    }
    delete this._wheelClick
  }, _onClick:function(ev) {
    var target = ev.getTarget(true);
    var dialogRoot = this._findDialogRootNode(target);
    if(!dialogRoot) {
      return
    }
    var mail = dialogRoot.getAttribute("mail");
    var action = target.getAttribute("data-action") || target.parent().getAttribute("data-action");
    if(target.hasClass("nwa_action_close") || target.parent().hasClass("nwa_action_close")) {
      this.closeTabEvent.fire(mail);
      ev.stopEvent();
      return
    }
    if(action === "resend") {
      var text = U.String.entityDecode(target.getAttribute("data-text"));
      this.messageEvent.fire(mail, text, true);
      U.Mnt.countRB(1335025);
      return
    }
    if(action === "upload-abort") {
      WA.fileTools.abort(target.getAttribute("data-id"));
      return
    }
    if(target.up("nwa-message__actions")) {
      if(action) {
        var text = U.String.entityDecode(target.getAttribute("data-text"));
        var msgId = target.getAttribute("data-msg-id");
        var nick = this.nick || WA.SA.get(mail).nick || mail;
        this.authActionEvent.fire({mail:mail, action:action, nick:nick, msg_id:msgId, text:text})
      }
      return
    }
    if(target.up("nwa-chat__header")) {
      if(!target.up("nwa-voip-talk") && !target.up("nwa-chat__topbar")) {
        this.minimizedEvent.fire()
      }
      return
    }
    if(target.up("nwa-button-tab") || action == "expand") {
      this.changeFocusEvent.fire(mail)
    }
  }, _findDialogRootNode:function(node) {
    return node.up("nwa-dialog")
  }, hideChatConsistEditor:function(mail) {
    this._dialogs[mail] && this._dialogs[mail]._hideChatConsist()
  }, _startPreviewsTimer:function() {
    if(this._previewTimer) {
      return
    }
    this._previewTimer = WA.setTimeout(function() {
      for(var i in this._previews) {
        delete this._previews[i]
      }
      this._previewTimer = null;
      this._focused && this._startPreviewsTimer()
    }, 6E5, this)
  }, _renderTabs:function(dlg) {
    var dialogsEl = this.el, openDialogs = [];
    var dialogs = U.Array.clone(dlg);
    if(dialogs.length > 4) {
      dialogs = dialogs.splice(dialogs.length - 4, 4)
    }
    U.Array.each(dialogs, function(dialog, i) {
      if(!dialog.cast[dialog.mail]) {
        return
      }
      openDialogs.push(dialog.mail);
      if(this._openedDialogs.length <= i) {
        this._openedDialogs.push(dialog.mail)
      }
      var objDialog = this._dialogs[dialog.mail];
      if(!objDialog) {
        objDialog = new DialogView({}, dialog);
        objDialog.updateActivityEvent.on(function() {
          this.updateActivityEvent.fire(dialog.mail)
        }, this);
        objDialog.typingEvent.on(function() {
          this.typingEvent.fire(dialog.mail)
        }, this);
        objDialog.messageEvent.on(function(text) {
          this.messageEvent.fire(dialog.mail, text)
        }, this);
        objDialog.stickerEvent.on(function(packId, stickerId) {
          this.messageEvent.fire(dialog.mail, {pack_id:packId, sticker_id:stickerId}, false, false, true)
        }, this);
        objDialog.renameContactEvent.on(function(mail, nick) {
          this.renameContactEvent.fire(mail, nick)
        }, this);
        objDialog.removeContactEvent.on(function(mail) {
          this.removeContactEvent.fire(mail)
        }, this);
        objDialog.authActionEvent.on(function(params) {
          this.authActionEvent.fire(params)
        }, this);
        objDialog.minimizeEvent.on(function(params) {
          this.minimizedEvent.fire(params)
        }, this);
        this.contactSelectEvent.relay(objDialog.contactSelectEvent);
        this.requestListEvent.relay(objDialog.requestListEvent);
        this.openChatConsistEvent.relay(objDialog.openChatConsistEvent);
        this.closeChatConsistEvent.relay(objDialog.closeChatConsistEvent);
        this.openAddSearchEvent.relay(objDialog.openAddSearchEvent);
        this.addContactEvent.relay(objDialog.addContactEvent);
        this.topScrolledEvent.relay(objDialog.topScrolledEvent);
        objDialog._history._previews = this._previews;
        objDialog.render(dialogsEl);
        this._dialogs[dialog.mail] = objDialog
      }
      this._startPreviewsTimer();
      objDialog.updateTabInfo(dialog)
    }, this);
    U.Array.each(this._openedDialogs, function(dialog, i) {
      if(U.Array.indexOf(openDialogs, dialog) == -1) {
        this._destroyDialog(dialog)
      }
    }, this);
    this._openedDialogs = openDialogs
  }, _destroyDialog:function(mail) {
    if(this._dialogs[mail]) {
      this._dialogs[mail].deactivate();
      this._dialogs[mail].destroy();
      delete this._dialogs[mail]
    }
    if(this._focused == mail) {
      this._focused = false
    }
  }, updateView:function(data) {
    if(this._modifDate != data.dialogsModifDate) {
      this._modifDate = data.dialogsModifDate;
      this._renderTabs(data.dialogs)
    }
    return this.setFocus(data)
  }, _onChatInfoReady:function(chatId, success, info) {
    if(success && this._dialogs[chatId]) {
      this._dialogs[chatId].applyChatInfo(info)
    }
  }, refreshTabBar:function(forceRefresh, forceTimeout) {
    clearTimeout(this._timer);
    this._timer = 0;
    this._refreshTabsVisibility(forceRefresh);
    if(forceTimeout) {
      this._timer = WA.setTimeout(WA.createDelegate(function() {
        this.refreshTabBar(forceRefresh)
      }, this), this.TABS_UPDATE_INTERBAL)
    }
  }, _refreshTabsVisibility:function(forceRefresh) {
    var tabsCapacity = this.calcAvailableSpace(this._focused);
    var tabsToHide = this._openedDialogs.length - tabsCapacity;
    if(tabsToHide != this._hiddenTabsCount || forceRefresh) {
      this._hiddenTabsCount = tabsToHide;
      U.Array.each(this._openedDialogs, function(dialog, i) {
        if(tabsToHide > 0 && dialog != this._focused) {
          this._dialogs[dialog].getEl().addClass("nwa-dialog_hidden");
          tabsToHide--
        }else {
          this._dialogs[dialog].getEl().removeClass("nwa-dialog_hidden")
        }
      }, this)
    }
  }, calcAvailableSpace:function(hasFocused) {
    var actualWidth = this.el.getWidth();
    if(actualWidth > this.TABS_MAX_SUM_WIDTH) {
      return this.MAX_TABS_VISIBLE
    }
    var tabsCapacity = 0;
    if(hasFocused) {
      tabsCapacity++;
      actualWidth -= this.TAB_ACTIVE_WIDTH
    }
    U.Array.eachReverse(this._openedDialogs, function(dialog, i) {
      if(dialog == this._focused) {
        return
      }
      var tabWidth = this.TAB_WIDTH;
      if(tabWidth >= actualWidth) {
        return false
      }
      tabsCapacity++;
      actualWidth -= tabWidth
    }, this);
    return tabsCapacity
  }, calcAvailableSpace_old:function(hasFocused) {
    var actualWidth = this.el.getWidth(), diffWidth = 0;
    if(actualWidth > this.TABS_MAX_SUM_WIDTH) {
      return this.MAX_TABS_VISIBLE
    }
    diffWidth = this.TAB_WIDTH * (this.MAX_TABS_VISIBLE - 1) + (hasFocused ? this.TAB_ACTIVE_WIDTH : this.TAB_WIDTH) - actualWidth;
    if(diffWidth <= 0) {
      return this.MAX_TABS_VISIBLE
    }
    return this.MAX_TABS_VISIBLE - Math.ceil(diffWidth / this.TAB_WIDTH)
  }, setFocus:function(data) {
    if(this._focused && this._focused != data.focused) {
      this._dialogs[this._focused].blur()
    }
    if(!data.focused) {
      WA.fireSharedEvent("dialogFocusChanged", {focused:false});
      this._focused = false;
      this.refreshTabBar(true);
      return false
    }
    var index = this._indexOf(data.dialogs, data.focused);
    var dialog = data.dialogs[index];
    var focusedDialog = this._dialogs[data.focused];
    var needRedraw = focusedDialog._history._hidePreviews != this._hidePreviews;
    focusedDialog._history._hidePreviews = this._hidePreviews;
    if(this._focused != data.focused) {
      WA.fireSharedEvent("dialogFocusChanged", {focused:data.focused});
      this._focused = data.focused;
      focusedDialog.focus(dialog)
    }
    focusedDialog.updateWindow(dialog, needRedraw);
    this.refreshTabBar(true);
    return data.focused
  }, _indexOf:function(dialogs, mail) {
    return U.Array.indexOfBy(dialogs, function(dialog) {
      if(dialog.mail == mail) {
        return true
      }
    })
  }, isFirst:function(mail) {
    var first = this.el.first();
    if(first && !first.getAttribute("mail")) {
      first = first.next()
    }
    return first ? first.getAttribute("mail") == mail : false
  }, deactivate:function() {
    this._focused = false;
    this._modifDate = false;
    if(this._previewTimer) {
      clearTimeout(this._previewTimer);
      this._previewTimer = null
    }
    U.Array.each(this._openedDialogs, function(dialog, i) {
      this._destroyDialog(dialog)
    }, this);
    this._openedDialogs = []
  }});
  WA.DialogsAgentView = DialogTabs;
  function isText(s) {
    return s.length > 0 && s != " "
  }
  function buildRichMessage(text, msgId, options) {
    var ret = text;
    var mark = (new Date).getTime();
    var MARK_FORMAT = "{0}" + mark + "_{1}";
    var links = [], mediaContent = false, mixedContent = false, textBlockBefore, lastOffset = 0, ending = "";
    var html = "", plainHtml = "";
    ret = ret.replace(WA.DialogsAgent.REG_URL, function(str, href, offset, src) {
      if(msgId) {
        WA.DialogsAgent.bindUrlToMessage(msgId, href)
      }
      textBlockBefore = false;
      if(offset > 0 && isText(src.substring(lastOffset, offset))) {
        textBlockBefore = mixedContent = true;
        if(links.length > 0) {
          links[links.length - 1].textAfter = true
        }
      }
      ending = src.substr(offset + str.length);
      href = U.String.htmlEntity(href);
      links.push({href:href, name:href, textBefore:textBlockBefore});
      var replacing = U.String.format(MARK_FORMAT, "L", links.length - 1) + str.substr(href.length);
      lastOffset = offset + str.length;
      return replacing
    });
    if(ending && isText(ending)) {
      mixedContent = true;
      links[links.length - 1].textAfter = true
    }
    ret = U.String.htmlEntity(ret);
    ret = WA.Emoji.parse(ret);
    ret = ret.replace(/(\n|\r\n)/g, "<br />").replace(/(\t)/g, "    ");
    ret = ret.replace(/ (\s+)/g, function(m, spaces) {
      return(new Array(spaces.length + 1)).join("&nbsp;")
    });
    if(links.length) {
      ending = "";
      lastOffset = 0;
      ret = ret.replace(new RegExp("(L)" + mark + "_(\\d+)", "g"), function(str, key, index, offset, src) {
        index = parseInt(index);
        if(WA.isNumber(index) && index >= 0) {
          if("L" === key) {
            if(index < links.length) {
              if(offset > 0 && isText(src.substring(lastOffset, offset))) {
                html += '<span class="icq-message__textblock' + (index == 0 ? " icq-message_first" : "") + '">' + src.substring(lastOffset, offset) + "</span>";
                plainHtml += src.substring(lastOffset, offset)
              }
              lastOffset = offset + str.length;
              var currentLink = links[index], linkName = currentLink.name, href = currentLink.href, attrs = currentLink.notImage ? 'notimage="true"' : "", overlay = "", forward = "", cls = options.showSnippet ? "waRawLink" : "waKeepLink", wrapCls = "", flags = 0, snippet, fileData;
              if(mixedContent) {
                flags += WA.snippet.FLAG_TEXT_MIX
              }
              if(currentLink.textBefore) {
                flags += WA.snippet.FLAG_TEXT_BEFORE
              }
              if(currentLink.textAfter) {
                flags += WA.snippet.FLAG_TEXT_AFTER
              }
              if(index == 0 && html == "") {
                wrapCls += " icq-message_first"
              }
              if(offset + str.length == src.length) {
                wrapCls += " icq-message_last"
              }
              if(options.showPreview) {
                mediaContent = true;
                fileData = WA.fileTools.resolveLinkAsFile(href, true);
                if(!fileData && options.showSnippet) {
                  snippet = WA.snippet.getPreviewCode(href, null, flags)
                }
              }
              if(fileData) {
                html += WA.fileTools.getPreviewCode(fileData.id, fileData.url || href)
              }else {
                if(snippet) {
                  html += '<span class="' + wrapCls + '">' + snippet + "</span>"
                }else {
                  html += U.String.format('<span class="icq-message__textblock{8}" data-class="{8}"><a class="{5}" data-orig="{6}" data-flags="{7}" href="{0}" rel="nofollow noopener noreferrer" target="_blank" {2}>{1}{3}{4}</a></span>', href, linkName, attrs, overlay, forward, cls, encodeURIComponent(href), flags, wrapCls)
                }
              }
              ending = src.substr(offset + str.length);
              return""
            }
          }
        }
        return str
      });
      if(ending && isText(ending)) {
        html += '<span class="icq-message__textblock icq-message_last">' + ending + "</span>"
      }
    }else {
      html = '<span class="icq-message__textblock icq-message_first icq-message_last">' + ret + "</span>"
    }
    return{html:html, media:mediaContent}
  }
})();
(function() {
  var WA = WebAgent;
  var U = WA.util;
  var SOCK = WA.ConnectionFacade;
  WA.DialogsAgent = WA.Activatable.extend(Object, {constructor:function(config) {
    WA.DialogsAgent.superclass.constructor.call(this, config);
    this.countChangedEvent = new U.Event;
    this.unreadedEvent = new U.Event;
    this.minimizedEvent = new U.Event;
    this.incomingMessageEvent = new U.Event;
    this.closeTabEventEvent = new U.Event;
    this.updateActivityEvent = new U.Event;
    this.sendMessageEvent = new U.Event;
    this.visibleDialogChangedEvent = new U.Event;
    this.abstraction = new WA.DialogsAbstraction;
    this.incomingMessageEvent = (new U.Event).relay(this.abstraction.incomingMessageEvent);
    this.selfNameReadyEvent = (new U.Event).relay(this.abstraction.selfNameReadyEvent);
    this.abstraction.updateActivityEvent.on(this._onUpdateActivity, this);
    this._view = new WA.DialogsAgentView;
    this._view.changeFocusEvent.on(this._onTabsFocusChange, this);
    this._view.updateActivityEvent.on(this._onUpdateActivity, this);
    this.changeFocusEvent = (new U.Event).relay(this._view.changeFocusEvent);
    this.requestListEvent = (new U.Event).relay(this._view.requestListEvent);
    this.addContactEvent = (new U.Event).relay(this._view.addContactEvent);
    this._view.closeTabEvent.on(this._onTabClose, this);
    this._view.messageEvent.on(this._onMessageSubmit, this);
    this._view.typingEvent.on(this._onMessageTyping, this);
    this._view.minimizedEvent.on(function() {
      if(!WA.isPopup) {
        this.abstraction.blur();
        this.minimizedEvent.fire()
      }
    }, this);
    this._view.renameContactEvent.on(function(mail, newNick) {
      this.renameContactEvent.fire(mail, newNick);
      this.abstraction.renameContact(mail, newNick)
    }, this);
    this._view.removeContactEvent.on(function(mail) {
      this.abstraction.close(mail, true);
      this.removeContactEvent.fire(mail)
    }, this);
    this._view.authActionEvent.on(this._onAuthAction, this);
    this._view.topScrolledEvent.on(this.abstraction.loadHistoryPart, this.abstraction);
    this.openAddSearchEvent = (new U.Event).relay(this._view.openAddSearchEvent);
    this._view.contactSelectEvent.on(this.openDialog, this);
    this._view.openChatConsistEvent.on(this._openChatConsist, this);
    this.removeContactEvent = new U.Event;
    this.renameContactEvent = new U.Event;
    WA.UserAttend.attendEvent.on(this._onUserAttend, this);
    WA.Voip.callEvent.on(this._checkCallEvent, this);
    WA.Voip.updateActivityEvent.on(this._onUpdateActivity, this);
    this._titleAnimator = new WA.DialogsAgent.TitleAnimator
  }, _onMessageSubmit:function(mail, text, resend, flash, sticker, file) {
    this.abstraction.postMessage(mail, text, resend, flash, sticker);
    if(!file) {
      var clistData = this._extractClistData(this.abstraction._cache.dm.get(mail));
      this.updateActivityEvent.fire(clistData)
    }
    this.sendMessageEvent.fire()
  }, _extractClistData:function(dialog, isRawData) {
    return this.abstraction._extractClistData(dialog, isRawData)
  }, _onUpdateActivity:function(clistData, type) {
    var dlg, clistData_tmp = clistData;
    if(typeof clistData === "string") {
      dlg = this.abstraction._cache.dm.getIfExist(clistData);
      if(!dlg) {
        dlg = WA.SA.get(clistData);
        clistData = this._extractClistData(dlg, true)
      }else {
        clistData = this._extractClistData(dlg)
      }
    }
    if(clistData && !clistData[0]) {
      U.Mnt.log({reason:"breaklog", text:"actUpdate: data not found for email=" + clistData_tmp + " type=" + type + " user=" + WA.ACTIVE_MAIL});
      return
    }
    this.updateActivityEvent.fire(clistData, type)
  }, _checkCallEvent:function(type, params) {
    if(params && params.email) {
      var text = WA.Voip.historyMessages[type];
      if(text) {
        this.abstraction.addServiceMessage(params.email, WA.tr("voip.voiceCalls"), text)
      }
    }
  }, _onTabsFocusChange:function(mail, isBottom) {
    this.abstraction.focus(mail);
    this.visibleDialogChangedEvent.fire(mail)
  }, closeDialog:function(email) {
    this.abstraction.close(email, true);
    this.closeTabEventEvent.fire(email)
  }, _onTabClose:function(email) {
    this.abstraction.close(email);
    this.closeTabEventEvent.fire(email)
  }, _onAuthAction:function(params) {
    var mail = params.mail, action = params.action;
    if("add" === action) {
      WA.MainAgent.sendAddContact(mail, params.nick, function(success) {
        if(success) {
          this.abstraction.makeAuthorized()
        }else {
          this.abstraction.close(mail)
        }
      }, this)
    }else {
      if("cancel" === action) {
        this.abstraction.close(mail, true)
      }else {
        if("ignore" === action) {
          WA.IcqApi.ignoreContact({email:mail});
          this.abstraction.close(mail, true);
          WA.ChangeLog.logAction("remove", {email:mail})
        }else {
          if("spam" === action) {
            if(params.text) {
              WA.IcqApi.sendMessage({spam:1, to:mail, message_id:params.msg_id, text:params.text})
            }
            this.abstraction.close(mail, true);
            this.removeContactEvent.fire(mail)
          }
        }
      }
    }
  }, _onMessageTyping:function(mail) {
    var clistData = this._extractClistData(this.abstraction._cache.dm.get(mail));
    this.updateActivityEvent.fire(clistData);
    WA.IcqApi.sendTyping({to:mail})
  }, _openChatConsist:function(clbk, scope) {
    var confCons = new WA.ConferenceParti;
    if(confCons) {
      confCons.selectEvent.on(function(mail, nick, status, title, features, action) {
        var call, focused = this.getVisibleDialog();
        switch(action) {
          case "videocall":
          ;
          case "voicecall":
            call = true;
          case "message":
            this.openDialog(mail, nick, status, title, features);
            return false
        }
      }, this);
      confCons.hideEvent.on(function() {
        this.markAsReaded()
      }, this)
    }
    clbk && clbk.call(scope || window, confCons)
  }, _onAbstractionUpdate:function(data) {
    this.countChangedEvent.fire(data.dialogs.length);
    var focusedEmail = this._view.updateView(data);
    if(!focused) {
    }
    var focused = this.getFocusedDialogView();
    if(focused && WA.MainAgent.isChat(focusedEmail) && WA.CLD.getMute(focusedEmail)) {
      focused.toggleBlacklistState(true)
    }
    if(WA.UserAttend.isAttend && (!focused || !focused.isChatConsistVisible())) {
      this.markAsReaded()
    }
    var duty = this._dutyUnreaded = this._getDutyUnreaded(data);
    this.unreadedEvent.fire(+WA.ContactStates.hasUnread());
    if(duty.count) {
      this._titleAnimator.start(duty.count, U.String.entityDecode(duty.nick))
    }else {
      this._titleAnimator.stop()
    }
  }, _getDutyUnreaded:function(data) {
    var res = {count:0, dialog:false};
    var date = 0;
    U.Array.each(data.dialogs, function(dlg) {
      if(!dlg.unreaded) {
        return
      }
      if(WA.CLD.getMute(dlg.mail)) {
        return
      }
      res.count++;
      if(date < dlg.modifDate) {
        date = dlg.modifDate;
        res.dialog = dlg
      }
    }, this);
    if(res.dialog) {
      var mail = res.dialog.mail;
      var c = res.dialog.cast[mail];
      WA.apply(res, {mail:mail, nick:c.nick, status:c.status, statusTitle:c.statusTitle})
    }
    return res
  }, _onUserAttend:function() {
    this.markAsReaded()
  }, markAsReaded:function(mail, mid) {
    this.abstraction.markAsReaded(mail, mid);
    if(!mail) {
      var focused = this.getVisibleDialog();
      mail = focused && focused.mail
    }
    if(WA.ma._promoSms && mail) {
      WA.ma._promoSms.updateUserReadMessage()
    }
  }, render:function(ct) {
    this._view.render(ct)
  }, openDialog:function(mail, nick, status, statusTitle, features, phones) {
    this._view.hideChatConsistEditor(mail);
    this.abstraction.open(mail, nick, status, statusTitle, features, phones)
  }, hasDialogs:function() {
    return this.abstraction._cache.dm.getDialogCount() > 0
  }, minimize:function() {
    this.abstraction.blur()
  }, togglePreviews:function(hidePreviews) {
    var fData = this.abstraction._cache.dm && this.abstraction._cache.dm.getFocused();
    var fView = this.getFocusedDialogView();
    this._view._hidePreviews = hidePreviews;
    if(fData && fView) {
      fView._history._hidePreviews = hidePreviews;
      fView._history._renderHistory(fData.data)
    }
  }, getFocusedDialogView:function() {
    return this._view._focused && this._view._dialogs[this._view._focused]
  }, _onSharedEvent:function(type, data) {
  }, activate:function(cb, scope) {
    return WA.DialogsAgent.superclass.activate.call(this, {cb:cb, scope:scope})
  }, _onActivate:function(params) {
    WA.listenSharedEvent(this._onSharedEvent, this);
    this.abstraction.updateEvent.on(this._onAbstractionUpdate, this);
    this.abstraction.activate(params.cb, params.scope)
  }, _onDeactivate:function() {
    WA.unlistenSharedEvent(this._onSharedEvent, this);
    this.abstraction.updateEvent.un(this._onAbstractionUpdate, this);
    this.abstraction.deactivate();
    this._view.deactivate();
    this._titleAnimator.stop()
  }, actualize:function(cb, scope) {
    cb && cb.call(scope || window)
  }, enableUserEvents:function() {
  }, disableUserEvents:function() {
  }, getOpenDialogs:function() {
    return this.abstraction.getOpenDialogs()
  }, getVisibleDialog:function() {
    return this.abstraction.getFocused()
  }});
  WA.DialogsAgent.buildPlainHtmlMessage = function(msg) {
    msg = U.String.htmlEntity(msg);
    msg = WA.Emoji.parse(msg);
    msg = msg.replace(/(\n|\r\n)/g, "<br />").replace(/(\t)/g, "    ");
    msg = msg.replace(/ (\s+)/g, function(m, spaces) {
      return(new Array(spaces.length + 1)).join("&nbsp;")
    });
    return msg
  };
  var _urlIds = {};
  var REG_URL = WA.DialogsAgent.REG_URL = /(https?:\/\/(?:[\w-]+\.[\w\.-]+\w(?::\d*)?(?:\/\S*?)?))(?:[\.,\?!:;]*(?=\s|$))/ig;
  var REG_FIRST_URL = new RegExp(REG_URL.source, "i");
  function extractUrlFromText(text) {
    var res = text.match(REG_FIRST_URL);
    return res && res[0] || ""
  }
  WA.DialogsAgent.extractUrlFromMessage = function(msgId, text) {
    var url = _urlIds[msgId] || extractUrlFromText(text);
    if(url) {
      this.bindUrlToMessage(msgId, url);
      return url
    }
  };
  WA.DialogsAgent.bindUrlToMessage = function(msgId, url) {
    if(msgId && !_urlIds[msgId]) {
      _urlIds[msgId] = url
    }
  };
  WA.DialogsAgent.getMediaBlockMaxSize = function() {
    return WA.isPopup ? 320 : 200
  }
})();
(function() {
  var WA = WebAgent;
  WA.DialogsAgent.TitleAnimator = WA.extend(Object, {constructor:function() {
    this.originalTitle = document.title;
    this.updater = new WA.util.DelayedTask({interval:500, fn:this._doUpdate, scope:this});
    this._reset()
  }, _reset:function() {
    this.index = 0;
    this.unreadCount = 0;
    this.subTitle = "";
    this._lastTitle = false
  }, _getTitle:function() {
    var index = this.index;
    if(0 === index) {
      return WA.tr("titleAnimator", {count:this.unreadCount})
    }else {
      if(1 === index) {
        return this.subTitle
      }else {
        if(2 === index) {
          return"*************"
        }else {
          return this.originalTitle
        }
      }
    }
  }, _doUpdate:function() {
    if(document.title != this._lastTitle) {
      this.originalTitle = document.title
    }
    document.title = this._lastTitle = this._getTitle();
    this.index = ++this.index >= 3 ? 0 : this.index;
    this.updater.start()
  }, start:function(count, title) {
    if(!this.updater.isStarted()) {
      this._reset()
    }
    this.unreadCount = count;
    this.subTitle = WA.util.String.trim(title);
    this._doUpdate()
  }, stop:function() {
    if(this.updater.isStarted()) {
      this.updater.stop();
      if(document.title == this._lastTitle) {
        document.title = this.originalTitle
      }
    }
  }})
})();
(function() {
  var WA = WebAgent, U = WA.util, UI = WA.ui;
  var PicturesMenu = WA.extend(UI.Layer, {constructor:function(config) {
    var cfg = WA.applyIf(config || {}, {cls:"nwa-dialog__pictures", hideOnClick:false, fadeIn:true});
    PicturesMenu.superclass.constructor.call(this, cfg);
    this.itemClickEvent = new U.Event
  }, _onShow:function() {
    if(!this.btnStickers) {
      this.emojiMenu = new UI.TabBox({autoRender:this.el, dataSource:EmojiDS, fadeIn:false, flatStyle:true, cls:"nwa-dialog__emojipicker", clsTab:"nwa-emoji_tab", clsTabLayer:"nwa-emoji_set", hideOnEscape:false, hideOnClick:false});
      this.emojiMenu.itemClickEvent.on(function(code) {
        this.hide();
        this.itemClickEvent.fire("emoji", {id:code})
      }, this);
      this.btnEmoji = new UI.ToggleButton({cls:"nwa-dialog__pictures-btn nwa-dialog__pictures-btn_smiles", scope:this, text:"<span></span>", linkedLayer:this.emojiMenu, handler:function(obj, e) {
        e.stopPropagation();
        this.switchMenu(0)
      }});
      this.btnEmoji.render(this.el);
      this.stickerMenu = new UI.TabBox({externalResources:true, autoRender:this.el, dataSource:StickerDS, fadeIn:false, flatStyle:true, cls:"nwa-dialog__stickerpicker", clsTab:"nwa-sticker-tab nwa-sticker-tab-n", clsTabLayer:"nwa-sticker_set", hideOnClick:false, hideOnEscape:false});
      this.stickerMenu.itemClickEvent.on(function(code) {
        this.hide();
        code = code.split("#");
        this.itemClickEvent.fire("sticker", {pack:code[0], id:code[1]})
      }, this);
      this.btnStickers = new UI.ToggleButton({cls:"nwa-dialog__pictures-btn nwa-dialog__pictures-btn_stickers", tooltip:WA.tr("sticker.stickers"), scope:this, text:"<span></span>", linkedLayer:this.stickerMenu, handler:function(obj, e) {
        e.stopPropagation();
        this.switchMenu(1)
      }});
      this.btnStickers.render(this.el);
      this.showcase = new WA.DialogsAgent.Showcase({autoRender:this.el});
      this.showcase.closeEvent.on(function(ignored, item, ev) {
        this.hide()
      }, this);
      this.showcase.packInstalledEvent.on(function(packId) {
        WA.Sticker.requestContent(WA.bind(function() {
          this.switchMenu(1, packId, true)
        }, this))
      }, this);
      this.btnShowcase = new UI.ToggleButton({cls:"nwa-dialog__pictures-btn nwa-dialog__pictures-btn_showcase", tooltip:WA.tr("sticker.showcase"), scope:this, text:"<span></span>", linkedLayer:this.showcase, handler:function(obj, e) {
        e.stopPropagation();
        this.switchMenu(2)
      }});
      this.btnShowcase.render(this.el);
      this.switchMenu(0)
    }
    EmojiDS.updateRecent();
    StickerDS.updateRecent();
    PicturesMenu.superclass._onShow.call(this)
  }, setControlElement:function(el) {
    this.controlEl = el && el.length == null && [el] || el
  }, _onClick:function(e) {
    var target = e.getTarget(true);
    for(var i = 0, len = this.controlEl.length;i < len;i++) {
      if(this.controlEl[i].contains(target)) {
        return false
      }
    }
    PicturesMenu.superclass._onClick.call(this, e)
  }, switchMenu:function(menuIndex, tabIndex, selectById) {
    this.show();
    this.emojiMenu.hide();
    this.stickerMenu.hide();
    this.showcase.hide();
    this.btnStickers.setState(false);
    this.el.toggleClass("nwa-dialog__pictures_full", false);
    if(menuIndex == 0) {
      this.emojiMenu.show();
      if(tabIndex != null) {
        this.emojiMenu.selectTab(tabIndex || 0, !!selectById)
      }
    }else {
      if(menuIndex == 1) {
        this.stickerMenu.show();
        if(this.stickerMenu.tabsCount == 0) {
          this.stickerMenu.hide();
          this.el.toggleClass("nwa-dialog__pictures_full", true);
          this.showcase.show();
          this.showcase.switchFreePromo();
          this.btnShowcase.setState(false);
          this.btnStickers.setState(true)
        }else {
          if(tabIndex != null) {
            this.stickerMenu.selectTab(tabIndex || 0, !!selectById)
          }
        }
      }else {
        if(menuIndex == 2) {
          this.el.toggleClass("nwa-dialog__pictures_full", true);
          this.showcase.show();
          if(tabIndex) {
            this.showcase.switchPackPreview(tabIndex, true)
          }else {
            this.showcase.switchShowcase()
          }
        }
      }
    }
  }, destroy:function() {
    this.itemClickEvent.removeAll();
    this.itemClickEvent = null;
    if(this.emojiMenu) {
      this.emojiMenu.destroy();
      this.stickerMenu.destroy()
    }
    PicturesMenu.superclass.destroy.call(this)
  }});
  var DataSource = WA.extend(Object, {_setIds:[], _setData:{}, _setContent:{}, _recentItems:[], _initialized:false, _storageName:"", RECENT_LIMIT:25, constructor:function() {
    this.dataChangeEvent = new U.Event
  }, destroy:function() {
    this.dataChangeEvent.removeAll()
  }, init:function() {
    if(this._initialized) {
      return
    }
    this._initialized = true;
    this.dataChangeEvent.fire()
  }, getSetCount:function() {
    return this._setIds.length
  }, getSetId:function(setIndex) {
    return this._setIds[setIndex]
  }, getSetData:function(setIndex) {
    var setId = this._setIds[setIndex];
    return this._setData[setId]
  }, getSetIndexById:function(setId) {
    for(var i = 0, len = this._setIds.length;i < len;i++) {
      if(this._setIds[i] == setId) {
        return i
      }
    }
    return-1
  }, _onSyncTriggerEvent:function(syncRecord) {
    if(syncRecord.isChanged(this._storageName)) {
      this._getRecent()
    }
  }, updateRecent:function() {
    var recentCount = this._recentItems.length;
    this._getRecent(function() {
      if(recentCount != this._recentItems.length) {
        if(recentCount == 0) {
          this._addRecentTab()
        }
        this.dataChangeEvent.fire()
      }
    }.bind(this))
  }, _addRecentTab:function() {
    if(this._setIds[0] && this._setIds[0] != "_recent") {
      this._setIds.unshift("_recent")
    }
  }, _getRecent:function(cb) {
    var ret = [];
    WA.AccountStorage.load(this._storageName, {success:function(res) {
      if(res) {
        ret = res.split(",")
      }
      this._recentItems = ret;
      cb && cb(ret)
    }, scope:this});
    return ret
  }, _saveRecent:function() {
    var obj = {};
    if(this._recentItems.length > this.RECENT_LIMIT) {
      this._recentItems.length = this.RECENT_LIMIT
    }
    obj[this._storageName] = this._recentItems.join(",");
    WA.AccountStorage.save(obj)
  }, _addRecentItem:function(code) {
    var ind = this._recentItems.indexOf(code);
    if(ind > -1) {
      this._recentItems.splice(ind, 1)
    }
    this._recentItems.unshift(code);
    this._saveRecent()
  }, _saveRecentOld:function(code) {
    var obj = {}, key = "recent" + this._storageName, ind = this._recentItems.indexOf(code);
    if(ind > -1) {
      this._recentItems.splice(ind, 1)
    }
    this._recentItems.unshift(code);
    if(this._recentItems.length > this.RECENT_LIMIT) {
      this._recentItems.length = this.RECENT_LIMIT
    }
    obj[key] = this._recentItems.join(",");
    WA.AccountStorage.save(obj)
  }, itemClicked:function(code) {
    var refreshTabs = !this._recentItems.length;
    this._addRecentItem(code);
    if(refreshTabs) {
      this._addRecentTab();
      this.dataChangeEvent.fire()
    }
  }, formatSetItems:function(setIndex) {
    var setId = this._setIds[setIndex];
    var data = [];
    var len = (setId == "_recent" ? this._recentItems.length : this._setContent[setId] && this._setContent[setId].length) || 0;
    for(var k = 0;k < len;k++) {
      data.push(this._formatMenuItem(setId, k))
    }
    return data
  }, checkTabUpdated:function() {
    return false
  }, _formatMenuItem:function(setId, itemIndex) {
    return{}
  }});
  var EmojiDataSource = WA.extend(DataSource, {_storageName:"recentemoji", constructor:function() {
    EmojiDataSource.superclass.constructor.apply(this, arguments)
  }, init:function() {
    if(this._initialized) {
      return
    }
    this._setIds = U.Array.clone(WA.data.EmojiSets);
    this._setContent = WA.data.EmojiData;
    this.updateRecent();
    EmojiDataSource.superclass.init.apply(this, arguments)
  }, _formatMenuItem:function(setId, itemIndex) {
    var itemId;
    if(setId == "_recent") {
      itemId = this._recentItems[itemIndex]
    }else {
      itemId = this._setContent[setId][itemIndex]
    }
    return{code:itemIndex, emoji_id:itemId, item_code:itemId, cls:"nwa-emoji_inline nwa-emo-" + itemId}
  }});
  var StickerDataSource = WA.extend(DataSource, {_storageName:"recentsticker", constructor:function() {
    StickerDataSource.superclass.constructor.apply(this, arguments)
  }, init:function() {
    if(this._initialized) {
      return
    }
    this._updatedTabs = [];
    this.updateRecent();
    WA.Sticker.packDataReadyEvent.on(this._onContentReady, this);
    WA.Sticker.packChangedEvent.on(this._onPackChangeEvent, this);
    WA.Sticker.requestContent();
    this._initialized = true
  }, _onPackChangeEvent:function(packId) {
    if(this._updatedTabs.indexOf(packId) == -1) {
      this._updatedTabs.push(packId)
    }
    WA.Sticker.requestContent()
  }, _onContentReady:function() {
    this._setIds = [];
    this._setData = {};
    this._setContent = {};
    var setList = WA.Sticker.getAltPackList();
    U.Array.each(setList, function(set) {
      if(set.is_enabled && set.purchased) {
        this._setIds.push(set.id);
        this._setData[set.id] = {icon:WA.Sticker.getStickerPickerIconUrl(set.id, 19)}
      }
    }, this);
    if(this._recentItems.length) {
      this._addRecentTab()
    }
    this._setContent = WA.Sticker.getAllPackContent();
    if(this._recentItems.length && this._setContent) {
      var toBeRemoved = [];
      U.Array.each(this._recentItems, function(code, ind) {
        var packId = code.split("#")[0];
        if(this._setContent[packId]) {
          if(WA.Sticker.isCustomPack(packId) !== false) {
            var stickerId = code.split("#")[1], stickerFound = false;
            U.Array.each(this._setContent[packId], function(obj) {
              if(stickerId == obj.id) {
                stickerFound = true;
                return false
              }
            });
            if(!stickerFound) {
              toBeRemoved.push(ind)
            }
          }
        }else {
          toBeRemoved.push(ind)
        }
      }, this);
      if(toBeRemoved.length) {
        U.Array.eachReverse(toBeRemoved, function(ind) {
          this._recentItems.splice(ind, 1)
        }, this);
        this._saveRecent()
      }
    }
    this.dataChangeEvent.fire();
    StickerDataSource.superclass.init.apply(this, arguments)
  }, checkTabUpdated:function(packId) {
    var res = this._updatedTabs.indexOf(packId);
    if(res > -1) {
      this._updatedTabs = this._updatedTabs.splice(res, 1)
    }
    return res > -1
  }, itemClicked:function(code) {
    if(code.split("#")[0] == "showcase") {
      return true
    }
    StickerDataSource.superclass.itemClicked.apply(this, arguments)
  }, _formatMenuItem:function(setId, itemIndex) {
    var itemId;
    if(setId == "_recent") {
      itemId = this._recentItems[itemIndex].split("#");
      setId = itemId[0];
      itemId = itemId[1]
    }else {
      itemId = this._setContent[setId][itemIndex].id
    }
    return{code:itemId, sticker_pack:setId, item_code:setId + "#" + itemId, title:"", alt:"", path:WA.Sticker.getStickerPreviewUrl(setId, itemId, 48), cls:"nwa-stset" + setId + "_obj" + itemId}
  }});
  var EmojiDS = new EmojiDataSource;
  var StickerDS = new StickerDataSource;
  WA.DialogsAgentView.SmileBox = PicturesMenu
})();
(function() {
  var WA = WebAgent;
  var U = WA.util;
  var UI = WA.ui;
  var SHOWCASE_ITEM_HTML = '<div class="nwa-showcase__item {cls_installed}" data-id="{id}">                                <img class="nwa-showcase__item__icon" src="{icon}"/>                                <div class="nwa-showcase__item__info">                                    <div class="nwa-showcase__item__name">{name}<div class="nwa-showcase__item__name-fader"></div></div>                                    <div class="nwa-showcase__item__ready">' + WA.tr("sticker.installed") + '</div>                                </div>                                <div class="nwa-showcase__item__readyok"><span></span></div>                                <div class="nwa-showcase__item__install">' + 
  WA.tr("sticker.add") + "</div>                            </div>";
  var PREVIEW_PACK_HTML = '<div class="nwa-showcase__preview {cls_installed}" data-id="{id}">                                <img class="nwa-showcase__preview__icon" src="{icon}"/>                                <div class="nwa-showcase__preview__info">                                    <div class="nwa-showcase__preview__name">{name}<div class="nwa-showcase__preview__name-fader"></div></div>                                    <div class="nwa-showcase__preview__ready">' + WA.tr("sticker.installed") + 
  '</div>                                    <div class="nwa-showcase__preview__install nwa-action_install" data-id="{id}" data-storeid="{store_id}">' + WA.tr("sticker.add") + '</div>                                    <div class="nwa-showcase__preview__description">{descr}<div class="nwa-showcase__preview__name-fader"></div></div>                                </div>                                <div class="nwa-showcase__preview__content">{content}</div>                            </div>';
  var PACK_ITEM_HTML = '<img class="nwa-showcase__preview__content-item" src="{icon}" />';
  var Showcase = WA.DialogsAgent.Showcase = WA.extend(UI.Component, {constructor:function() {
    Showcase.superclass.constructor.apply(this, arguments);
    this.previewMode = false;
    this.closeEvent = new U.Event;
    this.packInstalledEvent = new U.Event
  }, _onRender:function(el) {
    this.el = el.createChild({style:"display: none;", cls:"nwa-showcase", children:[{cls:"nwa-showcase__title", children:[{tag:"span"}, {cls:"nwa-showcase__close"}]}, {cls:"nwa-showcase__body"}]});
    this._contEl = this.el.last();
    this._titleEl = this.el.first();
    this._titleEl.last().on("click", function() {
      if(this.previewMode) {
        this.switchShowcase();
        if(this.singlePackMode) {
          this.closeEvent.fire()
        }
      }else {
        this.closeEvent.fire()
      }
    }, this);
    this._contEl.on("click", this._onClickEvent, this);
    this.scrollBar = new WA.ui.ScrollBar({source:this._contEl});
    this.scrollBar.render(this.el)
  }, _onClickEvent:function(el) {
    var id, trg = el.getTarget(true), item = trg.up("nwa-showcase__item");
    if(trg.hasClass("nwa-action_install")) {
      this.installPack(trg.getAttribute("data-id"), trg.getAttribute("data-storeid"))
    }else {
      if(item) {
        id = item.getAttribute("data-id");
        this.switchPackPreview(id)
      }
    }
  }, switchFreePromo:function() {
    this.previewMode = false;
    this.setTitle(WA.tr("sticker.showcase"));
    this.update('<div class="nwa-showcase__body_promo"></div>');
    this.scrollBar.sync()
  }, switchShowcase:function(forceRequest) {
    this.update("");
    WA.Sticker.requestShowcase(WA.bind(this._showPackList, this), forceRequest)
  }, _showPackList:function() {
    var html = [], packList = WA.Sticker.getShowcaseList();
    this.previewMode = false;
    U.Array.each(packList, function(pack) {
      html.push(U.String.parseTemplate(SHOWCASE_ITEM_HTML, {id:pack.id, icon:WA.Sticker.getPackIconUrl(pack.id, 64), name:U.String.htmlEntity(pack.name), descr:U.String.htmlEntity(pack.description), cls_installed:pack.purchased ? "nwa-showcase__item_installed" : ""}))
    });
    this.setTitle(WA.tr("sticker.showcase"));
    this.update(html.join(""));
    this.scrollBar.sync()
  }, switchPackPreview:function(packId, singlePackMode) {
    this.previewMode = true;
    var packName = WA.Sticker.getPackName(packId);
    if(packName) {
      this.setTitle(packName)
    }
    this.update("");
    this.scrollBar.sync();
    WA.Sticker.requestShowcase(function() {
      WA.Sticker.requestPackInfo(packId, function(res) {
        if(res !== false) {
          this.renderPackPreview(packId, singlePackMode)
        }else {
          this.previewMode = false
        }
      }.bind(this), false)
    }.bind(this))
  }, renderPackPreview:function(packId, singlePackMode) {
    var pack = WA.Sticker.getShowcasePreview(packId);
    if(!pack) {
      return
    }
    this.previewMode = true;
    this.singlePackMode = !!singlePackMode;
    var html = U.String.parseTemplate(PREVIEW_PACK_HTML, {id:packId, store_id:pack.store_id, icon:WA.Sticker.getPackIconUrl(packId, 120), name:U.String.htmlEntity(pack.name), descr:U.String.htmlEntity(pack.description), content:this.createContentPreview(packId), cls_installed:pack.purchased ? "nwa-showcase__preview_installed" : ""});
    this.setTitle(pack.name);
    this.update(html);
    this.scrollBar.sync()
  }, createContentPreview:function(packId) {
    var items = WA.Sticker.getAllPackContent()[packId], html = "";
    U.Array.each(items, function(item) {
      var iconUrl = WA.Sticker.getStickerPreviewUrl(packId, item.id, 48);
      html += U.String.parseTemplate(PACK_ITEM_HTML, {icon:iconUrl})
    }, this);
    return html
  }, setTitle:function(txt) {
    this._titleEl.first().update(U.String.htmlEntity(txt))
  }, update:function(html) {
    this._contEl.update(html);
    this._contEl.dom.scrollTop = 0
  }, installPack:function(packId, storeId) {
    WA.Sticker.requestInstallPack(packId, storeId, WA.bind(function(data) {
      if(data.status == 200) {
        this.packInstalledEvent.fire(packId)
      }
    }, this))
  }, destroy:function() {
    if(this.scrollBar) {
      this.scrollBar.destroy()
    }
  }})
})();
(function() {
  var WA = WebAgent;
  var U = WA.util;
  var Dlg = WA.DialogsAgent.RemoveContactDialog = WA.extend(WA.ui.Window, {closeAction:"hide", constructor:function(config) {
    config = config || {};
    Dlg.superclass.constructor.call(this, {cls:"nwa-dlg-remove", fadeIn:true, modal:true, title:"", autoRender:config.autoRender || false, bbar:["->", {cls:"nwa-button_blue", text:config.okButton || "OK", handler:function() {
      this._fireOkEvent()
    }, scope:this}, {cls:"nwa-button_blue", text:WA.tr("box.cancel"), handler:function() {
      this.close()
    }, scope:this}]});
    this.okEvent = new WA.util.Event;
    this.cancelEvent = new WA.util.Event
  }, _onRender:function(ct) {
    Dlg.superclass._onRender.call(this, ct);
    this.body.createChild({tag:"span"})
  }, _onHide:function() {
    Dlg.superclass._onHide.call(this);
    if(this._ok !== true) {
      this.cancelEvent.fire()
    }
  }, show:function(msg) {
    this._ok = false;
    Dlg.superclass.show.call(this);
    this.body.first().update(msg)
  }, _fireOkEvent:function() {
    this._ok = true;
    this.okEvent.fire();
    this.close()
  }})
})();
(function() {
  var WA = WebAgent;
  var U = WA.util;
  var Dlg = WA.DialogsAgent.AuthContactDialog = WA.extend(WA.ui.Window, {closeAction:"_handleClose", buttonsConfig:[{cls:"nwa-button_blue nwa-dlg-auth__add-contact", action:"add", text:'<span class="nwa-dlg-auth__add-contact-label">' + WA.tr("box.grantAuth") + "</span>"}, {cls:"nwa-button_blue", action:"cancel", text:WA.tr("box.cancel")}, {cls:"nwa-button_link", action:"ignore", text:WA.tr("box.ignore")}, {cls:"nwa-button_link", action:"spam", text:WA.tr("box.spam")}], constructor:function(config) {
    config = config || {};
    var items = [];
    U.Array.each(this.buttonsConfig, function(button) {
      items.push(new WA.ui.Button({cls:button.cls, handler:function() {
        this._fireOkEvent(button.action)
      }, scope:this, text:button.text}))
    }, this);
    Dlg.superclass.constructor.call(this, {cls:"nwa-dlg-auth", fadeIn:true, title:"", autoRender:config.autoRender || false, modal:true, items:items});
    this.okEvent = new WA.util.Event
  }, _onRender:function(ct) {
    Dlg.superclass._onRender.call(this, ct);
    this.body.createChild([{tag:"div", cls:"nwa-dlg-auth__title"}, {tag:"div", cls:"nwa-dlg-auth__avatar"}])
  }, _onShow:function() {
    Dlg.superclass._onShow.call(this);
    this.body.first().update('<span class="nwa-special-nick">' + U.String.htmlEntity(this._meta.nick) + "</span> " + WA.tr("box.askedAuth"));
    var previewEl = this.body.first().next();
    previewEl.setStyle("background-image", "url(" + WA.makeAvatar(this._meta.mail, this._meta.nick, "_avatar32", previewEl) + ")")
  }, _fireOkEvent:function(action) {
    this.okEvent.fire(action);
    this.hide()
  }, _handleClose:function() {
    this._fireOkEvent("cancel")
  }, setMeta:function(meta) {
    this._meta = meta
  }})
})();
(function() {
  var WA = WebAgent;
  var U = WA.util;
  var ConnectionRoster = WA.conn.ConnectionRoster;
  var SOCK = WA.conn.ConnectionFacade;
  var zodiac = [["ololo", WA.tr("zodiac.ololo")], ["capricorn", WA.tr("zodiac.capricorn")], ["aquarius", WA.tr("zodiac.aquarius")], ["pisces", WA.tr("zodiac.pisces")], ["aries", WA.tr("zodiac.aries")], ["taurus", WA.tr("zodiac.taurus")], ["gemini", WA.tr("zodiac.gemini")], ["cancer", WA.tr("zodiac.cancer")], ["leo", WA.tr("zodiac.leo")], ["virgo", WA.tr("zodiac.virgo")], ["libra", WA.tr("zodiac.libra")], ["scorpio", WA.tr("zodiac.scorpio")], ["sagittarius", WA.tr("zodiac.sagittarius")]];
  var zodiacMidl = [0, 20, 18, 20, 20, 20, 21, 22, 23, 23, 23, 22, 21];
  function getZodiakInd(d, m) {
    var ind = m || 12;
    if(d > zodiacMidl[ind]) {
      ind = (ind + 1) % 12 || 12
    }
    return ind
  }
  for(var months = [], i = 0;i <= 12;) {
    months.push(WA.tr(i++, {scope:"month_gen"}))
  }
  var Abstraction = WA.extend(ConnectionRoster, {constructor:function() {
    Abstraction.superclass.constructor.apply(this);
    this.updateEvent = new U.Event
  }, get:function(mail) {
    if(this._mail != mail) {
      this._mail = mail;
      WA.IcqApi.getProfile({email:this._mail, uniq:this._uniq = WA.uniq()}, function(success) {
        if(!success) {
          this.updateEvent.fire({error:1})
        }
      }.bind(this))
    }
  }, _onConnectionWp:function(value) {
    if(value.uniq && value.uniq == this._uniq) {
      if(value.result) {
        var index = U.Array.indexOfBy(value.result, function(v) {
          if(v.email == this._mail) {
            return true
          }
        }, this);
        if(index != -1) {
          this.updateEvent.fire(value.result[index])
        }
      }else {
        if(value.error) {
        }
      }
    }
  }});
  WA.Profile = WA.extend(WA.ui.Component, {constructor:function(isAddEnabled, config) {
    WA.Profile.superclass.constructor.call(this, config);
    this.initialConfig.hideOnEscape = true;
    this._isAddEnabled = isAddEnabled;
    this._abstraction = new Abstraction;
    this._abstraction.updateEvent.on(this._onUpdate, this);
    this.addEvent = new U.Event
  }, show:function(mail, data, isSuggest) {
    WA.log(arguments);
    this._isSuggest = isSuggest;
    if(this._mail != mail) {
      this._mail = mail;
      this._reset();
      this._data = data
    }
    WA.Profile.superclass.show.apply(this)
  }, _onShow:function() {
    WA.Profile.superclass._onShow.apply(this, arguments);
    if(!this._done) {
      if(!this._data) {
        this._abstraction.get(this._mail)
      }else {
        this._onUpdate(this._data)
      }
      if(!this._userPicLoaded) {
        this._userPicLoaded = true;
        this._updateImage()
      }
    }
  }, _onRender:function(el) {
    this.el = el.createChild({cls:"nwa-wp", children:[{}, {cls:"nwa-wp__plate", children:[{cls:"nwa-wp__white", children:[{cls:"nwa-wp__userpic"}, {cls:"nwa-wp__info"}, {cls:"nwa-wp__line"}, {cls:"nwa-wp__more"}]}, {tag:"button", cls:"nwa-button nwa-button_blue nwa-wp__add-button", children:[{tag:"span", cls:"nwa-toolbar__add-contact-label", children:WA.tr("profile.addContact")}]}, {tag:"button", cls:"nwa-button nwa-button_blue nwa-wp__cancel-button", html:WA.tr("profile.close")}]}]});
    this.el.first().on("click", this._onCloseButton, this);
    el = this.el.first().next().first();
    this._userpicEl = el.first();
    this._infoEl = this._userpicEl.next();
    this._moreEl = this._infoEl.next().next();
    this._addButtonEl = el.next().on("click", this._onAddButton, this);
    if(this._isAddEnabled) {
      this._addButtonEl.show()
    }
    el.next().next().on("click", this._onCloseButton, this);
    this._nameBox = new WA.ui.NameBox;
    this._nameBox.render(el);
    this._reset()
  }, _reset:function() {
    this._clearImage();
    var loading = "<span>" + WA.tr("dialog.loading") + "</span>";
    this._nameBox.setName("");
    this._infoEl.update(loading);
    this._moreEl.update(loading);
    this._userPicLoaded = false;
    this._done = false
  }, _onAddButton:function() {
    if(this.done) {
      this.addEvent.fire(this._mail, this._name, this._isSuggest)
    }
  }, _onCloseButton:function() {
    this.hide()
  }, _clearImage:function() {
    this._userpicEl.setStyle({"background-image":"none"})
  }, _updateImage:function() {
    this._userpicEl.setStyle({"background-image":"url(" + WA.makeAvatar(this._mail, this._name, "_avatar", this._userpicEl) + ")"})
  }, _onUpdate:function(data) {
    var name = [];
    data.firstname && name.push(data.firstname);
    data.lastname && name.push(data.lastname);
    name = name.length && name.join(" ") || data.nickname || this._mail;
    this._name = name;
    var isUIN = this._mail.indexOf("@uin.icq") != -1;
    if(data.birthday) {
      var now = new Date;
      var shortYear = now.getFullYear() - 2E3;
      var date = data.birthday.split("-");
      if(date[0].length == 2 && date[0] > shortYear) {
        date[0] = "19" + date[0]
      }else {
        if(date[0].length == 2 && date[0] <= shortYear) {
          date[0] = "20" + date[0]
        }
      }
      var birthday = new Date(date[0], date[1] - 1, date[2]);
      var age = now.getFullYear() - birthday.getFullYear();
      var bday = new Date("" + now.getFullYear() + data.birthday.replace(/^\d+/, ""));
      if(bday > now) {
        age--
      }
      var bdayStr = date[2] + " " + months[+date[1]] + " " + date[0];
      data.zodiac = getZodiakInd(+date[2], +date[1])
    }
    var status = data.status && data.status.type || "online";
    var statusTitle = data.status && data.status.title || WA.MainAgent.statuses[status] || status;
    if(isUIN) {
      status = "icq_" + status
    }
    var sa = "";
    if(data.sex || age) {
      sa = U.String.format("<br><span>{0}{2}{1}</span><br>", ["", WA.tr("sex.m"), WA.tr("sex.f")][data.sex || 0], age ? WA.tr("time.years", {count:age}) : "", data.sex && age ? " - " : "")
    }
    var format = '{0}<div class="nwa-wp__status {1}">{2}</div>';
    this._nameBox.setName(name);
    this._infoEl.update(U.String.format(format, sa, WA.Statuses.buildCssClass(status, isUIN), U.String.htmlEntity(statusTitle)));
    var more = [], horoUrl;
    if(data.birthday) {
      horoUrl = "http://horo.mail.ru/prediction/" + zodiac[data.zodiac][0] + "/today/";
      more.push(U.String.format("<span>" + WA.tr("profile.birthdate") + ":</span><br>{0}{1}", bdayStr || "", data.zodiac ? ' / <a class="nwa-wp__zodiac nwa-wp__zodiac_' + data.zodiac + '" href="' + horoUrl + '" target="_blank">' + zodiac[data.zodiac][1] + "</a>" : ""))
    }
    var title = WA.tr("profile.email") + ":";
    var mail = this._mail;
    if(isUIN) {
      title = "UIN:";
      mail = mail.replace("@uin.icq", "")
    }
    format = "<span>{1}</span><br/>" + (isUIN ? "{0}" : '<a href="mailto:{0}">{0}</a>');
    more.push(U.String.format(format, mail, title));
    var country = data.country_id && WA.getCountryById(data.country_id) || data.country_id;
    data.location = (country ? [country] : []).concat(data.city || []).join(", ");
    if(data.location) {
      more.push(U.String.format("<span>" + WA.tr("profile.home") + ':</span><br><div class="nwa-wp__location" title="{0}">{0}<div class="nwa-wp__location-fader"></div></div>', U.String.htmlEntity(data.location)))
    }
    this._moreEl.update(more.join("<br><br>"));
    this.done = true
  }})
})();
(function() {
  var WA = WebAgent;
  WA.PhotoPreview = WA.extend(WA.ui.Component, {initComponent:function() {
    WA.PhotoPreview.superclass.initComponent.apply(this);
    this.initialConfig.hideOnEscape = true;
    this.mail = this.initialConfig.mail || null;
    this.nick = this.initialConfig.nick || null
  }, _onRender:function(ct) {
    this.el = ct.createChild({tag:"div", cls:"nwa-ppreview" + (this.initialConfig.fadeIn && !WA.isIE ? " nwa_fadein" : ""), children:[{tag:"div", cls:"nwa-ppreview__img ", children:{tag:"div", cls:"nwa-ppreview__close"}}]});
    this.el.on("click", this.hide, this);
    if(this.mail) {
      this._renderPhoto()
    }
  }, show:function(mail, nick) {
    WA.PhotoPreview.superclass.show.apply(this);
    if(mail && this.mail != mail || nick && this.nick != nick) {
      this.mail = mail || this.mail;
      this.nick = nick || this.nick;
      this._renderPhoto()
    }
  }, _onHide:function(me) {
    WA.PhotoPreview.superclass._onHide.apply(this)
  }, _renderPhoto:function() {
    var previewUrl = WA.makeAvatar(this.mail, this.nick, "_avatar180", this.el.last());
    this.el.last().setStyle("background-image", "url(" + previewUrl + ")")
  }})
})();
(function() {
  var WA = WebAgent;
  var U = WA.util;
  var Dlg = WA.DialogsAgent.AlertDialog = WA.extend(WA.ui.Window, {closeAction:"hide", constructor:function(config) {
    config = config || {};
    Dlg.superclass.constructor.call(this, {cls:"nwa-dlg-remove", fadeIn:true, title:"", autoRender:config.autoRender || false, modal:true, bbar:["->", {cls:"nwa-button_blue", text:WA.tr("box.ok"), handler:this.close, scope:this}]})
  }, _onRender:function(ct) {
    Dlg.superclass._onRender.call(this, ct);
    this.body.createChild({tag:"span"})
  }, show:function(msg) {
    Dlg.superclass.show.call(this);
    this.body.first().update(msg || WA.tr("msgTooLong"));
    try {
      this.closeBtn.el.dom.focus()
    }catch(e) {
    }
  }})
})();
(function() {
  var WA = WebAgent;
  var U = WA.util;
  var LOAD_FAIL_TIMEOUT = 4E3;
  var POLLING_PERIOD = 200;
  var swfLoaded = [], loadCheckTimeout = 0, checkingCount, ieCloseTimer = 0;
  function isLoaded(swfUrl) {
    return U.Array.indexOf(swfLoaded, swfUrl) > -1
  }
  function checkSwfLoading(e, callback) {
    var fn = function() {
      checkingCount++;
      if(typeof e.ref.PercentLoaded !== "undefined" && e.ref.PercentLoaded()) {
        if(e.ref.PercentLoaded() === 100) {
          callback(true)
        }else {
          if(checkingCount > LOAD_FAIL_TIMEOUT / POLLING_PERIOD) {
            callback(false)
          }else {
            loadCheckTimeout = WA.setTimeout(fn, POLLING_PERIOD)
          }
        }
      }else {
        loadCheckTimeout = WA.setTimeout(fn, POLLING_PERIOD)
      }
    };
    loadCheckTimeout = WA.setTimeout(fn, POLLING_PERIOD)
  }
  function resetSwfLoading() {
    clearTimeout(loadCheckTimeout);
    clearTimeout(ieCloseTimer)
  }
  WA.SwfPreview = WA.extend(WA.ui.Component, {initComponent:function() {
    WA.SwfPreview.superclass.initComponent.apply(this);
    this.initialConfig.hideOnEscape = true;
    this.readyToLoad = false;
    this.failLoadEvent = new U.Event
  }, _onRender:function(ct) {
    this.swfId = "swfbrdg_" + Math.random().toString().substr(2);
    this.el = ct.createChild({tag:"div", cls:"nwa-ppreview" + (this.initialConfig.fadeIn && !WA.isIE ? " nwa_fadein" : "")});
    this.el.on("mousedown", function(e) {
      this.hide()
    }, this);
    window[this.swfId + "_DoFSCommand"] = WA.createDelegate(this.closeSwf, this)
  }, preview:function(swfUrl, duration) {
    if(!WA.hasFlash) {
      return
    }
    if(!this.rendered) {
      this.render(this.autoRender)
    }
    if(this.readyToLoad) {
      resetSwfLoading()
    }
    this.readyToLoad = true;
    this.swfDuration = duration || 0;
    this.swfUrl = swfUrl;
    this._renderPhoto();
    this.show()
  }, show:function() {
    WA.SwfPreview.superclass.show.apply(this)
  }, _onHide:function(me) {
    resetSwfLoading();
    WA.SwfPreview.superclass._onHide.apply(this);
    WA.util.swf.removeSWF(this.swfId)
  }, _renderPhoto:function() {
    WA.util.swf.removeSWF(this.swfId);
    this.el.createChild({id:this.swfId, tag:"div"});
    WA.util.swf.embedSWF(this.swfUrl, this.swfId, "298", "298", "7", false, false, {name:this.swfId, allowScriptAccess:"always", wmode:"transparent", loop:"false"}, {"class":"nwa-mult-preview nwa_self"}, WA.createDelegate(this._onSwfCreate, this))
  }, _onSwfCreate:function(e) {
    var fn = WA.createDelegate(function(success) {
      if(success) {
        if(!isLoaded(this.swfUrl)) {
          swfLoaded.push(this.swfUrl)
        }
        this._onSwfLoad()
      }else {
        this._onSwfLoad(false)
      }
    }, this);
    if(e.success) {
      if(isLoaded(this.swfUrl)) {
        fn(true)
      }else {
        checkSwfLoading(e, fn)
      }
    }else {
      fn(false)
    }
  }, _onSwfLoad:function(status) {
    this.readyToLoad = false;
    if(status === false) {
      this.hide();
      this.failLoadEvent.fire()
    }else {
      this.show();
      if(WA.isIE && this.swfDuration > 0) {
        ieCloseTimer = WA.setTimeout(this.hide, this.swfDuration, this)
      }
    }
  }, closeSwf:function(com, args) {
    if(com == "magent" && args == "end") {
      this.hide()
    }
  }, destroy:function() {
    resetSwfLoading();
    WA.SwfPreview.superclass.destroy.call(this);
    window[this.swfId + "_DoFSCommand"] = null
  }})
})();
(function() {
  var WA = WebAgent;
  var U = WA.util;
  var JSON = WA.getJSON();
  function addUrlParametr(url, uniq) {
    url = url.replace(/wa_embedlogin=\d+(\&?)/g, "");
    var sep = url.indexOf("?") != -1 ? "&" : "?";
    url += sep + "wa_embedlogin=" + uniq;
    url = url.replace(/\&\&\&*/, "&").replace(/\?\&/, "?");
    return url
  }
  function makeLoginToken() {
    var uniq = Math.round(Math.random() * 999999);
    try {
      var tokens = JSON.parse(localStorage.waLoginTokens || "{}");
      tokens[uniq] = 1;
      localStorage.waLoginTokens = JSON.stringify(tokens)
    }catch(e) {
    }
    return uniq
  }
  var haveLoginToken = false;
  function checkLoginToken() {
    if(haveLoginToken) {
      return true
    }else {
      var loc = "" + document.location;
      var t = loc.match(/wa_embedlogin=(\d+)/);
      if(t) {
        try {
          var uniq = t[1];
          var tokens = JSON.parse(localStorage.waLoginTokens || "{}");
          if(tokens[uniq]) {
            haveLoginToken = true;
            delete tokens[uniq];
            localStorage.waLoginTokens = JSON.stringify(tokens);
            return true
          }
        }catch(e) {
        }
      }
    }
    return false
  }
  var pageToken;
  var AuthForm = WA.AuthForm = WA.Activatable.extend(WA.ui.Component, {_onRender:function(ct) {
    pageToken = makeLoginToken();
    var back = ("" + document.location).match(/([^\/]+)\.mail\.ru\/(.*)$/);
    this.el = ct.createChild({tag:"div", cls:"nwa-agent nwa-authform", children:[{tag:"div", cls:"nwa-agent__shadow", children:[{tag:"div", id:"nwaHeader", cls:"nwa-header", children:[{tag:"div", id:"nwaNick", cls:"nwa-header__nick", children:[{tag:"span", children:WA.tr("auth.authorization")}]}, {tag:"div", cls:"nwa-header__mini", id:"newAuthMinimize", title:WA.tr("auth.minimize")}]}, {tag:"div", id:"nwaClist", cls:"nwa-clist", children:{tag:"form", method:"POST", id:"nwaAuthForm", action:"https://auth.mail.ru/cgi-bin/auth", 
    children:[{tag:"input", type:"text", name:"Login", id:"nwaAuthLogin", cls:"nwa-auth-login", tabindex:"1", placeholder:WA.tr("auth.email")}, {tag:"input", type:"password", name:"Password", id:"nwaAuthPass", cls:"nwa-auth-pass", tabindex:"3", placeholder:WA.tr("auth.password")}, {tag:"input", type:"hidden", name:"Page", id:"nwaAuthPage"}, {tag:"input", type:"hidden", name:"FailPage", id:"nwaAuthFailPage"}, {tag:"input", type:"hidden", name:"level", checked:"checked", id:"nwaAuthLevel"}, {cls:"nwa-auth-checkcover nwa-auth-checkcover-checked", 
    id:"nwaAuthCheckCover"}, {cls:"nwa-auth-level", children:WA.tr("auth.rememberMe"), id:"nwaAuthCheckText"}, {tag:"a", cls:"nwa-auth-forget", href:"https://e.mail.ru/cgi-bin/passremind", children:WA.tr("auth.lostPassword")}, {cls:"nwa-auth-submit", tag:"button", type:"submit", tabindex:"4"}, {cls:"nwa-auth-title", children:WA.tr("auth.authorization")}, {tag:"select", name:"Domain", id:"nwaAuthDomain", cls:"nwa-auth-domain", tabindex:"2", children:[{tag:"option", value:"mail.ru", children:"@mail.ru", 
    selected:"selected"}, {tag:"option", value:"inbox.ru", children:"@inbox.ru"}, {tag:"option", value:"bk.ru", children:"@bk.ru"}, {tag:"option", value:"list.ru", children:"@list.ru"}]}]}}]}]})
  }, _onAfterRender:function() {
    WA.get("newAuthMinimize").on("click", this.hide, this);
    this.el.on("mousedown", function(ev) {
      ev.stopPropagation()
    }, this);
    if(!WA.isPopup) {
      WA.getBody().on("mousedown", this.hide, this)
    }
    this._checkTextEl = WA.get("nwaAuthCheckText").on("click", this._toggleLevelCheck, this);
    this._checkCoverEl = WA.get("nwaAuthCheckCover").on("click", this._toggleLevelCheck, this);
    this._levelEl = WA.get("nwaAuthLevel");
    this._pageEl = WA.get("nwaAuthPage");
    this._failPageEl = WA.get("nwaAuthFailPage");
    this._loginEl = WA.get("nwaAuthLogin");
    this._passEl = WA.get("nwaAuthPass");
    this._domainEl = WA.get("nwaAuthDomain");
    WA.get("nwaAuthForm").on("submit", function() {
      var backUrl = addUrlParametr("" + document.location, pageToken);
      this._pageEl.setAttribute("value", document.location.protocol + "//r.mail.ru/clb1203896/" + document.location.host + backUrl.replace(/https?:\/\/[^\/]+/, ""));
      this._failPageEl.setAttribute("value", "https://r.mail.ru/clb1203897/e.mail.ru/cgi-bin/login?email=" + U.String.htmlEntity(this._loginEl.dom.value + "@" + this._domainEl.dom.value) + "&fail=1&page=" + U.String.htmlEntity(encodeURIComponent(backUrl)))
    }, this);
    this.isPlaceholderSupported = "placeholder" in document.createElement("input");
    if(!this.isPlaceholderSupported) {
      this._placeholderFallback()
    }
  }, _placeholderFallback:function() {
    this._loginEl.on("focus", this._onInputFocus, this);
    this._loginEl.on("blur", this._onInputBlur, this);
    this._passEl.on("focus", this._onInputFocus, this);
    this._passEl.on("blur", this._onInputBlur, this);
    var loginPlaceholder = this._loginEl.getAttribute("placeholder"), passPlaceholder = this._passEl.getAttribute("placeholder");
    this._loginEl.setAttribute("value", loginPlaceholder);
    this._passEl.setAttribute("value", passPlaceholder)
  }, _onInputFocus:function(e) {
    var input = e.getTarget(), placeholder = input.getAttribute("placeholder");
    if(input.value === placeholder) {
      input.value = ""
    }
  }, _onInputBlur:function(e) {
    var input = e.getTarget(), placeholder = input.getAttribute("placeholder");
    if(U.String.trim(input.value) === "") {
      input.value = placeholder
    }
  }, _toggleLevelCheck:function() {
    this._checkCoverEl.toggleClass("nwa-auth-checkcover-checked");
    if(this._checkCoverEl.hasClass("nwa-auth-checkcover-checked")) {
      this._levelEl.setAttribute("checked", "checked")
    }else {
      this._levelEl.removeAttribute("checked")
    }
  }, _onShow:function() {
    U.Mnt.countRB(1203895)
  }});
  AuthForm.haveLoginToken = function() {
    return checkLoginToken(false)
  };
  AuthForm.removeLoginToken = function() {
    return checkLoginToken(true)
  }
})();
(function() {
  var WA = WebAgent;
  var U = WA.util;
  WA.buttons = {};
  var SB = WA.buttons.StatusButton = WA.extend(WA.ui.TabButton, {constructor:function(config) {
    config.clickEvent = "mousedown";
    this._status = null;
    this._newMsgFlag = false;
    SB.superclass.constructor.call(this, config)
  }, setStatus:function(status) {
    if(this._status != status) {
      this.el.first().first().dom.className = "nwa-button-tab__icon " + WA.Statuses.buildCssClass(status);
      this._status = status;
      this.setInfo("")
    }
    this.updateIcon()
  }, getStatus:function() {
    return this._status || null
  }, setInfo:function(text) {
    this.el.setAttribute("title", text)
  }, setNewMsgFlag:function(show) {
    this._newMsgFlag = show !== false;
    this.updateIcon()
  }, setPopupMode:function(mode, appMode) {
    if(mode) {
      this.setStatus("popup")
    }else {
      this.setStatus(this._status)
    }
    this.el.toggleClass("nwa-button-tab_popup", !!mode);
    this.el.toggleClass("nwa-button-tab_appmode", !!(mode && appMode))
  }, getPopupMode:function() {
    return this._status && this._status.indexOf("popup") == 0
  }, setCount:function(count) {
    if(count && this._count != count) {
      this._count = count
    }
  }, updateIcon:function() {
    var disableTab = this._status == "offline" || this._status == "gray" || this._status == "yellow";
    this.el.toggleClass("nwa-button-tab_disabled", disableTab);
    var showNewMsgIcon = this._newMsgFlag && !this.getPopupMode() && !disableTab;
    this.el.first().first().toggleClass("wa-cl-status-message-blink", showNewMsgIcon)
  }})
})();
(function() {
  var WA = WebAgent;
  var U = WA.util;
  var TMPLT = '<span class="btn_close">                    <span class="i-close"></span>                </span>                <div class="security_content i-shield">                    <p class="title">{0}</p>                    <form class="form">                        <div class="form_content">                            <label class="label">                                <span class="label_text">' + WA.tr("phoneBinding.yourPhone") + '</span>                                <input class="input" name="phone" type="phone" value="+7" />                            </label>                            <p class="input_error" style="display:none;"></p>                        </div>                        <p class="description">{1}</p>                        <input class="btn_submit" type="submit" value="{2}" />                    </form>                </div>';
  var TMPLT2 = '<span class="btn_close">                    <span class="i-close"></span>                </span>                <div class="security_content">                    <p class="title">' + WA.tr("phoneBinding.codeFromSMS") + '</p>                    <p class="label">                        <span class="label_text">' + WA.tr("phoneBinding.phone") + '</span>                    </p>                    <div class="phone_number">                        {3}                        <a class="link_action" href="javascript:void(1)">' + 
  WA.tr("phoneBinding.modify") + '</a>                    </div>                    <form class="form">                        <div class="form_content">                            <label class="label">                                <span class="label_text">' + WA.tr("phoneBinding.yourCode") + '</span>                                <input class="input" name="code" type="text" value="" />                            </label>                            <p class="input_error" style="display:none;"></p>                        </div>                        <p class="description">                            ' + 
  WA.tr("phoneBinding.SMSCodeSent") + ' <br />                            <a href="javascript:void(1)" class="action_send" id="action_send">' + WA.tr("phoneBinding.sendAgain") + ' 1:00</a>                        </p>                        <input name="trans_id" type="hidden" value="{4}" />                        <input class="btn_submit" type="submit" value="' + WA.tr("phoneBinding.ok") + '" />                    </form>                </div>';
  WA.PhoneBindingPopup = WA.extend(WA.ui.Component, {constructor:function() {
    this.finishEvent = new U.Event;
    this.value = false;
    this.domainUrl = "agent.mail.ru/waphone";
    this.url = "/waphone/phone.php";
    this._requestSent = false;
    this._templates = [TMPLT, TMPLT2];
    this._timer = null;
    this._currentCfg = null;
    this._step = -1;
    this.errorClass = "s-error";
    WA.PhoneBindingPopup.superclass.constructor.apply(this, arguments)
  }, _onRender:function(container) {
    this.el = container.createChild({cls:"security_wrap"});
    this.el.on("click", this._onClick, this);
    this._step = -1;
    this._renderStep(this.initialConfig)
  }, _clearHandlers:function() {
    if(this.form) {
      this.form.un("submit", this.nextStep, this)
    }
    if(this.input) {
      this.input.un("input", this._onInputChange, this)
    }
    if(this._timer) {
      clearInterval(this._timer);
      this._timer = null
    }
  }, _renderStep:function(cfg) {
    this._step++;
    var tmplt = this._templates[this._step];
    if(!tmplt) {
      return this.finish()
    }
    this._clearHandlers();
    this.value = false;
    this._currentCfg = cfg;
    this.el.update(U.String.format(tmplt, U.String.htmlEntity(cfg.title), U.String.htmlEntity(cfg.text), U.String.htmlEntity(cfg.btn_text) || WA.tr("phoneBinding.switchOn"), U.String.htmlEntity(cfg.phone), U.String.htmlEntity(cfg.trans_id)));
    this.closeButton = this.el.first();
    if(!this.initialConfig.close_btn) {
      this.closeButton.hide()
    }
    this.form = WA.get(this.el.dom.getElementsByTagName("form")[0]);
    this.input = WA.get(this.form.dom[0]);
    this.error = WA.get(this.form.dom.getElementsByTagName("p")[0]);
    this.input.on("input", this._onInputChange, this);
    this.form.on("submit", this.nextStep, this);
    var sendLink = WA.get("action_send");
    var timeElapsed = 60;
    if(sendLink) {
      var onTimer = WA.createDelegate(function() {
        if(--timeElapsed) {
          sendLink.update(WA.tr("phoneBinding.sendAgain") + " 0:" + timeElapsed.toString().replace(/^(\d)$/, "0$1"));
          this._timer = WA.setTimeout(onTimer, 1E3)
        }else {
          sendLink.addClass("s-ready").update(WA.tr("phoneBinding.sendAgain"))
        }
      }, this);
      this._timer = WA.setTimeout(onTimer, 1E3)
    }
  }, _onInputChange:function() {
    this.input.removeClass(this.errorClass);
    this.error.hide();
    if(this.input.dom.name === "phone") {
      this.input.dom.value = this.input.dom.value.replace(/[^0-9\+]+/g, "")
    }
  }, _onClick:function(e) {
    var trgt = e.getTarget(true);
    if(trgt.up("link_action")) {
      this._step = -1;
      var phone = this._currentCfg.phone;
      this._renderStep(this.initialConfig);
      this.input.dom.value = phone;
      e.stopEvent()
    }else {
      if(trgt.up("action_send")) {
        var sendLink = trgt.up("action_send");
        if(sendLink.hasClass("s-ready") && !this._requestSent) {
          this._step--;
          this.input.dom.value = "";
          this.nextStep(e, null, {phone:this._currentCfg.phone})
        }
        e.stopEvent()
      }else {
        if(trgt.up("btn_close")) {
          (new Image).src = "https://agent.mail.ru/waphone/close.php";
          this.finish()
        }
      }
    }
  }, _makeRequest:function(cb, forceParams) {
    if(this._requestSent) {
      return
    }
    var params = forceParams || {}, l = this.form.dom.length;
    if(!forceParams) {
      while(l--) {
        if(this.form.dom[l].name) {
          params[this.form.dom[l].name] = this.form.dom[l].value
        }
      }
    }
    var req = {method:"POST", url:this.url, data:params};
    this._requestSent = true;
    WA.XDRequest.getInstance(this.domainUrl).request(req, function(resp) {
      this._requestSent = false;
      cb && cb.call(this, true, resp)
    }, function(resp) {
      this._requestSent = false;
      cb && cb.call(this, false, resp)
    }, this)
  }, nextStep:function(e, el, forceData) {
    this._onInputChange();
    this._makeRequest(function(success, res) {
      var data, phone;
      try {
        data = JSON.parse(res.data)
      }catch(err) {
      }
      if(data && data.status < 300) {
        if(data.status == 200) {
          this.value = true;
          return this.finish()
        }else {
          phone = forceData && forceData.phone || this.input.dom.value;
          this._renderStep({phone:phone, trans_id:data.trans_id})
        }
      }else {
        if(forceData) {
          this._step = -1;
          this._renderStep(this.initialConfig);
          this.input.dom.value = forceData.phone
        }
        this.input.addClass(this.errorClass);
        if(data && data.error) {
          this.error.update(data.error).show()
        }
      }
    }, forceData);
    e.stopEvent();
    return false
  }, finish:function() {
    this.finishEvent.fire(this.value);
    return false
  }, destroy:function() {
    this.el.un("click", this._onClick, this);
    this._clearHandlers();
    this.finishEvent.removeAll();
    WA.PhoneBindingPopup.superclass.destroy.apply(this, arguments)
  }})
})();
(function() {
  var WA = WebAgent;
  var Storage = WA.Storage;
  var U = WA.util;
  var US = WA.conn.UserState;
  var SOCK = WA.ConnectionFacade;
  var FM = WA.FocusManager;
  var UI = WA.ui;
  var AuthForm = WA.AuthForm;
  var ACCOUNT_MAIL_RU = "https://account.mail.ru/login";
  var POPUP_URL = (WA.isLocalhost ? "/popup.html?" : "http://webagent.mail.ru/webim/agent/popup.html?") + (WA.useLang ? "wa_lang=" + WA.useLang : "") + (WA.usedBranch != "master" ? "&branch=" + WA.usedBranch : "");
  function redirectToMailLogin() {
    var now = WA.now();
    var lastAuthRedir = parseInt(localStorage["lastAuthRedir"]) || 0;
    if(now - lastAuthRedir > 10) {
      WA.log("~~~ redirectToAuthPage: OK", lastAuthRedir, now);
      doAuthRedirect()
    }else {
      WA.log("~~~ redirectToAuthPage: too many tries")
    }
  }
  function doAuthRedirect() {
    localStorage["lastAuthRedir"] = WA.now();
    WA.setTimeout(function() {
      window.location = ACCOUNT_MAIL_RU + "?page=" + encodeURIComponent("" + document.location)
    }, 100)
  }
  var StatusButton = WA.extend(WA.buttons.StatusButton, {constructor:function() {
    StatusButton.superclass.constructor.apply(this, arguments)
  }, _onRender:function() {
    StatusButton.superclass._onRender.apply(this, arguments)
  }, _onAfterRender:function() {
    StatusButton.superclass._onAfterRender.apply(this, arguments)
  }});
  var StatusMenu = WA.extend(UI.menu.Menu, {render:function(ct) {
    var container = WA.get(ct);
    var el = container.createChild({tag:"div", cls:"nwa-status-menu-root"});
    StatusMenu.superclass.render.call(this, el)
  }});
  var StatusMenuItem = WA.extend(UI.menu.Button, {constructor:function(config) {
    config.owner = this;
    config.iconCls = WA.Statuses.buildCssClass(config.status);
    config.text = U.String.htmlEntity(config.text);
    StatusMenuItem.superclass.constructor.call(this, config)
  }, _onAfterRender:function() {
    this.setText(this._text);
    return StatusMenuItem.superclass._onAfterRender.apply(this, arguments)
  }, setText:function(text) {
    this.button.setText(text)
  }, getText:function() {
    return U.String.entityDecode(this.button.getText())
  }, setStatus:function(status) {
    this.initialConfig.status = status;
    this.button.setIconCls(WA.Statuses.buildCssClass(status))
  }, getStatus:function() {
    return this.initialConfig.status
  }});
  var StatusEssence = WA.extend(UI.Component, {constructor:function() {
    StatusEssence.superclass.constructor.apply(this, arguments);
    this._popupDisabledChecker = new WA.util.DelayedTask({interval:1E3, fn:function() {
      Storage.load(["status.disabled"], {success:function(storage) {
        if(this._statusDisabled != storage["status.disabled"]) {
          (this._statusDisabled = storage["status.disabled"]) ? this.statusButton.hide() : this.statusButton.show()
        }
        this._popupDisabledChecker.start()
      }, scope:this})
    }, scope:this});
    if(US.isValidUser()) {
      this._active = undefined;
      this._checkDocumentReady(this._documentReady, this)
    }else {
      if(WA.allowAuth) {
        this._checkDocumentReady(function() {
          this.statusButton = new StatusButton({cls:"nwa-button-tab_agent nwa-button-tab_disabled", text:WA.tr("mainTitle"), handler:function(nope, event) {
            U.Mnt.log({reason:"breaklog", login:WA.ACTIVE_MAIL, text:"ffbreak:showauth1"});
            this._showAuthDialog();
            event.stopEvent()
          }, scope:this});
          this._makeElRoot();
          this.statusButton.render(this.boundEl);
          this.statusButton.setStatus("offline");
          this.statusButton.show()
        }, this)
      }else {
        if(WA.isPopup) {
          this._checkDocumentReady(function() {
            this._showAuthDialog(true)
          }, this)
        }
      }
    }
    US.permanentShutdownEvent.on(this._onPermanentShutdown, this);
    US.networkErrorEvent.on(this._errorMode, this)
  }, _checkDocumentReady:function(cb, scope) {
    if(document.body) {
      cb && cb.call(scope || window)
    }else {
      WA.setTimeout(WA.createDelegate(cb, scope), 10)
    }
  }, _documentReady:function() {
    this._onDocumentReady();
    Storage.init();
    Storage.whenReady(this._onStorageInit, this)
  }, _onStorageInit:function() {
    WA.debug.Console.log("_onStorageInit");
    this.syncStatus = WA.Synchronizer.registerComponent("status", ["status", "custom", "disabled"], false);
    this.syncStatus.read(function(data) {
      var status = data.get("status") || "";
      WA.debug.Console.log("STATUS: read, ", status);
      var s = status.split(":");
      this._statusModifDate = s[0];
      this._statusDisabled = data.get("disabled") || "0";
      WA.Synchronizer.startUp(1);
      WA.debug.Console.log("Synchronizer.startUp")
    }, this);
    this.syncStatus.triggerEvent.on(function(data) {
      if(data.isChanged("custom")) {
        this.__statusTitle = data.get("custom")
      }
      if(data.isChanged("disabled") && this._statusDisabled != data.get("disabled")) {
        this._statusDisabled = data.get("disabled");
        if(this._statusDisabled == "1") {
          WA.isPopup || this._onPermanentShutdown()
        }else {
          this.isPermanentShutdown && (this.isPermanentShutdown = false);
          if(!data.isChanged("status")) {
            this._activate(function() {
              this.syncStatus.read(function(data) {
                var s = data.get("status").split(":");
                var customTitle = data.get("custom");
                this._statusModifDate = s[0];
                this._onStatusChange(s[1], customTitle);
                this._listenFM()
              }, this)
            }, this, true)
          }
          this._initPromoSms()
        }
      }
      if(this._statusDisabled == "1" && !WA.isPopup) {
        this.statusButton.hide();
        this.notify && this.notify.clear();
        return
      }
      if(data.isChanged("status")) {
        var status = data.get("status");
        var s = status.split(":");
        var customTitle = this.__statusTitle;
        if(this._statusModifDate != s[0]) {
          this._statusModifDate = s[0];
          this._onSyncStatus(s[1], customTitle);
          WA.debug.Console.log("STATUS: sync, ", status)
        }else {
          WA.debug.Console.log("STATUS: sync again, ", status)
        }
        if(s[1] != "offline") {
          U.Mnt.countRB(706711)
        }
      }
    }, this);
    SOCK.requestReadyEvent.on(this._onSocketRequestable, this);
    US.init();
    US.readyEvent.on(this._onSocketReady, this);
    US.statusChangedEvent.on(this._onUserStateStatusChange, this);
    US.getState(this._setInitialState, this)
  }, _sendStatistics:function() {
    if(this._statSent) {
      return
    }
    Storage.modify(["statsSentTs"], function(s) {
      var now = WA.now();
      if(+s.statsSentTs + 60 * 60 < now) {
        this._statSent = true;
        WA.StatisticsApi.send(WA.getUserLogin());
        s.statsSentTs = now
      }
    }, this)
  }, _setInitialState:function(state, param) {
    WA.log("###_setInitialState", state);
    if(!state) {
      FM.activate()
    }else {
      if(state == "error") {
        this._errorMode(param)
      }else {
        if(state == "online") {
          WA.log("###call this._activate 1");
          this._activate(function() {
            this.syncStatus.read(function(data) {
              var s = data.get("status").split(":");
              WA.log("###read status", s);
              var customTitle = data.get("custom");
              this._statusModifDate = s[0];
              this._onStatusChange(s[1], customTitle);
              this._listenFM()
            }, this)
          }, this)
        }else {
          if(state == "disabled") {
            Storage.save({"sync$status$disabled":this._statusDisabled = "1"});
            FM.activate(function() {
              FM.deactivate()
            }, this, false);
            WA.Synchronizer.stop();
            this.statusButton.hide();
            this.el && this.el.hide();
            this.notify && this.notify.clear();
            return
          }else {
            if(WA.AuthForm.haveLoginToken()) {
              FM.activate()
            }else {
              this._deactivate();
              this._onStatusChange("offline");
              this._listenFM()
            }
          }
        }
      }
    }
    if(!WA.isPopup) {
      if(state == "popup") {
        this._popupDisabledChecker.start();
        this.notify && this.notify.deactivate()
      }else {
        this._popupDisabledChecker.stop();
        this.notify && this.notify.activate()
      }
    }else {
      this.notify && this.notify.activate()
    }
    if(state != "disabled" && state != "popup" && !WA.isPopup) {
      if(this._statusDisabled == "1") {
        this.isPermanentShutdown = false
      }
      this._statusDisabled = "0";
      if(FM.isActive()) {
        this.syncStatus.write("disabled", "0")
      }else {
        Storage.save({"sync$status$disabled":"0"})
      }
    }
  }, _errorMode:function(attemptDelay, errorType) {
    this._onErrorMode();
    if(this._active || this._active === undefined) {
      this._active = false;
      if(errorType != "frameLoadingError") {
        SOCK.discardEvents();
        FM.deactivate();
        WA.UserAttend.deactivate()
      }
    }
    this.isPermanentShutdown || Storage.load(["status.disabled"], {success:function(storage) {
      if(!storage["status.disabled"]) {
        this._onStatusChange("yellow")
      }
    }, scope:this});
    this.statusButton.setInfo(WA.tr("msgNetworkError", {delay:attemptDelay}));
    this._requestableCb = WA.createDelegate(function() {
      this._activate(function() {
        this.syncStatus.read(function(data) {
          var s = data.get("status").split(":");
          var customTitle = data.get("custom");
          this._statusModifDate = s[0];
          this._onStatusChange(s[1], customTitle);
          this._listenFM()
        }, this)
      }, this)
    }, this);
    if(errorType != "frameLoadingError") {
      FM.activate()
    }
  }, _onPermanentShutdown:function(event) {
    if(this.isPermanentShutdown) {
      return
    }
    this._disableUserEvents();
    this._deactivate();
    if(event && event.isShowInfo) {
      this.statusButton.setStatus("gray");
      this.statusButton.setInfo(event.info);
      this.statusMenu.beforeShowEvent.on(function() {
        return false
      })
    }else {
      if(event && event.reason == "showAuthForm") {
        if(WA.isPopup) {
          this.statusButton.setStatus("offline");
          this.statusButton.hide();
          this._showAuthDialog(true)
        }else {
          this.statusButton.setStatus("offline");
          this.statusButton.show()
        }
      }else {
        this.statusButton.hide();
        this.el.hide();
        this._statusDisabled = "1";
        if(FM.isActive()) {
          this.syncStatus.write("disabled", "1")
        }else {
          Storage.save({"sync$status$disabled":"1"})
        }
      }
    }
    this.isPermanentShutdown = true;
    if(this._promoSms) {
      this._promoSms.destroy();
      this._promoSms = null
    }
    this.notify && this.notify.clear()
  }, _listenFM:function() {
    if(!this._listenFMFlag) {
      this._listenFMFlag = true;
      WA.debug.Console.log("_listenFM");
      FM.focusEvent.on(this._onFocus, this);
      FM.blurEvent.on(this._onBlur, this);
      FM.ifFocused(this._onFocus, null, this)
    }
  }, _storeStatus:function(status, statusTitle, cb, scope) {
    WA.log("###_storeStatus", status);
    if(statusTitle) {
      this.syncStatus.write("custom", statusTitle)
    }
    this.syncStatus.write("status", "" + +new Date + ":" + status, cb, scope)
  }, _onSocketRequestable:function(force) {
    WA.debug.Console.log("socket requestable, force:", force);
    WA.log("###_onSocketRequestable", force, this._active, !!this._requestableCb, WA.DialogsAbstraction.nick);
    if(!WA.DialogsAbstraction.nick) {
      WA.IcqApi.getProfile({email:WA.ACTIVE_MAIL})
    }
    if(this._requestableCb) {
      if(!force && !this._active) {
        SOCK.requestable = false;
        return
      }
      this._requestableCb();
      delete this._requestableCb
    }
    this.notify.checkMutesMigration()
  }, _onSocketReady:function() {
  }, _onUserStateStatusChange:function(status, statusTitle, readyCb) {
    WA.debug.Console.log("_onUserStateStatusChange ", status, ", isActive:", this._active, "requestable:", SOCK.requestable);
    var expandCL = status != "offline" && WA.isPopup;
    var setStatusCb = WA.createDelegate(function(cb, scope) {
      WA.log("###_onUserStateStatusChange5");
      expandCL && this.contactList.show();
      if(this._statusDisabled == "1" && this.isPermanentShutdown) {
        this.isPermanentShutdown = false;
        Storage.save({"sync$status$disabled":this._statusDisabled = "0"})
      }
      this._onStatusChange(status, statusTitle);
      this._storeStatus(status, statusTitle, cb, scope);
      this._listenFM()
    }, this);
    WA.log("###_onUserStateStatusChange1", status);
    if(status != "offline") {
      if(!this._active) {
        WA.log("###_onUserStateStatusChange2");
        this._requestableCb = WA.createDelegate(function() {
          WA.log("###_onUserStateStatusChange4");
          WA.log("###call this._activate 2");
          this._activate(setStatusCb)
        }, this);
        if(SOCK.requestable) {
          WA.log("###_onUserStateStatusChange3");
          this._onSocketRequestable(true)
        }else {
          SOCK.restore()
        }
        FM.activate(false, false, true)
      }else {
        WA.log("###_onUserStateStatusChange2.5");
        setStatusCb()
      }
    }else {
      delete this.preventOfflineBeep;
      this._deactivate();
      setStatusCb(readyCb);
      this.notify.clear();
      return true
    }
  }, _onSyncStatus:function(status, customTitle) {
    WA.debug.Console.log("_onSyncStatus ", status);
    var setStatusCb = WA.createDelegate(function() {
      this._onStatusChange(status, customTitle);
      this._listenFM()
    }, this);
    if(status != "offline") {
      this._activate(setStatusCb, window, true)
    }else {
      this._deactivate();
      setStatusCb()
    }
  }, _activate:function(readyCb, scope, onSync) {
    WA.log("###At last, MA._activate()!");
    if(!this._active) {
      this._active = true;
      WA.debug.Console.log("_activate");
      this._onActivate(function() {
        FM.activate(false, false, !onSync);
        WA.UserAttend.activate();
        WA.AutoAway.activate();
        WA.WindowFocus.activate();
        if(WA.isPopup || this._lastCLState) {
          if(this.isPermanentShutdown) {
            this._hideAuthDialog()
          }
          this.contactList.show();
          delete this._lastCLState
        }
        readyCb && readyCb.call(scope)
      }, this)
    }else {
      readyCb && readyCb.call(scope || window)
    }
  }, _deactivate:function() {
    delete this._requestableCb;
    if(this._active || this._active === undefined) {
      this._active = false;
      WA.debug.Console.log("_deactivate");
      SOCK.discardEvents();
      FM.deactivate();
      WA.UserAttend.deactivate();
      WA.AutoAway.deactivate();
      WA.WindowFocus.deactivate();
      this._onDeactivate()
    }
  }, _onErrorMode:function(status) {
  }, _onStatusChange:function(status) {
  }, _onActivate:function(cb, scope) {
  }, _onDeactivate:function() {
  }, _onDocumentReady:function() {
  }});
  var DependencyEssence = WA.extend(StatusEssence, {_statusAlertsOff:true, constructor:function() {
    DependencyEssence.superclass.constructor.apply(this, arguments)
  }, _showAuthDialog:function(show) {
    if(WA.isPopup && show) {
      return redirectToMailLogin()
    }
  }, _hideAuthDialog:function() {
    if(this._authForm) {
      this._authForm.hide()
    }
  }, __changeStatus:function(status, title) {
    if(this.statusButton.getStatus() == "offline" && status != "offline") {
      this.statusButton.setStatus("yellow")
    }
    WA.conn.UserState.setStatus(status, title);
    U.Mnt.countRB(706784)
  }, _onCountEvent:function(onlineCount, totalCount) {
    WA.debug.Console.log("_onCountEvent: ", onlineCount);
    this.statusButton.setCount(onlineCount);
    this.sync.write("contact_count", onlineCount);
    if(this._promoSms && totalCount > 1) {
      this._promoSms.checkYesterdayActivity()
    }
  }, _userEventEnabled:false, _enableUserEvents:function() {
    if(!this._userEventEnabled) {
      this._userEventEnabled = true;
      this.contactList.enableUserEvents();
      this.dialogsWindow.enableUserEvents();
      WA.debug.Console.log("_enableUserEvents done")
    }
  }, _disableUserEvents:function() {
    if(this._userEventEnabled) {
      this._userEventEnabled = false;
      this.contactList.disableUserEvents();
      this.dialogsWindow.disableUserEvents();
      WA.debug.Console.log("_disableUserEvents")
    }
  }, _toggleStatusMenu:function() {
    if(this.statusMenu && this.statusMenu.rendered) {
      this.statusMenu.toggle()
    }
  }, _createEssences:function() {
    var items = [{iconCls:WA.Statuses.buildCssClass("online"), text:WA.tr("status.online"), handler:function() {
      this.__changeStatus("online")
    }, scope:this}, {iconCls:WA.Statuses.buildCssClass("offline"), text:WA.tr("status.offline"), handler:function() {
      this.__changeStatus("offline")
    }, scope:this}];
    var statusMenu = this.statusMenu = new StatusMenu({fadeIn:true, items:items});
    statusMenu.beforeShowEvent.on(function() {
      statusMenu.getEl().toggleClass("nwa-status-menu_in", !!this._active);
      return!this.statusButton.getPopupMode()
    }, this);
    this.statusButton = new StatusButton({cls:"nwa-button-tab_agent nwa-button-tab_disabled", text:WA.tr("mainTitle"), children:[{tag:"div"}], handler:function(nope, event) {
      var status = this.statusButton.getStatus();
      if(status == "offline" && this.isPermanentShutdown) {
        U.Mnt.log({reason:"breaklog", login:WA.ACTIVE_MAIL, text:"ffbreak:showauth2"});
        this._showAuthDialog()
      }else {
        if(this._userEventEnabled) {
          if(status == "offline") {
            this._toggleStatusMenu()
          }else {
            this.contactList.toggle();
            WA.UserAttend.onActivity();
            U.Mnt.countRB(706784);
            this._active || US.checkConnectivity()
          }
        }else {
          if(status == "offline") {
            this._toggleStatusMenu()
          }
        }
      }
      event.stopEvent()
    }, scope:this});
    this.contactList = new WA.ContactListAgent;
    this.contactList.hideEvent.on(function() {
      this.sync.write("clist", "")
    }, this);
    this.contactList.showEvent.on(function() {
      this.sync.write("clist", "1")
    }, this);
    this.contactList.closeDialogEvent.on(function(email) {
      this.dialogsWindow.closeDialog(email)
    }, this);
    this.contactList.beforeShowEvent.on(function() {
      if(statusMenu.rendered && statusMenu.isVisible()) {
        return false
      }
    }, this);
    this.contactList.abstraction.countEvent.on(this._onCountEvent, this);
    this.contactList.contactSelectEvent.on(function(mail, nick, status, statusTitle, features, phones) {
      this.notify.removeByMail(mail, true);
      this.openDialog(mail, nick, status, statusTitle, features, phones)
    }, this);
    this.contactList.playSoundEvent.on(WA.Beep.unmute, WA.Beep);
    this.contactList.statusAlertsOptionEvent.on(function(val) {
      this._statusAlertsOff = val
    }, this);
    this.dialogsWindow = new WA.DialogsAgent;
    this.contactList.previewsToggleOptionEvent.on(this.dialogsWindow.togglePreviews, this.dialogsWindow);
    this.contactList.subDialogOpenEvent.on(this.dialogsWindow.minimize, this.dialogsWindow);
    this.dialogsWindow.changeFocusEvent.on(this.contactList.addContactDialog.hide, this.contactList.addContactDialog);
    this.dialogsWindow.countChangedEvent.on(function(count) {
      var focused = this.dialogsWindow.getVisibleDialog();
      if(focused && this.dialogsWindow._view.isFirst(focused.mail)) {
        this.notify.shift()
      }else {
        this.notify.shift(true)
      }
    }, this);
    this.dialogsWindow.updateActivityEvent.on(function(clistData, type) {
      if(type === undefined || type === "activity") {
      }else {
        this.contactList.abstraction.updateUnreadContact(clistData, type);
        if(type === "read_message" && clistData && clistData[0]) {
          this.notify.removeByMail(clistData[0])
        }
      }
    }, this);
    this.dialogsWindow.unreadedEvent.on(function(count) {
      this.statusButton.setNewMsgFlag(count > 0)
    }, this);
    this.dialogsWindow.removeContactEvent.on(function(mail) {
      this.contactList.abstraction.removeContact(mail)
    }, this);
    this.dialogsWindow.renameContactEvent.on(function(mail, newNick) {
      this.contactList.abstraction.renameContact(mail, newNick)
    }, this);
    this.dialogsWindow.incomingMessageEvent.on(function(offlineMessage, email) {
      if(this._promoSms) {
        this._promoSms.newIncomingMessage()
      }
      if(offlineMessage) {
        if(this.preventOfflineBeep) {
          return
        }
        this.preventOfflineBeep = true
      }
      if(!WA.MainAgent.isChat(email) || !WA.CLD.getMute(email)) {
        WA.Beep.play("message")
      }
    }, this);
    this.dialogsWindow.selfNameReadyEvent.on(this.contactList.setSelfNick, this.contactList);
    this.dialogsWindow.openAddSearchEvent.on(this.contactList.openAddDialog, this.contactList);
    this.dialogsWindow.sendMessageEvent.on(function() {
      if(this._promoSms) {
        this._promoSms.updateUserActivity()
      }
    }, this);
    this.dialogsWindow.requestListEvent.on(this.contactList.abstraction.getPhoneList, this.contactList.abstraction);
    this.dialogsWindow.addContactEvent.on(this.contactList.abstraction.addContact, this.contactList.abstraction);
    WA.ContactStates.updateEvent.on(function(count) {
      this.statusButton.setNewMsgFlag(WA.ContactStates.hasUnread() > 0)
    }, this);
    this.notify = new WA.NotifyAgent;
    this.notify.clickEvent.on(this.openDialog, this);
    this.notify.cancelEvent.on(this.dialogsWindow.markAsReaded, this.dialogsWindow);
    this.notify.onBeforeNotifyEvent.on(function(mail, statusChange, nativeDisabledOrFocus) {
      if(!WA.isPopup && (this.isPermanentShutdown || this._statusDisabled == "1")) {
        return false
      }
      if(nativeDisabledOrFocus && this.dialogsWindow.getVisibleDialog().mail == mail) {
        return false
      }
      if(statusChange && (this._statusAlertsOff || U.Array.indexOf(this.dialogsWindow.getOpenDialogs() || [], mail) > -1)) {
        return false
      }
    }, this);
    this.dialogsWindow.visibleDialogChangedEvent.on(function(mail) {
      this.notify.removeByMail(mail)
    }, this);
    this.dialogsWindow.closeTabEventEvent.on(this.notify.removeByMail, this.notify);
    if(!WA.isPopup) {
      WA.getDoc().on("mousedown", function(ev) {
        var target = ev.getTarget(true);
        if(!target.isAncestor(this.el) && !target.hasClass("nwa_self")) {
          this.dialogsWindow.minimize();
          this.contactList.minimize()
        }
      }, this)
    }else {
    }
  }, openDialog:function(mail, nick, status, statusTitle, features, phones) {
    if(this._userEventEnabled) {
      this.dialogsWindow.openDialog(mail, nick, status, statusTitle, features, phones)
    }else {
      return false
    }
  }});
  var POPUP_SHOW_PERIOD = 7 * 24 * 60 * 60;
  var BINDING_CHECK_PERIOD = 2 * 24 * 60 * 60;
  var MAX_POPUP_SHOW_NUM = 5;
  var PhoneBinder = WA.extend(Object, {constructor:function() {
    this.notBinded = true;
    this.ready = false;
    this._allowEvents = false;
    this._eventsBlocked = false;
    this._storageMap = ["showTimestamp", "readyTimestamp", "showPeriod", "checkPeriod", "ready", "popupIsShown", "showNum"];
    var lang = WA.useLang ? WA.useLang + "_" + WA.useLang.toUpperCase() : "ru_RU";
    this.checkUrl = "https://agent.mail.ru/waphone/hasphone.php";
    this.sync = WA.Synchronizer.registerComponent("phone_binding_popup", ["hide"]);
    this.sync.triggerEvent.on(this._onSyncTrigger, this);
    var match = (location.href + "").match(/my_popup_time=(\d+)/);
    if(match && match[1]) {
      POPUP_SHOW_PERIOD = +match[1]
    }
    match = (location.href + "").match(/my_binding_time=(\d+)/);
    if(match && match[1]) {
      BINDING_CHECK_PERIOD = +match[1]
    }
    match = (location.href + "").match(/my_popup=(\d)/);
    if(match) {
      this._checkResult = match[1]
    }
  }, onAfterRender:function(mEl, mBoundEl) {
    if(this.notBinded) {
      this.mainEl = mEl;
      this.mainBoundEl = mBoundEl;
      Storage.whenReady(function() {
        this._getSData(function(data) {
          POPUP_SHOW_PERIOD = +data.showPeriod || POPUP_SHOW_PERIOD;
          BINDING_CHECK_PERIOD = +data.checkPeriod || BINDING_CHECK_PERIOD;
          if(data.readyTimestamp && WA.now() - data.readyTimestamp > BINDING_CHECK_PERIOD) {
            Storage.save({phone_binding:"|" + data.readyTimestamp});
            data = {}
          }
          if(!data.showTimestamp || data.ready !== "1" && WA.now() - data.showTimestamp > POPUP_SHOW_PERIOD && (!data.showNum || data.showNum < MAX_POPUP_SHOW_NUM)) {
            this._eventsBlocked = true;
            this.mainEl.blockDOMEvents(["mousedown", "mouseup", "click", "DOMMouseScroll", "mousewheel", "keydown", "keyup", "keypress"], this._checkPhoneBindingOnClick, this)
          }
        })
      }, this)
    }
  }, onFocus:function() {
    this._getSData(function(data) {
      POPUP_SHOW_PERIOD = +data.showPeriod || POPUP_SHOW_PERIOD;
      BINDING_CHECK_PERIOD = +data.checkPeriod || BINDING_CHECK_PERIOD;
      if(data.readyTimestamp && WA.now() - data.readyTimestamp > BINDING_CHECK_PERIOD) {
        data.showTimestamp = 0
      }
      if(data.showTimestamp && (data.ready === "1" || WA.now() - data.showTimestamp < POPUP_SHOW_PERIOD || data.showNum >= MAX_POPUP_SHOW_NUM)) {
        this.ready = true;
        this.notBinded = false;
        this._hidePhoneBindingPopup()
      }else {
        if(data.popupIsShown) {
          this.ready = false;
          this.notBinded = true;
          if(!this._eventsBlocked && this.mainEl) {
            this._eventsBlocked = true;
            this.mainEl.blockDOMEvents(["mousedown", "mouseup", "click", "DOMMouseScroll", "mousewheel", "keydown", "keyup", "keypress"], this._checkPhoneBindingOnClick, this)
          }
          this._sendCheckRequest()
        }else {
          this._hidePhoneBindingPopup()
        }
      }
    })
  }, _onSyncTrigger:function(data) {
    if(data.isChanged("hide") && data.get("hide")) {
      this._hidePhoneBindingPopup()
    }
  }, _getSData:function(cb) {
    Storage.load(["phone_binding"], {success:function(data) {
      var res = {}, map = this._storageMap;
      U.Array.each((data["phone_binding"] || "").split("|"), function(it, ind) {
        map[ind] && (res[map[ind]] = it)
      });
      cb.call(this, res)
    }, scope:this})
  }, _modifySData:function(cb) {
    Storage.modify(["phone_binding"], function(s) {
      var data = {}, map = this._storageMap, res = (s["phone_binding"] || "").split("|");
      U.Array.each(res, function(it, ind) {
        map[ind] && (data[map[ind]] = it)
      });
      cb.call(this, data);
      U.Array.each(map, function(key, ind) {
        data.hasOwnProperty(key) && (res[ind] = data[key])
      });
      s["phone_binding"] = res.join("|")
    }, this)
  }, _sendCheckRequest:function() {
    if(this.checkSent) {
      return
    }
    this.checkSent = true;
    function onReady(res, reqSuccess) {
      this.checkSent = false;
      if(this.ready) {
        return
      }
      this.ready = true;
      var cfg;
      if(res && res.show) {
        cfg = res
      }
      res = !res || !res.show && !res.need_popup;
      if(this._checkResult) {
        res = this._checkResult !== "1";
        if(!res) {
          cfg = {"show":true, "close_btn":true, "show_timeout":86400, "btn_text":"ÐÐ¾Ð´ÑÐ²ÐµÑÐ´Ð¸ÑÑ", "text":"Ð ÑÐ¾Ð¾ÑÐ²ÐµÑÑÑÐ²Ð¸Ð¸ Ñ Ð·Ð°ÐºÐ¾Ð½Ð¾Ð´Ð°ÑÐµÐ»ÑÑÑÐ²Ð¾Ð¼, Ð½ÐµÐ¾Ð±ÑÐ¾Ð´Ð¸Ð¼Ð¾ Ð¿Ð¾Ð´ÑÐ²ÐµÑÐ´Ð¸ÑÑ Ð½Ð¾Ð¼ÐµÑ Ð²Ð°ÑÐµÐ³Ð¾ ÑÐµÐ»ÐµÑÐ¾Ð½Ð°. ÐÐ¾Ð¼ÐµÑ Ð½Ðµ Ð±ÑÐ´ÐµÑ Ð¾ÑÐ¾Ð±ÑÐ°Ð¶Ð°ÑÑÑÑ Ð² Ð²Ð°ÑÐµÐ¼ Ð¿ÑÐ¾ÑÐ¸Ð»Ðµ.", "title":"ÐÐ½Ð¸Ð¼Ð°Ð½Ð¸Ðµ"}
        }
      }
      this.notBinded = !res;
      if(this.notBinded) {
        if(this.mainEl) {
          this._showPhoneBindingPopup(cfg)
        }else {
          this._cfg = cfg;
          this._modifySData(function(data) {
            if(cfg) {
              if(cfg.show_timeout) {
                data.showPeriod = cfg.show_timeout
              }
              if(cfg.check_timeout) {
                data.checkPeriod = cfg.check_timeout
              }
            }
            data.ready = data.readyTimestamp = "";
            data.popupIsShown = 1
          })
        }
      }else {
        this._modifySData(function(data) {
          if(reqSuccess) {
            if(cfg) {
              if(cfg.show_timeout) {
                data.showPeriod = cfg.show_timeout
              }
              if(cfg.check_timeout) {
                data.checkPeriod = cfg.check_timeout
              }
            }
            data.ready = 1;
            data.readyTimestamp = WA.now();
            data.showTimestamp = WA.now()
          }else {
            data.ready = data.readyTimestamp = ""
          }
          data.popupIsShown = ""
        })
      }
    }
    WA.makeJsonpRequest(this.checkUrl, {}, "callback", function(d) {
      onReady.call(this, d, true)
    }, this, onReady);
    WA.setTimeout(function() {
      onReady.call(this, true)
    }, 5E3, this)
  }, _checkPhoneBindingOnClick:function(e, el) {
    if(!this.ready) {
      this._sendCheckRequest();
      return true
    }
    if(this.notBinded) {
      this._showPhoneBindingPopup(this._cfg);
      if(this._allowEvents || e.getTarget(true).up("nwa-phone-binding-popup-cont")) {
        return true
      }
      e.stopEvent()
    }else {
      this.mainEl.unblockDOMEvents(["mousedown", "mouseup", "click", "DOMMouseScroll", "mousewheel", "keydown", "keyup", "keypress"]);
      this._eventsBlocked = false;
      return true
    }
  }, _hidePhoneBindingPopup:function(res) {
    this._modifySData(function(data) {
      if(res !== undefined) {
        if(res) {
          data.ready = 1;
          data.readyTimestamp = WA.now()
        }else {
          data.ready = data.readyTimestamp = ""
        }
        data.showTimestamp = WA.now();
        data.showNum = Number(data.showNum || 0) + 1
      }
      data.popupIsShown = ""
    });
    this.mainEl && this.mainEl.removeClass("nwa-phone-binding-popup-shown");
    if(this._phoneBindingPopup) {
      this._phoneBindingPopup.destroy();
      this._phoneBindingPopupCont.remove();
      delete this._phoneBindingPopup;
      delete this._phoneBindingPopupCont;
      delete this._popupIsShown;
      this.notBinded = false;
      this.sync.write("hide", 1)
    }
  }, _showPhoneBindingPopup:function(cfg) {
    if(this._popupIsShown) {
      return
    }
    this._popupIsShown = true;
    this._allowEvents = true;
    this.sync.write("hide", "");
    this._modifySData(function(data) {
      if(cfg) {
        if(cfg.show_timeout) {
          data.showPeriod = cfg.show_timeout
        }
        if(cfg.check_timeout) {
          data.checkPeriod = cfg.check_timeout
        }
      }
      data.ready = data.readyTimestamp = "";
      data.popupIsShown = 1
    });
    this._phoneBindingPopupCont = this.mainBoundEl.createChild({cls:"nwa-phone-binding-popup-cont nwa-add", style:"display:block;visibility:hidden"});
    this._phoneBindingPopup = new WA.PhoneBindingPopup(cfg);
    this.mainEl.addClass("nwa-phone-binding-popup-shown");
    this._phoneBindingPopup.render(this._phoneBindingPopupCont);
    this._allowEvents = false;
    this._phoneBindingPopupCont.setStyle("visibility", "visible");
    this._phoneBindingPopup.show();
    this._phoneBindingPopup.finishEvent.on(this._hidePhoneBindingPopup, this)
  }});
  var WA_VERSION = 2;
  WA.MainAgent = WA.extend(DependencyEssence, {constructor:function() {
    this.popup = WA.MainAgent.Popup.create();
    this.popup.changeStateEvent.on(this._onPopupChangeState, this);
    this.phoneBinder = new PhoneBinder;
    this.sharedEvent = new U.Event;
    this.sync = WA.Synchronizer.registerComponent("main_agent", ["contact_count", "clist", "dialogs"]);
    this.sync.triggerEvent.on(this._onSyncTriggerEvent, this);
    this.sync.showDebugState();
    WA.MainAgent.superclass.constructor.apply(this, arguments)
  }, _updateAgentVersion:function() {
    WA.Storage.save({main_agent_version:WA_VERSION}, {failure:function() {
      WA.setTimeout(WA.createDelegate(function() {
        this._updateAgentVersion()
      }, this), 1E3)
    }, scope:this})
  }, _onPopupChangeState:function(state, appState) {
    if(state) {
      WA.Synchronizer.stop();
      this._disableUserEvents();
      this._setInitialState("popup", null, true);
      if(appState) {
        this.statusButton.hide()
      }
    }else {
      US.getState(function(userState, param) {
        this._enableUserEvents();
        this.statusButton.setPopupMode(false);
        this.statusButton.el.setAttribute("popup_closing", "");
        this._setInitialState(userState, param, true);
        if(!WA.isPopup) {
          WA.Synchronizer.startUp()
        }
      }, this)
    }
  }, _onStatusChange:function(status, customTitle) {
    WA.debug.Console.log("_onStatusChange");
    if(!this.__intervalFlushed) {
      this.__intervalFlushed = true;
      U.Mnt.flushInterval("loading")
    }
    if(!status) {
      U.Mnt.log({reason:"breaklog", login:WA.ACTIVE_MAIL, text:"empty_status:status=" + status + " US.isReady=" + US.isReady + " US.connected=" + US.connected});
      if(US.isReady) {
        status = US.connected ? "online" : "offline"
      }else {
        US.readyEvent.on(function() {
          if(!this.statusButton.getStatus()) {
            this._onStatusChange()
          }
        }, this, {single:true})
      }
    }
    this.statusButton.setStatus(status);
    this.contactList.setStatus(status);
    this.statusButton.show();
    this.show();
    if(this.popup.getState()) {
      this.statusButton.setPopupMode(true, this.popup.getAppState());
      this.statusButton.el.setAttribute("popup_closing", "");
      Storage.load(["status.disabled"], {success:function(storage) {
        if(storage["status.disabled"] || this._statusDisabled == "1") {
          this.statusButton.hide()
        }
      }, scope:this})
    }
    if(status != "offline") {
      if(WA.isPopup) {
        if(status != "yellow") {
          this.el.removeClass("nwa-popup_login")
        }
        this.statusButton.initialConfig.text != WA.tr("mainTitle") && this.statusButton.setText(WA.tr("mainTitle"))
      }
    }else {
      if(WA.isPopup) {
        this.el.toggleClass("nwa-popup_login", true);
        this.statusButton.setText(WA.tr("status.offline"))
      }
    }
    Storage.modifyObject(["promo"], function(storage) {
      var now = WA.now();
      var promo = storage["promo"];
      promo.lastStatusCheck = promo.lastStatusCheck || 0;
      if(now - promo.lastStatusCheck > 60 * 60) {
        promo.lastStatusCheck = now;
        U.Mnt.countRB(status != "offline" ? 1976271 : 1976272)
      }
    }, this);
    WA.checkClienResolution(false)
  }, _getStatusTitle:function(status, customTitle) {
    status = status.replace(/^icq_/, "");
    var statusTitle = WA.MainAgent.statuses[status] || customTitle || status || WA.MainAgent.statuses["online"];
    return statusTitle
  }, _onActivate:function(cb, scope) {
    WA.debug.Console.log("_onActivate");
    this.sync.read(function(data) {
      this.statusButton.show();
      WA.ChangeLog.activate();
      WA.ContactStates.activate();
      var count = 0;
      var onActivated = function() {
        count++;
        if(count == 2) {
          cb && cb.call(scope || window)
        }
      };
      this.dialogsWindow.activate(onActivated);
      this.contactList.activate(onActivated);
      this._onSyncTriggerEvent(data)
    }, this)
  }, _onErrorMode:function() {
    WA.ChangeLog.deactivate();
    if(WA.isFF) {
      this._lastCLState = this.contactList.isVisible()
    }
    this.contactList.deactivate();
    this.dialogsWindow.deactivate();
    if(this.statusButton.isVisible()) {
      this.contactList.hide()
    }
  }, _onDeactivate:function() {
    WA.Voip.deactivate();
    if(this._promoSms) {
      this._promoSms.deactivate()
    }
    WA.debug.Console.log("_onDeactivate");
    WA.ChangeLog.deactivate();
    WA.ContactStates.deactivate();
    this.dialogsWindow.deactivate();
    this.contactList.deactivate();
    this.contactList.hide();
    this._statTask && this._statTask.stop()
  }, _createEssences:function() {
    WA.MainAgent.superclass._createEssences.call(this);
    this.contactList.popupChangeVisibleEvent.on(function() {
      if(!WA.isPopup) {
        window.open(POPUP_URL, "wa_popup", "width=714,height=500,resizable=no,location=no")
      }else {
        this.popup.close()
      }
    }, this)
  }, _onDocumentReady:function() {
    WA.debug.Console.log("_onDocumentReady");
    this._createEssences();
    this.render(WA.getBody())
  }, _onStorageInit:function() {
    WA.MainAgent.superclass._onStorageInit.call(this);
    this.popup.init();
    this._updateAgentVersion()
  }, _setInitialState:function(state, param, canSet) {
    if(canSet === true) {
      WA.MainAgent.superclass._setInitialState.call(this, state, param)
    }
  }, _listenFM:function() {
    if(!this.popup.getState()) {
      WA.MainAgent.superclass._listenFM.call(this)
    }
  }, _onFocus:function() {
    if(WA.isDebug) {
      document.title = document.title.replace(" [focused]", "") + " [focused]"
    }
    var count = 0;
    var onReady = function() {
      count++;
      if(count == 3) {
        this._enableUserEvents()
      }
      var focused = this.dialogsWindow.getVisibleDialog();
      if(focused && this.dialogsWindow._view.isFirst(focused.mail)) {
        this.notify.shift()
      }
    };
    this.sync.read(function(data) {
      if(WA.isPopup) {
        this.contactList.show()
      }else {
        this._onSyncTriggerEvent(data)
      }
      onReady.call(this)
    }, this);
    this.dialogsWindow.actualize(onReady, this);
    this.contactList.actualize(onReady, this);
    this.phoneBinder.onFocus()
  }, _onBlur:function() {
    if(WA.isDebug) {
      document.title = document.title.replace(" [focused]", "")
    }
    this._disableUserEvents()
  }, _onSyncTriggerEvent:function(data) {
    var str = [];
    if(data.isChanged("clist")) {
      var clist = data.get("clist");
      str.push("clist=" + clist);
      if(clist) {
        this.contactList.show()
      }else {
        if(!WA.isPopup) {
          this.contactList.hide()
        }
      }
    }
    if(data.isChanged("contact_count")) {
      var contact_count = data.get("contact_count");
      str.push("contact_count=" + contact_count);
      if(contact_count) {
        this.statusButton.setCount(contact_count)
      }
    }
    WA.debug.Console.log("_onSyncTriggerEvent " + str.join(", "))
  }, _makeElRoot:function() {
    var rootClass = "nwa-root nwa-icq" + (WA.isPopup ? " nwa-root_fullscreen" : "") + ((WA.isFF || WA.isWebKit) && !WA.isMac ? " nwa-css3-animation" : "") + (WA.isIE ? " nwa-msie" : "") + (WA.isFF ? " nwa-ff" : "") + (WA.isWebKit ? " nwa-webkit" : "") + (WA.isOpera ? " nwa-opera" : "") + (WA.isMac ? " nwa-mac" : "");
    var rootEl = {tag:"div", id:"wa-root", cls:rootClass, style:"display: none; position: fixed; right: 9500px;", children:[{tag:"div", cls:"nwa-root__agent"}]};
    var mailFooterEl = WA.get("w-portal-footer");
    if(mailFooterEl) {
      U.DomHelper.insertFirst(mailFooterEl.dom, rootEl)
    }else {
      U.DomHelper.rapidHtmlInsert(rootEl)
    }
    this.el = WA.get("wa-root");
    this.boundEl = this.el.first()
  }, _checkWindowHeight:function() {
    var windowHeight = WA.util.DomHelper.getWindowSize().height, isLow = windowHeight < 600;
    this.el.toggleClass("nwa-agent_low", isLow)
  }, _onRender:function(ct) {
    this._makeElRoot();
    this.boundEl.on("scroll", function(ev) {
      ev.stopEvent()
    });
    this.statusButton.render(this.boundEl);
    this.contactList.render(this.boundEl);
    this.contactList.beforeShowEvent.on(function() {
      this.statusButton.hide()
    }, this);
    this.contactList.hideEvent.on(function() {
      this.statusButton.show()
    }, this);
    this.contactList.statusMenuToggleEvent.on(function() {
      this._toggleStatusMenu()
    }, this);
    WA.get(window).on("resize", this._checkWindowHeight, this);
    this._checkWindowHeight();
    this.statusMenu.setControlElement(this.contactList.statusToggleBtn.getEl());
    this.statusMenu.render(this.boundEl);
    this.dialogsWindow.render(this.el);
    WA.Beep.render(this.boundEl);
    this.statusButton.el.on("click", this.__onStatusButtonClick, this);
    Storage.whenReady(function() {
      Storage.load(["oldschool"], {success:function(storage) {
        if(storage["oldschool"]) {
          this.el.addClass("old-school")
        }
      }, scope:this})
    }, this)
  }, _onAfterRender:function() {
    this.phoneBinder.onAfterRender(this.el, this.boundEl);
    this._initPromoSms()
  }, _initPromoSms:function() {
    if(!this.rendered) {
      return false
    }
    if(!this._promoSms) {
      this._promoSms = new WA.Promo;
      this._promoSms.friendSelectEvent.on(function(email) {
        WA.ma.contactList.abstraction.getContactsInfo([email], function(contacts) {
          this.openDialog.apply(this, contacts[0])
        }, this)
      }, this);
      if(this.rendered) {
        this._promoSms.render(this.boundEl)
      }
    }
    return true
  }, __onStatusButtonClick:function() {
    var el = this.statusButton.el;
    if(this.popup.getState() && !WA.isPopup && !el.getAttribute("popup_closing")) {
      el.setAttribute("popup_closing", 1);
      this.popup.close()
    }
  }, goAppMode:function() {
    this.popup.updateAppState({app:true})
  }});
  WA.MainAgent.sendAddContact = function(email, nickname, cb, scope) {
    WA.IcqApi.addContact({email:email, nickname:nickname || email}, cb || WA.emptyFn, scope || this)
  };
  WA.MainAgent.isChat = function(email) {
    return email.indexOf("@chat.agent") != -1
  };
  WA.MainAgent.isTel = function(email) {
    return email.indexOf("@tel.agent") > 0 || email.substring(0, 1) === "+"
  };
  WA.MainAgent.isSupport = function(email) {
    return email === "support@corp.mail.ru"
  };
  WA.MainAgent.getGeneralContactStatus = function(contactInfo) {
    return WA.MainAgent.isChat(contactInfo[0]) && "chat" || WA.MainAgent.isTel(contactInfo[0]) && "tel" || contactInfo[2] && contactInfo[0].indexOf("@uin.icq") != -1 && "icq_gray" || contactInfo[2] && "gray" || contactInfo[6] && U.Date.getElapsed(new Date(contactInfo[6] * 1E3)) / 1E3 < U.Date.DAY && "away" || contactInfo[3] || ""
  };
  WA.MainAgent.getSettingsUrl = function() {
    return location.hostname.match(/(video|foto|my)\.mail\.ru/) ? "http://my.mail.ru/my/editprops" : "http://e.mail.ru/cgi-bin/editprofile"
  };
  WA.MainAgent.statuses = {"online":WA.tr("status.online"), "away":WA.tr("status.away"), "dnd":WA.tr("status.dnd"), "offline":WA.tr("status.offline"), "chat":WA.tr("status.conf"), "gray":WA.tr("status.auth"), "auth":WA.tr("status.auth"), "status_chat":WA.tr("status.chat"), "mobile":WA.tr("status.mobile"), "unknown":WA.tr("status.unknown"), "invisible":WA.tr("status.invisible"), "tel":WA.tr("status.tel")};
  WA.hasFlash = WA.util.swf.hasFlashPlayerVersion("7");
  WA.MainAgent.WP2Nick = function(value, defnick) {
    return(value.firstname || value.lastname) && U.String.trim((value.firstname || "") + " " + (value.lastname || "")) || value.nickname || defnick || value.email
  };
  WA.listenSharedEvent = function(callback, scope) {
    if(WA.ma) {
      WA.ma.sharedEvent.on(callback, scope)
    }
  };
  WA.unlistenSharedEvent = function(callback, scope) {
    if(WA.ma) {
      WA.ma.sharedEvent.un(callback, scope)
    }
  };
  WA.fireSharedEvent = function(type, data) {
    if(WA.ma) {
      WA.ma.sharedEvent.fire(type, data)
    }
  }
})();
(function() {
  var WA = WebAgent;
  var Popup = WA.extend(Object, {constructor:function() {
    Popup.superclass.constructor.call(this);
    this.state = 0;
    this.appState = 0;
    this.changeStateEvent = new WA.util.Event;
    this.rpc = WA.rpc.Local.createRpc(this._getId());
    this.rpc.remoteEvent.on(this._onRemoteEvent, this)
  }, _getId:function() {
    WA.abstractError()
  }, getState:function() {
    return this.state
  }, getAppState:function() {
    return this.appState
  }, updateAppState:function() {
  }, init:function() {
    this.rpc.invoke("activate", {"app":WA.APP_MODE})
  }, _onRemoteEvent:function(method, params) {
  }, _updateState:function(state, appState) {
    this.state = state;
    this.appState = appState;
    this.changeStateEvent.fire(state, appState);
    WA.debug.State.set("popup_state", state)
  }, close:function() {
  }});
  var MasterPopup = WA.extend(Popup, {_getId:function() {
    return"MasterPopup"
  }, _onRemoteEvent:function(method, params) {
    if("closePopup" === method) {
      this.close()
    }
  }, init:function() {
    MasterPopup.superclass.init.call(this);
    this._updateState(0, 0)
  }, updateAppState:function(state) {
    this.rpc.invoke("updateAppState", state)
  }, close:function() {
    window.close()
  }});
  var SlavePopup = WA.MainAgent.Popup = WA.extend(Popup, {_getId:function() {
    return"SlavePopup"
  }, _onRemoteEvent:function(method, params) {
    if("changePopupState" === method) {
      this._onChangePopupState(params)
    }
  }, close:function() {
    this.rpc.invoke("closePopup")
  }, _onChangePopupState:function(states) {
    this._updateState(states.state, states.appState);
    if(!states.state) {
      WA.debug.State.set("popup_expiredOn", new Date)
    }
  }});
  var instance = null;
  WA.MainAgent.Popup = {create:function() {
    if(!instance) {
      var clazz = WA.isPopup ? MasterPopup : SlavePopup;
      instance = new clazz
    }
    return instance
  }}
})();
(function() {
  var WA = WebAgent;
  var U = WA.util;
  var NOTIFY_HEIGHT = 76;
  var SPEED = 0.5;
  var notifyCollection;
  var MINUTE = 6E4;
  var HOUR = 60 * MINUTE;
  var DAY = 24 * HOUR;
  var MONTH = 30 * DAY;
  var YEAR = 12 * MONTH;
  var __nativeNotifyStatus;
  var _chromeBubble = new (WA.extend(WA.ui.Component, {_onRender:function(ct) {
    this.el = ct.createChild({cls:"nwa-chrome-permission_bubble", children:{cls:"nwa-chrome-permission_bubble_closer"}});
    this.el.first().on("click", _hideChromeBubble)
  }}));
  function _showChromeBubble() {
    if(!_chromeBubble.rendered) {
      _chromeBubble.render(WA.ma)
    }else {
      _chromeBubble.show()
    }
  }
  function _hideChromeBubble() {
    _chromeBubble.rendered && _chromeBubble.hide()
  }
  var _nativeNotify = !WA.isOpera && window.Notification && (window.Notification.permission || window.Notification.permissionLevel || window.Notification.prototype && window.Notification.prototype.cancel) && window.Notification;
  if(_nativeNotify) {
    var rpc = WA.rpc.Local.createRpc("Notify");
    WA.rpc.Local.whenReady(function() {
      rpc.invoke("getNotifyStatus", null, function(stat) {
        __nativeNotifyStatus = stat
      })
    });
    rpc.remoteEvent.on(function(method, params) {
      if(method == "onRequestPermission") {
        _hideChromeBubble();
        __nativeNotifyStatus = params.permission
      }
    })
  }
  function updateRpcPos() {
    rpc.__upTimeout && clearTimeout(rpc.__upTimeout);
    rpc.__upTimeout = null;
    if(!rpc.__notiEL) {
      return
    }
    var size = rpc.__notiEL.getSize();
    var pos = rpc.__notiEL.offset();
    rpc.__moveRpc({zi:"9999", left:pos.left - document.body.scrollLeft + "px", top:pos.top - document.body.scrollTop + "px", width:size.width + "px", height:size.height + "px", pos:"fixed"});
    rpc.__moved = true
  }
  var Notify = WA.extend(U.EventDispatcher, {constructor:function(img, title, text, uniq) {
    Notify.superclass.constructor.apply(this, arguments);
    this.img = img;
    this.title = title;
    this.text = text;
    this.uniq = uniq;
    this._opacity = 0;
    this._fadeOutEvent = new U.Event
  }, replaceId:"", top:0, subtitle:"", count:0, status:"online", date:0, __showNativeNotifi:function(noAnimation, preventNativeObject) {
    if(!_nativeNotify || preventNativeObject) {
      return this.el && (this.el.dom.style.display = "")
    }
    if((!WA.FocusManager.focused || noAnimation) && __nativeNotifyStatus == "granted") {
      return
    }
    var th = this;
    var subtitle = this.subtitle, txt = U.String.entityDecode(this.prepareText("\n", true));
    if(subtitle) {
      if(subtitle.indexOf("<") > -1) {
        subtitle = U.String.entityDecode(subtitle.replace(/<[^>]+>([^<]+)<[^>]+>/, "$1"))
      }
      txt = subtitle + "\n" + txt
    }
    rpc.invoke("showNativeNotifi", {title:this.title, data:{body:txt, icon:this.img && this.img.toString(), tag:this.uniq}, uniq:this.uniq}, function() {
      __nativeNotifyStatus = "granted";
      th.canceled || th.el && (th.el.dom.style.display = "none")
    }, function(err) {
      __nativeNotifyStatus = err.message;
      th.canceled || th.el && (th.el.dom.style.display = "");
      if(location.host == "webagent.localhost.mail.ru" || location.host == "my.mail.ru") {
        if(err.message == "default") {
          if(_nativeNotify && !Notification.permissionLevel && WA.isChrome) {
            rpc.__notiEL = th.el;
            updateRpcPos();
            rpc.__upTimeout = setTimeout(updateRpcPos, 400)
          }
          rpc.invoke("showRequestOnClick", null, function() {
            _showChromeBubble();
            th.hideNativeNotifi();
            if(!th.canceled) {
              th._onClick(false)
            }
          })
        }
      }
    });
    rpc.remoteEvent.on(this.__onRemoteEvent, this)
  }, __onRemoteEvent:function(method, params) {
    if(this.uniq == params.uniq && method == "onclick" && !this.canceled) {
      if(WA.WindowFocus.focus) {
        this._onClick(false)
      }else {
        var focusf = function() {
          this._onClick(false)
        };
        WA.WindowFocus.focusEvent.on(focusf, this, {single:true});
        window.focus();
        if(_nativeNotify && _nativeNotify.permission && WA.isFF) {
          WA.setTimeout(function() {
            if(!WA.WindowFocus.focus) {
              WA.WindowFocus.focusEvent.un(focusf, this);
              var w = window.open(location.href);
              w && w.focus();
              focusf.call(this)
            }
          }, 300, this)
        }
      }
    }
  }, hideNativeNotifi:function() {
    if(rpc) {
      rpc.__upTimeout && clearTimeout(rpc.__upTimeout);
      rpc.__notiEL = null;
      rpc.__moved && rpc.__backRpc();
      rpc.__moved = false;
      rpc.invoke("hideNativeNotifi", {uniq:this.uniq})
    }
  }, show:function(noAnimation, preventNativeObject) {
    if(!this.showed && !this.canceled) {
      this.showed = true;
      notifyCollection.add(this, noAnimation);
      this.__showNativeNotifi(noAnimation, preventNativeObject)
    }
  }, _onElapsedTimer:function() {
    var d = new Date - this.date;
    var n, text;
    if(d > YEAR) {
      n = Math.floor(d / YEAR);
      text = WA.tr("time.years", {count:n})
    }else {
      if(d > MONTH) {
        n = Math.floor(d / MONTH);
        text = WA.tr("time.months", {count:n})
      }else {
        if(d > DAY) {
          n = Math.floor(d / DAY);
          text = WA.tr("time.days", {count:n})
        }else {
          if(d > HOUR) {
            n = Math.floor(d / HOUR);
            text = WA.tr("time.hours", {count:n})
          }else {
            if(d > MINUTE) {
              n = Math.floor(d / MINUTE);
              text = WA.tr("time.minutes", {count:n})
            }
          }
        }
      }
    }
    if(n) {
      this.elapsedEl.update(WA.tr("notify.timeElapsed", {time:text}))
    }
    this._elapsedTimer.start()
  }, cancel:function(noAnimation) {
    if(this.showed && !this.canceled) {
      this.showed = false;
      this.canceled = true;
      this.dispatchEvent("close", {target:this, noAnimation:noAnimation});
      this.hideNativeNotifi();
      if(noAnimation) {
        this.destroy()
      }else {
        this.setPosition(this._position + 1);
        this._fadeOutEvent.on(this.destroy, this);
        this.fadeOut()
      }
    }
  }, fade:function(fadeIn) {
    U.animation.clear(this._fadeAnim);
    var endValue = 0;
    if(fadeIn) {
      endValue = 100
    }
    this._fadeAnim = U.animation.start(this._opacity, endValue, SPEED, this._onFadeFrame, this)
  }, fadeIn:function() {
    this.fade(true)
  }, fadeOut:function() {
    this.fade(false)
  }, _onFadeFrame:function(value, lastFrame) {
    this.setOpacity(value);
    if(lastFrame && value == 0) {
      this._fadeOutEvent.fire()
    }
  }, setOpacity:function(value) {
    if(this.el) {
      this.el.setStyle("opacity", value / 100)
    }
    this._opacity = value
  }, prepareText:function(rbr, clipTags) {
    var text = this.text, out = "", res, part, symbolsLeft = 35, rePlain = /^([^<]+)<(?:a|div|img)/i, reA = /^(<a.+?>)(.+?)(<\/a>)/i, reDiv = /^<div.+?><\/div>/i, reEmoji = /^<img.*?nwa\-emoji_inline[^>]*?>/i;
    text = text.replace(/<br\s*\/?>/gi, rbr || "").replace(/&nbsp;/ig, " ");
    while(symbolsLeft > 0 && text.length) {
      if(symbolsLeft < 4 && text.length > 3) {
        part = "...";
        text = ""
      }else {
        if(res = reA.exec(text)) {
          text = text.substr(res[0].length);
          part = U.String.ellipsis(res[2], symbolsLeft);
          symbolsLeft -= part.length;
          part = clipTags ? part : res[1] + part + res[3]
        }else {
          if(res = reDiv.exec(text)) {
            text = text.substr(res[0].length);
            symbolsLeft -= 3;
            part = clipTags ? "" : res[0]
          }else {
            if(res = rePlain.exec(text)) {
              text = text.substr(res[1].length);
              part = res[1];
              symbolsLeft -= part.length
            }else {
              if(res = reEmoji.exec(text)) {
                WA.Emoji.initSmiles();
                text = text.substr(res[0].length);
                res[1] = /title="([^"]+)"/.exec(res[0]);
                res[1] && (res[1] = res[1][1]);
                part = clipTags ? res[1] ? ":" + res[1] + ":" : "" : res[0];
                symbolsLeft -= 3
              }else {
                text = text.replace(/&quot;/ig, '"');
                part = U.String.ellipsis(text, symbolsLeft);
                text = "";
                symbolsLeft -= part.length
              }
            }
          }
        }
      }
      out += part
    }
    return out
  }, render:function(ct) {
    var text = this.prepareText();
    var message = {tag:"div", cls:"nwa-notice-message", children:'<div class="nwa-notice-nick nwa-mark-nick">' + this.title + "</div>"};
    if(this.subtitle) {
      message.children += '<div class="nwa-notice-subtitle">' + this.subtitle + "</div>"
    }
    if(this.img) {
      message.children = '<span class="nwa-notice-message-avatar ' + (this.img.className || "") + '" style="background-image: url(' + (this.img.url || this.img) + ');"></span>' + message.children
    }
    message.children += text;
    message.children += '<div class="nwa-notice-message__fadeout"></div>';
    this.el = ct.createChild({tag:"div", cls:"nwa-notice" + (this.img ? "" : " nwa-notice_no-image"), children:[{tag:"div", cls:"nwa-notice-close"}, message]});
    this.elapsedEl = this.el.createChild({tag:"div", cls:"nwa-notice-elapsed"});
    this.setOpacity(this._opacity);
    this.notifyEl = this.el.first();
    this.el.on("click", this._onClick, this).on("contextmenu", this._onClick, this).on("mouseover", this._onMouseOver, this);
    this.el.dom.style.display = "none"
  }, _onMouseMoveOutside:function(event) {
    var target = event.getTarget();
    if(!this.el.contains(target) && this._mouseover) {
      delete this._mouseover;
      WA.getBody().un("mousemove", this._onMouseMoveOutside, this);
      this.dispatchEvent("mouseout", {target:this})
    }
  }, _onMouseOver:function(event) {
    if(!this._mouseover) {
      this._mouseover = true;
      WA.getBody().on("mousemove", this._onMouseMoveOutside, this);
      this.dispatchEvent("mouseover", {target:this})
    }
  }, _onClick:function(event) {
    var trg = event.getTarget && event.getTarget();
    if(trg && trg.className.indexOf("nwa-notice-close") != -1 || event.button == 2) {
      if(this.statusChange) {
        U.Mnt.countRB(1732277)
      }
      this.cancel();
      event.stopEvent()
    }else {
      if(trg && trg.className.indexOf("nwa-notice_reply") > -1) {
        var tmp = WA.splitMail(this.replaceId);
        var url = "http://my.mail.ru/" + tmp[1] + "/" + tmp[0] + "/microposts?postid=" + trg.getAttribute("data-post-id");
        window.open(url);
        this.cancel();
        event.stopPropagation()
      }else {
        if(this.statusChange) {
          U.Mnt.countRB(1733649)
        }
        this.dispatchEvent("click", {target:this})
      }
    }
  }, setTop:function(top) {
    top = Math.round(top);
    this.top = top;
    this.el.setStyle({top:-1 * top + "px"});
    if(top >= NOTIFY_HEIGHT && !this._displayed) {
      this._displayed = true;
      this.dispatchEvent("display", {target:this})
    }
  }, setPosition:function(position, noAnimation) {
    this._position = position;
    U.animation.clear(this._moveAnim);
    if(noAnimation) {
      this.setTop(position * NOTIFY_HEIGHT)
    }else {
      this._moveAnim = U.animation.start(this.top, position * NOTIFY_HEIGHT, SPEED, this.setTop, this)
    }
  }, destroy:function() {
    rpc && rpc.remoteEvent.un(this.__onRemoteEvent, this);
    U.animation.clear(this._fadeAnim);
    U.animation.clear(this._moveAnim);
    WA.getBody().un("mousemove", this._onMouseMoveOutside, this);
    this.el.un("click", this._onClick, this).un("contextmenu", this._onClick, this).un("mouseover", this._onMouseOver, this);
    this.el.remove();
    if(this._elapsedTimer) {
      this._elapsedTimer.stop()
    }
    Notify.superclass.destroy.apply(this, arguments)
  }});
  var NotifyCollection = WA.extend(Object, {constructor:function() {
    this._collection = [];
    WA.fly(window).on("unload", this._onWindowUnload, this);
    WA.fly(window).on("beforeunload", this._onWindowUnload, this)
  }, _onWindowUnload:function() {
    var collection = [].concat(this._collection);
    while(collection.length) {
      collection.shift().hideNativeNotifi()
    }
    WA.fly(window).un("unload", this._onWindowUnload, this);
    WA.fly(window).un("beforeunload", this._onWindowUnload, this)
  }, _indexOfNotify:function(notify) {
    var index = -1;
    U.Array.each(this._collection, function(v, i) {
      if(v == notify) {
        index = i;
        return false
      }
    }, this);
    return index
  }, _indexOfReplaceId:function(replaceId) {
    var index = -1;
    U.Array.each(this._collection, function(v, i) {
      if(v.replaceId == replaceId) {
        index = i;
        return false
      }
    }, this);
    return index
  }, add:function(notify, noAnimation) {
    var top = 0;
    notify.addEventListener("close", WA.createDelegate(this._onNotifyClose, this));
    var index = -1;
    if(notify.replaceId) {
      index = this._indexOfReplaceId(notify.replaceId)
    }
    if(index == -1) {
      if(this._collection.length) {
        var lastNotify = this._collection[0];
        var lastBottom = lastNotify.top - NOTIFY_HEIGHT;
        if(lastBottom < 0) {
          top = lastBottom
        }
      }
      this._collection.unshift(notify)
    }else {
      var oldNotify = this._collection[index];
      top = oldNotify.top;
      oldNotify.cancel(true);
      this._collection.splice(index, 0, notify);
      notify.setOpacity(100)
    }
    notify.render(this.el);
    notify.setTop(top);
    this._reorder(noAnimation);
    if(noAnimation) {
      notify.setOpacity(100)
    }else {
      if(index == -1) {
        notify.fadeIn()
      }
    }
  }, _reorder:function(noAnimation) {
    U.Array.each(this._collection, function(v, i) {
      v.setPosition(i + 1, noAnimation)
    }, this)
  }, _onNotifyClose:function(event) {
    var notify = event.target;
    var index = this._indexOfNotify(notify);
    this._collection.splice(index, 1);
    this._reorder()
  }, render:function(ct) {
    this.el = ct.createChild({tag:"div", cls:"nwa-notice-root"})
  }});
  var Notifications = WA.Notifications = WA.extend(Object, {constructor:function() {
    notifyCollection = new NotifyCollection
  }, createNotification:function(img, title, text, uniq) {
    return new Notify(img, title, text, uniq)
  }, checkPermission:function() {
    return 0
  }, requestPermission:function(cb) {
    cb()
  }, render:function(ct) {
    notifyCollection.render(ct)
  }, shift:function(back, dstat) {
    notifyCollection.el.toggleClass("nwa-notice-shifted", !back);
    dstat && notifyCollection.el.toggleClass("nwa-notice-shifted_ondialer", dstat.visible);
    if(rpc && rpc.__moved) {
      rpc.__upTimeout && clearTimeout(rpc.__upTimeout);
      rpc.__upTimeout = setTimeout(updateRpcPos, 400)
    }
  }, getNativeNotifyEnabled:function() {
    return __nativeNotifyStatus == "granted"
  }})
})();
(function() {
  var WA = WebAgent;
  var U = WA.util;
  var SA = WA.SA;
  var S = WA.Storage;
  var ConnectionRoster = WA.conn.ConnectionRoster;
  var FM = WA.FocusManager;
  var TIMEOUT = 1E4;
  var JSON = WA.getJSON();
  var OFFLINE_NOTIFY_INTERVAL = 3E3;
  var OFFLINE_NOTIFY_LIMIT = 50;
  var TOTAL_NOTIFY_LIMIT = 8;
  var VISIBLE_NOTIFY_LIMIT = 3;
  var migratedBlackList, onMutesMigrated = function(blacklist) {
    migratedBlackList = blacklist
  };
  S.mutesMigratedEvent.on(onMutesMigrated);
  var NotifyAbstraction = WA.NotifyAbstraction = WA.extend(ConnectionRoster, {constructor:function() {
    NotifyAbstraction.superclass.constructor.apply(this, arguments);
    this.onBeforeNotifyEvent = new U.Event;
    this.createNotifyEvent = new U.Event;
    this.cancelNotifyEvent = new U.Event;
    this.timeoutNotifyEvent = new U.Event;
    FM.focusEvent.on(this._onFMFocus, this);
    FM.blurEvent.on(this._onFMBlur, this);
    this._windowFocus = WA.WindowFocus;
    this._windowFocus.focusEvent.on(this._onNativeFocus, this);
    this._windowFocus.blurEvent.on(this._onNativeBlur, this);
    this._packs = [];
    this._blacklist = [];
    this._timeouts = {};
    this._packsQueue = {};
    this._packsCount = {};
    this._totalOfflineCount = 0;
    this._doNotSaveFlag = false;
    this._active = false;
    this._sync = WA.Synchronizer.registerComponent("notify", ["packs"]);
    this._sync.triggerEvent.on(this._onSync, this)
  }, _repack:function(value) {
    var mail = value.from;
    var info = SA.get(mail);
    var nick = info.nick;
    var now = +new Date;
    var fromMail = mail;
    var isChat = WA.MainAgent.isChat(mail);
    var pack = {notify:{status:info.status, title:info.nick, text:value.event ? WA.DialogsAbstraction.buildEventMessage(value, isChat) : value.text, date:value.timestamp * 1E3, replaceId:mail}, extra:{status:info.status, status_title:info.status_title, from:mail, title:info.nick, mid:value.mid, features:info.features}, uniq:Math.round(Math.random() * 99999), ts:now};
    if(value.offline) {
      pack.extra.offline = 1
    }
    if(value.statusChange) {
      var statusType = value.status.type.replace(/^icq_/, "");
      pack.notify.replaceId = mail + "_s";
      pack.notify.statusChange = 1;
      pack.extra.title = pack.notify.title = pack.notify.title || mail;
      pack.notify.text = '"' + (value.status.title || WA.MainAgent.statuses[statusType] || statusType) + '"'
    }else {
      if(WA.MainAgent.isChat(mail)) {
        pack.notify.status = "chat";
        var sender = value.senderFriendly;
        fromMail = value.sender || mail;
        info = sender ? {nick:sender} : SA.get(fromMail);
        pack.notify.subtitle = 'Ð² <span class="nwa-mark-nick">' + U.String.htmlEntity(pack.notify.title) + "</span>";
        pack.extra.title = pack.notify.title;
        pack.notify.title = info.nick || fromMail
      }else {
        if(value.auth) {
          pack.notify.status = "auth";
          pack.notify.text = WA.tr("notify.authRequest");
          pack.extra.title = pack.notify.title = pack.notify.title || mail
        }
      }
    }
    if(value.mult && value.mult.tag && value.mult.tag.indexOf("sticker") > 1) {
      pack.notify.text = WA.tr("notify.youHaveSticker")
    }
    pack.notify.title = U.String.htmlEntity(pack.notify.title);
    pack.extra.title = U.String.htmlEntity(pack.extra.title);
    var url = WA.DialogsAgent.extractUrlFromMessage(value.mid || value.arch_id, pack.notify.text);
    var snippetTitle = url && U.String.htmlEntity(WA.snippet.getTitle(url) || "");
    pack.notify.text = snippetTitle || WA.DialogsAgent.buildPlainHtmlMessage(pack.notify.text);
    pack.notify.title_plain = pack.notify.title;
    if(fromMail) {
      pack.notify.img = WA.makeAvatar(mail, nick, "_avatar50")
    }
    return pack
  }, _indexOfByUniq:function(uniq) {
    var index = -1;
    U.Array.each(this._packs, function(pack, i) {
      if(pack.uniq === uniq) {
        index = i;
        return false
      }
    }, this);
    return index
  }, _indexOfByReplaceId:function(replaceId) {
    var index = -1;
    U.Array.each(this._packs, function(pack, i) {
      if(pack.notify.replaceId === replaceId) {
        index = i;
        return false
      }
    }, this);
    return index
  }, _saveSync:function() {
    this._sync.write("packs", JSON.stringify(this._packs))
  }, _onSync:function(data) {
    if(data.isChanged("packs")) {
      var packs = JSON.parse(data.get("packs") || "[]");
      this.clear();
      S.load(["status.disabled"], {success:function(storage) {
        var packIds = "";
        if(this._active && (!storage["status.disabled"] || WA.isPopup)) {
          U.Array.each(packs, function(pack) {
            pack.showed = true;
            packIds += pack.uniq + ",";
            this.createNotifyEvent.fire(pack.uniq, pack.notify, pack.extra, true);
            this._timeoutSet(pack.uniq)
          }, this)
        }
        this._packs = packs;
        WA.log("###Sync packs, length:" + this._packs.length + "  ids:" + packIds)
      }, scope:this})
    }
  }, activate:function() {
    this._active = true;
    this._sync.read(this._onSync, this)
  }, deactivate:function() {
    this._active = false;
    this.clear(true)
  }, checkMutesMigration:function() {
    if(migratedBlackList) {
      this.applyMigratedBlackList(migratedBlackList)
    }else {
      S.mutesMigratedEvent.on(function(blacklist) {
        migratedBlackList = blacklist;
        this.applyMigratedBlackList(migratedBlackList)
      }, this)
    }
    S.mutesMigratedEvent.un(onMutesMigrated)
  }, applyMigratedBlackList:function(migratedBlackList) {
    var blacklist = migratedBlackList && migratedBlackList.split(",");
    if(blacklist) {
      U.Array.each(blacklist, function(email) {
        this.setEmailBlacklistState(email, true)
      }, this)
    }
  }, setEmailBlacklistState:function(email, state) {
    WA.IcqApi.muteContact({email:email, mute:state}, function() {
    }, this)
  }, _timeoutRemove:function(uniq) {
    if(this._timeouts[uniq]) {
      this._timeoutStop(uniq);
      delete this._timeouts[uniq]
    }
  }, _timeoutSet:function(uniq) {
    if(!this._timeouts[uniq]) {
      this._timeouts[uniq] = new U.DelayedTask({fn:function() {
        this._remove(uniq);
        this.timeoutNotifyEvent.fire(uniq)
      }, scope:this, interval:TIMEOUT})
    }
  }, _timeoutStart:function(uniq, interval) {
    if(this._timeouts[uniq]) {
      this._timeouts[uniq].start(interval)
    }
  }, _timeoutStop:function(uniq) {
    this._timeoutSet(uniq);
    if(this._timeouts[uniq]) {
      this._timeouts[uniq].stop()
    }
  }, _remove:function(uniq) {
    this._timeoutRemove(uniq);
    var index = this._indexOfByUniq(uniq);
    if(index != -1) {
      this._packs.splice(index, 1);
      WA.log("###Remove pack (" + uniq + "), new length:", this._packs.length)
    }
    if(!this._doNotSaveFlag) {
      this._saveSync()
    }
  }, _onAfterConnectionResponse:function() {
    if(this._newMessages) {
      delete this._newMessages;
      var count = 0;
      var _packs = U.Array.clone(this._packs);
      var packIds = "", packNotShownIds = "";
      U.Array.eachReverse(_packs, function(pack, i) {
        if(!pack.showed && count < VISIBLE_NOTIFY_LIMIT) {
          pack.showed = true;
          count++;
          if(pack.extra.offline && ++this._totalOfflineCount > TOTAL_NOTIFY_LIMIT) {
            return
          }
          this.createNotifyEvent.fire(pack.uniq, pack.notify, pack.extra)
        }else {
          if(count >= VISIBLE_NOTIFY_LIMIT && pack.showed) {
            packIds += pack.uniq + ",";
            this.cancelNotifyEvent.fire(pack.uniq)
          }else {
            if(count >= VISIBLE_NOTIFY_LIMIT && !pack.showed) {
              packNotShownIds += pack.uniq + ","
            }
          }
        }
      }, this);
      if(packIds || packNotShownIds) {
        WA.log("###Cancel shown packs:" + packIds + " SKIP not shown:" + packNotShownIds)
      }
      var overPacks = this._packs.length > VISIBLE_NOTIFY_LIMIT;
      packIds = "";
      while(this._packs.length > VISIBLE_NOTIFY_LIMIT) {
        var pack = this._packs.shift();
        packIds += pack.uniq + ",";
        this.cancelNotifyEvent.fire(pack.uniq, true);
        this._timeoutRemove(pack.uniq)
      }
      if(overPacks) {
        WA.log("###Shift packs, new length:" + this._packs.length + "  ids:" + packIds)
      }
      this._saveSync()
    }
  }, _onConnectionMessage:function(value) {
    if(!value.from) {
      return
    }
    var pack = this._repack(value);
    if(WA.MainAgent.isChat(pack.extra.from) && WA.CLD.getMute(pack.extra.from)) {
      return
    }
    if(this.onBeforeNotifyEvent.fire(pack.extra.from, !!pack.notify.statusChange, this._windowFocus._intermediateFocus) === false) {
      return
    }
    this._handlePack(pack)
  }, _onConnectionHistoryState:function(value) {
    if(value.historyPart && value.historyPart.history && value.historyPart.history.length) {
      U.Array.each(value.historyPart.history, function(m) {
        if(m[1] && m[1].from !== WA.ACTIVE_MAIL && (!value.yours || value.yours.lastRead < m[1].arch_id)) {
          this._onConnectionMessage(m[1])
        }
      }, this)
    }
  }, resetPackQueue:function(email) {
    if(this._packsQueue[email]) {
      clearTimeout(this._packsQueue[email].queueTimer);
      delete this._packsQueue[email]
    }
  }, _handlePack:function(pack) {
    var email = pack.extra.from;
    this.resetPackQueue(email);
    if(pack.extra.offline) {
      var packCount = this._packsCount[email] || 0;
      this._packsCount[email] = ++packCount;
      if(packCount > OFFLINE_NOTIFY_LIMIT) {
        return
      }
    }
    var index = this._indexOfByReplaceId(pack.notify.replaceId);
    if(index != -1) {
      var oldPack = this._packs[index];
      if(pack.extra.offline) {
        var now = +new Date;
        var diff = now - oldPack.ts;
        if(diff < OFFLINE_NOTIFY_INTERVAL) {
          var queueTimer = WA.setTimeout(function(email) {
            return function() {
              var pack = this._packsQueue[email];
              if(pack) {
                pack.ts = +new Date;
                delete pack.queueTimer;
                this._handlePack(pack);
                this._onAfterConnectionResponse()
              }
            }
          }(email), OFFLINE_NOTIFY_INTERVAL - diff, this);
          pack.queueTimer = queueTimer;
          this._packsQueue[email] = pack;
          return
        }
      }
      this._timeoutRemove(oldPack.uniq);
      pack.notify.count = (oldPack.notify.count || 1) + 1;
      pack.notify.title_plain += " (" + pack.notify.count + ")";
      this._packs[index] = pack;
      if(oldPack.showed) {
        this.cancelNotifyEvent.fire(oldPack.uniq, true)
      }
    }else {
      this._packs.push(pack)
    }
    this._timeoutSet(pack.uniq);
    if(this._windowFocus.focus || pack.notify.statusChange) {
      this._timeoutStart(pack.uniq)
    }
    this._newMessages = true
  }, _onConnectionAuthRequest:function(value) {
    value.auth = 1;
    this._onConnectionMessage(value)
  }, _onConnectionContactStatus:function(value) {
    if(!value.status) {
      return
    }
    if(value.status.type == "offline" || value.status.type == "icq_offline" || value.status.type == "gray" || value.status.type == "icq_gray" || value.change !== true) {
      return
    }
    value.statusChange = 1;
    value.from = value.email;
    this._onConnectionMessage(value)
  }, stopTimeout:function() {
    var changed = false;
    var now = +new Date;
    U.Object.each(this._packs, function(pack, replaceId) {
      if(pack.notify.statusChange) {
        return
      }
      pack.ts = now;
      this._timeoutStop(pack.uniq);
      changed = true
    }, this);
    if(changed) {
      this._saveSync()
    }
  }, restartTimeout:function() {
    var changed = false;
    var now = +new Date;
    U.Object.each(this._packs, function(pack, replaceId) {
      this._timeoutStart(pack.uniq);
      pack.ts = now;
      changed = true
    }, this);
    if(changed) {
      this._saveSync()
    }
  }, restoreTimeout:function() {
    var now = +new Date;
    U.Object.each(this._packs, function(pack, replaceId) {
      this._timeoutStart(pack.uniq, TIMEOUT - (now - pack.ts))
    }, this)
  }, _onFMFocus:function() {
    this.restoreTimeout()
  }, _onFMBlur:function() {
    this.stopTimeout()
  }, close:function(uniq) {
    this._remove(uniq)
  }, clear:function(doNotSave) {
    this._doNotSaveFlag = doNotSave;
    var packs = U.Array.clone(this._packs);
    U.Array.each(packs, function(pack) {
      this.cancelNotifyEvent.fire(pack.uniq, true);
      this._timeoutRemove(pack.uniq)
    }, this);
    this._doNotSaveFlag = false
  }, _onNativeFocus:function() {
    FM.ifFocused(this.restoreTimeout, false, this)
  }, _onNativeBlur:function() {
    FM.ifFocused(this.stopTimeout, false, this)
  }, removeByReplaceId:function(replaceId) {
    var packs = U.Array.clone(this._packs);
    U.Array.each(packs, function(pack) {
      if(pack.notify.replaceId.replace(/_s$/, "") == replaceId) {
        this.resetPackQueue(pack.extra.from);
        this.cancelNotifyEvent.fire(pack.uniq, true);
        this._timeoutRemove(pack.uniq)
      }
    }, this)
  }})
})();
(function() {
  var WA = WebAgent;
  var U = WA.util;
  var notifications;
  var NotifyAgent = WA.NotifyAgent = WA.extend(Object, {constructor:function() {
    this._notifies = {};
    this.clickEvent = new U.Event;
    this.cancelEvent = new U.Event;
    this.abstraction = new WA.NotifyAbstraction;
    this.abstraction.createNotifyEvent.on(this._onCreateNotify, this);
    this.abstraction.cancelNotifyEvent.on(this._onCancelNotify, this);
    this._timeouted = {};
    this.abstraction.timeoutNotifyEvent.on(this._onTimeoutNotify, this);
    this._onCloseScope = WA.createDelegate(this._onClose, this);
    this._onMouseOverScope = WA.createDelegate(this._onMouseOver, this);
    this._onMouseOutScope = WA.createDelegate(this._onMouseOut, this);
    this._onClickScope = WA.createDelegate(this._onClick, this);
    this.onBeforeNotifyEvent = new U.Event;
    this.abstraction.onBeforeNotifyEvent.on(function(from, statChange, winFocus) {
      return this.onBeforeNotifyEvent.fire(from, statChange, winFocus || !this._getNativeNotifyEnabled())
    }, this);
    this._shifted = false
  }, _makeNotify:function(info, noAnimation, uniq) {
    if(!notifications) {
      notifications = window.notifications
    }
    var oldNotifyData = this._getByReplaceId(info.replaceId);
    if(oldNotifyData) {
      oldNotifyData.notify.removeEventListener("close", this._onCloseScope);
      this._removeNotify(oldNotifyData.uniq)
    }
    var notify = notifications.createNotification(info.img, info.title_plain, info.text, uniq);
    WA.apply(notify, info);
    notify.addEventListener("close", this._onCloseScope);
    notify.addEventListener("mouseover", this._onMouseOverScope);
    notify.addEventListener("mouseout", this._onMouseOutScope);
    notify.addEventListener("click", this._onClickScope);
    notify.show(noAnimation);
    return notify
  }, _onCreateNotify:function(uniq, info, extra, noAnimation) {
    if(info.statusChange) {
      U.Mnt.countRB(1732275)
    }
    this._notifies[uniq] = {info:info, extra:extra, uniq:uniq, notify:this._makeNotify(info, noAnimation, uniq)}
  }, _onTimeoutNotify:function(uniq, noAnimation) {
    var data = this._notifies[uniq];
    if(data && data.info.statusChange) {
      U.Mnt.countRB(1732279)
    }
    this._timeouted[uniq] = 1;
    this._onCancelNotify(uniq, noAnimation)
  }, _onCancelNotify:function(uniq, noAnimation) {
    var data = this._notifies[uniq];
    if(data) {
      data.notify.cancel(noAnimation)
    }
  }, _onMouseOver:function() {
    this.abstraction.stopTimeout()
  }, _onMouseOut:function() {
    this.abstraction.restartTimeout()
  }, _onClick:function(event) {
    var notify = event.target;
    var data = this._getByNotify(notify);
    if(data) {
      this.clickEvent.fire(data.extra.from, data.extra.title, data.extra.status, data.extra.status_title, data.extra.features);
      this.abstraction.resetPackQueue(data.extra.from)
    }
    notify.cancel()
  }, _removeNotify:function(uniq) {
    var data = this._notifies[uniq];
    if(data) {
      data.notify.cancel(true)
    }
    this.abstraction.close(uniq);
    delete this._notifies[uniq]
  }, _onClose:function(event) {
    var notify = event.target;
    var data = this._getByNotify(notify);
    this._removeNotify(data.uniq);
    if(!this._timeouted[data.uniq]) {
      event.noAnimation || this.cancelEvent.fire(data.extra.from, data.extra.mid)
    }else {
      delete this._timeouted[data.uniq]
    }
  }, _getByNotify:function(notify) {
    var retval = false;
    U.Object.each(this._notifies, function(data, k) {
      if(data.notify === notify) {
        retval = data;
        return false
      }
    }, this);
    return retval
  }, _getByReplaceId:function(replaceId) {
    var retval = false;
    U.Object.each(this._notifies, function(data, k) {
      if(data.info.replaceId.replace(/_s$/, "") === replaceId) {
        retval = data;
        return false
      }
    }, this);
    return retval
  }, _getNativeNotifyEnabled:function() {
    if(!notifications) {
      notifications = window.notifications
    }
    return notifications.getNativeNotifyEnabled()
  }, clear:function(doNotSave) {
    this.abstraction.clear(doNotSave)
  }, removeByMail:function(mail, silent) {
    if(silent) {
      var data = this._getByReplaceId(mail);
      this._timeouted[data.uniq] = 1
    }
    this.abstraction.removeByReplaceId(mail)
  }, shift:function(back) {
    (notifications || (notifications = window.notifications)) && this._shifted == (back || false) && notifications.shift(!(this._shifted = !back))
  }, getEmailBlacklistState:function(email, cb, scope) {
    this.abstraction.getEmailBlacklistState(email, cb, scope)
  }, getLocalEmailBlacklistState:function(email, cb, scope) {
    return this.abstraction.getLocalEmailBlacklistState(email)
  }, checkMutesMigration:function() {
    this.abstraction.checkMutesMigration()
  }, setEmailBlacklistState:function(email, state) {
    this.abstraction.setEmailBlacklistState(email, state)
  }, activate:function() {
    this.abstraction.activate()
  }, deactivate:function() {
    this.abstraction.deactivate()
  }})
})();
(function() {
  var WA = WebAgent, U = WA.util, US = WA.conn.UserState, SOCK = WA.conn.ConnectionFacade, S = WA.Storage, ConnectionRoster = WA.conn.ConnectionRoster;
  var API = WA.extend(ConnectionRoster, {constructor:function() {
    API.superclass.constructor.apply(this, arguments);
    this.errorEvent = new U.Event;
    SOCK.requestReadyEvent.on(function() {
      this._openQueue()
    }, this);
    US.permanentShutdownEvent.on(function(event) {
      if(event && event.reason == "noAuth") {
        this._status = "offline";
        this._noauth = true
      }
    }, this);
    US.statusChangedEvent.on(function(status) {
      this._status = status
    }, this);
    US.readyEvent.on(function() {
      if(WA.ma.isPermanentShutdown) {
        this._disabled = true;
        this._cancelOpening("disabledByUser")
      }
      US.getActualStatus(function(status) {
        this._status = status
      }, this)
    }, this);
    S.whenReady(function() {
      WA.ma.popup.changeStateEvent.on(function(isOpened) {
        if(!isOpened) {
          this._openQueue()
        }
      }, this);
      US.getActualStatus(function(status) {
        if(!this._confirmEventsListened) {
          this._confirmEventsListened = true;
          WA.ma.contactList.onlineConfirmSuccessEvent.on(function() {
            WA.ma.statusButton.setStatus("yellow");
            WA.conn.UserState.setStatus("online")
          }, this);
          WA.ma.contactList.onlineConfirmDeclineEvent.on(function() {
            this._cancelOpening("onlineDecline")
          }, this)
        }
        if(status == "disabled") {
          this._disabled = true;
          this._cancelOpening("disabledByUser")
        }else {
          this._status = status
        }
      }, this)
    }, this)
  }, _cancelOpening:function(message) {
    if(!message) {
      debugger
    }
    if(this._queue.length) {
      this.errorEvent.fire({message:message, queue:this._queue});
      this._queue = []
    }
  }, _queue:[], _idlist:{}, _addAction:function(type, args) {
    var id = args.id, mail = args.mail;
    if(WA.ma.popup.getState()) {
      WA.ma.popup.close()
    }
    var index = this._indexOfQueue(id, mail);
    if(index == -1) {
      if(!mail && this._idlist[id]) {
        mail = this._idlist[id]
      }
      args = WA.apply(args, {type:type});
      this._queue.push(args)
    }
    if(this._disabled) {
      this._cancelOpening("disabledByUser");
      return true
    }else {
      if(this._noauth) {
        this._cancelOpening("invalidUser");
        return true
      }else {
        if(WA.ma.popup.getState()) {
          WA.ma.popup.close()
        }else {
          this._openQueue()
        }
      }
    }
    return false
  }, openDialog:function(id, mail) {
    return this._addAction("openDialog", {id:id, mail:mail})
  }, getProfile:function(id, mail, cb, scope) {
    return this._addAction("getProfile", {id:id, mail:mail, cb:cb, scope:scope})
  }, callTo:function(tel) {
    U.Mnt.countRB(1313949);
    return this._addAction("call", {mail:tel, tel:tel})
  }, _indexOfQueue:function(id, mail) {
    return U.Array.indexOfBy(this._queue, function(e) {
      if(e.id && e.id == id || e.mail && e.mail == mail) {
        return true
      }
    }, this)
  }, _onConnectionContactMail:function(value) {
    var index = this._indexOfQueue(value.id);
    if(index != -1) {
      this._queue[index].mail = value.mail;
      this._openKnown()
    }
  }, _openQueue:function() {
    if(this._status && this._queue.length) {
      if(this._status != "offline") {
        if(this._queue.length) {
          var idlist = [];
          U.Array.each(this._queue, function(c) {
            if(!c.mail && !c.requested) {
              idlist.push(c.id);
              c.requested = true
            }
          }, this);
          if(idlist.length) {
            SOCK.getMailById(idlist[0])
          }else {
            this._openKnown()
          }
        }
      }else {
        U.Mnt.countRB(1313950);
        WA.conn.UserState.getUserStatus(function(status) {
          if(status.type == "offline") {
            WA.ma.contactList.onlineConfirm(WA.tr("box.goOnline"))
          }else {
            WA.ma.contactList.onlineConfirm(WA.tr("box.goOnlineForce"))
          }
        }, function(errno, errmsg) {
          this._cancelOpening(errmsg)
        }, this)
      }
    }
  }, _onConnectionMaillist:function(value) {
    U.Array.each(value, function(contact) {
      this._idlist[contact.id] = contact.mail;
      var index = this._indexOfQueue(contact.id);
      this._queue[index].mail = contact.mail
    }, this);
    this._openKnown()
  }, _openKnown:function() {
    var maillist = [], mailhash = {};
    var queue = [];
    var tel;
    U.Array.each(this._queue, function(e, index) {
      if(e.mail) {
        if(e.type == "openDialog") {
          maillist.push(e.mail);
          mailhash[e.mail] = index
        }else {
          if(e.type == "getProfile") {
            WebAgent.ma.contactList.addContactDialog._abstraction.get(e.mail, e.cb, e.scope)
          }else {
            if(e.type == "call") {
              tel = e.tel
            }
          }
        }
      }else {
        queue.push(e)
      }
    }, this);
    this._queue = queue;
    WA.ma.contactList.abstraction.getContactsInfo(maillist, function(contacts) {
      U.Array.each(contacts, function(contact) {
        delete mailhash[contact[0]];
        WA.ma.dialogsWindow.openDialog.apply(WA.ma.dialogsWindow, contact)
      }, this);
      var lastindex = -1, mail;
      U.Object.each(mailhash, function(index, m) {
        if(index > lastindex) {
          lastindex = index;
          mail = m
        }
      }, this);
      if(mail) {
        WA.ma.contactList.searchContact(mail, true)
      }
    }, this);
    if(tel) {
      WA.ma.contactList.callTo(tel)
    }
  }});
  WA.API = new API
})();
(function() {
  var WA = WebAgent;
  var U = WA.util;
  var S = WA.Storage;
  var SOCK = WA.ConnectionFacade;
  var ConnectionRoster = WA.conn.ConnectionRoster;
  var MINUTE = 60;
  var HOUR = 60 * MINUTE;
  var DAY = 24 * HOUR;
  var WEEK = DAY * 7;
  var MONTH = DAY * 30;
  var FIRST_INTERVAL = 7 * 24 * 60 * 60;
  var ua = navigator.userAgent;
  var isMac = ua.indexOf("Mac") != -1;
  var haveDesktopClient = ua.indexOf("MRA") != -1;
  var INSTALL_AGENT_RBCOUNTER;
  var installAgentType = 0;
  var installAgentLink;
  var installAgentText;
  if(installAgentType == 0) {
    installAgentText = "<b>" + WA.tr("promo.installAgent") + "</b><br>" + WA.tr("promo.checkNewMail");
    if(!isMac) {
      INSTALL_AGENT_RBCOUNTER = 1190681;
      installAgentLink = "http://r.mail.ru/clb1177706/agent.mail.ru/windows?partnerid=350"
    }else {
      INSTALL_AGENT_RBCOUNTER = 1190689;
      installAgentLink = "http://r.mail.ru/clb1177715/agent.mail.ru/macos?partnerid=352"
    }
  }else {
    installAgentText = "<b>" + WA.tr("promo.installAgent") + "</b><br>" + WA.tr("promo.notifications");
    if(!isMac) {
      INSTALL_AGENT_RBCOUNTER = 1190685;
      installAgentLink = "http://r.mail.ru/clb1177708/agent.mail.ru/windows?partnerid=351"
    }else {
      INSTALL_AGENT_RBCOUNTER = 1190690;
      installAgentLink = "http://r.mail.ru/clb1177716/agent.mail.ru/macos?partnerid=353"
    }
  }
  var SmsPromo = WA.extend(WA.ui.Component, {constructor:function() {
    SmsPromo.superclass.constructor.apply(this, arguments);
    this.clickEvent = new U.Event;
    this.closeEvent = new U.Event
  }, render:function(ct) {
    this._ct = ct
  }, _onRender:function(ct) {
    this.el = ct.createChild({cls:"nwa-promo-sms", style:"display:none;", children:["<b>" + WA.tr("promo.freeSms") + "</b><br>" + WA.tr("promo.sendFromAgent"), {cls:"nwa-promo-sms-close"}]})
  }, _onAfterRender:function() {
    this.el.on("click", this._onClick, this)
  }, _onClick:function(e) {
    var trg = e.getTarget(true);
    if(trg.getClass() == "") {
      trg = trg.parent()
    }
    if(trg.hasClass("nwa-promo-sms-close")) {
      U.Mnt.countRB(1100901);
      e.stopPropagation()
    }else {
      if(trg.hasClass("nwa-promo-sms")) {
        U.Mnt.countRB(1100899);
        this.clickEvent.fire();
        e.stopPropagation()
      }
    }
    this.closeEvent.fire();
    this.hide()
  }, show:function() {
    if(!this.rendered && this._ct) {
      SmsPromo.superclass.render.call(this, this._ct)
    }
    if(this.rendered) {
      SmsPromo.superclass.show.call(this)
    }
  }, _onShow:function() {
    U.Mnt.countRB(1100896)
  }, destroy:function() {
    SmsPromo.superclass.destroy.apply(this, arguments);
    this.clickEvent.removeAll();
    this.closeEvent.removeAll();
    this._destroyed = true;
    if(this._el) {
      this._el.remove()
    }
  }});
  var AgentPromo = WA.extend(SmsPromo, {_onRender:function(ct) {
    this.el = ct.createChild({cls:"nwa-promo-installagent nwa-promo-installagent-type" + installAgentType, style:"display:none;", children:[installAgentText, {tag:"a", href:installAgentLink, target:"_blank"}, {cls:"nwa-promo-installagent-close"}]})
  }, _onAfterRender:function() {
    this.el.on("click", function(e) {
      var trg = e.getTarget(true);
      if(trg.getClass() == "") {
        trg = trg.parent()
      }
      if(trg.hasClass("nwa-promo-installagent-close")) {
        U.Mnt.countRB(1100901);
        e.stopPropagation()
      }else {
        if(trg.hasClass("nwa-promo-installagent")) {
          U.Mnt.countRB(1100899);
          this.clickEvent.fire();
          e.stopPropagation()
        }
      }
      this.closeEvent.fire();
      this.hide()
    }, this)
  }});
  var SmilesPromoTitle = ["ÐÑÐ¿ÑÐ°Ð²Ñ ÑÐ»ÑÐ±ÐºÑ!", "Ð¡Ð¼Ð°Ð¹Ð»Ð¸ÐºÐ¸ Ð² ÐÐµÐ±-ÐÐ³ÐµÐ½ÑÐµ!", "ÐÑÐµ Ð±Ð¾Ð»ÑÑÐµ ÑÐ¼Ð°Ð¹Ð»Ð¸ÐºÐ¾Ð²!"], SmilesPromoText = ["ÐÐ¾Ð²Ð°Ñ ÐºÐ¾Ð»Ð»ÐµÐºÑÐ¸Ñ ÑÐ¼Ð°Ð¹Ð»Ð¸ÐºÐ¾Ð²<br/>ÑÐ¶Ðµ Ð² ÐÐµÐ±-ÐÐ³ÐµÐ½ÑÐµ", "ÐÑÐµ ÐºÐ¾Ð»Ð»ÐµÐºÑÐ¸Ð¸ ÑÐ¼Ð°Ð¹Ð»Ð¸ÐºÐ¾Ð²<br/>Ð´Ð¾ÑÑÑÐ¿Ð½Ñ Ñ Ð»ÑÐ±Ð¾Ð³Ð¾ ÐºÐ¾Ð¼Ð¿ÑÑÑÐµÑÐ°", "Ð¡Ð´ÐµÐ»Ð°Ð¹ÑÐµ Ð¾Ð±ÑÐµÐ½Ð¸Ðµ ÑÑÑÐµ<br/>Ñ Ð½Ð¾Ð²ÑÐ¼Ð¸ ÑÐ¼Ð°Ð¹Ð»Ð¸ÐºÐ°Ð¼Ð¸"];
  var SmilesPromo = WA.extend(SmsPromo, {_onRender:function(ct) {
    this.el = ct.createChild({cls:"nwa-promo-smiles", style:"display:none;", children:[{cls:"nwa-promo-smiles-body", children:["<b>" + SmilesPromoTitle[this._textNum || 0] + "</b><br>" + SmilesPromoText[this._textNum || 0]]}, {cls:"nwa-promo-smiles-close"}]})
  }, _onClick:function(e) {
    var trg = e.getTarget(true);
    if(trg.getClass() == "") {
      trg = trg.parent()
    }
    if(trg.hasClass("nwa-promo-smiles-close")) {
      e.stopPropagation()
    }else {
      if(trg.hasClass("nwa-promo-smiles-body")) {
        U.Mnt.countRB([2565523, 2565525, 2565545][this._textNum], true);
        this.clickEvent.fire();
        e.stopPropagation()
      }
    }
    this.closeEvent.fire();
    this.hide()
  }, show:function() {
    this._textNum = WA.i ? WA.i % 3 : 0;
    SmilesPromo.superclass.show.call(this)
  }, _onShow:function() {
    U.Mnt.countRB([2565523, 2565525, 2565545][this._textNum])
  }});
  var StickerPromo = WA.extend(Object, {constructor:function() {
    this.clickEvent = new U.Event
  }, show:function() {
    var uniq = Math.floor(Math.random() * 1E4);
    var url = WA.imgPath + "images/" + (WA.isRetina ? "penguin@2x" : "penguin") + ".png";
    var notify = window.notifications.createNotification(url, "Ð¡ÑÐ¸ÐºÐµÑÑ!", "ÐÐµÐ»Ð¸ÑÑ ÑÐ¼Ð¾ÑÐ¸ÑÐ¼Ð¸ Ñ Ð´ÑÑÐ·ÑÑÐ¼Ð¸", uniq);
    notify.addEventListener("click", WA.createDelegate(function() {
      this.clickEvent.fire();
      notify.cancel();
      U.Mnt.countRB(10746127)
    }, this));
    notify.show(true, true);
    notify.el.addClass("nwa-promo-sticker");
    U.Mnt.countRB(10746123)
  }});
  var FriendsSuggest = WA.extend(SmsPromo, {_onRender:function(ct) {
    this.el = ct.createChild({cls:"nwa-fsg", style:"display:none;", children:[{cls:"nwa-fsg-ava", id:"nwaSugAva"}, {cls:"nwa-fsg-skin", children:[{cls:"nwa-fsg-next", title:WA.tr("search.next")}, {cls:"nwa-fsg-prev", title:WA.tr("search.previous")}, {cls:"nwa-fsg-profile", title:WA.tr("search.profile")}, {cls:"nwa-fsg-close", title:WA.tr("search.close")}, {cls:"nwa-fsg-add", title:WA.tr("search.add")}, {cls:"nwa-fsg-nofriends", title:WA.tr("search.notFamiliar")}, {cls:"nwa-fsg-info", children:[{cls:"nwa-fsg-nick", 
    id:"nwaSugNick"}, {cls:"nwa-fsg-relation", id:"nwaSugRelation"}]}]}]})
  }, _onAfterRender:function() {
    this._nickEl = WA.get("nwaSugNick");
    this._relationEl = WA.get("nwaSugRelation");
    this._avaEl = WA.get("nwaSugAva");
    this.el.on("click", this._onClick, this)
  }, _onClick:function(e) {
    var trg = e.getTarget(true);
    var action = trg.getClass().replace("nwa-fsg-", "");
    if({next:1, prev:1, profile:1, close:1, add:1, nofriends:1}[action]) {
      this.clickEvent.fire({type:action, mail:this._currentMail, nick:this._currentNick})
    }
  }, show:function(mail, nick, relation, length) {
    FriendsSuggest.superclass.show.call(this);
    this._currentMail = mail;
    this._currentNick = nick;
    this._avaEl.setStyle("background-image", "url(" + WA.makeAvatar(mail, nick, "_avatarsmall", this._avaEl) + ")");
    this._nickEl.update(U.String.htmlEntity(nick));
    this._relationEl.update(relation);
    this.el.toggleClass("nwa-fsg-single", !(length - 1))
  }, _onShow:function() {
  }, destroy:function() {
    SmsPromo.superclass.destroy.apply(this, arguments);
    this.clickEvent.removeAll();
    this.closeEvent.removeAll();
    this._destroyed = true;
    if(this._el) {
      this._el.remove()
    }
  }});
  var Abstraction = WA.extend(ConnectionRoster, {constructor:function() {
    Abstraction.superclass.constructor.apply(this, arguments);
    this.requestSuggestsEvent = new U.Event;
    this.suggestsShowEvent = new U.Event;
    this.smsPromoEvent = new U.Event;
    this.installAgentShowEvent = new U.Event;
    this.smilesPromoShowEvent = new U.Event;
    this.stickerPromoShowEvent = new U.Event;
    this._userData = null;
    this._cbQueue = []
  }, _onStartDelay:function() {
    S.modifyObject(["promo"], function(storage) {
      var now = WA.now();
      var promo = storage["promo"];
      var left;
      if(!promo.smsClosed) {
        left = 0;
        if(promo.smsDate) {
          left = 2 * WEEK - (now - promo.smsDate)
        }
      }
      if(!haveDesktopClient && !promo.installAgentShown) {
        var left2 = 0;
        if(promo.installAgentTs) {
          left2 = WEEK - (now - promo.installAgentTs)
        }
        if(left !== undefined) {
          left = Math.min(left, left2)
        }else {
          left = left2
        }
      }
      if(!promo.stickerTs && !WA.isProblemSafari && false) {
        this._timerSML = WA.setTimeout(function() {
          this._getUser(function() {
            if(now - WA.getFixedTS(this._userData.reg_date) > 2 * WEEK) {
              this._showStickerPromo()
            }
          }, this)
        }, 1E3, this)
      }
      if(left !== undefined && left < HOUR) {
        this._tmr = WA.setTimeout(function() {
          this._getUser(this._onUser)
        }, left * 1E3, this);
        return
      }
      if(!promo.suggestsTs) {
        left2 = 0
      }else {
        left2 = 2 * WEEK - (now - promo.suggestsTs)
      }
      if(left !== undefined) {
        left = Math.min(left, left2)
      }else {
        left = left2
      }
      if(left < 0) {
        left = 0
      }
      if(left < HOUR) {
        this._tmr = WA.setTimeout(function() {
          this._getUser(this._onUser)
        }, left * 1E3, this)
      }
    }, this)
  }, _getUser:function(cb, scope) {
    if(this._userData) {
      cb && cb.call(scope || this)
    }else {
      if(window.patron && patron.HelperTimestamp && patron.HelperStatus) {
        this._userData = {helper:{status:patron.HelperStatus, time:patron.HelperTimestamp}, reg_date:patron.RegTime};
        cb && cb.call(scope || this)
      }else {
        if(cb) {
          this._cbQueue.push([cb, scope])
        }
        if(SOCK.requestable) {
          SOCK.send("helper")
        }
      }
    }
  }, _onConnectionHelper:function(value) {
    var cb;
    if(value.mask && value.ts && value.reg_ts) {
      this._userData = {helper:{status:value.mask, time:value.ts.split(",")}, reg_date:value.reg_ts};
      while(this._cbQueue.length) {
        cb = this._cbQueue.shift();
        cb[0] && cb[0].call(cb[1] || this)
      }
    }
  }, _onUser:function() {
    var user = this._userData;
    S.modifyObject(["promo"], function(storage) {
      var now = WA.now();
      var promo = storage["promo"];
      var isSmsClosed = !!(user.helper.status & 1 << 18);
      var showTs = parseInt(user.helper.time[18] || 0);
      if(isSmsClosed) {
        if(!promo.smsClosed) {
          promo.smsClosed = 1
        }
      }else {
        if(showTs <= 1) {
          if(!promo.smsDate) {
            promo.smsDate = now - 2 * WEEK + FIRST_INTERVAL
          }
          var left = FIRST_INTERVAL - (now - user.reg_date)
        }else {
          left = 2 * WEEK - (now - showTs)
        }
      }
      if(left && left < 1) {
        left = 1
      }
      if(left !== undefined && left < HOUR) {
        this._tmr = WA.setTimeout(this._showSms, left * 1E3, this)
      }
      var sugLastTs = user.helper.time[24] || 0;
      if(sugLastTs <= 1) {
        sugLastTs = now - 4 * DAY - (now - user.reg_date);
        promo.suggestsTs = sugLastTs
      }
      left = WEEK - (now - sugLastTs);
      if(left < 0) {
        left = 0
      }
      if(left < HOUR) {
        this._tmr3 = WA.setTimeout(this._showSuggests, left * 1E3, this)
      }
    }, this)
  }, checkRegDateIdle:function() {
    this._getUser(function() {
      if(this._userData) {
        var daysPassed = (WA.now() - this._userData.reg_date) / 60 / 60 / 24;
        S.load(["promo.rbflags"], {success:function(storage) {
          var flags = parseInt(storage["promo.rbflags"]) || 0;
          if((flags & 4) > 0) {
            return
          }
          if(daysPassed >= 1 && daysPassed < 30 && (flags & 8) == 0) {
            flags = flags + 8;
            U.Mnt.countRB(1614538)
          }else {
            if(daysPassed >= 30 && (flags & 16) == 0) {
              flags = flags + 16;
              U.Mnt.countRB(1614540)
            }
          }
          S.save({"promo.rbflags":flags})
        }, scope:this})
      }
    }, this)
  }, setCLOpen:function() {
    S.load(["promo.rbflags"], {success:function(storage) {
      var flags = parseInt(storage["promo.rbflags"]) || 0;
      if((flags & 4) == 0) {
        flags = flags + 4;
        S.save({"promo.rbflags":flags})
      }
    }, scope:this})
  }, checkRegDate:function() {
    this._getUser(function() {
      if(this._userData) {
        var daysPassed = (WA.now() - this._userData.reg_date) / 60 / 60 / 24;
        S.load(["promo.rbflags"], {success:function(storage) {
          var flags = parseInt(storage["promo.rbflags"]) || 0;
          this.requestSuggestsEvent.fire(function(list) {
            var cnt = list.length;
            if(daysPassed < 1 && (flags & 1) == 0) {
              U.Mnt.countRB(cnt > 0 ? 1614517 : 1614518);
              flags = flags + 1
            }else {
              if(daysPassed >= 1 && daysPassed < 30 && (flags & 2) == 0) {
                U.Mnt.countRB(cnt > 0 ? 1614525 : 1614526);
                flags = flags + 2
              }
            }
            U.Mnt.countRB(cnt > 0 ? 1614533 : 1614536);
            S.save({"promo.rbflags":flags})
          }, this)
        }, scope:this})
      }
    }, this)
  }, _showSuggests:function() {
    WA.conn.UserState.getState(function(status) {
      if(status && status != "disabled" && status != "offline") {
        if(U.MailApi.lockNotify()) {
          this.requestSuggestsEvent.fire(function(list) {
            S.modifyObject(["suglist", "promo"], function(storage) {
              var sugList = storage["suglist"] || {};
              var newSugList = {};
              var haveNew = false;
              U.Array.each(list, function(contact) {
                if(!sugList[contact.email]) {
                  sugList[contact.email] = 1;
                  haveNew = true
                }
                newSugList[contact.email] = 1
              }, this);
              if(haveNew) {
                this.suggestsShowEvent.fire(list);
                storage["suglist"] = newSugList;
                U.Mnt.countRB(1202989);
                if(!storage.promo.suggestsShown) {
                  storage.promo.suggestsShown = 1
                }else {
                  U.Mnt.countRB(1203001)
                }
              }else {
                U.Mnt.countRB(1203E3)
              }
              U.MailApi.updateFlagTime(24);
              storage.promo || (storage.promo = {});
              storage.promo.suggestsTs = WA.now()
            }, this)
          }, this)
        }
      }
    }, this)
  }, _showInstallAgent:function() {
    WA.conn.UserState.getState(function(status) {
      if(status && status != "disabled") {
        if(U.MailApi.lockNotify()) {
          if(this.installAgentShowEvent.fire() !== false) {
            S.modifyObject(["promo"], function(storage) {
              storage.promo || (storage.promo = {});
              storage.promo.installAgentShown = 1;
              U.MailApi.updateFlagTime(19);
              U.Mnt.countRB(INSTALL_AGENT_RBCOUNTER)
            }, this)
          }
        }
      }
    }, this)
  }, _showSms:function() {
    WA.conn.UserState.getState(function(status) {
      if(status && status != "disabled") {
        if(U.MailApi.lockNotify()) {
          U.MailApi.updateFlagTime(18);
          this.smsPromoEvent.fire();
          S.modifyObject(["promo"], function(storage) {
            storage.promo || (storage.promo = {});
            storage.promo.smsDate = Math.round(+new Date / 1E3);
            U.Mnt.countRB(1100896);
            if(!storage.promo.alreadyShown) {
              storage.promo.alreadyShown = 1
            }else {
              U.Mnt.countRB(1160057)
            }
          }, this)
        }
      }
    }, this)
  }, smsClosed:function() {
    U.MailApi.setFlag(18);
    S.modifyObject(["promo"], function(storage) {
      storage.promo || (storage.promo = {});
      storage.promo.smsClosed = 1
    }, this);
    this.onPopupClose()
  }, _showSmiles:function() {
    WA.conn.UserState.getState(function(status) {
      if(status && status != "disabled") {
        if(U.MailApi.lockNotify()) {
          S.modifyObject(["promo"], function(storage) {
            storage.promo || (storage.promo = {});
            storage.promo.smilesTs = Math.round(+new Date / 1E3);
            this.smilesPromoShowEvent.fire()
          }, this)
        }
      }
    }, this)
  }, _showStickerPromo:function() {
    WA.conn.UserState.getState(function(status) {
      if(status && status != "disabled") {
        if(U.MailApi.lockNotify()) {
          S.modifyObject(["promo"], function(storage) {
            storage.promo || (storage.promo = {});
            storage.promo.stickerTs = Math.round(+new Date / 1E3);
            this.stickerPromoShowEvent.fire()
          }, this)
        }
      }
    }, this)
  }, destroy:function() {
    clearTimeout(this._tmr);
    clearTimeout(this._tmr2);
    clearTimeout(this._tmr3);
    if(this._timerSML) {
      clearTimeout(this._timerSML)
    }
    this.smsPromoEvent.removeAll();
    this.installAgentShowEvent.removeAll();
    Abstraction.superclass.destroy.call(this)
  }, onPopupClose:function() {
    U.MailApi.unlockNotify()
  }});
  WA.Promo = WA.extend(Object, {constructor:function() {
    this.smsPromo = new SmsPromo;
    this.friSug = new FriendsSuggest;
    this.friSug.clickEvent.on(this._onSugClick, this);
    this.agentPromo = new AgentPromo;
    this.smilesPromo = new SmilesPromo;
    this.stickerPromo = new StickerPromo;
    this._abstraction = new Abstraction;
    this.requestSuggestsEvent = (new U.Event).relay(this._abstraction.requestSuggestsEvent);
    this._abstraction.smsPromoEvent.on(this.smsPromo.show, this.smsPromo);
    this._abstraction.installAgentShowEvent.on(this._onInstallAgentShow, this);
    this._abstraction.suggestsShowEvent.on(this._showSuggests, this);
    this._abstraction.smilesPromoShowEvent.on(this.smilesPromo.show, this.smilesPromo);
    this._abstraction.stickerPromoShowEvent.on(this.stickerPromo.show, this.stickerPromo);
    this.smsPromo.closeEvent.on(this._abstraction.smsClosed, this._abstraction);
    this.smsClickEvent = new U.Event;
    this.smsPromo.clickEvent.on(this._onPromoClick, this);
    this.onBeforeInstallAgentEvent = new U.Event;
    this.showUserProfileEvent = new U.Event;
    this.friendSelectEvent = new U.Event;
    this.smilesClickEvent = new U.Event;
    this.stickerClickEvent = new U.Event;
    this.noFriendsEvent = new U.Event;
    this.agentPromo.closeEvent.on(this._abstraction.onPopupClose, this._abstraction);
    this.smilesPromo.closeEvent.on(this._abstraction.onPopupClose, this._abstraction);
    this.smilesPromo.clickEvent.on(this._onSmilesClick, this);
    this.stickerPromo.clickEvent.on(this._onStickerClick, this)
  }, checkYesterdayActivity:function() {
    S.modifyObject(["promo"], function(storage) {
      var promo = storage["promo"] || {};
      var now = new Date;
      var today = now.getDate() + "_" + (now.getMonth() + 1);
      if(promo.lastLoginDay && WA.isString(promo.lastLoginDay) && promo.lastLoginDay != today && promo.lastLoginActive != 1) {
        U.Mnt.countRB(2005903)
      }
      if(promo.lastLoginDay != today) {
        promo.lastLoginDay = today;
        promo.lastLoginActive = 0
      }
    }, this)
  }, updateUserActivity:function() {
    S.modifyObject(["promo"], function(storage) {
      var promo = storage["promo"] || {};
      var now = new Date;
      var today = now.getDate() + "_" + (now.getMonth() + 1);
      if(promo.lastLoginDay && promo.lastLoginDay == today && promo.lastLoginActive != 1) {
        promo.lastLoginActive = 1
      }
    }, this)
  }, updateUserReadMessage:function() {
    S.modifyObject(["promo"], function(storage) {
      var promo = storage["promo"] || {};
      var now = +new Date;
      this._checkOldIncomingMessage(promo.lastIncomingMessageTS, now);
      promo.lastIncomingMessageTS = 0
    }, this)
  }, newIncomingMessage:function() {
    S.modifyObject(["promo"], function(storage) {
      var promo = storage["promo"] || {};
      var now = +new Date;
      if(this._checkOldIncomingMessage(promo.lastIncomingMessageTS, now) === true || !(promo.lastIncomingMessageTS > 0)) {
        promo.lastIncomingMessageTS = now
      }
    }, this)
  }, checkLostMessage:function() {
    S.modifyObject(["promo"], function(storage) {
      var promo = storage["promo"] || {};
      var now = +new Date;
      if(this._checkOldIncomingMessage(promo.lastIncomingMessageTS, now) === true) {
        promo.lastIncomingMessageTS = 0
      }
    }, this)
  }, _checkOldIncomingMessage:function(msgTs, now) {
    if(msgTs > 0 && now - msgTs > 60 * 60 * 1E3) {
      U.Mnt.countRB(2005901);
      return true
    }
  }, _onInstallAgentShow:function() {
    if(this.onBeforeInstallAgentEvent.fire() !== false) {
      this.agentPromo.show()
    }else {
      return false
    }
  }, _showSuggests:function(list) {
    if(list) {
      this._sugList = list;
      this._sugIntex = 0;
      this._showSugIndex(this._sugIntex)
    }
  }, _onSmilesClick:function() {
    this.smilesClickEvent.fire()
  }, _onStickerClick:function() {
    this.stickerClickEvent.fire()
  }, _showSugIndex:function(index) {
    var contact = this._sugList[index];
    this.friSug.show(contact.email, contact.nick, contact.relation, this._sugList.length)
  }, _remSug:function(index) {
    typeof index == "undefined" && (index = this._sugIntex);
    this._sugList.splice(index, 1);
    if(this._sugList.length) {
      index > this._sugIntex || this._sugIntex--;
      this._onSugClick({type:"next"})
    }else {
      this._onSugClick({type:"close"})
    }
  }, _onSugClick:function(ev) {
    switch(ev.type) {
      case "next":
        if(this._sugList) {
          this._sugIntex++;
          if(!this._sugList[this._sugIntex]) {
            this._sugIntex = 0
          }
          this._showSugIndex(this._sugIntex)
        }
        U.Mnt.countRB(1202999);
        break;
      case "prev":
        if(this._sugList) {
          this._sugIntex--;
          if(this._sugIntex < 0) {
            this._sugIntex = this._sugList.length - 1
          }
          this._showSugIndex(this._sugIntex)
        }
        U.Mnt.countRB(1202997);
        break;
      case "close":
        this.friSug.hide();
        this._abstraction.onPopupClose();
        U.Mnt.countRB(1202990);
        break;
      case "profile":
        this.showUserProfileEvent.fire(ev.mail);
        U.Mnt.countRB(1202995);
        break;
      case "add":
        this._remSug();
        WA.MainAgent.sendAddContact(ev.mail, ev.nick, function(success) {
          if(success) {
            U.Mnt.countRB(2249803)
          }
        }, this);
        U.Mnt.countRB(1202991);
        break;
      case "nofriends":
        this._remSug();
        this.noFriendsEvent.fire(ev.mail);
        U.Mnt.countRB(1202992);
        break
    }
  }, _onPromoClick:function() {
    this.smsClickEvent.fire();
    S.save({"promo.click":"1"})
  }, checkCLStats:function() {
    if(this._statsChecked !== true) {
      this._statsChecked = true;
      this._abstraction.checkRegDate()
    }
  }, setCLOpen:function() {
    this._abstraction.setCLOpen()
  }, checkIdleStats:function() {
    if(this._idleStatsChecked !== true) {
      this._idleStatsChecked = true;
      WA.SessionStorage.load(["clist_list"], {success:function(data) {
        var list = data["clist_list"];
        if(!list) {
          this._abstraction.checkRegDateIdle()
        }
      }, scope:this})
    }
  }, render:function(ct) {
    this.smsPromo.render(ct);
    this.friSug.render(ct);
    this.agentPromo.render(ct);
    this.smilesPromo.render(ct);
    this.rendered = true
  }, deactivate:function() {
    this.friSug.hide()
  }, destroy:function() {
    this.smsClickEvent.removeAll();
    this.smsPromo.destroy();
    this.friSug.destroy();
    this.smilesPromo.destroy();
    this._abstraction.destroy();
    this.onBeforeInstallAgentEvent.removeAll();
    this.agentPromo.destroy()
  }})
})();
WebAgent.util.Mnt.wrapTryCatch(function() {
  var WA = WebAgent;
  var U = WA.util;
  var renderNotify = function() {
    window.notifications = new WA.Notifications;
    notifications.render(ma.boundEl)
  };
  U.Mnt.endPart("loading", "wajs");
  var ma = WA.ma = new WA.MainAgent(WA.isPopup);
  if(ma.rendered) {
    renderNotify()
  }else {
    ma.renderEvent.on(renderNotify)
  }
  WA.afterFirstExecEvent.fire()
});

