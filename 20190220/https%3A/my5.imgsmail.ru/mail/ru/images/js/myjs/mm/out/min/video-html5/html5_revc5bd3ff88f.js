define(["jquery","client-server","counters","base/view","util/helpers","util/css-manager","video-html5/log","video-html5/stat","video-html5/video-api-response","video-html5/quality-selector","video-html5/backscreen","video-html5/controls","video-html5/share","plugins/jQuery.XDomainRequest"],function(a,b,c,d,e,f,g,h,i,j,k,l,m){"use strict";var n=d.extend({props:{templates:{html5:"video-html5/tmpl/html5",error:"video-html5/tmpl/error"},deferred:{uaParser:"plugins/ua-parser",dashElement:"video-html5/wrapper/dash-element",videoElement:"video-html5/wrapper/video-element",adv:"video-html5/commerce/main"},elements:{wrapper:".b-video-html5",video:".b-video-html5__video"},defaultOptions:{allowCloseDelay:5,relatedLimit:16,advSlot:3474,locales:{errors:{mediaErrAborted:"Network problems. Please try again later.",mediaErrNetwork:"Network problems. Please try again later.",mediaErrDecode:"This video type is not supported.",mediaErrSrcNotSupported:"Playback error.",liteError:"Video is not exist or not available"},adv:{controls:{qualityList:{full_hd:"1080p",hd:"720p",md2:"480p",md1:"360p",sd:"240p"}}},controls:{qualityList:{full_hd:"1080p",hd:"720p",md2:"480p",md1:"360p",sd:"240p"}}}},vars:{stat:null,poster:""},accessors:{get:["poster","stat"],set:["poster","stat"]},CNT:{canPlay:1701805,canPlayExt:1864379,iframeShow:1846034,withPlayOrError:1767275,playClick:1815744,playClickExt:1846040,playNoError:1864391,channelStarted:6086848,videoError:13042926,videoErrorExt:1864382,channelError:6087008,backscreenShown:13042904,reconnect:25035541,fromMyMail:1845846,showAuth:23841635,playAuth:23841636,playClickFromMyMail:1846029,goInit:25568687,relatedOnPause:28361329,clickRelatedOnPause:28361336},cssClasses:{advSkip:"b-video-html5__skip",advTimer:"b-video-html5__adv-timer",cover:"b-video-html5__cover",insidePlayButton:"b-video-controls__inside-play-button show",preloader:"b-video-html5__preloader",playLayer:"b-video-html5__play-layer"},states:{INITED:1,ERROR:2,PLAYING:3,ENDED:4,PAUSED:5}},public:{init:function(){return this.options.external||(this.options.isLegal&&this.showError(this.options.videoErrors.needFlash,!1),this.options.flashVars={comscore:this.options.comscore,autoplay:"1"===this.options.flash.videoplayer.autoplay,movieSrc:this.options.externalId.slice(1),metadataUrl:this.options.signVideoUrl||this.options.metaUrl||this.options.externalId+".json?new=1",time:this.options.time,enable_reconnect:this.options.enableReconnect,dash_enabled:this.options.enableDash,dash_filter:this.options.dashFilter,dashRejectAgents:this.options.dashRejectAgents,trashClusters:this.options.trashClusters,trashClustersPreroll:this.options.trashClustersPreroll,reRequestOverlay:this.options.reRequestOverlay,showLastOverlay:this.options.showLastOverlay,customOverlayShowPolicy:this.options.customOverlayShowPolicy,customOverlayBannerSettings:this.options.customOverlayBannerSettings,externalAdvConfig:this.options.externalAdvConfig,mpegDashDebug:this.options.mpegDashDebug,webRTCCdn:this.options.webRTCCdn,overlayStartTime:this.options.overlayStartTime,overlayCheckBlack:this.options.overlayCheckBlack,trashPrerollSkipTime:this.options.trashPrerollSkipTime,videoUseCredentials:this.options.videoUseCredentials,pauseBackscreen:this.options.pauseBackscreen,dashBufferTime:this.options.dashBufferTime,noShareAuthors:this.options.noShareAuthors}),this.log=g.create({externalId:this.getParam("movieSrc"),external:this.options.external?1:0}),this.stat=h.create({externalId:this.getParam("movieSrc"),html:1,external:this.options.external,autoplay:!this.options.external||this.getParam("autoplay"),authorized:this.options.authorized}),this.backscreenUser=this.options.userBackScreen,this.backscreenAutoplay=this.options.backScreenAutoPlay,this.testRegion=this.options.testRegion,this.russianRegion=this.options.russianRegion,this.videoReadyState=!1,this.videoReadyHandlers=[],this.isFirstPlay=!0,this.reconnected=!1,this.options.external?this.loadData():f.require("media",!0).then(function(){this.loadData()}.bind(this)),this.state=this.states.INITED,n.__super__.init.call(this)},destroy:function(){return this.mediaElement&&this.mediaElement.destroy(),this.$video&&(this.$video.off(),this.getVideo()&&this.getVideo().pause(),this.$video.removeAttr("src"),this.$video.find("source").remove(),this.$video.remove(),delete this.$video),this.controls&&this.controls.destroy(),this.backscreen&&this.backscreen.destroy(),this.adv&&this.adv.destroy(),this._onWindowResizeHandler&&a(window).off("resize",this._onWindowResizeHandler),this.$clickContainer&&this.$clickContainer.off("click"),n.__super__.destroy.call(this)},getType:function(){return"html"},getWrapper:function(){return this.$wrapper},getVideo:function(){return this.$video.get(0)},getTime:function(){return this.$video&&this.$video.length?{currentTime:this.getVideo().currentTime,duration:this.getVideo().duration}:{}},pause:function(){this.$video&&this.$video.length&&(this.adv&&this.adv.isPlaying()?this.adv.pause():this.getVideo().pause())},play:function(){this.$video&&this.$video.length&&(this.adv&&this.adv.isPlaying()?this.adv.resume():this.getVideo().play())},pauseNextVideo:function(a){this.backscreen&&this.backscreen.pauseAutoplay(a)},setBackScreenAutoPlay:function(a){this.backscreenAutoplay=a,this.backscreen&&this.backscreen.switchAutoplay(a)},setUserBackScreen:function(a){this.backscreenUser=a},toggleMute:function(){this.getActiveControls().toggleMute()},volumeUp:function(){this.getActiveControls().volumeUp()},volumeDown:function(){this.getActiveControls().volumeLow()},seekForward:function(){this.adv&&this.adv.isPlaying()||this.controls.forward()},seekBackward:function(){this.adv&&this.adv.isPlaying()||this.controls.back()},seek:function(a){this.adv&&this.adv.isPlaying()||this.controls.seek(a)},setVolume:function(a){this.getActiveControls().setVolumePositionByPercent(a)}},protected:{loadData:function(){this.getVideoData(function(b,d){return this.apiResponse=a.extend(!0,{movie:{}},b),b.error?(this.showError(b.error),void a(document).trigger("VideoPlayer.error",[b.error])):(this.qualityList=d,this.relatedHost=b.relatedHost,this.backscreenCounter=b.backscreenCounter,this.extraSlots=b.extraSlots,this.backscreenTargetParent=b.targetParent,this.siteZone=b.sitezone,this.adSlot=b.adSlot,this.skipAd=b.skipAd,this.disableOverlay=b.skipOverlay,this.isPrivate=b.isPrivate,this.hasLink=2!==b.spAccess,this.duration=b.meta.duration,this.region=b.region,this.videoId=b.meta.id,this.accId=b.meta.accId,this.multiOverlay=this.options.external&&1===b.multiOverlay||!this.options.external&&2===b.multiOverlay||3===b.multiOverlay,this.admanUrl=b.admanUrl,b.partnerId&&(this.partnerId=b.partnerId),b.isChannel&&(this.isChannel=!0),this.cluster=b.cluster,this.setPoster(b.meta.poster),this.pageUrl=b.meta.url,this.authorEmail=b.author.email,this.videoStarted&&this.extraSlots&&this.extraSlots.forEach(function(a){c.myrb(a)}),this.setOption("region",this.region),this.stat.options.accid=this.accId,this.stat.options.providerId=b.provider,this.stat.options.itemId=b.meta.itemId,this.stat.options.videoId=b.meta.id,this.stat.send({name:"loaded"},!0),(document.location.href.indexOf("comscore=1")>0||"1"===this.getParam("comscore"))&&this.stat.comScoreInit(b),this.playVideo(this.getParam("autoplay")),void a(document).trigger("VideoPlayer.inited"))}.bind(this))},getAdvSlot:function(){var a;return this.isPartner()&&(a=this.getParam("rbAdvertismentSlotOverride")),this.getParam("slot")||a||this.adSlot||(this.options.external?this.options.advSlot:this.options.adv.slot)},getVideoData:function(c){return a.support.cors=!0,b.func("",{ext:this.options.external?1:0},{url:this.getJsonUrl(),crossDomain:!0,dataType:"json",xhrFields:{withCredentials:!0},success:function(a){e.isFunction(c)&&c(a,i.parse(a))}.bind(this),error:function(b,c,d){this.showError(this.options.external?this.options.locales.errors.liteError:this.options.videoErrors.liteLoadingError),a(document).trigger("VideoPlayer.error",["lite_loading"])}.bind(this),headers:null},!1,!1,!1,!0)},getVideoUrl:function(){return this.getParam("movieSrc")},getVideoLocation:function(){var a;if(this.options.external){var b=this.getParam("movieSrc").split("/");b.splice(2,0,"video"),a=b.join("/")}else a=this.options.videoLocation;return a},getJsonUrl:function(){var a;return a=this.getParam("metadataUrl")?this.getParam("metadataUrl"):this.getVideoUrl()+".json?new=1"},isPartner:function(){return!this.options.external||this.options.request.externalLocation.indexOf("mail.ru")!==-1&&this.options.flashVars.isPartner},getPartnerId:function(){var a,b,c=document.location.search.substring(1),d=c.split("&");for(a=0;a<d.length;a++)if(b=d[a].split("="),"partner"===b[0])return b[1];return""},getActiveControls:function(){return this.adv&&this.adv.isPlaying()?this.adv.getControls():this.controls},videoReady:function(a){this.videoReadyState?a(this.video):this.videoReadyHandlers.push(a)},setOption:function(a,b){this.options[a]=b},showError:function(b,c){this.state!==this.states.ERROR&&(this.$wrapper.length?(void 0===this.$errorPanel&&(this.$errorPanel=a("<div></div>").addClass("b-video-html5__error_panel").html("<p>"+b+"</p>").appendTo(this.$wrapper)),c&&this.createBackscreen(!0),this._onResize(null),this.$clickContainer&&this.$clickContainer.remove()):this.render("error",{message:b},function(a){a.appendTo(this.$el)}.bind(this)),this.stat.send({name:"error_text_shown"},!0),this.state=this.states.ERROR)},showPauseBackscreen:function(){var a=this.getParam("pauseBackscreen");("3"===a||"1"===a&&this.options.external||"2"===a&&!this.options.external)&&(this.createBackscreen(!0),c.myrb(this.CNT.relatedOnPause))},getParam:function(a){return this.options.flashVars[a]},getAdmanParams:function(){var b={duration:this.duration,content_id:this.accId,wide:a(this.video).width()>640?1:0,player_width:a(this.video).width(),player_height:a(this.video).height()},c={slot:this.getAdvSlot(),wrapper:"#"+this.video.id,browser:{mobile:e.os.isMobile(),adBlock:!1},params:b},d=j.getVideoQuality(this.qualityList,!this.isPartner());if(d)switch(d.name){case"sd":c.videoQuality=360;break;case"hd":c.videoQuality=720;break;default:c.videoQuality=480}return this.siteZone&&(c.params._SITEZONE=this.siteZone),this.cluster&&(c.params.mm_tagid=this.cluster.id),this.getParam("preview")&&this.options.external&&!this.isIframe()&&(c.params.preview=this.getParam("preview")),c},initAdman:function(){var b={$parentElement:this.getWrapper(),$videoElement:a(this.getVideo()),external:this.options.external,params:this.getAdmanParams(),stat:this.stat,locales:this.options.locales,multiOverlay:this.multiOverlay,autoplay:this.getParam("autoplay"),admanUrl:this.admanUrl,disableOverlay:this.disableOverlay,disablePreroll:this.skipAd,partnerId:this.getPartnerId(),reRequestOverlay:"1"===this.getParam("reRequestOverlay"),showLastOverlay:"1"===this.getParam("showLastOverlay"),cluster:this.cluster,customOverlayShowPolicy:this.getParam("customOverlayShowPolicy"),customOverlayBannerSettings:this.getParam("customOverlayBannerSettings"),trashOverlayClusters:this.getParam("trashClusters"),trashPrerollClusters:this.getParam("trashClustersPreroll"),mpegDashDebug:this.getParam("mpegDashDebug"),trashPrerollSkipTime:this.getParam("trashPrerollSkipTime"),overlayStartTime:this.getParam("overlayStartTime"),checkTitlesSince:this.getParam("overlayCheckBlack"),referrer:this.options.external?window.unescape(this.options.request.referrer):this.options.referrer,isCorp:this.getVideoUrl().indexOf("corp")!==-1,externalAdvConfig:this.getParam("externalAdvConfig"),authorized:this.options.authorized===!0||"true"===this.options.authorized,onPauseOverlayFail:this.showPauseBackscreen.bind(this),noShareAuthors:this.getParam("noShareAuthors")};this.require("adv",function(c){this.adv=c.createRunTime(b,a(this.getVideo())),this.startVideo()}.bind(this))},isNeedAdv:function(){var a=this.getParam("rbAdvertismentSlotOverride")&&this.isPartner()||this.adSlot,b=!this.getParam("isAdvertismentsSwitchOffForced")||!this.isPartner(),c=!e.os.isIphone(),d=0!==this.getVideoUrl().indexOf("corp")||a,f=/\S+@\w+\.\w+/,g=f.test(document.location.href)||f.test(decodeURIComponent(document.location.href));return b&&c&&d&&("1"===this.options.allowEmailInUrl||!g)},isIframe:function(){try{return window.self!==window.top}catch(a){return!0}},onScreenClick:function(a){a.stopPropagation(),this.$clickContainer.off("click"),this.$clickContainer.remove(),this.getVideo().play(),e.os.isMobile()&&!e.os.isIphone()&&this.adv.resume()},onVideoReady:function(a){this.video=a,this.isNeedAdv()?this.initAdman():this.startVideo(),this.stat.send({name:"inited"},!0)},startVideo:function(){m.init({externalId:this.getVideoUrl(),videoLocation:this.getVideoLocation()}),e.os.isMobile()&&(this.$clickContainer=a("<div></div>").addClass(this.cssClasses.playLayer).css({"z-index":100500}).appendTo(this.$el).on("click",this.onScreenClick.bind(this))),this.isDashEnabled()&&this.isDashSupported()?this.require("dashElement",function(a){this.initElement(a)}.bind(this)):this.require("videoElement",function(a){this.initElement(a)}.bind(this))},initElement:function(a){this.isDestroyed||(this.mediaElement=new a,this.mediaElement.init({$video:this.$video,qualityList:this.qualityList,external:this.options.external&&!this.isPartner(),stat:this.stat,useWebRTC:this.isWebRTCCdn(),debug:"1"===this.getParam("mpegDashDebug"),onReady:this.createControls.bind(this),dashBufferTime:parseInt(this.getParam("dashBufferTime")||30,10)}))},createControls:function(){this.controls=l.createRunTime(e.extend(!0,{},this.options.videoControls,{mediaElement:this.mediaElement,qualityList:this.qualityList,external:!this.isPartner()&&this.hasLink,likeEnable:!1,hideLogo:location.search&&location.search.indexOf("hidelogo")!==-1,externalId:this.getVideoUrl(),videoId:this.videoId,videoLocation:this.getVideoLocation(),videoSwfurl:"http://my1.imgsmail.ru/r/video2/uvpv3.swf",cssVideoRetinaVersion:this.options.cssVideoRetinaVersion,locales:this.options.locales.controls,contentId:this.accId,stat:this.stat,showViral:!this.isPrivate&&this.hasLink&&this.isAuthorWithShare(),trackWaiting:this.russianRegion,time:this.getParam("time"),prerollShown:this.prerollStarted,referer:this.options.external?window.unescape(this.options.request.referrer):this.options.referrer,region:this.region,duration:this.duration,fullscreenElement:this.$el.get(0),authorized:this.options.authorized,fromBackscreenAutoplay:this.options.fromBackscreenAutoplay,user:this.options.authorized?this.options.activeEmail:this.options.mrcuCookie,cluster:this.cluster,poster:this.poster,pageUrl:this.pageUrl,partnerId:this.getPartnerId(),yandexRuleHosts:this.getParam("yandexRuleHosts")}),a(this.getWrapper()))},playVideo:function(a){void 0===a&&(a=!0),!this.videoStarted&&this.extraSlots&&this.extraSlots.forEach(function(a){c.myrb(a)}),this.videoStarted=!0,a=a&&!e.os.isMobile(),this.setOption("autoPlay",a),this.insertVideo(),c.myrb(this.CNT.withPlayOrError),this.options.external?(c.myrb(this.CNT.iframeShow),"go"===this.getPartnerId()&&c.myrb(this.CNT.goInit)):(c.myrb(this.CNT.fromMyMail),this.options.authorized&&c.myrb(this.CNT.showAuth)),this.stat.sendTNS("show")},insertVideo:function(){this.render("html5",{poster:this.poster,isAutoPlay:this.getParam("autoplay"),useCredentials:"1"===this.getParam("videoUseCredentials")},function(b){if(!this.isDestroyed){if(b.appendTo(this.$el),this.updateElements(),!this.options.external){var c=this.$el.attr("id")+"_video";this.$video.attr("id",c).addClass(this.cssClasses.video).css({width:"100%",height:"100%"})}this.video=this.$video.get(0),this.$video.on("canplay",this.onVideoCanPlay.bind(this)),this.$video.on("play",this.onVideoPlay.bind(this)),this.$video.on("pause",this.onVideoPause.bind(this)),this.$video.on("video.click",this.onVideoClick.bind(this)),this.$video.on("ended",this.onVideoEnded.bind(this)),this.$video.on("error",this.onVideoError.bind(this)),this.$video.on("dash.error",this.onDashError.bind(this)),this._onWindowResizeHandler=this._onResize.bind(this),a(window).on("resize",this._onWindowResizeHandler),this.$el.on("relatedEmpty",function(a){this._relatedEmpty=!0,this.state===this.states.ENDED?this.controls.showPlayButton("replay"):this.controls.showPlayButton()}.bind(this)),this.videoReadyState=!0,this.videoReadyHandlers.forEach(function(a){a(this.video)}.bind(this)),this.videoReady(this.onVideoReady.bind(this))}}.bind(this))},onDashError:function(a){var b=this.getParam("autoplay");this.video.currentTime>0?(this.onVideoError(a),this.getVideo().pause()):(this.mediaElement&&(b=b||this.mediaElement.started,this.mediaElement.destroy()),this.controls&&this.controls.destroy(),this.require("videoElement",function(a){setTimeout(function(){this.initElement(a),b&&this.mediaElement.play()}.bind(this),100)}.bind(this)))},onVideoError:function(b){if(b.target.src&&b.target.error||"dash"===b.type){var d,f,g,h,i,j="",k=0,l=this.options.videoErrors||this.options.locales.errors,m=l.mediaErrAborted;if("dash"===b.type)h=5,i=this.mediaElement.currentSrc;else{if(a.ajax({url:this.video.src+"&error="+(b.target.error&&b.target.error.code),type:"post"}),this.canReconnect())return this.mediaElement.setQuality(0),this.reconnected=!0,void c.myrb(this.CNT.reconnect);h=Number(b.target.error.code),i=this.video.src}this.require("uaParser",function(){var b=a.ua;switch(h){case 1:f="aborted",m=l.mediaErrAborted;break;case 2:f="network",m=l.mediaErrNetwork,k=3e3;break;case 3:f="decode",m=l.mediaErrDecode;break;case 4:f="not_supported",j="err_by_type_"+f+".",e.os.isMobile()&&(j+="mob."),g=j,j+=188===this.options.region||70===this.options.region?"rus.":76===this.options.region?"tur.":"world.",j+=i.match(/cdn\d+/)[0],g+=this.options.region,m=l.mediaErrSrcNotSupported;break;case 5:f="dash_error",m=l.mediaErrSrcNotSupported}d=["html5VideoError",f,b.os.name,b.os.version,b.device.vendor,b.device.model,b.browser.name,b.browser.version,this.options.region,i].map(function(a){return encodeURIComponent(a).replace(/\./g,"_")}),c.myrb(this.CNT.videoErrorExt),c.myrb(this.CNT.videoError),this.isChannel&&c.myrb(this.CNT.channelError),c.mygrst(d.join(".")),this.log.send(f),this.stat.sendToGraphite("error_"+(e.os.isMobile()?"mob_":"")+f),this.video.currentTime>0&&this.stat.sendToGraphite("error_post_start_"+(e.os.isMobile()?"mob_":"")+f),188!==this.options.region&&70!==this.options.region||this.stat.sendToGraphite("error_rus_"+(e.os.isMobile()?"mob_":"")+f),j.length&&this.stat.sendToGraphite(j),g&&this.stat.sendToGraphite(g),k>0?setTimeout(function(){this.showError(m,!0)}.bind(this),k):this.showError(m,!0)}.bind(this)),a(document).trigger("VideoPlayer.error",["playback"])}},canReconnect:function(){return!this.reconnected&&"1"===this.getParam("enable_reconnect")&&!e.os.isIpad()&&!e.os.isIphone()},isDashEnabled:function(){var a="1"===this.getParam("dash_enabled")&&this.options.external||"2"===this.getParam("dash_enabled")&&!this.options.external||"3"===this.getParam("dash_enabled"),b=this.getParam("dash_filter"),c=this.getParam("dashRejectAgents")||"",d=0;if(!this.checkOriginArray())return!1;for(c=c.split(","),d;d<c.length;d++)if(window.navigator.userAgent.indexOf(c[d])!==-1)return!1;return!!this.apiResponse.dash||(a&&b&&(b=b.replace(/(['"])?([a-z0-9A-Z_]+)(['"])?:/g,'"$2": '),b=JSON.parse(b),b&&b.duration>this.duration&&(a=!1)),a)},isWebRTCCdn:function(){var a=this.getParam("webRTCCdn"),b=this.qualityList[0].src,c=!1;return"all"===a||(a=a&&a.split(","),b=b&&b.match(/cdn\d+/)[0],a&&b&&a.indexOf(b)!==-1&&(c=!0),c)},checkOriginArray:function(){var a;return[1,2].reduce(function(b,c){a=!0}),a},isDashSupported:function(){var a=window.hasOwnProperty("WebKitMediaSource"),b=window.hasOwnProperty("MediaSource");return a||b},isAuthorWithShare:function(){var a=this.getParam("noShareAuthors");return!a||a.split(",").indexOf(this.authorEmail)===-1},onVideoCanPlay:function(a){c.myrb(this.CNT.canPlay),this.options.external&&c.myrb(this.CNT.canPlayExt)},onVideoPlay:function(b){this.isFirstPlay&&(c.myrb(this.CNT.playClick),this.isChannel&&c.myrb(this.CNT.channelStarted),this.options.external?(c.myrb(this.CNT.playClickExt),c.myrb(this.CNT.playNoError)):(c.myrb(this.CNT.playClickFromMyMail),this.options.authorized&&c.myrb(this.CNT.playAuth)),a(document).trigger("VideoPlayer.start",[this.getVideo()]),this.isFirstPlay=!1,this.$video.removeAttr("poster")),this.$errorPanel&&(this.$errorPanel.remove(),this.$errorPanel=void 0),a(document).trigger("VideoPlayer.play",[this.getVideo()]),this.state=this.states.PLAYING},onVideoPause:function(b){a(document).trigger("VideoPlayer.pause",[this.getVideo()]),this.state!==this.states.ENDED&&this.state!==this.states.ERROR&&(this.state=this.states.PAUSED)},onVideoEnded:function(b){e.os.isIphone()||this.createBackscreen(),a(document).trigger("VideoPlayer.end",[this.getVideo()]),this.state=this.states.ENDED},onVideoClick:function(a){a.stopPropagation(),this.$el.trigger("video.click")},_onResize:function(a){e.isjQueryObject(this.$errorPanel)&&setTimeout(function(){this.$el.parent().height()<300&&this.$errorPanel.hasClass("half")||this._relatedEmpty?this.$errorPanel.removeClass("half"):this.$el.parent().height()>=300&&!this.$errorPanel.hasClass("half")&&this.$errorPanel.addClass("half")}.bind(this),a?400:1)},createBackscreen:function(b){this.backscreen&&this.backscreen.destroy(),this.backscreen=k.create(a(this.getWrapper()),a.extend(!0,{locales:this.options.external?this.options.locales.controls:this.options.videoControls.locales},this.options.backscreen,{videoElement:a(this.video),external:this.options.external,inside:this.isPartner(),videoUrl:this.getVideoUrl(),videoId:this.videoId,relatedHost:this.relatedHost,canAdd:this.options.canAdd&&!this.options.external,isOwner:this.options.videoIsOwner,autoplay:this.backscreenAutoplay&&!this.backscreenUser,limit:this.options.relatedLimit,disabled:"1"===this.getParam("isRelatedDisabled")&&this.isPartner(),backscreenCounter:this.backscreenCounter,videoSwfurl:"http://my1.imgsmail.ru/r/video2/uvpv3.swf",externalId:this.getVideoUrl(),videoLocation:this.getVideoLocation(),stat:this.stat,showViral:!this.isPrivate&&this.hasLink&&this.isAuthorWithShare(),errorMode:b,poster:this.poster,pageUrl:this.pageUrl,onRelatedItemClick:function(b){if(this.controls.exitFullscreen(),this.options.external)if(this.backscreenTargetParent)location.href="//my.mail.ru/video/embed/"+b.id+"?backscreen=&autoplay=1&currentReferrer="+this.options.request.externalLocation;else{window.open("http://r.mail.ru/clb670603/my.mail.ru"+b.url+"/?from=videoplayer&currentReferrer="+this.options.request.externalLocation,"_blank");var d=this.options.request.referrer.match(/http(|s):\/\/([\w\W]*?)(?:(\/|\?|#))/);c.dwh({version:1,category:{"mm-player":{action:4,videoItem:this.getVideoUrl(),region:this.region,ad:!!this.prerollStarted,authorized:!1,user:"",referer:d?d[2]:this.options.request.referrer,duration:this.duration,platform:a.browser.platform,cdn:""}}})}else a(document.body).trigger("VideoPlayer.relatedClicked",[b.url,this.getVideo()]);this.video.paused&&!this.video.ended&&c.myrb(this.CNT.clickRelatedOnPause),c.myrb(this.CNT.goInit)}.bind(this)})),c.myrb(this.CNT.backscreenShown)},initApi:function(){}}});return n});