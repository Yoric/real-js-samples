define(["jquery","factory","audio-player","util/find-event-target","util/helpers","util/css-manager","util/promise","client-server","counters","util/num-end","product-tools/complaints"],function(a,b,c,d,e,f,g,h,i,j,k){function l(a,b){var c,d,e,f=a.find("."+z),g=0,h=0,i=0,k=0;return h=Number(a.eq(0).find('[data-tagtype="comment"]').size()),g=Number(a.eq(0).find("."+x).size()),h-=g,c=a.closest("."+A).siblings("."+E).find("."+B+'[data-type="comments-focus"]'),0===c.length&&(c=a.parent().find(".b-comments__video_total-count"),d=!0),e=c.find('[data-type="counter"]'),f.length>0?(i=Number(f.data("commentsCount")),0===i&&(i=Number(e.html()))):i=h,k=i+b,h+=b,f.data("commentsCount",k),0===k?(e.hide(),d&&e.parent().hide()):(e.show().html(k),d&&e.parent().show()),h>0&&f.length>0&&void 0===f.data("commentsPrev")&&j.ending(f,k),h}function m(a,b){b.addClass(s)}function n(b,c){var d;return d=a('[data-tagtype="list"][data-dataid="'+c+'"]')}var o,p="b-comments__",q=p+"answer-active",r=p+"textfield-load",s=p+"textfield-error",t=p+"add-border",u=p+"content-load",v=p+"comment-load",w=p+"content-loadcomments",x=p+"item-selected",y=p+"item-extended",z=p+"count",A=p+"history",B=A+"-button",C=A+"_no-comments",D=p+"settings-open",E="event_links",F="comment:Controller",G="comment:Settings",H=function(){var b="data-comment-",c=["event","type","juser","listlimit","addcln","opts","from","ERRMSG","show","banner","reverse","total"],d=["id","answer","answername","answeremail","listafter","listbefore","parent","dataid"];return function(e,f){var g={},h=e.attr("data-dataid"),i=f.find("#comment-"+h);return 0===i.length&&(i=a(".b-sticky-post").find("#comment-"+h)),c.forEach(function(a){g[a]=i.attr(b+a)}),d.forEach(function(a){g[a]=e.attr(b+a)}),g.dataid=h,["history_owner","history_guest","audio_playlist"].indexOf(g.from)!==-1?g.audioFragment="history":g.audioFragment=g.from,g}}(),I={setUp:function(b,c){var e,f;return this.container=b,this.writers={},this.container.on("focus",'[data-type="focus"]',function(a){var b=d(a,'[data-type="focus"]');this.action_focus(H(b,this.container),b,a,c)}.bind(this)),e=this.container.find('[data-type="focus"]'),e.each(function(b,c){var d=a(c).find(".b-comments-writer__textarea");return d.is(":focus")&&this.action_focus(H(a(c),this.container),a(c)),d.length&&(f=g.resolve()),b}.bind(this)),f||g.reject()},onBrowserEvent:function(a){var b,c,e,f,g,h,i,j=!1;return"click"===a.type&&(b=d(a,"[data-type]"),b&&b.length&&(e=b.attr("type"),f=b.attr("data-type"),e!==F&&e!==G||(h=(e===G?"settings_":"")+"action_"+f,g=this[h],g&&(c="complaint"===f?k.parseElement(b):H(b,this.container),this.request=g.call(this,c,b,a),"focus"===f&&(i=b.closest(".b-history-event").find('[data-type="focus"]'),0===i.length&&(i=b.closest(".m-layer").find('[data-type="focus"]')),i.focus()),j=!0)))),j},onCommentAdd:function(a){e.isFunction(a)&&(this.onCommentAdd=a)},onCommentRemove:function(a){e.isFunction(a)&&(this.onCommentRemove=a)},onCommentsFetched:function(a){e.isFunction(a)&&(this.onCommentsFetched=a)},onCommentsInput:function(a){e.isFunction(a)&&(this.onCommentsInput=a)},onWriterInitialized:function(a){e.isFunction(a)&&(this.onWriterInitialized=a)},onShowParent:function(a){e.isFunction(a)&&(this.onShowParent=a)},countComments:function(b,c){var d=a("#comment-"+b.dataid),f=e.incrementCounter(d.attr("data-comment-total"),c);return d.attr("data-comment-total",f),b.total=f,b},destroyWriter:function(a){this.writers&&(this.writers[a]&&this.writers[a].destroy(),delete this.writers[a])},destroyWriters:function(){this.writers&&Object.keys(this.writers).forEach(function(a){this.writers[a].destroy(),delete this.writers[a]}.bind(this))},getWriter:function(a){return this.writers&&this.writers[a]},action_focus:function(c,d,f,g){var h=d.data("dataid"),j=this;e.isFunction(f)&&(g=f,f=null),f&&(f.preventDefault(),f.stopPropagation()),this.writers[h]?e.isObject(this.writers[h])&&e.isFunction(g)&&g():(this.writers[h]=!0,b("comments/writer",function(f){this.writers[h]=f.create(this.options).onLoad(d.find(".b-comments-writer-wrapper")),this.writers[h].on("add",function(d,e){var f=n(this,e.listId);switch(f.parent().hasClass(C)&&f.parent().show().removeClass(C),l(f,1),c.from){case"music-layer":case"video-layer":f.prepend(e.result);break;default:f.append(e.result)}b("audio-player",function(a){a.createPlaylist({id:"comment-"+e.id,from:"comment-"+e.id,element:f.find('[data-comment-id="'+e.id+'"]'),fragment:c.audioFragment}).createTracks()}),c.show&&"0"!==c.show||!c.banner||this.container.find("#"+c.banner).remove(),"photo-layer"===c.from&&a("#b-photo-content-container").scrollTo("100%",0),i.mygrst("monitoring.comments.add.added"),i.myrb(c.addcln),j.onCommentAdd(j.countComments(c,1))}),this.onCommentsInput&&this.writers[h].on("input",this.onCommentsInput),this.onWriterInitialized&&this.writers[h].on("initialized",this.onWriterInitialized),e.isFunction(g)&&g()}.bind(this)))},action_add:function(b,c){var d=this,e=c.parent(),f=e.find("textarea"),g=f.val(),j=this.container;if(this.isAddCommentThrottled===!1)return this.isAddCommentThrottled=!0,setTimeout(function(){this.isAddCommentThrottled=!1}.bind(this),1e3),!g||g.length>500||/^\s*$/.test(g)||e.hasClass(r)?null:(e.addClass(r),i.mygrst("monitoring.comments.add.adding"),h.func("comments.add",function(a,c){return{text:g,type:b.type,item:b.event,from:b.from,juser:b.juser,register:f.attr("data-comment-answer"),opts:b.opts,captcha_id:a,captcha_answer:c}},{url:"/cgi-bin/my/ajax?user="+b.juser,type:"POST",success:function(c){var g=n(d,b.dataid);c=a.parseJSON(c);var h=c[2];"ok"===h?(f.val("").height("").blur(),e.attr("class",t),g.parent().hasClass(C)&&g.parent().show().removeClass(C),l(g,1),"video-layer"!==b.from?g.append(c[3].data):g.prepend(c[3].data),b.show&&"0"!==b.show||!b.banner||j.find("#"+b.banner).remove(),"photo-layer"===b.from&&a("#b-photo-content-container").scrollTo("100%",0),i.mygrst("monitoring.comments.add.added")):"ratelimit"===h?(m(d,e),i.mygrst("monitoring.comments.add.ratelimit")):(m(d,e),i.mygrst("monitoring.comments.add.error")),i.myrb(b.addcln)},error:function(){i.myrb(721694),i.mygrst("monitoring.comments.xhrerror"),m(d,e)},complete:function(){e.find("textarea").attr("data-comment-answer",""),e.find('[data-type="add"]').attr("data-comment-answer",""),e.removeClass(q),e.removeClass(r),delete d.request}}))},action_load:function(b,d,e){var f=this,g=d.parent();return g.addClass(w),i.mygrst("monitoring.comments.load.loading"),h.func("comments.get",{type:b.type,item:b.event,from:b.from,limit:b.listlimit,opts:b.opts,before:b.listbefore,after:b.listafter,reverse:b.reverse},{url:"/cgi-bin/my/ajax?user="+b.juser,type:"POST",success:function(d){if(d=a.parseJSON(d),"ok"===d[2]&&d[3]){var e,h=a('<div class="'+p+'content-fromajax" />').html(d[4]);d[3].before?(e=g.find("[data-comment-listafter]"),"video-layer"!==b.from?h.insertBefore(e):h.insertAfter(e),e.remove()):d[3].after&&(e=g.find("[data-comment-listbefore]"),h.insertAfter(e),e.remove()),h.find(".jp__playlist").each(function(d,e){var f=a(e).closest(".b-comments__item"),g=f.length&&f.data("commentId");c.createPlaylist({from:"comment-"+g,element:e,fragment:b.audioFragment}).createTracks()});var j=n(f,b.dataid);j.find("."+z).addClass("loaded"),i.mygrst("monitoring.comments.load.loaded"),f.onCommentsFetched()}else i.mygrst("monitoring.comments.load.error")},error:function(a){i.myrb(721694),i.mygrst("monitoring.comments.load.xhrerror"),g.removeClass(w)},complete:function(){g.removeClass(w),delete f.request}})},action_extend:function(c,d,e){var f=this,g=d.parents('[data-comment-id="'+c.id+'"]'),i=g.find('[data-tagtype="commentText"]');return g.addClass(u),h.func("comments.expand_media",[c.type,c.event,c.id],{url:"/cgi-bin/my/ajax?user="+c.juser,type:"POST",success:function(c){c=a.parseJSON(c),b("comments/item",function(a){var b=new a;b.setContent(JSON.parse(c[3])),b.renderText(function(a){i.html(a)}),g.removeClass(u).addClass(y)})},complete:function(){delete f.request}})},settings_action_delete:function(b,d,e){e.stopPropagation();var f,g=this,i=n(g,b.dataid),j=a('[data-comment-id="'+b.id+'"]'),k=i.find("."+z);return h.func("comments.delete",{type:b.type,item:b.event,from:b.from,juser:b.juser,id:b.id},{url:"/cgi-bin/my/ajax?user="+b.juser,type:"POST",beforeSend:function(){this.fadeCommentTimeout=window.setTimeout(function(){j.addClass(v),window.clearTimeout(this.fadeCommentTimeout)},500)},success:function(){var d,e=c.getCurrentPlaylist();e&&(d=e.from,d!==-1&&d==="comment-"+b.id&&a(document).trigger("AudioPlayer.stop",{fragment:e.fragment})),f=l(i,-1),1===f&&k.length>0?(b.listafter=k.data("commentListafter"),b.listbefore=k.data("commentListbefore"),g.action_load(b,k)):0===f&&("history_owner"!==b.from&&"history_guest"!==b.from||i.parent().hide(),i.parent().addClass(C)),j.remove(),o&&o.hide(),g.onCommentRemove(g.countComments(b,-1))},complete:function(){delete g.request}})},settings_action_complaint:function(b,c){c.addClass("progress"),c.attr("type",""),a.when(k.add(b)).then(function(){c.removeClass("progress").addClass("done"),o&&(o.position(),setTimeout(function(){o.hide()},2e3))}).fail(function(a,b){c.removeClass("progress").addClass("error"),o&&o.position()})},settings_action_unsubscribe:function(b,c){var d=c.data("authorId"),e=c.data("groupId");return h.func("history.admin_unsubscribe_group",{user:d,group:e},{beforeSend:function(){},complete:function(){},error:function(){},success:function(b){b=a.parseJSON(b),"ok"===b[2]?c.parent().addClass("success"):c.parent().addClass("error"),o&&(o.position(),setTimeout(function(){o.hide()},2e3))}})},action_setanswer:function(b,c,d){var e,f,g,h=this.container.find('label[data-dataid="'+b.dataid+'"]');f=function(a,b){a.setAnswer({id:b.id,user:b.answername.replace(/>/g,"&gt;").replace(/</g,"&lt;")}),h.focus(),g&&a.off("initialized")},0===h.length&&(h=a(".b-sticky-post").find('label[data-dataid="'+b.dataid+'"]')),h.length>0&&this.action_focus(b,h,d,function(){e=this.writers[b.dataid],e.isRendered()?f(e,b):(g=f.bind(this,e,b),e.on("initialized",null,g))}.bind(this))},action_unsetanswer:function(a,b){var c=b.parents("label");c.find("textarea").attr("data-comment-answer",""),c.find('[data-type="add"]').attr("data-comment-answer",""),c.removeClass(q)},action_like:function(c,d){b("comments/like",function(b){var d=a(".b-comments__item-actions-like").filter(function(){return a(this).attr("data-comment-id")===c.id.toLowerCase()||a(this).attr("data-comment-id")===c.id.toUpperCase()});this.like=b.create().onLoad(d.parent())}.bind(this))},action_auth:function(){b("product-tools/auth-form",function(a){a.show()})},action_showparent:function(b,c){var d,e=this,f=n(e,b.dataid),g=a(c.parents('[data-tagtype="comment"]')[0]);return f.addClass(u),c.attr("type",""),d=h.func("comments.select",{type:b.type,item:b.event,from:b.from,limit:1,opts:b.opts,id:b.parent},{url:"/cgi-bin/my/ajax?user="+b.juser,type:"POST",success:function(c){c=a.parseJSON(c);var d=a("<div />",{class:x});"ok"===c[2]&&c[3]&&g&&g.length?d.html(c[3].data):d.html(a('<div class="'+x+'-error">'+b.ERRMSG+"</div>")),d.insertAfter(g),e.onShowParent()},error:function(a){i.myrb(721694)},complete:function(){f.removeClass(u),delete e.request}})},action_showsettings:function(c,d,e){e.preventDefault(),e.stopPropagation(),b("ui/bubble2",function(b){o||(o=b.create({style:"nmenu",addClass:"comments-bubble",position:{my:"right top",at:"right bottom",offset:"-8 3"},onOpen:function(){a("body").addClass(D),o.getOpener().closest(".b-photo").size()&&o.element.addClass("from-layer")},onClose:function(){a("body").hasClass(D)&&a("body").removeClass(D),o.element.removeClass("from-layer")}}),this.bubbleContent=a(o.element[0].children[0]),this.bubbleContent.on("click",a.proxy(this.onBrowserEvent,this))),o.setContent(d.next('[data-type-comment="settings-menu"]').html()),o.setOpener(d),o.toggle()}.bind(this)),this.writers[c.dataid]&&this.writers[c.dataid].hideBubbles()},action_showCommentLikers:function(a,c){b("likes/likers-popup",function(a){a.create().onLoad(c.closest(".b-comments__item-actions-like__wrapper"))}.bind(this))},reset:function(){this.request&&this.request.abort(),this.timerId&&(clearTimeout(this.timerId),delete this.timerId),this.fadeCommentTimeout&&(clearTimeout(this.fadeCommentTimeout),delete this.fadeCommentTimeout)},destroy:function(){this.reset(),this.container&&(this.container.off(),delete this.container),this.destroyWriters()}};return{create:function(a){var b=Object.create(I);return b.options={},a&&e.extend(b.options,a),f.require("sprites.smiles.smiles"),b}}});