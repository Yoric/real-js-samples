var FanclubPurchaseFlow=function(){"use strict";var e=this;e.defaultSettings={showSuccessModal:!1,showFailureModal:!1,dynamicallyTargetButton:!0,dismissUrl:""},e.init=function(a){e.params=e.getExtendedObject(e.defaultSettings,a),e.initModals(),e.add_listeners()},e.getExtendedObject=function(e,a){var t={};return Object.keys(e).forEach(function(a){t[a]=e[a]}),Object.keys(a).forEach(function(e){t[e]=a[e]}),t},e.initModals=function(){e.purchaseFlowModal=new MG_Modal({closeButton:!1,closeDocument:!1,content:document.querySelector(".fanclub_purchase_flow_modals_container"),className:"fanclubPurchaseFlowModal"})},e.add_listeners=function(){if(e.params.dynamicallyTargetButton)MG_Utils.addEventHandler(document,"click",function(a){if(a.target){var t=a.target.parentNode,l=t?t.parentNode:null;MG_Utils.hasClass(a.target,"js_becomeFan")?e.triggerPurchaseModal(a.target.getAttribute("data-model_id")):t&&MG_Utils.hasClass(t,"js_becomeFan")?e.triggerPurchaseModal(t.getAttribute("data-model_id")):l&&MG_Utils.hasClass(l,"js_becomeFan")&&e.triggerPurchaseModal(l.getAttribute("data-model_id"))}});else{var a=document.querySelectorAll(".js_becomeFan");[].forEach.call(a,function(a){MG_Utils.addEventHandler(a,"click",function(t){e.triggerPurchaseModal(a.getAttribute("data-model_id"))})})}if(e.params.triggerPurchaseFlow&&e.params.isModelPage&&e.params.modelId&&e.triggerPurchaseModal(e.params.modelId),e.params.showSuccessModal){e.purchaseFlowModal.openModal();var t=document.querySelector(".contentMTubes .fanclub_purchase_flow_modals");MG_Utils.addClass(t.querySelector(".pf_success_modal"),"active_modal"),MG_Utils.addClass(t,"redirect_on_close"),e.addModalCloseListeners(t)}if(e.params.showFailureModal){e.purchaseFlowModal.openModal();var t=document.querySelector(".contentMTubes .fanclub_purchase_flow_modals"),l=t.querySelector(".pf_failure_modal");MG_Utils.addClass(l,"active_modal"),MG_Utils.addClass(t,"redirect_on_close"),e.addModalCloseListeners(t),MG_Utils.addEventHandler(l.querySelector(".js_change_cc"),"click",function(a){var t=a.target.getAttribute("data-model_id");MG_Utils.ajaxCall({type:"POST",data:{modelId:t},url:e.params.changeCCAjax,success:function(e){"PASS"==e.success&&(window.location.href=e.redirectUrl)}})})}},e.addNewEventHandlers=function(a,t){e.addLastDigitEventListeners(a),MG_Utils.addEventHandler(a.querySelector(".js_purchase_modal_submit"),"click",function(l){"true"==l.target.getAttribute("data-loginSignup")?(e.openSelectedModal(".login_signup_modal",a),purchaseFlow_LoginSignup.addListeners(a,t.showSignupCaptcha)):window.location.href=l.target.getAttribute("data-redirectUrl")}),MG_Utils.addEventHandler(a.querySelector(".js_report_other_perks"),"click",function(a){MG_Utils.hasClass(a.target,"disabled")||e.reportOtherPerks(a.target)});var l=a.querySelectorAll(".js_change_cc");[].forEach.call(l,function(a){MG_Utils.addEventHandler(a,"click",function(a){var t=a.target.getAttribute("data-model_id");MG_Utils.ajaxCall({type:"POST",data:{modelId:t},url:e.params.changeCCAjax,success:function(e){"PASS"==e.success&&(window.location.href=e.redirectUrl)}})})}),MG_Utils.addEventHandler(a.querySelector(".js_alreadyFanTip"),"click",function(a){e.purchaseFlowModal.closeModal(function(){window.location=a.target.getAttribute("data-url"),e.params.isModelPage&&!e.params.dismissUrl&&window.location.reload(!0)})}),e.addModalCloseListeners(a),e.addLeaveModalListeners(a)},e.addLastDigitEventListeners=function(a){var t=a.querySelectorAll(".lastFour");[].forEach.call(t,function(t){["keyup","input","keypress"].forEach(function(l){MG_Utils.addEventHandler(t,l,function(t){"input"==l&&t.target.value.length>=1&&(t.target.value=t.target.value.slice(0,1),MG_Utils.hasClass(t.target,"lastFourEnd")||t.target.nextElementSibling.focus());var r=a.querySelector("."+e.getCurrentOpenedModal(a)),s="";[].forEach.call(r.querySelectorAll(".lastFour"),function(e){s+=e.value}),"input"==l&&4==s.length&&MG_Utils.removeClass(r.querySelector(".js_last_digits_submit"),"disabled"),"keyup"!=l||"13"!=t.keyCode||MG_Utils.hasClass(r.querySelector(".js_last_digits_submit"),"disabled")||e.handleLastDigitsAjax(r,s)})})});var l=a.querySelectorAll(".js_last_digits_submit");[].forEach.call(l,function(a){MG_Utils.addEventHandler(a,"click",function(t){if(!MG_Utils.hasClass(a,"disabled")){var l=t.target.parentElement,r="";l.querySelectorAll(".lastFour").forEach(function(e){r+=e.value}),e.handleLastDigitsAjax(l,r)}})})},e.triggerPurchaseModal=function(a){e.purchaseFlowModal.openModal(),MG_Utils.addClass(document.querySelector(".modalMTubes.fanclubPurchaseFlowModal"),"loadingModal"),MG_Utils.ajaxCall({type:"POST",data:{modelId:a},url:e.params.initiatePurchaseFlowAjax,success:function(t){if(MG_Utils.removeClass(document.querySelector(".modalMTubes.fanclubPurchaseFlowModal"),"loadingModal"),"PASS"==t.success){var l=document.querySelector(".contentMTubes .fanclub_purchase_flow_modals");MG_Utils.addClass(l.querySelector(".fanclub_purchase_modal"),"active_modal"),e.populatePurchaseModal(t,l),e.replaceModelInfo(t,l,a),e.addNewEventHandlers(l,t),e.initScroll(l.querySelectorAll(".fanclub_purchase_top_content"),"100%","250px")}else if(void 0!==t.fanclubInactive&&t.fanclubInactive){var l=document.querySelector(".contentMTubes .fanclub_purchase_flow_modals");MG_Utils.addClass(l.querySelector(".inactive_fanclub_modal"),"active_modal"),l.innerHTML=l.innerHTML.replace(/%%MODEL_NAME%%/g,'<span class="modelName">'+t.username+"</span>"),e.addModalCloseListeners(l)}}})},e.populatePurchaseModal=function(e,a){e.perks&&e.perks.forEach(function(e){var t=a.querySelector(".perks_template .perk_container").cloneNode(!0);t.querySelector(".perk_content").innerText=e,a.querySelector(".fanclub_purchase_perks_list").appendChild(t)}),e.otherPerks&&(e.otherPerks.forEach(function(e){var t=a.querySelector(".perks_template .perk_container").cloneNode(!0);t.querySelector(".perk_content").innerText=e,a.querySelector(".fanclub_purchase_other_perks_list").appendChild(t)}),MG_Utils.addClass(a.querySelector(".fanclub_purchase_other_perks"),"active"),MG_Utils.addClass(a.querySelector(".fanclub_purchase_top_content"),"two_perks_list")),e.showLast4?MG_Utils.addClass(a.querySelector(".fanclub_purchase_bottom"),"purchase_modal_2"):MG_Utils.addClass(a.querySelector(".fanclub_purchase_bottom"),"purchase_modal_1"),e.loginSignup&&a.querySelector(".js_purchase_modal_submit").setAttribute("data-loginSignup",!0),void 0!==e.redirectUrl&&a.querySelector(".js_purchase_modal_submit").setAttribute("data-redirectUrl",e.redirectUrl),void 0!==e.paidVideoOptOutMessage&&e.paidVideoOptOutMessage&&(a.querySelector(".fanclub_purchase_optout").innerHTML=e.paidVideoOptOutMessage)},e.replaceModelInfo=function(e,a,t){var l=e.modelInfo.modelName,r=e.modelInfo.priceFrequency;a.innerHTML=a.innerHTML.replace(/FANCLUB_PRICE/g,r),a.innerHTML=a.innerHTML.replace(/MODEL_ID/g,t);var s=new RegExp(l,"g");a.innerHTML=a.innerHTML.replace(s,'<span class="modelName">'+l+"</span>"),a.innerHTML=a.innerHTML.replace(/%%MODEL_NAME%%/g,'<span class="modelName">'+l+"</span>")},e.reportOtherPerks=function(a){var t=a.getAttribute("data-model_id");MG_Utils.ajaxCall({type:"POST",data:{modelId:t},url:e.params.reportOtherPerksAjax,success:function(t){"PASS"==t.success?(a.innerHTML=e.params.reportOtherPerksThankYouTxt,MG_Utils.addClass(a,"notClickable"),MG_Utils.addClass(a,"disabled")):"FAIL"==t.success&&(a.innerHTML=t.message,MG_Utils.addClass(a,"notClickable"),MG_Utils.addClass(a,"disabled"),MG_Utils.addClass(a,"error"))}})},e.openSelectedModal=function(e,a){MG_Utils.removeClassMultiple(a.querySelectorAll(".fanclub_submodal"),"active_modal"),MG_Utils.addClass(a.querySelector(e),"active_modal")},e.handleLastDigitsAjax=function(a,t){MG_Utils.removeClass(a.querySelector(".last_digits_error"),"active"),a.querySelector(".last_digits_error").innerHTML="";var l={last4:t,modelId:a.querySelector(".js_last_digits_submit").getAttribute("data-model_id")};e.params.premiumUserInfo&&(l.a=e.params.premiumUserInfo),MG_Utils.ajaxCall({type:"POST",data:l,url:e.params.lastDigitsAjax,success:function(e){"FAIL"==e.success?(MG_Utils.addClass(a.querySelector(".last_digits_error"),"active"),a.querySelector(".last_digits_error").innerHTML=e.message):window.location.href=e.redirectUrl}})},e.addModalCloseListeners=function(a){if(MG_Utils.hasClass(a,"fanclub_purchase_flow_modals")){var t=function(t){var l="leave_confirmation_modal"==e.getCurrentOpenedModal(a)&&"close_button"==t;if(MG_Utils.hasClass(a,"leave_confirmation")){if("leave_confirmation_modal"!=e.getCurrentOpenedModal(a))e.openSelectedModal(".leave_confirmation_modal",a);else if(l){var r=a.querySelector(".leave_confirmation_modal .leave_confirmation_buttons").getAttribute("data-previousModal");e.openSelectedModal("."+r,a)}}else e.purchaseFlowModal.closeModal(),MG_Utils.hasClass(a,"reload_on_close")?e.params.dismissUrl?window.location.href=e.params.dismissUrl:window.location.reload(!0):MG_Utils.hasClass(a,"redirect_on_close")&&e.params.redirectWithoutParamsUrl&&(window.location.href=e.params.redirectWithoutParamsUrl)},l=function(e){"modalWrapMTubes"===(e.target&&e.target.id||e.srcElement&&e.srcElement.id)&&t("outer_close")};MG_Utils.addEventHandler(document.querySelector("#modalWrapMTubes"),"click",l),[].forEach.call(a.querySelectorAll(".js_close_modal"),function(e){MG_Utils.addEventHandler(e,"click",function(){t("close_button")})})}},e.addLeaveModalListeners=function(a){MG_Utils.addEventHandler(a.querySelector(".js_cancel_leave_modal"),"click",function(t){var l=t.target.parentElement.getAttribute("data-previousModal");e.openSelectedModal("."+l,a)}),MG_Utils.addEventHandler(a.querySelector(".js_confirm_leave_modal"),"click",function(a){var t=a.target.parentElement.getAttribute("data-previousModal");e.purchaseFlowModal.closeModal(),"last_digits_modal"==t&&(e.params.dismissUrl?window.location.href=e.params.dismissUrl:window.location.reload(!0))})},e.getCurrentOpenedModal=function(e){return e.querySelector(".active_modal").getAttribute("data-modal")},e.initScroll=function(e,a,t){MG_Scroll.init({selector:e,width:a,height:t,color:"#F39000",railColor:"#2e2e2e",railOpacity:"1",opacity:"1",wrapperClass:"scrollContentWrapper"})}};try{var fanclubPurchaseFlow=new FanclubPurchaseFlow;fanclubPurchaseFlow.init("undefined"!=typeof fanclubPurchaseFlowParams?fanclubPurchaseFlowParams:{})}catch(e){console.log("ERROR === Fanclub Purchase Flow ==="),console.log(e)}