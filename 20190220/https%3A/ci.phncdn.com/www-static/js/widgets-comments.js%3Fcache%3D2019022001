function textCount(){var e=stripCombiningMarks($j(this).text()),t=e.length;t>500?($j(this).text(e.substr(0,500)).caret(-1),t=500):($j(this).text().match(regexLineBreakCombiningMarks)||$j(this).text().match(regexSymbolWithCombiningMarks))&&$j(this).text(e).caret(-1)}function validateFrom(e,t,a){e.find(t).fadeToggle(),window.setTimeout(function(){e.find(t).fadeToggle(),a.removeAttr("disabled")},3e3)}function rating(e,t,a,n){$j.post(e,function(e){e&&LocalStorageManager.getInstance().push("commentsRated",e),commentFix(n,a,1)})}function reply(e,t,a){var n=$j(t);$j(".replyBlock").find("button.reply").show().siblings().remove(),n.append('<div class="enterCommentBlock inComments clearfix"><form class="clearfix commentsForm commentReplyForm replyPlaceholder" action="'+e+'" method="post"><div class="textAreaWrap clearfix"><div class="tail"></div><textarea class="commentTextArea comment js_tagTextarea" name="comment" cols="40" rows="3" maxlength="500">'+WIDGET_COMMENTS.commentPlaceholderText+'</textarea></div><div class="actions"><button class="cmtSubmit commentBtn float-right" type="submit"><span>Comment</span></button></div></form></div><div class="feedbackMessages"><p class="error_1 error display-none">'+WIDGET_COMMENTS.error_1+'</p><p class="error_2 error display-none">'+WIDGET_COMMENTS.error_2+'</p><p class="error_3 error display-none">'+WIDGET_COMMENTS.error_3+"</p></div>"),n.find(".enterCommentBlock").prepend($j("#userAvatar").html()),n.find("button.reply").hide(),n.show().removeClass("rightMargin float-left"),prepareTagging(),n.find(".js_taggable").text("").trigger("focus")}function commentDelete(e,t){var a=$j(t),n=a.closest("#cmtWrapper"),o=t.replace(/[^0-9]/g,"");ajaxPost(e,t),a.hide(),$j(".childrenOf"+o).hide(),n.find($j(".childrenOf"+o)).hide(),n.find($j(".showMoreChildren"+o)).hide();var r=document.getElementById("tooltip");null!==r&&MG_Utils.addClass(r,"hidden")}function commentSpam(e,t){var a=$j(t),n=a.closest("#cmtWrapper"),o=t.replace(/[^0-9]/g,"");$j.ajax({type:"POST",url:e,success:function(e){e&&LocalStorageManager.getInstance().push("commentsReported",e)}}),a.hide(),$j(".childrenOf"+o).hide(),n.find($j(".childrenOf"+o)).hide(),n.find($j(".showMoreChildren"+o)).hide()}function commentFix(e,t,a){parseInt(t)?$j(".thumbsUpVote"+e).hasClass("already-voted")||($j(".thumbsUpVote"+e).addClass("already-voted"),a&&$j(".thumbsUpVote"+e).html(parseInt(parseInt($j(".thumbsUpVote"+e).html())+1)),$j(".thumbsDown"+e).hide()):$j(".thumbsDownVote"+e).hasClass("already-voted")||($j(".thumbsDownVote"+e).addClass("already-voted"),a&&$j(".thumbsDownVote"+e).html(parseInt(parseInt($j(".thumbsDownVote"+e).html())+1)),$j(".thumbsUp"+e).hide()),$j(".thumbsUp"+e).attr("disabled",!0),$j(".thumbsDown"+e).attr("disabled",!0),$j("#tooltip").hide()}function commentsRatedUpdate(){var e=LocalStorageManager.getInstance(),t=$j.parseJSON(e.get("commentsRated"));if(!t)return-1;$j.map(t,function(e,t){var a=e.split("|");$j(".thumbsUpVote"+t)&&$j(".thumbsDownVote"+t)&&(parseInt($j(".thumbs"+(parseInt(a[0])?"Up":"Down")+"Vote"+t).html())==parseInt(a[1])?commentFix(t,a[0],1):commentFix(t,a[0],0))})}function commentsReportedUpdate(){var e=LocalStorageManager.getInstance(),t=$j.parseJSON(e.get("commentsReported"));if(!t)return-1;$j.map(t,function(e,t){var a=t.split("_");$j(".commentTag"+a[1]).remove(),$j(".showMoreChildren"+a[1]).remove(),$j(".childrenOf"+a[1]).remove()})}function placeHolderLoad(){window.setTimeout(function(){$j(".js_taggable").text($j(".js_tagTextarea").val()).addClass("placeHolderText")},250)}function appendInterlanLinks(){$j(".commentMessage").each(function(e,t){var a=$j(this).contents().get(0),n=addInternalLinks(a.nodeValue);$j(this).contents().first().replaceWith(escapeHtml(n))})}function renderLinksInComment(){$j(".commentUsernameLink:not(.processed)").each(function(e,t){var a=$j(this);a.data("href")?a.addClass("processed").html('<a href="'+a.data("href")+'" target="_blank" rel="noopener noreferrer">@'+a.data("username")+"</a>"):a.addClass("processed").html("<span>@"+a.data("username")+"</span>")}),$j(".js_taggable").length>0&&(friendList=[])}head.ready(document,function(){var e=$j("body");$j("#cmtWrapper");appendInterlanLinks(),e.on("keyup",".js_taggable",textCount),e.on("click",'.commentsForm button[type="submit"]',function(e){e.preventDefault();var t=$j("#commentClone").html(),a=$j(this).closest(".closestComment"),n=$j(this).closest(".enterCommentBlock"),o=$j(this).closest(".enterCommentBlock").next(),r=$j(this).closest(".replyBlock"),s=$j(this),l=$j(this).parents("form"),i=$j(".js_taggable");s.attr("disabled",!0),i.length>0&&pushCommentData(s),$j.ajax({type:"POST",url:l.attr("action"),dataType:"json",data:l.serialize(),success:function(e){if("PASS"==e.status){var l=t;l=l.replace(/\[\[id\]\]/g,e.id),l=l.replace(/\[\[commentMessage\]\]/,addInternalLinks(e.comment)),l=l.replace(/\[\[dateAdd\]\]/,"1 second ago"),l=l.replace(/\[\[urlDelete\]\]/g,e.deleteLink),l=l.replace(/\[\[urlReply\]\]/g,e.reply),l=l.replace(/\[\[urlSpam\]\]/g,e.spam),l=l.replace(/\[\[urlVoteDown\]\]/g,e.voteDown),l=l.replace(/\[\[urlVoteUp\]\]/g,e.voteUp),l=l.replace(/\[\[dataType\]\]/g,e.type),n.hasClass("mainComment")?$j(".js-cmtInject").after(l):a.after(l),a.find(".js_taggable").addClass("placeHolderText").text(WIDGET_COMMENTS.commentPlaceholderText),a.find(".js_tagTextarea").val(WIDGET_COMMENTS.commentPlaceholderText),s.removeAttr("disabled"),""==e.reply&&($j(".commentTag"+e.id+" .replyBlock").remove(),$j(".commentTag"+e.id).addClass("nestedBlock")),e.parentId>0&&$j(".commentTag"+e.id).addClass("childrenOf"+e.parentId),r.find(".enterCommentBlock").remove(),r.find(".reply").removeAttr("style"),renderLinksInComment()}else"SPAM"==e.status?validateFrom(o,".error_1",s):"DISABLED"==e.status?validateFrom(o,".error_3",s):"FAIL"!=e.status&&"EMPTY"!=e.status||validateFrom(o,".error_2",s)}})});var t;e.on("focus",".js_taggable",function(){window.clearTimeout(t);var e=$j(this);e.closest("form").find('button[type="submit"]').show(),e.addClass("activeEdit"),e.text()==WIDGET_COMMENTS.commentPlaceholderText&&e.text("").removeClass("placeHolderText")}).on("blur",".js_taggable",function(e){t=window.setTimeout(function(){var t=$j(e.target);t.closest("form").find('button[type="submit"]').hide(),t.removeClass("activeEdit"),""==t.text()&&t.text(WIDGET_COMMENTS.commentPlaceholderText).addClass("placeHolderText")},250)}),e.on("focus","textarea.commentTextArea",function(){$j('.commentsForm button[type="submit"]').removeAttr("disabled")}),e.on("blur",".js_taggable",function(){var e=$j(this);e.html(e.html().replace(/<(\bbr\b)>|<(\bp\b)>/gi,"\n")),e.text(e.text().replace(/[\<\>|\[\]|\{\}]/gi,""))}),e.on("click","button.hideElements",function(){var e=$j(this);e.closest(".hiddenParentComments").hide(),$j("#"+e.data("element")).show()}),e.on("click","button.loadMore",function(){var e=$j(this);$j("#"+e.data("element")+e.data("comment-key")).removeClass("display-none"),e.hide()}),e.on("mouseleave",".cmtDropDown",function(){$j(this).find("ul").hide()}),e.on("click","#js-cmtTriggerMenu",function(){$j(this).next("ul").toggle()}),e.on("click",".js-cmtFilter",function(){var e=$j("#js-cmtTriggerMenu"),t=$j(".js-commentReplacement"),a=$j(this);a.closest("ul").hide(),e.find("span").text(a.find("span").text()),t.toggleClass("active"),$j.ajax({type:"POST",dataType:"html",data:{isSortCommentsAjax:1},url:a.data("sort"),beforeSend:function(){t.addClass("loadingStatus").empty()},success:function(e){t.removeClass("loadingStatus").html(e)},complete:function(){commentsRatedUpdate(),commentsReportedUpdate(),"function"==typeof prepareTagging&&prepareTagging(),placeHolderLoad(),renderLinksInComment(),t.hasClass("active")?$j("#js-cmtTriggerMenu").find("span").html(WIDGET_COMMENTS.recentCommentsText):$j("#js-cmtTriggerMenu").find("span").html(WIDGET_COMMENTS.popularCommentsText);var e=document.querySelectorAll("#cmtWrapper .avatarTrigger");[].forEach.call(e,function(e){e.setAttribute("src",e.getAttribute("data-src"))}),appendInterlanLinks()},error:function(){location.reload()}})}),placeHolderLoad(),commentsRatedUpdate(),commentsReportedUpdate()}),MG_Utils.domReady(function(){if(document.querySelector(".js-saleVideoLogMessage")){var e=document.querySelector(".js-saleVideoLogMessage").querySelector("span");MG_Utils.addEventHandler(e,"click",function(){WIDGET_COMMENTS.loggedOut?signinbox.show(WIDGET_COMMENTS.purchaseModalTitle):purchaseModals.openPurchaseModal()})}var t=document.querySelectorAll("[data-purchase-modal='purchase']");t&&[].forEach.call(t,function(e){e.removeAttribute("disabled"),MG_Utils.addEventHandler(e,"click",function(){purchaseModals.openPurchaseModal()})}),$j(".commentBtn.thumbs").each(function(){$j(this).click(function(e){rating($j(this).data("ratingurl"),$j(this).data("elem"),$j(this).data("value"),$j(this).data("id"))})})});