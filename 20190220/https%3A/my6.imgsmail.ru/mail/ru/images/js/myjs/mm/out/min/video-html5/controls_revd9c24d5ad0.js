define(["jquery","counters","base/view","util/helpers","video-html5/storage","video-html5/viral-panel","video-html5/log","video-html5/context-menu","external/cookie"],function(a,b,c,d,e,f,g,h,i){"use strict";var j=c.extend({props:{defaultOptions:{insidePlayButtonTimeout:300,controlsHideTime:3e3,volumeItemsCount:11,volumeItemWidth:1,volumeItemMarginRight:4,volumeButtonWidth:4,progressBarColor:"#276BAD",qualityList:[],videoPageUrl:"https://my.mail.ru/",apiUrl:"https://my.mail.ru/video/embed/",advMode:!1,retinaSprite:location.protocol+"//my10.imgsmail.ru/mail/ru/css/new/retina_icons_player.css",cssVideoRetinaVersion:"0",volumePanelHideTimeout:200},cssClasses:{main:"b-video-controls",wrapper:"b-video-controls-wrapper",videoElement:"b-video-controls__video",playButton:"b-video-controls__play-button",pause:"pause",nowPlay:"now-play",advMode:"adv-mode",moveProgress:"move-progress",timeLeft:"b-video-controls__time-left",timeRight:"b-video-controls__time-right",insidePlayButton:"b-video-controls__inside-play-button",insidePlayButtonRun:"run",insidePlayButtonDynamic:"dynamic",insidePlayButtonBackscreen:"backscreen",progressBarWrapper:"b-video-controls__progressbar-wrapper",progressBar:"b-video-controls__progressbar",progressPlay:"b-video-controls__progressbar__play",progressLoad:"b-video-controls__progressbar__load",progressButton:"b-video-controls__progressbar__button",volumeButton:"b-video-controls__volume-button",volumeButtonMute:"mute",volumeProgressBar:"b-video-controls__volume-progressbar",volumeProgressItem:"b-video-controls__volume-progressbar__item",volumeProgressItemFilled:"filled",volumeProgressButton:"b-video-controls__volume-progressbar__button",qualityButton:"b-video-controls__quality-button",qualityList:"b-video-controls__quality-list",qualityListTitle:"b-video-controls__quality-list__title",qualityItem:"b-video-controls__quality-item",qualityItemSelected:"selected",fullScreenButton:"b-video-controls__fullscreen-button",linkToMyMail:"b-video-controls__mymail-link",notSupport:"b-video-controls__not-support",preloader:"b-video-html5__preloader",bubbleLink:"b-video-html5__bubble-link",bubbleLinkClose:"b-video-html5__bubble-link__close",videoArea:"b-video-html5__video-area",play:"icon-player-video_play",pauseIcon:"icon-player-video_stop",smallRepeat:"icon-player-video_repeat_small",volume:"icon-player-video_sound",mute:"icon-player-video_mute",settings:"icon-player-video_settings",fullscreen:"icon-player-video_fullscreen",smallscreen:"icon-player-video_smallscreen",logo:"icon-player-video_logo_mm",centerPlay:"icon-player-video_center_play",centerRepeat:"icon-player-video_replay_big"},CNT:{progressBarClick:2207094,volumeChange:2207111,fullScreenOn:2207131,myMailClick:2207165,qualityClick:2207173,quality240:2207179,quality360:2207185,quality720:2207198,quality1080:2207205,pauseExternalClick:7279677,pauseClick:7279629,playExternalClick:7489358,playInternalClick:7489350,screenClick:7489371,screenClickExternal:7489382,rightClick:7485810,rightClickExternal:7489111,channel80:6086988,played80:466835,started:466834,startLoading:13042921,played80html:13042808,played80htmlExt:23668370,played80htmlInt:23668377,played80Auth:23841746,startedHtml:13042897,startFromBackscreenAutoplay:18908354,played80FromBackscreenAutoplay:18908370,startLoadingExt:22679558,startLoadingInt:22679559,startLoadingAuth:23841731,goPlayed80:25568770,goStarted:25568750,dashStarted:25786769,dash80:25786787,firstByteMobile:3650535,firstByteAndroid:3650443,firstByteIphone:3650316,firstByteIpad:3650318,preogress80Mobile:3650617,preogress80Android:3650457,preogress80Iphone:3650451,preogress80Ipad:3650453},elements:{},events:{"click .b-video-html5__video-area":"_onVideoClick","dblclick .b-video-html5__video-area":"_onVideoDoubleClick","mousedown .b-video-html5__video-area":"_onVideoMouseDown","click .b-video-controls__fullscreen-button":"_onFullScreenButtonClick",mousemove:"_onParentMouseMove",touchmove:"_onParentMouseMove",keydown:"_onParentKeyDown",mouseleave:"_onParentMouseLeave","mouseenter .b-video-controls":"_onMouseEnter","mousemove .b-video-controls":"_onMouseMove","click .b-video-controls__play-button":"_onPlayButtonClick"}},public:{init:function(){return this.mediaElement=this.options.mediaElement,this.$videoElement=this.mediaElement.$video,this.stat=this.options.stat,!this.options.advMode&&this.options.showViral&&(this.viralPanel=f.create(this.$el,this.options)),this.options.advMode||(this._initVideo(),this.options.showViral&&this._initContextMenu()),d.os.isIphone()?(this.$videoElement.attr({controls:""}),this.$videoElement.on("timeupdate",this._onVideoTimeUpdate.bind(this))):(this._loadSprite(),this._createDomElements(),this._bindEvents(),this._restoreVolume()),this._oldTime=0,this._watchedTime=0,this.mediaElement.isPaused()===!1&&this._onVideoPlay(),this.updateView(),this.fullScreenElement=this.options.fullscreenElement||this.$el.get(0),this.log=g.create({externalId:this.options.externalId,external:this.options.external}),j.__super__.init.call(this)},destroy:function(){d.os.isIphone()||(this._unbindEvents(),this.$container.remove()),this.$videoElement&&this.$videoElement.off(),this.$insidePlayButton&&this.$insidePlayButton.remove(),this.viralPanel&&this.viralPanel.destroy(),this.copyLinkBubble&&this.copyLinkBubble.destroy(),d.isjQueryObject(this.$preloader)&&(this.$preloader.remove(),delete this.$preloader),this.$el.removeClass(this.cssClasses.wrapper)},togglePlay:function(){this.mediaElement.isPaused()===!1?(this._playNow=!1,this.mediaElement.pause(),this.options.external?b.myrb(this.CNT.pauseExternalClick):b.myrb(this.CNT.pauseClick),this.lastAction="pause"):(this._playNow=!0,this.mediaElement.play(),this.options.external?b.myrb(this.CNT.playExternalClick):b.myrb(this.CNT.playInternalClick),this.lastAction="play")},setPositionByPercent:function(a){if(!this.mediaElement.isSeeking()){var b=(a*(this.mediaElement.getDuration()/100)).toFixed(1);this.mediaElement.seek(b),this.stat.send({name:"click.seek"},!0),this.lastAction="seek_"+b,this.ended&&this.mediaElement.play()}},_onQualityChanged:function(a,b,c){this.$qualityItems&&this.$qualityItems.removeClass(this.cssClasses.qualityItemSelected).filter('[data-quality-type="'+b+'"]').addClass(this.cssClasses.qualityItemSelected),this.lastAction="change_quality",this.stat.send({name:"click.quality",value:c},!0)},_onVideoCanPlay:function(){this.togglePreload(!1)},setVolumePositionByPercent:function(a){this.setVolume(a/100)},setVolume:function(a){this.mediaElement.setVolume(a),this._onVideoVolumeChange()},setBackscreen:function(a){this.backscreen=a},showVolumePanel:function(){this.$volumeProgressBar.addClass("volume-show"),clearTimeout(this._volumePanelHideTimer)},hideVolumePanel:function(){this._volumePanelHideTimer=setTimeout(function(){this._moveVolume?this._hideVolumePanel=!0:(this.$volumeProgressBar.removeClass("volume-show"),this._hideVolumePanel=!1)}.bind(this),this.options.volumePanelHideTimeout)},back:function(){var a=this.mediaElement.getCurrentTime()-this.mediaElement.getDuration()/100;this.lastAction="seek_"+a,this.mediaElement.seek(a),this.stat.send({name:"click.seek"},!0)},forward:function(){var a=this.mediaElement.getCurrentTime()+this.mediaElement.getDuration()/100;this.lastAction="seek_"+a,this.mediaElement.seek(a),this.stat.send({name:"click.seek"},!0),this.ended&&this.mediaElement.play()},seek:function(a){var b=Math.min(this.mediaElement.getDuration(),a);this.lastAction="seek_"+b,this.mediaElement.seek(b),this.stat.send({name:"click.seek"},!0),this.ended&&this.mediaElement.play()},volumeUp:function(){this.mediaElement.getVolume()+.1<=1&&this.setVolume(this.mediaElement.getVolume()+.1)},volumeLow:function(){this.mediaElement.getVolume()-.1>=0&&this.setVolume(this.mediaElement.getVolume()-.1)},toggleMute:function(){0!==this.mediaElement.getVolume()?(this._volumeBeforeMute=this.mediaElement.getVolume(),this.setVolume(0),e.setParam("muted",!0)):(this.setVolume(this._volumeBeforeMute),e.setParam("volume",this.mediaElement.getVolume()),e.setParam("muted",!1))},exitFullscreen:function(){this._fullScreenNow&&this.toggleFullScreen()},toggleFullScreen:function(){this._fullScreenNow?document.exitFullscreen?document.exitFullscreen():document.mozCancelFullScreen?document.mozCancelFullScreen():document.webkitExitFullscreen?document.webkitExitFullscreen():document.msExitFullscreen&&document.msExitFullscreen():((d.os.isIpad()||d.os.isIphone())&&this.mediaElement.$video.get(0).webkitEnterFullscreen&&this.mediaElement.$video.get(0).webkitEnterFullscreen(),this.fullScreenElement.requestFullscreen?this.fullScreenElement.requestFullscreen():this.fullScreenElement.webkitRequestFullscreen?this.fullScreenElement.webkitRequestFullscreen():this.fullScreenElement.mozRequestFullScreen?this.fullScreenElement.mozRequestFullScreen():this.fullScreenElement.msRequestFullscreen&&this.fullScreenElement.msRequestFullscreen(),this.$fullScreenButton.removeClass(this.cssClasses.fullscreen).addClass(this.cssClasses.smallscreen)),this.stat.send({name:"fullscreen",value:!this._fullScreenNow})},_initVideo:function(){this.stat.send({name:"started"+(d.os.isMobile()?"_mob":"")},!0),b.myrb(this.CNT.startLoading),this.options.trackWaiting&&(this.waiting15=setTimeout(function(){this.stat.sendToGraphite("waiting15")}.bind(this),15e3)),e.getParam("quality")||this.stat.send({name:"first_time"},!0),d.os.isIphone()||(this.$videoArea=a("<div><div>").addClass(this.cssClasses.videoArea).appendTo(this.$el))},_loadSprite:function(){if(d.display.isRetina()){var b=document.createElement("link");b.rel="stylesheet",b.href=this.options.retinaSprite+"?"+this.options.cssVideoRetinaVersion,a(b).insertAfter(a('link[rel="stylesheet"]').last())}},_createDomElements:function(){this.$container=a("<div></div>").addClass(this.cssClasses.main).appendTo(this.$el),this.$videoElement.addClass(this.cssClasses.videoElement),this.options.advMode?this.$container.addClass(this.cssClasses.advMode):this.$videoElement.attr({tabindex:1}),this.$el.addClass(this.cssClasses.wrapper),this._createInsidePlayButton(),this.$preloader=a("<div></div>").addClass(this.cssClasses.preloader).appendTo(this.$el).hide(),this._createPlayButton(),this._createTimeLeft(),this._createProgressBar(),this.options.external&&(this.$container.addClass("external"),this.options.hideLogo?this.$container.addClass("hidelogo"):this._createLinkToMyMail()),this._createFullScreenButton(),!this.options.advMode&&this.options.qualityList.length>1&&this._createQualitySettings(),d.os.isMobile()?this.$container.addClass("no-volume"):(this._createVolumeProgressBar(),this._createVolumeButton(),this.options.external&&this.$volumeProgressBar.addClass("external")),this._createTimeRight(),this._updateTime()},_createPlayButton:function(){this.$playButton=a("<div></div>").addClass(this.cssClasses.playButton).addClass(this.cssClasses.play).appendTo(this.$container)},_createTimeLeft:function(){this.$timeLeft=a("<div></div>").html("00:00").addClass(this.cssClasses.timeLeft).appendTo(this.$container)},_createTimeRight:function(){this.$timeRight=a("<div></div>").html("00:00").addClass(this.cssClasses.timeRight).appendTo(this.$container)},_createProgressBar:function(){this.$progressBarWrapper=a("<div></div>").addClass(this.cssClasses.progressBarWrapper).appendTo(this.$container),this.$progressBar=a("<div></div>").addClass(this.cssClasses.progressBar).appendTo(this.$progressBarWrapper),this.$progressPlay=a("<div></div>").addClass(this.cssClasses.progressPlay).css({backgroundColor:this.options.progressBarColor}).appendTo(this.$progressBar),this.$progressLoad=a("<div></div>").addClass(this.cssClasses.progressLoad).appendTo(this.$progressBar),this.$progressButton=a("<div></div>").addClass(this.cssClasses.progressButton).appendTo(this.$progressBar)},_createVolumeButton:function(){this.$volumeButton=a("<div></div>").addClass(this.cssClasses.volumeButton).addClass(this.cssClasses.volume).appendTo(this.$container)},_createVolumeProgressBar:function(){var b,c;for(this.$volumeProgressBar=a("<div></div>").addClass(this.cssClasses.volumeProgressBar).appendTo(this.$container),this.$volumeProgressButton=a("<div></div>").addClass(this.cssClasses.volumeProgressButton).appendTo(this.$volumeProgressBar),this.$volumeItems=a(),b=0;b<this.options.volumeItemsCount;b++)c=a("<div></div>").addClass(this.cssClasses.volumeProgressItem).appendTo(this.$volumeProgressBar),this.$volumeItems=this.$volumeItems.add(c)},_createQualitySettings:function(){this._createQualityButton(),this._createQualityList()},_createQualityButton:function(){this.$qualityButton=a("<div></div>").addClass(this.cssClasses.qualityButton).addClass(this.cssClasses.settings).appendTo(this.$container)},_createQualityList:function(){var b,c=this.mediaElement.currentQuality;this.$qualityList=a("<div></div>").addClass(this.cssClasses.qualityList).appendTo(this.$container),this.options.external&&this.$qualityList.addClass("external"),a("<div></div>").addClass(this.cssClasses.qualityListTitle).html(this.options.locales.quality).appendTo(this.$qualityList),this.$qualityItems=a(),this.options.qualityList.reverse().forEach(function(c){b=a("<div></div>").addClass(this.cssClasses.qualityItem).html(this.options.locales.qualityList[c.name]).attr({"data-quality-type":c.name}).appendTo(this.$qualityList),this.$qualityItems=this.$qualityItems.add(b)}.bind(this)),this.$qualityItems.filter('[data-quality-type="'+c.name+'"]').addClass(this.cssClasses.qualityItemSelected)},_createFullScreenButton:function(){this.$fullScreenButton=a("<div></div>").addClass(this.cssClasses.fullScreenButton).addClass(this.cssClasses.fullscreen).appendTo(this.$container)},_createLinkToMyMail:function(){var c=this.options.videoPageUrl+this.options.videoLocation+".html";c=c.replace(/(http:|https:|)\/\//,""),this.$linkToMyMail=a('<a href="https://r.mail.ru/clb670603/'+c+'/?from=videoplayer" target="_blank" data-clns="d'+this.CNT.myMailClick+'"></div>').addClass(this.cssClasses.linkToMyMail).addClass(this.cssClasses.logo).appendTo(this.$container).on("click",function(c){var d;b.myrb(this.CNT.myMailClick),this.options.referer&&(d=this.options.referer.match(/http(|s):\/\/([\w\W]*?)(?:(\/|\?|#))/)),b.dwh({version:1,category:{"mm-player":{action:4,ad:!!this.options.prerollStarted,videoItem:this.options.externalId,authorized:!!this.options.authorized,user:this.options.user||"",referer:d?d[2]:this.options.referer,duration:this.mediaElement.getDuration(),region:this.options.region,platform:a.browser.platform,cdn:this.mediaElement.getCdn()}}})}.bind(this))},_updateTime:function(){var a,b,c,d,e=this.mediaElement.getDuration()||this.options.duration||0;d=this._timeRemainMode?e-this._currentTime:this._currentTime,a=Math.floor(d/3600),a=a>0?a+":":"",b=Math.floor(d%3600/60),b=(b<10?"0"+b:b)+":",c=Math.floor(d%60),c=c<10?"0"+c:c,b&&c&&this.$timeLeft.html(a+b+c),a=Math.floor(e/3600),a=a>0?a+":":"",b=Math.floor(e%3600/60),b=(b<10?"0"+b:b)+":",c=Math.floor(e%60),c=c<10?"0"+c:c,b&&c&&this.$timeRight.html(a+b+c)},_updateProgress:function(){var a=Math.ceil(100*this._currentTime/this.mediaElement.getDuration()),b=0;this.$progressPlay&&(this.$progressPlay.width(a+"%"),this.$progressButton.css({left:a+"%"})),!this.options.advMode&&Math.abs(this._currentTime-this._oldTime)>=1&&(0===this._watchedTime&&(this.sendFirstByteLoadedStat(),this.waiting15&&clearTimeout(this.waiting15)),this._watchedTime++,this.togglePreload(!1),b=Math.round(100*this._watchedTime/this.mediaElement.getDuration()),this.stat.checkpoint(b),b>=80&&!this.reached80&&(this.reached80=!0,this.send80playedStat()),this._oldTime=parseInt(this._currentTime,10),this.sendTimeToDwh(this._watchedTime))},_updateLoadProgress:function(){var a=this.mediaElement.getBufferedPercent();this.$progressLoad.width(a+"%")},_createInsidePlayButton:function(){this.$insidePlayButton=a("<div></div>").appendTo(this.$el).on(d.os.isMobile()?"touchend":"click",this._onPlayButtonClick.bind(this)),this.showPlayButton()},_runInsideButton:function(){this.$insidePlayButton.removeClass().addClass(this.cssClasses.insidePlayButton).addClass(this.cssClasses.insidePlayButtonDynamic).addClass(this.cssClasses.insidePlayButtonRun).addClass(this.cssClasses.centerPlay),this.mediaElement.isPaused()===!1&&this.$insidePlayButton.addClass(this.cssClasses.pause),setTimeout(function(){this.$insidePlayButton.removeClass(this.cssClasses.insidePlayButtonRun)}.bind(this),this.options.insidePlayButtonTimeout)},showPlayButton:function(a){this.$insidePlayButton.removeClass().addClass(this.cssClasses.insidePlayButton).addClass(this.cssClasses.centerPlay).addClass("show"),"backscreen"===a?this.$insidePlayButton.addClass(this.cssClasses.insidePlayButtonBackscreen):"replay"===a&&this.$insidePlayButton.removeClass(this.cssClasses.centerPlay).addClass(this.cssClasses.centerRepeat)},togglePreload:function(a){void 0===a&&(a=!0),this.$preloader&&(a?(this.$preloader.show(),this.$insidePlayButton.removeClass("show")):this.$preloader.hide())},_getPercentCursor:function(a,b){var c,e,f;return d.os.isMobile()?b.originalEvent.touches&&b.originalEvent.touches[0]?(c=b.originalEvent.touches[0].pageX,e=b.originalEvent.touches[0].pageY):b.originalEvent.changedTouches&&b.originalEvent.changedTouches[0]&&(c=b.originalEvent.changedTouches[0].pageX,e=b.originalEvent.changedTouches[0].pageY):(c=b.pageX,e=b.pageY),f=a.hasClass("vertical-mode")?Math.ceil(Math.min(Math.max((a.width()-(e-a.offset().top))/(a.width()/100),0),100)):Math.ceil(Math.min(Math.max((c-a.offset().left)/(a.width()/100),0),100))},_getPercentProgressByEvent:function(a){return this._getPercentCursor(this.$progressBarWrapper,a)},_getPercentVolumeByEvent:function(a){return this._getPercentCursor(this.$volumeProgressBar,a)},_moveProgressByEvent:function(a){var b=this._getPercentProgressByEvent(a);this._moveProgress&&(this.backscreen&&this.backscreen.destroy(),this.$progressPlay.width(b+"%"),this.$progressButton.css({left:b+"%"}))},_filledVolumeItems:function(b){this.$volumeItems.each(function(c,d){var e=c*(this.options.volumeItemWidth+this.options.volumeItemMarginRight);e<b?a(d).addClass(this.cssClasses.volumeProgressItemFilled):a(d).removeClass(this.cssClasses.volumeProgressItemFilled)}.bind(this))},_moveVolumeByEvent:function(a){var b=this._getPercentVolumeByEvent(a),c=(this.$volumeProgressBar.width()-this.options.volumeButtonWidth)/100*b;this._moveVolume&&(this._filledVolumeItems(c),this.$volumeProgressButton.css({left:c+parseInt(this.$volumeProgressBar.css("paddingLeft"),10)}))},_positionVolumeButton:function(){var a=(this.$volumeProgressBar.width()-this.options.volumeButtonWidth)/100*(100*this.mediaElement.getVolume());this._filledVolumeItems(a),this.$volumeProgressButton.css({left:a+parseInt(this.$volumeProgressBar.css("paddingLeft"),10)})},_restoreVolume:function(){var a=100*e.getParam("volume"),b=e.getParam("muted");isNaN(a)&&(a=100),this.setVolumePositionByPercent(a),b&&this._onVolumeButtonClick({target:this.$volumeButton[0]})},updateView:function(){if(!d.os.isIphone()){var b,c,e=this.$el.outerWidth();e>500?(this._timeRemainMode=!1,this.$playButton.after(this.$timeLeft),this.$timeRight.show(),this.$container.removeClass("no-time"),this.$timeLeft.removeClass("minimized"),this.$timeLeft.off()):(this.$timeRight.after(this.$timeLeft),this.$timeRight.hide(),this.$container.addClass("no-time"),this.$timeLeft.addClass("minimized"),this.$timeLeft.on("click",function(a){this._timeRemainMode=!(this._timeRemainMode===!0),this._updateTime()}.bind(this))),this.$videoElement&&this.$videoElement.size()&&this._updateTime(),b=[this.$timeLeft,this.$progressBarWrapper],this.$volumeButton&&(e>400?(this.$volumeButton.before(this.$volumeProgressBar),this._volumePanelEnable=!1,this.$volumeProgressBar.removeClass("vertical-mode"),this.$container.removeClass("no-volume-bar")):(this.$volumeProgressBar.appendTo(this.$volumeButton),this._volumePanelEnable=!0,this.$volumeProgressBar.addClass("vertical-mode"),this.$container.addClass("no-volume-bar")),b.unshift(this.$volumeButton)),this.viralPanel&&(this.$qualityButton&&b.push(this.$qualityButton),b.push(this.viralPanel.$rightToolbar)),c=a(a.map(b,function(a){return a.get()})),e>300?c.show():c.hide(),setTimeout(function(){var a=this.$progressBarWrapper.prev().position().left+this.$progressBarWrapper.prev().width(),b=this.$progressBarWrapper.parent().width()-this.$progressBarWrapper.parent().children().last().position().left;this.$progressBarWrapper.css({left:a+18+"px",right:b+18+"px"})}.bind(this),100)}},_bindEvents:function(){this._domHandlers={onBodyMouseMove:this._onBodyMouseMove.bind(this),onBodyMouseUp:this._onBodyMouseUp.bind(this),onWindowResize:this._onWindowResize.bind(this),onFullScreenChange:this._onFullScreenChange.bind(this)},this._videoHandlers={onVideoClick:this._onVideoClick.bind(this),onVideoDoubleClick:this._onVideoDoubleClick.bind(this),onVideoMouseDown:this._onVideoMouseDown.bind(this),onVideoPlay:this._onVideoPlay.bind(this),onVideoWaiting:this._onVideoWaiting.bind(this),onVideoEnded:this._onVideoEnded.bind(this),onVideoPause:this._onVideoPause.bind(this),onVideoProgress:this._onVideoProgress.bind(this),onVideoTimeUpdate:this._onVideoTimeUpdate.bind(this),onVideoVolumeChange:this._onVideoVolumeChange.bind(this),onQualityChanged:this._onQualityChanged.bind(this),onVideoCanPlay:this._onVideoCanPlay.bind(this)},this.$videoElement.on(d.os.isMobile()?"touchstart":"click",this._videoHandlers.onVideoClick),this.$videoElement.on("dblclick",this._videoHandlers.onVideoDoubleClick),this.$videoElement.on("mousedown",this._videoHandlers.onVideoMouseDown),this.$videoElement.on("play",this._videoHandlers.onVideoPlay),this.$videoElement.on("waiting",this._videoHandlers.onVideoWaiting),this.$videoElement.on("ended",this._videoHandlers.onVideoEnded),this.$videoElement.on("pause",this._videoHandlers.onVideoPause),this.$videoElement.on("progress",this._videoHandlers.onVideoProgress),this.$videoElement.on("timeupdate",this._videoHandlers.onVideoTimeUpdate),this.$videoElement.on("volumechange",this._videoHandlers.onVideoVolumeChange),this.$videoElement.on("video.qualityChanged",this._videoHandlers.onQualityChanged),this.$videoElement.on("canplay",this._videoHandlers.onVideoCanPlay),this.$progressBarWrapper.on(d.os.isMobile()?"touchend":"click",this._onProgressBarWrapperClick.bind(this)),this.$progressBarWrapper.on(d.os.isMobile()?"touchstart":"mousedown",this._onProgressBarWrapperMouseDown.bind(this)),d.os.isMobile()||(a(window).on("resize",this._domHandlers.onWindowResize),this.$volumeButton.on("click",this._onVolumeButtonClick.bind(this)),this.$volumeButton.on("mouseover",this._onVolumeButtonMouseOver.bind(this)),this.$volumeButton.on("mouseleave",this._onVolumeButtonMouseLeave.bind(this)),this.$volumeProgressBar.on(d.os.isMobile()?"touchend":"click",this._onVolumeProgressBarClick.bind(this)),this.$volumeProgressBar.on(d.os.isMobile()?"touchstart":"mousedown",this._onProgressBarMouseDown.bind(this)),this.$volumeProgressBar.on("mouseenter",this._onVolumeProgressBarMouseEnter.bind(this))),this.options.advMode||this.$qualityButton&&(this.$qualityButton.on("click",this._onQualityButtonClick.bind(this)),this.$qualityList.find("[data-quality-type]").on("click",this._onQualityItemClick.bind(this))),a(document.body).on(d.os.isMobile()?"touchmove":"mousemove",this._domHandlers.onBodyMouseMove),a(document.body).on(d.os.isMobile()?"touchend":"mouseup",this._domHandlers.onBodyMouseUp),a(document).on("webkitfullscreenchange mozfullscreenchange fullscreenchange MSFullscreenChange",this._domHandlers.onFullScreenChange)},_unbindEvents:function(){this.$playButton.off(),this.$el.off(),this.$container.off(),this.$progressBarWrapper.off(),this.$fullScreenButton.off(),d.os.isMobile()||(this.$volumeButton.off(),this.$volumeProgressBar.off()),!this.options.advMode&&this.$qualityButton&&(this.$qualityButton.off(),this.$qualityList.find("[data-quality-type]").off()),a(document).off("webkitfullscreenchange mozfullscreenchange fullscreenchange MSFullscreenChange",this._domHandlers.onFullScreenChange),a(document.body).off(d.os.isMobile()?"touchmove":"mousemove",this._domHandlers.onBodyMouseMove),a(document.body).off(d.os.isMobile()?"touchend":"mouseup",this._domHandlers.onBodyMouseUp)}},protected:{sendFirstByteLoadedStat:function(){var c;this.stat.send({name:"first_bytes_loaded"},!0),b.myrb(this.CNT.started),b.myrb(this.CNT.startedHtml),b.myrb(this.options.external?this.CNT.startLoadingExt:this.CNT.startLoadingInt),this.options.authorized&&b.myrb(this.CNT.startLoadingAuth),1===this.options.fromBackscreenAutoplay&&b.myrb(this.CNT.startFromBackscreenAutoplay),"go"===this.options.partnerId&&b.myrb(this.CNT.goStarted),"dash"===this.mediaElement.getId()&&b.myrb(this.CNT.dashStarted),this.options.trackWaiting&&this.stat.sendToGraphite("start_rus_"+(d.os.isMobile()?"mob":"")),this.options.referer&&(c=this.options.referer.match(/http(|s):\/\/([\w\W]*?)(?:(\/|\?|#))/)),b.dwh({version:1,category:{"mm-player":{action:1,ad:!!this.options.prerollStarted,videoItem:this.options.externalId,authorized:!!this.options.authorized,user:this.options.user||"",referer:c?c[2]:this.options.referer,duration:this.mediaElement.getDuration(),region:this.options.region,platform:a.browser.platform,cdn:this.mediaElement.getCdn()}}}),d.os.isAndroid()?b.myrb([this.CNT.firstByteMobile,this.CNT.firstByteAndroid]):d.os.isIpad()?b.myrb([this.CNT.firstByteMobile,this.CNT.firstByteIpad]):d.os.isIphone()&&b.myrb([this.CNT.firstByteMobile,this.CNT.firstByteIphone]),this.stat.sendTNS("play")},send80playedStat:function(){var c;this.stat.send({name:"reached_80_percent"},!0),b.myrb(this.CNT.played80),b.myrb(this.CNT.played80html),this.options.external?b.myrb(this.CNT.played80htmlExt):b.myrb(this.CNT.played80htmlInt),"go"===this.options.partnerId&&b.myrb(this.CNT.goPlayed80),"dash"===this.mediaElement.getId()&&b.myrb(this.CNT.dash80),this.options.fromBackscreenAutoplay&&b.myrb(this.CNT.played80FromBackscreenAutoplay),this.isChannel&&b.myrb(this.CNT.channel80),this.options.authorized&&b.myrb(this.CNT.played80Auth),this.options.referer&&(c=this.options.referer.match(/http(|s):\/\/([\w\W]*?)(?:(\/|\?|#))/)),b.dwh({version:1,category:{"mm-player":{action:2,ad:!!this.options.prerollStarted,videoItem:this.options.externalId,authorized:!!this.options.authorized,user:this.options.user||"",referer:c?c[2]:this.options.referer,duration:this.mediaElement.getDuration(),region:this.options.region,platform:a.browser.platform,cdn:this.mediaElement.getCdn()}}}),d.os.isAndroid()?b.myrb([this.CNT.preogress80Mobile,this.CNT.preogress80Android]):d.os.isIpad()?b.myrb([this.CNT.preogress80Mobile,this.CNT.preogress80Ipad]):d.os.isIphone()&&b.myrb([this.CNT.preogress80Mobile,this.CNT.preogress80Iphone])},sendTimeToDwh:function(a){var c,d=this.options.referer.match(/http(|s):\/\/([\w\W]*?)(?:(\/|\?|#))/);this.timeStart||(this.timeStart=Date.now()),a>300?a%30===0&&(c=30):a>120?a%10===0&&(c=10):a>0&&a%5===0&&(c=5),c&&b.dwh({version:1,category:{"mailru-videoplayer-sessions":{MMPlayerAuthorized:!!this.options.authorized,MMPlayerReferer:d?d[2]:this.options.referer,MMPlayerRegion:this.options.region,id:i.get("mrcu"),timestamp:this.timeStart,time:c}}})},_onPlayButtonClick:function(a,b){this.togglePlay(),b&&b.stopPropagation()},_onVideoClick:function(c,e){if(e=e||c,!this.options.advMode)if(e.preventDefault(),e.stopPropagation(),!this.options.external||d.os.isMobile()||this.hasYandexRule())d.os.isMobile()&&this.mediaElement.isPaused()===!1?(this._noShowControls=!1,this._onParentMouseMove(e)):(this.togglePlay(),this._runInsideButton(),this.$videoElement.trigger("video.click"));else{this.mediaElement.pause();var f=this.options.videoPageUrl.replace(/http(|s)\:\/\/|\/\//,"");window.open("https://r.mail.ru/clb670603/"+f+this.options.videoLocation+".html?time="+parseInt(this._currentTime,10)+"&from=videoplayer","_blank");var g=this.options.referer.match(/http(|s):\/\/([\w\W]*?)(?:(\/|\?|#))/);b.dwh({version:1,category:{"mm-player":{action:4,ad:!!this.options.prerollStarted,videoItem:this.options.externalId,authorized:!!this.options.authorized,user:this.options.user||"",referer:g?g[2]:this.options.referer,duration:this.mediaElement.getDuration(),region:this.options.region,platform:a.browser.platform,cdn:this.mediaElement.getCdn()}}})}b.myrb(this.options.external?this.CNT.screenClickExternal:this.CNT.screenClick)},hasYandexRule:function(){var a=!1;return this.options.yandexRuleHosts&&this.options.referer&&(a=this.options.yandexRuleHosts.split(",").some(function(a){return this.options.referer.indexOf(a)!==-1}.bind(this))),a},_onVideoDoubleClick:function(a,b){this.toggleFullScreen(),b&&b.stopPropagation()},_onVideoMouseDown:function(a){2===a.button&&b.myrb(this.options.external?this.CNT.rightClickExternal:this.CNT.rightClick)},_onVideoWaiting:function(a){this.togglePreload(!0)},_onParentKeyDown:function(a,b){if(!(b.target&&"INPUT"===b.target.tagName||d.os.isTV())){var c={space:32,left:37,right:39,top:38,bottom:40},e=Object.keys(c).map(function(a){return c[a]});if(e.indexOf(b.keyCode)!==-1&&b.preventDefault(),!this.options.advMode)switch(b.keyCode){case c.space:this._runInsideButton(),this.togglePlay();break;case c.left:this.back();break;case c.right:this.forward();break;case c.top:this.volumeUp();break;case c.bottom:this.volumeLow()}}},_onVideoPlay:function(a){this.$playButton.addClass(this.cssClasses.pause).addClass(this.cssClasses.pauseIcon).removeClass(this.cssClasses.smallRepeat),this.$videoElement.focus(),this.$insidePlayButton.removeClass("show"),this.$container.addClass(this.cssClasses.nowPlay),!this.options.advMode&&this.$qualityList&&this.$qualityList.removeClass("show"),this.ended=!1,this.togglePreload(!1),this.options.advMode||this.stat.comScorePlayVideo()},_onVideoEnded:function(){this.ended=!0,this.$playButton.removeClass(this.cssClasses.play).removeClass(this.cssClasses.pauseIcon).addClass(this.cssClasses.smallRepeat),this.$insidePlayButton.removeClass("show"),this.mediaElement.getDuration()-this.mediaElement.getCurrentTime()>1&&(this.stat.sendToGraphite("sudden_end"),this.log.send("action=sudden_end&duration="+this.mediaElement.getDuration()+"&current_time="+this.mediaElement.getCurrentTime()+"&last_action="+this.lastAction+"&cdn="+this.mediaElement.getCdn())),this.options.advMode||(this.stat.comScoreStop(),this.stat.comScoreReinit())},_onVideoPause:function(a){this.$playButton.addClass(this.cssClasses.play).removeClass(this.cssClasses.pause).removeClass(this.cssClasses.pauseIcon).removeClass(this.cssClasses.smallRepeat),this.$container.removeClass(this.cssClasses.nowPlay),this.options.advMode||(this.viralPanel&&this.viralPanel.showRightPanel(!0),this.$qualityList&&this.$qualityList.removeClass("show"),this.stat.comScoreStop())},_onVideoProgress:function(a){this._updateLoadProgress(),this._updateTime()},_onVideoTimeUpdate:function(a){this._currentTime=this.mediaElement.getCurrentTime(),d.os.isIphone()?this._updateProgress():(this._updateTime(),this._moveProgress||this._updateProgress())},_onVideoVolumeChange:function(a){d.os.isMobile()||(this._positionVolumeButton(),this.mediaElement.getVolume()>0?(e.setParam("volume",this.mediaElement.getVolume()),e.setParam("muted",!1)):e.setParam("muted",!0),0===Number(this.mediaElement.getVolume().toFixed(1))?this.$volumeButton.addClass(this.cssClasses.volumeButtonMute).addClass(this.cssClasses.mute).removeClass(this.cssClasses.volume):this.$volumeButton.removeClass(this.cssClasses.volumeButtonMute).removeClass(this.cssClasses.mute).addClass(this.cssClasses.volume),b.myrb(this.CNT.volumeChange),this.stat.send({name:"click.volume",value:this.mediaElement.getVolume()}))},_initContextMenu:function(){if(!this.contextMenu){var a=[{name:this.options.locales.copyLink,callback:this._copyLink.bind(this)},{name:this.options.locales.copyFrameLink,callback:this._copyFrameLink.bind(this)},{name:this.options.locales.copyEmbedCode,callback:this._copyEmbedCode.bind(this)}];this.options.cluster&&this.options.cluster.name&&a.unshift({name:"cluster: "+this.options.cluster.name+" "+this.options.cluster.id}),this.contextMenu=h.create({
target:this.$el,parent:this.$el,items:a})}},_onParentMouseLeave:function(a){clearTimeout(this._controlsTimeout),this._controlsTimeout=setTimeout(function(){this.$container&&this.$container.removeClass("show"),this.options.advMode||(this.$qualityList&&this.$qualityList.removeClass("show"),this.viralPanel&&this.viralPanel.showRightPanel(!1))}.bind(this),this.options.controlsHideTime)},_onParentMouseMove:function(a){this._noShowControls||(this.$container&&this.$container.addClass("show"),this.$el.removeClass("no-cursor"),this.options.advMode||this.ended||!this.viralPanel||this.viralPanel.showRightPanel(!0)),this._noShowControls=!1,clearTimeout(this._controlsTimeout),this._controlsTimeout=setTimeout(function(){this.$container&&this.$container.removeClass("show"),this.options.advMode||(this.$qualityList&&this.$qualityList.removeClass("show"),this.viralPanel&&this.viralPanel.showRightPanel(!1)),this._fullScreenNow&&this.$el.addClass("no-cursor"),this._noShowControls=!0}.bind(this),this.options.controlsHideTime)},_onMouseEnter:function(a){clearTimeout(this._controlsTimeout)},_onMouseMove:function(a,b){this._moveProgressByEvent(b),d.os.isMobile()||this._moveVolumeByEvent(b),this._moveVolume&&this.setVolumePositionByPercent(this._getPercentVolumeByEvent(b)),b.stopPropagation()},_onWindowResize:function(a){try{this.updateView()}catch(a){}},_onProgressBarWrapperClick:function(a){if(!this.options.advMode){var c=this._getPercentProgressByEvent(a);this.setPositionByPercent(c),this.$progressPlay.width(c+"%"),this.$progressButton.css({left:c+"%"}),this.backscreen&&this.backscreen.destroy(),b.myrb(this.CNT.progressBarClick)}},_onProgressBarWrapperMouseDown:function(a){this.options.advMode||(this._moveProgress=!0,this.$container.addClass(this.cssClasses.moveProgress))},_onVolumeButtonClick:function(a,b){b=b||a,b.target===this.$volumeButton[0]&&this.toggleMute()},_onVolumeButtonMouseOver:function(a){this.showVolumePanel()},_onVolumeButtonMouseLeave:function(a){this.hideVolumePanel()},_onVolumeProgressBarClick:function(a){this.setVolumePositionByPercent(this._getPercentVolumeByEvent(a))},_onProgressBarMouseDown:function(a){this._moveVolume=!0},_onVolumeProgressBarMouseEnter:function(a){clearTimeout(this._volumePanelHideTimer)},_onQualityButtonClick:function(a){this.$qualityList.toggleClass("show"),b.myrb(this.CNT.qualityClick)},_onQualityItemClick:function(c){var d,e=a(c.target).closest("[data-quality-type]");if(e&&e.size())switch(d=e.data("qualityType"),this.togglePreload(!0),this.mediaElement.setQuality(d),d){case"sd":b.myrb(this.CNT.quality240);break;case"md1":case"md2":b.myrb(this.CNT.quality360);break;case"hd":b.myrb(this.CNT.quality720);break;case"full_hd":b.myrb(this.CNT.quality1080)}},_onFullScreenButtonClick:function(a,b){this.toggleFullScreen(),b&&b.stopPropagation()},_onFullScreenChange:function(c){var d=document.fullscreenElement||document.mozFullScreenElement||document.webkitFullscreenElement||document.msFullscreenElement;this._fullScreenNow!==!!d&&(this._fullScreenNow=!!d,this._fullScreenNow?d!==this.fullScreenElement||this.options.advMode||(this.$el.addClass("fullscreen"),b.myrb(this.CNT.fullScreenOn),a(document).trigger("VideoPlayer.enterFullscreen")):(this.$el.removeClass("fullscreen"),a(document).trigger("VideoPlayer.exitFullscreen"),this.$fullScreenButton.removeClass(this.cssClasses.smallscreen).addClass(this.cssClasses.fullscreen)))},_onBodyMouseMove:function(a){this._moveProgressByEvent(a),d.os.isMobile()||this._moveVolumeByEvent(a),this._moveVolume?this.setVolumePositionByPercent(this._getPercentVolumeByEvent(a)):this._hideVolumePanel&&this.hideVolumePanel(),this._moveProgress&&a.preventDefault()},_onBodyMouseUp:function(a){this.$container.removeClass(this.cssClasses.moveProgress),this._moveProgress&&(this.setPositionByPercent(this._getPercentProgressByEvent(a)),this._moveProgress=!1),this._moveVolume&&(this.setVolumePositionByPercent(this._getPercentVolumeByEvent(a)),this._moveVolume=!1)},_copyLink:function(){var a=this.options.videoPageUrl+this.options.videoLocation+".html";this._copyToClipboard(a)},_copyFrameLink:function(){var a=this.options.videoPageUrl+this.options.videoLocation+".html?time="+parseInt(this._currentTime,10);this._copyToClipboard(a)},_copyEmbedCode:function(){var a="<iframe src='"+this.options.apiUrl+this.options.videoId+"' width='626' height='367' frameborder='0' scrolling='no' webkitallowfullscreen mozallowfullscreen allowfullscreen></iframe>";this._copyToClipboard(a)},_copyToClipboard:function(b){this.copyLinkBubble&&this.copyLinkBubble.destroy(),this.require("ui/bubble2",function(c){this.copyLinkBubble=c.create({style:"mini",width:"310",height:"35",closeButton:!0,addClass:this.cssClasses.bubbleLink,container:this.$el,position:{my:"center center",at:"center center",offset:"0 -10"},corner:""}),this.copyLinkBubble.setContent(a('<input type="text" name="" value="'+b+'" class="ui-form-input">')),this.copyLinkBubble.setTarget(this.$el),this.copyLinkBubble.updateCornerPosition(),this.copyLinkBubble.show(),this.copyLinkBubble.getContent().find(".ui-form-input").select(),this.copyLinkBubble.getContainer().find(".ui-bubble__close").addClass("player_bubble_close").addClass("icon-player-mmico_close_gray_16"),a(".ui-form-input").select()}.bind(this))}}});return j});