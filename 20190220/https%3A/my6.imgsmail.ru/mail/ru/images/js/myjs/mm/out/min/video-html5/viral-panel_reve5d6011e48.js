define(["jquery","factory","counters","video-html5/share"],function(a,b,c,d){"use strict";var e,f={videoPageUrl:"https://my.mail.ru/",contentVideoHost:"https://content.video.mail.ru/",videoUrl:"",share:["ok","vk","fb","gplus","tw"],locales:{}},g={main:"b-video-viral-panel",button:"b-video-viral-panel__button",icon:"b-video-viral-panel__icon",buttonTitle:"b-video-viral-panel__button__title",rightToolbar:"b-video-viral-panel__right-toolbar",bigToolbar:"b-video-viral-panel__big-toolbar",getLinkButton:"b-video-viral-panel__get-link-button",shareButton:"b-video-viral-panel__share-button",sharePanel:"b-video-viral-panel__share-panel",shareItemsWrapper:"b-video-viral-panel__share-items-wrapper",sharePanelItem:"b-video-viral-panel__share-panel__item"},h={smallLink:"icon-player-video_link_small",smallShare:"icon-player-video_share_small",bigLink:"icon-player-video_link_big",bigShare:"icon-player-video_share_big",share:{mm:"icon-player-video_mm",ok:"icon-player-video_ok",vk:"icon-player-video_vk",tw:"icon-player-video_tw",fb:"icon-player-video_fb",gplus:"icon-player-video_gplus"}},i={clickGetLink:2125285,clickShare:2125286};return e={init:function(b,c){this.options=a.extend(!0,{},f,c),this.$videoElement=this.options.mediaElement.$video,this.$parent=b,this.$el=a("<div></div>").addClass(g.main).on("click",this._onClick.bind(this)).appendTo(b),this.options.external&&this.options.share.unshift("mm"),this._initRightToolbar(),this.$videoElement.on("ended",this._onVideoEnded.bind(this)),this.$videoElement.on("play",this._onVideoPlay.bind(this)),this.$videoElement.get(0).addEventListener("pause",this._onVideoPause.bind(this)),this._onWindowResizeHandler=this._onWindowResize.bind(this),a(window).on("resize",this._onWindowResizeHandler),this._playNow=!0},destroy:function(){this.$el.remove(),a(window).off("resize",this._onWindowResizeHandler)},showRightPanel:function(a){a?this.$bigToolbar&&0!==this.$bigToolbar.parents().length||this.$rightToolbar.addClass("show"):this.$getLinkButton.hasClass("selected")||this.$rightToolbar.removeClass("show")},_initRightToolbar:function(){this.$rightToolbar=a("<div></div>").addClass(g.rightToolbar).appendTo(this.$el),this._initGetLink(this.$rightToolbar,null,h.smallLink),this.options.share.forEach(function(b){var c=a("<div></div>").addClass(g.button).attr({"data-share-type":b}).appendTo(this.$rightToolbar);a("<i></i>").addClass(g.icon).addClass(h.share[b]).appendTo(c),c.on("click",this._onShareItemClick.bind(this)),40*this.$rightToolbar.children().length>this.$el.height()&&c.hide()}.bind(this))},_initGetLink:function(b,c,d){this.$getLinkButton=a("<div></div>").addClass(g.button).addClass(g.getLinkButton).on("click",this._onGetLinkClick.bind(this)).appendTo(b),a("<i></i>").addClass(g.icon).addClass(d).appendTo(this.$getLinkButton),c&&c.length&&a("<span></span>").addClass(g.buttonTitle).html(c).appendTo(this.$getLinkButton)},_initShare:function(b,c,d){var e;this.$shareButton=a("<div></div>").addClass(g.button).addClass(g.shareButton).on("click",this._onShareButtonClick.bind(this)).appendTo(b),a("<i></i>").addClass(g.icon).addClass(d).appendTo(this.$shareButton),c&&c.length&&a("<span></span>").addClass(g.buttonTitle).html(c).appendTo(this.$shareButton),this.$sharePanel=a("<div></div>").addClass(g.sharePanel).appendTo(this.$shareButton),e=a("<div></div>").addClass(g.shareItemsWrapper).appendTo(this.$sharePanel),this.options.share.forEach(function(b){var c=a("<div></div>").addClass(g.sharePanelItem).attr({"data-share-type":b}).appendTo(e);a("<i></i>").addClass(g.icon).addClass(h.share[b]).appendTo(c),c.on("click",this._onShareItemClick.bind(this))}.bind(this))},_closePanels:function(){this.$getLinkButton.removeClass("selected"),this.$shareButton&&this.$shareButton.removeClass("selected"),this.$bubbleLink&&this.$bubbleLink.removeClass("show"),this.$sharePanel&&this.$sharePanel.removeClass("show"),this._getLinkShow=!1,this._sharePandelShow=!1},_onVideoPlay:function(a){this._playNow=!0,this._ended&&(this._ended=!1,this.maxMode&&(this.$rightToolbar.remove(),this._initRightToolbar(),this.maxMode=!1))},_onVideoPause:function(){this._playNow=!0},_onVideoEnded:function(){this._playNow=!1,this._ended=!0},_onWindowResize:function(b){var c;for(this._resizeTimeOut&&clearTimeout(this._resizeTimeOut),this._resizeTimeOut=setTimeout(function(){this._playNow||(this.$el.remove(),this.init(this.$parent,this.options))}.bind(this),1e3),c=0;c<this.$rightToolbar.children().length;c++)40*(c+1)>this.$el.height()?a(this.$rightToolbar.children()[c]).hide():a(this.$rightToolbar.children()[c]).show()},_onClick:function(b){(!b||0===a(b.target).closest("."+g.bubbleLink).length&&0===a(b.target).closest("."+g.rightToolbar).length)&&this._closePanels()},_onGetLinkClick:function(a){this._getLinkShow?a.target!==this.$getLinkButton.get(0)&&a.srcElement!==this.$getLinkButton.get(0)||this._onBubbleLinkCloseClick(a):(this.$shareButton&&this.$shareButton.removeClass("selected"),this.$sharePanel&&this.$sharePanel.removeClass("show"),this.$getLinkButton.addClass("selected"),this.$bubbleLink?this.$bubbleLink.addClass("show"):b("video-html5/link-bubble",function(a){this.$bubbleLink=a.create(this.options).on("close",this._onBubbleLinkCloseClick.bind(this)).appendTo(this.$getLinkButton),this.$bubbleLink.addClass("show")}.bind(this)),this._getLinkShow=!0,this._sharePandelShow=!1,c.myrb(i.clickGetLink)),a.stopPropagation()},_onBubbleLinkCloseClick:function(a){this.$getLinkButton.removeClass("selected"),this._getLinkShow=!1,a.stopPropagation()},_onShareButtonClick:function(a){this._sharePandelShow?(this.$shareButton.removeClass("selected"),this.$sharePanel.removeClass("show"),this._sharePandelShow=!1):(this.$getLinkButton.removeClass("selected"),this.$shareButton.addClass("selected"),this.$bubbleLink.removeClass("show"),this.$sharePanel.addClass("show"),this._sharePandelShow=!0,this._getLinkShow=!1,c.myrb(i.clickShare)),a.stopPropagation()},_onShareItemClick:function(b){var c=a(b.target).closest("[data-share-type]"),e=c.data("shareType");d.openWindow(e,"fromPlayer"),this.$shareButton&&this.$shareButton.removeClass("selected"),this.$sharePanel&&this.$sharePanel.removeClass("show"),this._sharePandelShow=!1,b.stopPropagation()}},{create:function(a,b){var c=Object.create(e);return c.init(a,b),c}}});