var sa=sa||{};sa.openAPI=sa.openAPI||{};var version;var receiveParamObj=receiveParamObj||{hasInitSiller:false};var coupon=coupon||{};coupon.receive=(function($){var receiveCoupon=function(paramObj,callback){receiveParamObj.actId=paramObj.actId;receiveParamObj.actKey=paramObj.actKey;receiveParamObj.cityId=paramObj.cityId;receiveParamObj.sourceId=paramObj.sourceId;receiveParamObj.bonusTrigerId=paramObj.bonusTrigerId==undefined?"":paramObj.bonusTrigerId;receiveParamObj.callback=callback;coupon.receive.receiveCouponAjax(paramObj,callback,true)};var receiveCouponV2=function(paramObj,callback){receiveParamObj.actId=paramObj.actId;coupon.receive.receiveCouponAjax(paramObj,callback,false)};var receiveCouponAjax=function(paramObj,callback,needAlert){if(typeof(callback)!="function"){alert("未传入参数：回调函数callback！");return}if(!receiveParamObj.hasInitSiller){coupon.sillerCode.initSillerCode();receiveParamObj.hasInitSiller=true}var targetUrl="//quan.suning.com/lqzx_rsf.do?callback=?";paramObj.detect=encodeURIComponent(bd.rst());paramObj.deviceToken=bd.ptoken();paramObj.channel="1";paramObj.dfpToken=receiveParamObj.cpfdfptoken;ensureLogin(function(){$.ajax({url:targetUrl,type:"get",timeout:3000,dataType:"jsonp",cache:false,jsonpCallback:"callback",data:paramObj,success:function(data){if(needAlert){couponSuccessCallBack(data,callback)}else{couponSuccessCallBackV2(data,callback)}},error:function(data){if(needAlert){couponFailCallBack(callback)}else{couponFailCallBackV2(callback)}}})},coupon.common.passport_config)};var couponSuccessCallBack=function(respData,callerCallBack){if(respData.resultCode=="0"){callerCallBack(respData);resultAlert("领券成功","恭喜您，领券成功！")}else{if(respData.resultCode=="1001"||respData.resultCode=="1002"){coupon.sillerCode.sillerAlertBox(respData)}else{if(respData.resultCode=="1003"||respData.resultCode=="1004"){coupon.imageCode.imageAlertBox(respData)}else{if(respData.resultCode=="2004"||respData.resultCode=="2005"||respData.resultCode=="2006"){coupon.sms.smsAlertBox(respData)}else{resultAlert("领券失败",respData.resultMsg);callerCallBack(respData)}}}coupon.analytics.sendSAErrorMessage("coupon_receive_api_pc",respData.resultCode+"&&1&&"+respData.resultMsg+"&&");coupon.analytics.sendUomErrorMsg("2","cpf-api-20001_"+respData.resultCode,"0",respData.resultMsg,receiveParamObj.actId)}if("1"==respData.dfpTokenFlag){coupon.init.dfpTokenInit()}};var couponFailCallBack=function(callerCallBack){var respData={};respData.resultCode="C0000";respData.resultMsg="当前网络异常，请稍后再试（C0000）";coupon.analytics.sendSAErrorMessage("coupon_receive_api_pc","&&0&&当前网络异常，请稍后再试（C0000）&&");callerCallBack(respData)};var couponSuccessCallBackV2=function(respData,callerCallBack){coupon.analytics.sendSAErrorMessage("coupon_receive_api_pc","&&1&&"+respData.resultMsg+"&&");coupon.analytics.sendUomErrorMsg("2","cpf-api-20001_"+respData.resultCode,"0",respData.resultMsg,receiveParamObj.actId);callerCallBack(respData);if("1"==respData.dfpTokenFlag){coupon.init.dfpTokenInit()}};var couponFailCallBackV2=function(callerCallBack){var respData={};respData.resultCode="C0000";respData.resultMsg="当前网络异常，请稍后再试（C0000）";coupon.analytics.sendSAErrorMessage("coupon_receive_api_pc","&&0&&当前网络异常，请稍后再试（C0000）&&");callerCallBack(respData)};var resultAlert=function(title,message){var alertHtml='<div class="coupon-use">  <div class="quanUse-error">    <div class="bindCoupon-box quanUseDilog">      <div class="bindCoupon-title">        <a href="javascript:void(0)" class="close" title="&#x5173;&#x95ED;"></a>        <strong>'+title+'</strong>      </div>      <div class="bindCoupon-content-success">        <p><span></span><em id="alertMsg">'+message+'</em></p>        <div class="bindCoupon-success-btn">          <a href="javascript:void(0)" class="close">关闭</a>        </div>      </div>    </div>  </div></div>';$.mDialog({css:{width:"448px",height:"250px"},title:"",message:alertHtml,fadeIn:300,fadeOut:0,callback:function(){$(".m-dialog .title, .m-dialog .btn").remove()}})};return{receiveCoupon:receiveCoupon,receiveCouponV2:receiveCouponV2,receiveCouponAjax:receiveCouponAjax}})(jQuery);coupon.imageCode=(function($){var uuid="";var sceneId="";var imageAlertBox=function(respData){uuid=respData.uuid;sceneId=respData.sceneId;var vcsImgsrc="//vcs.suning.com/vcs/imageCode.htm?uuid="+uuid+"&yys="+new Date().getTime()+"&sceneId="+sceneId;$("#imgCode").attr("src",vcsImgsrc);$("#imageCodeDiv").show();$("#sillerCodeDivPcApi").hide();$("#inputCode").removeClass("error-input");$("#inputCode").val("");$("#tipCode").removeClass("tip-icon tip-ok-16 tip-ok l");$("#tipCode").hide();$(".siller-confirm").off("click").on("click",function(){coupon.imageCode.validateCode(1)});$("#failMsg").html(respData.resultMsg);$(".dialog-siller,.dialog-siller-fiexd").show()};var validateCode=function(flag){var code=$("#inputCode").val();code=code.replace(/\s+/g,"");if(code==""||code==undefined){$("#tipCode").hide();$("#inputCode").addClass("error-input");$("#inputCode").val("");$("#inputCode").attr("placeholder","请输入正确的验证码");coupon.imageCode.changeCode();return}var param="code="+code+"&uuid="+uuid+"&delFlag=0";$.ajax({type:"get",url:"//vcs.suning.com/vcs/validate_jsonp.htm",data:param,dataType:"jsonp",success:function(data){if(data[0].result=="true"){$("#tipCode").addClass("tip-icon tip-ok-16 tip-ok l");$("#tipCode").show();$("#inputCode").removeClass("error-input");if(flag=="1"){$(".checkout").removeClass("checkout-loading");$(".checkout").trigger("click");coupon.init.closeValidateAlert();var paramObj={actId:receiveParamObj.actId,actKey:receiveParamObj.actKey,cityId:receiveParamObj.cityId,validateCode:code,uuid:uuid,sourceId:receiveParamObj.sourceId,bonusTrigerId:receiveParamObj.bonusTrigerId};coupon.receive.receiveCouponAjax(paramObj,receiveParamObj.callback,true)}}else{$("#tipCode").hide();$("#inputCode").addClass("error-input");$("#inputCode").val("");$("#inputCode").attr("placeholder","请输入正确的验证码");coupon.imageCode.changeCode()}}})};var changeCode=function(){var src="//vcs.suning.com/vcs/imageCode.htm?uuid="+uuid+"&yys="+new Date().getTime()+"&sceneId="+sceneId;$("#imgCode").attr("src",src)};var keyupFunc=function(){var code=$("#inputCode").val();code=code.replace(/\s+/g,"");var length=code.length;if(length>=4){coupon.imageCode.validateCode(0)}};var focusFunc=function(){$("#inputCode").removeClass("error-input");$("#inputCode").attr("placeholder","以下字符不区分大小写")};return{imageAlertBox:imageAlertBox,changeCode:changeCode,keyupFunc:keyupFunc,focusFunc:focusFunc,validateCode:validateCode}})(jQuery);coupon.sillerCode=(function($){var sillerAlertBox=function(respData){siller.reset();$("#imageCodeDiv").hide();$("#sillerCodeDivPcApi").show();$(".siller-confirm").off("click").on("click",function(){coupon.sillerCode.receiveCouponAgain()});$("#failMsg").html(respData.resultMsg);$(".dialog-siller,.dialog-siller-fiexd").show()};var initSillerCode=function(){siller.init({tip1:"滑动完成",backWidth:"300px",backHeight:"36px",slWidth:"36px",slHeight:"36px",fontSize:"12px",target:"sillerCodeDivPcApi",url:"//dt.suning.com/detect/dt/dragDetect.json"});$("#sillerCodeDivPcApi").find("div").css({height:"42px"});siller.show()};var receiveCouponAgain=function(){if(siller.status==1){coupon.init.closeValidateAlert();var paramObj={actId:receiveParamObj.actId,actKey:receiveParamObj.actKey,cityId:receiveParamObj.cityId,validateCode:siller.queryToken(),sourceId:receiveParamObj.sourceId,bonusTrigerId:receiveParamObj.bonusTrigerId};coupon.receive.receiveCouponAjax(paramObj,receiveParamObj.callback,true)}};return{sillerAlertBox:sillerAlertBox,receiveCouponAgain:receiveCouponAgain,initSillerCode:initSillerCode}})(jQuery);coupon.sms=(function($){var count=function(count){$(".again i").text(count);if(count>=0){setTimeout(function(){coupon.sms.count(--count)},1000)}else{$(".get-sms").show();$(".again").hide()}};var sendSmsCode=function(){var targetUrl="//quan.suning.com/sms/getSmsCode.do?callback=?";$.ajax({url:targetUrl,type:"get",timeout:3000,dataType:"jsonp",cache:false,jsonpCallback:"callback",success:function(data){sendSmsSuccessCallBack(data)},error:function(data){sendSmsFailCallBack()}})};var sendSmsSuccessCallBack=function(data){if("1001"==data.errcode){$(".get-sms").hide();$(".again").show();coupon.sms.count(60);$(".error span").hide()}else{if(data.errcode=="01001"){$(".get-sms").hide();$(".has-none").show();$(".error span").hide();coupon.analytics.sendUomErrorMsg("2","cpf-api-20018_"+data.errcode,"0","今日次数已用完","")}else{if(data.errcode=="1104"||data.errcode=="1106"){$(".error span").text("验证码发送失败，请重新获取");$(".error span").show();coupon.analytics.sendUomErrorMsg("2","cpf-api-20018_"+data.errcode,"0","验证码发送失败，请重新获取","")}else{if(data.errcode=="01002"){$(".error span").text("您的操作过于频繁，请1分钟后再试");$(".error span").show();coupon.analytics.sendUomErrorMsg("2","cpf-api-20018_"+data.errcode,"0","您的操作过于频繁，请1分钟后再试","")}}}}};var sendSmsFailCallBack=function(){};var smsAlertBox=function(respData){var alertHtml='<div class="sms">	<div class="sms-content">   	<div class="sms-title">			<a href="javascript:void(0)" class="close" title="&#x5173;&#x95ED;"></a>			<strong>活动过于火爆，请进行短信安全验证</strong>		</div>		<div class="sms-con">		<p id="smsPhoneNo">'+respData.mobileNum+'</p>		<div class="sms-input">			<input type="text" placeholder="&#x8BF7;&#x8F93;&#x5165;&#x9A8C;&#x8BC1;&#x7801;">			<a class="get-sms" href="javascript:void(0)">获取验证码</a>			<a style="display: none;" class="again" href="javascript:void(0)">重新获取(<i>60</i>)</a>			<a style="display: none;" class="has-none" href="javascript:void(0)">今日次数用完</a>		</div>		<p class="error">';if(respData.resultCode=="2005"){alertHtml+="			<span>验证码错误</span>"}else{if(respData.resultCode=="2006"){alertHtml+="			<span>验证码错误次数过多，请重新获取</span>"}else{alertHtml+='			<span style="display: none;">验证码错误</span>'}}alertHtml+='		</p>		<div class="sms-btn">		<a class="sms-submit" href="javascript:void(0)">确定</a>		<a class="close" href="javascript:void(0)">取消</a>	</div></div>';$.mDialog({css:{width:"448px",height:"250px"},title:"",message:alertHtml,fadeIn:300,fadeOut:0,callback:function(){$(".m-dialog .title, .m-dialog .btn").remove();$(".again,.has-none").hide();$(".get-sms").off("click").on("click",function(){sendSmsCode()});$(".sms-input input").off("focus").on("focus",function(){$(".error span").hide()});$(".sms-submit").off("click").on("click",function(){var validateCode=$(".sms-input input").val();if(validateCode==""){$(".error span").text("请输入验证码");$(".error span").show();return}$.unmDialog();var paramObj={actId:receiveParamObj.actId,actKey:receiveParamObj.actKey,cityId:receiveParamObj.cityId,validateCode:validateCode,sourceId:receiveParamObj.sourceId,bonusTrigerId:receiveParamObj.bonusTrigerId};coupon.receive.receiveCouponAjax(paramObj,receiveParamObj.callback,true)})}})};return{smsAlertBox:smsAlertBox,count:count}})(jQuery);coupon.common=(function($){var passport_config={base:"//quan.suning.com/",loginTheme:"b2c_pop"};var esjs=document.getElementsByTagName("script");var escss=document.getElementsByTagName("link");var isInclude=function(name,isJs){if(isJs){for(var i=0;i<esjs.length;i++){if(esjs[i][isJs?"src":"href"].indexOf(name)!=-1){return true}}return false}else{for(var i=0;i<escss.length;i++){if(escss[i][isJs?"src":"href"].indexOf(name)!=-1){return true}}return false}};var _loadAsyncJs=function(src,versionNo){if(isInclude(src,true)){return}var _src=src+versionNo;var _scripts=document.getElementsByTagName("script");for(var i=0;i<_scripts.length;i++){if(_scripts[i].src==_src){return}}var _script=document.createElement("script");_script.type="text/javascript";_script.async=true;_script.src=_src;var _s=_scripts[0];_s.parentNode.insertBefore(_script,_s)};var _loadScript=function(src,versionNo,loadCallback){if(isInclude(src,true)){loadCallback();return}var _script=document.createElement("script");_script.type="text/javascript",void 0!==loadCallback&&(_script.readyState?_script.onreadystatechange=function(){"loaded"!=_script.readyState&&"complete"!=_script.readyState||(_script.onreadystatechange=null,loadCallback())}:_script.onload=function(){loadCallback()}),_script.src=src+versionNo,document.body.appendChild(_script)};var _loadAsyncCss=function(_href,versionNo){if(isInclude(_href,false)){return}var _script=document.createElement("link");_script.type="text/css";_script.rel="stylesheet";_script.async=true;_script.href=_href+versionNo;document.getElementsByTagName("head")[0].appendChild(_script)};var getUrlParam=function(name){var reg=new RegExp("(^|&)"+name+"=([^&]*)(&|$)","i");var r=window.location.search.substr(1).match(reg);if(r!=null){return decodeURI(r[2])}return""};var setCookie=function(keyStr,valStr){var v3=window.location.href;v3=v3.substring(v3.indexOf("//")+2);v3=v3.substring(0,v3.indexOf("/"));if(v3.indexOf(".")>0){v3=v3.substring(v3.indexOf("."))}var domain=v3;var path="/";var str=keyStr+"="+encodeURIComponent(valStr)+";domain="+domain+";path="+path;document.cookie=str};var getCookieByKey=function(c_name){if(document.cookie.length>0){c_start=document.cookie.indexOf(c_name+"=");if(c_start!=-1){c_start=c_start+c_name.length+1;c_end=document.cookie.indexOf(";",c_start);if(c_end==-1){c_end=document.cookie.length}return unescape(document.cookie.substring(c_start,c_end))}}return""};return{isInclude:isInclude,_loadAsyncJs:_loadAsyncJs,_loadScript:_loadScript,_loadAsyncCss:_loadAsyncCss,getUrlParam:getUrlParam,setCookie:setCookie,getCookieByKey:getCookieByKey,passport_config:passport_config}})(jQuery);coupon.analytics=(function($){var sendSAErrorMessage=function(id,message){var msgList=message.split("&&");var param={type_name:id,error_type:msgList[1],error_code:msgList[0],error_detail:msgList[2],member_id:msgList[3],member_level:"",region:"",bid:"cpfSale"};try{sa.openAPI.sendMsgV2(param);sa.openAPI.sendMessage(id,message)}catch(e){}};var sendUomErrorMsg=function(errorType,errorCode,status,errorDesc,businessParam){var errorDetail='{"errorDesc":"'+errorDesc+'","businessParam":"'+businessParam+'"}';var param={status:status,error_type:errorType,error_code:errorCode,error_detail:errorDetail,member_id:coupon.common.getCookieByKey("custno"),member_level:coupon.common.getCookieByKey("custLevel"),region:"",bid:"cpfUom"};try{sa.openAPI.sendMsgV2(param)}catch(e){}};return{sendSAErrorMessage:sendSAErrorMessage,sendUomErrorMsg:sendUomErrorMsg}})(jQuery);coupon.init=(function($){var alertValidateHtml=function(){var alertHtml='<div class="m-lion-dialog-fiexd dialog-siller-fiexd" style="display: none;position:fixed;z-index:8002;top:0;left:0;right:0;bottom:0;background-color:#000;filter:alpha(opacity=30);opacity:0.3"></div><div class="m-lion-dialog dialog-siller" style="width: 448px; height: 260px; margin-left: -224px; margin-top: -130px; top: 50%; display: none;">  <div class="container">  	<div class="title"><h3>领取优惠券</h3></div>  	<a href="javascript:coupon.init.closeValidateAlert();" class="btn close" title="关闭" style="z-index: 10;"></a>  	<div class="content">  		<div class="coupon-dialog has-get" style="padding: 52px 0;">    			<p class="tips"><i class="tip-icon tip-info-24"></i><span id="failMsg"></span></p>				<div id="sillerCodeDivPcApi" class="dt_parent float" style="margin:30px auto 50px;display: none;"></div>    			<div class="dialog-common identify-code" id="imageCodeDiv" style="display: none;">      			<div class="code-input clearfix">        				<dl>          				<dt class="l">验证码</dt>          				<dd class="l">            					<p class="item-ide">			   						<input autocomplete="off" onkeyup="coupon.imageCode.keyupFunc();" onfocus="coupon.imageCode.focusFunc();" class="ui-text l" type="text" placeholder="以下字符不区分大小写" id="inputCode" >			   						<i id="tipCode" ></i>			 					</p>			 					<p class="item-ide">			   						<img onclick="coupon.imageCode.changeCode();" id="imgCode" class="l" src="" />			   						<span class="change l">看不清楚？<a href="javascript:void(0);" onclick="coupon.imageCode.changeCode();">换一张</a></span>			 					</p>		   					</dd>		 				</dl>	   				</div>    			</div>    			<div class="coupon-dialog-btn" style="margin-top: 20px;">    				<a href="javascript:coupon.init.closeValidateAlert();" class="siller-close closeThis">关闭</a>    				<a href="javascript:;" class="siller-confirm">确定</a>    			</div>  		</div>  	</div>  </div></div>';$("body").append(alertHtml)};var closeValidateAlert=function(){$(".dialog-siller,.dialog-siller-fiexd").hide()};var dfpTokenInit=function(){if(typeof(_dfp)!="undefined"){_dfp.init({appCode:"UfggrFD1MpeUazVs",env:"prd",success:function(token){receiveParamObj.cpfdfptoken=token},error:function(e){coupon.analytics.sendSAErrorMessage("coupon_receive_api_pc","&&dfp.init&&dfpToken初始化异常:"+e+"&&"+coupon.common.getCookieByKey("custno"))}})}};var detectInit=function(){if(typeof(bd)!="undefined"){bd.init({token:"other",system:"CPF",url:"//dt.suning.com/detect/dt/portoToken.json"})}};return{alertValidateHtml:alertValidateHtml,closeValidateAlert:closeValidateAlert,dfpTokenInit:dfpTokenInit,detectInit:detectInit}})(jQuery);$(function(){if(!coupon.common.isInclude("jquery",true)){alert("请引入jQuery.js")}$("script").each(function(){if($(this).attr("src")!=undefined&&$(this).attr("src").indexOf("couponReceive.js")!=-1){if($(this).attr("src").lastIndexOf("?")<=0){version=""}else{version=$(this).attr("src").substring($(this).attr("src").lastIndexOf("?"))}return false}});if(typeof(ensureLogin)!="function"){coupon.common._loadAsyncJs("//res.suning.cn/project/passport/js/passport.min.js",version)}if(typeof(bd)=="undefined"){coupon.common._loadScript("//dt.suning.com/detect/dt/detect.js",version,coupon.init.detectInit)}else{coupon.init.detectInit()}if(typeof(_dfp)=="undefined"){coupon.common._loadScript("//dfp.suning.com/dfprs-collect/dist/dfp.js",version,coupon.init.dfpTokenInit)}else{coupon.init.dfpTokenInit()}if(typeof(sa)=="undefined"||typeof(sa.openAPI)=="undefined"||typeof(sa.openAPI.sendMsgV2)!="function"){coupon.common._loadAsyncJs("//res.suning.cn/javascript/sn_da/da_opt.js",version);coupon.common._loadAsyncJs("//res.suning.cn/javascript/sn_da/sa-analytics.js",version)}if(typeof($.mDialog)!="function"){coupon.common._loadAsyncJs("//res.suning.cn/javascript/SFE.dialog.js",version)}coupon.common._loadAsyncCss("//res.suning.cn/public/v3/css/??v3common.min.css",version);coupon.common._loadAsyncCss("//res.suning.cn/project/cpf/js/api/pc/css/coupon.css",version);coupon.common._loadAsyncCss("//res.suning.cn/project/cpf/css/validateCode.css",version);if(typeof(siller)=="undefined"||typeof(siller.init)!="function"){coupon.common._loadAsyncCss("//dt.suning.com/detect/static/siller.css",version);coupon.common._loadAsyncJs("//dt.suning.com/detect/dt/siller.js",version)}coupon.init.alertValidateHtml()});