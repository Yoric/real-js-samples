define(["OK/utils/throttle","OK/utils/dom","OK/utils/utils","OK/logger"],function(d,k,p,r){var n="__loading",o="__playing",e="gif_video",l="gif_preview",f="gif_cnt",b="photo.gif",a="photo.gif.inplace",i=".js-volumeControl";var j=[],q;var m=function(s){this.element=s;this.autoplay=s.getAttribute("data-autoplay")==="true";this.nostop=s.getAttribute("data-nostop")==="true";this.inMessages=s.getAttribute("data-messages")==="true";this.playOnParent=s.getAttribute("data-playOnParent")==="true";this.location=s.getAttribute("data-location")||"u";this.volume=parseInt(s.getAttribute("data-volume")||"1",10);this.volumeControl=s.getAttribute("data-volumeControl")==="true";this.photoId=s.getAttribute("data-photoId");this.groupPhoto=s.getAttribute("data-groupPhoto")==="true"||undefined;var t=k.parent(this.element,this.playOnParent?"js-gifPlay":"media-photos_i");this.addButton=k.firstByClass(t,"gif-add");this.gifContainer=this.element.parentNode;if(this.playOnParent){this.gifContainer=k.parent(this.element,"js-gifPlay");}this.boundPlay=this.play.bind(this);this.boundStop=this.stop.bind(this);this.boundToggleVolume=this.toggleVolume.bind(this);this.boundCanPlayHandler=this.canPlayHandler.bind(this);this.boundPlayingHandler=this.playingHandler.bind(this);this.boundErrorHandler=this.errorHandler.bind(this);if(this.autoplay){if(this.nostop){this.play();}else{this.playOrStop();}}else{if(this.gifContainer){this.gifContainer.addEventListener("mouseenter",this.boundPlay);this.gifContainer.addEventListener("mouseleave",this.boundStop);}}if(this.volumeControl){this.volumeToggler=k.firstByClass(this.gifContainer,i);if(this.volumeToggler){this.volumeToggler.addEventListener("click",this.boundToggleVolume);}}};m.prototype={deactivate:function(){if(this.gifContainer){this.gifContainer.removeEventListener("mouseenter",this.boundPlay);this.gifContainer.removeEventListener("mouseleave",this.boundStop);}if(this.volumeToggler){this.volumeToggler.removeEventListener("click",this.boundToggleVolume);}},playOrStop:function(){if(!this.autoplay){return;}var t=this.element.classList.contains(o)||this.element.classList.contains(n);var s=p.isElementPartiallyInViewport(this.element,0.4);if(s&&!t){this.play();}else{if(!s&&t&&!this.nostop){this.stop();}}},toggleVolume:function(t){t.stopPropagation();t.preventDefault();var s=this.getVideo();if(s){var u=s.volume===0;this.muteAll();s.volume=u?1:0;s.muted=!u;if(u){t.target.classList.add("__animated");}else{t.target.classList.remove("__animated");}}},mute:function(){var s=this.getVideo();if(s){s.volume=0;s.muted=true;if(this.volumeToggler){this.volumeToggler.classList.remove("__animated");}}},isSupportsMp4:function(s){return !this.skipMp4&&s.canPlayType('video/mp4; codecs="avc1.42E01E, mp4a.40.2"').length>0;},isSupportsWebm:function(s){return !this.skipWebm&&s.canPlayType("video/webm").length>0;},canPlayHandler:function(t){var s=t.currentTarget;s.play();if(!this.playing){r.duration(b,Math.max(Date.now()-this.startTime,0),"video_start",this.location);}},playingHandler:function(){this.element.classList.add(o);if(this.addButton){this.addButton.classList.add(o);}this.element.classList.remove(n);if(!this.playing){this.playing=true;r.duration(b,Math.max(Date.now()-this.startTime,0),"video_play",this.location);r.success(a,location,this.autoplay?"a":"m");r.raw(b,{g:this.groupPhoto,pid:this.photoId,d:Math.max(Date.now()-this.startTime,0),p1:"video_play"});}},errorHandler:function(u){var t="und";var s=u.currentTarget;this.stop(true);if(s.error&&s.error.code){if(this.isSupportsMp4(s)){this.skipMp4=true;t="mp4";}else{if(this.isSupportsWebm(s)){this.skipWebm=true;t="webm";}}r.success(b,"video_fail_"+t+"_"+s.error.code,this.location);this.play();}else{r.success(b,"video_fail_"+t,this.location);}},play:function(){this.playing=false;var C,s=false,x=false,u=this.element.getAttribute("data-mp4Src"),y=this.element.getAttribute("data-webmSrc"),B=this.element.getAttribute("data-width"),z=this.element.getAttribute("data-height"),A=this.element.getAttribute("data-style"),F=this.element.getAttribute("data-imageSrc"),E=this.element.getAttribute("data-gifSrc"),t=this.element.getAttribute("data-preferWebm"),D=this;if(!this.skipMp4||!this.skipWebm){C=document.createElement("video");C.volume=this.volume;if(this.volume===0){C.muted=true;}if(typeof C.canPlayType==="function"){s=this.isSupportsMp4(C);x=this.isSupportsWebm(C);}}this.startTime=Date.now();if((s&&u!==null)||(x&&y!==null)){if(B){C.width=B;}if(z){C.height=z;}C.className=e;C.loop=true;C.setAttribute("style",A);C.addEventListener("canplay",this.boundCanPlayHandler);C.addEventListener("playing",this.boundPlayingHandler);C.addEventListener("error",this.boundErrorHandler);C.setAttribute("src",t?((x&&y)||(s&&u)):((s&&u)||(x&&y)));C.setAttribute("poster",F);k.firstByClass(this.element,f).appendChild(C);this.element.classList.add(n);C.load();C.play();r.success(b,"video_load",this.location);}else{var v=this.getImage();if(v){v.setAttribute("src",E);}var w=new Image();w.src=E;w.onload=function(){D.classList.remove(n);D.classList.add(o);D.addButton.classList.add(o);r.duration(b,Math.max(Date.now()-D.startTime,0),"gif_play",D.location);r.success(a,D.location,D.autoplay?"a":"m");r.raw(b,{g:D.groupPhoto,pid:D.photoId,d:Math.max(Date.now()-D.startTime,0),p1:"gif_play"});};w.onerror=function(){D.stop(true);r.success(b,"gif_fail",D.location);};if(!w.complete){this.element.classList.add(n);}else{this.element.classList.remove(n);this.element.classList.add(o);if(this.addButton){this.addButton.classList.add(o);}}r.success(b,"gif_load",this.location);}},stop:function(t){var u=this.getVideo();if(u){u.removeEventListener("canplay",this.boundCanPlayHandler);u.removeEventListener("playing",this.boundPlayingHandler);u.removeEventListener("error",this.boundErrorHandler);k.remove(u);}this.element.classList.remove(n,o);if(this.addButton){this.addButton.classList.remove(o);}var s=this.getImage();if(s){s.setAttribute("src",this.element.getAttribute("data-imageSrc"));}if(!t){r.duration(b,Math.max(Date.now()-this.startTime,0),!!u?"video_stop":"gif_stop",this.location);}if(this.volumeToggler){this.volumeToggler.classList.remove("__animated");}},muteAll:function(){var s;for(s=0;s<j.length;++s){j[s].mute();}},getImage:function(){return k.firstByClass(this.element,l);},getVideo:function(){return k.firstByClass(this.element,e);}};function h(y,t){var u=y.getAttribute("data-id"),A=y.getAttribute("data-type"),w=y.getAttribute("data-tkn"),v=y.getAttribute("data-container-id");if(t===true){y.classList.add("invisible");var B=y.nextElementSibling;if(B&&B.classList.contains("js-clonePhotoDone")){B.classList.remove("invisible");}}else{var z=k.parent(y,"ovr-menu_soh");if(z){z.classList.add("__success");}var s=k.parent(y,"gif-add");if(s){s.classList.add("__gif-success");var x=k.firstByClass(s,"sc-menu");if(x){x.classList.add("__gif-success");}}if(!q){q=document.getElementById("hook_Block_ShortcutMenu");}var C=k.firstByClass(q,"sc-menu");if(C){C.classList.add("__gif-success");q.dispatchEvent(new CustomEvent("change",{bubbles:true}));}}p.ajax({type:"POST",contentType:"application/json; charset=utf-8",url:"/web-api/photo/add",timeout:60000,data:JSON.stringify({photoId:u,type:A,tkn:w,cntId:v})});}function g(s){h(s.currentTarget,false);}var c=d(500,function(){var s;for(s=0;s<j.length;s++){if(!j[s].inMessages){j[s].playOrStop();}}});return{activate:function(s){if(s.classList.contains("gif-add_item")){s.addEventListener("click",g);}else{if(j.length===0){window.addEventListener("scroll",c);}j.push(new m(s));}},deactivate:function(t){if(t.classList.contains("gif-add_item")){t.removeEventListener("click",g);}else{var s;for(s=0;s<j.length;s++){if(j[s].element===t){j[s].deactivate();j.splice(s,1);break;}}if(j.length===0){window.removeEventListener("scroll",c);}}},add:function(s){h(s,true);}};});