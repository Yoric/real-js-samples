(function(c,r){"function"===typeof define?define("",["$"],r):r(c.jQuery)})(this,function(c){function r(){var a;a:{var b;if(0<document.cookie.length&&(a=document.cookie.indexOf("SUV="),-1!=a)){a=a+3+1;b=document.cookie.indexOf(";",a);-1==b&&(b=document.cookie.length);a=decodeURI(document.cookie.substring(a,b));break a}a=""}return parseInt(a,16).toString().replace(/[\.\+e]/g,"")}function v(a){this.requestFrequency=a||300;this.channel=[];this.recordingLen=0;this.recording=!1;this.audioContext=this.timer=null}function g(a){var b=c("#voice-text"),d=c("#voice-microphone");c("#voice-ring");switch(a){case"translating":d.attr("class","round load");break;case"forbidden":d.attr("class","round err");b.html("\u8bed\u97f3\u641c\u7d22\u529f\u80fd\u5df2\u5173\u95ed\u3002");break;case"fail":d.attr("class","round err");b.html('\u4e0d\u592a\u4e86\u89e3\u60a8\u7684\u610f\u601d\uff0c<a href="javascript:void(0);" uigs-id="voice_retry" id="voice-retry">\u70b9\u51fb\u91cd\u8bd5</a>');break;default:d.attr("class","round on"),b.html("\u60f3\u641c\u4ec0\u4e48\uff0c\u8bf4\u6765\u542c\u542c\uff01")}}function w(a){f.push(a);if(10<f.length)f.shift();else return!0;a=1;for(var b=f.length;a<b;a++)if(f[a]!==f[a-1])return!0;return!1}function m(a){"function"===typeof window.uigsPB&&uigsPB(a)}function A(a){if(!(n||this.reqIdx<u||this.voiceStartTime!==h))if(u=this.reqIdx,0===a.status)if(a=a.message.substring(0,20),""!==a){if(c("#voice-text").html(a),c(x).val(a),!w(a)||20<=a.length||2E4<(new Date).getTime()-h)n=!0,k(),g("translating"),m("voice_succ"),c(B).submit()}else w(a)||(m("voice_fail"),g("fail"),k());else f.length||(m("voice_fail"),g("fail"),k())}function C(){m("voice_fail");g("fail");k()}function k(){p.stop();f=[];u=t=0}function D(){c("body").css("overflow","hidden");l&&l.length?l.show():(q?y.append('<div class="index-yuyin-box" id="voice-layer" style=" z-index:99999999"><div class="yuyin-box" id="voice-layer"><table><tbody><tr><th><span id="voice-text">\u60f3\u641c\u4ec0\u4e48\uff0c\u8bf4\u6765\u542c\u542c\uff01</span></th><td><div class="round on" id="voice-microphone"><span class="s1"></span><span class="s1" id="voice-ring" style="animation-delay:0.8s"></span><span class="s2"><span class="s3" style="height:0"></span><span class="s4"></span><i></i></span></div></td></tr></tbody></table><a href="javascript:void(0);" uigs-id="voice_close" id="voice-close" class="yuyin-close"></a></div></div>'):y.append('<div class="yuyin-box" id="voice-layer"><table><tbody><tr><th><span id="voice-text">\u60f3\u641c\u4ec0\u4e48\uff0c\u8bf4\u6765\u542c\u542c\uff01</span></th><td><div class="round on" id="voice-microphone"><span class="s1"></span><span class="s1" id="voice-ring" style="animation-delay:0.8s"></span><span class="s2"><span class="s3" style="height:0"></span><span class="s4"></span><i></i></span></div></td></tr></tbody></table><a href="javascript:void(0);" uigs-id="voice_close" id="voice-close" class="yuyin-close"></a></div>'),l=c("#voice-layer"),c("#voice-close").on("click",function(){k();z()}),l.on("click","#voice-retry",function(){g();h=(new Date).getTime();p.start()}))}function z(){c(x).val("");l.hide();g();c("body").css("overflow","")}function E(){var a=c('<a href="javascript:void(0);" uigs-id="voice_btn" id="voice-btn" class="fayin" title="\u8bed\u97f3\u641c\u7d22"></a>'),b=c('<link rel="stylesheet" type="text/css" href="/web/css/'+(q?"yuyin.v1.0.1":"yuyin_result.v1.0.1")+'.css">');p=new v(200);p.error=function(){g("forbidden");k();setTimeout(z,3E3)};c("head").append(b);q?(c("#search-box").append(a),c("#query").parent().addClass("yuyin-cur")):(c("#top_qreset").after(a),c("#upquery").parent().addClass("yuyin-cur"));c("#voice-btn").on("click",function(){D();h=(new Date).getTime();p.start()})}var y=c("body"),l,q="undefined"===typeof window.oldQuery,x=q?"#query":"#upquery",B=q?"#sf":"#searchForm",f=[],h,n=!1,p,t=0,u=0;v.prototype={reset:function(){this.channel=[];this.recordingLen=0},empower:function(){var a=this;navigator.getUserMedia=navigator.webkitGetUserMedia||navigator.mozGetUserMedia||navigator.msGetUserMedia;if(navigator.mediaDevices&&navigator.mediaDevices.getUserMedia)navigator.mediaDevices.getUserMedia({audio:!0}).then(function(b){a.success.call(a,b)})["catch"](function(b){a.error.call(a,b)});else navigator.getUserMedia&&navigator.getUserMedia({audio:!0},function(b){a.success.call(a,b)},function(b){a.error.call(a,b)})},success:function(a){var b=this,d;if(null===b.audioContext)try{b.audioContext=new(window.AudioContext||window.webkitAudioContext)}catch(F){}this.sampleRate=b.audioContext.sampleRate;a=b.audioContext.createMediaStreamSource(a);d=b.audioContext.createScriptProcessor(2048,1,1);a.connect(d);d.onaudioprocess=function(a){b.recording&&(a=a.inputBuffer.getChannelData(0),b.channel.push(new Float32Array(a)),b.recordingLen+=2048)};d.connect(b.audioContext.destination);this.timer=setInterval(function(){if(!n){var a=b.encodeWav();2E3<(new Date).getTime()-h&&!f.length&&(m("voice_fail"),g("fail"),k());c.ajax({url:"https://webrest.speech.sogou.com/index.ks?type=utf-8&imei_no={{imei}}&starttime={{starttime}}&idx=".replace("{{imei}}",r()).replace("{{starttime}}",h)+t,type:"post",cache:!1,dataType:"json",data:a,reqIdx:t,voiceStartTime:h,contentType:"multipart/form-data",processData:!1,success:A,error:C});t++}},this.requestFrequency)},error:function(a){},mergeBuffers:function(a,b){b=new Float32Array(b);for(var d=0,c=a.length,e=0;e<c;e++){var f=a[e];b.set(f,d);d+=f.length}return b},downsampleBuffer:function(a,b,d){if(b==d)return a;if(b>d)throw"\u76ee\u6807\u91c7\u6837\u7387\u5fc5\u987b\u5c0f\u4e8e\u5f53\u524d\u91c7\u6837\u7387";b=d/b;d=new Float32Array(Math.round(a.length/b));for(var c=0,e=0;c<d.length;){for(var f=Math.round((c+1)*b),g=0,h=0;e<f&&e<a.length;e++)g+=a[e],h++;d[c]=g/h;c++;e=f}return d},writeUTFBytes:function(a,b,c){for(var d=c.length,e=0;e<d;e++)a.setUint8(b+e,c.charCodeAt(e))},floatTo16BitPCM:function(a,b,c){for(var d=0;d<c.length;d++,b+=2){var e=Math.max(-1,Math.min(1,c[d]));a.setInt16(b,0>e?32768*e:32767*e,!0)}},encodeWav:function(){var a=this.downsampleBuffer(this.mergeBuffers(this.channel,this.recordingLen),16E3,this.sampleRate),b=new ArrayBuffer(44+2*a.length),b=new DataView(b);this.writeUTFBytes(b,0,"RIFF");b.setUint32(4,44+2*a.length,!0);this.writeUTFBytes(b,8,"WAVE");this.writeUTFBytes(b,12,"fmt ");b.setUint32(16,16,!0);b.setUint16(20,1,!0);b.setUint16(22,1,!0);b.setUint32(24,16E3,!0);b.setUint32(28,64E3,!0);b.setUint16(32,2,!0);b.setUint16(34,16,!0);this.writeUTFBytes(b,36,"data");b.setUint32(40,2*a.length,!0);this.floatTo16BitPCM(b,44,a);return new Blob([b],{type:"audio/wav"})},start:function(){this.empower();n=!1;this.recording=!0},stop:function(){this.recording=!1;n=!0;clearInterval(this.timer);this.reset()}};navigator.mediaDevices=navigator.mediaDevices?navigator.mediaDevices:{};navigator.getUserMedia=navigator.webkitGetUserMedia||navigator.mozGetUserMedia||navigator.msGetUserMedia;window.AudioContext=window.AudioContext||window.webkitAudioContext||window.mozAudioContext;(navigator.mediaDevices.getUserMedia||navigator.getUserMedia)&&window.AudioContext&&E()});