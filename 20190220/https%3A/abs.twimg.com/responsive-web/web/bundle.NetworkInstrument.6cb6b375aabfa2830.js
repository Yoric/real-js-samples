webpackJsonp(["bundle.NetworkInstrument"],{"7BPk":function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var r=n("Dd8w"),o=n.n(r),i=n("+6Bu"),s=n.n(i),a=n("Zrlr"),u=n.n(a),_=n("wxAW"),d=n.n(_),c=n("6Ew8"),p=n("d39v"),f=n("nb4O"),m=n.n(f),h=n("Y/fN"),l=n.n(h),v=n("mDUa"),w=n.n(v),y=n("BEDH"),g=n.n(y),k=[p.a.BadOauthToken,p.a.OauthTimestampException,p.a.BadAuthenticationData,p.a.AccessDeniedByBouncer],E=function(){function e(t,n){var r=this;u()(this,e),this.scribeRequest=function(e){var t=e.response,n=e.error,o=s()(e,["error"]),i=new window.URL(o.url);if(n){if(!(n instanceof c.a))return;t={status:n.status}}if(0!==i.pathname.indexOf("/1.1/jot")){r._flushResourceTimingBuffer();var a=l()(r._buffer,function(e){var t=e.request;return i.protocol===t.uri_scheme&&i.hostname===t.uri_host_name&&i.pathname===t.uri_path&&(i.query||"")===t.uri_query});if(a){var u=r._buffer.indexOf(a);r._buffer[u]=r._updateEventWithRequestResponse(a,o,t,n)}else{var _=r._updateEventWithRequestResponse(r._prepareEvent(o.url),o,t,n);r._buffer.push(_)}r._flushBuffer()}},this._flushResourceTimingBuffer=function(){if(r._resourceTimingApiSupported){var e=window.performance.getEntriesByType("resource");window.performance.clearResourceTimings(),e.forEach(function(e){var t=r._updateEventWithPrecisionTimings(r._prepareEvent(e.name),e);r._buffer.push(t)})}},this._updateNetworkInfo=function(e){r._networkInfo=e},this._getNetworkMeasurements=function(){return{connection_type:r._networkInfo.type||"unknown",speed_class:r._networkInfo.effectiveType,download_mbps:r._networkInfo.downlink,download_max_mbps:r._networkInfo.downlinkMax,rtt_ms:r._networkInfo.rtt,reduced_data_usage:r._networkInfo.saveData}},this._resourceTimingApiSupported=window.performance&&window.performance.getEntriesByType&&window.performance.getEntriesByType("resource")&&window.performance.clearResourceTimings,this._scribe=t,this._options=o()({apiErrorSampleSize:0,apiSampleSize:0,cdnSampleSize:0,cdnHostList:[]},n),this._buffer=[],this._networkInfo={},g.a.getConnectionInfo().then(function(e){r._updateNetworkInfo(e),g.a.addEventListener("connectionChange",r._updateNetworkInfo)}),this._resourceTimingApiSupported&&(window.performance.onresourcetimingbufferfull=this._flushResourceTimingBuffer)}return d()(e,[{key:"_flushBuffer",value:function(){var e=this;this._buffer.splice(0,this._buffer.length).forEach(function(t){e._sample(t)&&e._scribe.log(null,t)})}},{key:"_sample",value:function(e){var t=e.event_type,n={"api:all":"apiSampleSize","api:error":"apiErrorSampleSize","cdn:all":"cdnSampleSize"},r=this._options[n[t]]||0;return Math.random()<r}},{key:"_getEventType",value:function(e,t){return this._options.cdnHostList.indexOf(e)>-1?"cdn:all":t>=200&&t<300?"api:all":"api:error"}},{key:"_prepareEvent",value:function(e){var t=new window.URL(e),n="api.twitter.com"===t.hostname;return{_category_:"client_network_request_event",request:{uri_scheme:t.protocol,uri_host_name:t.hostname,uri_path:t.pathname,uri_query:t.query||"",http_method:"GET",http_status_code:n?0:200,start_time_ms:Date.now(),request_details:{duration_ms:0}},common_header:{commonHeader:{clientHeader:{timestampMs:Date.now(),timezoneOffsetMin:-(new Date).getTimezoneOffset()}}},network_measurements:this._getNetworkMeasurements(),event_type:this._getEventType(t.hostname,200),event_source:"rweb"}}},{key:"_extractApiErrorCode",value:function(e){var t=e.errors,n=void 0===t?[]:t,r=n.map(function(e){return e.code}).filter(function(e){return void 0!==e}),o=m()(r,function(e){return k.indexOf(e)>-1});return o||(r.length>0?r[0]:void 0)}},{key:"_updateEventWithRequestResponse",value:function(e,t,n,r){var i=e.request.request_details;return o()({},e,{request:o()({},e.request,{http_method:t.method,http_status_code:n.status,start_time_ms:t.startTimestamp,trace_id:t.headers["x-b3-traceid"],twitter_api_error_code:r&&this._extractApiErrorCode(r)||void 0,request_details:o()({},i,{duration_ms:i.duration_ms||t.endTimestamp-t.startTimestamp,request_body_size:i.request_body_size||(t.data?t.data.length:void 0),response_body_size:i.response_body_size||(n&&n.body?n.body.length:void 0)})}),event_type:this._getEventType(e.request.uri_host_name,n.status)})}},{key:"_getTiming",value:function(e,t){return w()(e)&&w()(t)?Math.round(t-e):void 0}},{key:"_updateEventWithPrecisionTimings",value:function(e,t){return o()({},e,{request:o()({},e.request,{request_details:o()({},e.request.request_details,{duration_ms:Math.round(t.responseEnd-t.fetchStart),rx_bytes:t.transferSize,dns_ms:this._getTiming(t.domainLookupStart,t.domainLookupEnd),tcp_ms:this._getTiming(t.connectStart,t.connectEnd),tls_ms:0===t.secureConnectionStart?void 0:Math.round(t.connectEnd-t.secureConnectionStart),response_body_size:t.decodedBodySize})})})}}]),e}();t.default=E}});
//# sourceMappingURL=https://ton.smf1.twitter.com/twitter_shared_private/twitter_lite/sourcemaps/web/bundle.NetworkInstrument.6cb6b375aabfa2830.js.map