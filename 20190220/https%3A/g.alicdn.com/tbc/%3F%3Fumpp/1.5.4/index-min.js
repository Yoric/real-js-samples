/*! umpp 2015-08-03 */
KISSY.add("tbc/umpp/1.5.4/mods/messenger",function(a,b,c,d){function e(a,b){return u.push([a,b])-1}function f(a){return u[a]=null}function g(c,e,f){var g={type:c,content:e},h=f;if(a.isString(f)?(h=b.get("#"+f),f=h.contentWindow):f.contentWindow&&(f=f.contentWindow),l())try{return f.KISSY.TBC.Messenger.fire(c,e)}catch(i){}p?m&&(m.callSWF?m.callSWF("send",[g,k(h)]):m.send(g,k(h))):f.postMessage(d.stringify(g),"*")}function h(b,c){a.each(u,function(a){a&&a[0]===b&&a[1](c)})}function i(c,d){var e,f=(p?"parentFlash="+x+"&childFlash=_MessengerChildFlash_"+a.now()+"&":"")+"domain=taobao.org";a.isString(c)?(e=c,c={}):e=c.src,c.src=e+(e.indexOf("?")>-1?"&":"?")+f;var g=b.create("<iframe>",c);return g.setAttribute("width",1),g.setAttribute("height",1),g.style.position="absolute",b.get(d||"body").appendChild(g)}function j(a,b){v?i(a,b):w.push([a,b])}function k(a){var b=a.src,c=/childFlash=([^&]+)/;if(b){var d=b.match(c);if(d&&d[1])return d[1];throw"iframe has no flashName param"}}function l(){return!1}var m,n=window,o=a.namespace("KISSY.TBC.Messenger",parseFloat(a.version)<6?!0:window),p=(document.domain,"undefined"==typeof postMessage||!n.addEventListener),q=-1===location.host.indexOf("daily")&&-1===location.host.indexOf("net"),r="//"+(q?"g.alicdn.com":"assets.daily.taobao.net/g"),s="1.5.4",t=parseFloat(s)?r+"/tbc/umpp/"+s+"/flash-post-message.swf":"flash-post-message.swf",u=[],v=!p,w=[],x="_MessengerFlash_"+a.now();if(!l()||p)if(p){var y=parseFloat(a.version),z=6>y,A=!(1.2>=y||y>=1.4)||!z;a.use(A?z?"swf":"kg/swf/0.0.1/index":"flash",function(a,b){window._Messenger_Flash_PostMessage=function(a,b){var c=b.type,d=b.msg;if("swfReady"===c){v=!0;for(var e;e=w.pop();)i.apply(null,e)}else"message"==c&&d&&h(d.type,d.content)};var c={src:t,attrs:{width:1,height:1,style:"position:absolute;top:0",id:"umpp-message-id",name:"umpp-message-name"},params:{flashVars:{jsentry:"_Messenger_Flash_PostMessage",swfid:"J_MessengerFlashPostMessage",name:x},allowscriptaccess:"always"}};b&&A?m=new b(c):a.Flash&&a.Flash.add&&a.Flash.add("#J_FlashPostMessageContainer",c,function(a){m=a.swf})})}else n.addEventListener("message",function(b){var c=b.data;if(c&&a.isString(c))try{var e=d.parse(c);h(e.type,e.content)}catch(f){}},!1);else v=!0;return a.mix(o,{register:e,unregister:f,send:g,createIframe:j,fire:h,flashName:x})},{requires:["dom","event","json"]}),KISSY.add("tbc/umpp/1.5.4/mods/getNick",function(a,b){var c=a.namespace("KISSY.TBC.umpp",parseFloat(a.version)<6?!0:window);return c.getNick=function(a){var c=b.get("_nk_")||b.get("lgc");return a&&c?encodeURIComponent(unescape(c.replace(/\\u/g,"%u"))):c}},{requires:["cookie"]}),KISSY.add("tbc/umpp/1.5.4/mods/trinity",function(a,b){function c(a,b,c){this.nick=a||"umpp-guest",this.swfurl=b,this.evs=c,this._init()}var d=a.namespace("KISSY.TBC.umpp",parseFloat(a.version)<6?!0:window),e="UM_",f=window,g="J_UmppUserContainer",h="_umpp_trinity_",i=c.prototype;return i._init=function(){var c=this,d={src:c.swfurl,attrs:{width:1,height:1,id:"umpp-trinity-id",name:"umpp-trinity-name"},params:{flashVars:{jsentry:h,swfid:e+c.nick+a.now(),group:c.nick},allowscriptaccess:"always"}};f[h]=function(a,b){var d=b.type,e=b.data,f=c.evs,g=f[d];g&&g.call(c,"message"===d?e:null)};var i=parseFloat(a.version),j=6>i,k=!(1.2>=i||i>=1.4)||!j;a.use(k?j?"swf":"kg/swf/0.0.1/index":"flash",function(a,e){k&&e?c.swf=new e(d):a.Flash&&a.Flash.add&&(b.get("#"+g)||document.body.appendChild(b.create('<div id="'+g+'" style="height:1px;width:1px;overflow:hidden;position:absolute;bottom:1px"></div>')),a.Flash.add("#"+g,d,function(a){c.swf=a.swf}))})},i.fire=function(a,b){return this.swf.callSWF?this.swf.callSWF("fire",[a,b]):(this.swf.fire(a,b),void 0)},i.destroy=function(){var a=this;try{a.swf.destroy?a.swf.destroy():b.remove("#"+g),delete f[h]}catch(c){}},d.Trinity=c},{requires:["dom"]}),KISSY.add("tbc/umpp/1.5.4/mods/initGuest",function(a){function b(b,f,g){return e._guestTimer=setTimeout(function(){a.getScript(parseFloat(c)?f+"/tbc/umpp/"+c+"/guest-min.js":"guest.js",function(){parseFloat(a.version,10)>1.1&&a.use(parseFloat(c)?"tbc/umpp/"+c+"/guest":"tbc/umpp/guest")})},d),a.mix(e,{isOnline:b,cdnPath:f,Trinity:g}),e}var c="1.5.4",d=18e4,e=a.namespace("KISSY.TBC.umpp",parseFloat(a.version)<6?!0:window);return a.mix(e,{register:function(){},send:function(){},destroy:function(){this.trinity&&(this.trinity.destroy(),delete this.trinity),this._guestTimer&&(clearTimeout(this._guestTimer),this._guestTimer=null)}}),e.initGuest=b}),KISSY.add("tbc/umpp/1.5.4/mods/initUser",function(a,b,c,d){function e(b){var d=/onerror|onload|script|svg|eval|function/gi;if(a.isString(b))return b.replace(d,"_");if(a.isObject(b)){for(var e in b)a.isString(b[1])&&(b[e]=b[e].replace(d,"_"));return b}return a.isArray(b)?(b=c.stringify(b).replace(d,"_"),c.parse(b)):b}function f(a){b.get("#"+s)||r.createIframe({src:a,id:s,frameborder:0,scrolling:"no"})}function g(b){a.isArray(b)&&b.length&&a.each(b,function(a){"1063"==a.t1&&w.trinity.fire({content:[a],identity:[w.nick,a.t1,"1"].join("-")})})}function h(){r.register("umppready",function(){p=!0,j("master"),j("join")}),r.register("umppdata",function(b){if(a.isArray(b))for(var c=b.length,d=0;c>d;d++){var e=b[d];e.content&&a.isString(e.content)&&(e.content=e.content.replace(/"/g,x))}w.notify(b,!0),g(b)})}function i(b,d){if(!d)return!1;a.isString(d)&&(d=c.parse(decodeURI(d)));var e=d.body,f=e.content;if(a.isObject(e))if("-"===e.identity)a.each(f,function(b){a.each(w._Events,function(c){c&&b.t1==c[0]&&(b.content&&a.isString(b.content)&&(b.content=b.content.replace(new RegExp(x,"g"),'"')),c[1](b))})});else if(t===e.type)if(n){var g=f[0],h=f[1];"umpp-store-get"===g?w.getItem(h,function(a){b.fire.call(b,{type:t,content:[h,a]},d.from)}):"umpp-store-remove"===g?w.removeItem.call(w,h):"umpp-store-set"===g?w.setItem.apply(w,h):w.send(g,h)}else{var f=e.content;r.fire("umpp-store-get-"+f[0],f[1])}else if(u===e.type){if(!e.includeSelf&&d.from===d.to)return!1;j("message",e.content)}}function j(b,c){a.each(w._SwfEvents,function(a){a&&b===a[0]&&(a[1](c),"message"!==b&&(a[0]=b+"_ed"))})}function k(a){f("//mpp."+(a?"taobao.com":"daily.taobao.net")+"/ajaxconn2.html?appId="+v),p&&j("master")}function l(a,b,c,e){w.trinity=new a(b,c,{master:function(){n=!0,h(),new d({url:location.protocol+"//allot-mpp."+(e?"taobao.com":"daily.taobao.net")+"/allot.do?appId="+v,dataType:"jsonp",timeout:3,success:function(a){if(a&&0==a.code){var b=a.tn?a[a.tn]:a.token;b&&(b="&"+(a.tn?a.tn:"token")+"="+b),f("//"+a.host+"/ajaxconn2.html?appId="+v+b),p&&j("master")}else a&&1111==a.status&&k(e)},error:function(){k(e)}})},join:function(){o=!0,(n&&p||!n)&&j("join")},message:function(a){i(this,a)}})}function m(a,b,c,d,e){var f=parseFloat(q)?b+"/tbc/umpp/1.4.35/trinity.swf":"trinity.swf";return w.nick=c,l(d,c,f,a),w.on("join",function(){new e({mc:w})}),w}var n,o,p,q="1.5.4",r=a.TBC.Messenger,s="J_Um_Iframe",t="_trinity_notify_private",u="_trinity_notify_public",v=-1===location.host.indexOf("meeting.wangwang")?1064:1065,w=a.namespace("KISSY.TBC.umpp",parseFloat(a.version)<6?!0:window),x="@1fuck1@";return a.mix(w,{_Events:[],_SwfEvents:[],_StoreCache:{},_storeData:function(a,b){n&&(this._StoreCache[a]=b)},_removeData:function(a){n&&this._StoreCache[a]&&delete this._StoreCache[a]},on:function(a,b){return(n&&p||!n&&o)&&("master"===a&&n||"join"===a&&o)?(b(),!0):this._SwfEvents.push([a,b])-1},off:function(b){return a.isNumber(b)?this._SwfEvents[b]=null:void 0},register:function(a,b,c){var d=this,f=function(f,g){f&&(f=e(f)),b(f,g),c?d._storeData(a,f):d.removeItem(a)};return d.getItem(a,function(a){a&&f(a,!0)}),d._Events.push([a,f])-1},unregister:function(a){return this._Events[a]=null},send:function(a,b){return n?r.send.call(null,a,b,s):(this.trinity&&this.trinity.fire({type:t,content:[a,b]},"_"+this.nick),void 0)},notify:function(a,b){return this.trinity.fire({type:u,content:a,includeSelf:b,identity:"-"})},setItem:function(a,b){var c=this;c.on("join",function(){c._storeData(a,b),c.send("umpp-store-set",[a,b])})},getItem:function(a,b){var c=this,d=this._StoreCache[a];n&&d?b(d):c.on("join",function(){var d=r.register("umpp-store-get-"+a,function(e){r.unregister(d),c._storeData(a,e),b(e)});c.send("umpp-store-get",a)})},removeItem:function(a){var b=this;b.on("join",function(){b._removeData(a),b.send("umpp-store-remove",a)})},clear:function(a){return this.send("clearTMsg",a)},destroy:function(){this.trinity&&(this.trinity.destroy(),delete this.trinity),b.remove("#"+s),n=void 0,o=void 0,p=void 0,this._StoreCache={}}}),w.initUser=m},{requires:["dom","json","ajax"]}),KISSY.add("tbc/umpp/1.5.4/mods/monitorevent",function(a,b){function c(b){this.cfg=a.merge({delay:2e4},b||{}),this.status=1,this._init()}return a.mix(c.prototype,{get:function(a){return this.cfg[a]},set:function(a,b){this.cfg[a]=b},_init:function(){var b=window.g_config;return b?!b.appId||1!=b.appId&&1009!=b.appId?!1:(this.itemId=b.itemId,this.itemId?(this.activeTime=a.now(),this.cfg.mc.send("umpp-monitor-event",[this.itemId,1,this.activeTime].join(",")),this.timer=null,this._bindEvent(),this._addTimer(),this._registerUmppEvent(),void 0):!1):!1},_bindEvent:function(){var a=this;b.on(window,"focus",function(){a._active.call(a),a._focus.call(a)}),b.on(window,"blur",function(){a._active.call(a),a._blur.call(a,!0)}),b.on(window,"mousemove scroll",function(){a._active.call(a)}),b.on(window,"beforeunload",function(){a._close.call(this)})},_registerUmppEvent:function(){var a=this,b=a.cfg.mc;b.register("monitor-start",function(){a.start.call(a)}),b.register("monitor-focustime",function(b){a.set.call(a,"delay",1e3*b.focustime)})},_focus:function(){this.set("focusbluring",!1),this.status&&(this._removeTimer(),this.timer||this._addTimer(),this.cfg.mc.send("umpp-monitor-event",[this.itemId,2,a.now()].join(",")))},_blur:function(b){this.set("focusbluring",!1),this.status&&(b&&this._removeTimer(),this.cfg.mc.send("umpp-monitor-event",[this.itemId,3,a.now()].join(",")))},_active:function(){this.activeTime=a.now()},_close:function(){this.status&&this.cfg.mc.send("umpp-monitor-event",[this.itemId,4,a.now()].join(","))},_addTimer:function(){var b=this;b.timer=setTimeout(function(){var c=a.now();c-b.activeTime>b.cfg.delay&&!b.get("focusbluring")&&(b._blur(),b.set("focusbluring",!0)),b.timer=setTimeout(arguments.callee,b.cfg.delay)},b.cfg.delay)},_removeTimer:function(){this.timer&&(clearTimeout(this.timer),this.timer=null)}}),c},{requires:["event"]}),KISSY.add("tbc/umpp/1.5.4/index",function(a,b,c,d,e,f,g,h){function i(){var c,d=-1===location.host.indexOf("daily"),e=b.get("_l_g_")||b.get("lgc"),f=location.protocol+"//"+(d?"g.alicdn.com":"assets.daily.taobao.net/g"),g=j._Events,i=j._SwfEvents;return c=e?j.initUser(d,f,j.getNick(!0),j.Trinity,h):j.initGuest(d,f,j.Trinity),g&&a.mix(c,{_Events:g}),i&&a.mix(c,{_SwfEvents:i}),a.mix(j,c)}a.version>=1.4&&a.config({modules:{ajax:{alias:["io"]},flash:{alias:["gallery/flash/1.0/"]}}});var j=a.namespace("KISSY.TBC.umpp",parseFloat(a.version)<6?!0:window);return j.init=i,i()},{requires:["cookie","tbc/umpp/1.5.4/mods/messenger","tbc/umpp/1.5.4/mods/getNick","tbc/umpp/1.5.4/mods/trinity","tbc/umpp/1.5.4/mods/initGuest","tbc/umpp/1.5.4/mods/initUser","tbc/umpp/1.5.4/mods/monitorevent"]});