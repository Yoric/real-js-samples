/*! search-suggest 2014-12-16 */
KISSY.add("tbc/search-suggest/1.3.9/mods/storage",function(a,b,c){function d(a){return e||(d.superclass.constructor.call(this,a||{}),e=this,e.initialize()),e}var e;return d.ATTRS={src:{value:location.protocol+"//g.alicdn.com/tbc/search-suggest/1.3.7/storage.swf"},bridge:{value:null},hasInit:{value:!1}},a.extend(d,b,{initialize:function(b){b=b||{};var c=this;try{c._addFlash(b.appendTo),c.hasInit=!0}catch(d){a.log(d.message)}},_saveToArr:function(a,b){var c=this.lazyArr||[];c.push({func:a,args:b}),this.lazyArr=c},_addFlash:function(b){var c,d=this,e=document,f=e.createElement("div"),g=d.get("src"),h="";window.__StorageIsReady=function(){d.isLoaded=!0;var b=d.lazyArr;a.each(b,function(a){a.func.apply(d,a.args)})},f.id="storagetool",f.style.height=0,f.style.overflow="hidden",h+='<object id="J_StorageObj" name="J_StorageObj" ',h+='classid="clsid:D27CDB6E-AE6D-11cf-96B8-444553540000" width="1" height="1" ',h+='codebase="http://fpdownload.macromedia.com/pub/shockwave/cabs/flash/swflash.cab">',h+='<param name="movie" value="'+g+'" />',h+='<param name="allowScriptAccess" value="always" />',h+='<embed name="J_StorageEmbed" src="'+g+'" width="1" height="1" ',h+='allowScriptAccess="always" type="application/x-shockwave-flash" ',h+='pluginspage="http://www.adobe.com/go/getflashplayer">',h+="</embed></object>",b=b||e.body,b.appendChild(f),f.innerHTML=h,-1!==navigator.appVersion.indexOf("MSIE")?(f.style.zoom=1,f.style.filter="alpha(opacity=10)",c=window.J_StorageObj):(f.style.opacity=.1,c=e.J_StorageEmbed),d.set("bridge",c)},save:function(a,b,d){var e=this,f=e.get("bridge");if(!e.isLoaded)return void e._saveToArr(arguments.callee,arguments);try{return f.save(a,b),f.read(a)?c.parse(f.read(a)).length:(d&&d.onSuccess(val),0)}catch(g){d&&d.onFailure&&d.onFailure(g)}},read:function(a,b,c){var d,e=this,f=e.get("bridge");if(c=c||0,!e.isLoaded)return void e._saveToArr(arguments.callee,arguments);try{if(f.read)d=f.read(a),b&&b.onSuccess(d);else{if(200===c)return void(b&&b.onFailure&&b.onFailure(g));setTimeout(function(){e.read(a,b,c+1)},500)}return d}catch(g){b&&b.onFailure&&b.onFailure(g)}}}),d},{requires:["base","json"]}),KISSY.add("tbc/search-suggest/1.3.9/mods/local-query",function(a,b,c,d,e){function f(a){f.superclass.constructor.call(this,a||{}),this.initialize()}var g="localQuery";return a.extend(f,b,{initialize:function(){var a=this,b=a.get("name"),c=a.get("tab"),d=a.get("user");"item"===c&&(c="baobei"),a.storageKey=g+b+c+d,a._getStorage()},checkFlash:function(a){this.storage.read(a)},_setKey:function(a){var b=this,c=a.name||b.get("name"),d=a.tab||b.get("tab"),e=a.user||b.get("user");"item"===d&&(d="baobei"),b.storageKey=g+c+d+e,b.set("tab",d),b.set("name",c),b.set("user",e),this.datalist=null},_save:function(b,c){if(!b.match(/<>'"/)&&!c.match(/<>'"/)){var d=this._getDatalist(),e=encodeURIComponent(b),f={key:e,value:encodeURIComponent(c),time:a.now()};this._deleteItemByValue(d,e),d.unshift(f)}},_deleteItemByValue:function(a,b){for(var c,d=null,e=0;e<a.length;e++)c=a[e].key,c==b&&(d=a.splice(e,1),e--)},_query:function(b){var c,d,e=this._getDatalist(),f=[];return b?(b=encodeURIComponent(b),a.each(e,function(a){c=a.key,d=a.value,(0===c.indexOf(b)||0===d.indexOf(b))&&f.push(a)}),this._distinctByValue(f)):this._distinctByValue(e)},_distinctByValue:function(a){for(var b,c=[],d=0,e=a.length;e>d;d++)b=a[d],b.value.match(/%3C|%3E|[<>'"]/g)||!this._hasItemOfValue(c,b.value)&&c.push(b);return c},_hasItemOfValue:function(a,b){for(var c=!1,d=a.length-1;d>=0;d--)a[d].value===b&&(c=!0);return c},_cleanBefore:function(a){for(var b,c=this._getDatalist(),d=0,e=c.length-1;e>=0;e--)if(b=c[e],b.time>a){d=e+1;break}c.length=d},_getDatalist:function(){return this.datalist||(this.datalist=this.storage.read()||[]),this.datalist},_getStorage:function(){var a=this.get("storageType");switch(a){case"flashStorage":this.storage=this._initFlashStorage();break;default:this.storage=!1}},_initFlashStorage:function(){var a=this;return{save:function(){return(new d).save(a.storageKey,c.stringify(a.datalist))},read:function(b){var f=(new d).read(a.storageKey,b);if(f){var g=c.parse(f);return g}return e}}},destructor:function(){this.datalist=null,g=null},save:function(b,c){if(""!=c){var d,e=this.storage.read();e&&(d=e.length);var f=this._save(b,c),g=this.storage.save();return d>300&&(this.datalist=this.datalist.slice(0,d-10),a.log("add_before\n"+g+"\n"+d),g=this.storage.save(),a.log("add_after\n"+g+"\n"+d)),f}},query:function(a){return this._query(a)},deleteItem:function(b){var c=this._getDatalist(),d=c.length;this._deleteItemByValue(c,encodeURIComponent(b));var e=this.storage.save();d>300&&(this.datalist=this.datalist.slice(0,d-10),e=this.storage.save(),a.log("delete\n"+e+"\n"+d))},clearByDay:function(b){var c=a.now()-24*b*3600*1e3;this._cleanBefore(c),this.storage.save()},hasHistory:function(){return this._getDatalist().length>0?!0:!1}},{ATTRS:{name:{value:"default",setter:function(a){return a}},user:{value:"",setter:function(b){return a.fromUnicode(b)}},maxLength:{value:500},storageType:{value:"flashStorage",setter:function(a){return a},getter:function(a){return a}}}}),f},{requires:["base","json","tbc/search-suggest/1.3.9/mods/storage"]}),KISSY.add("tbc/search-suggest/1.3.9/plugin/history",function(a,b,c,d){function e(b){e.superclass.constructor.call(this,b||{}),a.sug=a.bind(this._retSug,this)}var f;return a.extend(e,b,{pluginInitializer:function(b){var c=this,e=b.get("sugConfig"),g=e.tab||"";f=b.Stat,b.set("extend",{history:!0}),c.set("caller",b),c.localQueryMap={},c.localQueryPinyingMap={},c.historyLocalQuery=c.localQueryMap[g]=new d({name:"history",tab:g,user:b.getNick()}),c.pinyingLocalQuery=c.localQueryPinyingMap[g]=new d({name:"pinyin",tab:g,user:b.getNick()}),c.hitedHistoryListMap={};var h=b.comboBox;setTimeout(function(){c.historyLocalQuery.checkFlash({onSuccess:function(){c.historyReady=!0,h.on("afterCollapsedChange",function(a){if(!a.newVal){h.detach("afterCollapsedChange",arguments.callee);var b=h.get("menu").get("el");b.delegate("mousedown","."+e.prefixCls+"menu-history-delete",c._historyDeleteMousedown,c)}}),b.on("beforeSubmit",function(b){var d=h.get("input").val(),e=b.isNotSave;""===a.trim(d)||d.match(/[<>'"]/g)||c.pinyingLocalQuery&&!e&&c.pinyingLocalQuery.save(d,a.trim(d))}),setTimeout(function(){c._getPinyinQuery()},1e3)},onFailure:function(){a.log("loading flashStorage failure!")}})},500)},_dealUrl:function(a,b){var c="&area=history",d=a.indexOf(c)>-1;return b?!d&&a+c:d&&a.replace(c,"")},_getPinyinQuery:function(){var b=this,c=b.historyLocalQuery,d=b.pinyingLocalQuery.query();if(d.length>0){var e=decodeURIComponent(d[0].key);/[\u4e00-\u9fa5]/.test(e)?(b._getPinyin(d[0].key),b.pinyingLocalQuery.clearByDay(0)):(b.pinyingLocalQuery.clearByDay(0),c.save(e,a.trim(e)))}},_renderHTML:function(b,c){var d,e=this,f=e.get("caller"),g="",h=f.get("mods").history.tmpl,c=c||{},i=f.resultArr||(f.resultArr=[]),j=[];b=a.unique(b);for(var k=0,l=b.length-1;l>=k;k++)0!==k&&(c.attr=""),c.index=(k+1).toString(),c.historyItemValue=decodeURIComponent(b[k].key),c.historyItemQuery=b[k].key,g=a.substitute(h,c),d=c.historyItemValue,j.push(d),i.push({content:g,textContent:d,unique:!0});f.historyArr=j},renderPlugin:function(){if(this.historyReady){var a,b,c=this,d=c.get("caller"),e=d.query,f=c.historyLocalQuery.query(e),g=c.get("limit"),h=d.get("sugConfig"),i=d.comboBox.get("dataSource"),j=i.extraData&&i.extraData[e];if(c.get("web")&&""===e&&j&&j.cloud)return void c._renderHTML(j.cloud,{prefixCls:h.prefixCls});""===e&&f.length>0?(d.__header={tmpl:'<div class="history-box"><span>\u6700\u8fd1\u641c\u8fc7</span></div>',type:"history"},d.__footer=null,a=g):(d.__header=null,d.__footer=null,a=2),b=f.splice(0,a),d._addExtraEvent(),c._renderHistoryItems(b),c.hitedHistoryListMap[e]=b}},_historyDeleteMousedown:function(b){for(var c=this,d=c.get("caller"),e=a.one(b.target),f=e.parent().attr("data-value"),g=e.parent(2),h=d.comboBox,i=h.get("menu"),j=i.get("children"),k=e.attr("data-type"),l=0;l<j.length;l++){var m=j[l];if(m.get("el")[0]===g[0]){i.removeChild(m,!0);break}}var n=c.historyLocalQuery;n&&("history"===k?n.deleteItem(f):"most"===k&&(n._setKey({name:"most"}),n.save(f,f),n._setKey({name:"history"}))),h.sendRequest(d.query),c._sendStat(f)},_sendStat:function(b){var c,d=this.get("caller"),e={},g=location.hostname,h="op=del&nk={nick}&src={host}&q={query}&app=sug";e.nick=d.getNick(),e.query=b,e.host=g.replace(/com|\./g,""),c=a.substitute(h,e),f&&f.send(c)},_renderHistoryItems:function(a,b){var c=this,d={},e=c.get("caller"),f=e.get("sugConfig");d.prefixCls=f.prefixCls,d.attr=b&&b.attr||"",d.extraParam=b&&b.param||"history",c._renderHTML(a,d)},_getPinyin:function(b){var c=this,d=location.protocol+"//suggest.taobao.com/sug?code=utf-8&area=py&callback=KISSY.sug&q="+b;c._savedInputValue=decodeURIComponent(b),a.getScript(d)},_retSug:function(b){if(b&&b.result){var c=b.result[0],d=this,e=d._savedInputValue;d.historyLocalQuery&&d.historyLocalQuery.save(e,a.trim(c))}},_cleanHistory:function(){var b=this,c=b.get("caller"),d=c.comboBox,e=d.get("menu"),f=e.get("el"),g=d.get("input"),h=c.get("sugConfig"),i=h.prefixCls,j=f.one("."+i+"combobox-menu-header");b.historyLocalQuery.clearByDay(0),b.hitedHistoryListMap={};var k=j.siblings();k.css("display","none"),j.html('<div class="history-box"><span>\u641c\u7d22\u5386\u53f2\u5df2\u6e05\u7a7a</span></div>');var l=new a.Anim(f,{opacity:0},3,"easeIn",function(){k.css("display","block"),f.css({opacity:1,visibility:"hidden"})});l.run(),g.on("blur keydown mousedown",function(a){l.isRunning()&&l.stop(!0),c.__header=null,c.__footer=null,"keydown"===a.type&&this.value&&f.css("visibility","visible"),g.detach("blur keydown mousedown",arguments.callee)})},update:function(a){var b=this,c=encodeURI(a.tab);b.localQueryMap[c]||(b.localQueryMap[c]=new d({name:"history",tab:c,user:b.get("caller").getNick()}),b.localQueryPinyingMap[c]=new d({name:"pinyin",tab:c,user:b.get("caller").getNick()})),b.pinyingLocalQuery=b.localQueryPinyingMap[c],b.historyLocalQuery=b.localQueryMap[c],b._getPinyinQuery()}},{ATTRS:{pluginId:{value:"history"},limit:{value:10,setter:function(b){return a.isNumber(b)?b:void 0}}}}),e},{requires:["base","event","tbc/search-suggest/1.3.9/mods/local-query"]});