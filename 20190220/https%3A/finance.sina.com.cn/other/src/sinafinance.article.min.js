/*http  to  https*/
String.prototype.toHttps = function(){return this.replace(/^http:\/\//,'//')};
/*右侧浮层工具*/
$('[node-type="toTop"]').on('click', function () {
    $('body,html').animate({scrollTop: 0}, 500);
});
$('[node-type="toRelated"]').on('click', function () {
    var _top = $('#tab_related').offset().top;
    $('body,html').animate({scrollTop: _top}, 500);
});
(function () {
    var _popdom = $('[node-type="audio-pop"]');
    if (_popdom.size()) {
        _popdom.on('mouseenter', function () {
            var _this = $(this),
                _pos = _this.attr('node-pop'),
                _l = _this.offset().left,
                _t = _this.offset().top,
                _w = _this.width(),
                _cls = ['pop-audio-drop'];
               var _url = '//comet.blog.sina.com.cn/qr?http://cj.sina.cn/article/norm_detail?url=' + encodeURIComponent(location.href) + '&part=1';
            $('.pop-audio-drop').remove();
            if (_pos == 'right') {
                var _ww = $(window).width() - _l - _w;
                if (_ww < 190) {
                    _cls.push('pop-audio-left')
                } else {
                    _cls.push('pop-audio-right')
                }
            }
            _cls = _cls.join(' ');
            var _left = _this.offset().left + (_this.width()) / 2 - 30;
            var _top = _this.offset().top + 34;
            var _codeId = 'audioCode' + +new Date();
            var _drop = $('<div><div class="audioCode" id="' + _codeId + '"></div><span class="qr-img-bg"></span></div>').addClass(_cls).css({
                'position': 'absolute',
                'z-index': 99999,
                'left': _left,
                'top': _top,
                'display': 'none'
            }).appendTo($('body')).fadeIn(400);
            var toutiaoUrl = 'http://cj.sina.com.cn/article/normal_detail?url=' + encodeURIComponent(location.href.split('?')[0]);
            if(window.FIN_ARTICLE_CODE){
                $('#' + _codeId).html(FIN_ARTICLE_CODE)
            } else {
                $.getScript('//n.sinaimg.cn/finance/home/jqueryqr.js?v=0917',function(){
                    var _options = {
                        "render": "div",
                        "fill": "#000000",
                        "background": "#ffffff",
                        "text": toutiaoUrl,
                        "size": 106,
                        "image": {},
                        "success" : function(){
                            window.FIN_ARTICLE_CODE = $('#' + _codeId).html();
                        }
                    };
                $('#' + _codeId).empty().qrcode(_options);
                });
            }
        }).on('mouseleave', function () {
            $('.pop-audio-drop').fadeOut(400);
        }).on('click', function (e) {
            //e.preventDefault();
        })
    }
})();
SinaPage.loadWidget({
    require: [
        {
            url: '//finance.sina.com.cn/other/src/pageTools.final.js'
        }
    ],
    onAfterLoad: function () {
        var getCookie = PageTool.utils.cookie.getCookie;
        var setCookie = PageTool.utils.cookie.setCookie;
        $('[event-toggle]').each(function () {
            var _this = $(this);
            var _name = _this.attr('event-toggle');
            var _showObj = _this.attr('is');
            var _cont = $('#' + _name);
            if (getCookie(_name) > 10000) {
                _cont.hide(0)
                _this.addClass('chide').text('展开');
                _showObj && ($('#' + _showObj).show());
            }
        })
        $('body').on('click', '[event-toggle]', function () {
            var _this = $(this),
                _cont = _this.attr('event-toggle'),
                _showObj = _this.attr('is'),
                obj = $('#' + _cont);
            if (_cont && obj[0]) {
                if (obj.css('display') == 'none') {
                    obj.stop().slideDown(300);
                    _this.removeClass('chide').text('收起');
                    _showObj && ($('#' + _showObj).hide());
                    setCookie(_cont, 0, '', '/')
                } else {
                    obj.stop().slideUp(300);
                    _this.addClass('chide').text('展开');
                    _showObj && ($('#' + _showObj).show());
                    setCookie(_cont, +new Date(), '', '/')
                }
            }
        })
    }
});

$(window).on('scroll', function () {
    //var self = obj;
    var _top = $(document).scrollTop();
    if (_top >= 800) {
        $('[node-type="toTop"]').removeClass('fadeOut');
    } else {
        $('[node-type="toTop"]').addClass('fadeOut');
    }
});

/*正文页吸顶工具栏*/
if (document.getElementById('top_bar_wrap')) {
    SinaPage.loadWidget({
        trigger: {
            id: 'top_bar_wrap'
        },
        require: [
            {
                url: '//finance.sina.com.cn/other/src/pageTools.final.js'
                //url:'../js/base/pageTools.js'
            }
        ],
        triggerAhead: false,
        onAfterLoad: function () {
            //console.log(this)

            new PageTool.SetScrollFixed({
                wrap: 'top_bar',//吸顶的元素id
                start: 'top_bar_wrap',//跟随滚动元素外层id
                end: 'article-bottom',//结束滚动元素id
                fixedClass: 'top-bar-fixed'//吸顶的class
            });
        }
    });
}
/*字体控制-分享-收藏*/
SinaPage.loadWidget({
    require: [
        {
            url: '//finance.sina.com.cn/other/src/pageTools.final.js'
        },
        {
            url: '//n.sinaimg.cn/finance/fe/share.min.js'
        }
    ],
    onAfterLoad: function () {
        new PageTool.FontAdjustor();//字体调节
        new PageTool.AddFavorite({//添加收藏
            docid: SINA_TEXT_PAGE_INFO.docID
        });
        /*new PageTool.AddAniByAttr({//按钮动画
         attr : 'ani-hover',
         event : 'mouseover',
         aniClass:'ani',
         disableClass:'disable',
         onClick:function(){},
         onAnimationEnd:function(){}

         });*/
        //分享
        var shareImg = document.getElementById('artibody') && document.getElementById('artibody').getElementsByTagName('img')[0];
        var shareTitle = $('.main-title').html().replace(/<[^<>]*?font[^<>]*?>/gi, '');
        var pcUrl = window.location.href.split('?')[0];
        var toutiaoUrl = 'http://cj.sina.com.cn/article/normal_detail?url=' + encodeURIComponent(pcUrl);

        //为文章顶部的分享按钮配置share组件
        var topShare = new FnShare('#top_bar', {
            url: pcUrl,
            wxurl: toutiaoUrl,
            img: shareImg ? shareImg.src : '',
            title: shareTitle,
            security: 'http'
        });
        //点击评论按钮跳到屏幕组件
        $('[node-type="comment"]').on('click', function () {
            var _cmtTop = $('#bottom_sina_comment').offset().top
            $('body,html').animate({scrollTop: _cmtTop}, 500);
        });
    }
});
//顶部搜索

// 正文下方slide article-botton-slide
if ($('#article-botton-slide a').size() > 1) {
    var _randNumer = Math.floor($('#article-botton-slide a').size() * Math.random());
    SinaPage.loadWidget({
        require: [{
            url: '//n.sinaimg.cn/finance/fe/slider-min.js'
        }],
        onAfterLoad: function () {
            $('#article-botton-slide').show(0);
            window.artice_bottom_slider = new Slider({
                wrap: "article-botton-slide",
                itemClass: "slider-item",
                startOn: _randNumer || 0,
                slideBy: 1,
                speed: 3,
                isVertical: !0,
                isLoop: !0,
                autoPlay: !1,
                autoInterval: 5,
                onReady: function () {
                    for (var e = this.states.total / 2, t = this._id("artice_bottom_slider_dot"), a = "", r = 0; r < e; r++)
                        a += '<p class="' + (0 == r ? "cur" : "") + '" onmouseover="window.artice_bottom_slider.slideTo(' + r + ')"><span></span></p>';
                    t.innerHTML = a, this.doms.dots = t.getElementsByTagName("p"), t.style.display = "block"
                },
                onIndexChanged: function (e) {
                    for (var t = this.doms.dots, a = this.states.total / 2, r = 0; r < a; r++)t[r].className = "";
                    t[e % a].className = "cur"
                }
            })
            // _randNumer && window.artice_bottom_slider.slideTo(_randNumer);
        }
    });

} else {
    $('#article-botton-slide').show(0);
}
// 正文下方slide article-botton-slide  end
SinaPage.loadWidget({
    require: [{
        url: '//n.sinaimg.cn/ent/mainpage/js/pl/DivSelect.js'
    }, {
        // url: '//n.sinaimg.cn/finance/page2017/js/suggesServer.js'
        url: '//finance.sina.com.cn/common/js/hq-suggest.js'
    }],
    onAfterLoad: function () {
        new DivSelect('search_type', 'search_type_div');
        var _searchLanguageOption = {
            'cn': {
                // 'ov' : '简称/代码/拼音',
                // 'head' : ['选项', '类型', '代码', '中文名称'],
                // 'shead' : ['选项', '代码', '名称'],
                // 'phtxt' : '请输入关键字'
                'ov': '\u7B80\u79F0/\u4EE3\u7801/\u62FC\u97F3',
                'head': ['\u9009\u9879', '\u7C7B\u578B', '\u4EE3\u7801', '\u4E2D\u6587\u540D\u79F0'],
                'shead': ['\u9009\u9879', '\u4EE3\u7801', '\u540D\u79F0'],
                'phtxt': '\u8BF7\u8F93\u5165\u5173\u952E\u5B57'
            }
        }
        var _searchText = _searchLanguageOption['cn'];
        var SuggestServer01 = new SuggestServer();
        SuggestServer01.bind({
            'input': 'search_input',
            'default': '',
            'type': '',
            'width': 320,
            'link': 'http://biz.finance.sina.com.cn/suggest/lookup_n.php?country=@type@&q=@code@',
            'head': _searchText.head, // ['选项', '类型', '代码', '中文名称']
            'body': [-1, -2, 2, 4],
            'target': '_self',
            'callback': function (data, type) {
                var type = this._getType(type['1'])
                var sel = document.getElementById('search_type')
                if (sel && (sel.selectedIndex == 0 || sel.selectedIndex == 3)) {
                    window.open('http://biz.finance.sina.com.cn/suggest/lookup_n.php?country=' + type + '&q=' + data)
                }

                if (sel && sel.selectedIndex == 4) {
                    // var type=this._getType(type["2"]);
                    window.open('http://stock.finance.sina.com.cn/thirdmarket/quotes/' + data + '.html')
                    //window.open('http://biz.finance.sina.com.cn/suggest/lookup_n.php?country=' + type + '&q=' + data);
                }

            },
            onshow: function () {
                SuggestServer01._elementContainer.style.left = '-68px';
                SuggestServer01._elementContainer.style.top = '-4px';
            }
        });
        var callSuda_finance = function (a, b) {

        }
        document.getElementById('search_type').onchange = function () {
            callSuda_finance('finance_index_shortlist', 'top_search_change')
            switch (this.selectedIndex) {
                case 0:
                    SuggestServer01.changeType('')
                    SuggestServer01.changeLink('http://biz.finance.sina.com.cn/suggest/lookup_n.php?country=@type@&q=@code@')
                    SuggestServer01._objectConfig['value'] = '@2@'
                    SuggestServer01._objectConfig['head'] = _searchText.head
                    SuggestServer01._objectConfig['body'] = [-1, -2, 2, 4]
                    SuggestServer01._stringOriginalValue = _searchText.ov
                    if (SuggestServer01._elementInput.value == _searchText.phtxt) {
                        SuggestServer01._elementInput.value = _searchText.ov
                    }
                    SuggestServer01.clear()
                    break
                case 1:
                    SuggestServer01.changeType('')
                    SuggestServer01.changeLink('http://guba.sina.com.cn/?s=bar&name=@code@')
                    SuggestServer01._objectConfig['value'] = '@2@'
                    SuggestServer01._objectConfig['head'] = _searchText.head
                    SuggestServer01._objectConfig['body'] = [-1, -2, 2, 4]
                    SuggestServer01._stringOriginalValue = _searchText.ov
                    if (SuggestServer01._elementInput.value == _searchText.phtxt) {
                        SuggestServer01._elementInput.value = _searchText.ov
                    }
                    SuggestServer01.clear()
                    break
                case 2:
                    SuggestServer01.changeType('')
                    SuggestServer01.changeLink('http://search.sina.com.cn/?range=all&c=news&col=1_7&q=@4@')
                    SuggestServer01._objectConfig['value'] = '@4@'
                    SuggestServer01._objectConfig['head'] = _searchText.head
                    SuggestServer01._objectConfig['body'] = [-1, -2, 2, 4]
                    SuggestServer01._stringOriginalValue = _searchText.phtxt
                    if (SuggestServer01._elementInput.value == _searchText.ov) {
                        SuggestServer01._elementInput.value = _searchText.phtxt
                    }
                    SuggestServer01.clear()
                    break
                case 3:
                    SuggestServer01.changeType('7')
                    SuggestServer01.changeLink('http://biz.finance.sina.com.cn/suggest/lookup_n.php?country=@type@&q=@code@')
                    SuggestServer01._objectConfig['value'] = '@2@'
                    SuggestServer01._objectConfig['head'] = _searchText.head
                    SuggestServer01._objectConfig['body'] = [-1, -2, 2, 4]
                    SuggestServer01._stringOriginalValue = _searchText.ov
                    if (SuggestServer01._elementInput.value == _searchText.phtxt) {
                        SuggestServer01._elementInput.value = _searchText.ov
                    }
                    SuggestServer01.clear()
                    break
                case 4:
                    SuggestServer01.changeType('73')
                    SuggestServer01.changeLink('http://stock.finance.sina.com.cn/thirdmarket/quotes/@code@.html')
                    SuggestServer01._objectConfig['value'] = '@3@'
                    SuggestServer01._objectConfig['head'] = _searchText.shead
                    SuggestServer01._objectConfig['body'] = [-1, 2, 4]
                    SuggestServer01._stringOriginalValue = _searchText.ov
                    if (SuggestServer01._elementInput.value == _searchText.phtxt) {
                        SuggestServer01._elementInput.value = _searchText.ov
                    }
                    SuggestServer01.clear()
                    break
                default:
                    return
            }
        }

        window.changeViewInputs_0 = function (__elementSelect) {
            document.getElementById('search_input').value = _searchText.ov
            suggestServer_0 && suggestServer_0.changeType(__elementSelect.value)
        }

        window.checkFormSuggest_0 = function (__formSuggest) {
            __formSuggest['c'].value = 'all'
            var __stringCode = document.getElementById('search_input').value
            if (__stringCode != _searchText.ov && __stringCode != _searchText.phtxt && __stringCode != '') {
                var stringUrl = ''
                // 如果搜的是行情
                if (document.getElementById('search_type').selectedIndex == 0 || document.getElementById('search_type').selectedIndex == 3) {
                    stringUrl = 'http://biz.finance.sina.com.cn/suggest/lookup_n.php'
                    if (document.getElementById('search_type').selectedIndex == 3) {
                        __formSuggest['c'].value = 'forex'
                    }
                    // 如果suggest内容可见，且已经有使用键盘上下键在suggest list里选中，则不提交表单，改由suggest组件内部处理
                    try {
                        if (!$('#topSearch').find('table').is(':hidden') && $('#topSearch').find('tr').filter(function (i) {
                                if ($(this).css('background-color') == 'rgb(241, 245, 252)') {
                                    return true
                                }
                            }).length > 0) {
                            return false
                        }
                    } catch (e) {
                    }
                }
                if (document.getElementById('search_type').selectedIndex == 1) {
                    stringUrl = 'http://guba.sina.com.cn/bar.php'
                }
                if (document.getElementById('search_type').selectedIndex == 2) {
                    stringUrl = 'http://search.sina.com.cn/'
                    __formSuggest['c'].value = 'news'
                    __formSuggest['t'].value = ''
                }
                if (document.getElementById('search_type').selectedIndex == 4) {
                    //__formSuggest['c'].value='73';
                    stringUrl = 'http://biz.finance.sina.com.cn/suggest/lookup_n.php'
                    try {
                        if (!$('#topSearch').find('table').is(':hidden') && $('#topSearch').find('tr').filter(function (i) {
                                if ($(this).css('background-color') == 'rgb(241, 245, 252)') {
                                    return true
                                }
                            }).length > 0) {
                            return false
                        }
                    } catch (e) {
                    }

                }
                __formSuggest.action = stringUrl
                __formSuggest['name'].value = __stringCode
                __formSuggest['k'].value = __stringCode
            } else {
                try {
                    document.getElementById('search_input').value = ''
                    document.getElementById('search_input').focus()
                } catch (e) {
                }

                return false
            }
        }
    }
});
//评论组件
SinaPage.loadWidget({
    //加载评论
    /*trigger: {
     id: 'wrap_bottom_omment'
     },*/
    require: [
        {
           //url: '//finance.sina.com.cn/other/src/article-comment-2017.js'
url:'//finance.sina.com.cn/other/src/article-comment-test.js'
        }
    ],
    onAfterLoad: function () {
        //console.log(this)
        //容器id或容器节点
        var PAGE_INFO = window.SINA_TEXT_PAGE_INFO;
        var _cmt = window.___sinacMNT___;
        var wrapId = 'bottom_sina_comment';
        //评论表单选项
        var formOpt = {
            channel: PAGE_INFO.channel,//频道
            newsid: PAGE_INFO.newsid,//新闻id
            allNewsid: '',//组新闻ID
            parent: '',//回复的mid
            encoding: 'utf-8',
            commented: function (content, contentHTML) {
                //评论后回调
            },
            share_url: location.href.split('#')[0],//分享的链接
            video_url: '',//分享的视频地址
            img_url: '',//分享图片地址
            postTip: '我有话要说...',// 输入提示，如“请输入评论”
            autoGrow: false,// 输入框是否自动增高
            content: ''// 默认评论内容，如添加话题“#刘德华军同款军大衣#”
        };
        var cmtSudaInit = true;
        //评论列表选项
        var listOpt = {
            url: '',//评论接口URL
            channel: PAGE_INFO.channel,
            newsid: PAGE_INFO.newsid,
            //showReply: 1,//显示回复串//@A:xxxx//@B:xxxx
            group: 0,//等同于style=X
            encoding: 'utf-8',
            hotPageNum: 3,// 【最热评论】默认显示条数
            latestPageNum: 3,//【最新评论】默认显示条数
            replyShowNum: 3,//【回复列表】默认显示条数
            replyPageNum: 15,//【回复列表】点击加载更多的条数
            replyClickMoreTimes: 3,//【回复列表】可点击加载更多回复按钮的次数
            clickMoreTimes: 0, //【最热评论】可点击“更多评论”按钮次数,达到该次数后，显示“查看更多评论”链接，点击跳转
            maxWordCount: 200,
            showUserFrom:true,//显示用户来源
            loaded: function (self) {
                var numSplit = function numSplit(num) {
                    num = num + "";

                    var re = /(-?\d+)(\d{3})/;
                    var prefix = '\u4E07';
                    if( num < 10000) {
                        prefix = '';
                        while (re.test(num)) {
                            num = num.replace(re, "$1,$2");
                        }
                    } else if(num < 100000){
                        num = (parseInt(num / 1000) /10).toFixed(1);
                        if(num.slice(-1) == '0') {
                            num = num.slice(0,-2);
                        }
                    } else {
                        num = parseInt(num / 10000);
                    }
                    return num + prefix;
                };
                
                //如果评论关闭，隐藏顶部评论icon 和数字
                if (self.data.news.status == 'N_CLOSE') {
                    $('.tool-icon.tool-cmt').hide();
                } else {
                    if (self.data && self.data.count && self.data.count.total) {
                        //console.log(self.data.count.total)
                        var numStr = numSplit(self.data.count.total);
                        $('[node-type="comment-num"]').html(numStr);
                    } else {
                        $('[node-type="comment-num"]').html('');
                    }

                }

                if (cmtSudaInit) {
                    cmtSudaInit = false;
                }
            },
            beforeLoad: function () {
                //alert('beforeLoad');
            }
        };
        var opt = {
            isBBS: 0,// 是否是论坛页面
            hideList: SINA_TEXT_PAGE_INFO.hideCommentList, // 是否隐藏列表：某些新闻需要隐藏列表，加载数据但不渲染列表
            hideComment: SINA_TEXT_PAGE_INFO.hideComment // 是否隐藏评论
        };
        window.bottom_comment = new _cmt.cmnt.FormList(wrapId, formOpt, listOpt, opt);

    }
});
//相关微博、相关新闻
SinaPage.loadWidget({
    trigger: {
        id: 'tab_related'
    },
    require: [
        // 天乙资源
        [
            {
                url: '//sjs0.sinajs.cn/video/sinaplayer/js/page/player_v1.js'
            }, {
            url: '//h5.sinaimg.cn/m/videoPlayer/js/ty.e56f55e8.js'
        }, {
            url: '//news.sina.com.cn/js/pctianyi/sima.js'
        }
        ],
        {
            url: '//news.sina.com.cn/js/pctianyi/tianyi.js'
        },
        {
            url: '//n.sinaimg.cn/finance/pctianyi_wdg/apps/fin-atc-feed/js/feed-app.js'
        },
        {
            url: '//n.sinaimg.cn/finance/page/ent/js/weiboList.js'
        },
        {
            url: '//n.sinaimg.cn/finance/fe/Tab-min.js'
        }
    ],
    onAfterLoad: function () {
        //相关新闻-相关微博  tab按钮吸顶
        if($('.tab_related_app_link').size() < 1){
            $('<a class="tab_related_app_link" data-sudaclick="sf_cjapp_xgxwright_p" href="https://finance.sina.com.cn/mobile/comfinanceweb.shtml?source=cjzhengwen03" target="_blank">投资热点尽在新浪财经APP&gt;</a><a class="tab_related_app_imglink" data-sudaclick="sf_cjapp_xgxxbelow_p" href="https://finance.sina.com.cn/mobile/comfinanceweb.shtml?source=cjzhengwen01" target="_blank"></a>').appendTo($('#tab_related_btn'));
        }
        new PageTool.SetScrollFixed({
            wrap: 'tab_related_btn',//吸顶的元素id
            start: 'tab_related',//吸顶元素浮层id
            fixedClass: 'tab-related-fixed'//吸顶的class
        });
        //实例化tab标签
        var tab1 = new Tab({
            bonds: [
                ['tab01_btn01', 'tab01_cont01'],
                ['tab01_btn02', 'tab01_cont02']
            ], // 绑定dom，复杂数组格式，每组一对
            selected: 'cur', // 选择项的className，默认值"tab_selected"
            trigger: 'click', // 触发条件，默认值"mouseover"
            onAfter: function (to) {
                var me = this;
                var wbTab = $('#tab01_btn02');
                var _top = $('#tab_related').offset().top;
                $('body,html').animate({scrollTop: _top}, 500);
                if (to == 1 && wbTab.attr('data-first') != '1') {
                    //点击微博标签之后才加载iframe,并将标签设为已加载
                    new WeiboList({
                        id: 'related_wb',
                        keywords: $('#keywords').attr('data-wbkey')
                    });
                    wbTab.attr('data-first', '1');
                }
            }
        });
    }
});
/* 右侧组件 */
//7X24小时
if (document.getElementById('cj_7x24_list')) {
    SinaPage.loadWidget({
        trigger: {
            id: 'cj_7x24_list'
        },
        require: [{
            url: '//finance.sina.com.cn/other/src/pageTools.final.js'
        },
            {
                url: '//n.sinaimg.cn/finance/fe/doT.min.js'
            }
        ],
        onAfterLoad: function () {
            new PageTool.TPLRander({
                tplId: 'TPL_7x24_List',//dot模板id
                wrap: 'cj_7x24_cont',//domId
                api: '//zhibo.sina.com.cn/api/zhibo/feed?zhibo_id=152&id=&tag_id=0&page=1&page_size=20&type=0',//接口地址
                dataType: 'jsonp',
                apiData: {},//请求参数
                hasData: function (m) {//判断返回值是否有数据
                    var ret;
                    if (m.result && m.result.data && m.result.data.feed && m.result.data.feed.list && m.result.data.feed.list.length > 0) {
                        ret = true;
                    } else {
                        ret = false;
                    }
                    return ret;//默认失败
                },//是否返回成功
                formatData: function (m) {
                    var _data = m.result.data.feed.list;
                    if (_data && _data.length) {
                        for (var i = 0; i < _data.length; i++) {
                            _data[i].content = _data[i].rich_text && _data[i].rich_text.replace(/<a([^>]*)>([^<]*)<\/a>/g, '');
                            _data[i].format_created_time = _data[i].create_time && _data[i].create_time.slice(10);
                        }
                        _data.length = Math.min(5,_data.length);
                        return _data;
                    } else {
                        return _data || [];
                    }
                },//自定义数据格式化
                onSuccess: function (m) {
                },//成功回调
                onError: function (m) {
                }//失败回调
            });
        }
    });
}
//股市直播
SinaPage.loadWidget({
    // trigger: {
    //     id: 'cj_video_list'
    // },
    require: [{
        url: '//finance.sina.com.cn/other/src/pageTools.final.js'
    },
        {
            url: '//n.sinaimg.cn/finance/fe/doT.min.js'
        },
        {
            url: '//n.sinaimg.cn/finance/fe/Tab-min.js'
        }
    ],
    onAfterLoad: function () {
        //获取列表函数
        var PROTOCOL = location.protocol;
        var BASE_URI = 'http://live.finance.sina.com.cn';
        var PATH_TEACHER_LIVE = BASE_URI + '/bozhu';
        var BASE_API = PROTOCOL + '//app.finance.sina.com.cn/course/index.php';
        var dataFormat = {
            filterTag: function (text) {
                var escapeMap = {"<": "&lt;", ">": "&gt;", "script": ""};
                return !text ? '' : text
                    .replace(/<span(?:[^<]+)?>([^<]+)?<\/span>/g, function (m, p1) {
                        /*var imgSrc = emoji.getImg(p1);
                         return imgSrc ? '<span class="text-emoji"><img src="' + imgSrc + '" alt="' + p1 + '"></span>' : p1;*/
                        return p1;
                    })
                    .replace(/[<>]|script/g, function (m) {
                        return escapeMap[m];
                    });
            },
            /**
             * 处理后端接口返回的文字：处理尖括号,img标签,股票链接
             * @param {String}
             * @return {XML|string}
             */
            filterText: function (text) {
                text = this.filterTag(text);
                return !text ? '' : text
                //处理img标签
                    .replace(/\[img\](?:\[url\])?https?:([^\[\]]+)(?:\[\/url\])?\[\/img\]/g, function (m, url) {
                        url = PROTOCOL + url;
                        // return '<img class="text-pic" src="' + url + '">';
                        return '【更多独家重磅股市观点请点击】';
                    })
                    //处理a标签
                    .replace(/\[url\]([^\[\]]+)\[\/url\]/g, function (m, url) {
                        // return '<a class="stock-link" target="_blank" href="' + url + '">' + url + '</a>';
                        return '【更多独家重磅股市观点请点击】';
                    })
                    //处理股票链接
                    .replace(/\[stock\](.+?)\[\/stock]/g, function (m, p1) {
                        var code, name = '', splitPose = p1.indexOf('&');
                        if (splitPose !== -1) {
                            code = p1.slice(0, splitPose);
                            name = p1.slice(splitPose + 1);
                        } else {
                            code = p1;
                        }
                        /*return '<a class="stock-link" target="_blank" href="http://finance.sina.com.cn/realstock/company/' + code + '/nc.shtml">' + name + '(' + code + ')</a>';*/
                        return name + '（' + code + '）';
                    });
            },
            /**
             * 秒数格式化 YYYY-MM-DD HH:MM:SS
             * 当天的年月日格式化为“今天”
             * @param sec {Number|String}
             * @return {String}
             */
            second2Locale: function (sec) {
                if (isNaN(sec)) {
                    return '';
                }

                var date = new Date(sec * 1000);
                var yyyy = fixDigits(date.getFullYear());
                var mm = fixDigits(date.getMonth() + 1);
                var dd = fixDigits(date.getDate());
                var hh = fixDigits(date.getHours());
                var min = fixDigits(date.getMinutes());
                var s = fixDigits(date.getSeconds());
                var today = new Date();
                var todayDate = fixDigits(today.getFullYear()) + '-' +
                    fixDigits(today.getMonth() + 1) + '-' +
                    fixDigits(today.getDate());

                return (yyyy + '-' + mm + '-' + dd + ' ' + hh + ':' + min + ':' + s).replace(todayDate, '今天');

                function fixDigits(num) {
                    num = Number(num);
                    return num > 9 ? '' + num : '0' + num;
                }
            },
            program: function (o) {
                //直播状态
                o.status = o.extraInfo.live_status.toString();
                switch (o.status) {
                    case '1':
                        o.status_text = '即将开始';
                        break;
                    case '2':
                        o.status_text = '直播中';
                        break;
                    default:
                        o.status_text = '回顾';
                }
                //节目类型
                o.type = o.program_type.toString();
                switch (o.type) {
                    case '1':
                        o.type_text = '直播';
                        break;
                    case '2':
                        o.type_text = '图文';
                        break;
                    default:
                        o.type_text = '其他';
                }
                switch (o.pay_type) {
                    case '2':
                        o.pay_type_text = '付费';
                        break;
                    default:
                        o.pay_type_text = '免费';
                }
                //开始时间
                o.start_time = this.second2Locale(o.stime);
                o.teacher_url = PATH_TEACHER_LIVE + '/' + o.uid;
                o.program_url = o.teacher_url + '/' + o.id;
                //o.share_qr = util.getQrImg(o.share_url);
                return o;
            },
            /**
             * 图文直播中的单个卡片数据
             * @param o {Object}
             * @return o {Object} 返回传入对象
             */
            tuwen: function (o) {
                o.publish_time = this.second2Locale(o.time || o.stime || o.etime || o.ctime);
                if (o.answer) {
                    o.islive = 0;
                    o.answer = this.filterText(o.answer);
                    o.question = this.filterText(o.question);
                } else {
                    o.islive = 1;
                    o.content = this.filterText(o.content);
                }
                if (o.program) {
                    this.program(o.program);
                }
                return o;
            }
        };

        function randerList(index, me) {
            var _curBtn = $(me.doms.tabs[index]);
            var utlconf = _curBtn.attr('data-url');
            if (index == 0) {
                var url = '//finance.sina.com.cn/live/js/pic_live.js';
                new PageTool.TPLRander({
                    jsonpCallback: 'livePicContent',
                    tplId: 'TPL_Live_List',//dot模板id
                    wrap: 'tab14_cont0' + (index + 1),//domId
                    api: url,//接口地址
                    dataType: 'jsonp',
                    apiData: {},//请求参数
                    hasData: function (m) {//判断返回值是否有数据
                        var ret;
                        if (m && m.result.data.data.length > 0) {
                            ret = true;
                        } else {
                            ret = false;
                        }
                        return ret;//默认失败
                    },//是否返回成功
                    formatData: function (m) {
                        var data = m.result.data.data;
                        for (var i = 0; i < data.length; i++) {
                            data[i] = dataFormat.tuwen(data[i]);
                        }
                        return data;
                    },//自定义数据格式化
                    onSuccess: function (m) {
                        _curBtn.attr('data-loaded', '1');
                    },//成功回调
                    onError: function (m) {
                    }//失败回调
                });
            } else {
                var url = '//finance.sina.com.cn/live/js/video_program_list.js';
                new PageTool.TPLRander({
                    tplId: 'TPL_Live_List2',//dot模板id
                    jsonpCallback: 'liveVideoProgramList',
                    wrap: 'tab14_cont0' + (index + 1),//domId
                    api: url,//接口地址
                    dataType: 'jsonp',
                    apiData: {},//请求参数
                    hasData: function (m) {//判断返回值是否有数据
                        var ret;
                        if (m && m.result.data.length > 0) {
                            ret = true;
                        } else {
                            ret = false;
                        }
                        return ret;//默认失败
                    },//是否返回成功
                    formatData: function (m) {
                        var data = m.result.data;
                        for (var i = 0; i < data.length; i++) {
                            data[i] = dataFormat.tuwen(data[i]);
                        }
                        return data;
                    },//自定义数据格式化
                    onSuccess: function (m) {
                        _curBtn.attr('data-loaded', '1');
                    },//成功回调
                    onError: function (m) {
                    }//失败回调
                });
            }

        }

        //实例化tab标签
        var tab1 = new Tab({
            bonds: [
                ['tab14_btn01', 'tab14_cont01'],
                ['tab14_btn02', 'tab14_cont02']
            ], // 绑定dom，复杂数组格式，每组一对
            selected: 'tabs-cur', // 选择项的className，默认值"tab_selected"
            trigger: 'mouseover', // 触发条件，默认值"mouseover"
            onRender: function () {
                var me = this;
                randerList(0, me)
            },
            onAfter: function (to) {
                var me = this;
                var _curBtn = $(me.doms.tabs[to]);
                if (_curBtn.attr('data-loaded') != 1) {
                    randerList(to, me)
                }
            }
        });
    }
});
//底部最后一个广告吸顶
if (document.getElementById('last_side_ad')) {
    SinaPage.loadWidget({
        trigger: {
            id: 'last_side_ad'
        },
        require: [
            {
                url: '//finance.sina.com.cn/other/src/pageTools.final.js'
            }
        ],
        triggerAhead: false,
        onAfterLoad: function () {
            new PageTool.SetScrollFixed({
                wrap: 'last_side_ad',//吸顶的元素id
                start: 'last_ad_wrap',//跟随滚动元素外层id
                fixedClass: 'com-fixed',//吸顶的class
                onFixed: function () {
                    var self = this;
                    if ($('#top_bar').hasClass('top-bar-fixed')) {
                        this.obj.addClass('com-fixed-02');
                    }
                }
            });
        }
    })
};
(function($){
    function loadStyle(s, id) {
        var doc = document;
        var sDom = doc.createElement("style");
        sDom.id = id;
        sDom.type = "text/css";
        sDom.styleSheet ? (sDom.styleSheet.cssText = s) : sDom.appendChild(doc.createTextNode(s));
        doc.getElementsByTagName("head")[0].appendChild(sDom);
        return sDom;
    };
    var _style = '.latest-wrap a.link_cmt_tg,.latest-wrap a.link_cmt_tg:visited{color:#333;float:right;line-height:49px;font-size:14px;background-image:url(//n.sinaimg.cn/tech/66ceb6d9/20180823/bg-gt.png); background-image:-webkit-image-set(url(//n.sinaimg.cn/tech/66ceb6d9/20180823/bg-gt.png) 1x, url(//n.sinaimg.cn/tech/66ceb6d9/20180823/bg-gt2x.png) 2x); background-repeat:no-repeat; background-position:100% 17px; background-size:9px 14px;padding-right:20px;}.latest-wrap a.link_cmt_tg:hover{color:#3753a2;background-image:url(//n.sinaimg.cn/tech/66ceb6d9/20180823/bg-gt-hover.png); background-image:-webkit-image-set(url(//n.sinaimg.cn/tech/66ceb6d9/20180823/bg-gt-hover.png) 1x, url(//n.sinaimg.cn/tech/66ceb6d9/20180823/bg-gt-hover2x.png) 2x)}'
    var _api = '//finance.sina.com.cn/tgdata/toujiao/tg.json';
    loadStyle(_style);
    var _addTimeOut = null;
    var _title = null;
    var _url = null;
    function addCmtLink(){
        var _dom = $('[comment-type="latestWrap"] .title');
        if(_dom.size()){
            $('<a class="link_cmt_tg" target="_blank" href="'+_url+'">'+_title+'</a>').appendTo(_dom);
            _addTimeOut && clearInterval(_addTimeOut);
        }
    }
    $.ajax({
        url : _api,
        dataType : 'jsonp',
        jsonpCallback : 'pFunction',
        success : function(res){
            var data = res.result.data;
            if(data && data.article_title && data.article_url){
                _title = data.article_title;
                _url = data.article_url;
                _addTimeOut = setInterval(function(){
                    addCmtLink();
                },3000);
            }
        }
    })
})(jQuery);