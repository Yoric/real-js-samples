/* sohutv 2017-12-19 10:20:12 */
!function(){var t=kao.EventEmitter;sohuHD.namespace("sohuHD.wemedia.rssutil"),sohuHD.extend(sohuHD.wemedia.rssutil,{subUrl:"//my.tv.sohu.com/user/a/subscribe/batchAdd.do?callback=?",unsubUrl:"//my.tv.sohu.com/user/a/subscribe/delete.do?callback=?",checkUrl:"//push.my.tv.sohu.com/user/a/subscribe/batchJudge.do?callback=?",isLogin:function(){return!!this.getPassport()},getPassport:function(){return sohuHD.passport.getPassport()},sub:function(t){"[object Array]"!=Object.prototype.toString.call(t)&&(t=[].slice.call(arguments));var i=this.subUrl+"&plat=603&playlistids="+t.join(",")+"&passport="+this.getPassport();return $.getJSON(i)},unsub:function(t){"[object Array]"!=Object.prototype.toString.call(t)&&(t=[].slice.call(arguments));var i=this.unsubUrl+"&playlistid="+t.join(",")+"&passport="+this.getPassport();return $.getJSON(i)},check:function(t){"[object Array]"!=Object.prototype.toString.call(t)&&(t=[].slice.call(arguments));var i=this.checkUrl+"&plat=603&playlistids="+t.join(",")+"&passport="+this.getPassport();return $.getJSON(i)}});var i=(sohuHD.wemedia.rssutil,{unsubed:{t:"\u8ffd\u5267\u63d0\u9192",c:""},subed:{t:"\u6b63\u5728\u8ffd",c:""},cancel:{t:"\u53d6\u6d88\u8ffd\u5267",c:""}});sohuHD.namespace("sohuHD.wemedia.RssBtn"),sohuHD.wemedia.RssBtn=function(t,s){sohuHD.wemedia.RssBtn.superClass.constructor.call(this),this.originalConfig=s,this.config=s||{},this.btn=$(t),this.uid=s.uid,this.uid||(this.uid=this.btn.data("uid")||this.btn.data("rss-uid")),this.skin=this.btn.data("skin")||"white",this.stateMap=s.stateMap||{};for(var n in i){this.stateMap[n]=this.stateMap[n]||{};var e=this.stateMap[n],a=i[n];if(a)for(var o in a)"undefined"==typeof e[o]&&(e[o]=a[o])}this.alertDialog=new sohuHD.wemedia.ui.AlertDialog({delayHideTime:2e3}),this.config.initData&&(this.initData=this.config.initData,this.uData=this.initData),this.initData&&"undefined"!=typeof this.initData.isFollow&&(this.isFollow=this.initData.isFollow)},sohuHD.inherit(sohuHD.wemedia.RssBtn,t,{util:sohuHD.wemedia.rssutil,init:function(){this.initEvent(),this._init(),this.initialed=!0},initEvent:function(){this.btn.hover(function(){this.isFollow&&this.trigger("hover",this.isFollow)}.bind(this),function(){this.isFollow&&this.trigger("hoverout",this.isFollow)}.bind(this)),this.btn.on("click",function(t){var i=this.btn.data("action");return"sub"==i?this.doSub():"unsub"==i&&this.doUnsub(),!1}.bind(this)),this.on("sub",this),this.on("suberror",this),this.on("unsub",this),this.on("hover",this),this.on("hoverout",this),this.on("click",this),messagebus.subscribe("core.login",function(){this._init()}.bind(this),null,null),messagebus.subscribe("core.logout",function(){this._init()}.bind(this),null,null)},_init:function(){if(!this.initialed&&"undefined"!=typeof this.isFollow&&this.initData)return this.btn.show(),this.setBtnState(this.isFollow),setTimeout(function(){this.trigger("check",this.initData),this.trigger("init",this.initData)}.bind(this)),void(this.originalConfig.myuid==this.uid&&this.btn.hide());if(this.initialed&&!this.util.isLogin())this.btn.show(),this.isFollow=!1,this.setBtnState(this.isFollow);else if(!this.subing){var t=this.util.check(this.uid);t.done(function(t){t=t||{};var i=t.playlist[0].isSubs;if(this.uData={isFollow:i},this.isFollow=i,this.btn.show(),this.setBtnState(this.isFollow),this.trigger("check",this.uData),this.trigger("init",this.uData),this.uid==t.uid)return void this.btn.hide()}.bind(this))}},calcDialogPosition:function(t){var i,s,n=this.btn.offset(),e=t.size(),a=$(window).scrollTop(),o=$(window).scrollLeft(),h=this.btn.width(),u=this.btn.height();return i=n.top-e.h,i<a&&(i=n.top+u+20),s=n.left,s+e.w>o+$(window).width()&&(s=s+h-e.w),{top:i,left:s}},doSub:function(){if(!this.util.isLogin())return sohuHD.showLoginWinbox(function(){this.subing=!0,this.doSub()}.bind(this)),void sohuHD.initLogin();this.util.sub(this.uid).done(function(t){-2==t.status?this.trigger("suberror",t):(this.subing=!1,this.trigger("sub",t))}.bind(this))},doUnsub:function(){this.util.unsub(this.uid).done(function(t){this.trigger("unsub",t)}.bind(this))},handleEvent:function(t){switch(t){case"sub":this.onSub();break;case"unsub":this.onUnsub();break;case"hover":this.onHover();break;case"hoverout":this.onHoverOut();break;case"suberror":this.suberror()}},setBtnState:function(t){if(!0===t?t=1:!1===t&&(t=-1),1==t){if(this.btn.data("action",""),this.stateMap){var i=this.stateMap.subed,s=this.stateMap.unsubed,n=this.stateMap.cancel;this.btn.html(i.t),this.btn.removeClass(s.c||"").removeClass(n.c||""),this.btn.addClass(i.c||"")}}else if(-1==t){if(this.btn.data("action","sub"),this.stateMap){var i=this.stateMap.subed,s=this.stateMap.unsubed,n=this.stateMap.cancel;this.btn.html(s.t),this.btn.removeClass(n.c||"").removeClass(i.c||""),this.btn.addClass(s.c||"")}}else if(0==t&&(this.btn.data("action","unsub"),this.stateMap)){var i=this.stateMap.subed,s=this.stateMap.unsubed,n=this.stateMap.cancel;this.btn.html(n.t),this.btn.removeClass(i.c||"").removeClass(s.c||""),this.btn.addClass(n.c||"")}},onHover:function(){this.isFollow&&this.setBtnState(0)},onHoverOut:function(){this.isFollow&&this.setBtnState(1)},onSub:function(){this.isFollow=!0,this.setBtnState(this.isFollow)},onUnsub:function(){this.isFollow=!1,this.setBtnState(this.isFollow),this.alertDialog.el.addClass(this.btn.data("skin")||""),this.alertDialog.setTip("\u53d6\u6d88\u8ffd\u5267\u6210\u529f\uff01"),this.alertDialog.show();var t=this.calcDialogPosition(this.alertDialog);this.alertDialog.setPosition(t.top,t.left)},suberror:function(){this.alertDialog.el.addClass(this.btn.data("skin")||""),this.alertDialog.setTip("\u8ffd\u5267\u5931\u8d25\uff01"),this.alertDialog.show(),this.alertDialog.el.find(".read_tips").removeClass("read_tips_ok").addClass("read_tips_fail").width(70);var t=this.calcDialogPosition(this.alertDialog);this.alertDialog.setPosition(t.top,t.left)},getData:function(){return this.uData}}),sohuHD.extend(sohuHD.wemedia.RssBtn,{init:function(t,i){t=t||".wemedia-rss-btn";var s=[],n=[],e=$(t);if(e.each(function(t,i){var s=$(i).data("uid")||$(i).data("rss-uid");n.push(s)}),!n.length)return null;var a=jQuery.Deferred();return sohuHD.wemedia.rssutil.check(n).done(function(t){t=t||{};var n=[t.playlist[0].isSubs]||[],o=[];n.forEach(function(t,i){var s={isFollow:t};o.push(s)}),t.results=o,t.results.forEach(function(n,a){var o=($(e[a]).data(i.labUid||"uid"),$.extend({},i,{state:n.isFollow,initData:n,myuid:t.uid})),h=new sohuHD.wemedia.RssBtn(e[a],o);h.init(),s.push(h)}),a.resolve({btns:s,data:t})}),a}})}();