define(["OK/logger","OK/utils/vanilla","OK/utils/dom","OK/utils/delegate"],function(c,f,h,e){var b="ShortcutMenu";var a=null;var g=document.createElement("div");g.id="hook_Block_"+b;document.body.appendChild(g);OK.hookModel.captureBlockHook("body",g);g.addEventListener("change",function(){if(a&&a.visible()){a.positingElement();}});var d=function(i){this.hookId=i;this.stopClick=true;this.ajaxRequest=null;this.showTimeout=null;this.hideTimeout=null;this.menuElement=null;this.cacheable=true;this.loaded=false;this.showOnClick=true;};d.getActive=function(){return a;};d.prototype={activate:function(j){this.element=j;this.holder=this.getHolder();this.blockId=this.element.getAttribute("data-blockid");this.block=document.getElementById("hook_Block_"+this.blockId);this.inplace=this.element.getAttribute("data-inplace");this.loaded=this.element.getAttribute("data-loaded");this.showDelay=parseInt(this.element.getAttribute("data-show"),10)||300;this.hideDelay=parseInt(this.element.getAttribute("data-hide"),10)||100;this.cacheable=!this.element.getAttribute("data-nocache");this.saveChanges=this.element.getAttribute("data-save-changes");this.direction=this.element.getAttribute("data-direction");this.position=this.element.getAttribute("data-position")||"center";this.showOnClick=this.element.getAttribute("data-onClick");this.isShowImmediately=this.element.getAttribute("data-showImmediately");this.showImmediatelySelector=this.element.getAttribute("data-showImmediatelySelector");this.relatedMenu=this.getRelatedMenu();this.hideOnClick=this.element.getAttribute("data-hideOnClick");this.hideOnMouseDown=this.element.getAttribute("data-hideOnMouseDown");this.hideOnScroll=this.element.getAttribute("data-hideOnScroll");this.hideOnBlurSelector=this.element.getAttribute("data-hideOnBlurSelector");this.hideOnBlurElement=null;this.detectScrollableContainer=this.element.getAttribute("data-detect-scrollable");if(!this.holder){c.error("asm","noholder");c.success("asm","noholder",this.buildParamFingerprint());return;}this.handlers={};this.boundAjaxFail=this.ajaxFail.bind(this);this.boundAjaxDone=this.ajaxDone.bind(this);this.holderDelegate=new e(this.holder);if(OK.device.isTouch){this.holderDelegate.on("touchstart",this.holderTouchStartListener);var i=this.holder.getElementsByTagName("a")[0];if(!i){i=h.traverseParents(this.holder,function(k){return k.tagName.toUpperCase()==="A";},document.body,true);}if(i){this.linkDelegate=new e(i);this.linkDelegate.on("touchstart",this.touchHandle.bind(this),true);}}this.holderDelegate.on("mouseleave",this.hoverOutListener.bind(this));if(this.showOnClick){this.oneClickListener=this.addOneTimeListener(this.holder,"click",this.showMenu);}else{this.holderDelegate.on("mouseenter",this.hoverInListener.bind(this));if(this.hideOnClick){this.holderDelegate.on("click",this.hoverOutListener.bind(this));}if(this.hideOnMouseDown){this.holderDelegate.on("mousedown",this.hoverOutListener.bind(this));}}if(this.inplace&&this.loaded){this.initListeners(this.getBlock());}if(this.isShowImmediately){this.showImmediately();}},deactivate:function(){if(!this.holder){return;}this.ajaxClose();this.hide();this.removeOneTimeListener(this.oneClickListener);this.removeOneTimeListener(this.oneScrollListener);this.removeOneTimeListener(this.oneBodyTouchListener);this.removeOneTimeListener(this.oneImmediatelyHandler);this.removeOneTimeListener(this.oneBlurListener);this.holderDelegate.destroy();if(this.linkDelegate){this.linkDelegate.destroy();}if(this.shortcutMenuDelegate){this.shortcutMenuDelegate.destroy();}},buildParamFingerprint:function(){var j=[this.inplace,this.loaded,this.cacheable,this.showOnClick,this.hideOnClick,this.hideOnScroll];var i="";j.forEach(function(k){i+=(!!k*1).toString();});return i;},hoverInListener:function(i){if(OK.device.isTouch&&i){return;}this.clearHideTimeout();if(!this.showTimeout&&!this.visible()){this.showTimeout=setTimeout(this.showMenu.bind(this),this.showDelay);}},hoverOutListener:function(){this.clearShowTimeout();this.ajaxClose();if(!this.hideTimeout&&this.visible()){this.hideTimeout=setTimeout(function(){if(this.hideOnBlurElement!==document.activeElement){this.hideMenu();}else{this.hideTimeout=null;}}.bind(this),this.hideDelay);}},menuElementHoverInListener:function(){this.menuElementHoverInListenerCalled=true;if(this.hideTimeout){this.hideTimeout=clearTimeout(this.hideTimeout);}},menuElementLinkClickListener:function(i){if(!h.parent(i.target,"js-doNotHide",this.block)){this.menuElementClickListener();}},menuElementClickListener:function(){if(true===this.hideTimeout){this.hideTimeout=null;}this.hoverOutListener();},holderTouchStartListener:function(i){i.stopPropagation();},hide:function(){this.clearShowTimeout();this.clearHideTimeout();if(this.menuElement){this.hideMenu();}},getHolder:function(){var i=this.element.getAttribute("data-holder");return i?document.getElementById(i):this.element.previousElementSibling;},getClosestScrollable:function(k){if(!this.closestScrollable){var i=/(auto|scroll)/;var j=h.traverseParents(this.element,function(l){var m=window.getComputedStyle(l);var n=i.test(m.overflow+m.overflowY+m.overflowX);return n&&(!k||(l.scrollHeight>l.clientHeight));});this.closestScrollable=j||window;}return this.closestScrollable;},isTopDirection:function(m,j){var l=this.holder.getBoundingClientRect().top;if(this.detectScrollableContainer){var k=this.holder.getBoundingClientRect().height;var n=this.getClosestScrollable();var q=l-n.getBoundingClientRect().top;var i=n.clientHeight-k;var p=n.scrollTop+q+k+j;var o=n.scrollHeight;return i/2<q||(p>o);}else{return window.innerHeight-m-l<j;}},toRightFromHolder:function(j,l){if(this.detectScrollableContainer){var i=this.getClosestScrollable().getBoundingClientRect();var k=this.holder.getBoundingClientRect().left-i.left;return i.width/2>k;}else{return(window.innerWidth-OK.scrollBar.width)>(j.left+l);}},getRelatedMenu:function(){var i=this.element.getAttribute("data-related"),j;if(i){j=OK.hookModel.getHookById(i);return j.getInstance?j.getInstance():null;}return null;},getBlock:function(){if(this.inplace){return this.block;}return g;},getHtml:function(){if(!this.block){return"";}var i=this.block.innerHTML;if(!this.inplace||!this.cacheable){OK.hookModel.setHookContent(this.blockId,"");if(this.cacheable){this.block.innerHTML=i;}}return i;},initBlock:function(){if(this.element&&!this.block){var k=Array.prototype.slice.call(this.element.children);var l=null;for(var i=0;i<k.length;i++){if(k[i].classList.contains("posR")){l=k[i];break;}}if(!l){var j=document.createElement("div");j.id="hook_Block_"+this.blockId;j.className="posR";this.element.appendChild(j);this.block=j;OK.hookModel.captureBlockHook(this.hookId,j);}else{this.block=l;}}},initListeners:function(i){this.shortcutMenuDelegate=new e(i);this.shortcutMenuDelegate.on("click",".sc-menu a",this.menuElementLinkClickListener.bind(this));this.shortcutMenuDelegate.on("click",".sc-menu .js-hide",this.menuElementClickListener.bind(this));this.shortcutMenuDelegate.on("click",".js-forceHide",this.hideMenu.bind(this));this.shortcutMenuDelegate.on("mouseenter",this.menuElementHoverInListener.bind(this));this.shortcutMenuDelegate.on("mouseleave",this.hoverOutListener.bind(this));if(OK.device.isTouch){this.shortcutMenuDelegate.on("touchstart",this.holderTouchStartListener.bind(this));}if(this.hideOnBlurSelector){this.hideOnBlurElement=this.block.querySelector(this.hideOnBlurSelector);this.oneBlurListener=this.addOneTimeListener(this.hideOnBlurElement,"blur",this.hoverOutListener.bind(this));}},showMenu:function(){clearTimeout(this.hideTimeout);this.showTimeout=null;if(this.relatedMenu&&this.relatedMenu.hide){this.relatedMenu.hide();}if(this.visible()){return;}if(a){a.hide();}if(this.showOnClick){this.removeOneTimeListener(this.oneClickListener);this.oneClickListener=this.addOneTimeListener(this.holder,"click",this.hideMenu);}if(this.hideOnScroll){this.oneScrollListener=this.addOneTimeListener(this.getClosestScrollable(true),"scroll",this.hoverOutListener);}this.showTimeout=null;if(OK.device.isTouch){this.oneBodyTouchListener=this.addOneTimeListener(document.body,"touchstart",this.hoverOutListener);}if(this.ajaxRequest){return;}this.startTime=Date.now();if(this.loaded){var j=this.getHtml();this.processHTML(j,undefined,!this.inplace||!this.cacheable);c.success("asm","show","cache");}else{var i=this.element.getAttribute("data-url");this.ajaxRequest=f.ajax({url:i,dataType:"html"});this.ajaxRequest.then(this.boundAjaxDone,this.boundAjaxFail);}},showImmediately:function(){var i=this;if(i.showImmediatelySelector){setTimeout(function(){var j=i.showImmediatelySelector+":hover";i.showImmediatelyElement=h.traverseParents(i.holder,function(k){return k.matches(j);});if(i.showImmediatelyElement.matches(j)){i.showMenu();i.oneImmediatelyHandler=this.addOneTimeListener(i.showImmediatelyElement,"mouseleave",function(){setTimeout(function(){if(!i.menuElementHoverInListenerCalled){i.hideMenu();}},i.hideDelay);});}},1);}},visible:function(){return this._visible;},hideMenu:function(){this.clearShowTimeout();if(!this.visible()&&!this.showOnClick){return;}this.clearHideTimeout();this.stopClick=true;if(this.showOnClick){this.removeOneTimeListener(this.oneClickListener);this.oneClickListener=this.addOneTimeListener(this.holder,"click",this.showMenu);}this.ajaxClose(function(){c.success("asm","ajax","to");});if(this.menuElement){this.menuElement.classList.add("sc-menu__hidden");this.getHtml();if(this.saveChanges&&!this.inplace&&this.loaded&&this.cacheable){this.initBlock();this.block.innerHTML=g.innerHTML;}OK.hookModel.setHookContent(b,"");this.menuElement=null;}this.holder.classList.remove("__vis");if(this.shortcutMenuDelegate&&!this.cacheable){this.shortcutMenuDelegate.off();}this._visible=false;a=null;},touchHandle:function(i){if(this.stopClick){i.preventDefault();i.stopPropagation();this.stopClick=false;if(!this.showOnClick){this.hoverInListener();}return false;}else{this.hoverOutListener();}},getOffset:function(i){var j=i.getBoundingClientRect();return{left:j.left+window.pageXOffset,top:j.top+window.pageYOffset};},positingElement:function(){var p=h.outerSize(this.holder,false,true);var k=this.inplace?{top:0,left:0}:this.getOffset(this.holder);var s=h.outerSize(this.holder,true,true);var j=h.outerSize(this.menuElement,true,true);if(this.position!=="center"&&this.position!=="auto"){this.menuElement.classList.add("__noarrow");}var q;var n=h.outerSize(this.menuElement,false,true);if(this.direction==="top"){q=this.getOffset(this.holder).top-window.pageYOffset-90>n;}else{if(this.direction==="bottom"){q=false;}else{q=this.isTopDirection(p,n);}}var r=k.top;var l=[];if(q){this.menuElement.classList.add("sc-menu__top");var i;if(this.inplace){i=r+p;l.push("top: auto; bottom: "+Math.round(i)+"px;");}else{r-=n;l.push("bottom: auto; top: "+Math.round(r)+"px;");}}else{this.menuElement.classList.remove("sc-menu__top");if(!this.inplace){r+=p;}l.push("bottom: auto; top: "+Math.round(r)+"px;");}var o=Math.round(k.left-(j-s));var t=Math.round(k.left);var m=Math.round(k.left+((s-j)/2));switch(this.position){case"left":l.push("left: "+o+"px;");break;case"right":l.push("left: "+t+"px;");break;case"auto":if(this.toRightFromHolder(k,j)){l.push("left: "+t+"px;");this.menuElement.classList.remove("__right");this.menuElement.classList.add("__left");}else{l.push("left: "+o+"px;");this.menuElement.classList.add("__right");this.menuElement.classList.remove("__left");}break;default:l.push("left: "+m+"px;");break;}this.menuElement.setAttribute("style",l.join(""));},processHTML:function(l,m,j){var k=[];if(m&&m.getResponseHeader(OK.navigation.HEADER)){k=m.getResponseHeader(OK.navigation.HEADER).split(",");}var i;if(this.inplace){this.initBlock();k[0]=this.blockId;i=this.block;}else{k[0]=b;i=g;}if(j){f.updateBlocks(l,k);this.initListeners(this.getBlock());}this.menuElement=h.firstByClass(i,"sc-menu");this.positingElement();this.menuElement.classList.remove("sc-menu__hidden");this.holder.classList.add("__vis");a=this;this._visible=true;},ajaxDone:function(i){c.duration("asm",Date.now()-this.startTime,"ajax");var j=i.response;if(!j||(j.split(OK.navigation.SPLITER)[0]).length===0){c.success("asm","ajax","e");return;}c.success("asm","show","ajax");if(this.cacheable&&this.element){this.loaded=true;this.initBlock();this.block.innerHTML=j.split(OK.navigation.SPLITER)[0];}this.processHTML(j,i.xhr,true);this.ajaxClose();},ajaxFail:function(){this.ajaxClose(function(){c.error("asm","ajax");});},ajaxClose:function(i){if(this.ajaxRequest){this.ajaxRequest.xhr.abort();this.ajaxRequest=null;if(typeof i==="function"){i();}}},clearShowTimeout:function(){if(this.showTimeout){this.showTimeout=clearTimeout(this.showTimeout);}},clearHideTimeout:function(){if(this.hideTimeout){this.hideTimeout=clearTimeout(this.hideTimeout);}},addOneTimeListener:function(i,k,j){var m=this;var l=function l(n){i.removeEventListener(n.type,l);j.call(m,n);};i.addEventListener(k,l);return{element:i,type:k,handler:l};},removeOneTimeListener:function(i){if(i){i.element.removeEventListener(i.type,i.handler);i=null;}}};return d;});