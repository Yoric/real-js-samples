define(["jquery","OK/logger","OK/utils/utils","OK/utils/dom","OK/OhManager"],function(aF,W,ak,F,ad){var f;OK.onload.addCallback(function(){f=true;});var aD,ab=null,aa=null,av="mtLayer",P="mtLayerMain",al="mtLayerBack",aP="mtLayerForward",c="scrollToTopMtLayer",ar="media-layer js-viewport-container",k="media-layer_hld",at="mlr_disc",ai="media-layer_close",aH="media-layer_close_ico",aB="media-layer_close_ovr",d="sticky-plank_cnt",Y="media-layer_fixer",S="js_mediaLayerActions",ao=310,j=null,H=null,x=null,q=null,b=null,w=null,aR=null,aS=null,p=null,aJ=null,R=1145,E={id:null,to:75},O="MediaTopicLayerBody",aM="MediaTopicLayerAd",l="AnonymMediaTopicLayerAd",o="layer__disabled",v="invisible",ah="data-banner-seq-show-count",g=false,aG,V,a=false,L,B=ak.deferred();function A(aX,aV){var aW=document.getElementById(aX),aU;if(!aW){return false;}for(aU=0;aU<aV.length;aU+=1){if(aW.classList.contains(aV[aU])){return false;}}return true;}function ac(){return aD.isActive&&!aF("#hook_Block_PopLayerMediaTopic").hasClass(o);}function u(){return aD.isActive&&aF("#hook_Block_PopLayerMediaTopic").hasClass(o);}function y(aU){if(ac()){if(!a&&j[0]!==document.activeElement&&j.find(document.activeElement).length===0){j.focus();a=true;}if(j.hasClass("__edit")||j.find(".__edit").length>0){return;}if(j.find(".tag-box__editable").length>0){return;}if(A("hook_Modal_popLayerModal",[o])){return;}if(A("photoLayerWrapper",[o,v])){return;}if(A("video-poplayer-cnt",[o,v])){return;}if(aU.keyCode===39&&p){p.click();OK.stop(aU);}else{if(aU.keyCode===37&&aS){aS.click();OK.stop(aU);}}}}function z(aU){if(aU){OK.Layers.register(av,function(){U("cr_esc");},undefined,false,y);}else{OK.Layers.remove(av);}}function ae(aU,aV){OK.loader.use("OKCustomJs",function(){if(aU){z(aV);}if(aV){if(OK.Layers.onLayerShown){OK.Layers.onLayerShown();}}else{if(OK.Layers.onLayerHidden){OK.Layers.onLayerHidden();}}});}function K(){ad.switchLayer(!!aD.isActive);}function aO(){var aU=ar;if(aD.market&&aD.pfMode==""){aU+=" product-layer";}else{aU+=" media-layer__topic";}if(aD.modernLayer){aU+=" __modern";}if(aD.pfJs){aU+=" __posting";}if(aD.isActive){aU+=" __active";}if(aD.isProcess){aU+=" __process";}if(aD.pfMode=="N"){aU+=" __create";}if(aD.pfMode=="E"){aU+=" __edit";}if(aD.hasActiveTopics){aU+=" __has-topics";}if(aD.arrowsHidden){aU+=" __hide-arrows";}if(aD.hasBanner){aU+=" __has-banner";}if(aD.fixClosing){aU+=" __new-closing";}j[0].className=aU;}function az(){ae(true,aD.isActive);K();aO();var aU=af();if(!aU){return;}var aV=document.getElementById(aU+"Config");if(!aV){return;}var aW=aV.getAttribute("data-slot");if(aD.isActive){j.attr(ah,0);require(["OK/banners/BannerLoader"],function(aX){L=aX.subscribeToEvents(aW,{onAdsSuccess:aI,onNoAds:aw,onScriptError:aw,onHideBanner:aw});});}else{if(L&&typeof L.remove==="function"){L.remove();}aL(aU);aE(false);}}function aI(aU){aE(true);}function aw(aU){aE(false);}function aL(aV){var aU=document.getElementById(aV+"Wrapper");if(aU){aU.innerHTML="";}}function au(aU){var aV=parseInt(j.attr(aU),10);if(isNaN(aV)){aV=0;}return aV;}function n(aU){var aV=au(aU);j.attr(aU,aV+1);}function G(aV){var aU=aD.isActive!==aV;aD.isActive=aV;if(aU){az();}else{if(u()){ae(false,true);}}document.getElementById("hook_Block_PopLayerMediaTopic").classList.remove(o);}function ap(aU){var aV=aD.isProcess!==aU;aD.isProcess=aU;if(aV){aO();}}function N(aU){var aV=aD.pfMode!==aU;aD.pfMode=aU;if(aV){aO();}}function ax(aU){var aV=aD.pfJs!==aU;aD.pfJs=aU;if(aV){aO();}}function aE(aU){if(!aD){return;}var aV=aD.hasBanner!==aU;aD.hasBanner=aU;if(aV){aO();}j.attr(ah,aU?1:0);}function s(aU){H.toggleClass("__process",aU);}function J(aW,aU){var aX=aW.length,aV=aX;while(--aX+1){aW[aX].toggleClass(aU);}setTimeout(function(){while(--aV+1){aW[aV].toggleClass(aU);}},1);}function C(){if(q){var aU=0;aF(".comments_i",q).each(function(){var aV=aF(this).data("unread");if(aV){aU=this.getBoundingClientRect().top;}return !aV;});j.each(function(){this.scrollTop=(aU!==0)?this.scrollTop+aU:this.scrollHeight;});setTimeout(function(){aF(".js-comments_add",q).focus();},50);}}function r(aZ,aW,aY){var aV=aF(window),aU=aV.height(),aX=aV.width();if(E.id){clearTimeout(E.id);}E.id=setTimeout(function(){J([w,p,aS,aJ],Y);E.id=null;},aZ?0:E.to);j.toggleClass("__compact",aX<=R);j.toggleClass("__min-height",(aU<ao));if(aW){C();}if(aY){an(aY);}}function t(aV){if(g){return;}g=true;ab=aF(window);aa=aF(document.body);j=aF("#"+av);H=aF("#"+P);aS=aF("#"+al);p=aF("#"+aP);aJ=aF("#"+c);var aU=j.attr("data-fix-closing")==="1";aD={fixClosing:aU,isActive:j.hasClass("__active"),isProcess:j.hasClass("__process"),pfMode:j.hasClass("__edit")?"E":(j.hasClass("__create")?"N":""),pfJs:j.hasClass("__posting"),modernLayer:j.hasClass("__modern"),hasActiveTopics:j.hasClass("__has-topics"),hasBanner:j.hasClass("__has-banner"),arrowsHidden:j.hasClass("__hide-arrows")};x=j.find("."+k);w=x.find("."+ai);aR=j.find("."+aB);if(aU){j.on("click",function(aW){if(!F.parent(aW.target,"js-mlr-block",false,true)){U("cr_shadow");}});}else{aR.on("click",function(aW){U("cr_shadow");});}w.on("click",function(aW){U("cr_close");});if(aD.isActive){az();if(!aD.isProcess){r(true,aV);}}if(aV){C();}ab.on("resize.mtLayer",function(){r();});B.resolve(j);}var e;var Z;var aQ;function X(aV,aU){if(aU==null||aU.length==0){return;}OK.historyManager.putItemToCache(aV,aU);}function aC(aV){if(OK.historyManager.isHistorySupported()){var aW=aV.indexOf("?");if(aW>0){aQ=aV.substr(aW+1);Z=aV.substr(0,aW);if(aQ.length>0){aQ+="&mt.scrollTop="+aF(window).scrollTop();}else{aQ=null;}X(Z,aQ);}else{Z=aV;aQ=null;}var aX=M()==Z&&!V;var aU;if(!e){if(aX){aU=true;}else{if(V){aN(V,true);}}e=M();}else{aU=!aD.closeTopicId;}V="";if(!aX){aN(Z,aU);}}}function I(){if(!e&&Z==M()){aN(e,true);}e=null;Z=null;aQ=null;}function M(){return OK.historyManager.getState();}function aN(aV,aU){if(aU){OK.historyManager.replaceState(aV);}else{OK.historyManager.pushState(aV);}}function U(a1,aZ){if(a1=="cr_shadow"){if(aD.pfMode!=""){return;}}if(aD.pfMode!=""&&!aZ&&(a1==="cr_esc"||a1==="cr_close")){var a0=j.find(".posting");if(a0.length>0){var aU=a0[0].okPosting;if(aU){if(aU.needConfirmBeforeClose()){aU.showCloseConfirmDialog();}else{aU.closeWithoutConfirmDialog();}return;}}}a=false;aD.topicId=null;aD.owner=null;var aY=aD.closeTopicId,aV=aD.closeOwnerType;aD.closeTopicId=null;aD.closeOwnerType=null;if(aY&&(a1==="cr_esc"||a1==="cr_shadow"||a1==="cr_close"||a1==="cr_fail")){if(a1){aj(a1+"_ct");}setTimeout(function(){if(OK.historyManager.isHistorySupported()){OK.historyManager.back();}else{aA(aY,aV,"");}},0);return;}var aX=ac();var aW=false;if(aX){if(e&&Z==M()){if(e==Z){aW=true;OK.historyManager.back();}else{aN(e,true);}}}if(!aW){G(false);ap(false);N("");s(false);m();aq();aJ.removeClass("__active __animated");OK.hookModel.setHookContent(O,"");}e=null;if(a1){aj(a1);}j.trigger("mtLayer.close");}function aj(aU){W.success("mtlayer",aG||"",aU);}function m(){aS.removeClass("__active");p.removeClass("__active");}function Q(aU,aV){if(aS){aS.toggleClass("__active",!!aU&&!!aV);aS.unbind("click.back").bind("click.back",function(aX){if(aS.hasClass("__active")){var aW=p.hasClass("__active");aA(aU,aV,"MT_GoBack_"+aV,false,"","BACK",aW);}OK.stop(aX);});}}function i(aU,aV){if(p){p.toggleClass("__active",!!aU&&!!aV);p.unbind("click.forward").bind("click.forward",function(aX){if(p.hasClass("__active")){var aW=aS.hasClass("__active");aA(aU,aV,"MT_GoForward_"+aV,false,"","FORWARD",aW);}OK.stop(aX);});}}function an(aW){if(aW){var aX=j.find("[data-scroll-to='"+aW+"']");if(aX.length>0){var a1=aX[0],a0=a1.offsetTop,aU=a1.offsetParent;while(aU&&aU.nodeType===1&&aU!==j[0]){a0+=aU.offsetTop;aU=aU.offsetParent;}var aZ=j,aY=aZ.height(),aV=aZ.scrollTop(),a2=aY;if(aV+aY<=a0+a2){aZ.scrollTop(a0+a2-aY-5);}else{if(aV>a0){aZ.scrollTop(a0-5);}}}}}function aq(){var aU=aa;var aV=aU.find(".gwt-shortcutMenu__show");if(aV.length){aV.removeClass("gwt-shortcutMenu__show");}var aW=aU.find(".sc-menu:not(.sc-menu__hidden,.poll_ans_cnt)");if(aW.length){aW=aW.not("#ownProfileLSMnu");aW.addClass("sc-menu__hidden");}}var aT=[0,1,2,3,5,8,13,21,34,55,89,144,233,377,610];function ay(aV,aX){var aW=(aX-aV)/100;var aU;for(aU=1;aU<aT.length;aU++){if(aW<aT[aU]){break;}}return aT[aU-1]+"00";}function ag(){if(j){j.scrollTop(0);}}function am(aU){if(aD.isProcess){ap(false);}else{s(false);}aU&&aU();}function D(aX,a6,a2,a8,a9){V=a6;t(a2);var aW=aF("#"+O);aD.market=aW.attr("data-market")=="true";aD.advertSelectionId=aW.attr("data-adv-sel-id");aD.modernLayer=aW.attr("data-modernLayer")==="true";var a5=aW.attr("data-log");if(a5){aj(a5);}var a3=aW.attr("data-pf-mode");N(a3?a3:false);var aY=aW.attr("data-pf-js");ax(aY==="true");var aV=aW.attr("data-url");if(aV){aC(aV);}else{I();}if(aD.closeTopicId||a8){}else{var a1=aW.attr("data-back-id");Q(a1,aX);var a0=aW.attr("data-forward-id");i(a0,aX);}var a7=aW.attr("data-id");if(a7){aD.topicId=a7;aD.owner=aX;}var aU=aW.attr("data-log-click");if(aU){j.attr("data-l",aU);}else{j.removeAttr("data-l");}var aZ=x.find("."+S);if(aZ.length>0){var ba=function(be){var bd=be.delegateTarget.getAttribute("data-url");var bb=be.delegateTarget.getAttribute("uid");if(bd){if(bb){var bc=aF.ajax({type:"POST",url:bd,data:{"gwt.requested":window.pageCtx.gwtHash},headers:{TKN:OK.tkn.get()}});bc.done(function(bf,bh,bg){aZ.children().unbind("click.advert");T("PLAdvertStatusBackToView",function(){x.find("."+S).children().bind("click.advert",ba);});});}else{window.navigateOnUrlFromJS(bd);}}OK.stop(be);};aZ.children().bind("click.advert",ba);}if(!aD.isProcess){aO();}am(a9);J([p,aS,aJ],Y);ag();q=x.find("."+at);b=x.find("."+d);var a4=aW.attr("data-scroll-to-marker");r(true,a2,a4);}function af(){if(document.getElementById("hook_Block_"+aM)){return aM;}if(document.getElementById("hook_Block_"+l)){return l;}return null;}function aK(aZ){var aX=af();var aW=aX&&aD.isActive;if(!aW){return false;}if(aZ){var aY=document.getElementById(aX+"Config");if(aY){var aV=aY.getAttribute("data-everyNDisplay");if(aV){var aU=au(ah);if(aU===0){return true;}return(aU%aV)===0;}}}return true;}function aA(a5,aU,a9,a3,ba,bc,aW,bb,a6,aX,aV,a4){t(a3);var a8=Date.now();var aY=-1;var bd=-1;var a1;if(!bc){aD.closeTopicId=null;aD.closeOwnerType=null;}if(a9&&a9.indexOf("st.mt.or=on")!==-1){a6=aD.topicId;aX=aD.owner;}if(OK.photoLayer){OK.photoLayer.close();}OK.VideoPlayer.pauseAll();OK.loader.use("OKCustomJs",function(){var bf=OK.Layers.stack;var bg=bf&&bf.length>0&&bf[bf.length-1].id===av;if(!bg&&aD.isActive){z(true);}});function a7(bo){var bp=Date.now();var bn="";if(bo){bn+="r_";}if(bc){bn+="dt";}else{bn+="ot";}aj(bn+ay(a8,bp));if(a1){aj("js_"+bn+ay(a1,bp));}if(aD.pfMode){var bj=bp-a8;var bi=aY-a8;var bl=bd-aY;var bs=bp-bd;var bq=(aG||"");var bg=OK.getCurrentDesktopModelId&&OK.getCurrentDesktopModelId();var bh=(aD.pfJs?"js.":"gwt.")+(f?"f.":"p.")+(bg||"");if(bj>0){var bk=window.__gwtStatsEventsLog;if(bk&&bk.bootstrap&&bk.bootstrap.begin){var bm=(a8-bk.bootstrap.begin);var bt=Math.floor(bm/1000);var bf=Math.floor(bt/60);var br=Math.floor(bf/60);if(br>0){bh+=".h"+br;}else{if(bf>=20){bh+=".m"+Math.floor(bf/20)*20;}else{if(bf>=10){bh+=".m10";}else{if(bf>=5){bh+=".m5";}else{if(3>=bf&&bf>0){bh+=".m"+bf;}else{if(bt>=20){bh+=".s"+Math.floor(bt/20)*20;}else{bh+=".s"+Math.floor(bt/10)*10;}}}}}}W.duration("mtlayer",bm,"start."+bq+"."+aD.pfMode,bh);}W.duration("mtlayer",bj,bq+"."+aD.pfMode,bh);if(bi>0){W.duration("mtlayer",bi,"net."+bq+"."+aD.pfMode,bh);W.duration("mtlayer",bl,"act."+bq+"."+aD.pfMode,bh);W.duration("mtlayer",bs,"bnr."+bq+"."+aD.pfMode,bh);}}else{W.duration("mtlayer",bp-a8,bq+"."+aD.pfMode,bh+"_wtf");}}}aG=aU;V=ba;if(V){aj("shortlink");}m();if(aD.isActive&&!aD.isProcess){s(true);aq();}else{ap(true);}G(true);var a2;if(OK.getCurrentStateLink){a2=OK.getCurrentStateLink();}else{a2="/dk?"+window.pageCtx.state.replace("&amp;","&");}a2+=a2.indexOf("?")===-1?"?":"&";a2=a2.replace(/st\.mt\.(id|ot|bi|dir|hn).*?(&|$)/g,"");a2+="cmd="+O;if(a9){a2+="&st._aid="+a9;}var a0=aK(!!bc);var be={"gwt.requested":window.pageCtx.gwtHash,"st.mt.id":a5,"st.mt.ot":aU,"st.mt.dir":bc,"st.mt.wc":bb?"on":"off","st.mt.hn":aV?"on":"off","st.mt.ad":a0?"on":"off","st.mt.bi":a4?a4:0,"st.mt.as":aD.advertSelectionId};var aZ=aF.ajax({type:"POST",url:a2,data:be,headers:{TKN:OK.tkn.get()}});aZ.done(function(bj,bh,bq){a1=Date.now();if(a6){aD.closeTopicId=a6;aD.closeOwnerType=aX;}var bm=bq.getResponseHeader("Redirect-Location");if(bm){var bn=function(br){if(OK.navigation.redirect){OK.navigation.redirect(bm);}if(br===0||OK.navigation.redirect){U();a7();}else{setTimeout(function(){bn(br-1);},200);}};bn(5);}else{var bk=bq.getResponseHeader("End-Reached");if(bk==="yes"){if(bc==="FORWARD"){if(aW){aS.toggleClass("__active",true);}}else{if(bc=="BACK"){if(aW){p.toggleClass("__active",true);}}}am(a7);return;}aY=Date.now();var bl=bj.split(OK.navigation.SPLITER),bo=bq.getResponseHeader(OK.navigation.HEADER).split(",");var bp;for(var bi=0;bi<bl.length;bi++){var bg=bo[bi];if(bg){var bf=bl[bi];OK.hookModel.setHookContent(bg,bf);if(bg===aM||bg===l){bp=bf;}}}bd=Date.now();h(bp,bc);D(aU,V,a3,aV,a7);}});aZ.fail(function(){U("cr_fail");a7();});return aZ;}function h(aX,aW){if(aX){var aU=document.createElement("div");aU.innerHTML=aX;if(aU.getElementsByClassName("media-layer_ads").length===0){aE(false);}}else{var aV=document.getElementById(O);if(aV.getAttribute("data-hide-ad")==="true"){aL(af());aE(false);}else{if(aW&&aD.hasBanner){n(ah);}}}}function T(aX,aY){function aU(){if(aY){aY();}}if(!aD||!aD.topicId||!aD.owner){aU();return;}var aV="/";if(OK.getCurrentStateLink){aV=OK.getCurrentStateLink();}aV+=aV.indexOf("?")===-1?"?":"&";aV+="cmd="+O+"&st._aid="+aX;var aW=aF.ajax({type:"POST",url:aV,data:{"gwt.requested":window.pageCtx.gwtHash,"st.mt.id":aD.topicId,"st.mt.ot":aD.owner},headers:{TKN:OK.tkn.get()}});aW.done(function(a3,a5,a4){var a0=a4.getResponseHeader("Redirect-Location");if(a0){if(OK.navigation.redirect){OK.navigation.redirect(a0);}U();}else{var aZ=a3.split(OK.navigation.SPLITER),a2=a4.getResponseHeader(OK.navigation.HEADER).split(",");for(var a1=0;a1<aZ.length;a1++){if(a2[a1]){OK.hookModel.setHookContent(a2[a1],aZ[a1]);}}}aU();});aW.fail(aU);}return{show:function(){t();G(true);ag();},showPreloaded:D,showTopicInLayer:aA,closeLayer:function(aV,aU){if(g){U(aV,aU);}},hideLayer:function(){a=false;if(aD&&aD.isActive){if(e&&M()==Z){aN(e,true);}ae(false,false);}},restoreLayer:function(){if(aD&&aD.isActive){J([w,p,aS,aJ],Y);if(e&&M()!==Z){aN(Z,true);}ae(false,true);}},refreshLayerBody:function(aU){T("PLPhotoUserBackToView",aU);},deactivate:function(){aF(window).off(".mtLayer");if(w){w.off();}if(aR){aR.off();}G(false);},updateActiveTopics:function(aW,aU,aV){B.promise.then(function(aX){aD.hasActiveTopics=aU;aD.arrowsHidden=aV;var aZ=aW.getHeight();var aY=H.outerHeight(true);if(aU){if(aY<aZ){H.css("min-height",aZ);}else{if(aY-aZ<100){aW.setHeight(aY);}}}else{H.css("min-height","");}aO();});}};});