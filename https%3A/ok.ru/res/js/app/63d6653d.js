define(["OK/logger"],function(H){var x=null;var m=null;var F="nogwt";var j=false;var E=60;var w=5000;var a=30;var i=100;var g=5;var q=[50];var t=1000;var c=0;var s=0;var f=0;var B=0;var o=0;var u=null;var n=[];var b=false;var D;var v=0;function p(I,J){document.body.dispatchEvent(new CustomEvent("performance-event",{detail:{type:I,value:J},bubbles:true}));}function l(){return OK&&OK.Layers&&OK.Layers.isAnyLayerOpened();}(function r(){if(document.hidden!==undefined){x="hidden";m="visibilitychange";}else{if(document.mozHidden!==undefined){x="mozHidden";m="mozvisibilitychange";}else{if(document.msHidden!==undefined){x="msHidden";m="msvisibilitychange";}else{if(document.webkitHidden!==undefined){x="webkitHidden";m="webkitvisibilitychange";}}}}}());function C(I){if(I-s>i){B+=1;}s=I;if(I-f>=t){n.push(o);o=0;f=I;}else{o+=1;}if(I-c>w){y(true);}else{u=window.requestAnimationFrame(C);}}function k(){B=0;v=0;o=0;s=window.performance.now();c=s;f=s;j=l();b=true;u=window.requestAnimationFrame(C);}function A(J,K){var I={};J.sort(function(M,L){return M-L;});K.forEach(function(M){if(M){var L=Math.floor((J.length-1)*(M/100));I["p"+M]=J[L];}});return I;}function G(N){var I=[];var M=1000/t;var L,K,J;for(K=M-1;K<N.length;K++){L=0;for(J=0;J<M;J++){L+=N[K-J];}I.push(L);}return I;}function y(P){window.cancelAnimationFrame(u);u=null;b=false;var N=F;if(j||l()){N="layer";}if(P){if(H.duration){if((B>g)&&(B<(w/i))){H.duration("framerate",B,N);p("framerate",{lagCount:B,state:N});}if(v>g){H.duration("longtask.duration",v,N);p("longtask",{lagCount:v,state:N});}}k();}else{var I=G(n);var L,K;var M,O,J;while(I.length>=a){L=I.splice(0,a);J=0;for(M=0;M<a;M++){O=L[M];if(O>E){H.duration("overFpsLimit",O);O=E;L[M]=O;}J+=O;}K=A(L,q);K.mean=Math.floor(J/a);K.min=Math.min.apply(null,L);K.max=Math.max.apply(null,L);K.state=N;H.duration("altFramerate",K.p50||0,N,JSON.stringify(K));p("altFramerate",K);}n=[];}}function h(){y(false);F=OK.getCurrentDesktopModelId();k();}function z(){if(document[x]){y(false);}else{k();}}function e(I){w=Number(I.getAttribute("data-test-time"))||w;i=Number(I.getAttribute("data-threshold"))||i;g=I.hasAttribute("data-limit")?Number(I.getAttribute("data-limit")):g;a=I.hasAttribute("data-stat-limit")?Number(I.getAttribute("data-stat-limit")):a;t=I.hasAttribute("data-frame-period")?Number(I.getAttribute("data-frame-period")):t;q=I.hasAttribute("data-percentiles")?I.getAttribute("data-percentiles").split(",").map(function(K){return Number(K);}):q;F=(OK.getCurrentDesktopModelId&&OK.getCurrentDesktopModelId())||F;if("PerformanceObserver" in window){try{D=new PerformanceObserver(function(M){var K=M.getEntries();for(var L=0;b&&(L<K.length);L++){v+=1;}}).observe({entryTypes:["longtask"]});}catch(J){H.success("longtask.error","unsupported");}}if(m){window.addEventListener("navigationStateChanged",h);document.addEventListener(m,z,false);}k();}function d(){y(false);if(D){D.disconnect();}if(m){window.addEventListener("navigationStateChanged",h);document.removeEventListener(m,z);}}return{activate:e,deactivate:d};});