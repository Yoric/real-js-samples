define(["OK/capture","OK/logger","OK/utils/vanilla","OK/utils/throttle"],function(i,h,e,g){var b=0.5;function c(p){var m=p.response,q=p.xhr,o=this.list,n=o.lastChild,j,l=[];function k(){this.hookElement.classList.remove("in-progress");this.loading=false;e.trigger(this.hookElement,"dataload",{elements:l});}if(q.getResponseHeader("fetchedAll")==="true"){this.deactivate();}this.lastElement=q.getResponseHeader("lastelem");if(m===null||m.length===0){k.call(this);return l;}o.insertAdjacentHTML("beforeend",m);if(OK.hookModel.dispatchDataLoadedEvent){OK.hookModel.events.dispatchDataLoadedEvent();}j=n===null?o.firstChild:n.nextSibling;while(j!==null){i.activate(j);l.push(j);j=j.nextSibling;}this.page=this.page+1;this.hookElement.setAttribute("data-page",this.page);this.autoPage=this.autoPage+1;if(this.isManual){if(!this.isDeactivated){this.hookElement.classList.remove("loader-container");}this.switchToAuto();}else{this.switchToManual();}k.call(this);return l;}function f(){var j=document.body,k=document.documentElement;return Math.max(j.scrollHeight,j.offsetHeight,k.clientHeight,k.scrollHeight,k.offsetHeight);}var a=function(){this.loading=false;};function d(){if(this.forceBottomEdge||this.scrollingContainer!==window){if(this.scrollingContainerId&&this.scrollingContainer!==window){return this.scrollingContainer.scrollTop+this.scrollingContainer.offsetHeight>this.scrollingContainer.scrollHeight-this.forceBottomEdge;}return window.pageYOffset>f()-document.documentElement.clientHeight-this.forceBottomEdge;}var l=this.hookElement.getBoundingClientRect();var j=window.innerHeight-l.top;var k=l.height-j;return k<(window.innerHeight*b);}a.prototype={handleEvent:function(j){if(!document.body.contains(this.hookElement)){h.error("loader","oldQuery");this.deactivate();return;}switch(j.type){case"click":if(!this.loading){this.hookElement.classList.add("in-progress");this.hookElement.classList.add("loader-container");this.loadMore();}j.preventDefault();break;case"scroll":if(!this.loading&&d.call(this)){this.hookElement.classList.add("in-progress");this.loadMore();}break;}},activate:function(j){this.hookElement=j;this.list=this.hookElement.firstChild;this.showMoreButton=this.hookElement.getElementsByClassName("js-show-more")[0];this.url=this.hookElement.getAttribute("data-url");this.params=this.hookElement.getAttribute("data-params");this.dynamic=this.hookElement.getAttribute("data-dynamic");this.forceBottomEdge=this.hookElement.getAttribute("data-forcedbottomedge")||0;this.dataMax=this.hookElement.getAttribute("data-max")||0;this.manualPagesCount=this.hookElement.getAttribute("data-manualpagescount")||0;this.scrollingContainerId=this.hookElement.getAttribute("data-scroller");this.staticParams=this.params?this.params.split("&"):[];this.dynamicParams=this.dynamic?this.dynamic.split(","):[];this.lastElement=this.hookElement.getAttribute("data-last-element");this.pageParamsName=this.hookElement.getAttribute("data-pageParam")||"st.page";var k=this.hookElement.getAttribute("data-page");if(k){this.page=parseInt(k,10);}else{this.page=1;}this.autoPage=this.page;this.isManual=false;this.isDeactivated=false;this.throttledHandleEvent=g(200,this.handleEvent.bind(this));if(this.scrollingContainerId){this.scrollingContainer=document.getElementById(this.scrollingContainerId);}if(!this.scrollingContainer){this.scrollingContainer=window;}this.switchToManual();if(!this.isManual){this.scrollingContainer.addEventListener("scroll",this.throttledHandleEvent,false);}Object.defineProperty(this.hookElement,"getLoader",{enumerable:false,configurable:false,writable:false,value:function(){return this;}.bind(this)});},deactivate:function(){this.scrollingContainer&&this.scrollingContainer.removeEventListener("scroll",this.throttledHandleEvent,false);this.showMoreButton&&this.showMoreButton.removeEventListener("click",this.throttledHandleEvent,false);this.hookElement.classList.add("loader-container","loader__done");this.isDeactivated=true;},switchToManual:function(){function j(){return this.page>this.autoPage&&this.autoPage>this.manualPagesCount;}function k(){return this.page==this.autoPage&&this.page>this.dataMax;}if(!this.isManual&&!this.isDeactivated){if(k.call(this)||j.call(this)){this.hookElement.classList.remove("loader-container");this.scrollingContainer.removeEventListener("scroll",this.throttledHandleEvent,false);this.showMoreButton.addEventListener("click",this.throttledHandleEvent,false);this.isManual=true;}}},switchToAuto:function(){if(this.manualPagesCount>1&&this.isManual&&!this.isDeactivated){this.hookElement.classList.add("loader-container");this.scrollingContainer.addEventListener("scroll",this.throttledHandleEvent,false);this.showMoreButton.removeEventListener("click",this.throttledHandleEvent,false);this.isManual=false;this.autoPage=1;}},loadMore:function(n){if(this.isDeactivated){this.hookElement.classList.remove("in-progress");return Promise.resolve([]);}this.loading=true;n=Object.assign({fetch:this.isManual},n);var s=this.list.lastChild,q=this.url,r=this.staticParams,j=this.dynamicParams,p=this.lastElement,o,m,k;n[this.pageParamsName]=this.page+1;if(r.length){for(o=0;o<r.length;o+=1){k=r[o];m=k.split("=");if(m.length===2){n[m[0]]=m[1];}}}if(j.length){for(o=0;o<j.length;o+=1){k=j[o];n[k]=s.getAttribute(k);}}if(p){n["st.lastelem"]=p;}var l=e.ajax({url:q,data:n});return l.then(c.bind(this));}};return a;});