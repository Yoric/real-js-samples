define(["jquery","factory","counters","client-server","audio-player","util/schedule","util/find-event-target","util/num-end","util/hosts","external/cookie"],function(a,b,c,d,e,f,g,h,i,j){"use strict";function k(){b("product-tools/auth-form",function(a){a.show()})}var l,m=window.parseInt,n=function(a,b){return(a+3)*b+5*(b-1)};return{init:function(a,b,c){l=this,this.elem=a,this.config=c},destroy:function(){delete this.elem},expandContent:function(a,c){var d=g(c,'[data-type="text-container"]');a.addClass("process"),b("hashtag/main",function(b){this.hashtag=new b,this.hashtag.onExpandClick(a,c,d)}.bind(this))},expandPhotoItems:function(a,b){var c=a.siblings(".b-history-event__event_more");b.stopPropagation(),c.addClass("expand"),a.addClass("hidden")},expandApp:function(b,c){var d=a(b).closest(".b-history-event__body_app-action"),e=JSON.parse(d.find(".b-history-event__app-action_config").html()),f=d.find(".b-history-event__app-action_title .link-black"),g=d.find(".b-history-event__share-text_description-text");f.html(e.title),g.html(e.description),b.remove()},showVideo:function(b){var c,d=b.parent().parent(),e=d.find(".b-history-event__embed-video__content");a(document).trigger("SharedVideo.play").one("VideoPlayer.play SharedVideo.play",function(){d.removeClass("b-history-event__share_show-video"),d.find(".b-history-event__embed-video__video").remove()}),d.addClass("b-history-event__share_show-video"),a(e.html()).insertAfter(e),this.initedVideos=this.initedVideos||{},a.each(this.initedVideos,function(b,d){c=a("#"+d.object.wrapperId),c&&c[0]&&c[0].call("pause")})},shareVideo:function(a,c){c.preventDefault(),c.stopPropagation(),b("video-html5/share",function(b){var c={videoLocation:a.data("videoLocation")},d=a.data("shareType");b.init(c),b.openWindow(d,"fromHistory")})},playVideo:function(c,d){var f,h=c.data("videoExternalId")+c.closest("[data-id]").data("id");this.config=a.extend({playerId:h},this.config),d.preventDefault(),d.stopPropagation(),d.cancelBubble=!0;try{f=JSON.parse(c.find('script[type="text/plain"]').html().replace(/\r|\n|\t|\s{2,}/g,"")),0===c.attr("data-video-guestbook").length&&c.attr("data-video-height")&&(f.flash.video.height=c.attr("data-video-height")-30),f.referrer="lenta"}catch(a){f={}}return this.initedVideos=this.initedVideos||{},this.initedVideos[h]||a(d.target).hasClass("b-history-event__videoevent-title")||g(d,".b-history-event__videoevent-title")||(c.children().remove(),c.attr("data-history-action","").removeAttr("href").attr("nohref",!0),b("video-html5/video",function(b){this.initedVideos[h]={element:c,options:f,object:b.createRunTime(f,c)},e.getPlayer()&&null!==e.getPlayer().getTrack()&&a(document).trigger("AudioPlayer.stop")}.bind(this))),h},restoreVideo:function(b,c){var d,e,f=b.data("externalId")+b.closest("[data-id]").data("id");this.initedVideos=this.initedVideos||{},d=this.initedVideos[f],d&&(e=d.element,d.object.destroy(),e.append(a('<span class="b-history-event__videoevent-play"></span>')),e.append(a('<script type="text/plain">'+JSON.stringify(d.options)+"</script>")),e.attr("data-history-action","playVideo"),this.initedVideos[f]=null)},addHoliday:function(a,c){c.preventDefault();var d=a.data(),e={id:d.id,type:d.type,name:d.name,day:d.day,month:d.month};a.hasClass("ui-button-main")&&a.removeClass("ui-button-main").addClass("ui-button-link"),a.removeAttr("data-history-action"),b("product-tools/holidays",function(b){b.sendAjaxAddHoliday(e,function(){a.html(d.addSuccess),void 0!==d.classSuccess&&a.addClass(d.classSuccess)},function(){a.html(d.addError)})})},dropMicropost:function(b,c){var e=g(c,".b-history-event"),f=b.attr("data-history-confirm"),h=b.attr("data-history-id"),i=b.attr("data-history-email");window.confirm(f)&&(b.attr("data-history-action",""),b.addClass("process"),d.func("history.remove_micropost",[h],{url:"/cgi-bin/my/ajax?user="+i,success:function(c){c=a.parseJSON(c),"ok"===c[2]?e.addClass("deleted").html(b.attr("data-history-status")):"not found"!==c[2]&&"forb"!==c[2]||b.removeClass("process").addClass("error")},error:function(){b.removeClass("process").addClass("error")},complete:function(){e=null,b=null}}))},showAddVideo:function(d,e){var f,g=l,h=d.data();e.preventDefault(),e.stopPropagation(),d.hasClass("disabled")||(c.myrb(7208116),h.activeEmail?(g.albumSelector&&(f=g.albumSelector.items,g.albumSelector.destroy()),b("media/video/album-selector",function(b){g.albumSelector=b.create({content:a(g.config.videoAlbumSelectorTemplate),user:h.activeEmail,currentId:void 0,videoEmail:h.videoEmail,isChannel:h.isChannel,isCommunity:h.isCommunity,item:h.videoItem,container:a("[data-mru-app-section='body']"),autoAdd:!0,locales:g.config.locales,activeDir:g.config.activeDir}),f&&g.albumSelector.addItems(f),g.albumSelector.show(d)})):k())},expandEvent:function(b){var c,f,g,i,j={},k="data-event-",l="data-history-action",n=b.attr(l);b.addClass("process"),b.attr(l,""),["id","userid","offset","limit","page","total","juser"].forEach(function(a){j[a]=b.attr(k+a)}),["offset","limit","total"].forEach(function(a){j[a]=m(j[a])}),f=this.elem.find('[data-history-event-container="'+j.id+'"]'),f.addClass("loading"),g=f.height(),f.attr("originalHeight")?f.css("height",g):f.attr("originalHeight",g).css("height",g),i=b.parent().outerHeight(!0),d.func("history.get_sub_events",[j.id,j.userid,j.offset,j.limit,j.page],{url:"/cgi-bin/my/ajax?user="+j.juser,success:function(d){var g,i;d=a.parseJSON(d),b.attr(k+"offset",j.offset+j.limit),"audio:Playlist"===f.data("type")?(g=f,i=e.getPlaylistById(j.id),i?(i.setElement(f),i.getElement().append(d[2]),i.createTracks()):(g.append(d[2]),i=e.createPlaylist({id:g.data("historyEventContainer"),eventType:g.data("eventType"),element:g,fragment:"history"}),i.createTracks())):f.append(d[2]),c=j.total-j.offset-j.limit,c>0?h.ending(b.find(".b-history-event__expand-count"),c):f.parents(".b-history-event").addClass("loaded")},error:function(){b.addClass("error")},complete:function(){b.removeClass("process"),f.css("height",g+i),f.animate({height:f.prop("scrollHeight")},500,function(){f.attr("style",""),f.removeClass("loading"),f=null}),b.attr(l,n),b=null,j=null}})},expandFriends:function(a){var b,c,d=a.parents(".b-history-event"),e="<![CDATA[ SPLITTER ]]>",f=d.find('[data-type="other-friends"]'),g=f.html()||"",i=d.find("[data-history-event-container]"),j="data-event-offset",k=m(a.attr(j))||0,l=m(a.attr("data-event-total")),n=l,o=g.replace("<!--","").replace("-->","").split(e),p=o.length;a.addClass("process"),b=i.height(),i.attr("originalHeight")?i.css("height",b):i.attr("originalHeight",b).css("height",b),o.length&&(g=o.splice(k,n),i.append(g.join("")),k+n<p?(a.attr(j,k+n),c=l-k-n):(a.attr(j,""),d.addClass("loaded"),c=l),h.ending(a.find(".b-history-event__expand-count"),c),i.animate({height:i.prop("scrollHeight")},500,function(){i.attr("style",""),i.removeClass("loading"),i=null})),a.removeClass("process")},hideHolidayToday:function(a){var b=new Date,c=new Date(b.getFullYear(),b.getMonth(),b.getDate(),23,59,59),d=a.attr("data-active-email");a.hide(),a.parent().fadeOut(),c.setDate(c.getDate()),j.set("_hh_"+d,"1",{expires:c,domain:i.getCookieDomain(),path:"/"})},hidePromo:function(a){var b=new Date,c=a.attr("data-active-email");a.hide(),a.parent().fadeOut(),b.setDate(b.getDate()+7),j.set("_hp_"+c.replace("@","."),"1",{expires:b,domain:i.getCookieDomain(),path:"/"})},enterGroup:function(b,e){var f=a(b),g=f.data("email"),h=f.data("ref"),i=f.data("textJoined"),j=f.data("textError"),l=f.data("textModer"),m=f.data("counter"),n=f.data("activeEmail"),o={success:"done",error:"error"};return e.preventDefault(),n?void(f.hasClass("progress")||f.hasClass(o.success)||f.hasClass(o.error)||(f.addClass("progress"),d.func("groups.join",{email:g,ref:h||""},{dataType:"JSON",success:function(a){f.removeClass("progress"),"ok"===a[2]?"joined"===a[3]?(c.myrb(m),f.html(i).addClass(o.success)):"for_moderate"===a[3]?(c.myrb(m),f.html(l).addClass(o.success)):f.html(j).addClass(o.error):f.html(j).addClass(o.error)},error:function(){f.removeClass("progress"),f.html(j).addClass(o.error)}}))):(k(),!1)},openShareLink:function(a,b){var c=a.attr("href").split("#");b.stopPropagation(),b.preventDefault(),c&&c.length&&c[1]&&(c=c[0]+"&anchor="+encodeURIComponent(c[1])),window.open(c)},repaintPosts:function(b){var c,d,e;b.find('[data-history-event="text-resize"]').each(function(){e=a(this),c=e.height(),d=parseInt(e.css("font-size"),10),c>n(d,3)&&(e.addClass("b-history-event__event-textbox_status-type1"),c=e.height(),d=parseInt(e.css("font-size"),10),c>n(d,4)&&(e.addClass("b-history-event__event-textbox_status-type2"),c=e.height(),d=parseInt(e.css("font-size"),10),c>n(d,5)&&e.addClass("b-history-event__event-textbox_status-type3"))),e.removeAttr("data-history-event")})},cutAppPosts:function(b){b.find(".b-history-event__app--install_txt-inner").each(function(){var b=a(this);b.height()<=60&&b.parent().removeClass("b-history-event__app--install_txt-cut")})},openAuthPopup:function(a,b){b.preventDefault(),b.stopPropagation(),k()},repost:function(a){this.isRepostThrottled||(this.isRepostThrottled=!0,setTimeout(function(){this.isRepostThrottled=!1}.bind(this),1e3),b("home/history/repost",function(b){b.createRunTime(a).renderGroups(a)}))},addPlaylist:function(a){b("music-reskin/models/playlist.model",function(b){var c=new b({ID:a.data("id")}),d=function(){a.removeAttr("data-history-action").addClass("done")};c.subscribe().then(function(){d()},function(a){"already_exists"===a[3]&&d()})})},astat:function(a){var b,d=a.parents("[data-astat]");d&&d.length&&(b=d.data("astat").split(":"),c.astat({type:b[1],evid:b[2],action:"ExternalURL",version:"1",category:"news-feed-actions",actor_id:b[0]||"0",owner_id:b[3]||"0",parent_owner_id:b[4]||"0",parent_evid:b[5]||"0",create_time:b[8]||"0",is_recommend:b[9]||"0"}))}}});