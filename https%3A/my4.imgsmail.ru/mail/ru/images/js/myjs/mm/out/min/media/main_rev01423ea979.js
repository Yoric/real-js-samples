define(["jquery","client-server","counters","factory","util/uri","util/promise","util/css-manager","util/helpers","app/history"],function(a,b,c,d,e,f,g,h,i){function j(){i.changeEvent.on("suppress",function(a,b){var c=q(e(i.page()).data.path,{});b=b||{},c&&c.id&&c.type?(c.type!==r.layerType&&("photo"===r.layerType?l.hide():"video"===r.layerType&&k.hide()),["multipost","micropost","share","video-item-page"].indexOf(c.navigation)===-1&&r.openLayer(h.extend(c,b.data||{}),b.oldUrl)):r.closeLayers()})}var k,l,m,n={video:"media/video",photo:"media/photo",history:"media/history-layer"},o={dummy:{"not-found":"https://my7.imgsmail.ru/mail/ru/images/my/filed-default/layer/404.png",access:"https://my7.imgsmail.ru/mail/ru/images/my/filed-default/layer/403.png",error:"https://my7.imgsmail.ru/mail/ru/images/my/filed-default/layer/404.png",encodedNow:"https://my7.imgsmail.ru/mail/ru/images/my/compass/static/video/video-blank.png"}},p=["photo","video","micropost","multipost"],q=function(b,c){var d,f,g,j,k,l=b.split("/"),m=e(i.page());return l&&l.length&&l[3]&&(p.indexOf(l[3])>-1?(d=l[1],f=l[2],g=l[3]):"catalog"===l[2]?(f=l[0]||"pladform_video",k=l[4],j=l[3],d="community",g="video",c.isLegalUrl=!0):p.indexOf(l[1])>-1&&(g=l[1],d=l[2],f=l[3])),g?(c.type=g,c.category=j,c.dir=c.content="/"+d+"/"+f+"/",c.albumId=k,c=a.extend({sort:m.param("sort")||!1,stream:m.param("ps")||!1,timeStamp:m.param("timestamp")||!1,promoBlock:m.param("pb")||!1},c),("photo"===g||"video"===g)&&l[4]&&l[5]?(c.album=l[4],c.id=window.parseInt(l[5].replace(".html","")),c.path=c.content+c.album,c.externalId=c.path+"/"+c.id,"photo"===g?"_animated"===c.album?c.ext=".gif":c.ext=".jpg":c.videoMoviesrc=c.externalId):"micropost"!==g&&"multipost"!==g||!l[4]?c=!1:c.id=l[4].replace(".html",""),c&&(c.cache="",c=h.extend({},o,c))):c=!1,c},r={openLayer:function(a,b){var c,d=b||i.page();this.savedPage||(this.savedPage=d),c=[g.require("media"),g.require("components.comments.comments")],!a||"micropost"!==a.type&&"multipost"!==a.type||c.push(g.require("components.history.history")),f.all(c).then(this.onReadyStyles.bind(this,a,d)).catch(function(a){webConsole.error(a)})},onReadyStyles:function(b,e){var f=b.type;"photo"===f?(d(n.photo,function(d){l||(l=d,l.create().onLoad(a(".b-fragment-photo")),l.closeEvent.on(this.onClose.bind(this)),l.changePhotoEvent.on(this.changeUrl.bind(this))),d.show(b)&&c.myrb(713132)}.bind(this)),i.setDefaultState("suppress")):"video"===f?(this.layerType=f,d(n.video,function(c){k||(k=c,k.create().onLoad(a(".b-fragment-video")),k.closeEvent.on(this.onClose.bind(this)),k.changeVideoEvent.on(this.changeUrl.bind(this)),c.relatedDeep=0,this.isFirstVideoOpen=!0),c.relatedDeep=this.isFirstVideoOpen?0:c.relatedDeep,this.isFirstVideoOpen=!1,c.show(b)}.bind(this)),i.setDefaultState("suppress")):"micropost"===f||"multipost"===f?(this.layerType=f,d(n.history,function(c){m||(m=c,m.create().onLoad(a(".b-fragment-history-layer")),m.closeEvent.on(this.onClose.bind(this)),m.showEvent.on(this.changeUrl.bind(this))),this.savedSubPage||c.show(b.id,b.type,b.content,b.parent)}.bind(this)),i.setDefaultState("suppress")):i.setDefaultState()},closeLayers:function(){l&&l.hide(),k&&(k.hide(),this.isFirstVideoOpen=!0),m&&m.hide(),i.setDefaultState()},parseClick:function(b){var d,f,g,h,j,k=window.document,l=a(b.target);!l.attr("href")&&l.attr("data-layer-closest")&&(l=l.closest("[href]")),j=void 0!==l.attr("href")?e(l.attr("href")):"",k.getSelection?d=k.getSelection().toString().length:k.selection&&(d=k.selection.createRange().text.length),j&&j.data&&0===d&&(h=q(j.data.path,{sort:l.attr("data-photo-sort")||!1,stream:l.attr("data-photo-stream")||!1,showCommentArea:l.attr("data-show-comments")||!1,promoBlock:l.attr("data-promo-block")||!1,filedimageurl:l.attr("data-filedimageurl"),referer:l.attr("data-referer"),parent:j.param("parent"),queryId:l.attr("data-qid"),queryCurrentId:l.attr("data-current-qid"),urlSerp:l.attr("data-serp"),itemIndex:l.attr("data-index")}),h&&h.id&&(b.preventDefault(),b.stopPropagation(),b.cancelBubble=!0,this.layerType&&h.type!==this.layerType&&!this.savedSubPage&&(this.savedSubPage=i.page()),f=l.parents("[data-dwh]"),f&&f.length&&(g=f.data("dwh").split(":"),c.dwh({version:1,category:{"news-feed-actions":{UserID:g[0]||"0",Type:g[1],EvID:g[2],JournalID:g[3],ParentJournalID:g[4],ParentEvID:g[5],Action:"Layer",IsRecommend:g[9]}}})),f=l.parents("[data-astat]"),f&&f.length&&(g=f.data("astat").split(":"),c.astat({type:g[1],evid:g[2],action:"Layer",version:"1",category:"news-feed-actions",actor_id:g[0]||"0",owner_id:g[3]||"0",parent_owner_id:g[4]||"0",parent_evid:g[5]||"0",create_time:g[8]||"0",is_recommend:g[9]||"0"})),"video"===h.type?this.changeUrl(b,h,!0):this.openLayer(h)))},parseUrlClick:function(a,b){var c=q(b,{});this.openLayer(c)},changeUrl:function(a,b,c){var d;c=c||!1,"function"==typeof b.sort&&(b.sort=!1),d=b.videoMoviesrc||b.isVideo?b.content+"video/"+b.album+"/"+b.id+".html":b.postId&&b.postDir&&b.postType?b.postDir+b.postType+"/"+b.postId+".html":b.content+"photo/"+b.album+"/"+b.id+".html",b.isLegalUrl&&(d="/video/catalog/"+b.category+"/"+b.album+"/"+b.id+".html"),b.sort&&(d+="?sort="+b.sort),b.stream&&(d+=b.sort?"&":"?",d+="ps="+b.stream),b.timeStamp&&(d+=b.sort||b.stream?"&":"?",d+="timestamp="+b.timeStamp),b.promoBlock&&(d+=b.sort||b.stream||b.timeStamp?"&":"?",d+="pb="+b.promoBlock),(location.pathname+location.search!==d||c)&&i.page(d,i.SetHashModes.SUPPRESS_EVENT,{queryId:b.queryId,queryCurrentId:b.queryCurrentId,urlSerp:b.urlSerp,itemIndex:b.itemIndex})},onClose:function(){var a=this.savedSubPage||this.savedPage;b.abortAll(),i.setDefaultState(),a&&(i.page(a,i.SetHashModes.SUPPRESS_EVENT),this.savedSubPage?delete this.savedSubPage:(delete this.layerType,delete this.savedPage))},destroy:function(){delete this.layerType,delete this.savedPage,delete this.savedSubPage}};return{create:function(){var b=r,c=a("body"),d=r.parseClick.bind(r);return{onLoad:function(e){var f,g,k=i.page();j(),g=a.parseJSON(e.html()),o=h.extend(o,g),c.on("click",'[type="photolayer"]',d),c.on("click",'[type="videolayer"]',d),c.on("click",'[type="historylayer"]',d),f=o.idForLayer.length>0?q(o.linkForLayer,{}):q(k,{}),f&&f.type&&f.id&&(k="micropost"===f.type||"multipost"===f.type?f.content:k.replace(/\/[^\/]+\.html[^\/]*$/,""),b.openLayer(f,k))},onUnload:function(){c.off("click touchend",'[type="photolayer"]',d),c.off("click touchend",'[type="videolayer"]',d),c.off("click touchend",'[type="historylayer"]',d),r.closeLayers(),r.destroy(),o={},i.setDefaultState(),m&&(m.create().onUnload(),m=null),k&&(k.create().onUnload(),k=null),l&&(l.create().onUnload(),l=null)}}},parseURL:function(a){return q(a,{})},openLayer:function(a){var b=q(a,{});b&&b.type&&b.id&&(a="micropost"===b.type||"multipost"===b.type?b.content:a.replace(/\/[^\/]+\.html[^\/]*$/,""),r.openLayer(b,a))},closeLayers:function(){r.closeLayers(),r.onClose()}}});