define(["jquery","counters","base/view","util/helpers","plugins/jQuery.XDomainRequest","plugins/swfobject","plugins/ua-parser"],function(a,b,c,d){"use strict";var e=c.extend({props:{deferred:{flash:"video-html5/flash",html5:"video-html5/html5",albumSelector:"media/video/album-selector",history:"app/history"},defaultOptions:{flash:{video:{width:"100%",height:"100%"},videoplayer:{autoplay:"1",preview:"0",noLike:1,noUpload:1}},adv:{delay:5,slot:3999},contentHost:"//content.video.mail.ru/",external:!1},cssClasses:{main:"b-video-html5",video:"b-video-html5__video"},vars:{wrapperId:"",MIN_FLASH_VERSION:"11.1",$playerContainer:null},CNT:{canPlay:1701805,unSupport:1701807,withPlayOrError:1767275,playClick:1815744,fromMyMail:1845846,showAuth:23841635,playAuth:23841636,playClickFromMyMail:1846029,channelStarted:6086848,channelError:6087008,videoError:13042926,legalHtml:7764216,backscreenShown:13042904,turnOnAutoplay:18908744,turnOffAutoplay:189087206,hasEmailInUrl:23491715,addVideo:7696390,albumSelector:7208107,videoAdded:1605262,reconnect:25035541}},public:{init:function(){return this.wrapperId=this.$el.attr("id")||Math.random().toString(36).slice(2),this.$el.addClass(this.cssClasses.main).empty().attr("id",this.wrapperId),this.$playerContainer=this.$el.parent(),this.isFlashSupport()?this.options.isLegal||!this.isMp4Supported()||!this.options.html5Only&&"0"!==this.options.flashEnabled?this.initFlash():this.initHtml5():(this.initHtml5(),this.options.isLegal&&b.myrb(this.CNT.legalHtml)),this.documentEventHandler={addVideoClick:this.addVideoClick.bind(this),playerStart:this._onVideoStartMulticast.bind(this),playerRelatedClicked:this._onRelatedItemClick.bind(this),playerPlay:this._onVideoPlayMulticast.bind(this),playerPause:this._onVideoPauseMulticast.bind(this),playerEnded:this._onVideoEndedMulticast.bind(this)},a(document.body).on("addVideoClick",this.documentEventHandler.addVideoClick).on("VideoPlayer.relatedClicked",this.documentEventHandler.playerRelatedClicked),a(document).on("VideoPlayer.start",this.documentEventHandler.playerStart).on("VideoPlayer.play",this.documentEventHandler.playerPlay).on("VideoPlayer.pause",this.documentEventHandler.playerPause).on("VideoPlayer.end",this.documentEventHandler.playerEnded),this.$el.on("click",function(a){a.stopImmediatePropagation()}),this},destroy:function(){return this.isDestroyed||(this.handleComplete(),this.player&&this.player.destroy(),a(document.body).off("addVideoClick",this.documentEventHandler.addVideoClick).off("VideoPlayer.relatedClicked",this.documentEventHandler.playerRelatedClicked),a(document).off("VideoPlayer.start",this.documentEventHandler.playerStart).off("VideoPlayer.play",this.documentEventHandler.playerPlay).off("VideoPlayer.pause",this.documentEventHandler.playerPause).off("VideoPlayer.end",this.documentEventHandler.playerEnded),e.__super__.destroy.call(this)),this},setUserBackScreen:function(a){this.player&&this.player.setUserBackScreen(a)},setBackScreenAutoPlay:function(a){this.player&&(this.player.setBackScreenAutoPlay(a),b.myrb(a?this.CNT.turnOnAutoplay:this.CNT.turnOffAutoplay))},pauseNextVideo:function(a){this.player&&this.player.pauseNextVideo(a)},play:function(){!this.completed&&this.player&&this.player.play()},pause:function(){this.player&&this.player.pause()},isPlaying:function(){return this.playing}},protected:{initHtml5:function(){this.require("html5",function(a){this.isDestroyed||(this.player=a.createRunTime(d.extend(!0,{},this.options),this.$el))}.bind(this))},initFlash:function(){this.require("flash",function(a){this.isDestroyed||(this.player=a.createRunTime(d.extend(!0,{minFlashVersion:this.MIN_FLASH_VERSION},this.options),this.$el))}.bind(this))},addVideoClick:function(a,c,d){c.get(0)!==this.$el.get(0)&&!this.$playerContainer.has(c.get(0)).length||c.hasClass("disabled")||(d&&(this.isChannel=d.isChannel,this.isCommunity=d.isCommunity),b.myrb(this.CNT.addVideo),a.stopImmediatePropagation(),setTimeout(function(){this.showAlbumSelector(a,c)}.bind(this),100))},showAlbumSelector:function(c,d){this.require("albumSelector",function(c){var e;b.myrb(this.CNT.albumSelector),this.albumSelector&&(e=this.albumSelector.items,this.albumSelector.destroy()),this.albumSelector=c.create({content:a(this.options.videoAlbumSelectorTemplate),user:this.options.activeEmail,item:this.options.videoItem,autoAdd:!0,videoEmail:this.options.videoEmail,isChannel:this.isChannel,isCommunity:this.isCommunity,locales:this.options.locales,activeDir:this.options.activeDir,insideTarget:!0}),e&&this.albumSelector.addItems(e),this.albumSelector.show(d)}.bind(this))},_onVideoStartMulticast:function(a,b){this.$playerContainer.has(b).length&&(this._onVideoStarted(),this.player.initApi())},_onVideoPlayMulticast:function(a,b){this.$playerContainer.has(b).length?(this.playing=!0,this.completed=!1):this.pause()},_onVideoPauseMulticast:function(a,b){this.$playerContainer.has(b).length&&(this.playing=!1)},_onVideoEndedMulticast:function(a,b){this.$playerContainer.has(b).length&&(this.handleComplete(),this.completed=!0,this.playing=!1)},_onRelatedItemClick:function(a,b,c){c&&!this.$playerContainer.has(c).length||this.require("history",function(a){var c=a.page().indexOf("/multipost/")!==-1;this.options.linkToPage||c?location.href=location.protocol+"//"+location.host+b:a.page(b,a.SetHashModes.SUPPRESS_EVENT)}.bind(this))},_onVideoStarted:function(){var a,c;a=this.$playerContainer.parents("[data-dwh]"),a&&a.length&&(c=a.data("dwh").split(":"),c.length>5&&b.dwh({version:1,category:{"news-feed-actions":{UserID:c[0]||"0",Type:c[1],EvID:c[2],JournalID:c[3],ParentJournalID:c[4],ParentEvID:c[5],Action:"Player",IsRecommend:c[9]}}})),a=this.$playerContainer.parents("[data-astat]"),a&&a.length&&(c=a.data("astat").split(":"),c.length>5&&b.astat({type:c[1],evid:c[2],action:"Player",version:"1",category:"news-feed-actions",actor_id:c[0]||"0",owner_id:c[3]||"0",parent_owner_id:c[4]||"0",parent_evid:c[5]||"0",create_time:c[8]||"0",is_recommend:c[9]||"0"}))},isFlashSupport:function(){return swfobject.hasFlashPlayerVersion(this.MIN_FLASH_VERSION)},isMp4Supported:function(){var a=document.createElement("video");return!!a.canPlayType&&!!a.canPlayType("video/mp4")},handleComplete:function(){if(!this.completed&&this.player){var a=this.player.getTime(),b=a.duration,c=a.currentTime;this.options.queryCurrentId&&this.options.queryId&&this.options.itemIndex&&b>0&&this.sendGoStat("vt",this.options.queryId,this.options.queryCurrentId,this.options.itemIndex,parseInt(c,10),parseInt(b,10),this.options.urlSerp)}},sendGoStat:function(a,b,c,d,e,f,g){var h="https://go.imgsmail.ru/mm?pxn="+a+"&e="+b+"&e2="+c+"&u="+encodeURI(g)+"&n="+d;f&&(h+="&t="+e+"&d="+f),document.createElement("img").setAttribute("src",h)}}});return e});