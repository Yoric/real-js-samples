_.Module.define({path:"encourage-payment/widget/tdou_view_check",requires:["encourage-payment/widget/tdou_builder","encourage-payment/widget/tdou_data","encourage-payment/widget/tdou_view_util"],sub:{initial:function(){this.builder=this.requireInstance("encourage-payment/widget/tdou_builder"),this.dataProxy=this.requireInstance("encourage-payment/widget/tdou_data"),this.viewUtil=this.requireInstance("encourage-payment/widget/tdou_view_util")},showTdouCheckView:function(e,i,t){var n=this;n._wrap=e||$("body");var o=(n._wrap.height()-208)/2+"px",c=(n._wrap.width()-520)/2+"px",d={top:o,left:c},u=n._wrap.find(".j_tdou_get_icon_check");if(0==u.length){var a=this.builder.builderTdouCheck();u=$(a),n._wrap.prepend(u),n._bindEvents(u,i,t)}n.viewUtil.setMask(e),u.css(d),u.show()},hideTdouCheckView:function(){var e=this._wrap.find(".j_tdou_get_icon_check");e.hide(),this.viewUtil.removeMask()},_bindEvents:function(e,i,t){var n=this;e&&e.on("click",".j_header_close",function(){n.hideTdouCheckView()}).on("click",".j_check_btn",function(){n.hideTdouCheckView(),"function"==typeof i&&n._onCheckTdou(i,t)}).on("click",".j_btn_redo_check",function(){n._onRedoBuyIcon()})},_onCheckTdou:function(e,i){"function"==typeof e&&"object"==typeof i&&e.call(i)},_onRedoBuyIcon:function(){this.hideTdouCheckView()}}});_.Module.define({path:"encourage-payment/widget/tdou_counter",sub:{onValueChange:[],initial:function(){},builderUI:function(t){var a=['<div id="tdou_counter_#{id}" class="tdou_calc_count j_tdou_calc_count">','    <button class="tdou_calc_op tdou_calc_minus j_tdou_calc_minus">-</button>','    <input class="tdou_calc_input j_tdou_calc_input" type="text" value="1"/>','    <button  class="tdou_calc_op tdou_calc_add j_tdou_calc_add">+</button>',"</div>"].join(""),n=$.tb.format(a,{id:t});return n},bindEvents:function(t){var a=this;if(t){var n=999999,c=t.find(".j_tdou_calc_input"),e=t[0].id.replace("tdou_counter_","");t.delegate(".j_tdou_calc_minus","click",function(){var t=parseInt(c.val())||1;t=Math.max(1,t-1),t=Math.min(n,t),c.val(t),a.triggerValChange(t,e)}).delegate(".j_tdou_calc_add","click",function(){var t=parseInt(c.val())||1;t++,t=Math.min(n,t),c.val(t),a.triggerValChange(t,e)}).delegate(".j_tdou_calc_input","input propertychange",function(){var t=/^[1-9]\d*$/,o=c.val();(o&&!t.test(o)||t.test(o)&&o>999)&&(o=o.replace(/\D/g,"").replace(/^0(\d*)$/,"$1"),o=Math.min(n,o),c.val(o),a.triggerValChange(o,e))});var o=function(){var t=c.val()&&parseInt(c.val())>0&&parseInt(c.val())||1;t=Math.min(n,t),c.val(t),a.triggerValChange(t,e)};c.on("blur",function(){o()}).on("keydown",function(t){13==t.keyCode&&o()})}},triggerValChange:function(t,a){for(var n=0;n<this.onValueChange.length;n++){var c=this.onValueChange[n];c.action&&"function"==typeof c.action&&c.context&&c.action.call(c.context,t,a)}}}});_.Module.define({path:"encourage-payment/widget/tdou_view",requires:["encourage-payment/widget/tdou_builder","encourage-payment/widget/tdou_data","encourage-payment/widget/tdou_counter","encourage-payment/widget/tdou_view_util","encourage-payment/widget/tdou_view_check","encourage-payment/widget/TdouOpenType","encourage-payment/widget/qianbao_purchase_tdou","encourage-payment/widget/umoney_query"],sub:{PayMemberUrl:"/tbmall/getMyPayType",CASHIER:1,QIANBAO:2,initial:function(e){e=$.extend({},e);e.scores,e.level;this.builder=this.requireInstance("encourage-payment/widget/tdou_builder"),this.dataProxy=this.requireInstance("encourage-payment/widget/tdou_data",{scores:e.scores,level:e.level}),this.counter=this.requireInstance("encourage-payment/widget/tdou_counter"),this.viewUtil=this.requireInstance("encourage-payment/widget/tdou_view_util"),this.checkTdou=this.requireInstance("encourage-payment/widget/tdou_view_check"),this.openTypeList=this.requireInstance("encourage-payment/widget/TdouOpenType",{type:"tdou"})},createMain:function(e,t,n,o){var a=this;a.consumption_path=e,a.desc=t,a.current_need_tdou=n,a.is_direct_cashier=o;var i=$.tb.location.getHref();a.openType=a.openTypeList.getOpenType(e),a.dataProxy.getIconInfo(a.builderMainUI,a,i)},builderMainUI:function(e){var t=this;if(e&&0===e.no){var n=e.data,o=t.builder.builderGetTdouMain(n);t.renderMain(o),t.bindMainUIEvents(),t.dataProxy.isLogin()||$(".j_tdou_body_title").hide(),t.setDefaultSlected(),t.addUmoney()}else e&&11e4===e.no&&this.viewUtil.OpenLoginDialog()},renderMain:function(e){var t="tdou_pay_icon_dialog",n={modal:!0,showTitle:!1,fixed:!0,width:620,height:545,holderClassName:t,draggable:!0};n.html=e,this._dialog=new $.dialog(n),this._dialog.element[0].id=t,this._dialog.show()},setDefaultSlected:function(){$(".j_tdou_base_list li:eq(1)").trigger("click")},bindMainUIEvents:function(){var e=this;e.bindCounterEvent(),$(".j_header_close").on("click",function(){e.trigger("after_buy_icon"),e.closeMain()}),$(".j_tdou_give_btn_big").on("click",function(){e.trigger("after_buy_icon"),e.closeMain()}),$(".j_tdou_get_item").on("click",function(){var t=$(this);e.selectIconItem(t)}).on("mouseenter",function(){var e=$(this);e.addClass("tdou_item_hover")}).on("mouseleave",function(){var e=$(this);e.removeClass("tdou_item_hover")}),$(".j_tdou_buy_btn_big").on("click",function(){var t=$(".goods_wrap_selected");if(0!=t.length){var n=$(".j_tdou_calc_input").val(),o=t[0].id;e.wrap=$("#tdou_pay_icon_dialog");var a=$.tb.location.getHref();e.payChannel=2,e._openCtrl("dialog"),e.payType=e.QIANBAO,e.viewUtil.displayLoading(e.wrap),e.dataProxy.payIcon(o,n,e.buyIcon,e,a,e.consumption_path,e.payChannel)}}),this.buildStatsEvent()},buildStatsEvent:function(){$(".good_price_joinvip").find("a").on("click",function(){$.stats.track("T\u8c46\u94b1\u5305","\u4f1a\u5458\u5065\u5eb7\u7edf\u8ba1","","click",{obj_name:"\u83b7\u53d6T\u8c46\u70b9\u51fb\u8d34\u5427\u8d85\u7ea7\u4f1a\u5458"})})},_openCtrl:function(e){var t=this,n=t.openType;switch(e="win"===e||"dialog"===e?e:n){case"win":t.openNewWindow();break;case"dialog":}},openNewWindow:function(){this.win=window.open("")},bindCounterEvent:function(){var e=this;$(".tdou_calc_count_wrap").each(function(){e.counter.bindEvents($(this).find(".j_tdou_calc_count")),e.counter.onValueChange.push({action:e.onCounterValueChange,context:e})})},closeMain:function(){this._dialog.close(),this.dataProxy.clearCache()},selectIconItem:function(e){if(e){$(".j_tdou_get_item").removeClass("goods_wrap_selected"),e.addClass("goods_wrap_selected");var t=this,n=e.tbattr("id");$(".j_tdou_counter_replace").html(t.counter.builderUI(n));var o=$("#tdou_counter_"+n);t.counter.bindEvents(o),t.counter.onValueChange.push({action:t.onCounterValueChange,context:t}),t.onCounterValueChange(1,n)}},onCounterValueChange:function(e,t){var n=this.dataProxy.getPriceInfo(e,t),o=this.dataProxy.getMemberLevel();$(".j_goods_member_num").html(o>1?n.member_price:n.non_member_price),$(".j_goods_tmall_price_num").html(n.tbmall_price)},buyIcon:function(e){var t=this;if(t.viewUtil.hideLoading(),t.wrap=$("#tdou_pay_icon_dialog"),t.tbs=PageData.tbs,e&&0===e.no)if(t.win)t.checkTdou.showTdouCheckView(t.wrap,t.updateTdou,t),t.win.location.href=e.data;else{t.cashier=t.requireInstance("encourage-payment/widget/qianbao_purchase_tdou");var n=e.data,o=$.extend({product:"tdou",consumption_path:t.consumption_path,goods_cost_tdou:t.current_need_tdou,pay_type:6,pay_channel:t.payChannel},{qianbao_params:n.return_url,iconCount:n.iconCount,iconId:n.iconId}),a={ie:"utf-8",tbs:t.tbs,terminal:"pc",pay_type:6,iconId:n.iconId,pageUrl:n.return_url||"",margin:t.current_need_tdou,goodsCost:t.current_need_tdou,fr:t.consumption_path||0,channel:t.payChannel};t.cashier.showDialog(o,a)}else if(e&&11e4===e.no)t.closeMain(),t.viewUtil.OpenLoginDialog(),t.win&&t.win.close();else if(e&&1990055===e.error_code)if("undefined"==typeof passport||"undefined"==typeof passport.pop.init){var i="undefined"!=typeof Env&&Env.server_time?Env.server_time:(new Date).getTime(),r="https://passport";$.JsLoadManager.use([r+".baidu.com/passApi/js/uni_login_wrapper.js?cdnversion="+Math.floor(i/6e4),r+".baidu.com/passApi/js/wrapper.js?cdnversion="+Math.floor(i/6e4)],function(){window.realname=passport.pop.init({type:"accRealName",apiOpt:{product:"tb",staticPage:"//tieba.baidu.com/tb/static-common/html/pass/v3Jump.html"},tangram:!0,color:"green"}),window.realname.show()},!0,"utf-8")}else window.realname.show();else this.viewUtil.displayErrorInfo(t.wrap,""),t.win&&t.win.close()},updateTdou:function(){var e=this;e.dataProxy.getTdou(e.onUpdateTdou,e)},onUpdateTdou:function(e){var t=this;if(e&&0===e.no){var n=e.data.Parr_scores,o=$("#tdou_remain_num"),a=n?n.scores_money+n.scores_other:0,i=t.dataProxy.getUserTdou();if(o.val(a),a-i>=1e4){t.wrap=$("#tdou_pay_icon_dialog");var r=t.dataProxy.getUserName();this.viewUtil.dispalySuccessedInfo(t.wrap,r,function(){t.trigger("after_buy_icon",n),t.closeMain()},t)}else this.viewUtil.displayErrorInfo(t.wrap,"",function(){t.trigger("after_buy_icon",n),t.closeMain()},t)}},addUmoney:function(){var e=this;e.umoney=e.requireInstance("encourage-payment/widget/umoney_query");var t=e.umoney.showUmoneyOnGotTdou();e._dialog.element.find(".j_tdou_umoney").append(t)},isQianbaoHitSmallFlow:function(){var e=PageData&&PageData.user&&PageData.user.id;return e?"1157380926"==e||"707573940"==e||"963463500"==e||"1093896819"==e||"1496"==e||"1134652730"==e||"982451133"==e?!0:(e=parseInt(e),e%1===0):!1}}});_.Module.define({path:"encourage-payment/widget/tdou",requires:["encourage-payment/widget/tdou_view","encourage-payment/widget/tdou_view_auto_redirect"],sub:{initial:function(e){e=$.extend({scores:{level:2,limit:8e3,scores_fetch:0,scores_money:534,scores_other:80,scores_total:614,update_time:1432008154},level:{end_time:"1421055636",expired_notify:1,expiring_notify:1,left_num:0,max_free_score:8e3,open_status:null,props_category:105,props_id:2,props_type:0,update_time:null,used_status:1}},e);var t=e.scores,o=e.level;this.view=this.requireInstance("encourage-payment/widget/tdou_view",{scores:t,level:o}),this.autoDirect=this.requireInstance("encourage-payment/widget/tdou_view_auto_redirect")},factory:function(e,t){var o="",i="",r=0;switch(e){case"get_icon":o=t.consumption_path,i=t.desc,r=t.current_need_tdou,this.view.createMain(o,i,r);break;case"auto_direct":var s={consumption_path:t.consumption_path,title:t.desc,need_tdou:t.current_need_tdou,goods_cost_tdou:t.goods_cost_tdou||0,pay_type:t.pay_type,tbs:t.tbs,order_id:t.order_id,is_dialog:t.is_iframe};this.autoDirect.createMain(s);break;case"payment":}}}});_.Module.define({path:"encourage-payment/widget/tcharge_dialog",requires:["encourage-payment/widget/tdou","encourage-payment/widget/tdou_get"],sub:{initial:function(e){var t=this;$.stats.track("all","\u6253\u5f00T\u8c46\u6536\u94f6\u53f0","all","show"),e=$.extend({},e);var a=t.requireInstance("encourage-payment/widget/tdou",[{scores:e.scores,level:e.level}]);e&&e.chargeType&&"platform"==e.chargeType?a.factory("payment",e):(e&&(t.consumption_path=e.consumption_path,t.desc=e.desc,t.current_need_tdou=e.current_need_tdou,t.is_direct_cashier=e.is_direct_cashier),e&&t.is_direct_cashier?a.factory("auto_direct",e):t.requireInstance("encourage-payment/widget/tdou_get",e))}}});_.Module.define({path:"encourage-payment/widget/tdou_view_pay",requires:["encourage-payment/widget/tdou_builder","encourage-payment/widget/tdou_data","encourage-payment/widget/tdou_view_util","encourage-payment/widget/tdou_view_auto_redirect","encourage-payment/widget/tdou_view_operation_bootstrap","encourage-payment/widget/payMember","encourage-payment/widget/tdou_view"],sub:{errors:{110000:"\u7528\u6237\u672a\u767b\u9646",2320007:"\u7cfb\u7edf\u9519\u8bef\uff0c\u8bf7\u7a0d\u540e\u91cd\u8bd5",210009:"\u7cfb\u7edf\u9519\u8bef\uff0c\u8bf7\u7a0d\u540e\u91cd\u8bd5",2270044:"\u8d26\u53f7\u5f02\u5e38\uff0c\u8bf7\u91cd\u65b0\u767b\u9646",2270047:"\u652f\u4ed8\u5931\u8d25\u2014\u8ba2\u5355\u5931\u6548",2270050:"\u8ba2\u5355\u72b6\u6001\u5f02\u5e38",2270049:"\u5546\u54c1\u8fc7\u671f\uff0c\u8bf7\u91cd\u65b0\u8d2d\u4e70",2270015:"\u5546\u54c1\u4e0d\u53ef\u5151\u6362",2270051:"\u7cfb\u7edf\u7ef4\u62a4\u4e2d..."},order_status:{0:"\u652f\u4ed8\u672a\u5b8c\u6210\uff01",1:"\u652f\u4ed8\u6210\u529f\uff0c\u5546\u54c1\u5151\u6362\u4e2d\uff01",2:"\u5151\u6362\u6210\u529f",3:"\u5151\u6362\u5931\u8d25\uff0cT\u8c46\u5df2\u9000\u8fd8",4:"\u5151\u6362\u8d85\u65f6\uff0c\u8bf7\u8054\u7cfb\u7ba1\u7406\u5458"},tdou_buy_confirm_tag:"tdou_buy_confirm",is_iframe:!0,initial:function(e,t){t=$.extend({},t);var o=t.scores,a=t.level;this.builder=this.requireInstance("encourage-payment/widget/tdou_builder"),this.dataProxy=this.requireInstance("encourage-payment/widget/tdou_data",{scores:o||0,level:a||0}),this.viewUtil=this.requireInstance("encourage-payment/widget/tdou_view_util"),this.message=e,this.autoDirect=this.requireInstance("encourage-payment/widget/tdou_view_auto_redirect")},createMain:function(e){var t=this;t.notShowSucTips=e.notShowSucTips,t.dataProxy.getPayInfo(e,t.onPayInfo,t)},onPayInfo:function(e){if(this.sendMessage("pay_info",e),e&&0===e.no){var t=e.data.goods_info,o=e.data.order_info,a=e.data.user_info;this.pay_info={},this.pay_info.goods_info=t,this.pay_info.order_info=o,this.pay_info.user_info=a,this.createUI(t,o,a)}else this.handleError(e.no)},createUI:function(e,t,o){var a=this,i="",n=o.Parr_props;a.dataProxy.setParrProps(n);var r=a.dataProxy.getMemberLevel(),d=2==r,_=o.Parr_scores,u=0;_&&(u=_.scores_money+_.scores_other);var s=u>=e.tdou_num,c=0;s||(c=e.tdou_num-u);var l=e.free_vip_level;if(s&&(t.cpath.pay_cashier||void 0==t.cpath.pay_cashier))return a.pay(!1),void 0;if(!s&&(t.cpath.gettdou_cashier||void 0==t.cpath.gettdou_cashier))return a.getTdou(!1),void 0;var f=a.confirmCount();return s&&f>0?(f-=1,a.confirmCount(f),a.pay(!1),void 0):(d&&l?i=a.createUI_memberGetTdou_free(s,e,t,c):d&&!l?i=a.createUI_memberGetTdou(s,e,t,c):!d&&l?i=a.createUI_nonMemberGetGoodsOwnedMember(s,e,t,c):d||l||(i=a.createUI_nonMemberGetTdouOwnedMember(s,e,t,c)),a.renderMain(i),a.initUIData(),a.bindMainUIEvents(),void 0)},directToCrasher:function(e,t,o){var a=this,i=o.Parr_props;a.dataProxy.setParrProps(i);var n=o.Parr_scores,r=0;n&&(r=n.scores_money+n.scores_other);var d=r>=e.tdou_num,_=0;d||(_=e.tdou_num-r),d?a.pay(!1):a.getTdou(!1)},initUIData:function(){var e=this,t=e.confirmCount(),o=$(".j_baidu_tb_tdou_pay_info_box .j_tdou_buy_confirm");o.length>0&&(parseInt(t)>0?o.tbattr("checked",!0):o.tbattr("checked",!1))},createUI_nonMemberGetGoodsOwnedMember:function(e,t,o,a){t.tdou_pay_from=o.from;var i=this.builder.buildPayTdouMain_nonMemberGetGoodsOwnedMember(e,t,o,a);return i},createUI_nonMemberGetTdouOwnedMember:function(e,t,o,a){t.tdou_pay_from=o.from;var i=this.builder.buildPayTdouMain_nonMemberGetTdouOwnedMember(e,t,o,a);return i},createUI_memberGetTdou:function(e,t,o,a){t.tdou_pay_from=o.from;var i=this.builder.buildPayTdouMain_memberGetTdou(e,t,o,a);return i},createUI_memberGetTdou_free:function(e,t,o,a){t.tdou_pay_from=o.from;var i=this.builder.buildPayTdouMain_memberGetTdou_freeGoods(e,t,o,a);return i},renderMain:function(e){if(!($(".baidu_tb_tdou_payment_dialog").length>0)){var t={modal:!0,showTitle:!1,fixed:!0,width:610,height:275,holderClassName:"baidu_tb_tdou_payment_dialog",draggable:!0};t.html=e,this._dialog=new $.dialog(t),this._dialog.element[0].id="baidu_tb_tdou_payment_dialog",this._dialog.show(),this.sendMessage("ui:main:create",this._dialog)}},bindMainUIEvents:function(){var e=this,t=e._dialog.element;t.find(".j_tdou_pay_header_close").on("click",function(){e.closeMain(),e.sendMessage("closed","");var t=e.requireInstance("encourage-payment/widget/tdou_view_operation_bootstrap"),o={actionType:"CLOSE_PAYMENT"};t.triggerByScene(o,e.pay_info)}),t.delegate(".j_tb_tdou_pay_btn","click",function(){e.pay()}).delegate(".j_tb_tdou_get_tdou_btn","click",function(){e.getTdou()}).delegate(".j_tdou_enable_member","click",function(){var e=$(".j_baidu_tb_tdou_pay_info_box .j_tb_tdou_get_tdou_btn");$(this).tbattr("checked")?(e.html("\u5f00\u901a\u4f1a\u5458\u5e76\u83b7\u53d6T\u8c46"),e.addClass("tdou_pay_btn_135")):(e.html("\u83b7\u53d6T\u8c46"),e.removeClass("tdou_pay_btn_135"))}).delegate(".j_tdou_buy_confirm","click",function(){$(this).tbattr("checked")?e.confirmCount(30):e.confirmCount(0)}).delegate(".j_tdou_buy_icon","click",function(){e.getIcon()}).delegate(".j_tdou_open_super_member_link","click",function(){e.closeMain();var t=e.requireInstance("encourage-payment/widget/payMember"),o={fr:"tdou_view_pay"};t.showCashier(o)})},pay:function(e){var t=this,o=e;"undefined"==typeof e&&(o=!0);var a={no_ui:o};t.dataProxy.payGoods(t.onPay,t,a)},onPay:function(e,t){var o=this;t&&!t.no_ui?o.wrap=null:(o.wrap=null,o.closeMain());var a=o.dataProxy.getPayInfoCache();if(0===e.no){var i={from:a.order_info.from,goods_name:$.tb.subByte(a.goods_info.goods_name,24,""),order_status:e.data.order_info.status,price:a.goods_info.tdou_num};o.viewUtil.displayPaymentSuccess(o.wrap,i,function(){o.closeMain(),o.sendMessage("paid",e)},o,o.notShowSucTips)}else o.viewUtil.displayPaymentFailed(o.wrap,$.tb.subByte(a.goods_info.goods_name,24,""),function(){o.closeMain(),o.sendMessage("paid",e)},o)},getTdou:function(e){var t=this,o=!1,a=e;"undefined"==typeof e&&(a=!0),a?(o=$(".j_baidu_tb_tdou_pay_info_box .j_tdou_enable_member").tbattr("checked"),this.closeMain()):o=!1;var i=t.dataProxy.getPayInfoCache(),n=i.order_info.cpath,r={consumption_path:i.order_info.scene_id,title:"\u7b2c\u4e09\u65b9\u652f\u4ed8:\u83b7\u53d6T\u8c46",need_tdou:0,third_order_id:i.order_info.order_id,goods_cost_tdou:i.goods_info.tdou_num};o?($.extend(r,{title:"\u7b2c\u4e09\u65b9\u652f\u4ed8:\u5f00\u901a\u8d85\u7ea7\u4f1a\u5458,\u83b7\u53d6T\u8c46",pay_type:7,tbs:i.tbs}),n&&"1"==n.purchase&&$.extend(r,{title:"\u7b2c\u4e09\u65b9\u652f\u4ed8:\u5f00\u901a\u8d85\u7ea7\u4f1a\u5458,\u83b7\u53d6T\u8c46,\u8d2d\u4e70\u5546\u54c1",pay_type:9,tbs:i.tbs})):n&&"1"==n.purchase&&$.extend(r,{title:"\u7b2c\u4e09\u65b9\u652f\u4ed8:\u8d2d\u4e70\u5546\u54c1,\u83b7\u53d6T\u8c46",pay_type:8,third_order_id:i.order_info.order_id,tbs:i.tbs}),t.goCashier(r,a)},goCashier:function(e,t){var o=this,a={consumption_path:e.consumption_path,title:e.desc,need_tdou:e.current_need_tdou,goods_cost_tdou:e.goods_cost_tdou||0,pay_type:e.pay_type||6,tbs:e.tbs,order_id:e.third_order_id,is_dialog:!t,pay_info:o.pay_info};this.autoDirect.display_type="third_app",this.autoDirect.third_order_id=e.third_order_id,this.autoDirect.createMain(a)},getIcon:function(){var e=this;e.closeMain();var t=e.dataProxy.getPayInfoCache();e.view=this.requireInstance("encourage-payment/widget/tdou_view"),e.view.bind("after_buy_icon",function(o,a){var i=t.goods_info,n=t.order_info,r=t.user_info;null!=a&&(r.Parr_scores=a),e.createUI(i,n,r)},e);var o=t.order_info.scene_id,a="\u7b2c\u4e09\u65b9\u8d2d\u4e70icon",i=t.goods_info.tdou_num;e.view.createMain(o,a,i)},closeMain:function(){this._dialog&&this._dialog.close(),this.dialog=null},confirmCount:function(){var e=this,t=arguments[0],o=0,a=new Date,i=a.getFullYear()+""+(a.getMonth()+1)+a.getDate();if("undefined"!=typeof t){o=parseInt(t);var n=i+"#"+o;$.tb.Storage.set(e.tdou_buy_confirm_tag,n)}else{if(t=$.tb.Storage.get(e.tdou_buy_confirm_tag),null==t)return 0;var r=t.split("#");o=r&&2==r.length&&r[0]==i?parseInt(r[1]):0}return o},sendMessage:function(e,t){var o=this,a=null;a="closed"==e?{command:"encourage_dialog_closed",data:t}:"paid"==e?{command:"encourage_paid",data:t}:{command:e,data:t},o.message&&o.message(a)},handleError:function(e){if(e){var t=this,o=t.errors[e];return 11e4==e?(t.viewUtil.OpenLoginDialog(),void 0):(o?t.viewUtil.displayPaymentError(o):t.viewUtil.displayPaymentError("\u672a\u77e5\u9519\u8bef"),void 0)}}}});_.Module.define({path:"encourage-blue/widget/send_gift_success",requires:[],sub:{URL:{getGiftTab:"/present/getForumRank"},giftMap:{},initial:function(s){this.toUser=s.userId,this.toUserName=s.userName,this.scene_from=s.scene_from,this.initDialog()},getDialogTpl:function(){var s=this,i=_.template('<div class="send-gift-success-container" j-send-gift-success-container>     <h2>\u8d60\u9001\u6210\u529f</h2>     <span class="send-gift-success-close"></span>     <p class="send-gift-success-total">\u6211\u9001\u7684\u793c\u7269\u603b\u4ef7\u503c: <span></span></p>     <p class="send-gift-success-line"></p>     <div class="send-gift-success-raking" j-send-gift-success-raking>         <span class="txt">\u7b2c</span>         <span><i></i></span>         <span><i></i></span>         <span><i></i></span>         <span class="txt">\u540d</span>         <div class="num_box">             <div class="num"></div>             <div class="num"></div>             <div class="num"></div>         </div>     </div>     <p class="send-gift-success-mine" j-send-gift-success-mine>\u6211\u5728\u672c\u5427\u6392\u540d\uff1a<em class="res"></em></p>     <p class="send-gift-success-gray">\u8fd8\u5dee<em></em>\u9b45\u529b\u503c\u53ef\u8d85\u8d8a\u524d\u4e00\u540d</p>     <a href="javascript:;" class="send-gift-success-btn" j-send-gift-success-btn>\u786e \u5b9a</a> </div> ')({name:s.toUserName});return i},initDialog:function(){var s=this,i=s.getDialogTpl(),t={modal:!0,fixed:!0,width:254,height:290,hideOnclose:!1,holderClassName:"send-gift-success",draggable:!1,html:i,closeable:!1,showTitle:!1};s._gift_dialog=new $.dialog(t),s.$_gift_dialog=s._gift_dialog.element,s.showDialog(function(){s.getGiftList()}),s.bindEvent()},showDialog:function(s){var i=this;i.top||(i.top=Number(i.$_gift_dialog.css("top").replace("px",""))),i.$_gift_dialog.css({height:0,top:(i.top+290)/2}).animate({height:290,top:i.top,display:"block"},function(){i.$_gift_list=i.$_gift_dialog.find(".send-gift-success-container"),s&&s()})},closeDialog:function(s){var i=this;i.$_gift_dialog.animate({height:0,top:(i.top+290)/2,display:"none"},function(){s&&s()})},getGiftList:function(s){var i=this;$.ajax({url:i.URL.getGiftTab,data:{forum_id:window.PageData.forum.id},type:"GET",dataType:"json",success:function(t){if(0==t.no){var n=t.data;i.$_gift_dialog.find(".send-gift-success-total span").html(n.info.my_scores),i.$_gift_dialog.find(".send-gift-success-mine em").html(n.info.my_pos),1==n.info.my_pos?i.$_gift_dialog.find(".send-gift-success-gray").html("\u60a8\u5df2\u662f\u672c\u5427\u9001\u793c\u7269\u4ef7\u503c\u7b2c\u4e00\u540d"):i.$_gift_dialog.find(".send-gift-success-gray em").html(n.info.my_diff),i.setAnimation(),s&&s()}else i.errorTips()},error:function(){i.errorTips()}})},setAnimation:function(){var s=$("[j-send-gift-success-raking]"),i=$("[j-send-gift-success-mine]"),t=16;s.find(".num").css("backgroundPositionY",0);var n=i.find(".res").html(),e=String(n),a=null;a=1==e.length?"00"+n:2==e.length?"0"+n:n;var c=(a+"").split("");$.each(s.find(".num"),function(s){var i=$(this);setTimeout(function(){i.animate({backgroundPositionY:60*t-t*c[s]})},300*s)})},bindEvent:function(){var s=this;s.$_gift_dialog.on("click",".send-gift-success-close",function(){s.closeDialog(function(){s._gift_dialog.close()})}).on("click","[j-send-gift-success-btn]",function(){s.closeDialog(function(){s._gift_dialog.close()})})}}});_.Module.define({path:"encourage-blue/widget/gift_page_ctrl",sub:{giftMap:[],emptyListTpl:"<p>\u8be5\u7c7b\u76ee\u4e0b\u8fd8\u6ca1\u6709\u793c\u7269\uff0c\u8bf7\u9009\u62e9\u5176\u4ed6\u7c7b\u76ee~</p>",initial:function(t){this.giftList=t.giftList,this.$container=t.$container,this.rendTpl(),$.isEmptyObject(t.giftList)?this.emptyList():(this.formateData(),this.rendList(),this.rendPoint(),this.updateCursor(),this.updateView(),this.addEvents())},emptyList:function(){var t=this.emptyListTpl;this.$container.html(t)},pointTpl:function(t){var i=0,e="";for(i;t>i;i++)e+='<a href="javascript:;" class="btn-point j-gift-page" id="btn-point-'+i+'" data-page="'+i+'"><i></i></a>';return e},formateData:function(){var t=this,i=0;$.each(t.giftList,function(e,a){i++;var s=i%10,r=Math.floor(i/10);if(0==s&&r--,t.giftMap[r]||(t.giftMap[r]=[]),1==a.activity_type){var n=a.begin_time,p=a.end_time,c=Math.round((new Date).getTime()/1e3);a.is_time_limit=n>c?1:c>p?2:0}t.giftMap[r].push(a)});var e=t.giftMap[t.giftMap.length-1],a=e.length,s=5-a%5;if(5!=s)for(s;s>0;s--)e.push({})},rendTpl:function(){var t=_.template('<div class="gift-center-page">     <div class="gift-center-page-list"></div> </div> <a href="javascript:;" class="gift-center-box-cursor left j-gift-page" data-page="left"></a> <a href="javascript:;" class="gift-center-box-cursor gift-right j-gift-page" data-page="right"></a> <div class="gift-center-box-point"></div>')();this.$container.html(t),this.$pageList=this.$container.find(".gift-center-page-list"),this.$pageCursor=this.$container.find(".j-gift-page")},rendList:function(){var t=_.template("<% for (var itemList in list) {     var len = list[itemList].length;     var type = len/5;     var height = type * 126;     %> <ul class=\"gift-center-list\" id=\"gift-center-list-<%=itemList%>\" style=\"height:<%=height%>px\">     <% for (var i in list[itemList]) {          var item = list[itemList][i];         var type = '';         var timeLimit = 0;         switch (Number(item['activity_type'])) {             case 1 : {                 type = 'time';                 break;             }             case 2 : {                 type = 'num';                 break;             }             case 3 : {                 type = 'sale';                 break;             }             case 4 : {                 type = 'member';                 break;             }             case 5 : {                 type = 'free';                 break;             }         }         if (type == 'time') {             if (item['is_time_limit'] != 0) {                 type = 'time-limit';                 timeLimit = item['is_time_limit'];             }         }         if (item['large_thumbnail_url']) {             var category_id = item['category_id']['category_id'] || item['category_id'];             var tdouNum = 0;             if (item['activity_type'] == 3) {                 tdouNum = item['discount'];             } else {                 tdouNum = item['price'];             }     %>     <li class=\"gift-center-list-item\">         <a href=\"javascript:;\" class=\"gift-center-list-item-link\" id=\"gift-center-list-item-<%=item['gift_id']%>\" data-gift={\"gift_id\":\"<%=item['gift_id']%>\",\"category_id\":\"<%=category_id%>\",\"tdou\":\"<%=tdouNum%>\",\"active\":\"<%=item['activity_type']%>\",\"timeLimit\":\"<%=timeLimit%>\"}>             <img class=\"gift-center-list-item-link-img\" alt=\"<%=item['gift_desc']%>\" src=\"<%=item['large_thumbnail_url']%>\">             <p class=\"gift-center-list-item-link-name\"><%=item['gift_name']%></p>             <div class=\"gift-center-list-item-link-detail\">                 <p class=\"text-overflow\">\u5bf9\u65b9\u83b7\u5f97<%=item['gift_name']%></p>                 <p class=\"text-overflow\">                     <i class=\"icon-tbean\"></i>                     <% if (item['activity_type'] == 3) {%>                     <span class=\"del\"><%=item['price']%></span><span><%=item['discount']%></span>                     <% } else { %>                     <span><%=item['price']%></span>                     <% } %>                 </p>             </div>             <i class=\"icon-select\"></i>             <i class=\"icon-type <%=type%>\"></i>         </a>     </li>     <%} else {%>     <li class=\"gift-center-list-item empty\"></li>     <% } %>     <% } %> </ul> <% } %>")({list:this.giftMap});this.$pageList.html(t),this.setAnimation(),this.page=0},rendPoint:function(){var t=this.giftMap.length;this.total=t-1;var i=this.pointTpl(t);this.$container.find(".gift-center-box-point").html(i),this.$pageList.css({width:631*t})},updateCursor:function(){var t=this.giftMap.length;1==t?this.$pageCursor.remove():this.$pageCursor.eq(0).hide()},updateView:function(){var t=this.page;this.$container.find(".btn-point.active").removeClass("active"),this.$container.find(".btn-point").eq(t).addClass("active"),0==this.page?(this.$pageCursor.eq(0).hide(),this.$pageCursor.eq(1).show()):this.page==this.total?(this.$pageCursor.eq(1).hide(),this.$pageCursor.eq(0).show()):this.$pageCursor.show()},moveToPage:function(){var t=this.page;this.$pageList.animate({"margin-left":631*t*-1})},pagerCtrl:function(t){var i=this;switch(t){case"left":if(0==i.page)return;i.page--,i.updateView(),i.moveToPage();break;case"right":if(i.page==i.total)return;i.page++,i.updateView(),i.moveToPage();break;default:var e=Number(t);if(e>=0){if(e==i.page)return;i.page=e,i.updateView(),i.moveToPage()}}},setAnimation:function(){var t=this.$container.find(".gift-center-list-item"),i=100;$.each(t,function(t,e){i+=50,setTimeout(function(){$(e).addClass("show")},i)})},addEvents:function(){var t=this;t.$container.on("click",".j-gift-page",function(i){var e=$(i.currentTarget),a=e.data("page");t.pagerCtrl(a)})}}});_.Module.define({path:"encourage-blue/widget/gift_loading_css",sub:{initial:function(){},getTpl:function(){return _.template('<div class="gift-loading">     <div class="object object_one"></div>     <div class="object object_two"></div>     <div class="object object_three"></div>     <div class="object object_four"></div> </div>')()}}});_.Module.define({requires:["encourage-blue/widget/gift_loading_css","user/widget/user_api","encourage-payment/widget/baseUserData","encourage-blue/widget/gift_page_ctrl","encourage-blue/widget/send_gift_success","encourage-payment/widget/tdou_view_pay","encourage-payment/widget/tcharge_dialog"],path:"encourage-blue/widget/send_gift_dialog",equires:["encourage-blue/widget/gift_page_ctrl","encourage-blue/widget/send_gift_success","user/widget/user_api","encourage-payment/widget/tcharge_dialog","encourage-payment/widget/tdou_view_pay","encourage-payment/widget/baseUserData","encourage-blue/widget/gift_loading_css"],sub:{URL:{getGiftTab:"/present/show/getGiftList",getGiftForTab:"/present/show/getGiftListByCategoryId",getFreeGift:"/present/show/getUserFreeChance",sendGift:"/present/pay/placeOrder"},dialogHeight:560,giftMap:{},initial:function(t){return this.accountId=t.account_id,this.accountType=t.account_type,this.accountName=t.account_name,this.toUser=t.userId,this.toUserName=t.userName,this.scene_from=t.scene_from,this.threadId=t.threadId||null,this.postId=t.postId||null,this.forumName=window.PageData.forum.Name,this.fromUser=window.PageData.user.id,this.canSendToSelf=t.canSendToSelf,this.onFail=t.onFail||function(){},this.onSucess=t.onSucess||function(){},this.getUserTdou(),this.$loadingTpl=this.requireInstance("encourage-blue/widget/gift_loading_css").getTpl(),this.userLevel=this.requireInstance("user/widget/user_api").checkSuperMemberShipOf(PageData.user),this.fromUser?t.toUser!=this.fromUser||this.canSendToSelf?(this.initDialog(),void 0):(this.onFail({no:1,msg:"\u4e0d\u80fd\u7ed9\u81ea\u5df1\u9001\u793c\u7269\u54e6~"}),void 0):(this.onFail({no:210009,msg:"\u8bf7\u767b\u5f55~"}),void 0)},getUserTdou:function(t){this.baseUserData||(this.baseUserData=this.requireInstance("encourage-payment/widget/baseUserData")),this.baseUserData.getTdou(function(e){this.userTdou=e.data.Parr_scores.scores_total,t&&t()},this)},getDialogTpl:function(){var t=_.template('<div class="gift-center-dialog-container">     <div class="gift-center-title">         <h4>\u9001\u7ed9<%=name%></h4>         <a href="javascript:;" class="dialogJclose j-gift-center-title-close"></a>     </div>     <div class="gift-center-box">         <div class="gift-center-box-tab">         </div>         <div class="gift-center-box-list">             <div class="gift-loading"><span></span></div>         </div>     </div> </div> <div class="gift-center-dialog-cashier">     <div class="gift-tr gift-center-dialog-cashier-num">         <p>\u9009\u62e9\u6570\u91cf\uff1a</p>         <div class="gift-cashier-num-item">             <a href="javascript:;" class="j-gift-num" data-num="1">1</a>             <a href="javascript:;" class="j-gift-num" data-num="99">99</a>             <a href="javascript:;" class="j-gift-num" data-num="520">520</a>             <a href="javascript:;" class="j-gift-num" data-num="999">999</a>             <a href="javascript:;" class="j-gift-num" data-num="1314">1314</a>             <a href="javascript:;" class="j-gift-num gift-num-input" data-num="0">                 <input type="text" class="j-gift-num-input" maxlength="4" placeholder="\u81ea\u5b9a\u4e49" />             </a>         </div>     </div>     <div class="gift-tr gift-center-dialog-cashier-price">         <p>\u6240\u9700T\u8c46\uff1a</p>         <div class="gift-center-price">             <i class="icon-tbean"></i>             <span class="gift-center-price-tbean j-gift-price">0</span>             <!-- <span class="gift-center-price-detail">\uff08\u5bf9\u65b9\u83b7\u5f97<i class="icon_tbean"></i><span>0</span>\uff09</span>             <a href="/f?ie=utf-8&kw=\u84dd\u94bb&fr=gift" target="_blank" class="gift-center-price-tips">\u84dd\u94bb\u7528\u9014</a> -->         </div>     </div>     <div class="gift-tr gift-center-dialog-cashier-btn">         <a href="javascript:;" class="btn-gift-send disabled">\u8d60\u9001</a>         <span class="error-tips"></span>         <span class="txt-tips"></span>     </div> </div> <div class="gift-center-dialog-alert">     <div class="mask"></div>     <div class="loading">         <span></span>         <p>\u5151\u6362\u793c\u7269\u4e2d\uff0c\u8bf7\u7a0d\u5019~</p>     </div>     <div class="alert update-tdou">         <p>\u8d2d\u4e70T\u8c46\u6210\u529f\uff0c\u8bf7\u5237\u65b0\u3002</p>         <a href="javascript:;" class="j-update-tdou">\u5237\u65b0</a>         <a href="javascript:;" class="j-close-alert">\u5173\u95ed</a>     </div>     <div class="alert toast toast-error">         <i></i>         <span>\u8d60\u9001\u5931\u8d25\uff01</span>     </div>     <div class="alert toast toast-suc">         <i></i>         <span>\u8d60\u9001\u6210\u529f\uff01</span>     </div> </div>')({name:window.PageData.forum.name});return t},initDialog:function(){var t=this,e=t.getDialogTpl(),i={modal:!0,fixed:!0,width:690,height:t.dialogHeight,hideOnclose:!1,holderClassName:"gift-center-dialog",draggable:!1,html:e,closeable:!1,showTitle:!1};t._gift_dialog=new $.dialog(i),t.$_gift_dialog=t._gift_dialog.element,t.$success=t.$_gift_dialog.find("gift-center-dialog-container"),t.$inputCtrl=t.$_gift_dialog.find(".j-gift-num-input"),t.$numCtrl=t.$_gift_dialog.find(".j-gift-num"),t.$btnCtrl=t.$_gift_dialog.find(".btn-gift-send"),t.$tdouView=t.$_gift_dialog.find(".j-gift-price"),t.$blueView=t.$_gift_dialog.find(".gift-center-price-detail span"),t.$blueIcon=t.$_gift_dialog.find(".gift-center-price-detail i"),t.$errorTips=t.$_gift_dialog.find(".error-tips"),t.$txtTips=t.$_gift_dialog.find(".txt-tips"),t.$alertCenter=t.$_gift_dialog.find(".gift-center-dialog-alert"),t.$blueTips=t.$_gift_dialog.find(".gift-center-price-tips"),t.showDialog(function(){t.getGiftList(function(){t.setDefaultGift()})}),t.bindEvent()},setDefaultGift:function(){var t=this;setTimeout(function(){t.$_gift_dialog.find(".gift-center-box-list .gift-center-list-item-link").eq(0).click(),t.$_gift_dialog.find(".j-gift-num").eq(0).click()},1e3)},showDialog:function(t){var e=this;e.top||(e.top=Number(e.$_gift_dialog.css("top").replace("px",""))),e.$_gift_dialog.css({height:0,top:(e.top+e.dialogHeight)/2}).animate({height:e.dialogHeight,top:e.top,display:"block"},function(){e.$_gift_list||(e.$_gift_list=e.$_gift_dialog.find(".gift-center-dialog-container")),t&&t()})},closeDialog:function(t){var e=this;e.$_gift_dialog.animate({height:0,top:(e.top+e.dialogHeight)/2,display:"none"},function(){t&&t()})},getGiftList:function(t){var e=this;$.ajax({url:e.URL.getGiftTab,data:{scene_from:e.scene_from},type:"GET",dataType:"json",success:function(i){0==i.no?(e.rendGiftTpl(i.data),e.addFreeUrl=i.data.addfree_url,e.currency=i.data.currency,t&&t()):e.errorTips()},error:function(){e.errorTips()}})},errorTips:function(t){var e=this;switch(t){case"member":e.$txtTips.html('\u53ea\u6709\u4f1a\u5458\u624d\u53ef\u4ee5\u8d2d\u4e70<a href="javascript:;" class="j-get-member">\u8d2d\u4e70\u4f1a\u5458</a>');break;case"timeLimit":1==e.timeLimit?e.$errorTips.html("* \u9650\u65f6\u793c\u7269\u8fd8\u672a\u4e0a\u67b6"):2==e.timeLimit&&e.$errorTips.html("* \u9650\u65f6\u793c\u7269\u5df2\u4e0b\u67b6");break;case"tdou":e.$txtTips.html('\u60a8\u7684T\u8c46\u4e0d\u8db3<a href="javascript:;" class="j-get-tdou">\u83b7\u53d6T\u8c46</a>');break;case"timeIn":var i=e.curGift.end_time,a=Math.round((new Date).getTime()/1e3),s=i-a,r=Math.floor(s/86400),n=Math.floor(s%86400/3600),c=Math.floor(s%86400%3600/60);e.$txtTips.html("\u9650\u65f6\u9500\u552e\uff1a\u8fd8\u6709"+r+"\u5929"+n+"\u5c0f\u65f6"+c+"\u5206\u949f\u7ed3\u675f");break;case"free":$.ajax({url:e.URL.getFreeGift,data:{scene_from:e.scene_from},type:"GET",success:function(t){0==t.no?(e.limitNum=t.data.free_chance,e.freeCtrl(),e.$txtTips.html('\u60a8\u6700\u591a\u53ef\u4ee5\u514d\u8d39\u8d60\u9001<i class="num">'+t.data.free_chance+'</i>\u4e2a<a href="'+e.addFreeUrl+'" class="j-get-free-gift">\u83b7\u53d6\u673a\u4f1a</a>')):e.$txtTips.html('\u60a8\u6700\u591a\u53ef\u4ee5\u514d\u8d39\u8d60\u9001<i class="num">0</i>\u4e2a<a href="'+e.addFreeUrl+'" class="j-get-free-gift">\u83b7\u53d6\u673a\u4f1a</a>')},error:function(){e.$txtTips.html('\u60a8\u6700\u591a\u53ef\u4ee5\u514d\u8d39\u8d60\u9001<i class="num">0</i>\u4e2a<a href="'+e.addFreeUrl+'" class="j-get-free-gift">\u83b7\u53d6\u673a\u4f1a</a>')}});break;case"num":var d=e.curGift.gift_count;e.$txtTips.html('\u8be5\u793c\u7269\u9650\u91cf<i class="num">'+d+"</i>\u4e2a")}},rendGiftTpl:function(t){var e=t.list,i=t.list[0].category_id,a=t.gift_list;this.rendTab(e),this.setTab(i),this.giftListRend(i,a)},setTab:function(t){this.$tabList.removeClass("current"),$("#gift-center-tab-"+t).addClass("current")},giftListRend:function(t,e){this.setData(t,e),this.requireInstance("encourage-blue/widget/gift_page_ctrl",{giftList:e,$container:$(".gift-center-box-list")})},giftSendSuccess:function(t,e){this.requireInstance("encourage-blue/widget/send_gift_success",{giftList:e,$container:$(".gift-center-dialog-alert")})},setData:function(t,e){this.categoryId=t,this.giftMap[t]||(this.giftMap[t]={}),this.giftMap[t]=this.formateList(e)},formateList:function(t){var e={};return $.each(t,function(t,i){e[i.gift_id]=i}),e},rendTab:function(t){var e=this,i=_.template('<ul class="gift-center-tab-list">     <% var len = list.length;         var width = (630 - len) / len;         for (var i in list) {         var item = list[i];     %>     <li class="gift-center-tab-item-tr"></li>     <li class="gift-center-tab-item" style="width:<%=width%>px">         <a href="javascript:;" id ="gift-center-tab-<%=item.category_id%>" data-tab={"id":"<%=item.category_id%>"}>             <%=item.category_name%>         </a>     </li>     <%}%> </ul>')({list:t});e.$_gift_dialog.find(".gift-center-box-tab").html(i),e.$tabList=e.$_gift_dialog.find(".gift-center-box-tab").find(".gift-center-tab-item a")},selectGift:function(){var t=this;t.updateGift()},updateGift:function(){$(".gift-center-list-item-link").removeClass("select"),$("#gift-center-list-item-"+this.curGiftId).addClass("select")},setLoading:function(){this.$_gift_dialog.find(".gift-center-box-list").html(this.$loadingTpl)},changeTab:function(t){var e=this;e.setLoading(),e.giftMap&&e.giftMap[t]?(e.setTab(t),e.giftListRend(t,e.giftMap[t])):$.ajax({url:e.URL.getGiftForTab,data:{category_id:t},type:"GET",dataType:"json",success:function(i){if(0==i.no){var a=i.data.gift_list||{};e.setTab(t),e.giftListRend(t,a),e.giftMap[t]=e.formateList(a)}else e.errorTips()},error:function(){e.errorTips()}})},inputCtrl:function(t){var e=parseInt(t,10)||0;0==e?this.$inputCtrl.val(""):t!=e&&this.$inputCtrl.val(e),this.orderNum=e,this.updateBtn()},updateBtn:function(){return this.$txtTips.html(""),this.$errorTips.html(""),this.curGiftId&&this.curCategoryId?this.orderNum?(this.checkOrder()?this.$btnCtrl.removeClass("disabled"):this.$btnCtrl.addClass("disabled"),void 0):(this.$btnCtrl.addClass("disabled"),this.$tdouView.html("0"),this.$blueView.html("0"),void 0):(this.$btnCtrl.addClass("disabled"),this.$tdouView.html("0"),this.$blueView.html("0"),void 0)},setNum:function(t){this.$tdouView.html(t);var e=this.curGift,i=Math.floor((t-(e.tbkey_price||0))*(100-e.proportion)/100);this.$blueView.html(i),0==this.currency?(this.$blueIcon.removeClass().addClass("icon_tbean"),this.$blueTips.hide()):(this.$blueIcon.removeClass().addClass("icon-blue"),this.$blueTips.show())},checkOrder:function(){var t=Number(this.curTdouNum)*Number(this.orderNum);return this.setNum(t),4!=this.activeId||this.userLevel?1!=this.activeId||this.timeLimitCtrl()?t>this.userTdou?(this.tdouNotEnough(),!1):(2==this.activeId&&this.numLimitCtrl(),3==this.activeId&&this.saleCtrl(),5==this.activeId&&this.errorTips("free"),!0):!1:(this.notMember(),!1)},freeCtrl:function(){var t=this.limitNum,e=this.orderNum;e>t&&this.$btnCtrl.addClass("disabled")},notMember:function(){this.errorTips("member")},timeLimitCtrl:function(){return 0!=this.timeLimit?(this.errorTips("timeLimit"),!1):(this.errorTips("timeIn"),!0)},numLimitCtrl:function(){var t=this.curGift,e=t.gift_count;return this.errorTips("num"),e<this.orderNum?!1:!0},saleCtrl:function(){var t=this.curGift.price*Number(this.orderNum),e=Number(this.curTdouNum)*Number(this.orderNum);return this.$txtTips.html('\u6298\u6263\u4fc3\u9500\uff1a\u539f\u4ef7<i class="del">'+t+'</i>T\u8c46\uff0c\u73b0\u4ef7<i class="num">'+e+"</i>T\u8c46"),!0},tdouNotEnough:function(){this.errorTips("tdou")},sendGifterror:function(){var t=this;t.$alertCenter.show().find(".loading").hide(),t.$alertCenter.find(".toast-error").show(),setTimeout(function(){t.$alertCenter.hide().find(".toast-error").hide()},1e3)},sendGiftSuc:function(){var t=this;t.$alertCenter.show().find(".loading").hide(),t.$alertCenter.hide().find(".toast-suc").hide()},getOrder:function(){var t=this;t.$btnCtrl.addClass("disabled"),t.$alertCenter.show().find(".loading").show();var e={scene_from:t.scene_from,gift_id:t.curGiftId,num:t.orderNum,benefit_userid:t.toUser,benefit_username:t.toUserName,thread_id:t.threadId,post_id:t.postId};t.accountId&&t.accountType&&(e.account_type=t.accountType,e.account_id=t.accountId,e.benefit_userid=t.accountId,e.benefit_username=t.accountName),$.ajax({url:t.URL.sendGift,data:e,type:"POST",dataType:"json",success:function(e){if(0==e.no)if(5==t.activeId)t.sendGiftSuc(),t.giftSendSuccess(),t.limitNum=e.data.free_chance,t.freeCtrl(),t.$txtTips.html('\u60a8\u6700\u591a\u53ef\u4ee5\u514d\u8d39\u8d60\u9001<i class="num">'+e.data.free_chance+'</i>\u4e2a<a href="'+t.addFreeUrl+'" class="j-get-free-gift">\u83b7\u53d6\u673a\u4f1a</a>'),t.$btnCtrl.removeClass("disabled");else{var i=e.data;$.extend(i,{chargeType:"platform",notShowSucTips:!0});var a=t.requireInstance("encourage-payment/widget/tdou_view_pay",function(i){if("encourage_dialog_closed"==i.command?t.$alertCenter.hide().find(".loading").hide():"encourage_paid"==i.command?0==i.data.no?(t.sendGiftSuc(),t.giftSendSuccess()):t.sendGifterror():t.sendGifterror(),2==t.activeId){var a=e.data.gift_count;t.curGift.gift_count=a,t.numLimitCtrl()?t.$btnCtrl.removeClass("disabled"):t.$btnCtrl.addClass("disabled")}else t.$btnCtrl.removeClass("disabled")});a.createMain(i)}else t.$btnCtrl.removeClass("disabled"),t.sendGifterror()},error:function(){t.$btnCtrl.removeClass("disabled"),t.sendGifterror()}})},updateTdou:function(){var t=this.orderNum*this.curTdouNum-this.userTdou,e={consumption_path:"send-gift",fr:"send-gift",current_need_tdou:t,is_direct_cashier:!0};this.requireInstance("encourage-payment/widget/tcharge_dialog",e),setTimeout(function(){this.$alertCenter.show().find(".update-tdou").show()},1e3)},bindEvent:function(){var t=this;t.$_gift_dialog.on("click",".j-gift-center-title-close",function(){t.closeDialog(function(){t._gift_dialog.close()})}).on("click",".gift-center-list-item-link",function(e){var i=$(e.currentTarget),a=i.data("gift");t.curGiftId=a.gift_id,t.curCategoryId=a.category_id,t.curTdouNum=a.tdou,t.activeId=a.active,t.timeLimit=a.timeLimit,t.curGift=t.giftMap[t.curCategoryId][t.curGiftId],t.selectGift(),t.updateBtn()}).on("click",".gift-center-tab-item a",function(e){var i=$(e.currentTarget),a=i.data("tab"),s=a.id;t.changeTab(s),t.curCategoryId=null,t.curGiftId=null,t.curTdouNum=null,t.activeId=null,t.timeLimit=null,t.updateBtn()}).on("input",".j-gift-num-input",function(e){var i=$(e.currentTarget),a=i.val();t.inputCtrl(a)}).on("click",".j-gift-num",function(e){var i=$(e.currentTarget);t.$numCtrl.removeClass("select"),i.addClass("select");var a=Number(i.data("num"))||0;t.orderNum=a,0==a?(t.$inputCtrl.focus(),t.inputCtrl(t.$inputCtrl.val())):(t.$inputCtrl.val(""),t.updateBtn())}).on("click",".btn-gift-send",function(e){var i=$(e.target);i.hasClass("disabled")||t.getOrder()}).on("click",".j-get-tdou",function(){t.updateTdou()}).on("click",".j-close-alert",function(){t.$alertCenter.hide().find(".alert").hide()}).on("click",".j-update-tdou",function(){t.getUserTdou(function(){t.checkOrder(),t.$alertCenter.hide().find(".alert").hide()})})}}});_.Module.define({requires:["encourage-blue/widget/send_gift_dialog"],path:"encourage-blue/widget/raking_gift_dialog",sub:{URL:{getUserGiftList:"/present/getForumRank"},$emptyTpl:'<p class="tips-none" j-send-gift><a href="javascript:;">\u5feb\u6765\u6210\u4e3a\u7b2c\u4e00\u4e2a\u9001\u793c\u7269\u7684\u4eba\u5427</a></p>',$errorTpl:'<p class="tips">\u7cfb\u7edf\u9519\u8bef\uff0c\u8bf7\u5237\u65b0\u540e\u518d\u8bd5~</p>',emptyObject:{},giftData:{},initial:function(i){this.homeUserId=i.homeUserId,this.callBack=i.callBack,this.isUserHome=i.homeUserId==window.PageData.user.id||i.userId==window.PageData.user.user_id?!0:!1,this.initDialog(),this.addEvents(),this.isUserId=i.isUserId},getDialogTpl:function(){var i='<div class="raking-center-dialog-top">\u672c \u5427 \u8d21 \u732e \u699c</div>',t='<div class="raking-center-dialog-close"></div>',a='<div class="raking-center-dialog-con"></div>';return'<div class="raking-center-dialog-container">'+i+t+a+"</div>"},initDialog:function(){var i=this,t=i.getDialogTpl(),a={modal:!0,fixed:!0,width:750,height:500,hideOnclose:!1,holderClassName:"raking-center-dialog",draggable:!1,html:t,closeable:!1,showTitle:!1};i._gift_dialog=new $.dialog(a),i.$_gift_dialog=i._gift_dialog.element,i.showDialog(function(){i.getGiftList()})},showDialog:function(i){var t=this;t.top||(t.top=Number(t.$_gift_dialog.css("top").replace("px",""))),t.$_gift_dialog.css({height:0,top:(t.top+500)/2}).animate({height:500,top:t.top,display:"block"},function(){t.$_gift_list||(t.$_gift_list=t.$_gift_dialog.find(".raking-center-dialog-con")),i&&i()})},closeDialog:function(i){var t=this;t.$_gift_dialog.animate({height:0,top:(t.top+500)/2,display:"none"},function(){i&&i()})},setLoading:function(){this.$_gift_list.html(this.$loadingTpl)},getGiftList:function(i,t,a){var e,n=this,o=n.URL.getUserGiftList;n.giftData[i]&&n.giftData[i][t]&&!n.shouldReload?(e=n.giftData[i][t],a&&a(e),n.rendList(i,e.gift_list)):$.ajax({url:o,data:{forum_id:window.PageData.forum.id,pn:t||0,ps:8},type:"GET",dataType:"json",success:function(e){if(0==e.no){var o=e.data;if(n.shouldReload=!1,$.isEmptyObject(e.data.gift_list))return n.errorTips("empty"),void 0;if(a&&a(e.data),n.rendList(i,e.data.gift_list),n.setData(i,t,e.data),n.$_gift_dialog.find(".raking-center-dialog-username").addClass("current"),e.data.info){n.$_gift_dialog.find(".raking-center-dialog-title-txt em").html(o.info.my_scores),n.$_gift_dialog.find(".raking-center-dialog-title-txt b").html(o.info.my_pos),n.$_gift_dialog.find(".raking-center-dialog-title-rak span").html(o.info.my_diff);var s=n.$_gift_dialog.find(".raking-center-dialog-title-txt b").html();"1"==s&&n.$_gift_dialog.find(".raking-center-dialog-title-rak").html("\u60a8\u5df2\u662f\u672c\u5427\u9001\u793c\u7269\u4ef7\u503c\u7b2c\u4e00\u540d")}else n.$_gift_dialog.find("#raking-center-dialog-header").html("")}else n.errorTips("error")},error:function(){n.errorTips("error")}})},setData:function(i,t,a){$.isEmptyObject(this.giftData[i])&&(this.giftData[i]={}),this.giftData[i][t]=a},errorTips:function(i){var t="empty"===i?this.$emptyTpl:this.$errorTpl;this.$_gift_list.html(t)},rendList:function(i,t){var a=this,e=_.template('<ul class="raking-center-dialog-main-list">     <% for (var i in list) {          var item = list[i];              %>         <li>             <% if (i == 0) {%>                <span class="raking-center-dialog-main-num raking-center-dialog-main-num-one"><%=item[\'pos\']%></span>             <% } else if (i == 1) { %>                 <span class="raking-center-dialog-main-num raking-center-dialog-main-num-two"><%=item[\'pos\']%></span>             <% } else if (i == 2) { %>                 <span class="raking-center-dialog-main-num raking-center-dialog-main-num-three"><%=item[\'pos\']%></span>               <% } else { %>                 <span class="raking-center-dialog-main-num"><%=item[\'pos\']%></span>             <% } %>             <img src="https://gss0.bdstatic.com/6LZ1dD3d1sgCo2Kml5_Y_D3/sys/portrait/item/<%=item.portrait %>" alt="" class="raking-center-dialog-main-img" />             <div class="raking-center-dialog-title title">                 <p class="txt raking-center-dialog-username"><%=item[\'pay_username_formate\']%></p>                 <p>\u9b45\u529b\u503c\uff1a<%=item[\'present_scores\']%></p>             </div>         </li>              <% } %> </ul> ')({list:a.formatData(t),isUserHome:a.isUserHome,type:i}),n=_.template('<div class="raking-center-dialog-title" id="raking-center-dialog-header" j-raking-center-dialog>     <p class="raking-center-dialog-title-txt">         <span>\u6211\u7684\u9b45\u529b\u503c\uff1a<em></em></span>\u6392\u540d\uff1a<b></b>     </p>     <p class="raking-center-dialog-title-rak">\u8fd8\u5dee<span></span>\u9b45\u529b\u503c\u8d85\u8fc7\u524d\u4e00\u540d</p> </div> <div class="raking-center-dialog-main"> </div>')({list:a.formatData(t),isUserHome:a.isUserHome,type:i});a.$_gift_dialog.find(".raking-center-dialog-con").show().append(n),a.$_gift_dialog.find(".raking-center-dialog-main").show().append(e)},formatData:function(i){i.length;return $.each(i,function(i,t){if(t.create_time){var a=new Date(1e3*Number(t.create_time));t.formate_date=a.toISOString().split("T")[0]}if(t.gift_name){var e=t.gift_name;e=e.length>6?e.slice(0,5)+"...":e,t.gift_name_formate=e}if(t.pay_username){var e=t.pay_username;e=e.length>6?e.slice(0,5)+"...":e,t.pay_username_formate=e}}),i},addEvents:function(){var i=this;i.$_gift_dialog.on("click",".raking-center-dialog-close",function(){i.closeDialog(function(){i._gift_dialog.close()})}).on("click","[j-send-gift]",function(){i.closeDialog(function(){i._gift_dialog.close()}),i.requireInstance("encourage-blue/widget/send_gift_dialog",{userId:window.PageData.user.id,userName:window.PageData.user.name,scene_from:"pc_home",account_id:window.PageData.forum.id,account_name:window.PageData.forum.name,account_type:1,onSuccess:function(){$.tb.location.reload()},onFail:function(){$.tb.location.reload()}})})}}});_.Module.define({path:"encourage-blue/widget/gift_batou_goin",requires:["encourage-blue/widget/raking_gift_dialog","encourage-blue/widget/send_gift_dialog"],sub:{URL:{getUserGiftList:"/present/getForumRank"},initial:function(i){this.opts=i,this.$container=$(i.$container),this.getGiftList(),this.bindEvents()},getGiftList:function(){var i=this,t={user_id:window.PageData.user.id,forum_id:window.PageData.forum.id,pn:0,ps:4,type:1};$.get(i.URL.getUserGiftList,t,function(t){if(t&&0==t.no){var e=t.data.gift_list;i.renderGiftList(e)}})},formateData:function(i){var t=[];$.each(i,function(i,e){t.push(e)});var e=t.length;return e>4&&(t.length=4),t},renderGiftList:function(i){var t=this;i=t.formateData(i);var e=_.template('<% for (var i in list) {      var item = list[i];      if (item.num == 0 ) {  %>  <li class="check-gift-item">      <span class="offsate-gift-item-img"></span>      <p class="offsate-gift-item-info"></p>  </li>  <%} else {%>  <li class="check-gift-item">      <img src="https://gss0.bdstatic.com/6LZ1dD3d1sgCo2Kml5_Y_D3/sys/portrait/item/<%=item.portrait %>" alt=""/>  </li>  <% }   }%>')({list:i});t.$container.find(".gift-goin-con-check-list").show().append(e)},bindEvents:function(){var i=this;i.$container.on("click","[j-check-gift]",function(){0==window.PageData.user.is_login?_.Module.use("common/widget/LoginDialog",["","userBar"]):i.requireInstanceAsync("encourage-blue/widget/raking_gift_dialog",{homeUserId:window.PageData.user.id})}).on("click",".j-goin-gift",function(){i.requireInstance("encourage-blue/widget/send_gift_dialog",{userId:window.PageData.user.id,userName:window.PageData.user.name,account_name:window.PageData.forum.name,account_id:window.PageData.forum.id,account_type:1,scene_from:"pc_home",onSuccess:function(){$.tb.location.reload()},onFail:function(){$.tb.location.reload()}})})}}}),$(function(){function i(){$(".gift-goin-left").stop().animate({width:"50px"},3e3),$(".gift-goin-con").stop().animate({width:"0"},3e3)}setTimeout(i,3e3),$(".gift-goin-left").hover(function(){$(".gift-goin-left").stop().animate({width:"248px"},1e3),$(".gift-goin-con").stop().animate({width:"198px"},1e3),$(".gift-goin-con-start").css({display:"none"}).siblings("div").css("display","block")},function(){i()})});