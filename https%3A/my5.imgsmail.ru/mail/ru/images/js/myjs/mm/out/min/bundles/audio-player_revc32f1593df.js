define(function(a,b){b.callback=function(){define("audio_player_bundle-part",["factory","util/helpers","util/promise"],function(a,b,c){"use strict";return{create:function(){return{onLoad:function(d,e){new c(function(b){e?(e.init(d),b(e)):a("audio-player_bundle-part",b)}).then(function(a){if(d.data("id")){var c,e,f,g=d.closest('[rel="journal-discussion-post"]'),h=d.closest(".b-post-comment_body");c=d.hasClass("b-audio__playlist--community-post")?g.size()?g:h.size()?h:d:d,e=b.extend({element:c},d.data()),f=a.createPlaylist(e),f.createTracks()}})},onUnload:function(){}}}}}),define("audio-player_bundle-part",["jquery","counters","factory","app/history","audio-player/playlist_bundle-part","audio-player/track_bundle-part","audio-player/player_bundle-part","audio_player_bundle-part"],function(a,b,c,d,e,f,g,h){var i,j=[],k={msg:{},trackTemplate:"",init:!1,event:"AudioPlayer",handler:{player:"#js-audio-player",msg:"#js-audio-player_config",trackDefault:"#js-audio-player_default-track",playlist:".js-jp__playlist",playlistActive:"js-jp_player_active",track:{container:".js-jp__track",play:".jp__track-toggle",add:".jp__track-add",edit:".js-jp_track-edit",id:".js-jp_track-id",del:".js-jp_track-delete",up:".js-jp_move-up",down:".js-jp_move-down",admdel:".js-jp_am-del",admcopy:".js-jp_am-copy",admedit:".js-jp_am-track-edit-top",admdeltop:".js-jp_am-del-top",number:".jp__track-number",text:".jp__track-name-text",uploader:".jp__track-name-text-avt",performer:".jp__track-performer",performerLink:".jp__track-performer-link",fullname:".jp__track-fullname",fullnameLink:".jp__track-fullname-link",author:".jp__track-author",button:".jp__track-but",duration:".jp__track-but-duration",current:".jp__track-duration-current",total:".jp__track-duration-total",progressBar:".jp__track-progress",progressaArea:".jp__track-progress-container",progressLoaded:".jp__track-progress-loaded",progressSeek:".jp__track-progress-value",progressControl:".jp__track-progress-control",progressTime:".jp__track-progress-time",volumeBar:".jp__track-volume",volumeArea:".jp__track-volume-container",volumeSeek:".jp__track-volume-value",volumeControl:".jp__track-volume-control",volumeIcon:".jp__track-volume-icon",volumeIconMute:".jp__track-volume-icon-mute",volumeMute:"jp__track-mute",playsTrack:"jp__track-plays",playsButton:"jp__track-toggle-plays",initTrack:"jp__track-initialization"}}},l=a(document),m=k.handler,n={emptyaudiopage:{trackAdd:"1471394"},audiotop:{trackAdd:"1111949"},audiorelated:{trackAdd:"1634049"}},o=function(){l.on(k.event+".stop",function(a,b){if(b){var c=i.getTrack();null!==c&&b.fragment===c.getFragment()&&i.stop()}else i.stop()}),l.on("VideoPlayer.play",function(){i.stop()})},p=function(a){var b=!1;return j.forEach(function(c){c.getId()===a&&(b=c)}),b},q=function(b){var d=a("#audio-edit-track"),e=d.find("#edit_name"),f=d.find("#edit_author");c("util/htmlescape",function(a){var c=a.unescape(b.getName()),d=a.unescape(b.getAuthor());e.val(c),f.val(d)}),d.toggle(),d.position({of:b.fromTop?b.getElement("admedit")[0]:b.getElement("edit")[0],my:b.fromTop?"left top":"right top",at:b.fromTop?"left bottom":"right bottom",offset:b.fromTop?"0 5":"15 10",collision:"flip flip"}),d.on("click","#audio-edit-track-save",function(){b.fromTop?b.editTrackInfo("audio.edit_top",d):b.editTrackInfo("audio.edit",d)}).on("click","#audio-edit-track-close",function(){d.off(),d.hide()})},r=function(a,c){"undefine"==typeof c&&(c="defaults"),n[c]&&n[c][a]&&b.myrb(n[c][a])},s={init:function(b){var c=this;k.init||(b.find(m.msg).size()?k.msg=a.parseJSON(b.find(m.msg).html()):k.msg={},k.trackTemplate=b.find(m.trackDefault).html(),i=g.create(b,k),f.init(c),e.init(k),o(),d.changeEvent.on("default force",function(){i.stop(),j=[]}),k.init=!0)},createTrack:function(a){return f.create(a)},createPlaylist:function(a){var b={};return p(a.id)?(b=p(a.id),b.update(a)):(b=e.create(a,k),j.push(b)),b},getPlayer:function(){return i},getPlaylists:function(){return j},getCurrentPlaylist:function(){var a,b;return i&&(a=i.getTrack(),a&&(b=a.getPlaylist())),b},getConfig:function(){return k},editTrack:function(a){q(a)},editTrackTop:function(a){a.fromTop=1,q(a)},getPlaylistById:function(a){return p(a)},cnt:function(){r.apply({},arguments)}};return k.init||h.create().onLoad(a("#js-audio-player"),s),s}),define("audio-player/player_bundle-part",["jquery","factory","client-server","external/cookie","util/hosts","counters","jquery.jplayer"],function(a,b,c,d,e,f){var g="mmAudioPlayer_volume",h=window.location.protocol+"//"+e.getHost()+"/mail/ru/images/my/jplayer.swf",i="//my.mail.ru/+/music/listen_stat/",j={total:{play:"219797",tagAudio:"1404472",e_flash:"1404548",e_disabled:"1404553",e_solution:"1404554",e_no_support:"1404557",e_url:"1404561",e_url_not_set:"1404563",e_flash_version:"1404590",pause:"1404381",playContinue:"1406924",changeVolume:"1404392",trackLoad:"1404451",trackEnd:"1404456",track10:"1404460",track80:"12803482",trackProgg:"1404467",playstart:"4149668",error:"4149674",age_m_30:"5204443",age_w_30:"5204453",age_m_40:"5204447",age_w_40:"5204462"},history:{play:"1404379"},emptyaudiopage:{play:"1471392"},audiotop:{play:"1111947"},audiorelated:{play:"1634047"},community:{play:"1429617"},communityEvent:{play:"17629987"}},k=function(a,b){j[b]&&j[b][a]&&f.myrb(j[b][a]),j.total[a]&&f.myrb(j.total[a])},l=function(e,j){var l,m=a.Deferred(),n=!1,o=!0,p=e,q=70,r=!1,s=null,t=null,u=0,v=!1,w=j,x=Math.floor(1e6*Math.random()).toString(),y=function(a,b){30===a&&1===b?k("age_m_30"):40===a&&1===b?k("age_m_40"):30===a&&2===b?k("age_w_30"):40===a&&2===b&&k("age_w_40")},z=function(){p.jPlayer("play"),l&&l.port.postMessage({type:"music",cmd:"broadcast",message:"play",windowId:x})},A=function(){p.jPlayer("pause"),null!==s&&s.setPauseState()},B=function(){return d.get(g)&&(q=window.parseInt(d.get(g))),q},C=function(a,b){q=a,p.jPlayer("option","volume",q/100),b||d.set(g,q.toString(),{expires:30,path:"/"})},D=function(){null!==s&&(s.stop(),s=null)},E=function(){null!==s&&(s.stop(),s=null,p.jPlayer("stop"),p.jPlayer("clearMedia")),b("util/favicon",function(a){a("def")})},F=function(a){p.jPlayer("setMedia",{mp3:a})},G=function(a){s.showProgress(a.progress)},H=function(){var a=s.getPlaylist(),b=s.getPosition()+1;a.getSize()>b?a.getTracks()[b].play():a.getSize()===b&&E()},I=function(b){var d=a.extend({},b,{aid:w.msg.trackId});d.aid&&c.func("",d,{url:i,method:"POST",contentType:"application/x-www-form-urlencoded"},null,null,null,!0)},J=function(){var b,c=!0,d=!0,e=!a.browser.msie&&w.msg.isUseNativeAudioPlayer?"html, flash":"flash, html";return p.jPlayer({ready:function(a){m.resolve(),n=!0},ended:function(){k("trackEnd",s.getFragment()),H()},error:function(a){f.dwh({version:1,category:{"client-info":{URL:a.jPlayer.error.type,Type:"music-player-error",Duration:1,Calls:1}}})},solution:e,supplied:"mp3",swfPath:h,volume:B()/100,wmode:"window",errorAlerts:!1,warningAlerts:!1}),p.on(a.jPlayer.event.progress,function(a){var b=a.jPlayer.status;if(s.showLoaded(b.seekPercent),100!==b.seekPercent||s.isStatTrackLoadSend||(k("trackLoad",s.getFragment()),s.isStatTrackLoadSend=!0),u<b.seekPercent&&0!==u){var c=100/(b.seekPercent/u);p.jPlayer("playHead",c),v&&z(),u=0}}),p.on(a.jPlayer.event.timeupdate,function(b){var e=b.jPlayer.status;e.duration>0&&(G({progress:e.currentPercentAbsolute,time:a.jPlayer.convertTime(e.currentTime)}),e.currentPercentAbsolute>10&&c&&(k("track10",s.getFragment()),c=!1),e.currentPercentAbsolute>80&&d&&(k("track80",s.getFragment()),d=!1,I({percent:80})))}),p.on(a.jPlayer.event.play,function(a){k("playstart"),a.jPlayer.html.used&&k("tagAudio"),b=(b-(new Date).getTime())*-1,b<=200?f.myrb("3553008"):b>200&&b<=500?f.myrb("3553009"):b>500&&b<=1e3?f.myrb("3553013"):b>1e3&&b<=3e3?f.myrb("3553014"):b>3e3&&b<=5e3?f.myrb("3553015"):f.myrb("3569651"),y(parseInt(w.msg.age,10),parseInt(w.msg.sex,10))}),p.on(a.jPlayer.event.loadstart,function(){b=(new Date).getTime()}),p.on(a.jPlayer.event.error+".city",function(a){k(a.jPlayer.error.type),k("error"),"e_url"!==a.jPlayer.error.type&&"e_url_not_set"!==a.jPlayer.error.type||H()}),m.promise()};return q=B(),window.SharedWorker&&(l=new window.SharedWorker(w.msg.sharedWorkerUrl),l.port.onmessage=function(a){x!==a.data.windowId&&"music"===a.data.type&&"play"===a.data.message&&A()}.bind(this)),{init:function(){J()},playTrack:function(c){s===c?(0===u&&o&&z(),k("playContinue",s.getFragment())):(u=0,D(),s=c,s.setVolume(q,r),o&&(n?(F(s.getUrl()),z()):(o=!1,a.when(J()).done(function(){o=!0,F(s.getUrl()),z()})),k("play",s.getFragment()),k("play",s.getEventType())),s.getPlaylist().checkeLoadMore(s.getPosition())),b("util/favicon",function(a){a("play")}),v=!0},pause:function(){o!==!1&&(v=!1,A(),k("pause",s.getFragment()),b("util/favicon",function(a){a("def")}))},playHead:function(a){a<s.getLoaded()?(a=100/(s.getLoaded()/a),u=0,p.jPlayer("playHead",a),v&&z()):(A(),u=a,s.showProgress(a)),k("trackProgg",s.getFragment())},setVolume:function(a,b){r=!!b,C(a,r),s.setVolume(q,r),k("changeVolume",s.getFragment())},getVolume:function(){return B()},stop:function(){E()},getTrack:function(){return s},getPlaylist:function(){return t}}};return{create:function(a,b){return l(a,b)}}}),define("audio-player/playlist_bundle-part",["jquery","factory","audio-player/track_bundle-part","client-server","util/uri"],function(a,b,c,d,e){var f,g={},h=function(b){var c=this;if(this.tracks=[],this.id=b.id||-1,this.element=b.element,this.fragment=b.fragment||"",this.from=b.from||"",this.fromLayer=b.fromLayer||!1,this.eventType=b.eventType||"",this.sortable=b.sortable||!1,this.email=b.email||"",this.dir=b.dir||"",this.loadEnabled=b.loadEnabled||!1,this.editTracks=b.editTracks||!1,this.addTracks=b.addTracks||!1,this.period=b.period||"",this.query=b.query||"",this.type=b.type||"",this.isCommunity=b.isCommunity||!1,this.offset=b.perpage,this.total=b.total||0,this.loading=!1,this.ownerPageId=b.ownerPageId||!1,this.activeEmail=b.activeEmail||"",this.noLinkInTrack=b.noLink||!1,this.getElement().addClass(g.playlistActive),this.sortable&&this.initSortable(),c.total>c.offset){var d;d=a(b.autoload?'<div class="b-audio__more"></div>':'<a href="" class="b-audio__more ui-button-main">'+f.more+"</a>"),d.on("click",function(a){a.preventDefault(),c.getMoreTrack()}),c.getElement().after(d),c.loadMoreButton=d;var e=function(b){(a(window).scrollTop()+a(window).height()>a(document).height()-a(window).height()||b)&&(c.offset<c.total?c.getMoreTrack():a(window).off("scroll.playlist"))},h={};a(window).off("scroll.playlist").on("scroll.playlist",function(){clearTimeout(h),h=setTimeout(function(){e(!1)},50)}),b.autoload&&c.getMoreTrack()}};return h.prototype.createTracks=function(){var b=this,d=g,e=b.getElement(),f=b.getSize();d.track&&d.track.container&&e.find(d.track.container+":not(."+d.track.initTrack+")").each(function(d,e){f++;var g=c.create(a.extend(a(this).data(),{position:f,element:a(this)}));b.addTrack(g),b.noLink()&&g.getElement("fullname").each(function(){a(this).removeAttr("href").addClass("jp__track-no-link")})})},h.prototype.getId=function(){return this.id},h.prototype.getElement=function(){return a(this.element)},h.prototype.setElement=function(a){return this.element=a,this},h.prototype.getType=function(){return this.type},h.prototype.getOwnerPageId=function(){return this.ownerPageId},h.prototype.noLink=function(){return this.noLinkInTrack},h.prototype.addTrack=function(a){var b=this;return b.tracks.push(a),0===b.getElement().find(a.getElement()).size()&&b.getElement().append(a.getElement()),a.setPlaylist(b),b.updateTrackPosition(),this},h.prototype._addTracksLoad=function(a){var b=this;return a.forEach(function(a){b.tracks.push(a),b.getElement().append(a.getElement())}),b.updateTrackPosition(),this},h.prototype.removeTrack=function(a){return this.removeTrackById(a.getId()),this},h.prototype.removeTrackById=function(a){var b=this,c=b.getTrackById(a);c&&c.remove(),b.updateTrackPosition()},h.prototype.removeAllTrack=function(){var a=this;return a.tracks=[],a},h.prototype.updateTrackPosition=function(){var a=this,b=0;a.getTracks().forEach(function(a){a.setPosition(b),b++})},h.prototype.getTracks=function(){return this.tracks},h.prototype._setTracks=function(a){return this.tracks=a,this},h.prototype.getSize=function(){return this.tracks.length},h.prototype.size=function(){return this.getSize()},h.prototype.getActiveEmail=function(){return this.activeEmail},h.prototype.getFragment=function(){return this.fragment},h.prototype.getEventType=function(){return this.eventType},h.prototype.getTrackById=function(a){var b=!1;return this.getTracks().forEach(function(c){c.getId()===a&&(b=c)}),b},h.prototype.getTrackByPosition=function(a){var b=!1;return this.getTracks().forEach(function(c){c.getPosition()===a&&(b=c)}),b},h.prototype.getTotal=function(){return this.total},h.prototype.getPage=function(){return this.page},h.prototype.update=function(a){this.id=a.id||-1,this.element=a.element,this.fragment=a.fragment||"history",this.getElement().addClass(g.playlistActive)},h.prototype.checkeLoadMore=function(a){var b=this,c=10;b.offset-c<=a&&b.offset<b.total&&b.getMoreTrack()},h.prototype.initSortable=function(){var a=this;b("jquery-ui/sortable",function(){a.getElement().sortable({items:g.track.container,cursor:"pointer",scrollSpeed:30,cancel:".ui-state-disabled",start:function(a,b){},stop:function(a,b){},update:function(b,c){var d=a.tracks,e=c.item.data("item"),f=c.item.data("item"),g=e.getPosition(),h=e.getNumber(),i=e.getElement().index(),j=i;if(d.forEach(function(a){a.setPosition(a.getElement().index())}),d.sort(function(a,b){return a.getPosition()-b.getPosition()}),g<j)for(;g!==j;)j--,d[j]&&(e.setNumber(d[j].getNumber()),e=d[j]);else for(;g!==j;)j++,d[j]&&(e.setNumber(d[j].getNumber()),e=d[j]);e.setNumber(h),f.saveOrder()}}).disableSelection()})},h.prototype.getMoreTrack=function(){var b=this,f={type:b.type,limit:50,offset:b.offset,query:b.query,period:b.period};b.isCommunity&&(f.user=b.email),""!==e().param("age")&&(f.age=e().param("age")),""!==e().param("sex")&&(f.sex=e().param("sex")),""!==e().param("country")&&(f.country=e().param("country")),b.loading||(b.loading=!0,b.loadMoreButton.addClass("progress"),d.func("audio.get",f,{dataType:"json",url:"/my/ajax?user="+b.email}).success(function(d){if(d[2].List){var e=d[2].List;b.offset=d[2].Offset||b.offset+e.length,b.offset>=b.total&&b.loadMoreButton.hide();var f=[];e.forEach(function(d){var e=c.create(a.extend({playlist:b},d));f.push(e),b.noLink()&&e.getElement("fullname").each(function(){a(this).removeAttr("href").addClass("jp__track-no-link")})}),b._addTracksLoad(f),b.loading=!1}else b.loadMoreButton.hide(),b.total=b.offset;b.loadMoreButton.removeClass("progress")}))},{init:function(a){g=a.handler,f=a.msg},create:function(a){return new h(a)}}}),define("audio-player/track_bundle-part",["jquery","client-server","counters","factory","util/htmlescape","util/helpers","util/icons-manager","jquery.jplayer"],function(a,b,c,d,e,f,g){function h(){d("product-tools/auth-form",function(a){a.show()})}var i,j,k,l,m,n=function(a){var b=a.split(":");return 60*parseInt(b[0],10)+parseInt(b[1],10)},o=function(a,b){i.cnt(a,b)},p=function(a){var b=this;this.id=a.id||a.FileID||a.File||0,this.userTrackId=a.userTrackId,this.name=e.escape(a.name||a.Name||""),this.author=e.escape(a.author||a.Author||""),this.url=a.url||a.URL,this.playlist=a.playlist||{},this.uid=a.uid||a.OwnerID,this.position=a.position||-1,this.handler=a.handler||k.track,this.number=a.number||a.OrderNum||-1,this.duration=a.duration||a.Duration||0,this.uploderdir=a.upldir||"",this.text=e.escape(a.text||""),this.change=a.change||a.Change||0,this.fileAdded=parseInt(a.fileAdded||a.FileAdded||0,10),this.notBindOnCreate=a.notBindOnCreate||!1,this.ownerDir=a.ownerDir||a.OwnerDir||"",this.ownerId=a.ownerId||a.OwnerID||"",this.ownerName=a.ownerName||a.OwnerName||"",this.ownerIsCom=a.ownerIsCom||a.OwnerIsCommunity||!1,this.ownerEmail=a.ownerEmail||"",this.loaded=0,this.template={},this.plays=!1,this.moves=!1,this.initProgressBar=!0,a.element?this.template.container=a.element:this.createTemplate(),this.notBindOnCreate||this.bind(),this.getElement().data("item",b)};return p.prototype.getId=function(){return this.id},p.prototype.getOwnerId=function(){return this.uid},p.prototype.getName=function(){return this.name},p.prototype.getAuthor=function(){return this.author},p.prototype.getUrl=function(){var a=this,b=this.getPlaylist(),c=this.url,d=b.getOwnerPageId()!==!1?b.getOwnerPageId():a.getOwnerId();return d&&(c=c.indexOf("?")===-1?c+"?u="+d:c+"&u="+d),c},p.prototype.getText=function(){return this.text},p.prototype.getFullName=function(){return"<b>"+this.getAuthor()+"</b> - "+this.getName()},p.prototype.getElement=function(b){var c=this,d=null,e=this.handler;return void 0!==b&&b.length>0?(c.template[b]||(c.template[b]=c.template.container.find(e[b])),d=c.template[b]||a()):d=c.template.container,d},p.prototype.getPlaylist=function(){return this.playlist},p.prototype.getPosition=function(){return this.position},p.prototype.setPosition=function(a){return this.position=a,this.getElement("number").text(a+1),this},p.prototype.getNumber=function(){return this.number},p.prototype.setNumber=function(a){return this.number=a,this},p.prototype.hasPlay=function(){return this.plays},p.prototype.stop=function(){var a=this.handler;return this.getElement().removeClass(a.playsTrack),this.getElement("play").removeClass(a.playsButton),this.getElement("current").html(""),this.showProgress(0,0),this.plays=!1,this},p.prototype.play=function(){var b=this,c=this.handler;return a(document).trigger("AudioPlayer.play"),j.playTrack(this),b.plays=!0,b.getElement().addClass(c.playsTrack),b.getElement("play").addClass(c.playsButton),b.initProgressBar&&b.initProgressBarFn(),this},p.prototype.pause=function(){return j.pause(),this.setPauseState()},p.prototype.setPauseState=function(){var a=this.handler;return this.plays=!1,this.getElement("play").removeClass(a.playsButton),this},p.prototype.remove=function(){var a=this,b=this.getPlaylist(),c=b.getTracks().indexOf(a);return null!==j.getTrack()&&j.getTrack().getId()===a.getId()&&j.stop(),a.getElement().fadeOut(200,function(){a.getElement().remove()}),b.tracks.splice(c,1),!1},p.prototype.setCurrentTime=function(a){return this.getElement("current").html(a+" / "),this},p.prototype.setDuration=function(a){return this.duration=a,this},p.prototype.getDuration=function(){return this.duration},p.prototype.setVolume=function(a,b){if(this.getElement("volumeSeek").height(a+"%"),a=100-a,100===a){var c=this.getElement("volumeBar").height(),d=this.getElement("volumeControl").height();a=100-d/c*100}return this.getElement("volumeControl").css({top:a+"%"}),b?this.getElement().addClass(this.handler.volumeMute):this.getElement().removeClass(this.handler.volumeMute),this},p.prototype.showProgress=function(a){var b=this.getElement("progressSeek"),c=this.getElement("progressControl");return c.hasClass("ui-draggable-dragging")||(c.css({left:a+"%"}),b.width(a+"%")),this},p.prototype.showLoaded=function(a){var b=this.getElement("progressLoaded");return b.width(a+"%"),this.loaded=a,this},p.prototype.getLoaded=function(a){return this.loaded},p.prototype.setPlaylist=function(a){return this.playlist=a,this},p.prototype.getPlaylist=function(){return this.playlist},p.prototype.add=function(){var a=this,e=this.getElement("add"),h=a.getPlaylist(),i={file_id:a.id,user_track_id:a.userTrackId,owner:a.ownerEmail,add_to:h.getActiveEmail()},j=function(a,b){a.html(g.getHtml("song_added")),a.addClass("added").attr("title",b),1===a.data("owner")?c.myrb(716737):c.myrb(716739)};return this.fileAdded||this.isAjaxRunning||(this.isAjaxRunning=!0,b.func("audio.add",i,{dataType:"json",success:function(b){a.isAjaxRunning=!1;var c=b[2];"ok"===c?(o("trackAdd",a.getFragment()),a.fileAdded=!0,j(e,l.audio_added)):"too_many_audio"===c?j(e,l.too_many_audio):"cannot_add"===c?j(e,l.cannot_add_audio):"exists"===c?j(e,l.audio_rep):j(e,l.audio_error),"ok"!==c&&"exists"!==c||d("ui/bubble2",function(c){var d=b[3]||{},g=c.create({width:"150px",style:"mini",target:e,content:f.stringFormat(l.audioAddedInPlaylist,d.id),container:a.getElement(),addClass:"jp__track-bubble",corner:"vertical right center",position:{my:"right center",at:"left center",offset:"-10 0"}}).show();setTimeout(function(){g.getElement().fadeOut(300,function(){g.destroy()})},3e3)})}})),this},p.prototype.editTrackInfo=function(a,c){var d,f=this,g="/cgi-bin/my/ajax",h=f.getElement(),i=f.getPlaylist(),j=c.find("#audio-edit-track-save"),k=c.find("#edit_author"),l=c.find("#edit_name");d={file_id:f.getId(),user_track_id:f.userTrackId,name:l.val(),author:k.val()},i.isCommunity&&(g=i.dir),l.hasClass("error")&&l.removeClass("error"),k.hasClass("error")&&k.removeClass("error"),d.name.length>0&&d.author.length>0?b.func(a,d,{dataType:"json",url:g,beforeSend:function(){j.addClass("progress")},success:function(a){"OK"===a[1]&&"ok"===a[2]&&(f.name=d.name,f.author=d.author,j.removeClass("progress"),h.find(".js-jp__track-fullname").html(e.escape(d.name)),h.find(".js-jp__track-performer").html(e.escape(d.author)),c.off(),c.hide())}}):(0===d.name.length&&l.addClass("error"),0===d.author.length&&k.addClass("error"))},p.prototype.realDeleteTrack=function(a){var c=this,d={file_id:c.id,user_track_id:c.userTrackId},e="/cgi-bin/my/ajax",f=c.getPlaylist();f.isCommunity&&(e=f.dir),b.func(a,d,{dataType:"json",url:e}),c.remove()},p.prototype.saveOrder=function(){var a=this,c=a.getPlaylist(),d="/cgi-bin/my/ajax",e={user:c.getActiveEmail(),file:a.getId(),user_track_id:a.userTrackId,order:a.getNumber()};c.isCommunity&&(e.user=c.email,d=c.dir),b.func("audio.order",e,{dataType:"json",url:d})},p.prototype.createTemplate=function(){var b=this,c=b.getPlaylist();b.template.container=a(m).clone(),"top"===c.getType()&&(b.change>=1?b.getElement().find(".js-position-up").addClass("js-audio_show"):b.change<=-1&&b.getElement().find(".js-position-down").addClass("js-audio_show"));var d="";d=b.ownerDir.length>0?l.upload+'<a href="'+b.ownerDir+'" class="jp__track-author">'+e.escape(b.ownerName)+"</a>  - id"+b.ownerId:l.upload+'<span class="jp__track-author">'+e.escape(b.ownerName)+"</span>  - id"+b.ownerId,b.getElement("uploader").html(d),b.getElement("total").html(b.getDuration()),b.getElement("fullnameLink").html(b.getName()).attr({href:"/music/songs/"+b.getId()}),b.getAuthor().length>0&&b.getElement("performerLink").html(b.getAuthor()).attr({href:"/music/artists/"+b.getAuthor()}),b.fileAdded&&b.getElement("add").removeClass("icon-add_song").addClass("icon-song_added added").attr("title",l.audio_added)},p.prototype.getFragment=function(){return this.getPlaylist().getFragment()},p.prototype.getEventType=function(){return this.getPlaylist().getEventType()},p.prototype.bind=function(){var b=this,c=b.handler,d=b.getElement();b.getElement().addClass(c.initTrack),d.on("click touchend",function(c){var e=a(c.target);e.attr("href")||e.hasClass("jp__track-volume-wrapper")||(c.preventDefault(),"openAuthPopup"!==d.data("action")?b.hasPlay()?b.pause():b.play():(c.stopPropagation(),h()))}),d.on("click touchend",c.add,function(a){"openAuthPopup"!==d.data("action")?(a.stopPropagation(),b.add()):(a.stopPropagation(),h())}),b.getElement("edit").on("click",function(a){a.stopPropagation(),i.editTrack(b)}),b.getElement("admedit").on("click",function(a,c){a.stopPropagation(),i.editTrackTop(b)}),b.getElement("del").on("click",function(a){var c="audio.remove";a.stopPropagation(),b.realDeleteTrack(c)}),b.getElement("id").on("click",function(c){c.stopPropagation();var d=b.getElement("container"),e=a('<span class="jp_moderate_text">'+b.getId()+'<i class="jp_moderate_text__icon ui-icon icon-mmico_close_gray_16"></i></span>');e.on("click",".jp_moderate_text__icon",function(){e.off("click"),e.remove(),b.getPlaylist().getElement().sortable("enable").disableSelection()}),0===d.find(".jp_moderate_text").length&&(d.append(e),b.getPlaylist().getElement().sortable("disable").enableSelection())}),b.getElement("admdeltop").on("click",function(a){var c="audio.remove_from_top";a.stopPropagation(),b.realDeleteTrack(c)}),b.getElement("admcopy").on("click",function(c){c.stopPropagation();var d=b.getElement("container"),e=a('<span class="jp_moderate_text">'+window.location.protocol+"//my.mail.ru/cgi-bin/my/audiotrack?file="+b.id+"&uid="+b.uid+'<i class="jp_moderate_text__icon ui-icon icon-mmico_close_gray_16"></i></span>');e.on("click",".jp_moderate_text__icon",function(){e.off("click"),e.remove(),b.getPlaylist().getElement().sortable("enable").disableSelection()}),0===d.find(".jp_moderate_text").length&&(d.append(e),b.getPlaylist().getElement().sortable("disable").enableSelection())})},p.prototype.initProgressBarFn=function(){var b=this,c=b.handler,e=b.getElement();b.initProgressBar=!1,e.on("click touchend",c.progressaArea,function(a){a.stopPropagation();var c=b.getElement("progressBar"),d=c.offset(),e=a.pageX-d.left,f=c.width(),g=100*e/f;j.playHead(g)}),e.on("mouseenter",c.progressaArea,function(a){b.getElement("progressTime").show()}).on("mouseleave",c.progressaArea,function(){b.getElement("progressTime").hide()}).on("mousemove",c.progressaArea,function(c){var d=a(this).offset(),e=c.pageX-d.left,f=b.getDuration(),g=a(this).width(),h=100*e/g;(h<0||h>100)&&b.getElement("progressTime").hide();var i=a.jPlayer.convertTime(n(f)/100*h);b.getElement("progressTime").css({left:e}).find(".ui-tooltip__text").html(i)}),e.on("click touchend",c.volumeArea,function(a){a.stopPropagation();var c=b.getElement("volumeBar"),d=c.offset(),e=a.pageY-d.top,f=c.height(),g=b.getElement("volumeControl").height(),h=100*(f-e)/f;h>100?h=100:f-e<=g&&(h=0),j.setVolume(h)}),e.on("click touchend",c.volumeIcon,function(a){a.stopPropagation(),j.setVolume(0,!0)}),e.on("click touchend",c.volumeIconMute,function(a){a.stopPropagation(),j.setVolume(j.getVolume())}),d("jquery-ui/draggable",function(){b.getElement("progressControl").draggable({axis:"x",containment:"parent",refreshPositions:!0,stop:function(a,c){var d=b.getElement("progressBar"),e=c.position.left,f=d.width(),g=100*e/f;j.playHead(g)},drag:function(a,c){var d=b.getElement("progressBar"),e=b.getElement("progressSeek"),f=c.position.left,g=d.width(),h=100*f/g;e.width(h+"%")}}),b.getElement("volumeControl").draggable({axis:"y",containment:"parent",stop:function(a,c){var d=b.getElement("volumeBar"),e=c.position.top,f=d.height(),g=b.getElement("volumeControl").height(),h=100*(f-e)/f,i=!1;h>100?h=100:f-e<=g&&(h=0,i=!0),j.setVolume(h,i)},drag:function(a,c){var d=b.getElement("volumeBar"),e=c.position.top,f=d.height(),g=b.getElement("volumeControl").height(),h=100*(f-e)/f,i=!1;h>100?h=100:f-e<=g&&(h=0,i=!0),j.setVolume(h,i)}})})},{init:function(a){i=a,j=a.getPlayer(),k=a.getConfig().handler,l=a.getConfig().msg,m=a.getConfig().trackTemplate},create:function(a){return new p(a)}}})},b.modules=["audio-player","audio-player/player","audio-player/playlist","audio-player/track","audio_player"]});