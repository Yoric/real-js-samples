define(["jquery","counters","base/view","util/helpers","util/htmlescape","video-html5/controls"],function(a,b,c,d,e,f){"use strict";var g=c.extend({props:{CNT:{bannerShown:22307968,overlayClosed:22307990,advPlayingExternal:23762970,advPlayingInternal:23762950,advPlayingAuth:23841720,goAdvPlaying:25568732},cssClasses:{advSkip:"b-video-html5__skip",advTimer:"b-video-html5__adv-timer"},deferred:{trashOverlay:"video-html5/commerce/custom-overlay",trashPreroll:"video-html5/commerce/custom-preroll"},defaultOptions:{trashPrerollSlot:1183,trashOverlaySlot:143824,trashPrerollSkipTime:5}},public:{init:function(){return this.promises={},this.stat=this.options.stat,this.$advContainer=this.options.$container,this.$overlayContainer=a(this.options.params.wrapper),this.video=this.$el[0],g.__super__.init.call(this)},destroy:function(){return this.destroyPreroll(),g.__super__.destroy.call(this)},playPreroll:function(){return this.currentAdvType="preroll",new Promise(function(a,b){this.promises.preroll={resolve:a,reject:b},this.require("trashPreroll",function(a){this.trashPreroll=a.createRunTime(d.extend(!0,{slot:this.options.trashPrerollSlot},this.options),this.$advContainer),this.trashPreroll.on("play",this.onAdvPlayed.bind(this)).on("pause",this.onAdvPaused.bind(this)).on("closed",this.onAdvCompleted.bind(this)).on("timeupdate",this.onAdvTime.bind(this)).on("preroll_click",this.onAdvClicked.bind(this)).on("ready",this.onPrerollReady.bind(this))}.bind(this))}.bind(this))},startOverlay:function(){return this.currentAdvType="overlay",new Promise(function(a,b){this.promises.overlay={resolve:a,reject:b},this.require("trashOverlay",function(a){this.trashOverlay=a.createRunTime(d.extend(!0,{slot:this.options.trashOverlaySlot,closeOnClick:this.options.closeOverlayOnClick},this.options),this.$overlayContainer),this.trashOverlay.on("started",this.onOverlayStarted.bind(this)).on("complete",this.onOverlayComplete.bind(this)).on("overlay_click",this.onOverlayClicked.bind(this)).on("closed",this.onOverlayClosed.bind(this)),this.trashOverlay.start()}.bind(this))}.bind(this))},pause:function(){this.trashPreroll.pause()},resume:function(){this.trashPreroll.play()},getControls:function(){return this.advControls},isPlaying:function(){return this.playing}},protected:{onPrerollReady:function(){this.createAdvControls(),this.createAdvSkip(),a(this.video).addClass("overlapped"),this.$advContainer.show(),this.advControls.updateView(),this.trashPreroll.play(),this.stat.send({name:"preroll_started"})},createAdvControls:function(){this.advControls||(this.advControls=f.createRunTime(a.extend(!0,{},{advMode:!0,mediaElement:this.trashPreroll,progressBarColor:"#A67100",showViral:!1,stat:this.stat,fullscreenElement:this.options.$parentElement.get(0)}),this.$advContainer))},onAdvCompleted:function(a){this.destroyPreroll()},onAdvClicked:function(a){this.promises.preroll.resolve(),setTimeout(function(){this.destroyPreroll(),this.video.pause()}.bind(this),300)},onOverlayClicked:function(a){this.video.pause()},createAdvSkip:function(){this.$advSkip=a("<div></div>").addClass(this.cssClasses.advSkip).appendTo(this.$advContainer),this.$advSkip.html(this.options.locales.advRemaining||e.unescape(this.options.locales.adv.remaining)),this.advTimeout=this.options.trashPrerollSkipTime,this.$advTimer=this.$advSkip.find("."+this.cssClasses.advTimer),this.$advTimer.html(this.advTimeout),this.$advSkip.hide()},onAdvTime:function(c,d){c=d||c;var f=Math.round(this.advTimeout-c.currentTime);this.advCurrentTime=c.currentTime,this.$advTimer&&this.$advTimer.html(f),f<=0&&(a("<div></div>").css({position:"absolute",top:"-10px",left:"-10px",bottom:"-10px",right:"-10px"}).appendTo(this.$advSkip),this.$advSkip.html(this.options.locales.advSkip||e.unescape(this.options.locales.adv.skip)).addClass("complete").on("click",this.onAdvSkipClick.bind(this)).focus()),this.$advSkip&&this.advCurrentTime>0&&this.$advSkip.show(),!this.prerollPlaying&&c.duration&&(this.options.external?b.myrb(this.CNT.advPlayingExternal):b.myrb(this.CNT.advPlayingInternal),this.options.authorized&&b.myrb(this.CNT.advPlayingAuth),"go"===this.options.partnerId&&b.myrb(this.CNT.goAdvPlaying),this.stat.comScorePlayAdv(c.duration),this.prerollPlaying=!0)},onAdvSkipClick:function(a){this.$advSkip.off(),this.trashPreroll.skip()},onAdvPlayed:function(){this.playing=!0},onAdvPaused:function(){this.playing=!1},destroyPreroll:function(){this.trashPreroll&&delete this.trashPreroll,this.advControls&&(this.advControls.destroy(),delete this.advControls),this.$advSkip&&(this.$advSkip.off("click").remove(),delete this.$advSkip),a(this.video).removeClass("overlapped"),this.$advContainer.hide(),this.promises.preroll&&(this.prerollPlaying?this.promises.preroll.resolve():this.promises.preroll.reject())},onOverlayStarted:function(){b.myrb(this.CNT.bannerShown),this.promises.overlay.resolve()},onOverlayClosed:function(){b.myrb(this.CNT.overlayClosed)},onOverlayComplete:function(){this.promises.overlay.reject()}}});return g});