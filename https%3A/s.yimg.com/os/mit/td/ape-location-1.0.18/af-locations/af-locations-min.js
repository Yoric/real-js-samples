YUI.add("af-locations",function(e){"use strict";e.namespace("Af").Locations=e.Mjata.ModelBase.createModelListClass("AfLocations","1.0",e.Mjata.LazyModelList,e.Mjata.Model,[e.Af.Sync],{currentLocation:null,isGeoCapable:null,readonly:!1,resource:"location",consolidate:!1,favCache:null,syncContext:{config:{uri:"/_td_api"},context:{crumb:"",helper:"ugeo"}},selectedLocation:null,EVT_FAV_LOC_ADDED:"favLocationAdded",EVT_FAV_LOC_DELETED:"favLocationDeleted",initializer:function(e){var t=this;t.favCache={},t.syncContext.config.uri=e.xhr_path||t.syncContext.config.uri,t.syncContext.context.crumb=e.user_crumb,t.geoCapable(),e.current&&e.current.woeid?t.setCurrent(e.current,!0):t._getLocationData("location.user.current",{},function(e,o){!e&&o&&t.setCurrent(o,!0)}),e.favorite||t.getFavoriteLocations()},geoCapable:function(){var e=this;return null===e.isGeoCapable&&(e.isGeoCapable=!!window.navigator.geolocation),e.isGeoCapable},getCurrentLocation:function(e,t){var o=this,a=o.isGeoCapable||o.geoCapable();t=t||!1,a?o.getUserCurrentPosition(function(a,n){a||o.setCurrent(n,t),"function"==typeof e&&e(a,n)}):o._getLocationData("location.user.current",{},function(a,n){!a&&n&&o.setCurrent(n,t),"function"==typeof e&&e(a,n||null)})},_roundFloats:function(e,t){return Math.round(e*t)/t},getUserCurrentPosition:function(t){var o=this,a=e.Af.Utils.i18n("ape-location/strings");navigator.geolocation.getCurrentPosition(function(e){o.createLocation("location.user.current",{lat:String(e.coords.latitude),lon:String(e.coords.longitude),radius:parseInt(e.coords.accuracy)},t)},function(e){var o={1:{code:401,message:a.BROWSER_DENIED_PERMISSION||"Browser denied permission to get your current location"},2:{code:500,message:a.BROWSER_LOCATION_NOT_FOUND||"Browser was unable to find your current location"},3:{code:408,message:a.BROWSER_TIMEOUT_LOCATION||"Browser timed out getting your location"}};t(o[e.code],null)},{timeout:1e4,maximumAge:0})},getFavoriteLocations:function(t,o){t=t||{};var a=this;a._getLocationData("location.user.favorite",t,function(t,n){!t&&n&&(e.Lang.isArray(n)||(n=[n]),a.set("favorite",n)),"function"==typeof o&&o(t,n)})},createLocation:function(e,t,o){if(!e||!t)return o(null,null);var a,n=null,i=this;switch(e){case"current":case"location.user.current":n="location.user.current";break;case"favorite":case"location.user.favorite":n="location.user.favorite";break;default:return o(null,null)}a=t.woeid?{resource:n,params:{woeid:t.woeid}}:{resource:n,params:{latitude:t.lat,longitude:t.lon,radius:t.radius}},i.sync("create",a,function(e,a){!e&&a&&a.woeid&&"location.user.favorite"===n&&(t.id=i._createLocationCacheKey(a),i.appendFavoriteLocation(a,!0)),"function"==typeof o&&o(e,a)})},appendFavoriteLocation:function(e,t){if(e){var o=this,a=o._createLocationCacheKey(e);o.favCache.hasOwnProperty(a)||(e.type="favorite",e.id=a,o.set("favorite",e),o.updateLocation(e,t)),o.fire(o.EVT_FAV_LOC_ADDED,{location:e})}},deleteLocation:function(t,o){var a,n=this;t.id?(a={resource:"location.user.favorite"},t.canonical&&"woe"===t.canonical?a.params={woeid:t.woeid}:a.params={latitude:t.lat,longitude:t.lon,radius:t.radius},n.sync("delete",a,function(a,i){var r,c,s;a||(r=n.get("favorite"),c=e.Af.Utils.getObjectInArray(r,"id",t.id),s=t.id,n.favCache.hasOwnProperty(s)&&delete n.favCache[s],r.splice(c.index,1),n.set("favorite",r)),o(a,i)}),n.fire(n.EVT_FAV_LOC_DELETED,{location:t})):o({error:400,message:"Missing id field"},null)},updateLocation:function(e,t){t=t||!1,e&&e.woeid&&(this.selectedLocation=e,this.set("location",e.woeid,{silent:t}),t||this._setSelected(e,t))},search:function(e,t){if(e&&e.hasOwnProperty("text")){var o=this,a=e.text,n=o.getCurrent(),i={text:a},r=e.hasOwnProperty("resource")?e.resource:"location.search";n&&n.hasOwnProperty("lat")&&n.hasOwnProperty("lon")&&(i.radius=o._roundFloats(n.lon,1e3)+","+o._roundFloats(n.lat,1e3)),e.hasOwnProperty("type")&&(i.type=e.type),o._findLocation(r,i,function(e,n){var i,r={text:a,data:null};if(!e&&n&&(o.set("displayState","search"),n.length)){if(!n[0]||!n[0].hasOwnProperty("woeid"))return t(null,r);i=o._mergeSearchWithFavorites(n),r.data=i}t(e,r)})}},_mergeSearchWithFavorites:function(t){var o,a,n,i,r,c,s=[],u=[];if(e.Lang.isArray(t)||(t=[t]),a=t.length,!(c=this.get("favorite"))||!c.length)return t;for(o=0;o<a;o+=1)n=t[o],i=this._createLocationCacheKey(n),this.favCache.hasOwnProperty(i)?(r=this.favCache[i])?s.push(r):(n.type="favorite",n.id=i,s.push(n)):u.push(n);return s.concat(u)},_setSelected:function(e,t){var o=this,a=this.getCurrent(),n=o.getSelectedLocation();a.woeid&&a.woeid!==e.woeid?this.createLocation("location.user.current",e,function(e,a){e||(o.setCurrent(a,!0),o.selectedLocation=a,t||o.fire("selectedLocationChange",{newVal:a,prevVal:n}))}):t||o.fire("selectedLocationChange",{newVal:e,prevVal:n})},getSelectedLocation:function(){return this.selectedLocation},setCurrent:function(e,t){if(e){var o=this.getCurrent();e.qualifiedName=e.qualifiedName||e.city+", "+(e.statecode||e.state),this.currentLocation=e,this.updateLocation(e,t),t||this.fire("currentChange",{newVal:e,prevVal:o})}},getCurrent:function(){return this.currentLocation},_getLocationData:function(e,t,o){this.load({resource:e,params:{}},o)},_findLocation:function(e,t,o){this.load({resource:e,params:t},o)},_createLocationCacheKey:function(e){if(!e||!e.city)return null;var t=e.city+"_";return t+=e.statecode?e.statecode:e.state,t.replace(/\s/g,"_").toLowerCase()}},{ATTRS:{locdrop_crumb:{},location:{},favorite:{setter:function(t){if(!t)return null;var o,a,n,i,r=this.get("favorite")||[],c=[];for(e.Lang.isArray(t)||(t=[t]),a=t.length,o=0;o<a;o+=1)n=t[o],(i=this._createLocationCacheKey(n))&&!this.favCache.hasOwnProperty(i)&&(this.favCache[i]=n,n.type="favorite",n.id=i,c.push(n)),n.qualifiedName=n.qualifiedName||n.city+", "+(n.statecode||n.state);return c.length&&r&&r.length?t=c.concat(r):r&&r.length>0?t=r:c&&(t=c),t}}}})},"@VERSION@",{
requires:["af-sync","af-utils","mjata-model-base","mjata-model","mjata-lazy-modellist","mjata-model-store"]});