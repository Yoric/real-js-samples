define(["jquery","client-server","counters","factory","util/helpers","util/htmlescape","video-html5/share","video-html5/circle-preloader"],function(a,b,c,d,e,f,g,h){"use strict";var i,j={relatedUrl:null,videoHost:"//video.mail.ru/",contentVideoHost:"//content.video.mail.ru/",videoUrl:"",relatedItemSize:{width:160,height:120,marginBottom:3,marginRight:3},viewport:{verticalPadding:40,horizontalPadding:60},maxRelatedItemLength:50,speedAnimation:400,locales:{},arrowMargin:10,deltaTouchMove:50,onRelatedItemClick:null,autoplay:!1,share:["mm","ok","vk","tw","fb","gplus","addVideo"]},k={main:"b-video-backscreen",relatedWrapper:"b-video-backscreen__related-wrapper",related:"b-video-backscreen__related",relatedItem:"b-video-backscreen__related-item",relatedItemTitle:"b-video-backscreen__related-item__title",relatedItemNextTitle:"b-video-backscreen__related-item__next_title",relatedItemViewCount:"b-video-backscreen__related-item__view-count",relatedItemOwner:"b-video-backscreen__related-item__owner",relatedItemAutoplay:"b-video-backscreen__related-item-autoplay",relatedItemAutoplayIcon:"b-video-backscreen__related-item-autoplay-icon",relatedItemClose:"b-video-backscreen__related-item__close",relatedCol:"b-video-backscreen__related-col",autoplayProgress:"b-video-backscreen__related-item-autoplay__progress",autoplayProgressCircle:"b-video-backscreen__related-item-autoplay__progress__circle",autoplayProgressCircleBack:"b-video-backscreen__related-item-autoplay__circle_back",leftArrow:"b-video-backscreen__left-arrow",rightArrow:"b-video-backscreen__right-arrow",button:"b-video-backscreen__button",buttonTitle:"b-video-backscreen__button__title",sharePanel:"b-video-backscreen__share-panel",shareIcon:"b-video-backscreen__share-icon",codeIcon:"b-video-backscreen__code-icon",addVideo:"b-video-backscreen__add-video-label"},l={left:"icon-player-video_left",right:"icon-player-video_right",autoplay:"icon-player-backscreen_autoplay",mm:"icon-player-backscreen_video_mm_share_60x60",ok:"icon-player-backscreen_video_ok_share_60x60",vk:"icon-player-backscreen_video_vk_share_60x60",tw:"icon-player-backscreen_video_twitter_share_60x60",fb:"icon-player-backscreen_video_fb_share_60x60",gplus:"icon-player-backscreen_video_gplus_share_60x60",code:"icon-player-video_link_small"},m={show:2125181,showInside:2125182,showExternal:2125184,showEmpty:2125186,clickRelated:26118414,clickRelatedPartner:1913354,clickRelatedExternal:2125204,clickRelatedInside:26118378,clickArrow:2125252,clickGetLink:2125285,clickShare:2125286,autoplayShow:18908421,autoplayCancel:18908439,autoplayPause:18908478,autoplayRestart:18908501};return i={init:function(b,d){this.options=a.extend(!0,{},j,d),this.stat=this.options.stat,this.$videoElement=this.options.videoElement,this.$parent=b,this._errorMode=this.options.errorMode,this.clickedTime=0;var f=this.options.poster||this.$videoElement.attr("poster");this.$videoElement.attr("poster",f),this.$el=a("<div></div>").addClass(k.main).appendTo(b),this.$relatedWrapper=a("<div></div>").addClass(k.relatedWrapper).appendTo(this.$el),this.$related=a("<div></div>").addClass(k.related).appendTo(this.$relatedWrapper),e.os.isMobile()&&this.$related.on("touchstart",this._onRelatedTouchStart.bind(this)).on("touchmove",this._onRelatedTouchMove.bind(this)).on("touchend",this._onRelatedTouchEnd.bind(this)),this._updateRelated(),e.isjQueryObject(this.$videoElement)&&(this.$videoElement.on("play",this._onVideoPlay.bind(this)),this.$videoElement.get(0).addEventListener("pause",this._onVideoPause.bind(this)),this.$videoElement.get(0).addEventListener("ended",this._onVideoEnded.bind(this)),this._onWindowResizeHandler=this._onWindowResize.bind(this)),a(window).on("resize",this._onWindowResizeHandler),this._lastTimeMove=(new Date).getTime(),this._playNow=!0,c.myrb(m.show),this.options.inside?c.myrb(m.showInside):c.myrb(m.showExternal),this.options.showViral&&this._initSharePanel(),this._errorMode&&this.stat.send({name:"error_backscreen_shown"},!0)},destroy:function(){this.$el.remove(),a(window).off("resize",this._onWindowResizeHandler),this.preloader&&(this.preloader.destroy(),delete this.preloader)},getRelated:function(c){function d(a){e.isString(a)&&(a=JSON.parse(a)),"OK"===a[1]?e.isFunction(c)&&(a[2].items?(c(a[2].items),this._related=a[2].items):a[3]?(c(a[3]),this._related=a[3]):(c([]),this._related=[]),this._related.length&&this.stat.send({name:"backscreen_shown",value:this._related[0].Type},!0)):a.videos?(c(a.videos),this._related=a.videos,this._related.length&&this.stat.send({name:"backscreen_shown",value:"related"},!0)):e.isFunction(c)&&c([])}var f,g=a("#b-video-search__filter-unsafe"),h=g.size()&&!g.is(":checked");if(this._related)e.isFunction(c)&&c(this._related);else if(this.options.relatedHost){var i,j=[];i=this.options.relatedHost.indexOf("?")!==-1?this.options.relatedHost+"&":this.options.relatedHost+"?",h&&j.push("unsafe=1"),j.push("backscreen=1"),j.push("arg_externalid="+this.options.videoUrl),j.push("external_id="+this.options.videoUrl),a.ajax({url:i+j.join("&"),crossDomain:!0,dataType:"json",success:d.bind(this),error:function(a,b,d){e.isFunction(c)&&c([]),this._related=[]}.bind(this)})}else{var k="/+/video/related/"+this.options.videoId+"?ver=2";f={backscreen:1},h&&(f.unsafe=1),this.options.limit&&(f.limit=this.options.limit),b.func("",f,{url:k,success:d.bind(this),fail:function(){e.isFunction(c)&&c([]),this._related=[]}.bind(this)},null,null,null,!0)}},getPreviewImage:function(){var a,b=this.options.videoUrl.split("/");return b[b.length-1]="i-"+b[b.length-1]+".jpg",a=b.join("/"),this.options.contentVideoHost+a},moveLeft:function(){var a=(new Date).getTime();a-this._lastTimeMove>this.options.speedAnimation&&(this.currentPage>0&&(this.$related.css({left:this.$related.position().left+(this.$relatedWrapper.outerWidth()+this.options.relatedItemSize.marginRight)}),1===this.currentPage&&this.pauseAutoplay(!1),this.currentPage--,this.$rightArrow.removeClass("disable")),0===this.currentPage&&this.$leftArrow.addClass("disable"),this._lastTimeMove=a)},moveRight:function(){var a=(new Date).getTime();a-this._lastTimeMove>this.options.speedAnimation&&(this.currentPage+1<this.pageCount&&(this.$related.css({left:this.$related.position().left-(this.$relatedWrapper.width()+this.options.relatedItemSize.marginRight)}),this.currentPage++,this.$leftArrow.removeClass("disable")),this.currentPage+1===this.pageCount&&this.$rightArrow.addClass("disable"),this._lastTimeMove=a),this.pauseAutoplay(!0)},_initSharePanel:function(){this.$sharePanel=a("<div></div>").addClass(k.sharePanel).appendTo(this.$el),this.options.external||this.options.share.shift(),this.options.canAdd&&!this.options.external||(this.options.share=this.options.share.slice(0,-1)),this.options.share.unshift("code"),this.options.share.forEach(function(b){var c=a("<div></div>").attr({"data-share-type":b}).appendTo(this.$sharePanel);"addVideo"===b?(c.text(this.options.locales.addVideo),c.addClass(k.addVideo)):"code"===b?c.addClass(l[b]).addClass(k.codeIcon):c.addClass(l[b]).addClass(k.shareIcon),"code"===b?c.on("click",this._onEmbedCodeClick.bind(this)):c.on("click",this._onShareItemClick.bind(this))}.bind(this)),this.$sharePanel.hide()},_onEmbedCodeClick:function(){this.$bubbleLink?(this.$bubbleLink.addClass("show center"),this.pauseAutoplay(!0)):d("video-html5/link-bubble",function(a){this.$bubbleLink=a.create(this.options).on("close",function(){this.pauseAutoplay(!1)}.bind(this)).appendTo(this.$el),this.$bubbleLink.addClass("show center"),this.pauseAutoplay(!0)}.bind(this))},_onShareItemClick:function(b){var c=a(b.target).closest("[data-share-type]"),d=c.data("shareType");"addVideo"===d?(b.preventDefault(),b.stopImmediatePropagation(),a(document.body).trigger("addVideoClick",[this.$parent]),this._onCancelAutoplay()):g.openWindow(d,"fromPlayer")},_onCancelAutoplay:function(a){a&&a.stopImmediatePropagation(),this.preloader&&(this.preloader.destroy(),this.options.autoplay=!1,this._updateRelated(),delete this.preloader,c.myrb(m.autoplayCancel))},pauseAutoplay:function(a){this.preloader&&(a?this.preloader.stop():this.preloader.reset(),c.myrb(a?m.autoplayPause:m.autoplayRestart))},switchAutoplay:function(a){this.options.autoplay!==a&&(this.options.autoplay=a,a?this._updateRelated():this._onCancelAutoplay())},_updateRelated:function(){this.$related.empty(),this.$related.css({left:0}),this._removeArrows(),this._initViewport(),this.options.disabled?(this._related=[],this.$parent.trigger("relatedEmpty"),c.myrb(m.showEmpty)):this.getRelated(function(b){b&&b.length?(this._renderRelated(b),a(".b-video-viral-panel").hide()):(this.$parent.trigger("relatedEmpty"),c.myrb(m.showEmpty))}.bind(this))},_renderRelatedItem:function(b){var c;return c=a("<div></div>").addClass(k.relatedItem).css({backgroundImage:"url("+b.imageUrl+")"}),a("<div></div>").addClass(k.relatedItemTitle).html(f.escape(b.title)).appendTo(c),b.viewCount&&a("<div></div>").addClass(k.relatedItemViewCount).html(String(b.viewCount).replace(/(\d)(?=(\d{3})+(?!\d))/g,"$1 ")).appendTo(c),a("<div></div>").addClass(k.relatedItemOwner).html(b.author).appendTo(c),e.os.isMobile()?c.on("touchstart",function(a){this.touchedItem=b}.bind(this)):c.on("click",function(a){a.stopPropagation(),this.touchedItem=b,this._relatedItemClick()}.bind(this)),c},_renderRelatedAutoPlayItem:function(b,d){var e;return d?(e=a("<div></div>").addClass(k.relatedItemAutoplay).css({backgroundImage:"url("+b.imageUrl+")"}),e.on("touchstart",function(a){this.touchedItem=b}.bind(this)),a("<div></div>").addClass(k.relatedItemAutoplayIcon).addClass(l.autoplay).appendTo(e),this.preloader&&this.preloader.destroy(),this.preloader=h.create(e,{cssClasses:{progress:k.autoplayProgress,progressCircle:k.autoplayProgressCircle,backCircle:k.autoplayProgressCircleBack},timer:10,onTimer:function(){this.touchedItem=b,this.touchedItem.url+=(this.touchedItem.url.indexOf("?")===-1?"?":"&")+"backscreen_autoplay=1",this._relatedItemClick()}.bind(this)}),this.preloader.reset(),c.myrb(m.autoplayShow)):(e=a("<div></div>").addClass(k.relatedItemAutoplay),a("<div></div>").addClass(k.relatedItemNextTitle).appendTo(e).text(this.options.locales.next),a("<div></div>").addClass(k.relatedItemClose).appendTo(e).on("click",this._onCancelAutoplay.bind(this)),a("<div></div>").addClass(k.relatedItemTitle).html(f.escape(b.title)).appendTo(e),b.viewCount&&a("<div></div>").addClass(k.relatedItemViewCount).html(String(b.viewCount).replace(/(\d)(?=(\d{3})+(?!\d))/g,"$1 ")).appendTo(e)),e.on("click",function(a){a.stopPropagation(),this.touchedItem=b,this._relatedItemClick()}.bind(this)),e},parseItem:function(a){var b={},c=a.Title||a.title||"";return c.length>this.options.maxRelatedItemLength?b.title=c.slice(0,this.options.maxRelatedItemLength)+"...":b.title=c,b.viewCount=a.ViewCount||a.count&&a.count.view,a.OwnerFirstName&&a.OwnerLastName?b.author=a.OwnerFirstName+" "+a.OwnerLastName:b.author=a.nickname||a.OwnerEmail||a.user&&a.user.name||"",b.url=a.UrlHtml||a.url&&a.url.video,b.imageUrl=a.FiledUrl||a.ImageUrlP||a.preview&&a.preview.urlFiled+"&mw=320&mh=240",b.type=a.Type,b.id=a.id,b},_relatedItemClick:function(){e.isFunction(this.options.onRelatedItemClick)&&this.touchedItem&&Date.now()-this.clickedTime>1e3&&(c.myrb(m.clickRelated),this.options.inside?(c.myrb(m.clickRelatedInside),this.options.external&&c.myrb(m.clickRelatedPartner)):c.myrb(m.clickRelatedExternal),this.options.backscreenCounter&&c.myrb(this.options.backscreenCounter),this.options.onRelatedItemClick(this.touchedItem),this._errorMode?this.stat.send({name:"error_related_clicked"},!0):this.stat.send({name:"click.related",value:this.touchedItem.type},!0),this.touchedItem=void 0,this.clickedTime=Date.now())},_initViewport:function(){this._viewport={width:this.$el.outerWidth(),height:this.$el.outerHeight()},this._viewport.maxVerticalItems=Math.floor((this._viewport.height-2*this.options.viewport.verticalPadding)/(this.options.relatedItemSize.height+this.options.relatedItemSize.marginBottom)),this._viewport.maxHorizontalItems=Math.floor((this._viewport.width-2*this.options.viewport.horizontalPadding)/(this.options.relatedItemSize.width+this.options.relatedItemSize.marginRight))},_renderRelated:function(b){var c,d,e,f,g,h,i,j,l=!1,m=[],n=[];if(this.options.autoplay&&!this._errorMode&&n.push(b[0]),n=n.concat(b),c=n.length,g=c>this._viewport.maxHorizontalItems?Math.ceil(c/this._viewport.maxHorizontalItems)>this._viewport.maxVerticalItems?this._viewport.maxVerticalItems:Math.ceil(c/this._viewport.maxHorizontalItems):1,this._errorMode&&(g=Math.floor(g/2)||1),g>0){for(f=Math.ceil(c/(this._viewport.maxHorizontalItems*g))*this._viewport.maxHorizontalItems,j=this._viewport.maxHorizontalItems*g,i=0;i<f;i++)h=a("<div></div>").addClass(k.relatedCol).appendTo(this.$related).attr("data-col",i),m.push(h);n.forEach(function(a,b){i=Math.floor(b/j)*this._viewport.maxHorizontalItems+b%this._viewport.maxHorizontalItems,h=m[i],this.options.autoplay&&b<=1&&!this._errorMode?this._renderRelatedAutoPlayItem(this.parseItem(a),0===b).appendTo(h):this._renderRelatedItem(this.parseItem(a)).appendTo(h)}.bind(this)),this.$related.width(f*(this.options.relatedItemSize.width+this.options.relatedItemSize.marginRight)),f>this._viewport.maxHorizontalItems&&(this.currentPage=0,this.pageCount=Math.ceil(f/this._viewport.maxHorizontalItems),f=this._viewport.maxHorizontalItems,l=!0),d=f*this.options.relatedItemSize.width+(f-1)*this.options.relatedItemSize.marginRight,e=g*this.options.relatedItemSize.height+(g-1)*this.options.relatedItemSize.marginBottom,this.$relatedWrapper.css({width:d,height:e,top:this._errorMode?this.$el.height()/2:(this.$el.height()-e)/2}),this.$sharePanel&&(this._errorMode?this.$sharePanel.hide():(this.$sharePanel.css({left:0}),this.$sharePanel.show(),this.$sharePanel.css({left:(this.$el.width()-this.$sharePanel.width())/2,top:(this.$el.height()-e)/2-40}))),l&&this._renderArrows()}},_renderArrows:function(){var b={left:parseInt(this.$relatedWrapper.css("marginLeft"),10)||this.$relatedWrapper.position().left,top:parseInt(this.$relatedWrapper.css("top"),10)||0},c=this.$relatedWrapper.width(),d=this.$relatedWrapper.height();this._removeArrows(),this.$leftArrow=a("<div></div>").addClass(k.leftArrow).addClass(l.left).addClass("disable").css({left:b.left-this.options.arrowMargin,top:b.top+d/2}).on("click",this._onLeftArrowClick.bind(this)).appendTo(this.$el),this.$rightArrow=a("<div></div>").addClass(k.rightArrow).addClass(l.right).css({left:b.left+c+this.options.arrowMargin,top:b.top+d/2}).on("click",this._onRightArrowClick.bind(this)).appendTo(this.$el)},_removeArrows:function(){this.$leftArrow&&this.$leftArrow.remove(),this.$rightArrow&&this.$rightArrow.remove()},_onVideoPlay:function(b){this._playNow=!0,this.destroy(),a(".b-video-viral-panel").show()},_onVideoPause:function(){this._playNow=!0},_onVideoEnded:function(){this._playNow=!1},_onWindowResize:function(a){this._resizeTimeOut&&clearTimeout(this._resizeTimeOut),this._resizeTimeOut=setTimeout(function(){this._updateRelated()}.bind(this),300)},_onLeftArrowClick:function(a){this.moveLeft(),c.myrb(m.clickArrow),a.stopPropagation()},_onRightArrowClick:function(a){this.moveRight(),c.myrb(m.clickArrow),a.stopPropagation()},_onRelatedTouchStart:function(a){this._startTouchX=a.originalEvent.touches[0].pageX},_onRelatedTouchEnd:function(a){var b=Math.abs(this._startTouchX-a.originalEvent.changedTouches[0].pageX);b>this.options.deltaTouchMove?(this._startTouchX-a.originalEvent.changedTouches[0].pageX>0?this.moveRight():this.moveLeft(),a.preventDefault()):this._relatedItemClick()},_onRelatedTouchMove:function(a){a.preventDefault()}},{create:function(a,b){var c=Object.create(i);return c.init(a,b),c}}});