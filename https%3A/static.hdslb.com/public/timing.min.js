(function(){var n=1;var r=null;var i=null;var o=[];var c=false;var a="//api.bilibili.com/open/monitor/report?";window._bm_=window.performanceLog={setSource:function(e,t){n=e||1;r=t||null},getSource:function(){return n},setTraceId:function(e){i=e},setApi:function(e){if(e){a=e}},warning:function(e,t,n,r,a){m([{level:"warning",errno:e,url:n,message:t,logtype:1,traceid_end:r,traceid_svr:a}])},error:function(e,t,n,r,a){m([{level:"error",errno:e,url:n,message:t,logtype:1,traceid_end:r,traceid_svr:a}])}};var e=XMLHttpRequest.prototype;var f=e.send;e.send=function(){var r=this;var a=(new Date).getTime();var e=function(){try{if(r.readyState===4){var e=r.status;if(d(r.responseURL)){var t=r.getResponseHeader("Trace-Id");if(e>399){window._bm_.error(e,r.statusText,r.responseURL,i,t)}else{var n=(new Date).getTime();m(p(r.responseURL,e,n-a,i,t))}}}}catch(e){}};if(typeof r.onreadystatechange==="function"){var t=r.onreadystatechange;r.onreadystatechange=function(){e.apply(null,arguments);t.apply(this,arguments)}}else{r.onreadystatechange=e}f.apply(this,arguments)};function t(){if(!("fetch"in window)){return false}try{new Headers;new Request("");new Response;return true}catch(e){return false}}if(t()){var s=window.fetch;window.fetch=function(){var a=(new Date).getTime();return s.apply(this,arguments).then(function(e){try{var t=e.status;if(d(e.url)){var n=e.headers.get("Trace-Id");if(t>399){window._bm_.error(t,e.statusText,e.url,i,n)}else{var r=(new Date).getTime();m(p(e.url,t,r-a,i,n))}}}catch(e){}return e})}}var u=function(){function e(){return((1+Math.random())*65536|0).toString(16).substring(1)}return e()+e()+"-"+e()+"-"+e()+"-"+e()+"-"+e()+e()+e()};var l=function(e){var t=null;var n=null;var r=null;e.forEach(function(e){if(e.entryType==="paint"&&e.name==="first-paint"){n=Math.floor(e.startTime)}if(e.entryType==="paint"&&e.name==="first-contentful-paint"){r=Math.floor(e.startTime)}});if(n&&r){t={};t.firstPaint=n;t.firstContentfulPaint=r}return t};var d=function(e){var t=e!=="";t=t&&e.indexOf("cm.bilibili.com")===-1;t=t&&e.indexOf("data.bilibili.com")===-1;t=t&&e.indexOf("sentry.io")===-1;return t};var v=function(e){var t=[];e.forEach(function(e){if(e.initiatorType==="xmlhttprequest"&&d(e.name)){t.push({level:"info",logtype:1,url:e.name.replace(/\?.*/,"").replace(/detail\/\d*/,"detail"),cost:Math.floor(e.duration)})}});return t};var p=function(e,t,n,r,a){return[{level:"info",logtype:1,url:e.replace(/\?.*/,"").replace(/detail\/\d*/,"detail"),status:t,cost:n,traceid_end:r,traceid_svr:a}]};var m=function(e){var t=new Image;e.map(function(e){e.sub_product=r;return e});e.sub_product=r;t.src=a+"source="+n+"&log="+encodeURIComponent(JSON.stringify(e))};window.addEventListener("error",function(e){if(!(e instanceof ErrorEvent)){var t={level:"error",url:e.target.baseURI,srcUrl:e.target.src||e.target.href,traceid_end:u()};if(c){m([t])}else{o.push(t)}}},true);window.addEventListener("load",function(){try{if(performance&&performance.timing&&performance.timing.navigationStart){setTimeout(function(){var e=["navigationStart","redirectStart","redirectEnd","fetchStart","domainLookupStart","domainLookupEnd","connectStart","secureConnectionStart","connectEnd","requestStart","responseStart","responseEnd","domLoading","domInteractive","domContentLoadedEventStart","domContentLoadedEventEnd","domComplete","loadEventStart","loadEventEnd"];var r={level:"info",logtype:2,url:window.location.origin+window.location.pathname};e.forEach(function(e){var t=performance.timing.navigationStart;var n=performance.timing[e]-t;r[e]=n<0?0:n});var t=[];if(typeof performance.getEntries==="function"){var n=performance.getEntries();var a=l(n);if(a){r.firstPaint=a.firstPaint;r.firstContentfulPaint=a.firstContentfulPaint}t=v(n)}if(o.length>0){m(o)}c=true;m([r]);m(t)},1e3)}}catch(e){console.log(e)}})})();
