define(["jquery","base/view","util/helpers","util/worker"],function(a,b,c,d){"use strict";var e=b.extend({props:{defaultOptions:{blackTime:2,startCheckPercent:90,scale:.5},events:{timeupdate:"onTimeUpdate"}},public:{init:function(){return this.blackSeconds=0,this.$video=this.$el,this.createCanvas(),e.__super__.init.call(this)},destroy:function(){return this.worker&&(this.worker.off("message"),this.worker.destroy(),delete this.worker),e.__super__.destroy.call(this)}},protected:{createCanvas:function(){this.$canvas=a("<canvas></canvas>"),this.$canvas.css({width:"100%",height:"100%"}).appendTo(this.$video.parent()).hide()},onTimeUpdate:function(){var a=this.$video[0].currentTime;!this.currentTimeInt||a-this.currentTimeInt>=.5?(this.canCheck(a)&&this.checkBlack(),this.currentTimeInt=a):this.currentTimeInt>=0&&a<this.currentTimeInt&&(this.blackScreenDetected=!1,this.blackSeconds=0,this.currentTimeInt=0)},canCheck:function(a){return a/this.$video[0].duration*100>=this.options.startCheckPercent&&!this.blackScreenDetected},checkBlack:function(){var a,b,c,d=this.$canvas[0],e=d.getContext("2d");d.width=this.$video[0].videoWidth,d.height=this.$video[0].videoHeight,a=Math.ceil(d.width*this.options.scale),b=Math.ceil(d.height*this.options.scale),e.drawImage(this.$video[0],0,0,d.width,d.height,0,0,a,b),c=e.getImageData(0,0,a,b).data,this.worker=this.worker||this.createWorker(),this.worker.postMessage("check",{imageData:c,width:a,height:b})},onResult:function(a,b){var c=b.isBlack;c?(this.blackSeconds>=this.options.blackTime&&(this.options.onDetect(),this.blackScreenDetected=!0),this.blackSeconds++):this.blackSeconds=0},createWorker:function(){var a=new d({fn:function(){self.onmessage=function(a){function b(a,b,c){return a>p&&b>p&&c>p?2:a<o&&b<o&&c<o?0:1}var c,d,e,f,g=a.data.data.imageData,h=a.data.data.width,i=a.data.data.height,j=0,k=0,l=0,m=0,n=0,o=50,p=200,q=1,r=10,s=90,t=4,u=2*i;for(n;n<=i;n++)c=Math.floor(n*h/i),d=n*h*4,n<i&&(e=b(g[d],g[d+1],g[d+2]),0!==e&&j++,e=b(g[d+4*c],g[d+4*c+1],g[d+4*c+2]),0===e?l++:2===e?k++:m++),n>0&&(e=b(g[d-4],g[d-3],g[d-2]),0!==e&&j++,e=b(g[d-4*c-4],g[d-4*c-3],g[d-4*c-2]),0===e?l++:2===e?k++:m++);f=j/u*100<=q&&l/u*100>=s&&k/u*100<=r&&m/u*100<=t,self.postMessage({isBlack:f})}}});return a.on("message",this.onResult.bind(this)),a}}});return e});