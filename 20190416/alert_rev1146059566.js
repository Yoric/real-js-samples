define(["jquery","client-server","base/view","util/helpers","util/promise","util/hosts","app/comet","collections/notifications/alerts"],function(a,b,c,d,e,f,g,h){"use strict";var i=c.extend({singleton:!0,props:{elements:{alerts:".b-alert"},templates:{commonFriends:"head/tmpl/alerts/common-friends",playlist:"head/tmpl/alerts/playlist"},events:{"click .b-alert":"onAlertOpen",'click [data-action="complain"]':"onAlertComplain",'click [data-action="alert-accept"]':"onAlertAccept",'click [data-action="alert-refuse"]':"onAlertRefuse",'click [data-action="alert-close"]':"onAlertDelete"},deferred:{complaints:"product-tools/complaints","head-buttons":"head/buttons"},optionsSelector:'script[data-type="alert-options"]'},public:{init:function(){var b=a(a(".b-notif-alerts").size()?".b-notif-alerts":".b-head__alerts"),c=JSON.parse(this.$el.html()),e="navigation";return this.filters=[],this.setElement(b),this.parseOptions(),this.delegateEvents(),this.options=d.extend({},this.options,c),this.options.view.filters&&(this.filters=String(this.options.view.filters).split(",")),this.options.view.navigation?this.$el.addClass(e):this.$el.removeClass(e),this.onCometEventCallback=this.onCometEvent.bind(this),g.pushEvent.on(this.onCometEventCallback),this.collection=new h,this.$alerts.each(function(b,c){var d=a(c),e=this.collection.addToCollection(d);return this.proccessingAlert(d,e).then(function(){this.checkFilter(e)?d.show():d.hide()}.bind(this)),b}.bind(this)),this},deleteByCategory:function(a){return this.collection&&this.collection.getArrayByAttr("category",a).forEach(function(a){a.isRemovedFromDom||a.removeElement()}),this},addFilter:function(a){return this.filters&&this.filters.push(a),this},removeFilter:function(a){var b=this.filters.indexOf(a);return b!==-1&&this.filters.splice(b,1),this},hide:function(){return this.$el.hide(),this},show:function(){return this.$el.fadeIn(),this},destroy:function(){return this.unDelegateEvents(),this.collection.clear(),this.collection.destroy(),delete this.collection,g.pushEvent.off(this.onCometEventCallback),delete this.onCometEventCallback,delete this.filters,this}},protected:{checkFilter:function(a){var b=!0;return this.filters.map(function(c){a.get("type")!==c&&a.get("category")!==c||(b=!1)}),b},addAlert:function(a,b){var c=this.collection.addToCollection(a);return c&&this.checkFilter(c)&&(this.collection.getArrayByAttr("type",c.get("type")).forEach(function(a){a.isRemovedFromDom||a.get("id")===c.get("id")||a.removeElement()}),c.get("element").fadeOut().appendTo(this.$el).fadeIn(),b.isLong||c.setTimeout(),this.proccessingAlert(c.get("element"),c)),c},alertAction:function(b,c){return b.set("action",c),this.deleteElement(b),b.save().then(function(b){var c=b[3];c&&c.html&&this.addAlert(a(c.html),c)}.bind(this)),this},getModelByElement:function(a){var b,c;return b=a.is("div.b-alert")?a:a.parents(".b-alert"),c=b.data(),this.collection.getByAttr("alertId",[c.id,c.type].join("-"))},proccessingAlert:function(a,b){var c=["friendship","dialogues"];return new e(function(e){a.size()?c.indexOf(b.get("type"))!==-1?b.fetch().then(function(){var c,g,h=b.get("commonFriends"),i=b.get("playlist"),j=b.get("sender"),k=b.get("user"),l=1===Number(j.IsFemale),m=1===Number(k.IsFemale);if(h&&d.isArray(h.list)&&h.list.length)this.render("commonFriends",{commonFriends:h.list.map(function(a){return{avatarUrl:a.Avatar32URL+"?"+a.AvatarChangeTime,name:a.Name}}).slice(0,5)}).then(function(b){a.find(".b-alert__common-friends-wrapper__list").html(b),a.find(".b-alert__common-friends-wrapper").show(),a.removeClass("b-alert_hidden"),e()});else if(i){switch(i.covers.cover=i.covers.cover||window.location.protocol+f.getImagesHost()+"music/bg_playlist-default-cover.jpg",c=JSON.parse(a.find(".b-alert__playlist__texts").html()),i.type){case"sender_likes":i.name=i.name||c.playlist+" "+k.Name,g=l?c.senderFemaleLike:c.senderMaleLike;break;case"sender_subscribed":i.name=i.name||c.playlist+" "+k.Name,g=l?c.senderFemaleSubscribe:c.senderMaleSubscribe;break;case"user_likes":i.name=i.name||c.playlist+" "+j.Name,g=m?c.userFemaleLike:c.userMaleLike;break;case"user_subscribed":i.name=i.name||c.playlist+" "+j.Name,g=m?c.userFemaleSubscribe:c.userMaleSubscribe;break;case"both_subscribed":g=c.bothSubscribe}this.render("playlist",{playlist:i,text:g}).then(function(b){a.find(".b-alert__playlist-wrapper").html(b).show(),a.removeClass("b-alert_hidden"),e()})}else a.removeClass("b-alert_hidden"),e()}.bind(this)):(a.removeClass("b-alert_hidden"),e()):e()}.bind(this))},deleteElement:function(a){var b=a.get("element");b.fadeOut(function(){b.remove()})},onAlertOpen:function(b,c){var d=this.getModelByElement(b);this.options.isNewMenu?(a(document.body).trigger("open-head-layer",{from:"alert",type:d.get("category"),options:d.get(["id","type","category","userId","userEmail"])}),c.stopPropagation(),this.deleteElement(d)):this.require("head-buttons",function(a){var b=new a,e=b.openAlert(d);e&&(c.stopPropagation(),this.deleteElement(d))}.bind(this))},onAlertAccept:function(a,b){var c=this.getModelByElement(a);b.stopPropagation(),this.alertAction(c,"accept")},onAlertRefuse:function(a,b){var c=this.getModelByElement(a);b.stopPropagation(),this.alertAction(c,"refuse")},onAlertDelete:function(b,c){var d=this.getModelByElement(b),e=b.data("type")&&!b.hasClass("b-alert__close");c.stopPropagation(),e?this.onAlertOpen(b,c):(this.deleteElement(d),d.remove().then(function(b){var c=b[3];c&&c.html&&this.addAlert(a(c.html),c)}.bind(this)))},onAlertComplain:function(a,b){var c=this.getModelByElement(a),d=a.data();b.stopPropagation(),this.deleteElement(c),this.require(["complaints"],function(a){a.add({journalUser:d.complaintJuser,disturber:d.complaintDisturber,type:d.complaintType,objectid:d.complainObjectid}).then(function(){c.get("element").remove()}.bind()).fail(function(){c.get("element").fadeIn()})})},onCometEvent:function(b,c){var d,e;b&&!c&&(c=b),"notification-alert"===c.name&&"remove-alert"!==c.data.action?(e=a(c.data.html),e.addClass("b-alert_hidden"),this.addAlert(e,c.data)):"remove-alert"!==c.name&&"remove-alert"!==c.data.action||(d=this.collection.getByAttr("eid",c.data.user),d&&!d.isRemovedFromDom&&d.removeElement())}}});return i});