"use strict";StackExchange.imageUploader=function(){var e=window.URL||window.webkitURL,t={},n=function(){var e,t,n,i,a=window.document,o=window.self;o.innerHeight&&o.scrollMaxY?(e=a.body.scrollWidth,t=o.innerHeight+o.scrollMaxY):a.body.scrollHeight>a.body.offsetHeight?(e=a.body.scrollWidth,t=a.body.scrollHeight):(e=a.body.offsetWidth,t=a.body.offsetHeight),o.innerHeight?(n=o.innerWidth,i=o.innerHeight):a.documentElement&&a.documentElement.clientHeight?(n=a.documentElement.clientWidth,i=a.documentElement.clientHeight):a.body&&(n=a.body.clientWidth,i=a.body.clientHeight);var r=Math.max(e,n),s=Math.max(t,i);return[r,s,n,i]},i={"uploadUrl":"/upload/image?https=true","showLowRepWarning":!1},a=function(){$(".wmd-prompt-background").remove()},o=function(){var e=window.document,t=(window.navigator,e.createElement("div")),i=t.style;t.className="wmd-prompt-background",i.position="absolute",i.top="0",i.zIndex="1000",i.opacity="0.5";var a=n();return i.height=a[1]+"px",i.left="0",i.width="100%",e.body.appendChild(t),t};return{"createImageUploadBackground":o,"removeImageUploadBackground":a,"enableLowRepWarning":function(){i.showLowRepWarning=!0},"uploadImageDialog":function(n,a){"string"===$.type(a)&&(a={"uploadUrl":a}),a=$.extend(i,a);var o,r="upload-iframe-"+(new Date).getTime(),s="/render/image-upload?uploadUrl={0}&showLowRepWarning={2}".formatUnicorn(encodeURIComponent(a.uploadUrl),a.showLowRepWarning?"true":"false"),c=$('<div class="modal image-upload wmd-prompt-dialog auto-center" tabindex="-1"></div>').addClass("async-load").data("load-url",s),u=0,l=function(e){c&&c.fadeOutAndRemove(),$("body").off("keydown",v.checkEscape).off("paste",v.paste),void 0!==e&&n(e)},d=function(e){return 0===e.type.indexOf("image/")},f=function(e){var t;return e.items&&(t=$.grep(e.items,d),t.length>0)?t[0].getAsFile():e.files&&(t=$.grep(e.files,d),t.length>0)?t[0]:void 0},p=function(e,t){var n=c.find("."+e);n.find(".tab-page").hide(),n.find("."+e+"-"+t).show(),n.data("active-tab",t)},h=function(e){var t=c.find("."+e);return t.data("active-tab")},g=function(){window.closeDialog=l,window.displayUploadError=m.uploadError},m={"resetInputs":function(){c.find(".modal-input-file, .modal-input-url").prop("disabled",!1).attr("value","")},"uploadError":function(e){m.resetInputs(),c.find(".modal-options-error .modal-options-error-message").text(e),p("modal-options","error")},"ajaxResult":function(e){$("#"+r).contents().find("html").html(e)},"ajaxError":function(e,t,n){m.uploadError(function(e){return"Request returned an error: ["+e.status+"] "+e.error}({"status":t,"error":n}))}},v={"showLink":function(e){e&&e.preventDefault(),p("modal-options","url"),c.find(".modal-input-url").focus()},"resetView":function(e){e&&e.preventDefault(),p("modal-dropzone","default"),p("modal-options","default"),c.find(".modal-cta-submit").prop("disabled",!0),c.find(".modal-dropzone-preview").empty(),c.find(".modal-input-file").val(""),m.resetInputs(),u=0,o.removeClass("hover"),c.find("form").off("submit").on("submit",v.oldSchoolSubmit),c.find("form input[name=fkey]").val(StackExchange.options.user.fkey)},"inputFileOrUrl":function(){var e=!!c.find(".user-input").filter(function(){return this.value.length}).length;c.find(".modal-cta-submit").prop("disabled",!e)},"disablePasteHandling":function(){$("body").off("paste",v.previewImage)},"enablePasteHandling":function(){$("body").on("paste",{"property":"clipboardData"},v.previewImage)},"selectFile":function(e){e.preventDefault(),c.find(".modal-input-file").click()},"clickFile":function(e){e.stopPropagation()},"previewImage":function(t){t.preventDefault();var n,i,a,o=f(t.originalEvent[t.data.property]);o&&(n=o.size>=2097152,i=c.find(".modal-dropzone-preview"),i.empty(),a=e.createObjectURL(o),$("<img>").attr("src",a).css({"maxWidth":i.css("width"),"maxHeight":i.css("height")}).on("load",{"url":a},v.loadPreviewImage).appendTo(i),c.find("form").off("submit").on("submit",o,v.ajaxSubmit),c.find(".modal-cta-submit").prop("disabled",n),p("modal-dropzone","preview"),p("modal-options",n?"toobig":"preview"))},"dragEnter":function(e){e.preventDefault(),u++,o.addClass("hover")},"dragLeave":function(){0===--u&&o.removeClass("hover")},"clickClose":function(e){e.preventDefault(),l(null)},"loadPreviewImage":function(t){e.revokeObjectURL(t.data.url)},"oldSchoolSubmit":function(e){var t="url"===h("modal-options");p("modal-options","uploading"),c.find(".modal-input-file").prop("disabled",t),c.find(".modal-input-url").prop("disabled",!t),e.target.target=r,g()},"ajaxSubmit":function(e){e.preventDefault(),p("modal-options","uploading");var t=new window.FormData;t.append("file",e.data),t.append("fkey",StackExchange.options.user.fkey),g(),$.ajax({"url":a.uploadUrl,"data":t,"cache":!1,"contentType":!1,"processData":!1,"type":"POST","success":m.ajaxResult,"error":m.ajaxError})},"checkEscape":function(e){27===e.which&&(e.preventDefault(),l(null))}},b=function(){c.css("height","auto"),c.find(".modal-options-uploading p").addSpinner(),c.find(".modal-options-default a").click(v.showLink),c.find(".modal-options-cancel").click(v.resetView),c.find(".modal-input-file").on("click",v.clickFile).on("change",v.inputFileOrUrl);var e=c.find(".modal-input-url").on("input keydown",v.inputFileOrUrl);c.find(".modal-dropzone-default").click(v.selectFile),c.find(".modal-input-file").change({"property":"target"},v.previewImage),c.find(".modal-input-url").focus(v.disablePasteHandling).blur(v.enablePasteHandling),v.enablePasteHandling(),o=c.find(".modal-dropzone-default").on("dragenter",v.dragEnter).on("dragleave",v.dragLeave).on("dragover",!1).on("drop",{"property":"dataTransfer"},v.previewImage),c.find(".modal-close").click(v.clickClose),v.resetView(),c.focus(),a.imageUrl&&(v.showLink(),e.val(a.imageUrl),v.inputFileOrUrl())},y=function(){c.asyncLoad({"callback":function(){w(c),b()},"cache":t})},w=function(e){$('<iframe style="display: none;" src="about:blank" />').attr("id",r).attr("name",r).appendTo(e)};return c.appendTo("body").center().fadeIn("fast").promise().done(y),c.on("popupClose",v.disablePasteHandling),$("body").on("keydown",v.checkEscape),!0}}}();