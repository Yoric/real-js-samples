(function(){try{(function(){var n={L_ArrowTapAndHoldTooltip:"Did you know you could tap and hold to move faster?",L_CompassButton_Title:"Set initial heading",L_ExitButtonTooltip:"Close",L_OverviewMapSwitchOffTip:"Show location on map",L_OverviewMapSwitchOnTip:"Hide map",L_PhotosynthModeName:"Step inside",L_ReportAProblem_LinkText:"Report a privacy concern with this image",L_StreetsideModeName:"Streetside",L_StreetsideView:"Streetside View",L_StreetsideOverviewMapFovTooltip:"Want to view a different place? Just drag the map anywhere you wish to!",L_ZoomInButton_Title:"Zoom in",L_ZoomOutButton_Title:"Zoom out"};window.$MicrosoftMaps8.ResourceManager?window.$MicrosoftMaps8.ResourceManager.init("Streetside",n):window.$MicrosoftMaps8.ResourcesObject=n})();var bt=window.Microsoft=window.Microsoft||{},r=bt.Maps=bt.Maps||{},u=r.Internal,b=u._Binding,e=u._Debug,pr=u._Url,kt=r.DataHandlerKeys,hi=r.BasicMapAnimation,wr=u._Dispatcher,ci=u._EntityHelper,v=u._Gimme,h=r.GlobalConfig,dt=r.GlobalDataEventHandler,t=u._Helper,li=r.ImageryMapLayer,k=u._JSEvent,d=u._LocalStorageCache,p=r.LocationRect,g=u._LoggerConstants,ai=u._LruCache,f=u._StreetsideLoggerConstants,et=u.MapFrameManager,w=u.MapHelper,o=r.Location,ot=r.MapMath,st=r.MapTypeId,ht=r.MapView,nt=u._Network,ct=u._Observable,br=u._ObservableCollection,tt=u._ObservableObject,kr=u._ObservableObjectChangedArgs,dr=u._OverlayManager,gt=u._Overlay,s=r.Point,gr=r.SearchResultsPoiTemplateSelector,vi=r.XsrPoiTemplateSelector,yi=r.RasterImageryScene,pi=r.Rectangle,y=r.ResourceManager.Streetside,wi=r.LabelVisibility,it=r.Size,i=h.features.streetside,f=u._StreetsideLoggerConstants,ni=u._StreetsidePerfConstants,nu=r.TaskBar,tu=h.features.taskFramework,ti=u.TileSystemHelper,n=u._VectorMath,bi=r.VectorMapLayer,ki=u.ViewChangeArgs,lt=r.ZoomLevel,c=r.OverviewMapMode;(function(){function kt(n,t,i,r){this.m00=n||0;this.m01=t||0;this.m10=i||0;this.m11=r||0}function i(n,t,i,r,u,f,e,o,s,h,c,l,a,v,y,p){this.m11=n;this.m12=t;this.m13=i;this.m14=r;this.m21=u;this.m22=f;this.m23=e;this.m24=o;this.m31=s;this.m32=h;this.m33=c;this.m34=l;this.m41=a;this.m42=v;this.m43=y;this.m44=p}function yt(n,t,i,r,u){this.a=n;this.b=t;this.c=i;this.d=r;this.normal=new o(this.a,this.b,this.c);this.point=u}function a(n,t,i,r){this.w=n;this.x=t;this.y=i;this.z=r}function uu(n,t){this.origin=n;this.direction=t}function tu(n,t,i,r){this.x=n;this.y=t;this.width=i;this.height=r}function h(n,t){this.x=n||0;this.y=t||0}function o(n,t,i){this.x=n;this.y=t;this.z=i}function e(n,t,i,r){this.x=n;this.y=t;this.z=i;this.w=r}function c(n,t){function i(){}i.prototype=t.prototype;n.prototype=new i;n.prototype.constructor=n;n.baseConstructor=t;n.superClass=t.prototype;n.__super=t}function lt(){function t(){return!n||n.length===0}var n=[];this.fire=function(i){if(!t())for(var r=0,u=n.length;r<u;r++)n[r](i)};this.addEventListener=function(t){n=n||[];for(var i=0,r=n.length;i<r;i++)if(n[i]===t)return;n.push(t)};this.removeEventListener=function(i){if(!t())for(var r=0,u=n.length;r<u;r++)n[r]===i&&n.splice(r,1)}}function ft(){this.map={};this._innerArray=[]}function yi(n,t){this.screenArray=n;this.textureArray=t}function ut(n,t,i,r,u,f,e){ut.__super.call(this);this._url=n;this._loadCallback=t;this._loadCallbackInfo=i;this._image=null;this._wrapS=r!==undefined?r:ut.Wrap.CLAMP_TO_EDGE;this._wrapT=u!==undefined?u:ut.Wrap.CLAMP_TO_EDGE;this._minFilter=f!==undefined?f:ut.Filter.LINEAR_MIPMAP_LINEAR;this._magFilter=e!==undefined?e:ut.Filter.LINEAR;this._isReady=!1;this._isDirty=!1}function dt(){dt.__super.call(this);dt._animation=null;dt._animationEndStates=null}function gi(n){this._texture=n;gi.__super.call(this)}function nr(){this._rotX=this._rotY=this._rotZ=0;this._translateX=this._translateY=this._translateZ=0;this._scaleX=this._scaleY=this._scaleZ=0;nr.__super.call(this)}function yr(n){this._geometry=n.geometry||null;this._material=n.material||null;this._transform=n.transform||null}function y(n,t,r){y.__super.constructor.call(this);this._name="BaseRenderer";this._renderables={};this._viewModel=null;this._removedRenderables={};this._layers={};this._window=n;this._rootElement=null;this._viewProjMatrix=i.createIdentity();this._width=t;this._height=r;this._initBackground();this.SortRenderableFucntion=function(n,t){var i=n.id.levelOfDetail,r=t.id.levelOfDetail;return i&&r?i-r:i||r?i?1:-1:0}}function p(){}function cr(n,t,r,u,f,e){var h,s,o,l,c;cr.__super.call(this,{});h=this;s=document.createElement("canvas");s.width=n;s.height=t;o=s.getContext("2d");o.clearRect(0,0,n,t);o.fillStyle=u||"gray";o.fillRect(0,0,n,t);o.fillStyle="black";o.font="12pt Segoe UI,sans-serif";o.fillText(f,n*.3,t*.3);l=s.toDataURL();c=new ut(l,null,null,null,null,null,null);e&&c.loadImageInDOM();h._material=new gi(c);h._transform=r?r:i.createIdentity()}function l(n){l.__super.call(this,n);if(!ht.isValidBrowser())throw"css3d is not supported";this._viewportToScreenTransform=f.createViewportToScreen(this._width,this._height)}function d(n){if(!ct.isValidBrowser())throw"WebGL not supported in this browser.";d.__super.call(this,n);this._contextCache=new Array(this.MAX_CONTEXTS)}function vr(n,t,i){var u,f;return(u=n.createShader(t),n.shaderSource(u,i),n.compileShader(u),!n.getShaderParameter(u,n.COMPILE_STATUS))?(f=n.getShaderInfoLog(u),r.log("Shader compiling error: "+f),n.deleteShader(u),null):u}function it(n,t,i){it.__super.call(this,n,t,i);this._expansionInPixels=it.STD_PIXEL_EXPANSION}function ci(){}function b(){}function v(){}function ar(n){c(this,n);var t={};this.Tesselate=function(i,r,u){var s=i.viewElementId.id,e=t[s],o,f;return e||(e={},t[s]=e),f=e[r],f===undefined&&(f=n.prototype.Tesselate.apply(this,[i,r,u]),o=f.density,o>0&&(e[o]=f)),f};this.GetRawDensity=function(t,i){return n.prototype.GetRawDensity.call(this,t,i)}}function g(){function t(){var t,i;if(tt.debugEnabled){t="TRegistry state: ";for(i in n)t+=i+", ";r.log(t+".")}}var n={};this.register=function(i){var u=i.id;return n[u]?(r.log(u+" cannot be registered because it's already registered for a different transition."),!1):(n[u]=i,t(),!0)};this.unregister=function(i){var u=i.id;n[u]||r.log(u+" cannot be unregistered because it's already registered for a different transition.");delete n[u];t()};this.getTransitionItem=function(t){return n[t]}}function wt(n){this.cullWorldAtLod=function(t,r,u,f){var p=n.getViewProjectionTransform(),a=t.getViewElements(r,u),v,s=i.createIdentity(),o={},y=0,h,l;f&&(o._notVisibleArray=[],y=3);for(h in a){var e=a[h],c=e.viewElementId,w=e.textureSource(c.x,c.y,c.levelOfDetail);if(e.priority=y,e.url=w,v!=e.faceTransform&&(s=p.multiply(e.faceTransform),v=e.faceTransform),l=this.genericCullPolygon(e.geometryPolygon,e.texturePolygon,s),!l){f&&o._notVisibleArray.push(e);continue}e.computedGeometry=l;e.mvpMatrix=s;o[h]=e}return o};this.genericCullPolygon=function(n,t,i){var r,e,o=f.applyWorldTransformation(n,i),u=et.clip(wt.lowerVisibleBoundary,wt.higherVisibleBoundary,o,t);return r=u.polygon,e=u.polygonTexture,e.length=r.length,r.length>2?u:undefined}}function wr(t,i,r){function c(n,r,f,e,o){var y=r||!o||o<0,c,l,a,s,v;if(!y)return!1;c=!1;l=f.map;for(a in l)if((s=l[a],s&&s.viewElementId.levelOfDetail==e)&&!h.isBorderTile(n,s)&&t.getState(s.url)==nt.ready){v=n.getElementRawTesselationDensity(s,i);u[n.getDataSourceName()].tesselationMap[e]=v;c=!0;break}return c}function o(t){var u=t.getMinimumLod(),h=t.getMaximumLod(),e=i.getViewport(),c=e.getHeight(),l=e.getWidth(),o=i.getVerticalFov(),a=c,v,r,s;return l>c&&(o=vt.convertVerticalToHorizontalFieldOfView(e.getAspectRatio(),o),a=l),v=f.calculateTexelToPixelRatioAtFov(f._cubeSide,t.getWorldConfiguration().source.tileSize,a,o),r=u+Math.round(n.logBase(1/v,2)),r>h?r=h:r<u&&(r=u),tt.debugEnabled&&(s=document.getElementById("LODV"),s&&(s.innerHTML="LOD: "+r)),r}function s(n,i,r,u){var f=n.getParent(),o;return f&&!t.AllCompleted.get(f.id,!0)&&f.levelOfDetail>i&&(o=r.getViewElementById(f,u),e(o)||t.downloadImage(o.textureSource(f.x,f.y,f.levelOfDetail),0,f.id),f=s(n.getParent(),i,r,u)),f}function e(n){var i=t.getState(n.url);return i==nt.failed||i==nt.timedout}var u={},h=this;window.instrumentPerf&&window.instrumentPerf.ttl&&(o=function(n){return n.getMinimumLod()});this.initDataSource=function(n){u[n.getDataSourceName()]={currentLod:{value:n.getMinimumLod()},tesselationMap:{},lastLod:-1,minLodHoldTime:0}};this.dropDataSource=function(n){delete u[n]};this.UpdateLodAndTesselation=function(n,t,i,r){var a=n.getDataSourceName(),f=u[a],e=f.currentLod.value,v=n.getMinimumLod(),p=e==f.lastLod,s=!p||i,h,l,y;return s&&(h=!1,l=e===v&&!r,f.minLodHoldTime!==0&&(h=Date.now()-f.minLodHoldTime>1500,h&&(l=!1,f.minLodHoldTime=0)),l?(f.currentLod.value=e=v,f.minLodHoldTime===0&&(f.minLodHoldTime=Date.now())):(f.lastLod=e,f.currentLod.value=e=o(n))),y=c(n,s,t,e,this.GetCurrentTesselationDensity(e,a)),s&y};this.getCurrentLod=function(n){var t=u[n].currentLod;return!t,t};this.isAtMinLod=function(n){return this.getCurrentLod(n.dataSourceName).value===n.getMinimumLod()};this.getMinLodHoldTime=function(n){return u[n].minLodHoldTime};this.GetCurrentTesselationDensity=function(n,t){var i=u[t].tesselationMap[n];return i?i:-1};this.EnrichWithParentIViewElements=function(n,u,f){var p=n.getMinimumLod(),k=i.getViewProjectionTransform(),c,h,a,v,y,b;for(c in u){var o=u[c],l=t.AllCompleted.get(c,!0),w=l?l.style.opacity:0;if((!l||w===undefined||w<1||l.animationInProgress)&&o.viewElementId.levelOfDetail>p)if(h=s(o.viewElementId,p,n,f),a=h.id,e(o)&&delete u[c],u[a]===undefined){if(o=n.getViewElementById(h),e(o))continue;if(v=k.multiply(o.faceTransform),o.mvpMatrix=v,y=r.genericCullPolygon(o.geometryPolygon,o.texturePolygon,v),y)o.computedGeometry=y,b=o.textureSource(h.x,h.y,h.levelOfDetail),o.priority=0,o.url=b,u[a]=o;else{u[a]=!1;continue}}else continue}};this.isBorderTile=function(n,t){return t.viewElementWidth!=n.worldConfiguration.source.tileSize||t.viewElementHeight!=n.worldConfiguration.source.tileSize}}function cu(i,e,o,s){function st(n,t,i){n.animation=t!=null?ct(t,i):ht()}function ht(){var n=i.getType()==="3D"?u.TYPE.ImmediateFadeIn:u.TYPE.FadeIn;return ct(n)}function ct(n,t){return y&&n!=u.TYPE.ImmediateFadeIn?u.createCSSAnimation(n,t):u.createAnimation(n,t)}function yt(n){if(window.elapsed===undefined&&!s.currentlyDownloading()&&n){window.elapsed=Date.now()-window.instrumentPerf.startTime;document.getElementById("timerSpan").innerText=window.elapsed+" ms.";var t=document.createElement("img");t.src=PingRequest.end}}function pt(){w=o.getViewport();d=w.getWidth();nt=w.getHeight();var t=o.getVerticalFov(),r=Math.abs(rt-t);p|=!n.isZero(r);p&&(rt=t);i.setViewProjectionMatrix(o.getViewProjectionTransform())}function bt(n,t,r,u){var tt,w,e,o,g,f,b,it,l,a,rt,ut,v,k,h,p;if(w=i.getType()=="2D",tt=w,e=n.dataSourceName,o=c.getCurrentLod(e).value,y&&o>n.getMinimumLod()&&(o-=t),g=u&&c.getMinLodHoldTime(e)===0,f=ot.cullWorldAtLod(n,o,y,g),g){for(b=0,it=f._notVisibleArray.length;b<it;++b)l=f._notVisibleArray[b],l!=null&&s.downloadImage(l.url,l.priority,l.viewElementId.id);delete f._notVisibleArray}else r&&c.EnrichWithParentIViewElements(n,f,y);a=[];for(rt in f)a.push(f[rt]);if(ut=a.length,w)for(v={},v[o]=c.GetCurrentTesselationDensity(o,e),k=0;k<ut;k++)h=a[k],p=h.viewElementId.levelOfDetail,v[p]===undefined&&(v[p]=c.GetCurrentTesselationDensity(p,e)),h.computedGeometry=n.covertToScreenSpace(h.computedGeometry.polygon,h.computedGeometry.polygonTexture,d,nt),tt&&kt(n,h,v[p],w);return dt(a,e)}function kt(n,t,i,r){var e=t.computedGeometry,l,u,y,a,p,w;if(i===0)e.intileTesselated=[e],e.density=0;else{var b=c.isBorderTile(n,t)?-1:i,v=n.tesselate(t,b,o),s=v.squares,h=v.texelSquares;for(s.length!=h.length,e.intileTesselated=new Array(s.length),l=0,u=0,y=s.length;u<y;u++)a=f.applyWorldTransformation(s[u],t.mvpMatrix),p=et.clip(wt.lowerVisibleBoundary,wt.higherVisibleBoundary,a,h[u]),p.polygon.length>2&&(r?(w=n.covertToScreenSpace(a,h[u],d,nt),e.intileTesselated[l]=w):e.intileTesselated[l]=new yi(a,h[u]),l++)}}function dt(n,t){for(var i,e,o,s=[],c=[],l=[],r=h.getVisibleElements(t).map||{},a={},u,v=n.length,f=0;f<v;f++)(i=n[f],u=i.viewElementId,u)&&(e=u.id,r[e]?c.push(i):s.push(i),a[e]=i);for(o in r)a[o]||l.push(r[o]);return{added:s,updated:c,removed:l}}function gt(n){for(var r=n.getDataSourceName(),s=h.getDelta(r).added,i=h.getRenderables(r),l=i.map,a=c.getCurrentLod(r),u,v=n.getInteractionController(),f=0,p=s.length;f<p;++f){var t=s[f],e=t.viewElementId,o={texture:new ut(t.url,null,null,null,null,null,null),polygon:t.texturePolygon.slice()};o.texture.dataSourceWidth=t.viewElementWidth;o.texture.dataSourceHeight=t.viewElementHeight;u=new li(t.geometryPolygon,[o],e,a);lt(t,u);l[e.id];i.add(e.id,u)}n.isCursorAndLabelEnabled&&(n.isRoadVectorReady&&n.generateLabelRenderables(i,y),n.prepareCursorTextureIfNecessary(i),n.generateCursorRenderableIfNecessary(i),n.updateCursorRenderableTranslation(i,v.getHitTestResultTranslation(),y))}function lt(n,t){switch(i.getType()){case"2D":t.geometryPolygon=n.computedGeometry;break;case"3D":t.transform=n.faceTransform}tt.debugEnabled&&(t.isClipped=n.isClipped)}function ni(n){var t,i=h.getDelta(n),u,f,r;if(i.removed&&i.removed.length>0)for(u=i.removed.length,t=0;t<u;++t)s.cancel(i.removed[t].viewElementId.id);if(i.added&&i.added.length>0)for(f=i.added.length,t=0;t<f;++t)r=i.added[t],s.downloadImage(r.url,r.priority,r.viewElementId.id)}function ti(n){for(var r,t,u,f=h.getRenderables(n).getArray(),e=!0,i=0,o=f.length;i<o;i++)if(r=f[i],t=r.texturesWithPolygons[0].texture,!t._image){if(u=s.AllCompleted.get(r.id.id,!0),!u){e=!1;continue}t._image=u;t._isReady=!0;t._isDirty=!0}return e}var h=new hu,rt=-1,p=!1,ot=new wt(o),a=new ft,c=new wr(s,o,ot),w=o.getViewport(),d=w.getWidth(),nt=w.getHeight(),k=new g,at=48e4,vt=1049088,it=0,y=i instanceof l;for(this.doPerfPingCall=function(){},window.instrumentPerf&&(this.doPerfPingCall=yt),i.setViewModel(h),this.RenderFrame=function(n){var o,f,e,v,b,l,d;for(pt(),o=a.getArray(),f=!1,e=0,v=o.length;e<v;e++){var u=o[e],t=u.getDataSourceName(),y=c.isAtMinLod(u),r=k.getTransitionItem(t),w=r&&r.animation,nt=!r;if((nt||r.transitionType!=g.TRANSITION_TYPE.OUT)&&(b=bt(u,n,!0,y),h.setDelta(t,b),ni(t),gt(u)),h.syncAddedFromDeltaCurrentVisibleElements(t),h.syncUpdatedFromDeltaCurrentVisibleElements(t,lt),s.update(),l=ti(t),i.syncRemovedRenderables(t),h.syncRemovedFromDeltaCurrentVisibleElements(t),!y||l?f|=i.render(t,w,n,ht):f=!0,d=c.UpdateLodAndTesselation(u,h.getVisibleElements(t),p,l),d&&(p=!1),r&&w.isComplete(u))switch(r.transitionType){case g.TRANSITION_TYPE.OUT:a.remove(t);h.removeModel(t);c.dropDataSource(t);i.disposeLayer(t);case g.TRANSITION_TYPE.IN:k.unregister(r);r.notifyCallback(u)}}return this.doPerfPingCall(f),!f},this.setViewChanged=function(n){p=n;var t=o.getViewport(),r=t.getWidth(),u=t.getHeight(),i=r*u;i<at?(b.setScreenQuadSize(32),v.setScreenQuadSize(32)):i<vt?(b.setScreenQuadSize(64),v.setScreenQuadSize(64)):(b.setScreenQuadSize(128),v.setScreenQuadSize(128))},this.registerDataSourceForAdd=function(n,t,u,f){var e=n.getDataSourceName(),o,s;return a.map[e]?(r.log(e+" is already in ViewController's ds list."),!1):(o=new g.DataSourceRegistryItem(n,f,g.TRANSITION_TYPE.IN),s=k.register(o),!s)?!1:(st(o,t,u),a.add(e,n),c.initDataSource(n),i.initLayer(e,n.getZOrder()),!0)},this.registerDataSourceForRemoval=function(n,t,u,f){if(!a.map[n])return r.log(n+" not found in ViewController's ds list."),!1;var e=new g.DataSourceRegistryItem(a.map[n],f,g.TRANSITION_TYPE.OUT),o=k.register(e);return o?(st(e,t,u),i.finalizeLayer(n),!0):!1},this.dispose=function(){for(var u,r=a.getArray(),f=t._renderGLEnabled(),n=0,e=r.length;n<e;n++)u=r[n].getDataSourceName(),i.disposeLayer(u,f);h.dispose();a.dispose()};it<e.length;)this.registerDataSourceForAdd(e[it],u.TYPE.FadeIn),it++;this.setViewChanged(!0)}function li(n,t,i,r){this.geometryPolygon=n.slice();this.texturesWithPolygons=t.slice();this.id=i;this.worldLod=r}function hu(){function t(t){return n[t]?!0:(n[t]=new i,!1)}function i(){this.delta={added:[],removed:[],updated:[]};this.currentRenderables=new ft;this.currentVisibleElements=new ft;this.dispose=function(){this.delta.added.length=0;this.delta.added.length=0;this.delta.updated.length=0;this.delta=null;this.currentRenderables.dispose();this.currentVisibleElements.dispose()}}var n={};this.getVisibleElements=function(i){return t(i),n[i].currentVisibleElements};this.getRenderables=function(i){return!t(i),n[i].currentRenderables};this.getDelta=function(i){return!t(i),n[i].delta};this.setDelta=function(i,r){t(i);n[i].delta=r};this.syncAddedFromDeltaCurrentVisibleElements=function(i){var r,e;!t(i);var o=n[i].delta,u=o.added,s=n[i].currentVisibleElements,f;for(r=0,e=u.length;r<e;r++)f=u[r],s.add(f.viewElementId.id,f);u.length=0};this.syncUpdatedFromDeltaCurrentVisibleElements=function(i,r){var u,l,o,s,h;!t(i);var f=n[i],a=f.delta,e=a.updated,v=f.currentVisibleElements.map,y=f.currentRenderables.map,c;for(u=0,l=e.length;u<l;u++)c=e[u],o=c.viewElementId.id,s=v[o],!s,h=y[o],h&&r(s,h);e.length=0};this.syncRemovedFromDeltaCurrentVisibleElements=function(i){var r,o;!t(i);var u=n[i],s=u.delta,f=s.removed,h=u.currentVisibleElements,c=u.currentRenderables,e;for(r=0,o=f.length;r<o;r++)e=f[r].viewElementId.id,h.remove(e),c.remove(e);f.length=0};this.removeModel=function(i){!t(i);delete n[i]};this.dispose=function(){for(var t in n)n.hasOwnProperty(t)&&n[t].dispose()}}function u(n){this._durationMs=n||u.DefaultDurationMs}function gt(n){gt.__super.call(this,n)}function ai(n){ai.__super.call(this,n)}function ui(n){ui.__super.call(this,n)}function fi(n){fi.__super.call(this,n)}function ei(n){ei.__super.call(this,n)}function st(n){st.__super.call(this,n)}function ir(n){ir.__super.call(this,n)}function vt(n,t,i,r){this._width=n;this._height=t;this._aspectRatio=this._width/this._height;this._nearDistance=i;this._farDistance=r}function su(n,t,i,r,u,f){this.width=n?n.getWidth():0;this.height=n?n.getHeight():0;this.up=o.clone(r);this.look=o.clone(u);this.fieldOfView=f;var e=function(n,t,i){var r=n.dot(t),u;return r>1?r=1:r<-1&&(r=-1),u=Math.acos(r),u<i};this.isFuzzyEqualTo=function(n,t){if(this.width!==n.width||this.height!==n.height)return!1;var i=t*this.fieldOfView/this.height;return Math.abs(this.fieldOfView-n.fieldOfView)>i?!1:e(this.up,n.up,i)?e(this.look,n.look,i)?!0:!1:!1}}function au(t,r){function y(){var n=Math.tan(.5*c);w=n===0?1:1/n;f.createLookAtRHOut(l,v,a,b);f.createPerspectiveOGLOut(c,s.getAspectRatio(),s.getNearDistance(),s.getFarDistance(),k);k.multiplyOut(b,d);u=!1}function nt(n){g=n;l=n.position;a=n.up;v=n.look;c=n.verticalFov}var tt=r||{verticalFov:n.degreesToRadians(80),position:new o(-1,-1,1),look:new o(0,0,-1),up:new o(0,1,0),side:new o(1,0,0)},g=null,s=t,p=new h(0,0),l=null,a=null,v=null,c=null,w=-1,b=i.createIdentity(),k=i.createIdentity(),d=i.createIdentity(),u=!0;nt(tt);this.setCameraParameters=nt;this.getCameraParameters=function(){return g};this.getPose=function(){return new su(s,p,l,a,v,c)};this.setViewport=function(n){s=n;u=!0};this.getViewport=function(){return s};this.setPosition=function(n){l=n;u=!0};this.getPosition=function(){return l};this.setVerticalFov=function(n){c=n;u=!0};this.getVerticalFov=function(){return c};this.getFocalLength=function(){return u&&y(),w};this.setLook=function(n){v=n;u=!0};this.getLook=function(){return v};this.setUp=function(n){a=n;u=!0};this.getUp=function(){return a};this.setDigitalPan=function(n){p=n;u=!0};this.getDigitalPan=function(){return p};this.getViewTransform=function(){return u&&y(),b};this.getProjectionTransform=function(){return u&&y(),k};this.getViewProjectionTransform=function(){return u&&y(),d};this.projectTo2D=function(n){u&&y();var r=s.getWidth()*.5,f=s.getHeight()*.5,t=d.transformVector4(e.createFromVector3(n));return t.x/=t.w,t.y/=t.w,t.z=t.w=1,new i(r,0,r,0,0,-f,f,0,0,0,1,0,0,0,0,1).transformVector4(t)}}function ri(n,t,i){this._startTime=-1;this._initialValue=-1;this._timeInMillis=-1;this._springConstant=n;this._damperConstant=t;this._allowOvershoot=i;this._current=0;this._target=0;this._velocity=0;this._t=-1;this._isSettled=!1}function hr(n,t,i){this._internalSpring=new ri(n,t,i);this._internalSpringCurrentValue=0;this._internalSpringTargetValue=1;this._current=[];this._initial=[];this._target=[]}function iu(n,t){function b(n){n.type="gestureStart";ut(n)}function a(n){n.type="gestureChange";ft(n)}function k(n){n.type="gestureEnd";d(n);u.focus()}function ct(n){n.type="mouseClicked";d(n)}function v(n){n.type="discreteZoom";et(n)}function g(n){n.type="keyDown";tt(n);ot(n)}function nt(n){n.type="keyUp";tt(n);st(n)}function tt(n){[37,38,39,40,61,107,109,173,187,189].indexOf(n.keyCode)>=0&&n.preventDefault()}function o(n){b({clientX:n.offsetX||n.layerX,clientY:n.offsetY||n.layerY,hasCursor:!0});e={x:n.clientX,y:n.clientY};n.preventDefault()}function s(n){var t=n.currentTarget===document;e!=null?(a({clientX:n.offsetX||n.layerX,clientY:n.offsetY||n.layerY,translationX:n.clientX-e.x,translationY:n.clientY-e.y,scale:1,hasCursor:!0,isOffTarget:t}),n.preventDefault()):(a({clientX:n.offsetX||n.layerX,clientY:n.offsetY||n.layerY,translationX:n.clientX,translationY:n.clientY,scale:1,hasCursor:!0,isOffTarget:t}),n.preventDefault())}function h(n){if(e!=null){var t=n.clientX-e.x,i=n.clientY-e.y;k({clientX:n.offsetX||n.layerX,clientY:n.offsetY||n.layerY,translationX:t,translationY:i,scale:1,hasCursor:!0});t==0&&i==0&&ct({clientX:n.offsetX||n.layerX,clientY:n.offsetY||n.layerY,translationX:0,translationY:0,scale:0});e=null;n.preventDefault()}}function f(n){var t=0;n.wheelDelta?t=n.wheelDelta/-120:n.deltaY&&(t=n.deltaY/3);v({clientX:n.offsetX||n.layerX,clientY:n.offsetY||n.layerY,direction:t>=0?1:-1,wheelDelta:t,mouseInteractionType:"mousewheel",hasCursor:!0});n.preventDefault()}function c(n){v({clientX:n.offsetX||n.layerX,clientY:n.offsetY||n.layerY,direction:1,hasCursor:!0});n.preventDefault()}var i=n,ut=t.gestureStart||function(){},ft=t.gestureChange||function(){},d=t.gestureEnd||function(){},et=t.discreteZoom||function(){},ot=t.keyDown||function(){},st=t.keyUp||function(){},w=!1,ht,r,e=null,y,p,l,u,it,rt;(window.navigator.msPointerEnabled||window.PointerEvent)&&window.MSGesture!==undefined?(l=window.navigator.msPointerEnabled,y=function(){r=new dr(i,b,a,k,v);window.PointerEvent?(i.addEventListener("pointerdown",r.msPointerDown,!1),i.addEventListener("pointerup",r.msPointerUp,!1)):l&&(i.addEventListener("MSPointerDown",r.msPointerDown,!1),i.addEventListener("MSPointerUp",r.msPointerUp,!1));l===!1&&(i.addEventListener("mousedown",o,!1),i.addEventListener("mousemove",s,!1),i.addEventListener("mouseup",h,!1));i.addEventListener("MSGestureTap",r.msGestureTap,!1);i.addEventListener("MSGestureStart",r.msGestureStart,!0);i.addEventListener("MSGestureChange",r.msGestureChange,!0);i.addEventListener("MSGestureEnd",r.msGestureEnd,!0);i.addEventListener("dblclick",c,!1);i.addEventListener("mousewheel",f,!1);i.addEventListener("pointermove",r.msPointerMove,!1)},p=function(){r&&(window.PointerEvent?(i.removeEventListener("pointerdown",r.msPointerDown,!1),i.removeEventListener("pointerup",r.msPointerUp,!1)):l&&(i.removeEventListener("MSPointerDown",r.msPointerDown,!1),i.removeEventListener("MSPointerUp",r.msPointerUp,!1)),l===!1&&(i.removeEventListener("mousedown",o,!1),i.removeEventListener("mousemove",s,!1),i.removeEventListener("mouseup",h,!1)),i.removeEventListener("MSGestureTap",r.msGestureTap,!1),i.removeEventListener("MSGestureStart",r.msGestureStart,!0),i.removeEventListener("MSGestureChange",r.msGestureChange,!0),i.removeEventListener("MSGestureEnd",r.msGestureEnd,!0),i.removeEventListener("pointermove",r.msPointerMove,!1));i.removeEventListener("dblclick",c,!1);i.removeEventListener("mousewheel",f,!1);ht=null}):window.ontouchstart!==undefined?(y=function(){r=new nu(b,a,k,v);i.addEventListener("touchstart",r.handleTouchStart,!1);i.addEventListener("touchend",r.handleTouchEnd,!1);i.addEventListener("touchcancel",r.handleTouchEnd,!1);i.addEventListener("touchleave",r.handleTouchEnd,!1);i.addEventListener("touchmove",r.handleTouchMove,!1);i.addEventListener("mousedown",o,!1);i.addEventListener("mousemove",s,!1);i.addEventListener("mouseup",h,!1);i.addEventListener("dblclick",c,!1);i.addEventListener("mousewheel",f,!1);i.addEventListener("wheel",f,!1)},p=function(){i.removeEventListener("touchstart",r.handleTouchStart,!1);i.removeEventListener("touchend",r.handleTouchEnd,!1);i.removeEventListener("touchcancel",r.handleTouchEnd,!1);i.removeEventListener("touchleave",r.handleTouchEnd,!1);i.removeEventListener("touchmove",r.handleTouchMove,!1);i.removeEventListener("mousedown",o,!1);i.removeEventListener("mousemove",s,!1);i.removeEventListener("mouseup",h,!1);i.removeEventListener("dblclick",c,!1);i.removeEventListener("mousewheel",f,!1);i.removeEventListener("wheel",f,!1)}):(y=function(){i.addEventListener("mousedown",o,!1);i.addEventListener("mousemove",s,!1);i.addEventListener("mouseup",h,!1);i.addEventListener("mousewheel",f,!1);i.addEventListener("wheel",f,!1);i.addEventListener("dblclick",c,!1)},p=function(){i.removeEventListener("mousedown",o,!1);i.removeEventListener("mousemove",s,!1);i.removeEventListener("mouseup",h,!1);i.removeEventListener("mousewheel",f,!1);i.removeEventListener("wheel",f,!1);i.removeEventListener("dblclick",c,!1)});u=document.createElement("div");u.id="focusElement";it=function(){i.appendChild(u);u.addEventListener("keydown",g,!1);u.addEventListener("keyup",nt,!1);u.focus()};rt=function(){u.removeEventListener("keydown",g,!1);u.removeEventListener("keyup",nt,!1);u.parentNode&&u.parentNode.removeChild(u)};this.enable=function(){y();it();w=!0};this.disable=function(){p();rt();w=!1;r=null};this.isEnabled=function(){return w};this.userCurrentlyInteracting=function(){return r?r.userCurrentlyInteracting():!1}}function gr(n,t){function i(n){t(n);n.handled||u.push(n)}var u=[],r=new iu(n,{gestureStart:i,gestureChange:i,gestureEnd:i,discreteZoom:i,keyDown:i,keyUp:i});this.enable=function(){r.enable()};this.disable=function(){r.disable()};this.isEnabled=function(){return r.isEnabled()};this.getQueuedEvents=function(){var n=u;return u=[],n};this.userCurrentlyInteracting=function(){return r.userCurrentlyInteracting()}}function dr(n,t,i,r,u){var e=n,v=t,y=i,l=r,w=u,o,h,c,s=!1,f=0,p=getComputedStyle(e.parentNode).direction=="rtl",a=new MSGesture,b=this;this.msGestureTap=function(n){v({clientX:n.offsetX,clientY:n.offsetY,hasCursor:n.pointerType&&n.pointerType==="mouse",isTouch:n.pointerType&&n.pointerType==="touch"});l({clientX:n.offsetX,clientY:n.offsetY,translationX:0,translationY:0,scale:1,hasCursor:n.pointerType&&n.pointerType==="mouse",isTouch:n.pointerType&&n.pointerType==="touch"})};this.msPointerDown=function(n){e.msSetPointerCapture?e.msSetPointerCapture(n.pointerId):e.setPointerCapture&&e.setPointerCapture(n.pointerId);a.target||(a.target=e);a.addPointer(n.pointerId);f++;f==1&&(v({clientX:n.offsetX,clientY:n.offsetY,hasCursor:n.pointerType&&n.pointerType==="mouse",isTouch:n.pointerType&&n.pointerType==="touch"}),o=0,h=0,c=1)};this.msPointerUp=function(n){f=Math.max(0,f-1);s||f!=0||l({clientX:n.offsetX,clientY:n.offsetY,translationX:o,translationY:h,scale:c,hasCursor:n.pointerType&&n.pointerType==="mouse",isTouch:n.pointerType&&n.pointerType==="touch"})};this.msPointerMove=function(n){s||f!=0||(y({clientX:n.offsetX||n.layerX,clientY:n.offsetY||n.layerY,translationX:n.clientX,translationY:n.clientY,scale:1,hasCursor:n.pointerType&&n.pointerType==="mouse",isTouch:n.pointerType&&n.pointerType==="touch"}),n.preventDefault())};this.msGestureStart=function(){s=!0};this.msGestureChange=function(n){if(s){p?o-=n.translationX:o+=n.translationX;h+=n.translationY;c*=n.scale;var t={clientX:n.offsetX,clientY:n.offsetY,translationX:o,translationY:h,scale:c,hasCursor:n.pointerType&&n.pointerType==="mouse",isTouch:n.pointerType&&n.pointerType==="touch"};n.detail&n.MSGESTURE_FLAG_INERTIA?(l(t),s=!1):y(t)}};this.msGestureEnd=function(n){s&&l({clientX:n.offsetX,clientY:n.offsetY,translationX:o,translationY:h,scale:c,hasCursor:n.pointerType&&n.pointerType==="mouse",isTouch:n.pointerType&&n.pointerType==="touch"})};this.userCurrentlyInteracting=function(){return f>0}}function nu(t,i,r,u){function v(n){var t=n.target.offsetParent,i=0,r=0;t&&(i=t.offsetLeft,r=t.offsetTop);n.actualX=n.clientX-i;n.actualY=n.clientY-r}var y=t,p=i,w=r,b=u,h,c,l,f={},o=0,e,s,a=0;this.handleTouchStart=function(t){for(var i,u=t.changedTouches,r=0,p=u.length;r<p;r++)i=u[r],o==0?e=i.identifier:o==1&&(s=i.identifier),v(i),f[i.identifier]={identifier:i.identifier,actualX:i.actualX,actualY:i.actualY,clientX:i.clientX,clientY:i.clientY},o++;o==1?(h=0,c=0,y({clientX:f[e].actualX,clientY:f[e].actualY})):o==2&&(l=1,t.preventDefault(),y({clientX:(f[e].actualX+f[s].actualX)/2,clientY:(f[e].actualY+f[s].actualY)/2}),a=n.distanceBetweenTwoPoints(f[e].actualX,f[e].actualY,f[s].actualX,f[s].actualY))};this.handleTouchMove=function(t){var d,w,b,nt,r,i,k,g;for(t.preventDefault(),d=t.changedTouches,w={},b=0,nt=d.length;b<nt;b++)(r=d[b],f[r.identifier])&&(v(r),w[r.identifier]={identifier:r.identifier,actualX:r.actualX,actualY:r.actualY,clientX:r.clientX,clientY:r.clientY});if(i=w[e],k=w[s],o>1&&(i||k)&&a!=0){h=0;c=0;var u=i==null?f[e]:i,y=k==null?f[s]:k,tt=n.distanceBetweenTwoPoints(u.actualX,u.actualY,y.actualX,y.actualY);l=tt/a;p({clientX:(u.actualX+y.actualX)/2,clientY:(u.actualY+y.actualY)/2,translationX:h,translationY:c,scale:l,isTouch:!0});f[e]=u;f[s]=y}else o>0&&i&&(g=f[e],l=1,h+=i.actualX-g.actualX,c+=i.actualY-g.actualY,p({clientX:i.actualX,clientY:i.actualY,translationX:h,translationY:c,scale:l,isTouch:!0}),f[e]=i)};this.handleTouchEnd=function(n){for(var r,u=n.changedTouches,t,i=0,e=u.length;i<e;i++)t=u[i],r=t.identifier,f[r]&&(delete f[r],o--);n.touches.length==0&&f.length>0&&(f={},o=0);o<2&&(v(t),w({clientX:t.actualX,clientY:t.actualY,translationX:h,translationY:c,scale:l}))};this.userCurrentlyInteracting=function(){return o>0}}function ki(t,i,r,u,f,e,s){var h,c;this._camera=t;this._upperPitchLimit=r||n.degreesToRadians(90);this._lowerPitchLimit=u||n.degreesToRadians(-90);this._upperHeadingLimit=null;this._lowerHeadingLimit=null;this._currentView={pitch:s||0,heading:e||0,verticalFov:0};this._viewChanging=!1;this._pitchSpring=new ri(.01,1,!0);this._headingSpring=new ri(.01,1,!0);this._fieldOfViewSpring=new ri(.0033,1,!0);this._zoomToPointSpring=new hr(.01,1,!1);this._zoomingToPoint=!1;this._wheelZoomFudgeFactor=.1;this._pitchSpring.setCurrentAndTarget(s||0);this._headingSpring.setCurrentAndTarget(e||0);this._fieldOfViewSpring.setCurrentAndTarget(this._camera.getVerticalFov());f?(h=n.degreesToRadians(40),this._minFieldOfView=f<h?f:h,c=n.degreesToRadians(5),this._minFieldOfView=this._minFieldOfView>c?this._minFieldOfView:c):this._minFieldOfView=n.degreesToRadians(20);this._maxFieldOfView=n.degreesToRadians(80);this._worldUp=i&&i.up?i.up:new o(0,1,0);this._worldLook=i&&i.look?i.look:new o(0,0,-1);this._worldSide=i&&i.side?i.side:new o(1,0,0);this._look=new o(0,0,0);this._side=new o(0,0,0);this._up=new o(0,0,0);this._tempQuaternion=new a(0,0,0,0);this._tempPitchRotationQuaternion=new a(0,0,0,0);this._tempHeadingRotationQuaternion=new a(0,0,0,0);this._lastGestureScale=1;this._startingPosition=null;this._discreteZoomFactor=.7;this._scrollSpeedX=0;this._scrollSpeedY=0;this._scrollAccX=0;this._scrollAccY=0;this._motionHandle=0;this._scrollSpeedDamper=.9;this._scrollSpeedAdjustmentFactor=200;this._previousTempZoomScale=null;this.viewChangeEvent=new lt;this.viewChangeEndEvent=new lt}function wi(t,r,u,f,e){function ht(){return[s._pitchSpring.getTarget(),s._headingSpring.getTarget()]}function ct(){var n=s._zoomToPointSpring.isSettled();return n&&(s._zoomingToPoint=!1),n&&s._pitchSpring.isSettled()&&s._headingSpring.isSettled()&&s._fieldOfViewSpring.isSettled()}function nt(n,t,i,r,u){var f,e,o=i/r;return e=n===0?0:2*Math.atan(o*(n/i)/u),f=t===0?0:2*Math.atan(-t/r/u),[f,e]}function lt(){if(ct()){s._viewChanging&&s.viewChangeEndEvent!=null&&s.viewChangeEndEvent.fire(s.getView());s._viewChanging=!1;return}s._viewChanging=!0;var n=Date.now();s._zoomToPointSpring.step(n);s._pitchSpring.step(n);s._headingSpring.step(n);s._fieldOfViewSpring.step(n);s.updateCameraProperties()}function at(t,i,r,u,f,e,o){s._zoomingToPoint=!1;r*=o;u*=o;var a=s._camera.getFocalLength(),h,c,l=nt(r,u,f,e,a);h=l[0];c=l[1];y=s.constrainHeading(i-c);k=s.constrainPitch(t-h);b=n.pickStartHeadingToTakeShortestPath(s._headingSpring.getCurrent(),y);s._pitchSpring.setTarget(k);s._headingSpring.setCurrent(b);s._headingSpring.setTarget(y)}function vt(n){s.setViewTarget(s.getPitch(),s.getHeading(),s.getVerticalFov(),!1,null);s._lastGestureScale=1;wt(n.clientX,n.clientY)}function yt(){s._lastGestureScale=1;tt();s._zoomingToPoint=!1}function pt(n){var t=s._lastGestureScale/n.scale,i,r;if(t!==1){tt();i=(s._startingPosition[0]+n.clientX)/2;r=(s._startingPosition[1]+n.clientY)/2;n.clientX=i;n.clientY=r;s.onDiscreteZoom(n,t)}s._lastGestureScale=n.scale;c=new h(s._startingPosition[0]+n.translationX,s._startingPosition[1]+n.translationY)}function wt(n,t){p=!0;s._startingPosition=[n,t];a[0]=s.getPitch();a[1]=s.getHeading()}function tt(){p=!1;c=null}function bt(){if(s._camera!==null&&c!==null&&p){var t=c.x,i=c.y,n=s._camera.getViewport(),r=t-s._startingPosition[0],u=i-s._startingPosition[1];at(a[0],a[1],r,u,n.getWidth(),n.getHeight(),1.1)}}function kt(t,i){var e=s.prevGyrometerReadingNonZero?2:2;if(t==null)return s.prevGyrometerReadingNonZero=!1,[0,0];if(Math.abs(t.angularVelocityX)<e&&Math.abs(t.angularVelocityY)<e&&Math.abs(t.angularVelocityZ)<e)return s.prevGyrometerReadingNonZero=!1,[0,0];s.prevGyrometerReadingNonZero=!0;var o=1.5*n.degreesToRadians(i/1e3)*Math.sin(s.getVerticalFov()),u=t.angularVelocityY*o,f=t.angularVelocityX*o,r=null;return(Windows&&Windows.Graphics&&Windows.Graphics.Display&&Windows.Graphics.Display.DisplayProperties&&(r=Windows.Graphics.Display.DisplayProperties.currentOrientation),r==null||r===Windows.Graphics.Display.DisplayOrientations.none||r===Windows.Graphics.Display.DisplayOrientations.landscape)?[f,u]:r===Windows.Graphics.Display.DisplayOrientations.portrait?[u,-f]:r===Windows.Graphics.Display.DisplayOrientations.landscapeFlipped?[-f,-u]:r===Windows.Graphics.Display.DisplayOrientations.portraitFlipped?[-u,f]:[0,0]}wi.__super.call(this,t,null,r,u,e);var s=this,b=0,k=0,y=0,it=i.createIdentity(),dt=i.createIdentity().multiply(it),rt=f,ut=-.7,a=[],p=!1,c=null,l=!1,d=i.createIdentity(),g=i.createIdentity(),v=i.createIdentity(),w=i.createIdentity(),ft=new o(0,0,-1),et=new o(0,1,0),ot=new o(1,0,0),st=new o(0,0,0);this.setDimension=function(n){rt=n};this.setBounds=function(t){t.top>=0&&(this._upperPitchLimit=t.top,this._lowerPitchLimit=Math.min(ut,t.bottom));var i=Math.abs(t.left-t.right);i<n.twoPI&&(t.left>0&&t.left<t.right?(this._upperHeadingLimit=t.left,this._lowerHeadingLimit=t.right):(this._upperHeadingLimit=t.right,this._lowerHeadingLimit=t.left<0?n.twoPI+t.left:t.left))};this.updateCameraProperties=function(){var n,t,r,u,f;this._zoomingToPoint?(u=this._zoomToPointSpring.getCurrent(),n=u[0],t=u[1],r=u[2],this._pitchSpring.setCurrentAndTarget(n),this._headingSpring.setCurrentAndTarget(t),this._fieldOfViewSpring.setCurrentAndTarget(r)):(n=this.constrainPitch(this.getPitch()),t=this.getHeading(),r=this.getVerticalFov());w.transformVector3Out(ft,this._worldLook);w.transformVector3Out(et,this._worldUp);w.transformVector3Out(ot,this._worldSide);i.createRotationXOut(n,d);i.createRotationYOut(-t,g);g.multiplyOut(d,v);v.transformVector3Out(this._worldLook,this._look);v.transformVector3Out(this._worldUp,this._up);v.transformVector3Out(this._worldSide,this._side);f=st;this._camera.setPosition(f);this._camera.setLook(this._look);this._camera.setUp(this._up);this._camera.setVerticalFov(r);this.viewChangeEvent!=null&&this.viewChangeEvent.fire(this.getView())};this.control=function(n,t){for(var i,e,r,u,f=0;f<t.length;++f){i=t[f];switch(i.type){case"gestureStart":l=!0;this.stopMovingCamera();vt(i);break;case"gestureChange":pt(i);break;case"gestureEnd":l=!1;yt(i);break;case"discreteZoom":this.onDiscreteZoom(i,null);break;case"keydown":l=!0;this.onKeyDown(i);break;case"keyup":l=!1;this.onKeyUp(i)}}if(this._gyrometer){if(e=new Date,r=this._gyrometer.getCurrentReading(),r&&this.prevGyroReading&&r.timestamp!=this.prevGyroReading.timestamp&&!l&&this.prevFrameTime&&(u=kt(r,e-this.prevFrameTime),u[0]!==0&&u[1]!==0)){var o=ht(),s=o[0]+u[0],h=o[1]-u[1];this.setPitchAndHeading(s,h,!0)}this.prevGyroReading=r;this.prevFrameTime=e}return lt(),bt(),this._camera};this.setGyrometer=function(n){this._gyrometer=n}}function hi(t,i,r,u,f,e,o){hi.__super.call(this,t,i,r,u,f,e,o);this._mouseDownPoint=new h(0,0);this._mouseUpPoint=new h(0,0);this._previousMousePoint=new h(-1,-1);this.hasCursor=!1;this._isMouseDown=!1;this._isCurrentMouseSet=!1;this._isPreviousMouseSet=!1;this._startingPitch=null;this._startingHeading=null;this._animationInProgress=null;this._radiansPerPixelPitch=null;this._radiansPerPixelHeading=null;this._accelerateHorizontalRotationNearPoles=!0;this._maxPitchForAcceleratingHorizontalRotation=n.degreesToRadians(70);this._currentMousePoint=new h(0,0);this.control=function(n,t){for(var i,r=0;r<t.length;++r){i=t[r];switch(i.type){case"gestureEnd":this.onGestureEnd(i);break;case"gestureStart":this.onGestureStart(i);break;case"gestureChange":this.onGestureChange(i);break;case"discreteZoom":this.onDiscreteZoom(i);break;case"keydown":this.onKeyDown(i);break;case"keyup":this.onKeyUp(i)}}return this.updateCameraProperties(),this._camera};this.updateCameraPropertiesImpl=function(){var u,n,t,i,r;this.updateViewForMouseDrag();u=this.stepUpSpring();this._zoomingToPoint?(r=this._zoomToPointSpring.getCurrent(),n=r[0],t=r[1],i=r[2],this._pitchSpring.setCurrentAndTarget(n),this._headingSpring.setCurrentAndTarget(t),this._fieldOfViewSpring.setCurrentAndTarget(i)):(n=this.getPitch(),t=this.getHeading(),i=this.getVerticalFov());this._look=this.calculateLookFromPitchAndHeading(n,t,this._worldLook,this._worldUp,this._worldSide,null);this._up=this.calculateLookFromPitchAndHeading(n,t,this._worldUp,this._worldUp,this._worldSide,null);this._side=this.calculateLookFromPitchAndHeading(n,t,this._worldSide,this._worldUp,this._worldSide,null);var f=this._camera.getLook(),e=this._camera.getUp(),o=this._camera.getVerticalFov();!this._animationInProgress&&(this._animationInProgress||u)&&f.equals(this._look)&&e.equals(this._worldUp)&&o===i||(this._camera.setLook(this._look),this._camera.setUp(this._worldUp),this._camera.setVerticalFov(i),this.viewChangeEvent!=null&&this.viewChangeEvent.fire(this.getView()));this._animationInProgress=!u};this.updateCameraProperties=function(){this.updateCameraPropertiesImpl()};this.updateViewForMouseDrag=function(){if(this._isCurrentMouseSet){if(this._isMouseDown&&this._isPreviousMouseSet&&(this._previousMousePoint.x!==this._currentMousePoint.x||this._previousMousePoint.y!==this._currentMousePoint.y)){var t=n.clamp(this._startingPitch+this._radiansPerPixelPitch*(this._currentMousePoint.y-this._mouseDownPoint.y),this._lowerPitchLimit,this._upperPitchLimit),i=n.normalizeRadian(this._startingHeading+this._radiansPerPixelHeading*(this._mouseDownPoint.x-this._currentMousePoint.x));this.setViewTarget(t,i,null,!0)}this._previousMousePoint.x=this._currentMousePoint.x;this._previousMousePoint.y=this._currentMousePoint.y;this._isPreviousMouseSet=!0}};this.stepUpSpring=function(){var n=Date.now(),t=this._zoomToPointSpring.step(n),i=this._pitchSpring.step(n),r=this._headingSpring.step(n),u=this._fieldOfViewSpring.step(n);return(t&&(this._zoomingToPoint=!1),t&&i&&r&&u)?(this._viewChanging&&this.viewChangeEndEvent!=null&&this.viewChangeEndEvent.fire(this.getView()),this._viewChanging=!1,!0):(this._viewChanging=!0,!1)};this.onGestureStart=function(t){var i,r;this.hasCursor=t.hasCursor==!0;this._mouseUpPoint.x=this._mouseUpPoint.y=-1;this._lastGestureScale=1;this._isMouseDown=!0;this._mouseDownPoint.x=t.clientX;this._mouseDownPoint.y=t.clientY;this._startingPitch=this._pitchSpring.getCurrent();this._startingHeading=this._headingSpring.getCurrent();this._startingPosition=[t.clientX,t.clientY];i=this._camera.getViewport();this._radiansPerPixelPitch=this._camera.getVerticalFov()/i.getHeight();this._accelerateHorizontalRotationNearPoles&&(r=Math.min(Math.abs(this._startingPitch),this._maxPitchForAcceleratingHorizontalRotation),this._radiansPerPixelHeading=this._radiansPerPixelPitch/Math.sin(n.halfPI-r))};this.onGestureEnd=function(n){this._mouseUpPoint.x=n.clientX;this._mouseUpPoint.y=n.clientY;this._lastGestureScale=1;this._isMouseDown=!1;this._isCurrentMouseSet=!1;this._isPreviousMouseSet=!1;this._startingPitch=null;this._startingHeading=null};this.onGestureChange=function(n){var t,i,r;if(this.hasCursor=n.hasCursor==!0,t=this._lastGestureScale/n.scale,t!==1){if(!this._startingPosition)return;i=(this._startingPosition[0]+n.clientX)/2;r=(this._startingPosition[1]+n.clientY)/2;n.clientX=i;n.clientY=r;this.onDiscreteZoom(n,t)}else this._isMouseDown&&(this._currentMousePoint.x=this._mouseDownPoint.x+n.translationX,this._currentMousePoint.y=this._mouseDownPoint.y+n.translationY,this._isCurrentMouseSet=!0);this._lastGestureScale=n.scale}}function bi(n,t,r,u,f,e,h,c,l){bi.__super.call(this,n,t,r,u,f,e,h);_hitTestTranslation=i.createIdentity();_isNewHitTestResult=!1;_isPancakeClicked=!1;_isDirty=!0;_pancakeLocation=null;_localToGlobal=c;_bubbleCenterInGlobal=l;_lastHitTestResult=null;this.hasCursor=!1;this.control=function(n,t){for(var i,r=0;r<t.length;++r){i=t[r];switch(i.type){case"mouseClicked":this.onMouseClicked(i);break;case"gestureEnd":this.onGestureEnd(i);break;case"gestureStart":this.onGestureStart(i);break;case"gestureChange":this.onGestureChange(i);break;case"discreteZoom":this.onDiscreteZoom(i);break;case"keydown":this.onKeyDown(i);break;case"keyup":this.onKeyUp(i)}}return this.updateCameraProperties(),this._camera};this._upArrowHandler=function(){this.navigateForward(!0)};this.navigateForward=function(n){var t=this._camera.getViewport();this.hitTestLocation(t.getWidth()/2,t.getHeight()*.65);this.onMouseClicked(null,!n)};this._downArrowHandler=function(){this.navigateForward(!1)};this.setHitTestResultTranslation=function(n){_hitTestTranslation=n;_isNewHitTestResult=!0};this.getHitTestResultTranslation=function(){return _hitTestTranslation};this.setIsNewHitTestResult=function(n){_isNewHitTestResult=n};this.getIsNewHitTestResult=function(){return _isNewHitTestResult};this.setIsPancakeClicked=function(n){_isPancakeClicked=n};this.getIsPancakeClicked=function(){return _isPancakeClicked};this.setPancakeLocation=function(n){_pancakeLocation=n};this.getPancakeLocation=function(){return _pancakeLocation};this.updateCameraProperties=function(){this.updateCameraPropertiesImpl();this.hitTest()};this.hitTest=function(){this.hitTestLocation(this._currentMousePoint.x,this._currentMousePoint.y)};this.hitTestLocation=function(n,t){var e=this._camera.getViewport(),h=2*n/e.getWidth()-1,c=1-2*t/e.getHeight(),f=new o(h,c,-1),u,s;f=this._camera.getProjectionTransform().inverse().transformVector3(f);f.z=-1;u=this._camera.getViewTransform().inverse().transformVector3(f);u.normalizeOut(u);var l=new o(0,-2.7,0),a=new o(0,1,0),v=yt.createFromPointAndNormal(l,a),y=new uu(u.multiplyScalar(-100),u),r=yt.intersectWithRay(y,v);r!=null&&(_lastHitTestResult==null||_lastHitTestResult.x!=r.x||_lastHitTestResult.y!=r.y||_lastHitTestResult.z!=r.z)&&(s=i.createTranslation(r.x,r.y,r.z),this.setHitTestResultTranslation(s),_lastHitTestResult=r)};this.onMouseClicked=function(n,t){var f=this.getHitTestResultTranslation(),i,r,u,e;this.setIsPancakeClicked(!0);i=new o(-f.m14,0,-f.m34);t&&(i.z*=-1,i.x*=-1);r=_localToGlobal.transformVector3(i);r=r.add(_bubbleCenterInGlobal);u=s.toLatLongAlt(r);e={latitude:u.x,longitude:u.y};this.setPancakeLocation(e)};var a=this.onGestureEnd;this.onGestureEnd=function(n){if(a.call(this,n),this._mouseDownPoint.x==this._mouseUpPoint.x&&this._mouseDownPoint.y==this._mouseUpPoint.y){this._currentMousePoint=this._mouseUpPoint;this.hitTest();this.onMouseClicked(n)}};this.onGestureChange=function(n){var t,i,r;if(this.hasCursor=n.hasCursor,t=this._lastGestureScale/n.scale,t!==1){if(!this._startingPosition)return;i=(this._startingPosition[0]+n.clientX)/2;r=(this._startingPosition[1]+n.clientY)/2;n.clientX=i;n.clientY=r;this.onDiscreteZoom(n,t)}else this._isMouseDown?(this._currentMousePoint.x=this._mouseDownPoint.x+n.translationX,this._currentMousePoint.y=this._mouseDownPoint.y+n.translationY,this._isCurrentMouseSet=!0):n.isOffTarget||(this._currentMousePoint.x=n.clientX,this._currentMousePoint.y=n.clientY,this.hitTest());this._lastGestureScale=n.scale}}function fu(){var n=this;n.byId={};n.byType={};n.add=function(t){if(t.id==null)throw"expected id property on the item";if(!t.type)throw"expected type property on the item";n.byId[t.id]=t;n.byType[t.type]=n.byType[t.type]||[];n.byType[t.type].push(t)};n.remove=function(t){var i;if(typeof item=="number")i=n.byId[t],n.byType[i.type].remove(i),n.byType[i.type].length===0&&delete n.byType[i.type],delete n.byId[t];else throw"Expected a single ID";};n.update=function(t){var i;if(t.added)for(i=0;i<t.added.length;++i)n.add(t.added[i]);if(t.removed)for(i=0;i<t.removed.length;++i)n.remove(t.removed[i])}}function pi(){this.interactionController=null;this.viewElementContainers=[];this.initialCameraParams=null;this.dataSourceName=null;this.worldConfiguration=null}function vi(n,t){this.message=n;this.innerException=t}function ti(n,t){this.message=n;this.innerException=t}function ot(){ot.__super.call(this);this.tesselator=new ar(v);this.worldConfiguration=null;this.dataSourceName="panorama"+Date.now();this.faceNames=["front","right","back","left","top","bottom"];this.jsonWrapper="/jsonproxy.psfx?jsonUrl={0}";this.jsonpWrapperParam="&jsCallback={0}";this.defaultPhotosynthServer="http://photosynth.net";this.defaultHttpsPhotosynthServer="https://photosynth.net";this.uriRegex=new RegExp("^(\\w+)://([^/]+)(/.*)$");this.outputMultiLODTiles=!1;this.scanConvertSize=20;this.prevViewTransform=null;this.prevProjectionTransform=null;this.initialCameraParams={verticalFov:n.degreesToRadians(60),position:new o(0,0,0),look:new o(0,.3,-1),up:new o(0,1,0)}}function w(t,r,u,f,e,o,h,c,l){var l=l||{},y,k,a;if(!t)throw"urlFormat cannot be null or empty";if(!r)throw"bubbleId must be specified";w.__super.call(this);this.tesselator=new ar(b);var p=["frontFace","rightFace","backFace","leftFace","topFace","bottomFace"],nt=["01","02","03","10","11","12"],v=8,tt=Math.pow(2,v+3);for(this.dataSourceName="streetsidePanorama"+r+Date.now(),this.interactionController=null,this.worldConfiguration={id:"streetsideCube"+r,type:"streetsidePanorama",source:{dimension:2032,tileSize:254,tileOverlap:1,tileBorder:1,minimumLod:v,maximumResolution:o?Math.pow(2,v+o):tt,bounds:{left:-3.141592653589793,right:3.141592653589793,top:-1.5707963267948966,bottom:1.5707963267948966},startingPitch:f&&n.degreesToRadians(f)||0,startingHeading:u&&n.degreesToRadians(u)||0,startingRoll:e&&n.degreesToRadians(e)||0,latitude:h,longitude:c,cameraHeight:2.7,projectorAspectRatio:1,projectorFocalLength:.5}},this.isCursorAndLabelEnabled=l.isCursorAndLabelEnabled||!1,y=l.cursor||{},this.cursorConfiguration={entityId:1e5,textureSize:y.size||256,textureExpansion:2,textureData:y.src||"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAQAAAAEACAYAAABccqhmAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAEtBJREFUeNrsnb9T21gXhq/cM+MtoXIa0pLh6zF9siEl+YpAk5QJk/RAvztJyqSJKTaUIT96TP8xSxuadQXleoY/gE8HjsL1RbJlLNlXV88zozEoEEDW+973nHslGQMAtSXiEITJ5eVl29m1FG/NnN/ej7eTgRMlirocVQwA/BB3IuZE5Ct3EPldsc3hSF/FHPqxSZzw7mAAUKzQWyrsFf245fmv3dPtSI2ihzFgADBa7MmInoh90tH8PN7Ohnw+jIV4mx/y+V1TQ2IK3dgU+rzrGACCvxZ7IvxxxX0abxfW6zgivyuJGczF26L1Oq5JnGjpcIQhYAB1ivQi9sdW/T6KYxX4qYr72PM/c1nNYFG35ZzfJ2bwVc2AkgEDCEr0z+JtLUf9nghdRP5TPw4BMYL7agaJMYzqIxzE2x5mgAGELPpzHfmOdbuoySGaUzNY1iQ0jxlgAFUXvQh9Q4XfGhF1j7X2PePI/eorrFiGMMwM9uKtE5tBj8OGAfgg/DVrtE/jQsXerdkoP2k6aKspzGV8XZIKDjhkGMC0RS8d/FcjRnsR/A99hbsjRvBwSDJIUsE7ZhIwgGnE/G2N+mlI025fRc9IX3wyEBNYN9lNxE687VIeYABFC7+twm8PififTThde98RA3g6pEToqhGQvjCA0oQvHfyPjPYzTwUP1QzmMQIMYBrCP7ZiPvjVK5DyYBkjwADuKnyZv387RPgfjf8r8eqOGMDzIUawxXoCDMAVfstkN/cQfnhG0DE0CzEAFf9O/PLS3L7yDuGHbQQyZfg+NoEdDKCewl/TuN9C+LU2AkkBm3XtD0Q1FH5Lhe+u3Eu6+t/RStA8UiNwZw0OtD/QwwDCFf8rrfXduC/Cl84+03n1QKYP19UI3LJAegPvMIDwRv1P5nZ3X2L+ruGinLqyoAOCWxZ0tSzoYQBhjvoXKvwuGgAdGLbN4KrCWqSBKGDhi+C/pIz6+xr5ifvglgXPtTRw08CTUC80igIV/5pGfnvUlybfjqG7D8NZ1vNk3kkDmyFeetwIUPxvdeRvOi7+FPFDDo71XLHLw6s0qecWCcBT4bdU+EvU+lBib+BES4IeBuCP+Nspo75cmvvG0OGHyZCZgj/M4D0I+moClR9YGgGIX7r8h4749zXGIX6YlDM9l/adkuBQzz0SwIyEL2+C1GQbRH6YYUnQMdcrCPsYwHTFf+jU+xL5dwx35YFyWdTzbNHpC6xW0QQaFRS/iP5vR/wy4r9A/DAFTvVcs1Pm1Tmp5yYJoGTxp9X7f3Jewgx4bQYXDvU1CVTmhiONCol/I0X8u4gfZsifeg4mJM3BDRJA8eL/ZO2i2Qc+0Ta3m4OycrCDAZQjfup98A1pCn6omglEiB+gviYQVUj8SfeVq/jAZ+bUBBarYAIR4georwlEiB+gviYQIX6A+ppAhPgB6msCkSfid1f4ieh/R/wQkAl8MzezA96sGGx4Kn5GfggJ95xOVgzO/NqBaMbilwMhF/a0nAPFPD+EiLtOoBdvD2Z5FWFjxuI/NIOP5tpF/BAwp2bw2oGWJoFmHUsAuZnHkiP+LucIBE7XMYHkkfT1MQC9ldKGtUsu6eWZfFAXvpvBW4xtzOr2YtEMxN/W6G874hvOCaghcrPRtvX56rRvNBpNWfxS80jTr2nVRHT8oa64awSkGfhgmrccn3YJYN+6W0S/g/ihxrgaSB5nF14PQJ+q4jb96PhD3XFnBpam+QSixpTEL8/qs5sc+4aOP0BC1ww2BV+pZqrfA9A5zn+cuv8p7znALT47/YB7ZS8SmkYCcOt+Ov4A6byZdj+gVAPQuc22U/fzuC6AdM6cfkC77PUBUYnib5nBKb8uoz9ALuz1AaVODZZpAIfWH3GudT9TfgCjmdN+wHwyeMYGsFqZEiAl+u8gfoDcJOsDSi8FGiWIX6L/trVLpjeOeU8BxuLYDE4Nbqu2vE8Ab81g1/8j7yXAnfhoBmcF3nptAHqhj72AYZfoDzBRKWDPCqypxrxNAJ+cCNPlPQSYiK5TQn/y0gBiZ9oxt+/uAwCTM3AXIdWaPwagzYmXTu3Cgh+AYjgzg720l0U1BItKANL1Txp/Mue/z3sGUCj7qi2jWtv2wgD01sYbzuhP4w+gWNwZtY0ibiteRAKwpyakWcG9/QDK4bsZbAi+nakB6JRE2xn9AaA8bI21J50WnDQBbDujPyv+AMrF1dn2TAyA0R+g+ilgkgTA6A9Q8RRwJwNg9AcIIwXcNQEw+gMEkALGNgBdgcToD+BfCmhNIwEw+gMEkgLGMgC9xfeGtYslvwCzxX3IaLM0AzCDD/eQdcldjj/ATOmam2sEXI0WbgDPrI8/c+wBvOBzhkaLMwB9VFFLP5ULE35w3AG84Ie5uQCvNc5jxcZJALazHBmu+APwhQvV5NgpINdzAXR64R9rl9zjnyf7AvjDolMK3MvzMJG8CWDD+vgU8QN4h6vLjSJLADtSMPUH4Cf745YBIw1A7zrSsnZ1Oc4AXmJrs5XnjkF5EsAz5wfQ/APwkwvHBJ4VYQD2lAJTfwB+8yNDu+MbgBP/L4j/AJUoAy7ylgGjEoA79w8A/pN7TcAoA1hznAUAqpECcpUBjZzxX+CyX4BqYGt1aBkwLAG0M+oKAPAbt1/XvosBPKb+BwgiBTzO+qIoI/7LTQX+tXb9bnjYJ0CVWIi3b9bnv0VR1M+bAOzIcI74ASrHmRm8UUh7nBJgxan/AaB6dDM0PVYCoPsPUP0+QDtXDyCl/l81zAAAVJG5eDsc1gdojBj9TxE/QGW5MIP3CGjnKQGWHAMAgOpymqHtTANYof4HCLIPsJLHAOyY8JPjB1BpfuZOAClrhikBAMIpAZquxt0E0CL+AwRdBrSGGQANQICwU8DQBLCCAQAEbQAreUsA1v8DhMFZVgkwsBLwMsb69D8cN4Bg+N8v0cfcSgBOd/Cc4wUQFOdpWrdLgCbxH6AWZUAzzQDaGU0DAAgoAdhaz7ocmAuAAMJNACbNAJgCBAiX1KlAEgBAPbgYlQCYBQCoRw+AWQCAGvcAmqNKAACoAVcGcHl52Sb+A9SnDEg03xgRFQAgzDKAEgCAEgAAam8ATAEC1KgHkGg+MQCmAAHq1QNoUgIAUAIAAAYAABgAAGAAAIABAAAGAAAYAABgAAAQmAH0rX0LHBaAILG13bcN4MT6h3mOE0CQ2No+oQQAoAQAAAyAHgBAnXoAV/x6SihPBgYInltPCKYEAKAEuIKpQIB6xP9+mgEwFQgQLvNpWs8qAeY4XgBBMTeqBDiyPl7keAEExWKa1kkAAPXrAaQmgC4JAKAWPYBumgEwCwBQjxLgl9Yj+ytYDAQQLLcWAaX1AHrWx8scM4AgWM7Q+FADoAwACIOFvAbAVCBA2PX/0TADOMEAAII2gJO8JQA9AIA69QCiKBJ36JMCAIIc/fuq8cwE4EaE+xw/gEpzPyv+ZxnAEWUAQJDx/yiPAdAIBAizBLiVACJ3x+XlZTN++dfatRpvFxxHgMohF/UdWp//FkVRf2gC0C84oQwACCr+n7jizyoBhC4GABCUAXTTviDLAOxmQZvjCFBJ2hmaHisByHXEXBcAUC0WTMY9AEYagNYK9jescDwBKoWt2W5a/T8sAQhf6QMABFH/f836omEG0HVqCe4TCFAN5pz6vzu2Aeia4R4pAKDSo3/PXf+fNwEIB04KAAD/aWdoeGwD2MtoKgCAv6xkaHg8A3DKgDlSAID3PDI3/bqh8T9PAnAjxEOOL0BlRv+DUV+cxwD2nNqC2QAAP3FT+t7EBpAyG0AZAOAntjZHxv+8CcB1knWOM4CX2Np8n+cb8hpAx/p40XCjEADfcHV5UJgBxFGi5/yHTzneAF5ha/JANVtYAnDLAOk00gwE8IM5M8bc/50MIHYUSQA96we2Oe4AXvDQDM79HxRuACnO8pzjDuBd/N8b5xvHNYB31sfzpACAmdM2gzf+eFeaAehNBTrWLqYEAWaLrcFO1o0/MjU97k+7vLxsxS//WLtexNsx7wPA1JHLfj9Yn9/L2/2/awmQTAl26QUAzBxbe91xxX8nA1B2HRfiZiEA0x/9lzM0Wa4BxE7TJQUAeDX6d6dmAKQAgOqP/hMZACkAoNqj/6QJgBQAUOHRf2IDIAUAVHf0LyIBCFuOOz3iPQIohUfO6L856X84sQHoXUc6jkNxpSBAscw5o3/nLvP+ZSSApA5JliDKumSWCAMUy7q5WfPfn7T2L9QA1IneOymAJwoDFMOCM/q/L2L0v9Jukb/l5eWlXCPQ0k/l+oAXvHcAE/PBqv3lev97Rf3HjYJ/Ubch2Oa9A5iItim48VdaAtAU8CV+WdNPL+Ltd30FgPGQxt83c9NUl3v9PSnyBzRK+KUlBfStP4C1AQB347Ul/r6TsP00AG1O2B3KdcMKQYBxEc3Yj+LbLarxV2oJYJUCh1YP4Nxc37eMUgAgX/T/bG6m/WTF32oZP6hR4h+xaQbXBmzzvgLkYtsMzvlvlvWDSjOAlFKgbZgVABiFq5NSon/pJUBGKSAlwH/j7Yz3GeAWsuDnL3PT+Cst+k/TAJrm+iaiTd11ani0GEAaUvcvWtH/3rh3+fWpB5CUAm4NI3/ga95rgAFem8GHe26WLf6pGICagDyqyH5gwTr9AICBut++gO7dOI/38roEcMqBv+OXJasf8EJLAoC6IqP+B6vuP4nF/2BaP7wx5T/2iRlcJbhjuHcA1BdXA33ViAnSAHQ644njfqwPgLqy7dT9T8qc8vMhAST3Edxy6h+aglA3XpvBPtjWpPf3q4QBqAlIQ7Bj7ZIGCPcShLrwyNx+qOe7mWhxVkdA1wfIIqEla/cbM3iXYYDQkFH/D+tzuafm6jSm/LwyAMsEZGagpbuYGYCQcTv+Uu8/mJX4Z1YCWKVA0vW0ZwY+mMHGCECI4r8692cp/pknACsJLGk50LSSAHcSglBw7+zT19h/MutfrOHD0dEDseUcMNstAaosfvdc3vJB/N4kACsJbMQvn6xdp9oTIAlAlcXvrvHv+PILRr4dMUwAEH+NDQATAMRfcwPABADx19wAMkyAdQLgM+5Un9fi994AMAFA/OXS8P2o6gHcTIlYbc458IR2FcVfCQNwTMBeMSjrqbmACGbNIz0X7UU+lRB/JUoApxxwVwwK+/H2J+chzAC5pNe+qs+bFX5BJQArCVxdOWWuL6JIWHccGKBskgRqi79XNfFXLgFYSSDtUmJpCu4YmoNQLot6ntnTfDO9pLc2CcBKAn1NAh3njaE5CGXSNrfn+DtVFX9lE4CTBl7FL2+d3fQFoOx6X9ia1Z18MIBBExBn/mIGm4NSCsgdhngMGUzCgtb79qifXMvfrfof1wjhHdI34oHWYnZJ8BclAUwY+f9KqfcfhCD+YBKAkwakHHjl7JY3S55UzHUEkAfp8m+nDB7yxJ6tkP7QKMR3LzaBNXO9fNguCc7Ndff2mPMbhrBsbk8rJ4t7DkL7Y6NQ30WdKvyS4uLSIPxIGoCUUV8afQ9T0uOTqnb5a9EDyOgL9PXZ6lvmZgmxIJ3cb/QGwKn1vznil3NGuvyroYo/6ATgpIGWlgSu6I+1N8BMQT1Z0Fp/OWXU35z2Y7owgPKN4JW+4U3nnz5qaUBZUJ+4L0nwubNfRvrdqs/tYwCj04DMFKw5/3SuRvAdfQTNIxX+vLP/QCN/r04HI6rrWaCLh6QsaKWUBR8NswWhITFfmnzuQ2d6Gve7dTwoUd3PitgIduKXlyllAUYQjvCfp9T5Evffx8LfqfPBiTg/fpUF0hvYSPlnjCAs4QsdrfV7dT9IGMBtI0ibLcAIwhB+19Sku48BTN4f2B5iBPuGx5j7hrxX60OEv1vXOh8DKMcIZNbgc7z9MEwfzgqZzpPFO0/N7a4+wscApmIEIv4jNQPuRjQdFlX0Kyb9VnAIHwMorUeQ1Sw0agBJeUAqKH60T2L+YsbXdAzNPQxgCkYgU4ayqvCZub2OwB6FftArKKS2f2iyr90Qse+Z60t1+xwuDGDaZrCmRrCW8SVJiSBGcEwyyDXSL6vgsyK+ICv39kK8RBcDqG55sDEiFRjLCMQUuAjpmgUV+7IZfpVmMtp3iPkYgM9msGSlgmFmcG4ZQp3SQTLKJ4KfHyH6ZLQ/4ezCAEI1A+FUNzGDnyacWQVp2t1XwS+a7CYeoscAgjcDGfEem/w3JDm2jOHM+L8ScVkjfSL05ZzfJ0noq7wiegygDmbQNDeNLnldGuPbL9QQztUUTnXf+RT6Cgsa2edU4Mnni2a8x7OdqOiPVPR08DEADEGNYEVfmxP8l64ZjGMOC05dvjCiTh9FXwV/lAgfwWMAkK9kaFmm0MrRR5g1Pd0SsfeI9BgAFG8MTauPsKKvk6aGcUZzoyJP6vc+QscAwB+TaDu7xjEHW+TXJwrr6gEAwuL/AgwAWfnIbrU1Rq8AAAAASUVORK5CYII="},k=l.label||{},this.labelConfiguration={entityId:2e4,labelOffsetFromBubbleInMeters:5,labelOffsetMaxInMeters:20,labelOffsetIncreaseStepInMeters:2,textureToGeometryRatio:1/60,font:k.font||"60pt SegoeBing"},this.roadVectorGroup=[],this.initialCameraParams=this.createCameraParameters(n.degreesToRadians(e||.07),n.degreesToRadians(f),n.degreesToRadians(u),null),a=0;a<p.length;a++){var it=p[a],rt=r+nt[a],ut=t.replace("{quadkey}",rt+"{quadkey}"),ft=a%4;this.worldConfiguration.source[it]={tileSource:new kr(ut,ft).getTileUrl,clip:[0,0,0,2032,2032,2032,2032,0]}}this.viewElementContainers.push(new ur(this.worldConfiguration));var et=this.worldConfiguration.source.startingHeading,ot=this.worldConfiguration.source.startingRoll,st=this.worldConfiguration.source.startingPitch,d=this.worldConfiguration.source.latitude,g=this.worldConfiguration.source.longitude;this.bubbleCenterInGlobal=s.fromLatLongAlt(d,g,0);var ht=i.createRotationY(-et),ct=i.createRotationX(st),lt=i.createRotationZ(ot),at=s.getLocalToGlobalRotation(n.degreesToRadians(d),n.degreesToRadians(g));this.localToGlobal=ht.multiply(lt).multiply(ct);this.localToGlobal=at.multiply(this.localToGlobal);this.globalToLocal=this.localToGlobal.inverse();this.surfaceNormalInGlobal=s.getSurfaceNormalFromPoint(this.bubbleCenterInGlobal);this.surfaceNormalInLocal=this.globalToLocal.transformVector3(this.surfaceNormalInGlobal)}function at(n,t,i,r,u){function e(n){return n.faceName.toString().concat(n.levelOfDetail.toString(),"_",n.x.toString(),"_",n.y.toString())}var f=this;f.x=t?Math.floor(t):0;f.y=i?Math.floor(i):0;f.levelOfDetail=n?Math.floor(n):0;f.faceName=r||Date.now();f.idFunction=u||e;f.id=f.idFunction(f)}function ru(n,t,i,r,u,f,e){this.geometryPolygon=n;this.texturePolygon=t;this.faceTransform=i;this.textureSource=r;this.viewElementId=u;this.viewElementWidth=f||256;this.viewElementHeight=e||256}function ni(n){this._geometry=n}function rr(n){ni.apply(this,new Array(new er(n)))}function ur(n){ni.apply(this,new Array(new or(n)))}function ii(t){this._worldConfiguration=t;this._viewElementsByLod=[];this._minimumLod=t.source.minimumLod;this._maximumLod=t.source.maximumLod||n.ceilLog2(t.source.dimension);this._baseImageWidth=t.source.dimension;this._baseImageHeight=t.source.dimension;this._tileWidth=t.source.tileSize;this._tileHeight=t.source.tileSize;this._tileOverlap=t.source.tileOverlap;this._tileBorder=t.source.tileBorder;this._faceNames=["frontFace","rightFace","backFace","leftFace","topFace","bottomFace"]}function er(){function i(n,i){r(t._worldConfiguration.source[i.faceName],f.cubeSideBase,i.lod,t._viewElementsByLod[i.lod],t._tileWidth,t._tileHeight,t._baseImageWidth,t._baseImageHeight,t._maximumLod,n,i)}function r(t,i,r,u,o,s,c,l,a,v,y){function hi(n,t,i){return n&&t!=i?i:t}function ci(n,t,i){for(var u,f=0,e=i,r=1,o=n.length;r<o;r++)u=n[r]-n[r-1],f==0?f=u:f!=u&&(e=Math.abs(t*u));return e}function li(n,t,i,r,u){var f,e,o;if(i==1&&!u)return[n,n+r];for(f=[n],e=1,o=0;e<=i;e++,o++)f[e]=f[o]+r;return u&&f.push(t),f}var yt=i[0].x,ai=i[0].y,it=i[0].z,rt=i[0].w,pt=Math.pow(2,a-r),ut=f._cubeSide,d=c/pt,g=l/pt,wt=[],et=t.clip,bt=et.length,kt,nt,dt,gt,w,ht,ti,ii,b,k,at,vt;if(bt%2!=0)throw"The clip region defined for the current face is invalid.";for(kt=i[1].y,nt=0;nt<bt;nt+=2)dt=et[nt],gt=et[nt+1],wt.push(new h(yt+dt*ut/c,kt-gt*ut/l));var p=Math.ceil(d/o),tt=Math.ceil(g/s),ni=0,vi=0,ot=1,st=1;p>1&&(ni=Math.floor(d-o*(p-1)),vi=Math.floor(g-s*(tt-1)),ot=ut*(o/d),st=ut*(s/g));w=!n.isZero(ni);ht=w;!w&&p>1&&(p--,tt--);ti=p-w;ii=tt-ht;ot!=st;var ct=li(yt,i[2].x,ti,ot,w),lt=li(i[1].y,ai,ii,-st,ht),ri=0,ui=0;for(w&&(ri=ci(ct,d,o),ui=ci(lt,g,s)),b=0;b<p;b++)for(k=0;k<tt;k++){var fi=ct[b],ei=ct[b+1],oi=lt[k],si=lt[k+1],ft=[new e(fi,si,it,rt),new e(fi,oi,it,rt),new e(ei,oi,it,rt),new e(ei,si,it,rt)];f.AreIntersecting(ft,wt)&&(ft.x=b,ft.y=k,at=d,vt=g,w&&(at=hi(b==p-1,o,ri),vt=hi(k==tt-1,s,ui)),v(u,ft,f._texelCornersBase,y,at,vt))}return}ii.apply(this,arguments);var t=this;this.getViewElements=function(n,r){return this.constructor.superClass.getViewElements(t,i,n,r)};this.getViewElementById=function(n,r){if(n!=null){var u=this.constructor.superClass.getViewElements(t,i,n.levelOfDetail,r);if(u!=null)return u[n.id]}return null}}function or(){function t(t,i){f.splitSquareRecursive(f.cubeSideBase,null,i.lod-n._minimumLod,null,n._viewElementsByLod[i.lod],!1,f._texelCornersBase,t,i,n._tileWidth,n._tileHeight)}ii.apply(this,arguments);var n=this;this.getViewElements=function(i,r){return this.constructor.superClass.getViewElements(n,t,i,r)};this.getViewElementById=function(i,r){if(i!=null){var u=this.constructor.superClass.getViewElements(n,t,i.levelOfDetail,r);if(u!=null)return u[i.id]}return null}}function kr(n,i){var r=8;this.getTileUrl=function(u,f,e){var c=e-r,o=new at(c,u,f,null,null),s,h;if(di.isInBounds(o)){if(o.levelOfDetail===0)if(i!=null)s=di.fromTileId(o,!0),h=i;else return null;else s=di.fromTileId(o,!1),h=t._getTileSubDomain(s);return n.replace("{quadkey}",s).replace("{subdomain}",h)}return null}}var tt={},et,n,f,r,s,vu,k,ht,ct,oi,tr;tt.debugEnabled=!1;et={clip:function(n,t,i,r){if(t.x<n.x||t.y<n.y||t.z<n.z)throw"clip bounds should have positive volume";var u={clipBounds:{x:n.x,y:n.y,z:n.z,sizeX:t.x-n.x,sizeY:t.y-n.y,sizeZ:t.z-n.z},poly:i,polyTextureCoords:r||null,polyVertexCount:i.length,clippedPoly:new Array(i.length+6),clippedPolyTextureCoords:r===undefined||r==null?null:new Array(r.length+6),clippedPolyVertexCount:0,tempVertexBuffer:new Array(i.length+6),tempTextureCoordBuffer:r===undefined||r==null?null:new Array(r.length+6),isClipped:!1};return et.clipConvexPolygonGeneral(u),u.clippedPoly.length=u.clippedPolyVertexCount,{polygon:u.clippedPoly,polygonTexture:u.clippedPolyTextureCoords,isClipped:u.isClipped}},clipConvexPolygonGeneral:function(n){var i;if(!n.clipBounds)throw"expected clip bounds option";if(n.polyVertexCount<3||n.poly==null||n.poly.length<n.polyVertexCount||n.clippedPoly==null||n.clippedPoly.length<n.polyVertexCount+6||n.tempVertexBuffer==null||n.tempVertexBuffer.length<n.polyVertexCount+6)throw"polygon arrays must have sufficient capacity";if(n.polyTextureCoords!=null&&(n.polyTextureCoords.length<n.polyVertexCount||n.clippedPolyTextureCoords==null||n.clippedPolyTextureCoords.Length<n.polyVertexCount+6||n.tempTextureCoordBuffer==null||n.tempTextureCoordBuffer.Length<n.polyVertexCount+6))throw"polygon arrays must have sufficient capacity";i=n.tempVertexBuffer;n.tempVertexBuffer=n.clippedPoly;n.clippedPoly=i;i=null;i=n.tempTextureCoordBuffer;n.tempTextureCoordBuffer=n.clippedPolyTextureCoords;n.clippedPolyTextureCoords=i;i=null;var r=n.tempVertexBuffer,e=n.tempTextureCoordBuffer,f=n.polyVertexCount,u,t,o,s;for(n.clippedPolyVertexCount=0,u=f-1,t=0;t<f;t++)o=n.poly[u].x-n.clipBounds.x*n.poly[u].w,s=n.poly[t].x-n.clipBounds.x*n.poly[t].w,n.BC0=o,n.BC1=s,n.p0Idx=u,n.p1Idx=t,n.clippedPolyCurrent=n.poly,n.clippedPolyTextureCoordsCurrent=n.polyTextureCoords,et.genericClipAgainstPlane(n),u=t;if(n.clippedPolyVertexCount!=0){for(i=r,r=n.clippedPoly,n.clippedPoly=i,i=null,i=e,e=n.clippedPolyTextureCoords,n.clippedPolyTextureCoords=i,i=null,f=n.clippedPolyVertexCount,n.clippedPolyVertexCount=0,u=f-1,t=0;t<f;t++)o=(n.clipBounds.x+n.clipBounds.sizeX)*r[u].w-r[u].x,s=(n.clipBounds.x+n.clipBounds.sizeX)*r[t].w-r[t].x,n.BC0=o,n.BC1=s,n.p0Idx=u,n.p1Idx=t,n.clippedPolyCurrent=r,n.clippedPolyTextureCoordsCurrent=e,et.genericClipAgainstPlane(n),u=t;if(n.clippedPolyVertexCount!=0){for(i=r,r=n.clippedPoly,n.clippedPoly=i,i=null,i=e,e=n.clippedPolyTextureCoords,n.clippedPolyTextureCoords=i,i=null,f=n.clippedPolyVertexCount,n.clippedPolyVertexCount=0,u=f-1,t=0;t<f;t++)o=r[u].y-n.clipBounds.y*r[u].w,s=r[t].y-n.clipBounds.y*r[t].w,n.BC0=o,n.BC1=s,n.p0Idx=u,n.p1Idx=t,n.clippedPolyCurrent=r,n.clippedPolyTextureCoordsCurrent=e,et.genericClipAgainstPlane(n),u=t;if(n.clippedPolyVertexCount!=0){for(i=r,r=n.clippedPoly,n.clippedPoly=i,i=null,i=e,e=n.clippedPolyTextureCoords,n.clippedPolyTextureCoords=i,i=null,f=n.clippedPolyVertexCount,n.clippedPolyVertexCount=0,u=f-1,t=0;t<f;t++)o=(n.clipBounds.y+n.clipBounds.sizeY)*r[u].w-r[u].y,s=(n.clipBounds.y+n.clipBounds.sizeY)*r[t].w-r[t].y,n.BC0=o,n.BC1=s,n.p0Idx=u,n.p1Idx=t,n.clippedPolyCurrent=r,n.clippedPolyTextureCoordsCurrent=e,et.genericClipAgainstPlane(n),u=t;if(n.clippedPolyVertexCount!=0){for(i=r,r=n.clippedPoly,n.clippedPoly=i,i=null,i=e,e=n.clippedPolyTextureCoords,n.clippedPolyTextureCoords=i,i=null,f=n.clippedPolyVertexCount,n.clippedPolyVertexCount=0,u=f-1,t=0;t<f;t++)o=r[u].z-n.clipBounds.z*r[u].w,s=r[t].z-n.clipBounds.z*r[t].w,n.BC0=o,n.BC1=s,n.p0Idx=u,n.p1Idx=t,n.clippedPolyCurrent=r,n.clippedPolyTextureCoordsCurrent=e,et.genericClipAgainstPlane(n),u=t;if(n.clippedPolyVertexCount!=0){for(i=r,r=n.clippedPoly,n.clippedPoly=i,i=null,i=e,e=n.clippedPolyTextureCoords,n.clippedPolyTextureCoords=i,i=null,f=n.clippedPolyVertexCount,n.clippedPolyVertexCount=0,u=f-1,t=0;t<f;t++)o=(n.clipBounds.z+n.clipBounds.sizeZ)*r[u].w-r[u].z,s=(n.clipBounds.z+n.clipBounds.sizeZ)*r[t].w-r[t].z,n.BC0=o,n.BC1=s,n.p0Idx=u,n.p1Idx=t,n.clippedPolyCurrent=r,n.clippedPolyTextureCoordsCurrent=e,et.genericClipAgainstPlane(n),u=t;n.clippedPolyCurrent=null;n.clippedPolyTextureCurrent=null}}}}}},genericClipAgainstPlane:function(n){var t;n.BC1>=0?(n.BC0<0&&(t=n.BC0/(n.BC0-n.BC1),n.clippedPoly[n.clippedPolyVertexCount]=n.clippedPolyCurrent[n.p0Idx].lerp(n.clippedPolyCurrent[n.p1Idx],t),n.clippedPolyTextureCoords!=null&&(n.clippedPolyTextureCoords[n.clippedPolyVertexCount]=n.clippedPolyTextureCoordsCurrent[n.p0Idx].lerp(n.clippedPolyTextureCoordsCurrent[n.p1Idx],t)),n.clippedPolyVertexCount++,n.isClipped=!0),n.clippedPoly[n.clippedPolyVertexCount]=n.clippedPolyCurrent[n.p1Idx],n.clippedPolyTextureCoords!=null&&(n.clippedPolyTextureCoords[n.clippedPolyVertexCount]=n.clippedPolyTextureCoordsCurrent[n.p1Idx]),n.clippedPolyVertexCount++):n.BC0>=0&&(t=n.BC0/(n.BC0-n.BC1),n.clippedPoly[n.clippedPolyVertexCount]=n.clippedPolyCurrent[n.p0Idx].lerp(n.clippedPolyCurrent[n.p1Idx],t),n.clippedPolyTextureCoords!=null&&(n.clippedPolyTextureCoords[n.clippedPolyVertexCount]=n.clippedPolyTextureCoordsCurrent[n.p0Idx].lerp(n.clippedPolyTextureCoordsCurrent[n.p1Idx],t)),n.clippedPolyVertexCount++,n.isClipped=!0)}};n={};n.zeroTolerance=1e-12;n.halfPI=Math.PI/2;n.twoPI=2*Math.PI;n.oneEightyOverPI=180/Math.PI;n.piOverOneEighty=Math.PI/180;n.isZero=function(t){return Math.abs(t)<n.zeroTolerance};n.degreesToRadians=function(t){return t*n.piOverOneEighty};n.radiansToDegrees=function(t){return t*n.oneEightyOverPI};n.normalizeRadian=function(t){while(t<0)t+=n.twoPI;while(t>=n.twoPI)t-=n.twoPI;return t};n.pickStartHeadingToTakeShortestPath=function(t,i){return Math.abs(i-t)>Math.PI?t<i?t+n.twoPI:t-n.twoPI:t};n.invSqrt=function(n){return 1/Math.sqrt(n)};n.isFinite=function(n){return n>Number.NEGATIVE_INFINITY&&n<Number.POSITIVE_INFINITY};n.clamp=function(n,t,i){return Math.min(Math.max(n,t),i)};n.logBase=function(n,t){return Math.log(n)/Math.log(t)};n.ceilLog2=function(t){return Math.ceil(n.logBase(t,2))};n.compareTo=function(n,t){return n<t?-1:n===t?0:1};n.divPow2RoundUp=function(t,i){return n.divRoundUp(t,1<<i)};n.divRoundUp=function(n,t){return Math.ceil(n/t)};n.isPowerOfTwo=function(n){return(n&n-1)==0};n.nextHighestPowerOfTwo=function(n){--n;for(var t=1;t<32;t<<=1)n=n|n>>t;return n+1};n.distanceBetweenTwoPoints=function(n,t,i,r){return Math.sqrt((i-n)*(i-n)+(r-t)*(r-t))};kt.prototype.inverse=function(){var t=this.m00*this.m11-this.m01*this.m10,n;return t==0?null:(n=1/t,new kt(n*this.m11,n*-this.m01,n*-this.m10,n*this.m00))};kt.prototype.dotMatrix2x2=function(n){return new kt(this.m00*n.m00+this.m01*n.m10,this.m00*n.m01+this.m01*n.m11,this.m10*n.m00+this.m11*n.m10,this.m10*n.m01+this.m11*n.m11)};kt.prototype.dotVector2=function(n){return new h(n.x*this.m00+n.y*this.m10,n.x*this.m01+n.y*this.m11)};kt.Identity=function(){return new kt(1,0,0,1)};i.createCopy=function(n){return new i(n.m11,n.m12,n.m13,n.m14,n.m21,n.m22,n.m23,n.m24,n.m31,n.m32,n.m33,n.m34,n.m41,n.m42,n.m43,n.m44)};i.createIdentity=function(){return new i(1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1)};i.createScale=function(n,t,r){return new i(n,0,0,0,0,t,0,0,0,0,r,0,0,0,0,1)};i.createTranslation=function(n,t,r){return new i(1,0,0,n,0,1,0,t,0,0,1,r,0,0,0,1)};i.createRotationX=function(n){return new i(1,0,0,0,0,Math.cos(n),-Math.sin(n),0,0,Math.sin(n),Math.cos(n),0,0,0,0,1)};i.createRotationY=function(n){return new i(Math.cos(n),0,Math.sin(n),0,0,1,0,0,-Math.sin(n),0,Math.cos(n),0,0,0,0,1)};i.createRotationXOut=function(n,t){t.m11=1;t.m12=0;t.m13=0;t.m14=0;t.m21=0;t.m22=Math.cos(n);t.m23=-Math.sin(n);t.m24=0;t.m31=0;t.m32=Math.sin(n);t.m33=Math.cos(n);t.m34=0;t.m41=0;t.m42=0;t.m43=0;t.m44=1};i.createRotationYOut=function(n,t){t.m11=Math.cos(n);t.m12=0;t.m13=Math.sin(n);t.m14=0;t.m21=0;t.m22=1;t.m23=0;t.m24=0;t.m31=-Math.sin(n);t.m32=0;t.m33=Math.cos(n);t.m34=0;t.m41=0;t.m42=0;t.m43=0;t.m44=1};i.createRotationZ=function(n){return new i(Math.cos(n),-Math.sin(n),0,0,Math.sin(n),Math.cos(n),0,0,0,0,1,0,0,0,0,1)};i.prototype={add:function(n){return new i(this.m11+n.m11,this.m12+n.m12,this.m13+n.m13,this.m14+n.m14,this.m21+n.m21,this.m22+n.m22,this.m23+n.m23,this.m24+n.m24,this.m31+n.m31,this.m32+n.m32,this.m33+n.m33,this.m34+n.m34,this.m41+n.m41,this.m42+n.m42,this.m43+n.m43,this.m44+n.m44)},subtract:function(n){return new i(this.m11-n.m11,this.m12-n.m12,this.m13-n.m13,this.m14-n.m14,this.m21-n.m21,this.m22-n.m22,this.m23-n.m23,this.m24-n.m24,this.m31-n.m31,this.m32-n.m32,this.m33-n.m33,this.m34-n.m34,this.m41-n.m41,this.m42-n.m42,this.m43-n.m43,this.m44-n.m44)},multiply:function(n){return new i(this.m11*n.m11+this.m12*n.m21+this.m13*n.m31+this.m14*n.m41,this.m11*n.m12+this.m12*n.m22+this.m13*n.m32+this.m14*n.m42,this.m11*n.m13+this.m12*n.m23+this.m13*n.m33+this.m14*n.m43,this.m11*n.m14+this.m12*n.m24+this.m13*n.m34+this.m14*n.m44,this.m21*n.m11+this.m22*n.m21+this.m23*n.m31+this.m24*n.m41,this.m21*n.m12+this.m22*n.m22+this.m23*n.m32+this.m24*n.m42,this.m21*n.m13+this.m22*n.m23+this.m23*n.m33+this.m24*n.m43,this.m21*n.m14+this.m22*n.m24+this.m23*n.m34+this.m24*n.m44,this.m31*n.m11+this.m32*n.m21+this.m33*n.m31+this.m34*n.m41,this.m31*n.m12+this.m32*n.m22+this.m33*n.m32+this.m34*n.m42,this.m31*n.m13+this.m32*n.m23+this.m33*n.m33+this.m34*n.m43,this.m31*n.m14+this.m32*n.m24+this.m33*n.m34+this.m34*n.m44,this.m41*n.m11+this.m42*n.m21+this.m43*n.m31+this.m44*n.m41,this.m41*n.m12+this.m42*n.m22+this.m43*n.m32+this.m44*n.m42,this.m41*n.m13+this.m42*n.m23+this.m43*n.m33+this.m44*n.m43,this.m41*n.m14+this.m42*n.m24+this.m43*n.m34+this.m44*n.m44)},multiplyOut:function(n,t){t.m11=this.m11*n.m11+this.m12*n.m21+this.m13*n.m31+this.m14*n.m41;t.m12=this.m11*n.m12+this.m12*n.m22+this.m13*n.m32+this.m14*n.m42;t.m13=this.m11*n.m13+this.m12*n.m23+this.m13*n.m33+this.m14*n.m43;t.m14=this.m11*n.m14+this.m12*n.m24+this.m13*n.m34+this.m14*n.m44;t.m21=this.m21*n.m11+this.m22*n.m21+this.m23*n.m31+this.m24*n.m41;t.m22=this.m21*n.m12+this.m22*n.m22+this.m23*n.m32+this.m24*n.m42;t.m23=this.m21*n.m13+this.m22*n.m23+this.m23*n.m33+this.m24*n.m43;t.m24=this.m21*n.m14+this.m22*n.m24+this.m23*n.m34+this.m24*n.m44;t.m31=this.m31*n.m11+this.m32*n.m21+this.m33*n.m31+this.m34*n.m41;t.m32=this.m31*n.m12+this.m32*n.m22+this.m33*n.m32+this.m34*n.m42;t.m33=this.m31*n.m13+this.m32*n.m23+this.m33*n.m33+this.m34*n.m43;t.m34=this.m31*n.m14+this.m32*n.m24+this.m33*n.m34+this.m34*n.m44;t.m41=this.m41*n.m11+this.m42*n.m21+this.m43*n.m31+this.m44*n.m41;t.m42=this.m41*n.m12+this.m42*n.m22+this.m43*n.m32+this.m44*n.m42;t.m43=this.m41*n.m13+this.m42*n.m23+this.m43*n.m33+this.m44*n.m43;t.m44=this.m41*n.m14+this.m42*n.m24+this.m43*n.m34+this.m44*n.m44},multiplyScalar:function(n){return new i(this.m11*n,this.m12*n,this.m13*n,this.m14*n,this.m21*n,this.m22*n,this.m23*n,this.m24*n,this.m31*n,this.m32*n,this.m33*n,this.m34*n,this.m41*n,this.m42*n,this.m43*n,this.m44*n)},transpose:function(){return new i(this.m11,this.m21,this.m31,this.m41,this.m12,this.m22,this.m32,this.m42,this.m13,this.m23,this.m33,this.m43,this.m14,this.m24,this.m34,this.m44)},transformVector4:function(n){var t=n.x,i=n.y,r=n.z,u=n.w;return new e(this.m11*t+this.m12*i+this.m13*r+this.m14*u,this.m21*t+this.m22*i+this.m23*r+this.m24*u,this.m31*t+this.m32*i+this.m33*r+this.m34*u,this.m41*t+this.m42*i+this.m43*r+this.m44*u)},transformVector4Out:function(n,t){var i=n.x,r=n.y,u=n.z,f=n.w;t.x=this.m11*i+this.m12*r+this.m13*u+this.m14*f;t.y=this.m21*i+this.m22*r+this.m23*u+this.m24*f;t.z=this.m31*i+this.m32*r+this.m33*u+this.m34*f;t.w=this.m41*i+this.m42*r+this.m43*u+this.m44*f},transformVector3:function(n){return new o(this.m11*n.x+this.m12*n.y+this.m13*n.z,this.m21*n.x+this.m22*n.y+this.m23*n.z,this.m31*n.x+this.m32*n.y+this.m33*n.z)},transformVector3Out:function(n,t){t.x=this.m11*n.x+this.m12*n.y+this.m13*n.z;t.y=this.m21*n.x+this.m22*n.y+this.m23*n.z;t.z=this.m31*n.x+this.m32*n.y+this.m33*n.z},determinant:function(){var n,t,i,r,u,f,e,o,s,h,c,l;return n=this.m11*this.m22-this.m12*this.m21,t=this.m11*this.m23-this.m13*this.m21,i=this.m11*this.m24-this.m14*this.m21,r=this.m12*this.m23-this.m13*this.m22,u=this.m12*this.m24-this.m14*this.m22,f=this.m13*this.m24-this.m14*this.m23,e=this.m31*this.m42-this.m32*this.m41,o=this.m31*this.m43-this.m33*this.m41,s=this.m31*this.m44-this.m34*this.m41,h=this.m32*this.m43-this.m33*this.m42,c=this.m32*this.m44-this.m34*this.m42,l=this.m33*this.m44-this.m34*this.m43,n*l-t*c+i*h+r*s-u*o+f*e},inverse:function(){var r,u,f,e,o,s,h,c,l,a,v,y,p,t,w,b,k,d,g,nt,tt,it,rt,ut,ft,et,ot,st,ht,ct;return(r=this.m11*this.m22-this.m12*this.m21,u=this.m11*this.m23-this.m13*this.m21,f=this.m11*this.m24-this.m14*this.m21,e=this.m12*this.m23-this.m13*this.m22,o=this.m12*this.m24-this.m14*this.m22,s=this.m13*this.m24-this.m14*this.m23,h=this.m31*this.m42-this.m32*this.m41,c=this.m31*this.m43-this.m33*this.m41,l=this.m31*this.m44-this.m34*this.m41,a=this.m32*this.m43-this.m33*this.m42,v=this.m32*this.m44-this.m34*this.m42,y=this.m33*this.m44-this.m34*this.m43,p=r*y-u*v+f*a+e*l-o*c+s*h,Math.abs(p)<n.zeroTolerance)?i.createIdentity():(w=this.m22*y-this.m23*v+this.m24*a,b=-this.m12*y+this.m13*v-this.m14*a,k=this.m42*s-this.m43*o+this.m44*e,d=-this.m32*s+this.m33*o-this.m34*e,g=-this.m21*y+this.m23*l-this.m24*c,nt=this.m11*y-this.m13*l+this.m14*c,tt=-this.m41*s+this.m43*f-this.m44*u,it=this.m31*s-this.m33*f+this.m34*u,rt=this.m21*v-this.m22*l+this.m24*h,ut=-this.m11*v+this.m12*l-this.m14*h,ft=this.m41*o-this.m42*f+this.m44*r,et=-this.m31*o+this.m32*f-this.m34*r,ot=-this.m21*a+this.m22*c-this.m23*h,st=this.m11*a-this.m12*c+this.m13*h,ht=-this.m41*e+this.m42*u-this.m43*r,ct=this.m31*e-this.m32*u+this.m33*r,t=1/p,new i(w*t,b*t,k*t,d*t,g*t,nt*t,tt*t,it*t,rt*t,ut*t,ft*t,et*t,ot*t,st*t,ht*t,ct*t))},toString:function(){return this.m11+", "+this.m12+", "+this.m13+", "+this.m14+"\n"+this.m21+", "+this.m22+", "+this.m23+", "+this.m24+"\n"+this.m31+", "+this.m32+", "+this.m33+", "+this.m34+"\n"+this.m41+", "+this.m42+", "+this.m43+", "+this.m44+"\n"},pullToZero:function(){Math.abs(this.m11)<n.zeroTolerance&&(this.m11=0);Math.abs(this.m12)<n.zeroTolerance&&(this.m12=0);Math.abs(this.m13)<n.zeroTolerance&&(this.m13=0);Math.abs(this.m14)<n.zeroTolerance&&(this.m14=0);Math.abs(this.m21)<n.zeroTolerance&&(this.m21=0);Math.abs(this.m22)<n.zeroTolerance&&(this.m22=0);Math.abs(this.m23)<n.zeroTolerance&&(this.m23=0);Math.abs(this.m24)<n.zeroTolerance&&(this.m24=0);Math.abs(this.m31)<n.zeroTolerance&&(this.m31=0);Math.abs(this.m32)<n.zeroTolerance&&(this.m32=0);Math.abs(this.m33)<n.zeroTolerance&&(this.m33=0);Math.abs(this.m34)<n.zeroTolerance&&(this.m34=0);Math.abs(this.m41)<n.zeroTolerance&&(this.m41=0);Math.abs(this.m42)<n.zeroTolerance&&(this.m42=0);Math.abs(this.m43)<n.zeroTolerance&&(this.m43=0);Math.abs(this.m44)<n.zeroTolerance&&(this.m44=0)},flattenColumnMajor:function(){return[this.m11,this.m21,this.m31,this.m41,this.m12,this.m22,this.m32,this.m42,this.m13,this.m23,this.m33,this.m43,this.m14,this.m24,this.m34,this.m44]},flattenRowMajor:function(){return[this.m11,this.m12,this.m13,this.m14,this.m21,this.m22,this.m23,this.m24,this.m31,this.m32,this.m33,this.m34,this.m41,this.m42,this.m43,this.m44]}};yt.createFromPoints=function(n,t,i){var f=t.subtract(n),e=i.subtract(n),r=f.cross(e),u;return r=r.normalize(),u=-1*(r.x*n.x+r.y*n.y+r.z*n.z),new yt(r.x,r.y,r.z,u,null)};yt.createFromPointAndNormal=function(n,t){var i=-1*(t.x*n.x+t.y*n.y+t.z*n.z);return new yt(t.x,t.y,t.z,i,n)};yt.intersectWithRay=function(t,i){var u,r;if(i.point===null)throw"requires plane.point to not equal null";return(u=t.direction.dot(i.normal),n.isZero(u))?null:(r=i.point.subtract(t.origin).dot(i.normal)/t.direction.dot(i.normal),r<=0)?null:t.origin.add(t.direction.multiplyScalar(r))};yt.prototype={transformNormal:function(n){var i=n.inverse().transpose(),t=i.transformVector3(this.normal);return new o(t.x,t.y,t.z)},toString:function(){return"A:"+this.a+", B:"+this.b+", C:"+this.c+", D:"+this.d}};a.createIdentity=function(){return new a(1,0,0,0)};a.fromRotationMatrix=function(t){var f,r,i,u;if(i=new a(0,0,0,0),f=t.m11+t.m22+t.m33,f>n.zeroTolerance)i.w=Math.sqrt(f+1)*.5,r=1/(4*i.w),i.x=(t.m32-t.m23)*r,i.y=(t.m13-t.m31)*r,i.z=(t.m21-t.m12)*r;else{u=0;t.m22>t.m11?(u=1,t.m33>t.m22&&(u=2)):t.m33>t.m11&&(u=2);switch(u){case 0:i.x=.5*Math.sqrt(t.m11-t.m22-t.m33+1);r=1/(4*i.x);i.w=(t.m32-t.m23)*r;i.y=(t.m12+t.m21)*r;i.z=(t.m13+t.m31)*r;break;case 1:i.y=.5*Math.sqrt(t.m22-t.m11-t.m33+1);r=1/(4*i.y);i.w=(t.m13-t.m31)*r;i.x=(t.m12+t.m21)*r;i.z=(t.m23+t.m32)*r;break;case 2:i.z=.5*Math.sqrt(t.m33-t.m11-t.m22+1);r=1/(4*i.z);i.w=(t.m21-t.m12)*r;i.x=(t.m13+t.m31)*r;i.y=(t.m32+t.m23)*r}}return i};a.fromAxisAngle=function(n,t){var r,i;return r=.5*t,i=Math.sin(r),new a(Math.cos(r),n.x*i,n.y*i,n.z*i)};a.fromAxisAngleOut=function(n,t,i){var u,r;u=.5*t;r=Math.sin(u);i.w=Math.cos(u);i.x=n.x*r;i.y=n.y*r;i.z=n.z*r};a.slerp=function(t,i,r){var e,u,o,f,s,h;return t===0?i:t>=1?r:(e=i.dot(r),u=Math.acos(e),Math.abs(u)>=n.zeroTolerance)?(o=Math.sin(u),f=1/o,s=Math.sin((1-t)*u)*f,h=Math.sin(t*u)*f,i.multiplyScalar(s).add(r.multiplyScalar(h))):i};a.prototype={dot:function(n){return this.w*n.w+this.x*n.x+this.y*n.y+this.z*n.z},length:function(){return Math.sqrt(this.w*this.w+this.x*this.x+this.y*this.y+this.z*this.z)},normalize:function(){var i,t;return(i=this.length(),i<n.zeroTolerance)?new a(0,0,0,0):(t=1/i,new a(this.w*t,this.x*t,this.y*t,this.z*t))},inverse:function(){var i,t;return(i=this.w*this.w+this.x*this.x+this.y*this.y*this.z*this.z,Math.abs(i)>n.zeroTolerance)?(t=1/i,new a(this.w*t,-this.x*t,-this.y*t,-this.z*t)):new a(0,0,0,0)},conjugate:function(){return new a(this.w,-this.x,-this.y,-this.z)},transform:function(n){var i,r,t;return r=2*(this.x*n.x+this.y*n.y+this.z*n.z),t=2*this.w,i=t*this.w-1,new o(i*n.x+r*this.x+t*(this.y*n.z-this.z*n.y),i*n.y+r*this.y+t*(this.z*n.x-this.x*n.z),i*n.z+r*this.z+t*(this.x*n.y-this.y*n.x))},transformOut:function(n,t){var r,u,i;u=2*(this.x*n.x+this.y*n.y+this.z*n.z);i=2*this.w;r=i*this.w-1;t.x=r*n.x+u*this.x+i*(this.y*n.z-this.z*n.y);t.y=r*n.y+u*this.y+i*(this.z*n.x-this.x*n.z);t.z=r*n.z+u*this.z+i*(this.x*n.y-this.y*n.x)},add:function(n){return new a(this.w+n.w,this.x+n.x,this.y+n.y,this.z+n.z)},multiply:function(n){return new a(this.w*n.w-this.x*n.x-this.y*n.y-this.z*n.z,this.y*n.z-this.z*n.y+this.w*n.x+n.w*this.x,this.z*n.x-this.x*n.z+this.w*n.y+n.w*this.y,this.x*n.y-this.y*n.x+this.w*n.z+n.w*this.z)},multiplyOut:function(n,t){t.w=this.w*n.w-this.x*n.x-this.y*n.y-this.z*n.z;t.x=this.y*n.z-this.z*n.y+this.w*n.x+n.w*this.x;t.y=this.z*n.x-this.x*n.z+this.w*n.y+n.w*this.y;t.z=this.x*n.y-this.y*n.x+this.w*n.z+n.w*this.z},multiplyScalar:function(n){return new a(this.w*n,this.x*n,this.y*n,this.z*n)},toRotationMatrix:function(){var r,t,n,u,f,e,o,s,h,c,l,a;return r=2*this.x,t=2*this.y,n=2*this.z,u=r*this.w,f=t*this.w,e=n*this.w,o=r*this.x,s=t*this.x,h=n*this.x,c=t*this.y,l=n*this.y,a=n*this.z,new i(1-(c+a),s-e,h+f,0,s+e,1-(o+a),l-u,0,h-f,l+u,1-(o+c),0,0,0,0,1)},toAxisAngle:function(){var i,t;return(i=this.x*this.x+this.y*this.y+this.z*this.z,i>n.zeroTolerance)?(t=n.invSqrt(i),new e(this.x*t,this.y*t,this.z*t,2*Math.acos(this.w))):new e(1,0,0,0)},toString:function(){return"["+this.w+", "+this.x+", "+this.y+", "+this.z+"]"}};tu.prototype={intersect:function(n){if(this.intersectsWith(n)){var t=Math.max(this.x,n.x),i=Math.max(this.y,n.y);this.width=Math.max(Math.min(this.x+this.width,n.x+n.width)-t,0);this.height=Math.max(Math.min(this.y+this.height,n.y+n.height)-i,0);this.x=t;this.y=i}else this.x=this.y=this.width=this.height=0},intersectsWith:function(n){return this.width<0||n.width<0?!1:n.x<=this.x+this.width&&n.x+n.width>=this.x&&n.y<=this.y+this.height&&n.y+n.height>=this.y},getLeft:function(){return this.x},getRight:function(){return this.x+this.width},getTop:function(){return this.y},getBottom:function(){return this.y+this.height}};h.clone=function(n){return new h(n.x,n.y)};h.prototype={dot:function(n){return this.x*n.x+this.y*n.y},perp:function(){return new h(this.y,-this.x)},normalize:function(){var t,i;return(t=this.length(),t<n.zeroTolerance)?new h(0,0):(i=1/t,new h(this.x*i,this.y*i))},length:function(){return Math.sqrt(this.x*this.x+this.y*this.y)},lengthSquared:function(){return this.x*this.x+this.y*this.y},add:function(n){return new h(this.x+n.x,this.y+n.y)},subtract:function(n){return new h(this.x-n.x,this.y-n.y)},multiplyScalar:function(n){return new h(this.x*n,this.y*n)},equals:function(n){return this.x===n.x&&this.y===n.y},lerp:function(n,t){return new h(this.x+t*(n.x-this.x),this.y+t*(n.y-this.y))},toString:function(){return"["+this.x+", "+this.y+"]"}};o.createFromVector2=function(n,t){return new o(n.x,n.y,t)};o.clone=function(n){return new o(n.x,n.y,n.z)};o.prototype={dot:function(n){return this.x*n.x+this.y*n.y+this.z*n.z},normalize:function(){var i,t;return(i=this.length(),i<n.zeroTolerance)?new o(0,0,0):(t=1/i,new o(this.x*t,this.y*t,this.z*t))},normalizeOut:function(t){var r,i;if(r=this.length(),r<n.zeroTolerance){t.x=0;t.y=0;t.z=0;return}i=1/r;t.x=this.x*i;t.y=this.y*i;t.z=this.z*i;return},cross:function(n){return new o(this.y*n.z-this.z*n.y,this.z*n.x-this.x*n.z,this.x*n.y-this.y*n.x)},crossOut:function(n,t){t.x=this.y*n.z-this.z*n.y;t.y=this.z*n.x-this.x*n.z;t.z=this.x*n.y-this.y*n.x},length:function(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z)},lengthSquared:function(){return this.x*this.x+this.y*this.y+this.z*this.z},add:function(n){return new o(this.x+n.x,this.y+n.y,this.z+n.z)},subtract:function(n){return new o(this.x-n.x,this.y-n.y,this.z-n.z)},subtractOut:function(n,t){t.x=this.x-n.x;t.y=this.y-n.y;t.z=this.z-n.z},multiplyScalar:function(n){return new o(this.x*n,this.y*n,this.z*n)},multiplyScalarOut:function(n,t){t.x=this.x*n;t.y=this.y*n;t.z=this.z*n},equals:function(n){return this.x===n.x&&this.y===n.y&&this.z===n.z},lerp:function(n,t){return new o(this.x+t*(n.x-this.x),this.y+t*(n.y-this.y),this.z+t*(n.z-this.z))},toString:function(){return"["+this.x+", "+this.y+", "+this.z+"]"}};e.createFromVector3=function(n){return new e(n.x,n.y,n.z,1)};e.prototype={dot:function(n){return this.x*n.x+this.y*n.y+this.z*n.z+this.w*n.w},normalize:function(){var i,t;return(i=this.length(),i<n.zeroTolerance)?new e(0,0,0,0):(t=1/i,new e(this.x*t,this.y*t,this.z*t,this.w*t))},length:function(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w)},lengthSquared:function(){return this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w},add:function(n){return new e(this.x+n.x,this.y+n.y,this.z+n.z,this.w+n.w)},subtract:function(n){return new e(this.x-n.x,this.y-n.y,this.z-n.z,this.w-n.w)},multiplyScalar:function(n){return new e(this.x*n,this.y*n,this.z*n,this.w*n)},equals:function(n){return this.x===n.x&&this.y===n.y&&this.z===n.z&&this.w===n.w},lerp:function(n,t){return new e(this.x+t*(n.x-this.x),this.y+t*(n.y-this.y),this.z+t*(n.z-this.z),this.w+t*(n.w-this.w))},toString:function(){return"["+this.x+", "+this.y+", "+this.z+", "+this.w+"]"}};f={};f.rotatedPos=new o(0,0,0);f.viewSide=new o(0,0,0);f.viewUp=new o(0,0,0);f.createLookAtRHOut=function(n,t,i,r){var e=f.rotatedPos,o=f.viewSide,u=f.viewUp;t.normalizeOut(t);i.normalizeOut(i);t.multiplyScalarOut(i.dot(t),u);i.subtractOut(u,u);u.normalizeOut(u);t.crossOut(u,o);r.m11=o.x;r.m12=o.y;r.m13=o.z;r.m21=u.x;r.m22=u.y;r.m23=u.z;r.m31=-t.x;r.m32=-t.y;r.m33=-t.z;r.transformVector3Out(n,e);r.m14=-e.x;r.m24=-e.y;r.m34=-e.z};f.createPerspective=function(n,t,r,u,f){var e;return e=1/Math.tan(n/2),new i(e/t,0,f.x*2,0,0,e,f.y*2,0,0,0,u/(u-r),-(r*u)/(u-r),0,0,-1,0)};f.createPerspectiveFromFrustumOut=function(n,t,i,r,u,f,e){e.m11=2*u/(t-n);e.m12=0;e.m13=(t+n)/(t-n);e.m14=0;e.m21=0;e.m22=2*u/(r-i);e.m23=(r+i)/(r-i);e.m24=0;e.m31=0;e.m32=0;e.m33=-1*(f+u)/(f-u);e.m34=-2*f*u/(f-u);e.m41=0;e.m42=0;e.m43=-1;e.m44=0};f.createPerspectiveOGLOut=function(n,t,i,r,u){var e=i*Math.tan(n/2),o=-e,s=o*t,h=e*t,c=i,l=r;f.createPerspectiveFromFrustumOut(s,h,o,e,c,l,u)};f.projectOntoPlane=function(n,t){var r=n,u=t.normal,f=t.d,e=u.dot(r),o=e+f-r.x*u.x,s=-r.x*u.y,h=-r.x*u.z,c=-r.x*f,l=-r.y*u.x,a=e+f-r.y*u.y,v=-r.y*u.z,y=-r.y*f,p=-r.z*u.x,w=-r.z*u.y,b=e+f-r.z*u.z,k=-r.z*f,d=-u.x,g=-u.y,nt=-u.z,tt=e;return new i(o,s,h,c,l,a,v,y,p,w,b,k,d,g,nt,tt)};f.createViewportToScreen=function(n,t){var r=i.createIdentity();return r.m11=n/2,r.m12=0,r.m13=0,r.m14=0,r.m21=0,r.m22=t/-2,r.m23=0,r.m24=0,r.m31=0,r.m32=0,r.m33=1,r.m34=0,r.m41=n/2,r.m42=t/2,r.m43=0,r.m44=1,r.transpose()};f.parseQuaternion=function(t,i,r){var u=1-(t*t+i*i+r*r);return u<n.zeroTolerance&&(u=0),new a(Math.sqrt(u),t,i,r)};f._halfCube=.5;f._halfCubeSquared=f._halfCube*f._halfCube;f._cubeSide=f._halfCube*2;f._dummyCornerBase=[new e(0,1,0,1),new e(0,0,0,1),new e(1,0,0,1),new e(1,1,0,1)];f.cubeSideBase=[new e(0,0,0,1),new e(0,f._cubeSide,0,1),new e(f._cubeSide,f._cubeSide,0,1),new e(f._cubeSide,0,0,1)];f._texelCornersBase=[new e(0,1,0,1),new e(0,0,0,1),new e(1,0,0,1),new e(1,1,0,1)];f.splitSquareRecursive=function(n,t,i,r,u,o,s,h,c,l,a){function it(n,t,i){var a=n[0],b=n[1],k=n[2],d=n[3],u=-1,v=null,y=null,p=null,w=null,r=f.splitFunction;i?(v=i[0],y=i[1],p=i[2],w=i[3]):(v=f._dummyCornerBase[0],y=f._dummyCornerBase[1],p=f._dummyCornerBase[2],w=f._dummyCornerBase[3]);var ot=a.x,st=a.y,ht=a.z,o=a.w,ct=v.x,lt=v.y,at=b.x,vt=b.y,ft=b.z,yt=y.x,pt=y.y,wt=k.x,bt=k.y,kt=k.z,dt=p.x,gt=p.y,ni=d.x,ti=d.y,et=d.z,ii=w.x,ri=w.y,g=r(t,ot,at,ct,yt),s=r(t,st,vt,lt,pt),ui=r(t,ht,ft,u,u),h=r(t,at,wt,yt,dt),nt=r(t,vt,bt,pt,gt),fi=r(t,ft,kt,u,u),tt=r(t,wt,ni,dt,ii),c=r(t,bt,ti,gt,ri),ei=r(t,kt,et,u,u),l=r(t,ot,ni,ct,ii),it=r(t,st,ti,lt,ri),oi=r(t,ht,et,u,u),si=r(t,h.xy,l.xy,h.uv,l.uv),hi=r(t,s.xy,c.xy,s.uv,c.uv),ci=r(t,ft,et,u,u),rt=new e(si.xy,hi.xy,ci.xy,o),ut=new e(si.uv,hi.uv,0,1);return{xy:[[a,new e(g.xy,s.xy,ui.xy,o),rt,new e(l.xy,it.xy,oi.xy,o)],[new e(g.xy,s.xy,ui.xy,o),b,new e(h.xy,nt.xy,fi.xy,o),rt],[rt,new e(h.xy,nt.xy,fi.xy,o),k,new e(tt.xy,c.xy,ei.xy,o)],[new e(l.xy,it.xy,oi.xy,o),rt,new e(tt.xy,c.xy,ei.xy,o),d]],uv:i?[[v,new e(g.uv,s.uv,0,1),ut,new e(l.uv,it.uv,0,1)],[new e(g.uv,s.uv,0,1),y,new e(h.uv,nt.uv,0,1),ut],[ut,new e(h.uv,nt.uv,0,1),p,new e(tt.uv,c.uv,0,1)],[new e(l.uv,it.uv,0,1),ut,new e(tt.uv,c.uv,0,1),w]]:null}}var v,y,k;if(h||(h=function(n,t,i){n.squares.push(t);n.texelSquares.push(i)}),n.length!=4)throw"Invalid square array supplied.";if(i==0){var p=n[0],w=n[2],d=o?(p.x+w.x)/2:p.x,g=o?(w.y+p.y)/2:w.y;n.x=r?Math.floor((d-r.initialX)/r.widthFr):0;n.y=r?Math.floor(r.total-(g-r.initialY)/r.heightFr):0;u&&h(u,n,t||s,c,l,a);return}var b=n[0],nt=n[1],tt=n[3];for(r=r||function(){var n=Math.pow(2,i),t=b.x,r=b.y;return{total:n,widthFr:Math.abs((tt.x-t)/n),heightFr:Math.abs((nt.y-r)/n),initialX:t,initialY:r}}(),v=it(n,o,t),i--,y=0,k=v.xy.length;y<k;y++)f.splitSquareRecursive(v.xy[y],v.uv?v.uv[y]:null,i,r,u,o,s,h,c,l,a);return};f.splitFunction=function(n,t,i,r,u){function e(n,t,i,r,u){var f=Math.sqrt(u+n*n),e=Math.sqrt(u+t*t),o=e/(f+e),s=f/(f+e);return{xy:n*o+t*s,uv:i*o+r*s}}function o(n,t,i,r){return{xy:(n+t)/2,uv:(i+r)/2}}return n?e(t,i,r,u,f._halfCubeSquared):o(t,i,r,u)};f.CalculatePolyArea=function(n,t){var i=t?[]:n,f=0,r,o,e,u;if(t)for(e=0;e<n.length;e++)r=n[e],i.push(new h(r.x*t.width,r.y*t.height));for(u=0;u<i.length-1;u++)r=i[u],o=i[u+1],f+=r.x*o.y-o.x*r.y;return f+=i[i.length-1].x*i[0].y-i[0].x*i[i.length-1].y,f/=2,Math.abs(f)};f.AreIntersecting=function(t,i){function v(n,t){for(var r,i=null,u=0;u<n.length;u++)r=n[u].x*t.x+n[u].y*t.y,i==null&&(i={min:r,max:r}),r<i.min?i.min=r:r>i.max&&(i.max=r);return i}function y(n){for(var f=[],i=n.length-1,t=0;t<n.length;t++){var r=n[t].x-n[i].x,u=n[t].y-n[i].y,e=Math.sqrt(r*r+u*u),o={x:r/e,y:-u/e};i=t;f.push(o)}return f}var p=y(t),w=y(i),r=p.concat(w),u,s,f,h,a,e,o,c,l;n:for(u=0;u<r.length;u++)for(s=r[u],f=u+1;f<r.length-1;f++)if(h=r[f],a=n.isZero(1-Math.abs(s.x*h.x+s.y*h.y)),a){delete r[u];continue n}for(e=0;e<r.length;e++)if((o=r[e],o)&&(c=v(t,o),l=v(i,o),c.max<l.min||l.max<c.min))return!1;return!0};f.applyWorldTransformation=function(n,t){for(var r=[],u=n.length,i=0;i<u;i++)r.push(t.transformVector4(n[i]));return r};f.calculateTexelToPixelRatioAtFov=function(n,t,i,r){var u=n*Math.tan(r/2);return t*u/i};f.calculateFovAtTexelToPixelRatio=function(n,t,i,r){return Math.atan(r*i/(t*n))*2};var rt={debug:!1,forceIERenderPath:!0,outputMultiLODTiles:!0,scanConvertSize:40,polyInflate:.05},yu={floodFill:function(n,t,i,r){var o,s,c,u,f,h,e;if(this.cachedCrossings={},r==null){if(i.length==0)return[];r=this.calculateStartingTile(n,t,i)}for(o=[r],s=new Array(n*t),s[r.y*n+r.x]=!0,c=[];o.length>0;)for(u=o.shift(),c.push(u),f=[],(this.tileCenterInPolygon(u,i)||this.gridCrossesPolygon(u,i))&&(f.push(this.getLeftNeighbor(u)),f.push(this.getRightNeighbor(u)),f.push(this.getTopNeighbor(u)),f.push(this.getBottomNeighbor(u))),h=0;h<f.length;h++)e=f[h],this.isValidTile(e,n,t)&&!s[e.y*n+e.x]&&(o.push(e),s[e.y*n+e.x]=!0);return c},calculateStartingTile:function(n,t,i){for(var r={x:0,y:0},u=0;u<i.length;u++)r.x+=i[u].x,r.y+=i[u].y;return r.x/=i.length,r.y/=i.length,r.x=Math.floor(r.x),r.y=Math.floor(r.y),r.x=Math.max(0,r.x),r.y=Math.max(0,r.y),r.x=Math.min(n-1,r.x),r.y=Math.min(t-1,r.y),r},getLeftNeighbor:function(n){return{x:n.x-1,y:n.y}},getRightNeighbor:function(n){return{x:n.x+1,y:n.y}},getTopNeighbor:function(n){return{x:n.x,y:n.y-1}},getBottomNeighbor:function(n){return{x:n.x,y:n.y+1}},tileCenterInPolygon:function(n,t){return this.pointInPolygon({x:n.x+.5,y:n.y+.5},t)},isValidTile:function(n,t,i){return isNaN(n.x)||isNaN(n.y)||n.x<0||n.y<0||n.x>=t||n.y>=i?!1:!0},normalizeNumber:function(n){return n>=0?1:-1},gridCrossesPolygon:function(n,t){var i={x:n.x+1,y:n.y},r={x:n.x+1,y:n.y+1},u={x:n.x,y:n.y+1};return this.countCrossings(n,t,null,null)!==this.countCrossings(i,t,null,null)?!0:this.countCrossings(u,t,null,null)!==this.countCrossings(r,t,null,null)?!0:this.countCrossings(n,t,!0,null)!==this.countCrossings(u,t,!0,null)?!0:this.countCrossings(i,t,!0,null)!==this.countCrossings(r,t,!0,null)?!0:!1},pointInPolygon:function(n,t){var i=this.countCrossings(n,t,!0,null);return i%2==1},cachedCrossings:{},countCrossings:function(n,t,i,r){var f=[],u,e,o=0,s,p,w;if(!r&&(s=n.x+","+n.y+(i?",down":",right"),this.cachedCrossings[s]!=null))return this.cachedCrossings[s];if(i)for(u=0;u<t.length;u++)f.push({x:t[u].y-n.y,y:t[u].x-n.x});else for(u=0;u<t.length;u++)f.push({x:t[u].x-n.x,y:t[u].y-n.y});for(u=0;u<f.length;u++){e=u+1;e>=f.length&&(e=0);var h=f[u].y,l=f[e].y,c=f[u].x,a=f[e].x,b=this.normalizeNumber(h),k=this.normalizeNumber(l),v=this.normalizeNumber(c),y=this.normalizeNumber(a);b!=k&&(v===1&&y===1?o++:v!==y&&(p=(h-l)/(c-a),w=h-p*c,w>=0&&o++))}return this.cachedCrossings[s]=o,o}},si=window.requestAnimationFrame||window.msRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.webkitRequestAnimationFrame||function(n){Microsoft.Maps.setTimeout(n,1e3/60)},lr=window.cancelAnimationFrame||window.webkitCancelRequestAnimationFrame||window.mozCancelRequestAnimationFrame||window.oCancelRequestAnimationFrame||window.msCancelRequestAnimationFrame||clearTimeout;r={getCssColorString:function(n){return r.getCssColorStringRGBA(n.r,n.g,n.b,n.a)},getCssColorStringRGBA:function(n,t,i,r){return"rgba("+n*255+","+t*255+","+i*255+","+r+")"},deleteFromArray:function(n,t){for(var i=0,r=n.length;i<r;)t(n[i])&&n.splice(i,1),i++},log:function(n){window.console&&tt.debugEnabled&&window.console.log(n)},_eventListeners:{},bind:function(n,t,i,u){for(var e=t.split(" "),f=0;f<e.length;++f)t=e[f],r._eventListeners[n]||(r._eventListeners[n]={}),r._eventListeners[n][t]||(r._eventListeners[n][t]=[]),n.addEventListener?(t=="mousewheel"&&n.addEventListener("DOMMouseScroll",i,u),n.addEventListener(t,i,u)):n.attachEvent&&(n.attachEvent("on"+t,i),u&&n.setCapture&&n.setCapture()),r._eventListeners[n][t].push([i,u])},_unbindAll:function(n){var t,i;if(r._eventListeners[n])for(t in r._eventListeners[n])for(i=0;i<r._eventListeners[n][t].length;++i)r.unbind(n,t,r._eventListeners[n][t][i][0],r._eventListeners[n][t][i][1])},unbind:function(n,t,i,u){if(n&&!t)r._unbindAll(n);else{for(var f,h,o,s=t.split(" "),e=0;e<s.length;++e)if(t=s[e],n.removeEventListener?(t=="mousewheel"&&n.removeEventListener("DOMMouseScroll",i,u),n.removeEventListener(t,i,u)):n.detachEvent&&(n.detachEvent("on"+t,i),u&&n.releaseCapture&&n.releaseCapture()),r._eventListeners[n]&&r._eventListeners[n][t]){for(f=0;f<r._eventListeners[n][t].length;++f)r._eventListeners[n][t][f][0]===i&&r._eventListeners[n][t][f].splice(f,1);r._eventListeners[n][t].length===0&&delete r._eventListeners[n][t]}if(o=0,r._eventListeners[n]){for(h in r._eventListeners[n])++o;o===0&&delete r._eventListeners[n]}}},setOpacity:function(){function t(n,t){n.style.opacity=t}function i(n,t){t*=100;var i;try{i=n.filters.item("DXImageTransform.Microsoft.Alpha");t<100?(i.Opacity=t,i.enabled||(i.enabled=!0)):i.enabled=!1}catch(r){t<100&&(n.style.filter=(n.currentStyle||n.runtimeStyle).filter+" progid:DXImageTransform.Microsoft.Alpha(opacity="+t+")")}}var n=document.createElement("div");return typeof n.style.opacity!="undefined"&&t||typeof n.style.filter!="undefined"&&i||function(){}}(),css:function(n,t){for(var i in t)t.hasOwnProperty(i)&&(i==="opacity"?r.setOpacity(n,t[i]):n.style[i]=t[i])},getWheelDelta:function(n){return n.detail?n.detail*-1:n.wheelDelta/40},isDataUrl:function(n){return/^data:/.test(n)},isRelativeUrl:function(n){var t=/^ftp:\/\//.test(n)||/^http:\/\//.test(n)||/^https:\/\//.test(n)||/^file:\/\//.test(n);return!t},hostnameRegexp:new RegExp("^(?:f|ht)tp(?:s)?://([^/]+)","im"),filehostnameRegexp:new RegExp("^file://([^/]+)","im"),getHostname:function(n){var t=r.hostnameRegexp.exec(n);return t&&t.length===2||(t=r.filehostnameRegexp.exec(n)),t&&t.length===2?t[1].toString():""},areSameDomain:function(n,t){var i=r.getHostname(n).toLowerCase(),u=r.getHostname(t).toLowerCase();return i===u},addScriptElement:function(n){var t=document.createElement("script");t.type="text/javascript";t.language="javascript";t.src=n;document.getElementsByTagName("head")[0].appendChild(t)},partialDotNetStringFormat:function(n){var t,o,u,f,s,i,e,r;if(arguments.length===0)return"";if(arguments.length===1)return n;for(t="",o=0;o<n.length;){if(u=n.indexOf("{"),u===-1)return t+n;if(t+=n.substr(0,u),n=n.substr(u),f=n.indexOf("}"),f<2,s=n.substr(1,f-1),n=n.substr(f+1),i=s.split(":"),e=arguments[parseInt(i[0])+1],i.length===1)t+=e.toString();else if(i[1]==="X")t+=e.toString(16).toUpperCase();else{for(r=e.toString();r.length<i[1].length;)r="0"+r;t+=r}}return t}};ft.prototype.map={};ft.prototype._innerArray=[];ft.prototype._changed=!0;ft.prototype.add=function(n,t){this.map[n]=t;this._changed=!0};ft.prototype.remove=function(n){this._changed|=!!this.map[n];delete this.map[n]};ft.prototype.getArray=function(){var n=this._innerArray,t,i;if(this._changed){t=this.map;n.length=0;for(i in t)n.push(t[i]);this._changed=!1}return n};ft.prototype.dispose=function(){this.map=null;this._innerArray.length=0;this._innerArray=null};s={};s.getFlattening=function(){return 1/298.257222101};s.getEccentricity2=function(){return s.getFlattening()*(2-s.getFlattening())};s.getInvOneMinusEcc=function(){return 1/(1-s.getEccentricity2())};s.getMajorRadiusInUnits=function(){return 6378137};s.fromLatLongAlt=function(t,i,r){var e=n.degreesToRadians(t),h=n.degreesToRadians(i),u=Math.sin(e),c=Math.cos(e),l=Math.sin(h),a=Math.cos(h),f=s.getMajorRadiusInUnits()/Math.sqrt(1-s.getEccentricity2()*u*u);return new o((f+r)*c*a,(f+r)*c*l,(f*(1-s.getEccentricity2())+r)*u)};s.toLatLongAlt=function(t){if(t.x==0&&t.y==0&&t.z==0)return new o(0,0,0);var h,c,u,f=Math.sqrt(t.x*t.x+t.y*t.y),r=t.z,i,e,a,v,l;return(v=Math.atan2(t.y,t.x),isNaN(v)&&(v=Math.atan2(t.y,t.x),isNaN(v)))?new o(0,0,0):(i=f*(1-s.getFlattening()),e=1/Math.sqrt(r*r+i*i),a=Math.atan2(r,i),h=r*e,c=i*e,u=s.getMajorRadiusInUnits(),l=f>1?f/c-u:t.z>0?t.z-s.getMajorRadiusInUnits()*(1-s.getFlattening()):-t.z-s.getMajorRadiusInUnits()*(1-s.getFlattening()),i=f*(1-s.getEccentricity2()*u/(u+l)),e=1/Math.sqrt(r*r+i*i),a=Math.atan2(r,i),h=r*e,c=i*e,u=s.getMajorRadiusInUnits()/Math.sqrt(1-s.getEccentricity2()*h*h),l=f>1?f/c-u:t.z>0?t.z-s.getMajorRadiusInUnits()*(1-s.getFlattening()):-t.z-s.getMajorRadiusInUnits()*(1-s.getFlattening()),i=f*(1-s.getEccentricity2()*u/(u+l)),e=1/Math.sqrt(r*r+i*i),a=Math.atan2(r,i),h=r*e,c=i*e,u=s.getMajorRadiusInUnits()/Math.sqrt(1-s.getEccentricity2()*h*h),l=f>1?f/c-u:t.z>0?t.z-s.getMajorRadiusInUnits()*(1-s.getFlattening()):-t.z-s.getMajorRadiusInUnits()*(1-s.getFlattening()),i=f*(1-s.getEccentricity2()*u/(u+l)),e=1/Math.sqrt(r*r+i*i),a=Math.atan2(r,i),h=r*e,c=i*e,u=s.getMajorRadiusInUnits()/Math.sqrt(1-s.getEccentricity2()*h*h),l=f>1?f/c-u:t.z>0?t.z-s.getMajorRadiusInUnits()*(1-s.getFlattening()):-t.z-s.getMajorRadiusInUnits()*(1-s.getFlattening()),new o(n.radiansToDegrees(a),n.radiansToDegrees(v),l))};s.getSurfaceNormalFromLatLong=function(n,t){var i=s.fromLatLongAlt(n,t,0);return i.z*=s.getInvOneMinusEcc(),i.normalize()};s.getSurfaceNormalFromPoint=function(n){var t=s.toLatLongAlt(n);return s.getSurfaceNormalFromLatLong(t.x,t.y)};s.getLocalToGlobalRotation=function(t,r){var u=i.createRotationX(Math.PI-t),f=i.createRotationZ(n.halfPI+r),e=i.createRotationY(Math.PI);return f.multiply(u).multiply(e)};s.getGlobalToLocalRotation=function(n,t){return s.getLocalToGlobalRotation(n,t).inverse()};yi.prototype.GetVertex=function(n){return this._vertexCache=this._vertexCache||new Array(this.geometryPolyArr.length),this._vertexCache[n]===undefined&&(this._vertexCache[n]={g:this.screenArray[n],t:this.textureArray[n]}),this._vertexCache[n]};ut.Wrap={CLAMP_TO_EDGE:1,REPEAT:2};ut.Filter={NEAREST:0,LINEAR:1,LINEAR_MIPMAP_LINEAR:2};c(ut,Object);ut.prototype.loadImageInDOM=function(){this._image=new Image;var n=this;this._image.onload=function(){n._loadCallback&&n._loadCallback(n._url,n._loadCallbackInfo,n);n._isReady=!0;n._isDirty=!0};this._image.crossOrigin="";this._image.src=this._url};c(dt,Object);dt.prototype.apply=function(){throw"You should not have reached base Material.apply().";};c(gi,dt);c(nr,i);nr.prototype.apply=function(){throw"You should not have reached base Transform.apply().";};c(yr,Object);vu=function(){var n=Date.now();return function(){return++n,n}}();c(y,Object);y.prototype.render=function(){throw"The renderer you are using does not implement the render() method.";};y.prototype.setViewModel=function(n){this._viewModel=n};y.prototype._checkColor=function(n){if(!n||n.r==null||n.g==null||n.b==null||n.a==null)throw"Color must include r,g,b,a numeric properties.";};y.prototype.setBackGroundColor=function(n){n?(this._checkColor(n),this._backgroundDiv.style.display="block",this._backgroundDiv.style.backgroundColor=r.getCssColorString(n)):this._backgroundDiv.style.display="none"};y.prototype._updateBackgroundSize=function(n,t){r.css(this._backgroundDiv,{width:n+"px",height:t+"px"})};y.prototype._layerIdBackground="BACKGROUND";y.prototype._initBackground=function(){var n=document.createElement("div"),t=this._width,i=this._height;this._backgroundDiv=n;this._window.appendChild(n);n.id=this._layerIdBackground;r.css(n,{width:t+"px",height:i+"px",position:"absolute",opacity:1,zIndex:0})};y.prototype._error=function(n){if(rt.debug)throw new Error(n);};y.prototype.setViewProjectionMatrix=function(n){this._viewProjMatrix=n};y.prototype.getType=function(){throw"Renderer must support one of the rendering techniques such as '2D', '3D' etc.";};y.prototype.initLayer=function(){throw"Reached Renderer.prototype.initLayer() instead of concrete implementation.";};y.prototype.finalizeLayer=function(){throw"Reached Renderer.prototype.finalizeLayer() instead of concrete implementation.";};y.prototype.disposeLayer=function(n){var t=this._layers[n];t&&(this._window.removeChild(t),delete this._layers[n])};y.prototype.updateAnimation=function(n,t,i){n.animation===undefined&&(n.animation=i());var r=n.animation;r&&(n.id.levelOfDetail!=n.worldLod.value?(r.finalize(n),n.animation=null):(r.apply(n),r.isComplete()&&(r.finalize(n),n.animation=null)))};c(cr,yr);p.InitRenderableFor3D=function(n){var s=2,t=n.geometryPolygon[0],i=n.geometryPolygon[1],r=n.geometryPolygon[2],u=n.geometryPolygon[3],f;n.geometryPolygon._vertices=[t.x,t.y,t.z,i.x,i.y,i.z,r.x,r.y,r.z,u.x,u.y,u.z];f=n.texturesWithPolygons[0].polygon;t=f[0];i=f[1];r=f[2];u=f[3];var h=n.texturesWithPolygons[0].texture,e=h.dataSourceWidth+s,o=h.dataSourceHeight+s;n.geometryPolygon._texCoords=[i.x/e,i.y/o,t.x/e,t.y/o,u.x/e,u.y/o,r.x/e,r.y/o];n.geometryPolygon._indices=[0,1,2,0,2,3];n.geometryPolygon._texCoordSize=2;n.geometryPolygon._isDirty=!0};p.DrawPolyLine=function(n,t,i){n.beginPath();i&&(r.log("===================Quad========================="),r.log("x: "+t[0].x+" y: "+t[0].y));n.moveTo(t[0].x,t[0].y);for(var u=1;u<t.length;u++)i&&r.log("x: "+t[u].x+" y: "+t[u].y),n.lineTo(t[u].x,t[u].y);n.lineTo(t[0].x,t[0].y);i&&r.log("===================STROKE=========================");n.stroke()};p.FilterType={NORMFACTOR:8};p.FilterType.NO_FILTER=[0,0,0,0,1,0,0,0,0];p.FilterType.GAUSSIAN=[1/16,2/16,1/16,2/16,4/16,2/16,1/16,2/16,1/16];p.FilterType.LAPLACIAN=[-1/p.FilterType.NORMFACTOR,-1/p.FilterType.NORMFACTOR,-1/p.FilterType.NORMFACTOR,-1/p.FilterType.NORMFACTOR,17/p.FilterType.NORMFACTOR,-1/p.FilterType.NORMFACTOR,-1/p.FilterType.NORMFACTOR,-1/p.FilterType.NORMFACTOR,-1/p.FilterType.NORMFACTOR];k=new function(){var n=navigator.userAgent,o=navigator.vendor==="Apple Computer, Inc.",h=n.indexOf("Webkit"),u=n.indexOf("Chrome"),t=u!==-1,f=n.indexOf("Firefox"),i=f!==-1,r=t?parseInt(n.substring(u+7)):-1,e=i?parseInt(n.substring(f+8)):-1,s=n.indexOf("Trident")!==-1;this.isWebGLCORSSupported=t&&r>=13||i&&e>=8;this.failsToRenderItemsNearContainerBorder=t&&r<=19;this.isWebGLCORSRequired=i&&e>4||t&&r>=13;this.useImageDisposer=o;this.supportsPreserve3D=!s&&!i};ht={};ht.isValidBrowser=function(){var u=window.CSSMatrix||window.WebKitCSSMatrix||window.MSCSSMatrix||window.MozCSSMatrix,f,e,i,t,n,r;return u==null||k.failsToRenderItemsNearContainerBorder?(ht.isValidBrowser=function(){return!1},!1):(f=new u,!f)?(ht.isValidBrowser=function(){return!1},!1):(e=document.createElement("div"),i=e.style,i.webkitTransform===undefined&&i.msTransform===undefined&&i.mozTransform===undefined)?(ht.isValidBrowser=function(){return!1},!1):k.supportsPreserve3D?(t=document.createElement("div"),n=t.style,n.width="0px",n.height="0px",n.position="absolute",n.overflowX="hidden",n.overflowY="hidden",n.backgroundColor="rgb(0, 0, 0)",t.innerHTML='<div style="position: absolute; z-index: -10; -webkit-transform: matrix3d(772.413793, 0, 0, 0, 0, 772.413793, 0, 0, -537600, -315000, -1050.021, -1050, -772.413793, -112072.413793, 525.0085, 525); -ms-transform: matrix3d(772.413793, 0, 0, 0, 0, 772.413793, 0, 0, -537600, -315000, -1050.021, -1050, -772.413793, -112072.413793, 525.0085, 525); -moz-transform: matrix3d(772.413793, 0, 0, 0, 0, 772.413793, 0, 0, -537600, -315000, -1050.021, -1050, -772.413793, -112072.413793, 525.0085, 525); transform: matrix3d(772.413793, 0, 0, 0, 0, 772.413793, 0, 0, -537600, -315000, -1050.021, -1050, -772.413793, -112072.413793, 525.0085, 525); "><div id="_rwwviewer_cssrenderer_test_id" style="width: 256px; height: 256px;"><\/div><\/div>',document.body.appendChild(t),r=document.getElementById("_rwwviewer_cssrenderer_test_id").getClientRects()[0],document.body.removeChild(t),Math.abs(r.width-377)<=1&&Math.abs(r.height-377)<=1?(ht.isValidBrowser=function(){return!0},!0):(ht.isValidBrowser=function(){return!1},!1)):(ht.isValidBrowser=function(){return!0},!0)};ct={};ct.getWebGLContext=function(n){var i,t,r;if(n.getContext)for(i=["webgl","experimental-webgl","webkit-3d","moz-webgl"],t=0;t<i.length;++t)try{if(r=n.getContext(i[t],{antialias:!0}),r!=null)return r}catch(u){}return null};ct.isValidBrowser=function(){if(navigator.userAgent.indexOf("Trident/7.0")>=0)return!1;var n=document.createElement("canvas"),t=ct.getWebGLContext(n);if(t){if(k.isWebGLCORSRequired&&!k.isWebGLCORSSupported)return r.log("CORS image textures are not supported in this browser"),ct.isValidBrowser=function(){return!1},!1}else return r.log("WebGL is not supported."),ct.isValidBrowser=function(){return!1},!1;return ct.isValidBrowser=function(){return!0},!0};oi=window.CSSMatrix||window.WebKitCSSMatrix||window.MSCSSMatrix||window.MozCSSMatrix;c(l,y);l.prototype._initNewCss3dDiv=function(n,t){var u=document.createElement("div"),f,i;u.width=this._width;u.height=this._height;u.zIndex=t;f=document.createElement("div");r.css(f,{width:this._width+"px",height:this._height+"px",position:"absolute",webkitTransformStyle:"flat",msTransformStyle:"flat",mozTransformStyle:"flat",zIndex:t});i=document.createElement("div");i.width=this._width;i.height=this._height;i.style.position="absolute";i.style.zIndex=t;f.appendChild(i);u.appendChild(f);k.supportsPreserve3D&&!rt.forceIERenderPath&&(i.style.webkitTransformStyle="preserve-3d",i.style.webkitTransform="matrix3d(1,0,0,0, 0,1,0,0, 0,0,1,0, 0,0,0,1)",i.style.mozTransformStyle="preserve-3d",i.style.mozTransform="matrix3d(1,0,0,0, 0,1,0,0, 0,0,1,0, 0,0,0,1)");this._window.appendChild(u);this._layers[n]={rootElement:u,flatten3D:f,viewportDiv:i,zOrder:t}};l.prototype.ignoreEvent=function(){return!1};l.prototype.setStyleProperties=function(n){k.supportsPreserve3D&&!rt.forceIERenderPath&&(n.style.webkitTransformStyle="preserve-3d",n.style.mozTransformStyle="preserve-3d");n.style.position="absolute"};l.prototype.clearStyleProperties=function(n){n.style.webkitTransformStyle="";n.style.msTransformStyle="";n.style.mozTransformStyle="";n.style.position=""};l.prototype.setViewportSize=function(n,t){var o,i,r,u,e;this._width=n;this._height=t;this._updateBackgroundSize(n,t);for(o in this._layers)i=this._layers[o],r=i.rootElement,r.width=n,r.height=t,u=i.flatten3D,u.width=n,u.height=t,e=i.viewportDiv,e.width=n,e.height=t;this._viewportToScreenTransform=f.createViewportToScreen(this._width,this._height)};l.prototype.invertYAxisMatrix=i.createScale(1,-1,1);l.prototype.transformOrigin="0px 0px 0";l.prototype.transformStyle="preserve-3d";tr=function(n,t){n.style.webkitTransform=t;n.style.msTransform=t;n.style.mozTransform=t};l.prototype.updateTransforms=function(n,t,i){var u,r;if(r=new oi,r.m11=1,r.m12=0,r.m13=0,r.m14=0,r.m21=0,r.m22=1,r.m23=0,r.m24=0,r.m31=0,r.m32=0,r.m33=1,r.m34=0,r.m41=0,r.m42=0,r.m43=0,r.m44=1,n||(n=i.rootElement),t||(t=r),n.$$matrixTransform&&(t=t.multiply(n.$$matrixTransform)),n.childNodes.length===0||n.$$isLeaf)tr(n,t);else for(tr(n,r),u=0;u<n.childNodes.length;++u)this.updateTransforms(n.childNodes[u],t,null)};l.prototype.render=function(n,t,i,r){var l=!1,f=this._layers[n],b,a,d,u,c,p,e,v,y,o,s,w,h;if(!f)throw"trying to render on a non-existing div "+n;if(t?(t.apply(f.rootElement),f.associatedAnimation=t,l=!0):f.associatedAnimation!=null&&(f.associatedAnimation.finalize(f.rootElement),f.associatedAnimation=null),f.finalized)return!0;for(b=this._viewportToScreenTransform.multiply(this._viewProjMatrix.multiply(this.invertYAxisMatrix)),this.setCSS3DViewProjection(b,f),p=this._viewModel.getRenderables(n).getArray(),d=p.length,a=0;a<d;a++)if(e=p[a],v=e.id,u=null,c=e.texturesWithPolygons[0].texture,c._isReady&&(u=c._image),u!==null){if(y=f.zOrder+v.levelOfDetail,!c._isDirty){u.parentNode&&this.setCSS3DTransform(u.parentNode,u,e.transform,y);this.updateAnimation(e,t,r);l|=e.animation!=null;continue}u._order=y;u.style.zIndex=y;u.parentNode&&this._error("Expected imageElement with no parent");this.setStyleProperties(u);o=document.createElement("div");s=o.style;o.id=v.id;s.position="absolute";s.zIndex=u.style.zIndex;k.supportsPreserve3D&&!rt.forceIERenderPath?(s.webkitTransformOrigin=this.transformOrigin,s.webkitTransformStyle=this.transformStyle,s.mozTransformOrigin=this.transformOrigin,s.mozTransformStyle=this.transformStyle):o.$$isLeaf=!0;o.appendChild(u);this.setCSS3DTransform(o,u,e.transform,v.levelOfDetail);f.viewportDiv.appendChild(o);c._isDirty=!1;this.updateAnimation(e,t,r);l|=e.animation!=null}if((!k.supportsPreserve3D||rt.forceIERenderPath)&&this.updateTransforms(null,null,f),w=!1,this._frameCallbacks){for(h=0;h<this._frameCallbacks.length;h++)this._frameCallbacks[h].count>0?w=!0:this._frameCallbacks[h].count==0&&this._frameCallbacks[h].cb(),this._frameCallbacks[h].count--;w||(this._frameCallbacks=[])}return l};l.prototype.preTransform=i.createIdentity();l.prototype.elementTransform=i.createIdentity();l.prototype.setCSS3DTransform=function(n,t,r){var e=Math.max(t.height||0,t.naturalHeight||0),f,u;this.invertYAxisMatrix.multiplyOut(i.createTranslation(0,-e,0),this.preTransform);r.multiplyOut(this.preTransform,this.elementTransform);f=this.invertYAxisMatrix.multiply(this.elementTransform);f=f.transpose();u=new oi;u.m11=f.m11;u.m12=f.m12;u.m13=f.m13;u.m14=f.m14;u.m21=f.m21;u.m22=f.m22;u.m23=f.m23;u.m24=f.m24;u.m31=f.m31;u.m32=f.m32;u.m33=f.m33;u.m34=f.m34;u.m41=f.m41;u.m42=f.m42;u.m43=f.m43;u.m44=f.m44;k.supportsPreserve3D&&!rt.forceIERenderPath?(n.style.webkitTransform=u,n.style.mozTransform=u,n.style.msTransform=u):n.$$matrixTransform=u};l.prototype.setCSS3DViewProjection=function(n,t){var r=n.transpose(),i=new oi,u;i.m11=r.m11;i.m12=r.m12;i.m13=r.m13;i.m14=r.m14;i.m21=r.m21;i.m22=r.m22;i.m23=r.m23;i.m24=r.m24;i.m31=r.m31;i.m32=r.m32;i.m33=r.m33;i.m34=r.m34;i.m41=r.m41;i.m42=r.m42;i.m43=r.m43;i.m44=r.m44;u=t.viewportDiv;k.supportsPreserve3D&&!rt.forceIERenderPath?(u.style.webkitTransform=i,u.style.mozTransform=i,u.style.msTransform=i):u.$$matrixTransform=i};l.prototype.initLayer=function(n,t){this._initNewCss3dDiv(n,t)};l.prototype.finalizeLayer=function(n){var t=this._layers[n];t&&(t.finalized=!0)};l.prototype.disposeLayer=function(n){var t=this._layers[n];t&&this._window.removeChild(t.rootElement)};l.prototype.getType=function(){return"3D"};l.prototype.syncRemovedRenderables=function(n){for(var f,o,t,i,e=this._viewModel.getDelta(n).removed,s=this._viewModel.getRenderables(n).map,u=0,h=e.length;u<h;u++)(f=e[u].viewElementId.id,o=s[f],o)&&(i=this._window.querySelector("#"+f),i?(t=i.firstChild,t?(this.clearStyleProperties(t),t.parentNode&&t.parentNode.removeChild(t)):this._error("Expected imgElement"),i.parentNode&&i.parentNode.removeChild(i)):r.log("Cannot find and remove element"))};c(d,y);d.prototype.MAX_CONTEXTS=5;d.prototype._getCanvasFromCache=function(n,t){for(var i,r,f,u=0,e=this._contextCache.length;u<e;u++)if(i=this._contextCache[u],i){if(i.isFree)return i.id=n,i.style.zIndex=t,i.isFree=!1,i.width=this._width,i.height=this._height,r=i._gl,r.viewportWidth=this._width,r.viewportHeight=this._height,r.viewport(0,0,r.viewportWidth,r.viewportHeight),r.clear(r.DEPTH_BUFFER_BIT),i;continue}else return f=this._initNewCanvas(n,t),this._contextCache[u]=f,f;throw"Out of canvas context cache! Too many datasources to render.";};d.prototype._initNewCanvas=function(n,t){var u=document.createElement("canvas"),i;if(u.id=n,u.width=this._width,u.height=this._height,u._gl=ct.getWebGLContext(u),u._gl){if(k.isWebGLCORSRequired&&!k.isWebGLCORSSupported)throw"CORS image textures are not supported in this browser";}else throw"WebGL is not supported.";return i=u._gl,i.viewportWidth=this._width,i.viewportHeight=this._height,i.viewport(0,0,i.viewportWidth,i.viewportHeight),i.clearDepth(1),i.disable(i.DEPTH_TEST),i.disable(i.CULL_FACE),this.init(u),r.css(u,{position:"absolute",left:0,top:0,zIndex:t}),u};d.prototype.init=function(n){var t=n._gl,e,i,u,o,r,f;if(n._vs=vr(t,t.VERTEX_SHADER,"                 uniform mat4 u_modelViewProjMat;                  uniform mat4 u_localMat;                                   /* the following can be optimized into one vec4 */                  uniform vec2 u_opacityBE, u_xBE, u_yBE, u_rotateBE;                  uniform vec2 u_sxBE, u_syBE;                  uniform float u_texW, u_texH;                  attribute vec3 a_pos;                  attribute vec2 a_texCoord;                  varying vec2 v_texCoord;                  varying float v_opacity;                                   void main()                  {                     float opacity, x, y, rotate;                     mat4 finalMat;                     float a;                                          finalMat = u_modelViewProjMat;                     opacity = u_opacityBE[0];                                          vec4 pos = finalMat * vec4(a_pos, 1.0);                     v_texCoord = a_texCoord.xy;                     v_opacity = opacity;                     gl_Position = pos;                  }"),n._ps=vr(t,t.FRAGMENT_SHADER,"precision mediump float; \n#define KERNEL_SIZE 9 \nuniform sampler2D u_diffuseTex; \nuniform vec4 u_colorMult; \nuniform vec2 u_kernelOffsets[9]; \nuniform float u_kernel[9]; \nvarying float v_opacity; \nvarying vec2 v_texCoord; \nvoid main() { \n    vec2 texCoord = vec2(v_texCoord.x, 1.0 - v_texCoord.y); \n    /*vec4 color = texture2D(u_diffuseTex, texCoord); */\n    vec4 color = vec4(0); \n    for(int i=0; i<9; i++ ) { \n        vec4 tmp = texture2D(u_diffuseTex, texCoord.st + u_kernelOffsets[i]); \n        color += tmp * u_kernel[i]; \n    } \n    gl_FragColor = color * vec4(1,1,1,v_opacity); \n}"),n._vs==null||n._ps==null)throw"Failure initializing webgl: shader";if(n._shaderProgram=t.createProgram(),t.attachShader(n._shaderProgram,n._vs),t.attachShader(n._shaderProgram,n._ps),t.linkProgram(n._shaderProgram),!t.getProgramParameter(n._shaderProgram,t.LINK_STATUS)){t.deleteProgram(n._shaderProgram);t.deleteShader(n._vs);t.deleteShader(n._ps);return}for(e=t.getProgramParameter(n._shaderProgram,t.ACTIVE_ATTRIBUTES),n._attribs=new Array(e),n._attribLocations={},i=0;i<e;i++)u=t.getActiveAttrib(n._shaderProgram,i),n._attribs[i]=u,n._attribLocations[u.name]=t.getAttribLocation(n._shaderProgram,u.name);for(o=t.getProgramParameter(n._shaderProgram,t.ACTIVE_UNIFORMS),n._uniforms=new Array(o),n._uniformLocations={},r=0;r<o;r++)f=t.getActiveUniform(n._shaderProgram,r),n._uniforms[r]=f,n._uniformLocations[f.name]=t.getUniformLocation(n._shaderProgram,f.name)};d.prototype.setViewportSize=function(n,t){var r,i;this._width=n;this._height=t;this._updateBackgroundSize(n,t);for(r in this._layers)i=this._layers[r],i.width=n,i.height=t,i._gl.viewportWidth=this._width,i._gl.viewportHeight=this._height,i._gl.viewport(0,0,n,t)};d.prototype.render=function(t,i,r,u){var s,h,o=this._layers[t],d=!1,f,nt,b,v,k,tt,e,y,w,g,c,it,rt,ut;if(!o)return!1;if(f=o._gl,i!=null?(i.apply(o),o.associatedAnimation=i,d=!0):o.associatedAnimation!=null&&(o.associatedAnimation.finalize(o),o.associatedAnimation=null),o.finalized)return!0;for(f.clear(f.DEPTH_BUFFER_BIT),f.useProgram(o._shaderProgram),nt=new Float32Array(p.FilterType.NO_FILTER),b=this._viewModel.getRenderables(t).getArray(),b.sort(this.SortRenderableFucntion),v=0;v<2;v++)for(v==1?(f.enable(f.BLEND),f.blendFunc(f.SRC_ALPHA,f.ONE_MINUS_SRC_ALPHA)):f.disable(f.BLEND),k=0,tt=b.length;k<tt;k++)if((e=b[k],s=null,h=e.texturesWithPolygons[0].texture,h._isReady&&(s=h._image),s!=null&&e.geometryPolygon!=null)&&(e.geometryPolygon._vertices||p.InitRenderableFor3D(e),this.updateAnimation(e,i,u),d|=e.animation!=null,v!=0||!(s.style.opacity<1))){if(e.geometryPolygon._isDirty&&(e.geometryPolygon.__gl_posBuffer&&f.deleteBuffer(e.geometryPolygon.__gl_posBuffer),e.geometryPolygon.__gl_posBuffer=f.createBuffer(),f.bindBuffer(f.ARRAY_BUFFER,e.geometryPolygon.__gl_posBuffer),f.bufferData(f.ARRAY_BUFFER,new Float32Array(e.geometryPolygon._vertices),f.STATIC_DRAW),e.geometryPolygon.__gl_texCoordBuffer&&f.deleteBuffer(e.geometryPolygon.__gl_texCoordBuffer),e.geometryPolygon.__gl_texCoordBuffer=f.createBuffer(),f.bindBuffer(f.ARRAY_BUFFER,e.geometryPolygon.__gl_texCoordBuffer),f.bufferData(f.ARRAY_BUFFER,new Float32Array(e.geometryPolygon._texCoords),f.STATIC_DRAW),e.geometryPolygon._indices&&(e.geometryPolygon.__gl_indexBuffer&&f.deleteBuffer(e.geometryPolygon.__gl_indexBuffer),e.geometryPolygon.__gl_indexBuffer=f.createBuffer(),f.bindBuffer(f.ELEMENT_ARRAY_BUFFER,e.geometryPolygon.__gl_indexBuffer),f.bufferData(f.ELEMENT_ARRAY_BUFFER,new Uint16Array(e.geometryPolygon._indices),f.STATIC_DRAW)),e.geometryPolygon._isDirty=!1),y=s.width,w=s.height,h._isDirty){h.__gl_texture&&f.deleteTexture(h.__gl_texture);h.__gl_texture=f.createTexture();f.bindTexture(f.TEXTURE_2D,h.__gl_texture);f.texParameteri(f.TEXTURE_2D,f.TEXTURE_MAG_FILTER,f.LINEAR);f.texParameteri(f.TEXTURE_2D,f.TEXTURE_MIN_FILTER,f.LINEAR_MIPMAP_LINEAR);g=f.CLAMP_TO_EDGE;f.texParameteri(f.TEXTURE_2D,f.TEXTURE_WRAP_S,g);f.texParameteri(f.TEXTURE_2D,f.TEXTURE_WRAP_T,g);try{n.isPowerOfTwo(y)&&n.isPowerOfTwo(w)?f.texImage2D(f.TEXTURE_2D,0,f.RGBA,f.RGBA,f.UNSIGNED_BYTE,s):(c=document.createElement("canvas"),c.width=n.nextHighestPowerOfTwo(y),c.height=n.nextHighestPowerOfTwo(w),it=c.getContext("2d"),it.drawImage(s,0,0,y,w,0,0,c.width,c.height),s=c,f.texImage2D(f.TEXTURE_2D,0,f.RGBA,f.RGBA,f.UNSIGNED_BYTE,c))}catch(ot){continue}f.generateMipmap(f.TEXTURE_2D);h._isDirty=!1}rt=this._viewProjMatrix.multiply(e.transform);ut=new Float32Array(rt.flattenColumnMajor());f.uniformMatrix4fv(o._uniformLocations.u_modelViewProjMat,!1,ut);var l=1/y,a=1/w,ft=[-l,-a,0,-a,l,-a,-l,0,0,0,l,0,-l,a,0,a,l,a],et=new Float32Array(ft);f.uniform2fv(o._uniformLocations["u_kernelOffsets[0]"],et);f.uniform1fv(o._uniformLocations["u_kernel[0]"],nt);f.uniform2f(o._uniformLocations.u_opacityBE,s.style.opacity,s.style.opacity);f.uniform1f(o._uniformLocations.u_t,-1);f.enableVertexAttribArray(o._attribLocations.a_pos);f.enableVertexAttribArray(o._attribLocations.a_texCoord);f.bindBuffer(f.ARRAY_BUFFER,e.geometryPolygon.__gl_posBuffer);f.vertexAttribPointer(o._attribLocations.a_pos,3,f.FLOAT,!1,0,0);f.bindBuffer(f.ARRAY_BUFFER,e.geometryPolygon.__gl_texCoordBuffer);f.vertexAttribPointer(o._attribLocations.a_texCoord,e.geometryPolygon._texCoordSize,f.FLOAT,!1,0,0);e.geometryPolygon._indices&&f.bindBuffer(f.ELEMENT_ARRAY_BUFFER,e.geometryPolygon.__gl_indexBuffer);f.activeTexture(f.TEXTURE0);f.bindTexture(f.TEXTURE_2D,h.__gl_texture);f.uniform1i(o._uniformLocations.u_diffuseTex,0);f.drawElements(f.TRIANGLES,e.geometryPolygon._indices.length,f.UNSIGNED_SHORT,0)}return d};d.prototype.animate=function(){};d.prototype.initLayer=function(n,t){var i=this._getCanvasFromCache(n,t);this._layers[n]=i;this._window.appendChild(i)};d.prototype.finalizeLayer=function(n){var t=this._layers[n];t&&(t.finalized=!0)};d.prototype.disposeLayer=function(n,t){var i=this._layers[n],r,u,f;i&&(i.isFree=!0,delete i.finalized,r=i._gl,t&&r&&(u=i._shaderProgram,u&&(r.detachShader(u,i._vs),r.detachShader(u,i._ps),r.deleteShader(i._vs),r.deleteShader(i._ps),r.deleteProgram(u)),f=r.getExtension("WEBGL_lose_context"),f&&f.loseContext()));y.prototype.disposeLayer.call(this,n)};d.prototype.getType=function(){return"3D"};d.prototype.syncRemovedRenderables=function(n){var f=this._layers[n],r,o,t;if(!f)throw"trying to render on a non-existing context "+n;var i=f._gl,e=this._viewModel.getDelta(n).removed,s=this._viewModel.getRenderables(n).map,u;for(r=0;r<e.length;r++)(o=e[r].viewElementId.id,t=s[o],t)&&(t.geometryPolygon.__gl_posBuffer&&i.deleteBuffer(t.geometryPolygon.__gl_posBuffer),t.geometryPolygon.__gl_indexBuffer&&i.deleteBuffer(t.geometryPolygon.__gl_indexBuffer),u=t.texturesWithPolygons[0].texture,u.__gl_texture&&i.deleteTexture(u.__gl_texture),t.geometryPolygon.__gl_texCoordBuffer&&i.deleteBuffer(t.geometryPolygon.__gl_texCoordBuffer))};c(it,y);it.STD_PIXEL_EXPANSION=window.chrome?.01:.5;it.prototype.setViewportSize=function(n,t){var r,i;this._width=n;this._height=t;this._updateBackgroundSize(n,t);for(r in this._layers)i=this._layers[r],i.width=n,i.height=t};it.prototype._initNewCanvas=function(n,t){var i=document.createElement("canvas"),u;return this._layers[n]=i,i.id=n,i.width=this._width,i.height=this._height,r.css(i,{position:"absolute",left:0,top:0,zIndex:t}),u=i.getContext("2d"),i.ctx=u,this._window.appendChild(i),u};it.prototype.render=function(n,t,i,r){function yt(n,t,i,r,u,f,e,o,s,h,c,l,a,v,y,p){var b=gt,k=b(r,u,f,e,o,s),d=b(f,e,r,u,o,s),g=b(o,s,f,e,r,u),w;if(r=k.x,u=k.y,f=d.x,e=d.y,o=g.x,s=g.y,n.save(),i<1?(n.globalAlpha=i,self._expansionInPixels=.25):self._expansionInPixels=it.STD_PIXEL_EXPANSION,n.beginPath(),n.moveTo(r,u),n.lineTo(f,e),n.lineTo(o,s),n.closePath(),p&&(n.strokeStyle="blue",n.stroke()),n.clip(),w=h*(y-a)-l*y+v*a+(l-v)*c,w==0)return n.restore(),!1;var nt=-(c*(o-f)-a*o+y*f+(a-y)*r)/w,tt=(a*s+c*(e-s)-y*e+(y-a)*u)/w,rt=(h*(o-f)-l*o+v*f+(l-v)*r)/w,ut=-(l*s+h*(e-s)-v*e+(v-l)*u)/w,ft=(h*(y*f-a*o)+c*(l*o-v*f)+(v*a-l*y)*r)/w,et=(h*(y*e-a*s)+c*(l*s-v*e)+(v*a-l*y)*u)/w;return n.transform(nt,tt,rt,ut,ft,et),!0&&n.drawImage(t,0,0),n.restore(),!0}function gt(n,t,i,r,u,f){var h=i-n,c=r-t,l=u-n,a=f-t,e=Math.sqrt(h*h+c*c),o,s,v,y,w,p;return e!=0&&(h/=e,c/=e),e=Math.sqrt(l*l+a*a),e!=0&&(l/=e,a/=e),o=h+l,s=c+a,e=Math.sqrt(o*o+s*s),e!=0&&(o/=e,s/=e),v=h-l,y=c-a,e=Math.sqrt(v*v+y*y),w=e/2,p=Math.min(2,self._expansionInPixels/w),o*=p,s*=p,{x:n-o,y:t-s}}var l,st,ht=this._viewModel.getRenderables(n).getArray(),g,ct,lt,at,f,u,w,nt,pt,vt,ut,wt,ft,ot,d,bt;if(ht.sort(this.SortRenderableFucntion),this.renderImageryB=!0,g=!1,tt.debugEnabled&&(ct=document.getElementById("tiles"),ct&&(this.showSquareB=ct.checked),lt=document.getElementById("triangles"),lt&&(this.showTrianglesB=lt.checked),at=document.getElementById("images"),at&&(this.renderImageryB=at.checked)),f=this._layers[n],!f)throw"trying to render on a non-existing canvas "+n;if(u=f.ctx,t?(t.apply(f),f.associatedAnimation=t,g=!0):f.associatedAnimation!=null&&(f.associatedAnimation.finalize(f),f.associatedAnimation=null),f.finalized)return!0;for(u.clearRect(0,0,this._width,this._height),w=0,nt=0,pt=ht.length;nt<pt;nt++){var b=ht[nt],rt=b.geometryPolygon,kt=b.texturesWithPolygons[0];if(st=kt.texture,l=st._isReady?st._image:null,l!=null&&rt!=null){for(this.updateAnimation(b,t,r),g|=b.animation!=null,vt=rt.intileTesselated,ut=0,wt=vt.length;this.renderImageryB&&ut<wt;ut++)if(ft=vt[ut],ft){var e=ft.screenArray,a=ft.textureArray,v=e[0],y=a[0],o,s,h,c;if(e.length==4)o=e[1],s=a[1],h=e[2],c=a[2],yt(u,l,l.style.opacity,v.x,v.y,o.x,o.y,h.x,h.y,y.x,y.y,s.x,s.y,c.x,c.y,this.showTrianglesB),o=e[2],s=a[2],h=e[3],c=a[3],yt(u,l,l.style.opacity,v.x,v.y,o.x,o.y,h.x,h.y,y.x,y.y,s.x,s.y,c.x,c.y,this.showTrianglesB),w+=2;else for(var et=1,k=1,dt=e.length-1;k<dt;et=k)k=et+1,o=e[et],s=a[et],h=e[k],c=a[k],yt(u,l,l.style.opacity,v.x,v.y,o.x,o.y,h.x,h.y,y.x,y.y,s.x,s.y,c.x,c.y,this.showTrianglesB),w++}if(tt.debugEnabled){if(!this.renderImageryB&&this.showTrianglesB)for(u.strokeStyle="teal",ot=rt.intileTesselated,d=0;d<ot.length;d++)ot[d]&&p.DrawPolyLine(u,ot[d].screenArray,null);this.showSquareB&&(bt=!1,u.strokeStyle=b.isClipped?"red":"cyan",p.DrawPolyLine(u,rt.screenArray,bt),u.strokeStyle="black")}}}return tt.debugEnabled&&(u.font="14px Tahoma",u.strokeStyle=w>1e3?"red":"blue",u.strokeText("Rendered triangles: "+w,this._width-300,this._height-50)),g};it.prototype.initLayer=function(n,t){this._initNewCanvas(n,t)};it.prototype.finalizeLayer=function(n){var t=this._layers[n];t&&(t.finalized=!0)};it.prototype.getType=function(){return"2D"};it.prototype.syncRemovedRenderables=function(){};ci.prototype.Tesselate=function(){throw"interface function called instead of implementation";};ci.prototype.GetRawDensity=function(){throw"interface function called instead of implementation";};c(b,ci);b._isSpheric=!0;b.ScreenQuadSize=64;b.ScreenQuadSizeThreshold=b.ScreenQuadSize*b.ScreenQuadSize;b.setScreenQuadSize=function(n){var i,t;if(b.ScreenQuadSize=n,b.ScreenQuadSizeThreshold=n*n,tt.debugEnabled)for(i=document.getElementsByName("tess"),t=0;t<i.length;t++)if(i[t].value==n){i[t].checked=!0;break}};b.prototype.Tesselate=function(n,t,i){var u,r;return t===0?{squares:[n.geometryPolygon],texelSquares:[n.texturePolygon],density:0}:(t=t||-1,t<0?(r=this.GetRawDensity(n,i),r=r>t?r:t):r=t,r=r>=1?r:1,u={squares:[],texelSquares:[],density:r},f.splitSquareRecursive(n.geometryPolygon,n.texturePolygon,r,null,u,b._isSpheric,n.texturePolygon,null,null,null,null),u.density=r,!u.density,u)};b.prototype.GetRawDensity=function(t,i){var e=i.getViewport(),a=e.getWidth(),v=e.getHeight(),w=v<=a,o=t.geometryPolygon[0].y,s=t.geometryPolygon[1].y,h=i.getVerticalFov(),y=v,c,u,r;if(w||(h=vt.convertVerticalToHorizontalFieldOfView(e.getAspectRatio(),h),o=t.geometryPolygon[1].x,s=t.geometryPolygon[2].x,y=a),c=b.ScreenQuadSize,tt.debugEnabled)for(u=document.getElementsByName("tess"),r=0;r<u.length;r++)if(u[r].checked==!0){c=u[r].value;break}var k=Math.sqrt((o-s)*(o-s)),d=f.calculateTexelToPixelRatioAtFov(f._cubeSide,c,y,h),p=k/d,l=Math.floor(n.logBase(p,2)),g=Math.pow(2,l);return g>p?l-1:l};c(v,ci);v._isSpheric=!0;v.ScreenQuadSize=64;v.setScreenQuadSize=function(n){var i,t;if(v.ScreenQuadSize=n,v.ScreenQuadSizeThreshold=n*n,tt.debugEnabled)for(i=document.getElementsByName("tess"),t=0;t<i.length;t++)if(i[t].value==n){i[t].checked=!0;break}};v.prototype.Tesselate=function(n,t,i){function g(n,t,i,r,u,e){if(u!=0){var o=f.splitFunction(v._isSpheric,n,t,i,r),s=e.length;e[s]=o;g(n,o.xy,i,o.uv,u-1,e);g(o.xy,t,o.uv,r,u-1,e)}}function bt(n,t){return n.xy<t.xy?-1:n.xy>t.xy?1:0}var o,h,nt,tt,s,a,yt,y,pt,wt;if(t===0)return{squares:[n.geometryPolygon],texelSquares:[n.texturePolygon],density:0};t=t||-1;t<0?(nt=i.getViewport(),tt=i.getVerticalFov(),v.prototype._updateTesselatorQuadSize(),o=v.prototype._getNumberOfSplits(n.geometryPolygon[1].x,n.geometryPolygon[2].x,vt.convertVerticalToHorizontalFieldOfView(nt.getAspectRatio(),tt),v.ScreenQuadSize,nt.getWidth()),h=this.GetRawDensity(n,i)):o=h=t;o<1&&(o=1);h<1&&(h=1);var c=n.geometryPolygon,p=n.texturePolygon,r=c[0].z,u=c[0].w,it=c[1].x,rt=c[2].x,ut=p[1].x,ft=p[2].x,et=c[0].y,ot=p[0].y,st=c[1].y,ht=p[1].y,l=[{xy:it,uv:ut},{xy:rt,uv:ft}];g(it,rt,ut,ft,o,l);l.sort(bt);s=[{xy:et,uv:ot},{xy:st,uv:ht}];g(et,st,ot,ht,h,s);s.sort(bt);var ct=(l.length-1)*(s.length-1),kt=0,dt=0,lt=[ct],at=[ct];for(a=0,yt=l.length-1;a<yt;a++)for(y=0,pt=s.length-1;y<pt;y++){var w=l[a],b=s[y+1],k=l[a+1],d=s[y];lt[kt++]=[new e(w.xy,b.xy,r,u),new e(w.xy,d.xy,r,u),new e(k.xy,d.xy,r,u),new e(k.xy,b.xy,r,u)];at[dt++]=[new e(w.uv,b.uv,r,u),new e(w.uv,d.uv,r,u),new e(k.uv,d.uv,r,u),new e(k.uv,b.uv,r,u)]}return wt=o==h?o:-1,{squares:lt,texelSquares:at,density:wt}};v.prototype.GetRawDensity=function(n,t){var i=t.getViewport(),r=t.getVerticalFov();return v.prototype._updateTesselatorQuadSize(),v.prototype._getNumberOfSplits(n.geometryPolygon[0].y,n.geometryPolygon[1].y,r,v.ScreenQuadSize,i.getHeight())};v.prototype._updateTesselatorQuadSize=function(){var t,n;if(tt.debugEnabled)for(t=document.getElementsByName("tess"),n=0;n<t.length;n++)t[n].checked==!0&&(v.ScreenQuadSize=t[n].value)};v.prototype._getNumberOfSplits=function(t,i,r,u,e){var o=Math.sqrt((i-t)*(i-t)),s=f.calculateTexelToPixelRatioAtFov(f._cubeSide,u,e,r);return Math.floor(n.logBase(o/s,2))};g.TRANSITION_TYPE={IN:1,OUT:2};g.DataSourceRegistryItem=function(n,t,i){this.id=n.getDataSourceName();this.dataSource=n;this.callback=t;this.transitionType=i};g.DataSourceRegistryItem.prototype.id=null;g.DataSourceRegistryItem.prototype.dataSource=null;g.DataSourceRegistryItem.prototype.callback=function(){};g.DataSourceRegistryItem.prototype.transitionType=null;g.DataSourceRegistryItem.prototype.notifyCallback=function(){this.callback&&this.callback(this.dataSource)};wt.lowerVisibleBoundary=new e(-1,-1,-1,null);wt.higherVisibleBoundary=new e(1,1,1,null);u.number=0;u.DefaultDurationMs=1e3;u.prototype._start=0;u.prototype._durationMs=u.DefaultDurationMs;u.prototype.guid=0;u.prototype._finalized=!1;u.prototype.apply=function(n){this._start||(this._start=Date.now());this.isComplete(n)&&this.finalize(n)};u.prototype.finalize=function(){this._finalized=!0};u.prototype.isComplete=function(){return this._finalized||this._start!=0&&Date.now()>this._start+this._durationMs};u.TYPE={FadeIn:1,FadeOut:2,HalfFadeOut:3,ImmediateFadeIn:4};u.createAnimation=function(n,t){switch(n){case u.TYPE.FadeIn:return new gt(t);case u.TYPE.FadeOut:return new fi(t);case u.TYPE.HalfFadeOut:return new ei(t);case u.TYPE.ImmediateFadeIn:return new ai(t);default:throw"unknown animation type: "+n;}};u.createCSSAnimation=function(n,t){switch(n){case u.TYPE.FadeIn:return new ui(t);case u.TYPE.FadeOut:return new st(t);case u.TYPE.HalfFadeOut:return new ir(t);default:throw"unknown animation type: "+n;}};u._getOpacityObject=function(n){if(n.style)return n;if(n instanceof li)return n.texturesWithPolygons[0].texture._image;throw"could not find Image object in "+n;};c(gt,u);gt.prototype.apply=function(n){if(u.prototype.apply.call(this,n),!this._finalized){var i=u._getOpacityObject(n),t=(Date.now()-this._start)/this._durationMs;t=t>1?1:t;(i.style.opacity==""||i.style.opacity<t)&&(i.style.opacity=t)}};gt.prototype.finalize=function(n){u.prototype.finalize.call(this,n);var t=u._getOpacityObject(n);t.style.opacity=1};c(ai,gt);ai.prototype.apply=function(n){this.finalize(n)};u._CSSAnimationHelper={styleNotImportatnt:"none !important;",setCSS3DOpacity:function(n,t,i){n.style.webkitTransition="opacity "+i+"s linear";n.style.mozTransition="opacity "+i+"s linear";n.style.msTransition="opacity "+i+"s linear";n.style.oTransition="opacity "+i+"s linear";n.style.opacity=t},transitionEndCallback:function(){this.animationInProgress=!1;this.removeEventListener("webkitTransitionEnd",u._CSSAnimationHelper.transitionEndCallback,!1);this.removeEventListener("mozTransitionEnd",u._CSSAnimationHelper.transitionEndCallback,!1);this.removeEventListener("MSTransitionEnd",u._CSSAnimationHelper.transitionEndCallback,!1);this.removeEventListener("oTransitionEnd",u._CSSAnimationHelper.transitionEndCallback,!1)},setCssOpacityChangeAnimation:function(n,t,i,r){var f=u._getOpacityObject(n),e;f.style.opacity===""?f.style.opacity=t:f.style.opacity==t||f.animationInProgress?f.style.opacity==i||f.animationInProgress||(e=u._CSSAnimationHelper.transitionEndCallback,f.addEventListener("webkitTransitionEnd",e,!1),f.addEventListener("MSTransitionEnd",e,!1),f.addEventListener("mozTransitionEnd",e,!1),f.addEventListener("oTransitionEnd",e,!1),f.animationInProgress=!0,u._CSSAnimationHelper.setCSS3DOpacity(f,i,r),Microsoft.Maps.setTimeout(function(){f.animationInProgress||e.apply(f)},r*1e3+50)):u._CSSAnimationHelper.dismissCssAnimation(f)},dismissCssAnimation:function(n){var r=u._getOpacityObject(n),t=r.style,i=u._CSSAnimationHelper.styleNotImportatnt;t&&(t.webkitTransition=i,t.mozTransition=i,t.msTransition=i,t.oTransition=i);u._CSSAnimationHelper.transitionEndCallback.apply(r)}};c(ui,u);ui.prototype.apply=function(n){(u.prototype.apply.call(this,n),this._finalized)||u._CSSAnimationHelper.setCssOpacityChangeAnimation(n,0,1,this._durationMs/1e3)};ui.prototype.finalize=function(n){u.prototype.finalize.call(this,n);u._CSSAnimationHelper.dismissCssAnimation(n);var t=u._getOpacityObject(n);t.style.opacity=1};c(fi,u);fi.prototype.apply=function(n){if(u.prototype.apply.call(this,n),!this._finalized){var i=u._getOpacityObject(n),t=(Date.now()-this._start)/this._durationMs;t=t>1?1:t;t=1-t;(i.style.opacity==""||i.style.opacity>t)&&(i.style.opacity=t)}};fi.prototype.finalize=function(n){u.prototype.finalize.call(this,n);var t=u._getOpacityObject(n);t.style.opacity=0};c(ei,u);ei.prototype.apply=function(n){if(u.prototype.apply.call(this,n),!this._finalized){var i=u._getOpacityObject(n),t=(Date.now()-this._start)/this._durationMs/2;t=t>.5?.5:t;t=1-t;(i.style.opacity==""||i.style.opacity>t)&&(i.style.opacity=t)}};ei.prototype.finalize=function(n){u.prototype.finalize.call(this,n);var t=u._getOpacityObject(n);t.style.opacity=.5};c(st,u);st.prototype.startOpacity=1;st.prototype.endOpacity=0;st.prototype.apply=function(n){(u.prototype.apply.call(this,n),this._finalized)||u._CSSAnimationHelper.setCssOpacityChangeAnimation(n,this.startOpacity,this.endOpacity,this._durationMs/1e3)};st.prototype.finalize=function(n){u.prototype.finalize.call(this,n);u._CSSAnimationHelper.dismissCssAnimation(n);var t=u._getOpacityObject(n);t.style.opacity=this.endOpacity};c(ir,st);st.prototype.startOpacity=1;st.prototype.endOpacity=.5;vt.convertHorizontalToVerticalFieldOfView=function(n,t){var i=.5/Math.tan(t*.5);return 2*Math.atan(.5*1/n/i)};vt.convertVerticalToHorizontalFieldOfView=function(n,t){var i=.5*1/n/Math.tan(t*.5);return 2*Math.atan(.5/i)};vt.prototype={getWidth:function(){return this._width},getHeight:function(){return this._height},getAspectRatio:function(){return this._aspectRatio},getNearDistance:function(){return this._nearDistance},getFarDistance:function(){return this._farDistance}};ri.prototype={step:function(n){function h(){return i._timeInMillis&&i._timeInMillis!=-1}function c(){return h()&&n!=i._startTime&&n-i._startTime>i._timeInMillis}function l(){return r<u&&r>-u&&t<u&&t>-u}var i,t,r,f,e,o,u,s;return this._isSettled?!0:(this._startTime==-1&&(this._startTime=n),i=this,t=0,this._t>=0&&(e=n-this._t,e>0&&(r=this._current-this._target,this._velocity+=-this._springConstant*r-this._damperConstant*this._velocity,t=this._velocity*e,(!this._allowOvershoot||e>100)&&(o=-r,Math.abs(o)<Math.abs(t)&&(t=o,this._velocity=0)),h()?(s=(n-this._startTime+1)/this._timeInMillis,this._current=this._initialValue+(this._target-this._initialValue)*s):this._current+=t)),r=this._current-this._target,u=1e-7,f=c()||l(),f?this.setCurrentToTarget():this._t=n,this._isSettled=f,f)},isSettled:function(){return this._isSettled},setTarget:function(n,t){this.target!=n&&(this._target=n,this._timeInMillis=t,t&&(this._startTime=-1,this._initialValue=this._current),this._isSettled=!1)},setCurrent:function(n){this._current=n;this._isSettled=!1},setCurrentAndTarget:function(n){this._target=n;this.setCurrentToTarget()},setCurrentToTarget:function(){this._current=this._target;this._velocity=0;this._isSettled=!0;this._t=-1;this._initialValue=-1;this._timeInMillis=-1},getTarget:function(){return this._target},getCurrent:function(){return this._current}};hr.prototype={step:function(n){var i,t,r;if(this._internalSpring._isSettled)return!0;for(i=this._internalSpring.step(n),t=0,r=this._current.length;t<r;t++)if(i)this._current[t]=this._target[t];else{var f=this._target[t],u=this._initial[t],e=(f-u)*this._internalSpring.getCurrent();this._current[t]=u+e}return i},isSettled:function(){return this._internalSpring._isSettled},setTarget:function(n){var i=!0,r=n.length,t;if(r==this._target.length)for(t=0;t<r;t++)this._target[t]!=n[t]&&(i=!1);else i=!1;i||(this._internalSpring.setTarget(this._internalSpringTargetValue,null),this._target=n,this._internalSpring._isSettled=!1)},setCurrent:function(n){this._internalSpring.setCurrent(this._internalSpringCurrentValue);this._current=n;this._initial=[];for(var t=0;t<n.length;t++)this._initial.push(n[t]);this._internalSpring._isSettled=!1},setCurrentAndTarget:function(n){this._internalSpring.setCurrentAndTarget(this._internalSpringTargetValue);this._target=n;this.setCurrentToTarget()},setCurrentToTarget:function(){for(var n=0,t=this._current.length;n<t;n++)this._current[n]=this._target[n]},getTarget:function(){return this._target},getCurrent:function(){return this._current}};ki.prototype={calculatePitchAndHeading:function(){var i=this.getPitch(),t=this.getHeading();return t<0&&(t+=n.twoPI),{pitch:i,heading:t}},setViewTarget:function(n,t,i,r,u,f){this._zoomingToPoint=!1;var e=!1;(n!==null||t!=null)&&(n=n!=0?n||this.getPitch():n,t=t!=0?t||this.getHeading():t,this.setPitchAndHeading(n,t,r,u,f),e=!0);i!==null&&(this.setVerticalFov(i,r,u),e=!0);e&&this.targetViewChangeCallback&&this.targetViewChangeCallback()},getView:function(){return this._currentView.pitch=this.getPitch(),this._currentView.heading=this.getHeading(),this._currentView.verticalFov=this.getVerticalFov(),this._currentView},getPitch:function(){return this._pitchSpring.getCurrent()},getHeading:function(){return this._headingSpring.getCurrent()},getVerticalFov:function(){return this._fieldOfViewSpring.getCurrent()},getMinVerticalFov:function(){return this._minFieldOfView},getMaxVerticalFov:function(){return this._maxFieldOfView},getBounds:function(){return{left:this._lowerHeadingLimit,right:this._upperHeadingLimit,bottom:this._lowerPitchLimit,top:this._upperPitchLimit,minFov:this._minFieldOfView,maxFov:this._maxFieldOfView}},zoomIn:function(n){this.setViewTarget(null,null,Math.max(this._minFieldOfView,this._camera.getVerticalFov()*this._discreteZoomFactor),n,null)},zoomOut:function(n){this.setViewTarget(null,null,Math.min(this._maxFieldOfView,this._camera.getVerticalFov()/this._discreteZoomFactor),n,null)},setPitchAndHeading:function(t,i,r,u,f){if(this._zoomingToPoint=!1,t=this.constrainPitch(t),i=this.constrainHeading(i),r){this._pitchSpring.setTarget(t,u);var e=this._headingSpring.getCurrent();f||(e=n.pickStartHeadingToTakeShortestPath(e,i));this._headingSpring.setCurrent(e);this._headingSpring.setTarget(i,u)}else this._pitchSpring.setCurrentAndTarget(t),this._headingSpring.setCurrentAndTarget(i),this.updateCameraProperties()},setVerticalFov:function(t,i,r){this._zoomingToPoint=!1;var u=n.clamp(t,this._minFieldOfView,this._maxFieldOfView);i?this._fieldOfViewSpring.setTarget(u,r):this._fieldOfViewSpring.setCurrentAndTarget(u);this.updateCameraProperties()},tryPitchHeadingToPixel:function(n,t){var r=this.calculateLookFromPitchAndHeading(n,t,this._worldLook,this._worldUp,this._worldSide,null),i;return this._camera.getLook().dot(r)<=0?null:(i=this._camera.projectTo2D(r),new h(i.x,i.y))},tryPixelToPitchHeading:function(t){var u=this._camera.getViewport(),h=this._camera.getFocalLength(),c=u.getWidth()/2,f=u.getHeight()/2,e=h*f,l=t.x-c,a=t.y-f,v=-Math.atan2(a,e),y=Math.atan2(l,e),i=this.calculateLookFromPitchAndHeading(v,y,this._look,this._up,this._side,!0),r=i.dot(this._worldUp),p=i.dot(this._worldSide),w=i.dot(this._worldLook),o=Math.atan2(r,Math.max(0,Math.sqrt(1-r*r))),s=n.normalizeRadian(Math.atan2(p,w));return isNaN(o)||isNaN(s)?null:{pitch:o,heading:s}},calculateLookFromPitchAndHeading:function(n,t,i,r,u,f){return a.fromAxisAngleOut(u,n,this._tempPitchRotationQuaternion),a.fromAxisAngleOut(r,-t,this._tempHeadingRotationQuaternion),f?this._tempPitchRotationQuaternion.multiplyOut(this._tempHeadingRotationQuaternion,this._tempQuaternion):this._tempHeadingRotationQuaternion.multiplyOut(this._tempPitchRotationQuaternion,this._tempQuaternion),this._tempQuaternion.transform(i)},constrainPitch:function(t){return n.clamp(t,this._lowerPitchLimit,this._upperPitchLimit)},constrainHeading:function(t){if(!this._upperHeadingLimit)return t;if(t<0&&(t+=n.twoPI),this._lowerHeadingLimit<this._upperHeadingLimit)return n.clamp(t,this._lowerHeadingLimit,this._upperHeadingLimit);if(t>this._lowerHeadingLimit&&t<this._upperHeadingLimit+n.twoPI||t+n.twoPI>this._lowerHeadingLimit&&t+n.twoPI<this._upperHeadingLimit+n.twoPI)return t;var i=Math.min(Math.abs(t-this._lowerHeadingLimit),Math.abs(t+n.twoPI-this._lowerHeadingLimit)),r=Math.min(Math.abs(t-this._upperHeadingLimit-n.twoPI),Math.abs(t-this._upperHeadingLimit));return i<r?this._lowerHeadingLimit:this._upperHeadingLimit},constrainVerticalFieldOfView:function(t){return n.clamp(t,this._minFieldOfView,this._maxFieldOfView)},onDiscreteZoom:function(t,i){function p(n){function f(){var r,i;return t.wheelDelta?r=Math.max(1.2,Math.abs(t.wheelDelta)):(i=1+(t.scale-Math.floor(t.scale)),n._previousTempZoomScale===null&&(n._previousTempZoomScale=i),r=1+Math.abs(n._previousTempZoomScale-i)*10,n._previousTempZoomScale=i),r}var i,r;if(t.mouseInteractionType&&t.mouseInteractionType=="mousewheel"||t.type&&t.type=="gestureChange")if(r=f(),c)if(u<n._maxFieldOfView-n._wheelZoomFudgeFactor)i=n.constrainVerticalFieldOfView(u*r);else return n._maxFieldOfView;else if(u>n._minFieldOfView+n._wheelZoomFudgeFactor)i=n.constrainVerticalFieldOfView(u/r);else return n._minFieldOfView;else i=n.constrainVerticalFieldOfView(u/2);return i}this._zoomingToPoint=!0;var o=this.calculatePitchAndHeading(),s=this.tryPixelToPitchHeading({x:t.clientX,y:t.clientY}),r=o.heading,f=s.heading;r=r-Math.floor(r/n.twoPI)*n.twoPI;Math.abs(r-f)>Math.PI&&(f<r?f+=n.twoPI:r+=n.twoPI);var c=t.direction&&t.direction>0||i>1,u=this._camera.getVerticalFov(),e=p(this),h=this._zoomToPointSpring.getTarget()[2];if((e!=this._minFieldOfView||h!=this._minFieldOfView)&&(e!=this._maxFieldOfView||h!=this._maxFieldOfView)){var l=e*((s.pitch-o.pitch)/u),a=e*((f-r)/u),v=s.pitch-l,y=f-a;this._zoomToPointSpring.setCurrent([o.pitch,r,u]);this._zoomToPointSpring.setTarget([v,y,e])}},onKeyDown:function(n){function i(n){t._scrollAccY=n;t.moveCamera()}function r(n){t._scrollAccX=n;t.moveCamera()}var t=this;n.keyCode=="37"?r(-1):n.keyCode=="38"?this._upArrowHandler?this._upArrowHandler(n,!0):i(1):n.keyCode=="39"?r(1):n.keyCode=="40"?this._downArrowHandler?this._downArrowHandler(n,!0):i(-1):n.keyCode=="107"||n.keyCode=="187"||n.keyCode=="61"?t.zoomIn(!0):(n.keyCode=="109"||n.keyCode=="189"||n.keyCode=="173")&&t.zoomOut(!0)},onKeyUp:function(n){function i(){t._scrollAccY=0}function r(){t._scrollAccX=0}var t=this;n.keyCode=="37"||n.keyCode=="39"?r():n.keyCode=="38"?this._upArrowHandler?this._upArrowHandler(n,!1):i():n.keyCode=="40"&&(this._downArrowHandler?this._downArrowHandler(n,!1):i())},moveCamera:function(){if(!this._motionHandle){var n=this;this._motionHandle=Microsoft.Maps.setInterval(function(){n._scrollSpeedX+=n._scrollAccX;n._scrollSpeedY+=n._scrollAccY;n._scrollSpeedX*=n._scrollSpeedDamper;n._scrollSpeedY*=n._scrollSpeedDamper;var t=n.getPitch(),i=n.getHeading();if(t+=n._scrollSpeedY/n._scrollSpeedAdjustmentFactor,i+=n._scrollSpeedX/n._scrollSpeedAdjustmentFactor,n.setPitchAndHeading(t,i,null,null),Math.abs(n._scrollSpeedX)<.1&&Math.abs(n._scrollSpeedY)<.1){n.stopMovingCamera();return}},33)}},stopMovingCamera:function(){this._motionHandle&&(clearInterval(this._motionHandle),this._motionHandle=0)}};c(wi,ki);c(hi,ki);c(bi,hi);var pt=function(n){var i=this,u={},f;u.assert=function(){};var e=n,o=3,r="$$count",t=[{}];t[0][r]=0;i.get=function(n,r){u.assert(typeof n=="string","Argument: key");for(var f,e=t.length,o=!0;e--;){if(f=t[e][n],f!==undefined)return r&&!o&&i.insert(n,f),f;o=!1}};i.insert=function(n,s){var h,l,c,a;if(u.assert(typeof n=="string","Argument: key"),u.assert(s!==undefined,"Argument: value"),h=t[t.length-1],h[n]===undefined)if(h[r]<e)h[r]++;else if(h={},h[r]=1,t.push(h),t.length>o&&(l=t.shift(),f))for(c in l)c!==r&&l.hasOwnProperty(c)&&(a=l[c],a!==i.get(c,null)&&f(a));h[n]=s};i.useDisposer=function(n){f=n};i.size=function(){for(var i,u=0,n=0;n<t.length;++n)if(t[n])for(i in t[n])t[n].hasOwnProperty(i)&&i!==r&&++u;return u}},ou=function(n,t,i){function ft(){var n,t;this[p]||(n=this[h].url,a(this,n),b.insert(n,!0),t=this[h].token,this[ut]=t,u.AllCompleted.insert(t,this),s.insert(n,this),y++,i(l,y))}function tt(){if(!this[p]){var n=this[h].url;a(this,n);k.useImageDisposer&&(this.src=w);v.insert(n,nt.failed);l++;t(l,y)}}function et(){if(!this[p]){var n=this[h].url;a(this,n);k.useImageDisposer&&(this.src=w);v.insert(n,nt.timedout);l++;t(l,y)}}function a(n,t){n[p]=!0;n.onload=null;n.onerror=null;n.onabort=null;window.clearTimeout(n[g]);for(var r=n[h],i=f.length;i--;)f[i]===r&&f.splice(i,1);c--;delete e[t]}var u=this;u.useCORS=n||!1;var w="data:image/gif;base64,R0lGODlhAQABAPAAAP///wAAACH5BAEAAAAALAAAAAABAAEAAAICRAEAOw==",it=5e3,rt=6,f=[],c=0,e={},o=120,s=new pt(o),v=new pt(30),b=new pt(o),y=0,l=0;t=t||function(){};i=i||function(){};k.useImageDisposer&&s.useDisposer(function(n){n&&n.src&&(n.src=w)});var d="$$",h=d+"downloadRequest",g=d+"timeoutid",p=d+"processed",ut="token";u.hasABlockingDownload=!1;u.blockingDownloadTargetCount=-1;u.blockingDownloadSuccessCount=0;u.blockingDownloadFailureCount=0;u.blockingDownloadProgressCallback=null;u.blockingDownloadFinishCallback=null;u.prefetchedTiles={};u.AllCompleted=new pt(o);u.resetCaches=function(){f.length=0;for(var n in e)a(e[n],n);e={};c=0;s=new pt(o);v=new pt(30);b=new pt(o);u.AllCompleted=new pt(o)};u.hasBlockingDownload=function(){if(u.hasABlockingDownload)if(u.blockingDownloadSuccessCount+=u.AllCompleted.Size(),u.update(),u.blockingDownloadProgressCallback(u.blockingDownloadSuccessCount),u.blockingDownloadSuccessCount+u.blockingDownloadFailureCount==u.blockingDownloadTargetCount)u.blockingDownloadFinishCallback(u.blockingDownloadSuccessCount,u.blockingDownloadFailureCount),u.resetDownloadAll();else return!0;return!1};u.getState=function(n){if(s.get(n))return nt.ready;var t=v.get(n);return t!==undefined?t:e[n]?nt.downloading:b.get(n)?nt.cacheExpired:nt.none};u.downloadImage=function(n,t,i){var r=u.getState(n);r===nt.ready?u.AllCompleted.insert(i,s.get(n)):r!=nt.downloading&&(f.push({url:n,priority:t,token:i}),f.length>900&&(f=f.slice(0,600)))};u.updatePriority=function(n,t){for(var r=!1,i=0;i<f.length;++i)if(f.url===n){r=!0;f.priority=t;break}if(!r)throw"Expected item to be in queue.";};u.cancel=function(n){e[n]&&a(e[n],n)};u.getCacheSize=function(){return s.size()};u.currentlyDownloading=function(){return c!=0};u.update=function(){var i,n,o;for(f.sort(function(n,t){return t.priority-n.priority}),i=0;i<f.length;i++){var s=f[i],t=s.url,l=u.getState(t);switch(l){case nt.none:case nt.timedout:case nt.cacheExpired:c<rt&&(e[t]||(c++,n=document.createElement("img"),e[t]=n,n[h]=s,n.onload=ft,n.onerror=tt,n.onabort=tt,n[g]=Microsoft.Maps.setTimeout(function(){var t=n;return function(){et.call(t)}}(),it),o=!1,u.useCORS&&(o=!r.isDataUrl(t)&&!r.isRelativeUrl(t)&&!r.areSameDomain(t,window.location.toString())),o&&(n.crossOrigin=""),n.src=t))}}};u.resetDownloadAll=function(){u.blockingDownloadTargetCount=0;u.blockingDownloadSuccessCount=0;u.blockingDownloadFailureCount=0;u.hasABlockingDownload=!1;u.customFailFunc=null;u.blockingDownloadProgressCallback=null;u.blockingDownloadFinishCallback=null}},nt={none:0,downloading:1,ready:2,failed:3,timedout:4,cacheExpired:5};pi.prototype={animationDurationMS:250,getInitialCameraParams:function(){return this.initialCameraParams},getDataSourceName:function(){return this.dataSourceName},getWorldConfiguration:function(){return this.worldConfiguration},getViewElements:function(n,t){return this.viewElementContainers[0].getGeometry().getViewElements(n,t)},getViewElementById:function(n,t){return this.viewElementContainers[0].getGeometry().getViewElementById(n,t)},getInteractionController:function(){return this.interactionController},getMinimumLod:function(){return this.viewElementContainers[0].getGeometry().getMinimumLod()},getMaximumLod:function(){return this.viewElementContainers[0].getGeometry().getMaximumLod()},tesselate:function(n,t,i){return this.tesselator.Tesselate(n,t,i)},getElementRawTesselationDensity:function(n,t){return this.tesselator.GetRawDensity(n,t)},covertToScreenSpace:function(n,t,i,r){return this.viewElementContainers[0].getGeometry().covertToScreenSpace(n,t,i,r)},getElementTransform:function(n){return this.viewElementContainers[0].getGeometry().getElementTransform(n)},getZOrder:function(){return 1}};rt.SivDataSourceExists=!0;c(ot,pi);ot.prototype.swapUrlBase=function(n,t){var i,r,u;if(t==null)return n;i=n.split("/");r=t.split("/");for(u in r)i[u]=r[u];return i.join("/")};ot.prototype.overrideHost=function(n,t){for(var r,u,i=0;i<t.length;i++)if(r=t[i][0],u=t[i][1],n.slice(-r.length)===r)return u;return n};ot.prototype.forceToHttps=function(n,t){var i=this.uriRegex.exec(n),r,u;return i==null||i.length<4?n:(r=i[2],u=i[3],r=this.overrideHost(r,t),"https://"+r+u)};ot.prototype.createFromJsonUri=function(n,t,i,r,u){n||t(null,new ti("The specified jsonUri cannot be null or empty",null));window.WinJS?this.createFromFullUrl(n,t,null,!1,u):r?this.createFromFullUrl(n,t,i,r,u):this.createFromFullUrl((window.location.protocol.toLowerCase()==="https:"?this.defaultHttpsPhotosynthServer:this.defaultPhotosynthServer)+this.jsonWrapper.replace("{0}",encodeURIComponent(n)),t,null,r,u)};ot.prototype.createFromFullUrl=function(n,t,i,u,f){var o=this,e,s,h;if(window.WinJS)WinJS.xhr({url:n}).then(function(n){var i=null;try{i=JSON.parse(n.responseText)}catch(r){t(null,new ti("The data returned for the pano is not valid json",r));return}this.createFromJson(i,null);o.worldConfiguration==null?t(null,new ti("The data returned for the pano is valid json but is not valid panorama data",null)):t(o.worldConfiguration)},function(n){t(null,new vi("The url specified for the pano json data did not return a 200 success",n))});else if(f){if(e=new Microsoft.Maps.Internal.originalXMLHttpRequest,"withCredentials"in e)e.open("GET",n,!0);else if(window.XDomainRequest)e=new XDomainRequest,e.onprogress=function(){},e.ontimeout=function(){},e.open("GET",n);else{t(null,new Error("The browser does not support CORS"));return}e.onload=function(){try{var n=JSON.parse(e.responseText);o.createFromJson(n,i);t(o.getWorldConfiguration())}catch(r){t(null,new ti("The data returned for the pano is not valid json",r));return}};e.onerror=function(){t(null,new vi("The url specified for the pano json data did not return a 200 success",null))};Microsoft.Maps.setTimeout(function(){e.send()},0)}else{for(s="PhotosynthCallback",h=0;window[s+h]!=null;)h++;s=s+h;window[s]=function(n){o.createFromJson(n,i);t(o.getWorldConfiguration());delete window[s]};u?r.addScriptElement(n):r.addScriptElement(n+o.jsonpWrapperParam.replace("{0}",s))}};ot.prototype.createFromJson=function(t,i,u){var w,b,k,s,e,v,l,y,et,nt,tt,a,it,h,c,at,rt,vt,p;try{if(t._json_synth&&t._json_synth>=1.01){for(y in t.l)if(t.l.hasOwnProperty(y)){l=t.l[y];break}var ot=l.x[0],st=ot.cubemaps[0],d=st.field_of_view_bounds,ht=ot.r[0],ut=ht.j,g=ht.start_relative_rotation,ct=0,lt=0;if(w=l.b,b=l.attribution_url,k=l.c,g!=null){var yt=new o(0,0,1),pt=f.parseQuaternion(ut[4],ut[5],ut[6]),wt=f.parseQuaternion(g[0],g[1],g[2]),bt=pt.multiply(wt),ft=bt.transform(yt);ct=n.halfPI-Math.acos(ft.y);lt=Math.atan2(ft.z,ft.x)}for(et=null,l.highlight_map&&l.highlight_map.default_highlight&&(et=l.highlight_map.default_highlight),this.worldConfiguration={id:"panorama"+y,type:"panorama",source:{attribution:{author:w,attributionUrl:b,licenseUrl:k},dimension:0,tileSize:254,tileOverlap:1,tileBorder:1,minimumLod:8,bounds:{left:n.degreesToRadians(d[0]),right:n.degreesToRadians(d[1]),top:n.degreesToRadians(d[3]),bottom:n.degreesToRadians(d[2])},startingPitch:ct,startingHeading:lt,projectorAspectRatio:1,projectorFocalLength:.5,highlights:et}},nt=0;nt<this.faceNames.length;nt++)s=this.faceNames[nt],e=st[s],e!=null&&(tt=this.swapUrlBase(e.u,u.contentBaseUri),u.forceToHttps&&(tt=this.forceToHttps(tt,u.overrideList)),this.worldConfiguration.source[s+"Face"]={tileSource:new pr(tt).getTileUrl,clip:e.clip.vertices},this.worldConfiguration.source.dimension=Math.max(this.worldConfiguration.source.dimension,e.d[0],e.d[1]))}else if(t.cubemap_json_version<2)for(c=1,t.tile_overlap_borders?c=t.tile_overlap_borders+0:t.tile_overlaps_borders&&(c=t.tile_overlaps_borders+0),c=t.tile_overlap_borders===!1?0:1,a=t.face_size,this.worldConfiguration={id:"panorama",type:"panorama",source:{dimension:a,tileSize:t.tile_size||510,tileOverlap:c,tileBorder:c,minimumLod:Math.ceil(Math.log(t.tile_size/Math.LN2)),bounds:{left:0,right:n.twoPI,top:n.halfPI,bottom:-n.halfPI},startingPitch:0,startingHeading:0,projectorAspectRatio:1,projectorFocalLength:.5}},t.field_of_view_bounds&&(this.worldConfiguration.source.bounds={left:n.degreesToRadians(t.field_of_view_bounds[0]),right:n.degreesToRadians(t.field_of_view_bounds[1]),bottom:n.degreesToRadians(t.field_of_view_bounds[2]),top:n.degreesToRadians(t.field_of_view_bounds[3])}),t.initial_look_direction&&(this.worldConfiguration.source.startingPitch=n.degreesToRadians(t.initial_look_direction[0]),this.worldConfiguration.source.startingHeading=n.degreesToRadians(t.initial_look_direction[1])),t.orientation&&(this.worldConfiguration.source.orientation={},this.worldConfiguration.source.orientation.roll=t.orientation[0],this.worldConfiguration.source.orientation.pitch=t.orientation[1],this.worldConfiguration.source.orientation.heading=t.orientation[2]||0),this.worldConfiguration.source.faceSize=a,this.worldConfiguration.source.imageContentType=t.image_content_type||"image/jpeg",this.worldConfiguration.source.imageExtension=t.image_extension||"jpg",this.worldConfiguration.source.hasAtlas=t.has_atlas===!1?!1:!0,it=0;it<this.faceNames.length;it++)s=this.faceNames[it],e=t[s],e!=null&&(e.tile_boundaries?(h=e.tile_boundaries,v=[h.left,h.top,h.left,h.bottom,h.right,h.bottom,h.right,h.top]):v=[0,0,0,a,a,a,a,0],this.worldConfiguration.source[s+"Face"]={tileSource:new sr(i,"formats/cubemap/"+s).getTileUrl,clip:v},this.worldConfiguration.source.maximumLod=Math.ceil(Math.log(this.worldConfiguration.source.faceSize)/Math.LN2),this.worldConfiguration.source.minimumLod=Math.ceil(Math.log(this.worldConfiguration.source.tileSize)/Math.LN2));else if(t.json_pano||t.panorama_json_version)for(c=t.tile_overlap_borders===!1?0:1,w=t.author,t.attribution_uri_format_string&&(b=r.partialDotNetStringFormat(t.attribution_uri_format_string,0,0)),k=null,at=t.publisher,this.worldConfiguration={id:"panorama"+y,type:"panorama",source:{attribution:{author:w,attributionUrl:b,licenseUrl:k,publisher:at},dimension:0,tileSize:t.tile_size,tileOverlap:c,tileBorder:c,minimumLod:Math.ceil(Math.log(t.tile_size/Math.LN2)),bounds:{left:0,right:n.twoPI,top:n.halfPI,bottom:-n.halfPI},startingPitch:0,startingHeading:0,projectorAspectRatio:1,projectorFocalLength:.5}},t.field_of_view_bounds&&(this.worldConfiguration.source.bounds={left:n.degreesToRadians(t.field_of_view_bounds[0]),right:n.degreesToRadians(t.field_of_view_bounds[1]),bottom:n.degreesToRadians(t.field_of_view_bounds[2]),top:n.degreesToRadians(t.field_of_view_bounds[3])}),t.initial_look_direction&&(this.worldConfiguration.source.startingPitch=n.degreesToRadians(t.initial_look_direction[0]),this.worldConfiguration.source.startingHeading=n.degreesToRadians(t.initial_look_direction[1])),rt=0;rt<this.faceNames.length;rt++)s=this.faceNames[rt],e=t[s],e!=null&&(v=e.clip&&e.clip.vertices?e.clip.vertices:[0,0,0,e.dimensions[1],e.dimensions[0],e.dimensions[1],e.dimensions[0],0],p=e.tile_image_uri_format_string,u.imageTileUriSuffix&&(p+=u.imageTileUriSuffix),u.forceToHttps&&(p=this.forceToHttps(p,u.overrideList)),vt=t.panorama_json_version?new sr(i,s).getTileUrl:new br(p,e.dimensions[0],e.dimensions[1],t.tile_size,e.finest_lod,e.number_of_lods).getTileUrl,this.worldConfiguration.source[s+"Face"]={tileSource:vt,clip:v},this.worldConfiguration.source.dimension=Math.max(this.worldConfiguration.source.dimension,e.dimensions[0],e.dimensions[1]),this.worldConfiguration.source.minimumLod=Math.ceil(Math.log(this.worldConfiguration.source.tileSize)/Math.LN2));this.viewElementContainers.push(new rr(this.worldConfiguration));this._minimumLod=this.worldConfiguration.source.minimumLod;this._maximumLod=this.worldConfiguration.source.maximumLod||n.ceilLog2(this.worldConfiguration.source.dimension);this.baseImageWidth=this.baseImageHeight=this.worldConfiguration.source.dimension;this.tileHeight=this.tileWidth=this.worldConfiguration.source.tileSize}catch(kt){window.console&&r.log(kt)}};ot.prototype.createController=function(t,i){var r=null;return t&&(r=f.calculateFovAtTexelToPixelRatio(f._cubeSide,t.dimension,i.getViewport().getHeight(),1.1)),this.interactionController=new wi(i,null,null,null,r),t&&(t.startingPitch!=undefined&&this.interactionController.setPitchAndHeading(t.startingPitch,t.startingHeading,null),this.interactionController.setBounds(t.bounds),this.interactionController.setDimension(t.dimension),this.interactionController.setVerticalFov(n.degreesToRadians(80),null)),this.interactionController};c(w,pi);w.prototype.animationDurationMS=0;w.prototype.createController=function(t,i,r,u){var s=null,e,o;return t&&(s=f.calculateFovAtTexelToPixelRatio(f._cubeSide,t.maximumResolution,u||i.getViewport().getHeight(),.3)),e=0,o=0,t&&(t.startingPitch!=undefined&&(e=t.startingPitch),t.startingHeading!=undefined&&(o=t.startingHeading)),this.interactionController=this.isCursorAndLabelEnabled?new bi(i,r,n.degreesToRadians(89.9),n.degreesToRadians(-89.9),s,o,e,this.localToGlobal,this.bubbleCenterInGlobal):new hi(i,r,n.degreesToRadians(89.9),n.degreesToRadians(-89.9),s,o,e),this.interactionController.setViewTarget(e,o,null,!1),this.interactionController};w.prototype.createCameraParameters=function(t,i,r,u){var f=this.createRotationMatrix(t,i,r);return{verticalFov:u||n.degreesToRadians(80),position:new o(0,0,0),look:f.transformVector3(new o(0,0,-1)),up:f.transformVector3(new o(0,1,0)),side:f.transformVector3(new o(1,0,0))}};w.prototype.createRotationMatrix=function(n,t,r){var u=i.createRotationZ(n),f=i.createRotationX(-t),e=i.createRotationY(r);return u.multiply(f.multiply(e))};w.prototype.setRoadVector=function(n){for(var t=0;t<n.length;++t)this.roadVectorGroup.push(n[t]);this.isRoadVectorReady=!0};w.prototype.generateLabelRenderables=function(n,t){for(var i=this.labelConfiguration.labelOffsetFromBubbleInMeters,r=this.labelConfiguration.labelOffsetMaxInMeters,u=this.labelConfiguration.labelOffsetIncreaseStepInMeters;!this.tryFindLabelsAndMakeIfExist(n,i,t)&&i<r;)i+=u;this.isRoadVectorReady=!1};w.prototype.tryFindLabelsAndMakeIfExist=function(t,r,u){var ut=document.createElement("canvas"),g=ut.getContext("2d"),p=87,ft,w,h,b,et,k,v,d,c,ht,ct,e,f;g.canvas.height=p;g.font=this.labelConfiguration.font;var it=this.labelConfiguration.entityId,lt=this.worldConfiguration.source.cameraHeight,ii=this.worldConfiguration.source.latitude,ri=this.worldConfiguration.source.longitude,l=new o(0,1,0),a=[];for(e=0;e<this.roadVectorGroup.length;++e)for(ft=this.roadVectorGroup[e].latLonArray.length,w=this.roadVectorGroup[e].latLonArray,h=0;h<ft-1;++h){var at=w[h].latitude,vt=w[h].longitude,yt=w[h+1].latitude,pt=w[h+1].longitude,wt=s.fromLatLongAlt(at,vt,0),bt=s.fromLatLongAlt(yt,pt,0),kt=this.bubbleCenterInGlobal.subtract(wt),dt=this.bubbleCenterInGlobal.subtract(bt),nt=this.globalToLocal.transformVector3(kt),tt=this.globalToLocal.transformVector3(dt),gt=this.surfaceNormalInLocal.multiplyScalar(nt.dot(l)/this.surfaceNormalInLocal.dot(l)),ni=this.surfaceNormalInLocal.multiplyScalar(tt.dot(l)/this.surfaceNormalInLocal.dot(l));if(nt=nt.subtract(gt),tt=tt.subtract(ni),b=this.findIntersectAndGetLabelLines(nt,tt,l,r),et=i.createTranslation(0,-lt,0),b)for(k=0;k<b.length;++k)if(v=b[k][0],d=b[k][1],!this.checkLabelFullyOverlapped(a,v,d)){var ot="❭"+this.roadVectorGroup[e].name,rt=g.measureText(ot).width,ti=this.createLabelTexture(ut,g,ot,rt,p,22),st=v.add(d.multiplyScalar(rt*this.labelConfiguration.textureToGeometryRatio)),y=d.cross(l);y=y.multiplyScalar(p*this.labelConfiguration.textureToGeometryRatio/2);c=[];c[0]=st.subtract(y);c[1]=st.add(y);c[2]=v.add(y);c[3]=v.subtract(y);ht=0;f=new li(c,[ti],it,ht);f.dimension=rt;ct=f.texturesWithPolygons[0].texture;ct.loadImageInDOM();f.transform=et;f.startPoint=v;f.direction=d;f.geometryPolygon=c;a.push(f)}}for(this.pushLabelsForwardIfNeeded(a),e=0;e<a.length;++e)f=a[e],f.id={id:it+e,levelOfDetail:24},t.add(it+e,f),f.startPoint.w=1,u&&(f.transform=f.transform.multiply(i.createTranslation(f.startPoint.x,0,f.startPoint.z).multiply(i.createRotationY(Math.atan2(f.direction.x,f.direction.z)+n.degreesToRadians(90))).multiply(i.createRotationZ(n.degreesToRadians(180))).multiply(i.createRotationX(n.degreesToRadians(90))).multiply(i.createScale(1/p,1/p,1))));return a.length>0?!0:!1};w.prototype.createLabelTexture=function(n,t,i,r,u,f){var s,e,o;return t.clearRect(0,0,r,u),t.canvas.width=r,t.font=this.labelConfiguration.font,t.fillStyle="white",t.font=this.labelConfiguration.font,t.fillText(i,0,u-f),s=n.toDataURL(),e=[],e[0]=new h(r,0),e[1]=new h(r,u),e[2]=new h(0,u),e[3]=new h(0,0),o={texture:new ut(s,null,null,null,null,null,null),polygon:e},o.texture.dataSourceWidth=r,o.texture.dataSourceHeight=u,o};w.prototype.findIntersectAndGetLabelLines=function(n,t,i,r){var u=t.subtract(n).normalize(),y=u.cross(i),f=-u.dot(n),e=Math.pow(-f,2)-(n.lengthSquared()-Math.pow(r,2)),h=t.subtract(n).length(),o=[],s;if(!(e<0)){if(e==0){f>=0&&f<=h&&o.push([n+f*u,u]);return}var c=f-Math.sqrt(e),l=f+Math.sqrt(e),a=n.add(u.multiplyScalar(c)),v=n.add(u.multiplyScalar(l));return c>=0&&c<=h&&(s=a.dot(u)>0?1:-1,o.push([a,u.multiplyScalar(s)])),l>=0&&l<=h&&(s=v.dot(u)>0?1:-1,o.push([v,u.multiplyScalar(s)])),o}};w.prototype.make2DLabelPolygon=function(n){for(var r=[],i=n.geometryPolygon,t=0;t<i.length;++t)r[t]=new h(i[t].x,i[t].z);return r};w.prototype.pushLabelsForwardIfNeeded=function(n){var k,w,e,l,a,v,t,r,c,p;if(!(n.length<2))for(k=new o(0,1,0),w=this.worldConfiguration.source.cameraHeight,e=1;e<n.length;++e)for(l=0;l<e;++l){var s=n[e],h=n[l],tt=this.make2DLabelPolygon(s),it=this.make2DLabelPolygon(h);if(f.AreIntersecting(tt,it)){t=s.direction;r=h.direction;t.cross(r).dot(k)>0?(a=this.getEdgeOfLabel(s,1)[0],v=this.getEdgeOfLabel(h,0)[0]):(a=this.getEdgeOfLabel(s,0)[0],v=this.getEdgeOfLabel(h,1)[0]);var rt=a.x,d=a.z,ut=v.x,g=v.z,y=t.x,u=t.z,nt=r.x,b=r.z,ft=u*nt-y*b;Math.abs(ft)>1e-6&&Math.abs(u)>1e-6&&(c=(u*rt-u*ut-y*d+y*g)/(u*nt-y*b),p=(b*c-d+g)/u,c>1e-6&&p>1e-6&&(s.transform=i.createTranslation(p*t.x,-w,p*t.z),h.transform=i.createTranslation(c*r.x,-w,c*r.z)))}}};w.prototype.getEdgeOfLabel=function(n,t){var i=[];return t==0?(i[0]=n.geometryPolygon[2],i[1]=n.geometryPolygon[1]):t==1&&(i[0]=n.geometryPolygon[3],i[1]=n.geometryPolygon[0]),i};w.prototype.checkLabelFullyOverlapped=function(n,t,i){for(var u,f,r=0;r<n.length;++r)if(u=n[r].startPoint,f=n[r].direction,t.subtract(u).length()<2&&i.dot(f)>.9848077)return!0;return!1};w.prototype.generateCursorRenderableIfNecessary=function(n){var l=n.map,f,r,c,e;if(!l[this.cursorConfiguration.entityId]){var t=this.cursorConfiguration.textureSize,s=this.cursorConfiguration.textureExpansion,u=[];u[0]=new h(t,0);u[1]=new h(t,t);u[2]=new h(0,t);u[3]=new h(0,0);f={texture:new ut("",null,null,null,null,null,null),polygon:u};f.texture.dataSourceWidth=t-s;f.texture.dataSourceHeight=t-s;r=[];r[0]=new o(1,0,-1);r[1]=new o(1,0,1);r[2]=new o(-1,0,1);r[3]=new o(-1,0,-1);c=0;e=new li(r,[f],this.cursorConfiguration.entityId,c);e.transform=i.createIdentity();e.id={id:this.cursorConfiguration.entityId,levelOfDetail:24};n.add(this.cursorConfiguration.entityId,e)}};w.prototype.updateCursorRenderableTranslation=function(t,r,u){var f=t.map;f[this.cursorConfiguration.entityId]&&(f[this.cursorConfiguration.entityId].transform=u?r.multiply(i.createTranslation(-.5,0,.5).multiply(i.createRotationY(n.degreesToRadians(90))).multiply(i.createRotationX(n.degreesToRadians(90))).multiply(i.createScale(2/this.cursorConfiguration.textureSize,2/this.cursorConfiguration.textureSize,1))):r)};w.prototype.prepareCursorTextureIfNecessary=function(n){var i=n.map,t=i[this.cursorConfiguration.entityId];t&&(texture=t.texturesWithPolygons[0].texture,texture._image==null&&(texture._image=new Image,texture._image.style.opacity=.5,texture._image.src=this.cursorConfiguration.textureData,texture._isDirty=!0,texture._isReady=!0))};rt.StreetsidePanoramaExists=!0;at.prototype={hasParent:function(){return this.levelOfDetail>0},getParent:function(){if(!this.hasParent())throw"0 level does not have a parent";return new at(this.levelOfDetail-1,this.x>>1,this.y>>1,this.faceName,this.idFunction)},getChildren:function(){var n=this.x<<1,t=this.y<<1;return[new at(this.levelOfDetail+1,n,t,this.faceName,this.idFunction),new at(this.levelOfDetail+1,n+1,t,this.faceName,this.idFunction),new at(this.levelOfDetail+1,n,t+1,this.faceName,this.idFunction),new at(this.levelOfDetail+1,n+1,t+1,this.faceName,this.idFunction)]},isChildOf:function(n){if(this.levelOfDetail<n.levelOfDetail)return!1;var t=this.levelOfDetail-n.levelOfDetail;return this.x>>t===n.x&&this.y>>t===n.y},equals:function(n){return this.x===n.x&&this.y===n.y&&this.levelOfDetail===this.levelOfDetail},toString:function(){return"("+this.x+","+this.y+","+this.levelOfDetail+")"}};ni.prototype.getGeometry=function(){return this._geometry};c(rr,ni);c(ur,ni);ii.prototype={getTileSize:function(){return this._worldConfiguration.source.tileSize},getMinimumLod:function(){return this._minimumLod},getMaximumLod:function(){return this._maximumLod},getViewElements:function(n,t,i,r){function h(t,i,r,f,o,s){for(var h,w,l,v,c,b,y=n._tileOverlap,p=[],k=r.length,a=0;a<k;a++)h=r[a],p.push(new e(y+h.x*o,y+h.y*s,h.z,h.w));w=f.uuid;l=new at(f.lod,i.x,i.y,f.faceName,function(n){return w+"_"+n.faceName+n.levelOfDetail+"_"+n.x+"_"+n.y});f.getFullTransforms?(v=f.datasource.getElementTransform(l),c=f.datasource.getTileSize(),i=[new e(0,c,0,1),new e(0,0,0,1),new e(c,0,0,1),new e(c,c,0,1)]):v=f.datasource.getFaceTransform(1,u);b=new ru(i,p,v,f.tileSource,l,o,s);t[l.id]=b}var f,u,o,s;if(i<n._minimumLod||i>n._maximumLod)return null;if(n._viewElementsByLod[i])return n._viewElementsByLod[i];for(n._viewElementsByLod[i]={},f=0;f<n._faceNames.length;f++)u=n._faceNames[f],o=n._worldConfiguration.source,o&&o[u]&&(s={getFullTransforms:r,datasource:n,tileSource:o[u].tileSource,lod:i,uuid:n._worldConfiguration.id+"_"+u,faceName:u},t(h,s));return n._viewElementsByLod[i]},getFaceTransform:function(t,r){var f=i.createTranslation(-.5,-.5,0).multiply(i.createScale(1/t,1/t,1)),e=.5,u;switch(r){case"frontFace":u=i.createTranslation(0,0,-e).multiply(f);break;case"backFace":u=i.createTranslation(0,0,e).multiply(i.createRotationY(n.degreesToRadians(180)).multiply(f));break;case"leftFace":u=i.createTranslation(-e,0,0).multiply(i.createRotationY(n.degreesToRadians(90)).multiply(f));break;case"rightFace":u=i.createTranslation(e,0,0).multiply(i.createRotationY(n.degreesToRadians(-90)).multiply(f));break;case"topFace":u=i.createTranslation(0,e,0).multiply(i.createRotationX(n.degreesToRadians(90)).multiply(f));break;case"bottomFace":u=i.createTranslation(0,-e,0).multiply(i.createRotationX(n.degreesToRadians(-90)).multiply(f));break;default:throw"unexpected cube face name";}return u},covertToScreenSpace:function(n,t,i,r){for(var u,s,h=n.length,l=t,c=new Array(h),e=f._halfCube,o=0;o<h;++o)u=n[o],s=u.w,u.x=(u.x/s*e+e)*i,u.y=r-(u.y/s*e+e)*r,u.z=u.z/s,c[o]=u;return new yi(c,l)},getElementTransform:function(n){var r=Math.pow(2,this._maximumLod-n.levelOfDetail),u=1,e=this._baseImageWidth/r,t=this._baseImageHeight/r,o=i.createScale(u,u,1),s=n.x*this._tileWidth,v=this._tileHeight,f=n.y*this._tileHeight+this._tileHeight,h=f<t?this._tileHeight:this._tileHeight-(f-t),c=t-(h+n.y*this._tileHeight),l=i.createTranslation(-this._tileOverlap,-this._tileOverlap,0),a=i.createTranslation(s,c,0);return this.getFaceTransform(e,n.faceName).multiply(o.multiply(a.multiply(l)))}};c(er,ii);c(or,ii);var pr=function(n){this.getTileUrl=function(t,i,r){return n+r+"/"+t+"_"+i+".jpg"}},sr=function(n,t){this.getTileUrl=function(i,r,u){return n()+t+"/"+u+"/"+i+"_"+r+".jpg"}},br=function(n,t,i,u,f,e){var o=Math.ceil(Math.log(Math.max(t,i))/Math.LN2),h=o-f,s=Math.ceil(Math.log(u)/Math.LN2),c=t/Math.pow(2,o),l=i/Math.pow(2,o);this.getTileUrl=function(t,i,u){var o=u-h,a,v;return o>f||o<=f-e?null:(a=Math.ceil(Math.pow(2,u-s)*c),v=Math.ceil(Math.pow(2,u-s)*l),r.partialDotNetStringFormat(n,o,t,i))}};var di={fromTileId:function(n,t){var e=1,r;t&&(e=0);var i="",u=n.x,f=n.y;for(r=0;r<n.levelOfDetail;r++)i=((u&1)+2*(f&1)).toString()+i,u>>=1,f>>=1;return i},isInBounds:function(n){if(n.x<0||n.y<0)return!1;var t=1<<n.levelOfDetail;return n.x>=t||n.y>=t?!1:!0}},eu=function(n){var u=this,t;u.lastAttribution=null;var l='<div id="attributionControl" class="panoramaAttributionControl panoramaAttributionControlContainer" > <a id="icon_anchor" class="panoramaAttributionControl"> <div class="panoramaAttributionControl  panoramaAttributionControlIcon" id="by_icon"><\/div> <div class="panoramaAttributionControl  panoramaAttributionControlIcon" id="nc_icon"><\/div> <div class="panoramaAttributionControl  panoramaAttributionControlIcon" id="nd_icon"><\/div> <div class="panoramaAttributionControl  panoramaAttributionControlIcon" id="sa_icon"><\/div> <div class="panoramaAttributionControl  panoramaAttributionControlIcon" id="pd_icon"><\/div><\/a> <div class="panoramaAttributionControl  panoramaAttributionControlIcon" id="copyright_icon"><\/div> <a class="panoramaAttributionControl" id="authorTextAnchor" href=""><span class="panoramaAttributionControl panoramaAttributionControlText"  id="authorText"><\/span><\/a> <span class="panoramaAttributionControl panoramaAttributionControlText"  id="authorTextNoAnchor"><\/span> <span class="panoramaAttributionControl panoramaAttributionControlText" id="attributionDash">&ndash;<\/span> <span id="publisherText"class="panoramaAttributionControl panoramaAttributionControlText" ><\/span> <\/div>',c="$$$$",s=document.createElement("div");n.appendChild(s);typeof MSApp=="object"&&MSApp.execUnsafeLocalFunction?MSApp.execUnsafeLocalFunction(function(){s.innerHTML=l}):s.innerHTML=l;n.removeChild(s);t=s.firstChild;n.appendChild(t);var f=function(n){if(!n[c+"displayValue"]){var t=n.style.display||window.getComputedStyle(n,null).getPropertyValue("display");n[c+"displayValue"]}r.css(n,{display:"none"})},e=function(n){var t=n[c+"displayValue"]||(n.tagName==="A"||n.tagName==="SPAN"?"inline":"inline-block");r.css(n,{display:t})},i=function(n,t){return t||(t=document),t.querySelector(n)},o=function(n,t){n.innerHTML=t};r.css(t,{display:"block"});f(t);var a=["pd_icon","by_icon","sa_icon","nc_icon","nd_icon","copyright_icon"],h={publicDomain:{pattern:"/publicdomain/",text:"This work is identified as Public Domain.",url:"http://creativecommons.org/licenses/publicdomain/",iconsToShow:["pd_icon"]},by:{pattern:"/by/",text:"This work is licensed to the public under the Creative Commons Attribution license.",url:"http://creativecommons.org/licenses/by/3.0/",iconsToShow:["by_icon"]},bySa:{pattern:"/by-sa/",text:"This work is licensed to the public under the Creative Commons Attribution-ShareAlike license.",url:"http://creativecommons.org/licenses/by-sa/3.0/",iconsToShow:["by_icon","sa_icon"]},byNd:{pattern:"/by-nd/",text:"This work is licensed to the public under the Creative Commons Attribution-NoDerivatives license.",url:"http://creativecommons.org/licenses/by-nd/3.0/",iconsToShow:["by_icon","nd_icon"]},byNc:{pattern:"/by-nc/",text:"This work is licensed to the public under the Creative Commons Attribution-Non-commercial license.",url:"http://creativecommons.org/licenses/by-nc/3.0/",iconsToShow:["by_icon","nc_icon"]},byNcSa:{pattern:"/by-nc-sa/",text:"This work is licensed to the public under the Creative Commons Attribution-Non-commercial-ShareAlike license.",url:"http://creativecommons.org/licenses/by-nc-sa/3.0/",iconsToShow:["by_icon","nc_icon","sa_icon"]},byNcNd:{pattern:"/by-nc-nd/",text:"This work is licensed to the public under the Creative Commons Attribution-Non-commercial-NoDerivatives license.",url:"http://creativecommons.org/licenses/by-nc-nd/3.0/",iconsToShow:["by_icon","nc_icon","nd_icon"]},copyright:{pattern:"",text:"This work is copyrighted.",url:"",iconsToShow:["copyright_icon"]}},v=function(){f(t)},y=function(n){var c,u,l,r,s=h.copyright;for(f(t),r=i("#publisherText",t),f(r),o(r,""),r=i("#authorText",t),f(r),o(r,""),r=i("#authorTextAnchor",t),f(r),r.title="",r.href="",r=i("#authorTextNoAnchor",t),f(r),o(r,""),r=i("#attributionDash",t),f(r),u=0;u<a.length;++u)r=i("#"+a[u],t),f(r);r=i("#icon_anchor",t);r.href="";r.title="";for(c in h)if(h.hasOwnProperty(c)&&n&&n.licenseUrl&&n.licenseUrl.indexOf(h[c].pattern)!=-1){s=h[c];break}for(u=0;u<s.iconsToShow.length;++u)l=s.iconsToShow[u],r=i("#"+l,t),e(r);r=i("#icon_anchor",t);r.title=s.text;r.href=s.url||n.attributionUrl;!n.author&&n.publisher?(r=i("#publisherText",t),f(r),o(r,""),n.attributionUrl?(r=i("#authorText",t),e(r),o(r,n.publisher),r=i("#authorTextAnchor",t),e(r),r.href=n.attributionUrl,r.title=n.attributionUrl):(r=i("#authorTextNoAnchor",t),e(r),o(r,n.publisher))):(n.publisher?(r=i("#publisherText",t),e(r),o(r,n.publisher),r=i("#attributionDash",t),e(r)):(r=i("#publisherText",t),f(r),o(r,"")),n.author&&(n.attributionUrl?(r=i("#authorText",t),e(r),o(r,n.author),r=i("#authorTextAnchor",t),e(r),r.href=n.attributionUrl,r.title=n.attributionUrl):(r=i("#authorTextNoAnchor",t),e(r),o(r,n.author))));e(t)};u.setAttribution=function(n){(u.lastAttribution!=null&&n.author===u.lastAttribution.author&&n.publisher===u.lastAttribution.publisher&&n.attributionUrl===u.lastAttribution.attributionUrl&&n.licenseUrl===u.lastAttribution.licenseUrl||u.lastAttribution===null)&&(y(n),u.lastAttribution=n)};u.clearAttrubution=function(){u.lastAttribution=null;v()};u.dispose=function(){t&&t.parentNode&&(t.parentNode.removeChild(t),t=null)}},lu=function(n,t){function gi(n,t){arguments.length==1&&arguments[0]&&typeof arguments[0]=="object"&&(t=arguments[0].height,n=arguments[0].width);r.css(p,{width:n+"px",height:t+"px"});r.css(k,{width:n+"px",height:t+"px",backgroundColor:"#000000",opacity:0});s.setViewportSize(n,t);y.setViewport(new vt(n,t,y.getViewport().getNearDistance(),y.getViewport().getFarDistance()));w.setViewChanged(!0)}function hi(){return i[e].getInteractionController().getPitch()}function ci(n,t,r){i[e].getInteractionController().setViewTarget(n,null,null,t,r)}function li(){return i[e].getInteractionController().getHeading()}function ai(n,t,r,u){i[e].getInteractionController().setViewTarget(null,n,null,t,r,u)}function vr(){return i[e].getInteractionController().getVerticalFov()}function yr(n,t,r){i[e].getInteractionController().setViewTarget(null,null,n,t,r)}function nr(n){i[e].getInteractionController().zoomIn(n)}function tr(n){i[e].getInteractionController().zoomOut(n)}function pr(n){n.type==="discreteZoom"&&n.mouseInteractionType!=="mousewheel"?c.doubleTappedEvent&&c.doubleTappedEvent.fire(n):n.type==="keydown"?c.keyDownEvent&&c.keyDownEvent.fire(n):n.type==="keyup"&&c.keyUpEvent&&c.keyUpEvent.fire(n)}function ir(n,t){nt=!1;t&&t(n)}function ni(){var r,y,n,t,p,k;if(!pi){if(r=window.stats,r!==undefined&&r.begin(),o&&o.control)y=o.control(y,ot?v.getQueuedEvents():[]);else{h=null;return}if(n=y.getPose(),a.hasBlockingDownload()||n.height<=0||n.width<=0){ti&&(h=si(ni));return}var d=bi?.1:1,f=v.userCurrentlyInteracting(),b=wt!=null&&!wt.isFuzzyEqualTo(n,d),s=(new Date).valueOf();f?yt=null:wi&&(yt==null&&(yt=s+1e3),yt>s?f=!0:yt=null);var l=f||b,g=l!==ki,u=g||l||a.currentlyDownloading()||!wt.isFuzzyEqualTo(n,.001);if(u?at=null:pt&&(at==null&&(at=s+500),at>s?u=!0:at=null),wt=n,wi=f,bi=b,ki=l,t=!0,p=!1,i[e].isCursorAndLabelEnabled&&(p=o.getIsNewHitTestResult(),o.setIsNewHitTestResult(!1)),(nt||u||pt||p)&&(t=w.RenderFrame(l)),i[e].isCursorAndLabelEnabled&&(o.getIsPancakeClicked()?(k=o.getPancakeLocation(),c.tappedEvent.fire(k),o.setIsPancakeClicked(!1)):o.isUpArrowPressed?o.navigateForward():o.isDownArrowPressed&&o.navigateForward(!1)),t&&!u&&pt&&(c.doneRenderingEvent&&c.doneRenderingEvent.fire(c.getView()),!ot)){h=null;return}pt=u||!t;t&&kt!==null&&(c.viewChangeEndEvent.fire(kt),kt=null);h&&(ti||!t||i[e].isCursorAndLabelEnabled)&&(h=si(ni));r!==undefined&&r.end()}}function wr(){for(var t=f.dataSources,i=t.length,n=0;n<i;n++)rr(t[n])}function rr(n){e=n.getDataSourceName();i[n.getDataSourceName()]=n;i.push(n);h||(h=si(ni))}function ur(n){if(n){er();for(var t=0;t<i.length;t++)i[e]===i[t]&&i.splice(t,1);delete i[e];rr(n);y.setCameraParameters(n.initialCameraParams);hr();fr()}}function fr(){var n=i[e].getInteractionController();n.viewChangeEvent.addEventListener(or);n.viewChangeEndEvent.addEventListener(sr)}function er(){var n=i[e].getInteractionController();n.viewChangeEvent.removeEventListener(or);n.viewChangeEndEvent.removeEventListener(sr)}function or(n){c.viewChangeEvent.fire(n)}function sr(n){kt=n}function br(n,t){var i={width:n+"px",height:t+"px",position:"absolute",direction:"ltr",overflow:"hidden",tabIndex:0,"-ms-touch-action":"none","touch-action":"none"},u={width:n+"px",height:t+"px",position:"absolute",webkitTapHighlightColor:"rgba(0,0,0,1)",tabIndex:0,zIndex:99,"-ms-touch-action":"none","touch-action":"none"};f.top&&(i.top=f.top+"px",u.top=f.top+"px");f.left&&(i.left=f.left+"px",u.left=f.left+"px");r.css(p,i);r.css(k,u)}function kr(){var t=.2617993877991494,i=.4363323129985824;st(ii,g,"sivZoomInButton","+",65,20,function(n){b(n);nr(!0)},1);st(ri,g,"sivZoomOutButton","-",20,20,function(n){b(n);tr(!0)},2);st(ei,g,"sivPitchUpButton","^",42,85,function(n){b(n);ci(hi()+t,!0,null)},5);st(ui,g,"sivHeadingLeftButton","<",65,130,function(n){b(n);ai(li()-i,!0,null)},3);st(fi,g,"sivHeadingRightButton",">",20,130,function(n){b(n);ai(li()+i,!0,null)},4);st(oi,g,"sivPitchDownButton","v",42,170,function(n){b(n);ci(hi()-t,!0,null)},6);g.type="text/css";n.appendChild(g)}function st(t,i,u,f,e,o,s,h){i.innerHTML+=" ."+u+" { width: 35px; height: 35px; position: absolute; right: "+e+"px; top: "+o+"px; z-index: 777; tabIndex: "+h+" }";t.id=u;t.innerHTML=f;t.className=u;r.bind(t,"touchend",s,null);r.bind(t,"touchstart",b,null);r.bind(t,"touchend",b,null);r.bind(t,"touchcancel",b,null);r.bind(t,"click",s,null);r.bind(t,"dblclick",b,null);n.appendChild(t)}function b(n){n.stopPropagation();n.stopImmediatePropagation();n.preventDefault()}function dr(){var n=f.renderer,t;n=n?n.toLowerCase():"";switch(n){case"webgl":if(!ht("webgl"))throw"WebGL is not supported";break;case"css3d":if(!ht("css3d"))throw"CSS3D is not supported";break;case"canvas2d":if(!ht("canvas2d"))throw"Canvas is not supported";break;default:if(!ht("webgl")&&!ht("css3d")&&!ht("canvas2d"))throw"Could not create webgl, css3d or canvas renderers: "+n;}t=tt.debugEnabled?{r:.4,g:.4,b:.4,a:1}:f.backgroundColor;s&&s.setBackGroundColor(t)}function ht(n){try{switch(n){case"webgl":s=new d(p,ft,et);vi=!0;break;case"css3d":s=new l(p,ft,et);break;case"canvas2d":s=new it(p,ft,et)}}catch(t){return!1}return s!=null}function nu(){var t,n;if(f.dataSources)for(t=i.length,n=0;n<t;n++)yi.add(i[n].getWorldConfiguration());else throw"expected worldConfiguration property passed in the options object";}function tu(){var t=null,n;return f.dataSources&&f.dataSources.length>0&&(f.dataSources.length==1?(n=f.dataSources[0],n&&n.worldConfiguration&&n.worldConfiguration.source&&n.worldConfiguration.source.attribution&&(t=n.worldConfiguration.source.attribution)):r.log("Attribution: More than one datasource encountered")),t}function iu(){var t=tu();f.hideAttribution||t&&(ct=new eu(n),ct.setAttribution(t));t&&cr(t)}function hr(){for(var n,t,u=i.length,r=0;r<u;r++)n=i[r],n.createController&&(t=n.createController(n.worldConfiguration.source,y,y.getCameraParameters(),f.height),o&&(t._scrollAccX=o._scrollAccX,t._scrollAccY=o._scrollAccY,o.stopMovingCamera()),o=t,n.outputMultiLODTiles!=null&&(rt.outputMultiLODTiles=n.outputMultiLODTiles),n.scanConvertSize!=null&&(rt.scanConvertSize=n.scanConvertSize))}function ru(){a.customFailFunc&&a.customFailFunc();f.tileDownloadFailed&&f.tileDownloadFailed();rt.tileDownloadFailed&&rt.tileDownloadFailed()}var v,dt,di,gt;if(!n)throw"expected div argument";var ut="button",c=this,f=t||{},cr=f.attributionChanged||function(){},ti=!0,p=document.createElement("div"),k=document.createElement("div"),vi=!1,s=null,yi=new fu,i=[],e=null,ft=f.width||n.offsetWidth,et=f.height||n.offsetHeight,ct=null,o=null,h,ot=!0,nt=!1,pi=!1,pt=null,wt=null,wi=null,bi=null,ki=null,at=null,yt=null,bt=300,ar=new vt(ft,et,1e-5,100),y=null,a=null,w=null,kt=null,ii=document.createElement(ut),ri=document.createElement(ut),ui=document.createElement(ut),fi=document.createElement(ut),ei=document.createElement(ut),oi=document.createElement(ut),g=document.createElement("style");for(wr(),br(ft,et),dr(),nu(),iu(),n.appendChild(p),n.appendChild(k),f.hideDefaultControls||kr(),v=new gr(k,pr),f.noInteraction||v.enable(),a=new ou(vi,ru,f.tileDownloadSucceeded),dt=null,di=i.length,gt=0;gt<di;gt++){dt=i[gt].getInitialCameraParams();break}y=new au(ar,dt);w=new cu(s,i,y,a);gi(ft,et);hr();f.height=null;this.viewChangeEvent=new lt;this.viewChangeEndEvent=new lt;this.doneRenderingEvent=new lt;this.keyDownEvent=new lt;this.keyUpEvent=new lt;this.doubleTappedEvent=new lt;this.tappedEvent=new lt;this.removeDataSource=function(n,t,f){t=t||u.TYPE.FadeOut;for(var e=0,o=i.length;e<o;e++)if(n&&i[e].dataSourceName===n){w.registerDataSourceForRemoval(n,t,bt,function(n){var t=n.getDataSourceName();r.deleteFromArray(i,function(n){return n&&n.getDataSourceName()===t});a.resetCaches();i.length===0&&(lr(h),h=null);f&&f(t)});nt=!0;return}if(n&&i[n]){w.registerDataSourceForRemoval(n,t,bt,function(n){var t=n.getDataSourceName();r.deleteFromArray(i,function(n){return n&&n.getDataSourceName()===t});i[t]=null;f&&f(t)});nt=!0;return}r.log(n+" was not found in the list of active datasources");return};this.addDataSource=function(n,t,i,r,f,e,o){i=i||u.TYPE.FadeIn;ur(n);e=e!==undefined?e:null;f=f!==undefined?f:null;o=o!==undefined?o:null;this.setView(e,f,o,!1,0);a.resetCaches();w.registerDataSourceForAdd(n,i,bt,function(n){r&&r(n);nt=!1});nt=!0};this.dispose=function(){pi=!0;v&&(v.disable(),v=null);p.parentNode&&(p.parentNode.removeChild(p),p=null);k.parentNode&&(k.parentNode.removeChild(k),k=null);ct&&(ct.dispose(),ct=null);ti=!1;er();lr(h);h=null;a.resetDownloadAll();a.resetCaches();a=null;w.dispose();w=null;yi=null;y=null;dt=null;r._unbindAll(ii);r._unbindAll(ri);r._unbindAll(ui);r._unbindAll(fi);r._unbindAll(ei);r._unbindAll(oi);ii=null;ri=null;ui=null;fi=null;ei=null;oi=null;g=null;this.viewChangeEvent=null;this.viewChangeEndEvent=null;this.doneRenderingEvent=null;this.keyDownEvent=null;this.keyUpEvent=null;this.doubleTappedEvent=null;this.tappedEvent=null;s=null;n=null;i.length=0;for(var t in i)i.hasOwnProperty(t)&&delete i[t]};this.setViewportSize=gi;this.getViewportSize=function(){return{width:y.getViewport().getWidth(),height:y.getViewport().getHeight()}};this.getView=function(){return i[e].getInteractionController().getView()};this.setView=function(n,t,r,u,f,o){i[e].getInteractionController().setViewTarget(n,t,r,u,f,o)};this.getPitch=hi;this.setPitch=ci;this.getHeading=li;this.setHeading=ai;this.getBounds=function(){return i[e].getInteractionController().getBounds()};this.getVerticalFov=vr;this.setVerticalFov=yr;this.zoomIn=nr;this.zoomOut=tr;this.getIsInteractive=function(){return ot};this.setIsInteractive=function(n){ot=n;v&&(ot&&!v.isEnabled()&&v.enable(),!ot&&v.isEnabled()&&v.disable());n&&!h&&(h=si(ni));k.style.visibility=n?"visible":"hidden"};this.setFocus=function(){var n=document.getElementById("focusElement");n&&n.focus()};this.getRendererType=function(){if(s){if(s instanceof l)return"css3d";if(s instanceof d)return"webgl";if(s instanceof it)return"canvas2d"}return""};this.transitionBetweenDataSources=function(n,t,i,f,e,o){function s(n){r.log("'"+n.getDataSourceName()+" ds is out!")}function h(n){r.log("'"+n.getDataSourceName()+"' ds is in! ");ir(n,i)}w.registerDataSourceForRemoval(n.getDataSourceName(),u.TYPE.HalfFadeOut,f+bt,s);ur(t);o=o!==undefined?o:null;e=e!==undefined?e:null;this.setView(o,e,null,!1,0);a.resetCaches();w.registerDataSourceForAdd(t,u.TYPE.FadeIn,f,h)||ir(null,i);nt=!0};fr()},fr=window.Microsoft||(window.Microsoft={}),bt=fr.ImmersiveViewer||(fr.ImmersiveViewer={});bt.SharedImmersiveViewer=lu;bt.PhotosynthSivDataSource=ot;bt.StreetsideSivDataSource=w;bt.JsonDownloadFailedError=vi;bt.JsonMalformedError=ti;bt.Utils=r;bt.DebugHelper=tt})();var l=this&&this.__extends||function(){var n=function(t,i){return n=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(n,t){n.__proto__=t}||function(n,t){for(var i in t)t.hasOwnProperty(i)&&(n[i]=t[i])},n(t,i)};return function(t,i){function r(){this.constructor=t}n(t,i);t.prototype=i===null?Object.create(i):(r.prototype=i.prototype,new r)}}(),ft=function(){function t(){this._cache=new di;this.EarthRadius=6371e3}return t.prototype.hasItem=function(n){var i,r;return this._isValidRequest(n)?(i=n,t.IsByLocationRequest(i))?(r=this._cache.getBoundingBox(),r&&r.contains(i.center)):this._cache.getId()===i.toString():!1},t.prototype.getItem=function(i){var f,o,s,u,y,r;if(!this._isValidRequest(i))return null;if(f=i,t.IsByLocationRequest(f)){if(o=f.center,e.time("BBCachingStrategyByLocation"),s=this._cache.getBoundingBox(),!s||!s.contains(o))return[];var l,h=new ii(o.latitude,o.longitude),k=this._cache.getCachedBubbles(),a=this._cache.getPrecomputedMapLocations(),v=Number.MAX_VALUE,c;for(u=0,y=a.length;u<y;u++){r=a[u];e.assert(r!=null&&r!==undefined,"malformed precomputed bubble location found.");var p=n.degreesToRadians(h.latitude-r.latitude),w=n.degreesToRadians(h.longitude-r.longitude),b=Math.sin(p/2)*Math.sin(p/2)+Math.cos(r.latRadians)*Math.cos(h.latRadians)*Math.sin(w/2)*Math.sin(w/2),d=2*Math.atan2(Math.sqrt(b),Math.sqrt(1-b));c=this.EarthRadius*d;c<v&&(v=c,l=k[u])}return e.timeEnd("BBCachingStrategyByLocation"),[l]}return this._cache.getId()===f.toString()?this._cache.getCachedBubbles():null},t.prototype.putItem=function(n,t){if(!this._isValidRequest(n))return!1;var i=this._cache.getId();return this._cache.setNewCache(n,t),i===this._cache.getId()},t.IsByLocationRequest=function(n){return n.width===0&&n.height===0},t.prototype._isValidRequest=function(n){var t=n instanceof p;return e.assert(t,"incorrect usage of BoundingBoxCachingStrategy"),t},t}(),di=function(){function n(){this._precomputedLocations=[]}return n.prototype.getBoundingBox=function(){return this._actualRect},n.prototype.setNewCache=function(n,t){var u,f,i,r;if(!ft.IsByLocationRequest(n)){for(this._bubbles=t,u=t.length,this._precomputedLocations.length=u,e.log(null,"Setting new cache with: "+u+" bubbles."),f=[],i=0;i<u;i++)r=t[i],this._precomputedLocations[i]=new ii(r.la,r.lo),f.push(new o(r.la,r.lo));this._actualRect=f.length>0?p.fromLocations(f):n;this._id=n.toString()}},n.prototype.getId=function(){return this._id},n.prototype.getPrecomputedMapLocations=function(){return this._precomputedLocations},n.prototype.getCachedBubbles=function(){return this._bubbles},n}(),ii=function(t){function i(i,r){var u=t.call(this,i,r)||this;return u.lonRadians=n.degreesToRadians(r),u.latRadians=n.degreesToRadians(i),u}return l(i,t),i}(o),ri=function(){function n(){this._cache=new ai(i.bubbleSourceBubbleLimit)}return n.prototype.hasItem=function(n){var t=this.getStringId(n),i=this._cache.getItem(t);return i!==null},n.prototype.getItem=function(n){var t=this.getStringId(n);return this._cache.getItem(t)},n.prototype.putItem=function(n,t){var u,i,r,o,f,s;if(typeof n=="number")e.assert(t.length<=1,"more than 1 bubbles received in getBubbleById request"),i=t[0];else if(n instanceof p)for(i=t,r=0,o=t.length;r<o;r++)f=t[r],this._cache.addItem(this.getStringId(f.id),f);else e.assert(!0,"Attempting to cache unexpected item in BubbleCache"),i=t;return u=this.getStringId(n),s=this.hasItem(u),this._cache.addItem(u,i),s},n.prototype.getStringId=function(n){return n instanceof String?n:n.toString()},n}(),at=function(){function n(n,t){t===void 0&&(t=new ri);this._bubbleSource=n;this._cachingStrategy=t}return n.prototype.getBubbleById=function(n,t,i){var u=this,r;return this._cachingStrategy.hasItem(n)?(r=this._cachingStrategy.getItem(n),t&&t(r),r):(this._bubbleSource.getBubbleById(n,function(i){return u.putToCacheAndCallback(n,i,t)},i),null)},n.prototype.getBubbleByIdConverter=function(n,t,i,r){return this.getBubbleById(t(n),i,r)},n.prototype.getBubbles=function(n,t,i,r){var f=this,u;return this._cachingStrategy.hasItem(n)?(u=this._cachingStrategy.getItem(n),i&&i(u),u):(this._bubbleSource.getBubbles(n,t,function(t){return f.putToCacheAndCallback(n,t,i)},r),null)},n.prototype.getBubblesConverter=function(n,t,i,r,u){return this.getBubbles(t(n),i,r,u)},n.prototype.putToCacheAndCallback=function(n,t,i){this._cachingStrategy.putItem(n,t);i&&i(t)},n}(),vt=function(){function n(){this.bubbleCountRegex=new RegExp("{bubbleCount}","g")}return n.prototype.getBubbleById=function(n,t,r){if(n==null)r();else{var u=i.getBubblesByIdUrlFormat.replace("{hsmsgenid}",h.dynamicProperties.streetsideMetadataGenerationId).replace("{id}",n.toString()).replace("{credentials}",nt.credentials);this._makeNetworkCall(u,t,r)}return null},n.prototype.getBubbleByIdConverter=function(n,t,i,r){return this.getBubbleById(t(n),i,r),null},n.prototype.getBubbles=function(n,t,r,u){if(n==null)u();else{var f=i.getBubblesByLocationRectUrlFormat.replace(this.bubbleCountRegex,t.toString()).replace("{hsmsgenid}",h.dynamicProperties.streetsideMetadataGenerationId).replace("{north}",n.getNorth().toString()).replace("{south}",n.getSouth().toString()).replace("{east}",n.getEast().toString()).replace("{west}",n.getWest().toString()).replace("{credentials}",nt.credentials);this._makeNetworkCall(f,r,u)}return null},n.prototype.getBubblesConverter=function(n,t,i,r,u){return this.getBubbles(t(n),i,r,u),null},n.prototype._makeNetworkCall=function(n,t,i){var r=function(n){n.length>=1&&n.splice(0,1);n.length>0?t&&t(n):i&&i()};nt.downloadJson(n,"bubbles",r,function(){return i&&i()},null,!1,null,!1)},n}(),gi=function(){function n(n){this._vanishingPoint=n}return n.prototype.getCameraFocalLength=function(){return n._cameraFocalLength},n.prototype.getVanishingPoint=function(){return this._vanishingPoint},n._cameraFocalLength=250,n}(),nr=function(t){function r(n,i,r,u,f,e,o){var h=t.call(this,0,0,0)||this;return h._streetName=e,h._threeDPosition=new s(n,i,0),h._radiansOfRotation=u,h._initialRadiansOfRotation=u,h._previousRadiansYWasRotated=0,h._canvasCameraProperties=r,h._color="#EBEBEB",h._lineWidth=1,h._arrowPoints=[],h._arrowPoints.push(new s(0,0)),h._arrowPoints.push(new s(15,12.5)),h._arrowPoints.push(new s(15,0)),h._arrowPoints.push(new s(0,-15)),h._arrowPoints.push(new s(-15,0)),h._arrowPoints.push(new s(-15,12.5)),h._rotateAroundXAxis(f),h._nextBubbleId=o,h}return l(r,t),r.prototype.getNextBubbleId=function(){return this._nextBubbleId},r.prototype.getInitialRadiansOfRotation=function(){return this._initialRadiansOfRotation},r.prototype.rotateAroundYAxis=function(n){var t=this._previousRadiansYWasRotated-n;this._previousRadiansYWasRotated=n;var i=Math.cos(t),r=Math.sin(t),u=this._threeDPosition.x*i-this._threeDPosition.z*r,f=this._threeDPosition.z*i+this._threeDPosition.x*r;this._threeDPosition.x=u;this._threeDPosition.z=f;this._threeDPosition.y=150;this._radiansOfRotation-=t;this._setScale();this._setPositionAdjustedForScale()},r.prototype._rotateAroundXAxis=function(n){var t=Math.cos(n),i=Math.sin(n),r=this._threeDPosition.y*t-this._threeDPosition.z*i,u=this._threeDPosition.z*t+this._threeDPosition.y*i;this._threeDPosition.y=r;this._threeDPosition.z=u;this._setScale();this._setPositionAdjustedForScale()},r.prototype.draw=function(n){n.save();n.translate(this.x,this.y);n.rotate(this._radiansOfRotation);n.scale(this._scaleX,this._scaleY);n.lineWidth=this._lineWidth;n.fillStyle=this._color;n.strokeStyle=this._color;this._drawStreetName(n);this._drawArrow(n);n.restore()},r.prototype._drawStreetName=function(t){var f;t.save();f=this._getTextRotationAngle();t.rotate(f);t.font="300 14.66px Arial";t.textAlign="right";t.shadowColor="#000000";t.shadowBlur=1;var r=-20,u=0,i=n.normalizeRadian(this._radiansOfRotation);i<=n.thirtyDegreesInRadians||i>=n.twoPI-n.thirtyDegreesInRadians?(t.textAlign="center",r=0,u=-30):i>n.thirtyDegreesInRadians&&i<Math.PI-n.thirtyDegreesInRadians?(t.textAlign="left",r=20):i>=Math.PI-n.thirtyDegreesInRadians&&i<=Math.PI+n.thirtyDegreesInRadians&&(t.textAlign="center",r=0,u=30);t.textBaseline="middle";t.fillText(this._streetName,r,u);t.shadowBlur=0;t.restore()},r.prototype._getTextRotationAngle=function(){var n=0;return n=this._initialRadiansOfRotation==Math.PI||this._initialRadiansOfRotation==0?this._initialRadiansOfRotation-this._previousRadiansYWasRotated:Math.PI-this._initialRadiansOfRotation-this._previousRadiansYWasRotated,this._initialRadiansOfRotation>0&&this._initialRadiansOfRotation!=Math.PI&&(n+=Math.PI),n},r.prototype._drawArrow=function(n){var t,r,i;for(n.beginPath(),n.moveTo(this._arrowPoints[0].x,this._arrowPoints[0].y),t=1,r=this._arrowPoints.length;t<r;t++)i=this._arrowPoints[t],n.lineTo(i.x,i.y);n.closePath();n.fill();n.save();n.shadowColor="#000000";n.shadowOffsetY=1.5;n.fill();n.restore();this._lineWidth>0&&n.stroke()},r.prototype._setScale=function(){var n=this._canvasCameraProperties.getCameraFocalLength(),t=n/(n+this._threeDPosition.z);this._scaleX=this._scaleY=t},r.prototype._setPositionAdjustedForScale=function(){var n=this._canvasCameraProperties.getVanishingPoint();this.x=n.x+this._threeDPosition.x*this._scaleX;this.y=n.y+this._threeDPosition.y*this._scaleY},r.prototype.getBounds=function(){for(var n=1e5,t=-1,r=1e5,u=-1,f=0,c=this._arrowPoints.length;f<c;f++){var e=this._arrowPoints[f],o=this.x+e.x,h=this.y+e.y;n=Math.min(n,o);t=Math.max(t,o);r=Math.min(r,h);u=Math.max(u,h)}return new pi(new s(n-i.navigationControlClickRegionAdjustment,r-i.navigationControlClickRegionAdjustment),new s(t+i.navigationControlClickRegionAdjustment,u+i.navigationControlClickRegionAdjustment))},r}(s),a=function(i){function r(n){var r=this,n=n||{};return r=i.call(this,n)||this,r._rootElement=t._createElement("div"),r._viewer=null,r._currentDataSource=null,r._inDataSourceQueue={},r._outDataSourceQueue={},r}return l(r,i),r.convertBubbleIdToQuad=function(n){if(typeof n!="number"||n<0)throw"bubbleId must be a positive number";var t=n.toString(4);if(t.length>16)throw"bubbleId invalid";return("0000000000000000"+t).slice(-16)},r.convertToRadiansOrReturnNull=function(t){return t!==undefined&&t!=null?n.degreesToRadians(t):null},r.prototype.getSharedImmersiveViewer=function(){return this._viewer},r.prototype.removeSIVContent=function(){var t=this;for(var n in this._inDataSourceQueue)this._inDataSourceQueue.hasOwnProperty(n)&&(this._outDataSourceQueue[n]=!0);this._currentDataSource&&this._viewer.removeDataSource(this._currentDataSource.getDataSourceName(),null,function(){t._currentDataSource=null})},r.prototype.addDataSource=function(n,t,i,r,u){var e=this,f=n.getDataSourceName();this._inDataSourceQueue.hasOwnProperty(f)||(this._inDataSourceQueue[f]=n);this._viewer.addDataSource(n,null,null,function(n){return e._removeFromQueue(n,!0,t)},i,r,u)},r.prototype.getRootElement=function(){return this._rootElement},r.prototype._viewerDoneRendering=function(n,t){this._finishedInitialRender||(this._finishedInitialRender=!0,t&&t.end())},r.prototype.getSivSize=function(){return this._sivSize},r.prototype.updateSivBackGround=function(n){this._sivBackground&&this._sivBackground.set_style({width:n.width+"px",height:n.height+"px"})},r.prototype.dispose=function(){i.prototype.dispose.call(this);this._viewer&&(this._rootElement.remove_event("contextmenu",this._contextMenuHandler),this._viewer.viewChangeEvent.removeEventListener(this._viewerViewChangedHandler),this._viewer.viewChangeEndEvent.removeEventListener(this._viewerViewChangedHandler),this._viewer.doneRenderingEvent.removeEventListener(this._viewerDoneRenderingHandler),this._viewer.dispose(),this._viewer=null)},r.prototype._removeFromQueue=function(n,t,i){var u=this,r=n.getDataSourceName();this._currentDataSource=this._inDataSourceQueue[r];delete this._inDataSourceQueue[r];i&&i(this._currentDataSource);this._outDataSourceQueue.hasOwnProperty(r)&&(this._viewer.removeDataSource(r,null,function(){u._currentDataSource=null}),delete this._outDataSourceQueue[r])},r}(tt),ui=function(i){function r(n,r,u,f,o,s){var h=i.call(this,s)||this;return h._reverseGeocoder=u,e.assertNotNull(r,"map"),h._isActive=!1,h._disposables=[],h._map=r,h.onFrameRendered=new k,h._config=n,h._taskBar=o,h._perfLog=f,h._exitArgs=null,h._rootElement.set_style({position:"absolute",left:"0px",top:"0px",opacity:1,height:"100%",width:"100%"}),h._rootElement.set_attr("class","ssSIV"),h._rootElement.set_attr("data-tag","Streetside.SIV"),h._sivBackground=t._createElement("div"),h._sivBackground.set_style({position:"absolute"}),h._sivBackground.add_class("streetsideBackground"),h._rootElement.append(h._sivBackground),h._disposables.push(new b(h._map,"actualSize",h,"size")),h}return l(r,i),r.prototype.getGeocoder=function(){return this._reverseGeocoder},r.prototype.setSize=function(n){this._sivSize=n;this._viewer&&this._viewer.setViewportSize(n);this.updateSivBackGround(n);this._controlsOverlay&&this._controlsOverlay.getOverlayElement().set_style({width:n.width+"px",height:n.height+"px"})},r.prototype.getMap=function(){return this._map},r.prototype.getCopyrights=function(n){n([this._getCopyrightString()])},r.prototype._getCopyrightString=function(){return""},r.prototype.setPreviousMode=function(n){this._previousMode=n},r.prototype.getPreviousMode=function(){return this._previousMode},r.prototype.setPreviousMapType=function(n){this._previousMapType=n},r.prototype.getPreviousMapType=function(){return this._previousMapType},r.prototype._setUpExitHandling=function(){var n=this;this._disposables.push(this._controlsOverlay.exiting.add(function(t){n._exitArgs=t;n._map.setMapType(n._previousMapType);n._map.setMode(n._previousMode)}))},r.prototype._onContextMenu=function(n){return n.stopPropagation(),n.preventDefault(),!1},r.prototype.getDisplayName=function(){throw"Method not implemented in base class";},r.prototype.tryPointToLocation=function(n,t){t=t||this._map.getView();var i=this._map.getActualSize(),f=n.x-i.width/2,e=n.y-i.height/2,o=t.cameraLocation,r=w.getMercatorZoomLevel(this._map),u=ti.latLongToPixelXY(o,r),h=new s(u.x+f,u.y+e);return ti.pixelXYToLatLong(h,r)},r.prototype.tryLocationToPoint=function(){return null},r.prototype.getCameraForLocationToPoint=function(){return this._map.getView().cameraLocation},r.prototype.getMapViewForLocationsInView=function(){return this._map.getView()},r.prototype.getMapViewWithBounds=function(){return this._map.getView()},r.prototype.getMapViewZoomedAboutLocation=function(){return this._map.getView()},r.prototype.getMapViewZoomedAboutLocationAtPoint=function(){return this._map.getView()},r.prototype.addControlsOverlayToMap=function(){var n=this;this._map.getOverlayManager().then(function(){n._map.getOverlays().insert(n._controlsOverlay)})},r.prototype.activated=function(){var n,i,r;this._isActive=!0;this._finishedInitialRender=!1;this._sivSize=this._map.getActualSize();this.setSize(this._sivSize);v(".MicrosoftMap .taskLayoutContainer").add_class("hideTaskLayout");v(".MicrosoftMap .toggleButton").add_class("hideTaskLayout");n=this._map.getNavigationBar();n&&n.setVisible(!1);i=this._map.getScaleBar();i&&i.setVisible(!1);h.isMapsAnswer&&t._showOrHideOverlayMenu(!1);r=this._taskBar&&this._taskBar.fullScreenEnabled?256:0;this._taskBar&&this._taskBar.setActionsOptions(24|r)},r.prototype.deactivated=function(){var r,n,i;this._viewer.setIsInteractive(!1);this.removeSIVContent();this.getPreviousMapType().id!==st.birdseyeV2&&this._taskBar&&this._taskBar.setActionsOptions(1023);this._isActive=!1;r=this._map.getOverlays();r.remove(this._controlsOverlay);h.isMapsAnswer&&this._previousMapType.id!==st.birdseyeV2&&t._showOrHideOverlayMenu(!0);v(".MicrosoftMap .taskLayoutContainer").remove_class("hideTaskLayout");v(".MicrosoftMap .toggleButton").remove_class("hideTaskLayout");n=this._map.getNavigationBar();n&&n.setVisible(!0);i=this._map.getScaleBar();i&&i.setVisible(!0)},r.prototype.dispose=function(){for(var n=this._disposables.length;n--;)this._disposables.pop().dispose();i.prototype.dispose.call(this)},r.prototype.getState=function(){throw"Method not implemented in base class";},r._sivFovToZoom=function(n,t,i){var r=n*(1-(t-i.minFov)/(i.maxFov-i.minFov));return Math.round(r*100)/100},r._sivZoomToFov=function(t,i,r){return n.radiansToDegrees(r.minFov+(r.maxFov-r.minFov)*(1-i/t))},r}(a),tr=function(){function n(n,i){this._rootElement=t._createElement("div");this._rootElement.set_attr("class","streetsideExit");this._rootElement.set_attr("data-tag","Streetside.Exit");this._rootElement.set_attr("title",y.L_ExitButtonTooltip);this._rootElement.set_attr("tabindex","0");this._rootElement.set_attr("role","button");this._sivMode=i;this._setUpEventHandling();this.exiting=new k}return n.prototype.update=function(){},n.prototype.getRootElement=function(){return this._rootElement},n.prototype.dispose=function(){this._detachEvents();this._rootElement.removeFromParent()},n.prototype._detachEvents=function(){this._rootElement.remove_event("click,touchstart",this._clickHandler);this._rootElement.remove_event("keydown",this._keyDownHandler);this._sivMode.getRootElement().remove_event("keydown",this._SIVKeyDownHandler)},n.prototype._setUpEventHandling=function(){var n=this;this._clickHandler=function(t){t&&t.preventDefault&&t.preventDefault();n._exitSIVMode(f.ExitMethodExitButton)};this._keyDownHandler=function(t){return n._onKeyDown(t)};this._SIVKeyDownHandler=function(t){return n._onKeyDownSIV(t)};this._rootElement.add_event("click,touchstart",this._clickHandler);this._rootElement.add_event("keydown",this._keyDownHandler);this._sivMode.getRootElement().add_event("keydown",this._SIVKeyDownHandler)},n.prototype._exitSIVMode=function(n){this.exiting.invoke({exitMethod:n})},n.prototype._onKeyDownSIV=function(n){n.keyCode===27&&this._exitSIVMode(f.ExitMethodEscKey)},n.prototype._onKeyDown=function(n){n.keyCode===13&&this._exitSIVMode(f.ExitMethodEscKey)},n}(),rt=function(){function n(){}return n.logActivated=function(t,i,r,u){var f={EP:i,CP:r,BL:u};n._log(t,g.Activated,f)},n.logDeactivated=function(t,i,r){var u={EM:i,NBN:r};n._log(t,g.Deactivated,u)},n.logBubbleChanged=function(t,i,r){var u={BL:i,BCM:r};n._log(t,f.ActionBubbleChanged,u)},n.logOverviewMapActivationState=function(t,i,r,u){var f={BL:u,OR:r};n._log(t,i,f)},n.logStreetsideError=function(t){var i={ET:t};n._log(f.StreetsideModeFeatureName,f.StreetsideErrorAction,i)},n._log=function(n,t,i){var r={feature:n,action:t,data:i};dt.invokeHandler(kt.instrumentationDataHandlerKey,{logData:r})},n}(),ir=function(n){function i(){var i=this,r={};i=n.call(this,r)||this;r.defineProperty("isOverlaySwitchOn",function(n,t){return i.onOverlaySwitchChanged(t)},null,{isPrivate:!1,defaultValue:!1});i._overviewMapSwitch=t._createElement("a");i._overviewMapSwitch.set_attr("href","#");i._overviewMapSwitch.set_attr("id","ssOverviewMapSwitch");i._overviewMapSwitch.set_attr("class","streetsideModeOverviewMapSwitch");i._overviewMapSwitch.set_attr("role","button");i._overviewMapSwitchClickHandler=function(n){n&&n.preventDefault&&n.preventDefault();i._isUserInitiatedPropertyChange=!0;i.setIsOverlaySwitchOn(!i.getIsOverlaySwitchOn())};i._overviewMapSwitch.add_event("click,touchstart",i._overviewMapSwitchClickHandler);i._isUserInitiatedPropertyChange=!1;i.onOverlaySwitchChanged(!1);return i}return l(i,n),i.prototype.update=function(n){this._currentBubble=n},i.prototype.getRootElement=function(){return this._overviewMapSwitch},i.prototype.dispose=function(){n.prototype.dispose.call(this);this._overviewMapSwitch&&(this._overviewMapSwitch.remove_event("click,touchstart",this._overviewMapSwitchClickHandler),this._overviewMapSwitch.removeFromParent(),this._overviewMapSwitch=null)},i.prototype.onOverlaySwitchChanged=function(n){var t,i;this._currentBubble&&rt.logOverviewMapActivationState(f.StreetsideModeFeatureName,n?f.OverviewMapActivated:f.OverviewMapDeactivated,this._isUserInitiatedPropertyChange?f.OriginUser:f.OriginEvent,new o(this._currentBubble.la,this._currentBubble.lo));t="fovToolTipLocalStorageShown";this._isUserInitiatedPropertyChange&&!d.getItem(t)&&(v(".streetSideToolTip.fov").add_class("streetsideTooltipFadeInOut"),d.setItem(t,"1",1));this._isUserInitiatedPropertyChange=!1;i="On";n?(this._overviewMapSwitch.add_class(i),this._overviewMapSwitch.set_attr("data-tag","Streetside.OverviewMap.SwitchOn"),this._overviewMapSwitch.set_attr("title",y.L_OverviewMapSwitchOnTip)):(this._overviewMapSwitch.remove_class(i),this._overviewMapSwitch.set_attr("data-tag","Streetside.OverviewMap.SwitchOff"),this._overviewMapSwitch.set_attr("title",y.L_OverviewMapSwitchOffTip))},i}(tt),rr=function(){function n(n){var r=this,i;if(!n)throw"Bubble info is invalid.";this._rootElement=t._createElement("div");this._rootElement.set_attr("id","ssReportAProblem");this._rootElement.set_attr("class","streetsideReportAProblem");i=y.L_ReportAProblem_LinkText;this._reportAProblemLink=t._createElement("a").set_text(i);this._reportAProblemLink.set_attr("data-tag","Streetside.ReportAProblem");this._reportAProblemLink.set_attr("class","streetsideText streetsideReportAProblemText");this._reportAProblemLink.set_attr("target","_blank");this._reportAProblemLink.set_attr("target-new","tab");this._reportAProblemLink.add_event("touchstart",function(){window.open(r._reportAProblemLink.get_attr("href"),"_blank")});this.update(n);this._rootElement.append(this._reportAProblemLink)}return n.prototype.update=function(n){var t=n.id;if(t>0)this._reportAProblemLink.set_attr("href",i.reportAProblemUrlFormat.replace("{id}",t+"").replace("{domain}",window.location.host));else throw"Bubble info or bubble id is invalid.";},n.prototype.getRootElement=function(){return this._rootElement},n.prototype.dispose=function(){this._rootElement.removeFromParent()},n}(),fi=function(n){function i(t,i,r){var u=n.call(this,null,0,new s(0,0))||this;return u._config=t,u._sivMode=i,u.exiting=new k,u._applySquareNavStyle=h.isMapsVertical||h.isMapsAnswer,u._createOverlayContainer(),u.setOverlayElement(u._overlayContainer),u._options=r,u.updateOptions(),u}return l(i,n),i.prototype.dispose=function(){this._detachToolPanel();this._detachExitControl()},i.prototype.clear=function(){},i.prototype._createOverlayContainer=function(){this._overlayContainer=t._createElement("div");this._overlayContainer.set_attr("id","ssControlsOverlay");this._overlayContainer.set_attr("data-tag","Streetside.ControlsOverlay");this._overlayContainer.set_attr("class","bm_streetsideModeControlsOverlay"+(this._applySquareNavStyle?" SquareNavControl":""))},i.prototype.update=function(){},i.prototype.getExitControl=function(){return this._bubbleExitControl},i.prototype.updateHeading=function(n){this._toolPanelControl&&this._toolPanelControl.updateHeading(n)},i.prototype.updateOptions=function(){this._options&&this._options.showExitButton===!1?this._detachExitControl():this._attachExitControl(this._config,this._sivMode);this._options&&this._options.showHeadingCompass===!1&&!this._options.showZoomButtons==!1?this._detachToolPanel():this._attachToolPanel()},i.prototype._attachExitControl=function(n,t){var i=this;this._bubbleExitControl||(this._bubbleExitControl=new tr(n,t),this._bubbleExitControl.exiting.add(function(n){return i.exiting.invoke(n)}),this._overlayContainer.append(this._bubbleExitControl.getRootElement()))},i.prototype._detachExitControl=function(){this._bubbleExitControl&&(this._bubbleExitControl.dispose(),this._bubbleExitControl=null)},i.prototype._attachToolPanel=function(){this._toolPanelControl||(this._toolPanelControl=new sr(this._sivMode.getSharedImmersiveViewer(),this._options.showZoomButtons,this._options.showHeadingCompass),this._overlayContainer.append(this._toolPanelControl.getRootElement()));this._toolPanelControl.updateVisibility(this._options.showZoomButtons,this._options.showHeadingCompass)},i.prototype._detachToolPanel=function(){this._toolPanelControl&&(this._toolPanelControl.dispose(),this._toolPanelControl=null)},i}(gt),yt=function(){function n(n,i){if(!n)throw"bubbleInfo is invalid.";this._reverseGeocoder=i;this._currentLocale=h.dynamicProperties.market;var r=this._currentLocale.indexOf("-");r>0&&(this._currentLocale=this._currentLocale.substr(0,r));this._currentLocale=this._currentLocale.toLowerCase();this._rootElement=t._createElement("div");this._rootElement.set_attr("id","ssApproxAddress");this._rootElement.set_attr("class","streetsideText streetsideApproxAddress");this._approxAddressSpan=t._createElement("span");this._approxAddressSpan.set_attr("data-tag","Streetside.ApproximateAddress");this._approxAddressSpan.set_attr("class","streetsideApproxAddressText");this.update(n);this._rootElement.append(this._approxAddressSpan)}return n.prototype.update=function(n){var t=this;this._getApproximateAddress(n,function(n){t._approxAddressSpan.set_text(n)})},n.prototype.clear=function(){this._approxAddressSpan.set_text(" ")},n.prototype.getRootElement=function(){return this._rootElement},n.prototype.dispose=function(){this.clear();this._rootElement.removeFromParent();this._rootElement=null},n.prototype._getApproximateAddress=function(n,i){this._reverseGeocoder.reverseGeocode(new o(n.la,n.lo),function(r){var u;u=r&&r.success&&r.location?r.addressList[0].formattedAddress:t._formatLatLonString(n.la,n.lo);i(u)})},n.getStreetNameFromMetadata=function(n,i){var o,s,f,r,u,e;if(n){if(!t._isArray(n))throw"Unexpected struct for roadnames: "+n+" . Array expected";for(f=0;f<n.length;f++)if(r=n[f],r.cs!==undefined?u=r.cs:r.cu!=undefined&&(u=r.cu),u!==undefined&&(u=u.toLowerCase()),i==u){o=r;break}else"default"==u&&(s=r)}return e="",o!=null?e=o.nms[0]:s!=null&&(e=s.nms[0]),e},n}(),ur=function(){function n(n){this._dateRegexp=new RegExp("(\\d{1,2})/(\\d{1,2})/(\\d{4})");this._rootElement=t._createElement("div");this._rootElement.set_attr("class","streetsideAttribution");n&&this.update(n)}return n.prototype.update=function(n){var i=n?n.id:0,t;if(i>0)t="©"+(new Date).getFullYear()+" Microsoft Corporation | "+this._getFormattedBubbleDate(n),this._rootElement.set_text(t);else throw"Bubble info or bubble id is invalid.";},n.prototype.getRootElement=function(){return this._rootElement},n.prototype.dispose=function(){this._rootElement.removeFromParent();this._rootElement=null},n.prototype._getFormattedBubbleDate=function(n){var f=n.cd,i=this._dateRegexp.exec(f),r="",u;return i!=null&&i[1]!=null&&i[2]!=null&&i[3]&&(u=new Date(parseInt(i[3],10),parseInt(i[1],10)-1,parseInt(i[2],10)),r=t._formatShortDateString(u)),r},n}(),fr=function(){function u(n,u){var p=this,c,v,l,a,f,e,s,h;this._disposables=[];this._streetsideMode=n;this._overviewMapControlHolder=t._createElement("div");this._overviewMapControlHolder.set_attr("class","streetsideOverviewMapcontrolHolder");this._overviewMapControlHolder.set_attr("data-tag","Streetside.OverviewMap.ControlHolder");c=n.getMap().getMapOptions();v=c.credentials;n.getRootElement().append(this._overviewMapControlHolder);l=this._streetsideMode.getCurrentBubble();a=i.overviewMapMapType;n._previousMapType&&(a=this._getOverviewMapType(n._previousMapType.id));f={mapType:a,liteMode:c.liteMode,credentials:v,navigationOptions:{lockCameraAltitude:!0,lockCameraHeading:!0},labelOptions:{labelVisibility:wi.visible},showLandmarks:!0,center:new o(l.la,l.lo),zoom:i.overviewMapLOD,hideNavBar:!0};n&&(e=n.getMap(),e&&e.getConfig().useOverlayQuadrants&&(s=e.getMapOptions(),f.scalebarLocation=s.scalebarLocation,f.copyrightLocation=s.copyrightLocation,f.logoLocation=s.logoLocation));r.loadMap({element:this._overviewMapControlHolder,mapOptions:f},function(n){return p._finishMiniMapSetup(n,u)});this._overviewMapControlDisablingCover=t._createElement("div");this._overviewMapControlDisablingCover.add_class("overviewMapShrine");this._overviewMapControlHolder.append(this._overviewMapControlDisablingCover);h=t._createElement("div");h.set_attr("class","streetSideToolTip fov ");h.set_text(y.L_StreetsideOverviewMapFovTooltip);this._overviewMapControlHolder.append(h)}return u.prototype.refresh=function(){this._overviewMapBehavior&&this._overviewMapBehavior.updateCaches()},u.prototype.updateMapCenter=function(n){this._overviewMapBehavior&&this._overviewMapBehavior.setMapCenter(n)},u.prototype.getNearestBubbleByLocation=function(n){var i=this,t;return this._overviewMapBehavior&&this._overviewMapBehavior.getClosestBubblesToLocation(n,function(r){return t=i._onNearestBubblesFound(r,n)}),t},u.prototype._onOverlayManagerLoaded=function(){var n=this,t=this._streetsideMode.getCurrentBubble();this._overviewMapBehavior=new cr;this._overviewMapBehavior.attach(this._overviewMap);this._disposables.push(this._overviewMapBehavior);this._overviewMapBehavior.setBubble(t);this._disposables.push(new b(this._streetsideMode,"overviewMapVisible",this._overviewMapBehavior,"headingDirectionOverlayVisible",function(t){var i="effective";return t?n._overviewMapControlDisablingCover.remove_class(i):n._overviewMapControlDisablingCover.add_class(i),t}));this._disposables.push(new b(this._overviewMapBehavior,"bubble",this._streetsideMode,"currentBubble",function(t){return n._streetsideMode.transitionToNewBubble(t,f.BubbleChangedMethodOverviewMap),t},"TwoWay"));this._hideNavigationBar();this._addPois(this._streetsideMode.getMap().getLayers());this._disposables.push(this._streetsideMode.getMap().getLayers().changed.add(function(t){t&&t.removed&&n._removePois(t.removed);t&&t.added&&n._addPois(t.added)}));this.updateHeading(this._streetsideMode.getSharedImmersiveViewer().getView().heading)},u.prototype._finishMiniMapSetup=function(n,t){var i=this,r;(this._overviewMap=n.getV8Map?n.getV8Map():n,this._overviewMapControlHolder)&&(r=this._streetsideMode.getCurrentBubble(),this._disposables.push(this._overviewMap),this._overviewMap.setDesiredSize(it.Auto),this._overviewMap.getOverlayManager().then(function(){i._onOverlayManagerLoaded()}),this._overviewMap.getLandmarksManager().then(function(n){i._updateLandmarkClickBehavior(n)}),t&&t(this,this._overviewMap.getRootElement()))},u.prototype._updateLandmarkClickBehavior=function(n){var t=this;n.landmarksAllDataSourcePromise.then(function(){var r,i,u;for(n.removePrimitiveTapped(),r=t._overviewMap.getLayers(),i=0;i<r.length;++i)if(u=r[i],u.getId()==="Microsoft.Maps.Landmarks"){t._landmarksLayerDisposable=u.primitiveTapped.add(function(n){return t._onPoiSelected(n.primitive)});break}})},u.prototype._addPois=function(n){var a=this,y=this._streetsideMode.getMap(),o,f,c,l,i,t;for(this._mainMapPoiLayers=this._mainMapPoiLayers||{},t=0;t<n.length;++t)o=n[t],f=o.getId(),f.match(/PoiManager/i)!=null&&f.match(/micro/i)==null&&(this._mainMapPoiLayers[f]={originalMapLayer:o,overviewMapLayer:null,overviewMapLayerDisposables:[]});for(i=Object.keys(this._mainMapPoiLayers),i.length>0&&(c=new vi(this._overviewMap),l=this._overviewMap.getLayers()),t=0;t<i.length;++t){var e=this._mainMapPoiLayers[i[t]],s=e.originalMapLayer,v=s.getDataSource(),r=new lr(v,c,s.getZIndex());e.overviewMapLayer=r;h.tileRefactoringEnabled&&(delete this._mainMapPoiLayers[i[t]],this._mainMapPoiLayers[r.getId()]=e);u._assignPoiLayer(s,r);e.overviewMapLayerDisposables.push(r.primitiveTapped.add(function(n){return a._onPoiSelected(n.primitive)}));l.insert(r)}},u._assignPoiLayer=function(n,t){var i=n&&n.getDataSource();i&&i.getPrimitives(null,function(n){var r=n.primitives,i,u;if(r)for(i=0,u=r.length;i<u;i++)r[i].layer=t})},u.prototype._removePois=function(n){var o=this,f,i,e,r;if(n&&n.length!==0){for(f=[],i=0,e=n.length;i<e;i++)r=n[i].getId(),this._mainMapPoiLayers[r]&&f.push(this._mainMapPoiLayers[r]);f.forEach(function(n){u._assignPoiLayer(n.overviewMapLayer,n.originalMapLayer);n.overviewMapLayer.dispose();t._clearDisposables(n.overviewMapLayerDisposables);delete o._mainMapPoiLayers[r]})}},u.prototype._onPoiSelected=function(n){var u=this,r=n.entity,t=r&&ct.getValue(r,"location"),i;!t&&n.crs&&(i=n.geometry,t=new o(n.crs.toLatitude(i.bounds[1],i.bounds[0]),n.crs.toLongitude(i.bounds[1],i.bounds[0])));t&&this._overviewMapBehavior.getClosestBubblesToLocation(t,function(n){return u._onPoiBubblesFound(n,t)})},u.prototype._onPoiBubblesFound=function(t,u){if(t&&t[0]){var e=t[0],s=r.ZoomLevel.toLocation(new o(e.la,e.lo,0),i.overviewMapLOD,!0),h=n.degreesToRadians(ot.getAngleBetweenTwoLocations(s,u));this._overviewMapBehavior.makeNextHeadingChangeAnimated();this._streetsideMode.transitionToNewBubble(e,f.BubbleChangedMethodOverviewMapPoi,h);this._overviewMapBehavior.setMapCenter(s)}},u.prototype._onNearestBubblesFound=function(n){var t;return n&&(t=n[0]),t},u.prototype._hideNavigationBar=function(){var t=this,n=this._overviewMap.getNavigationBar();n?n.setVisible(!1):this._overviewMap.navigationBarLoaded.addOne(function(){return t._hideNavigationBar()})},u.prototype.updateHeading=function(n){this._overviewMapBehavior&&this._overviewMapBehavior.updateHeading(n)},u.prototype.setSize=function(n){var t={width:n.width+"px",height:n.height+"px"};this._overviewMapControlDisablingCover.set_style(t);this._overviewMapControlHolder.set_style(t)},u.prototype.getRootElement=function(){return this._overviewMapControlHolder},u.prototype.dispose=function(){this._overviewMap&&this._removePois(this._overviewMap.getLayers());this._landmarksLayerDisposable&&(this._landmarksLayerDisposable.dispose(),this._landmarksLayerDisposable=null);for(var n=this._disposables.length;n--;)this._disposables.pop().dispose();this._overviewMap=null;this._overviewMapControlDisablingCover.removeFromParent();this._overviewMapControlDisablingCover=null;this._overviewMapControlHolder.removeFromParent();this._overviewMapControlHolder=null},u.prototype._getOverviewMapType=function(n){var t=r.MapTypeId;switch(n){case t.road:case t.grayscale:case t.canvasDark:case t.canvasLight:case t.symbolicNight:return n;default:return i.overviewMapMapType}},u}(),pt=function(){function n(n,t,i,r){this.AnimationProperty="animatingPropertyStub";this._animationType=n;this._tempSivSize=new it(r.width,t.height);this._tempOverviewMapSize=new it(r.width,i.height);this.animatingPropertyStub=t.height;this._viewportSize=r}return n.prototype.startAnimation=function(t,i){var u=this,r=this._viewportSize.height,f;this._animationType===n.AnimationOn?(f=1-1/3,r=this._viewportSize.height*f):r=this._viewportSize.height*(11/12);ct.animate(this,this.AnimationProperty,{to:r,frameCallback:function(n){return u._onAnimationProgress(n,t)},onComplete:function(){return i(u._animationType)}})},n.prototype.cancelAnimation=function(){ct.cancelAnimation(this,this.AnimationProperty)},n.prototype.isAnimationTypeCorrectWithCurrentState=function(t){return t?this._animationType===n.AnimationOn:this._animationType===n.AnimationOff},n.prototype.getDestinationViewportSize=function(){return this._viewportSize},n.prototype._onAnimationProgress=function(n,t){this._tempSivSize.height=this.animatingPropertyStub;this._tempOverviewMapSize.height=this._viewportSize.height-this._tempSivSize.height;t(this._tempSivSize,this._tempOverviewMapSize)},n.AnimationOn=0,n.AnimationOff=1,n}(),er=function(u){function s(n,r,f,o,s,c,l,a){var v=this,y={},p;return v=u.call(this,n,r,o,c,l,y)||this,v._browserHistoryManager=a,v._bootstrapper=s,v._browserHistoryManager&&(v._bhmSerializable={deserialize:function(){},serialize:function(){},serializableObjectChanged:new k},v._throttlerEvent=new k),y.defineProperty("currentBubble"),y.defineProperty("overviewMapVisible",function(n,t){return v.onOverviewMapVisibilityChanged(t)}),e.assertNotNull(r,"map"),v.mapModeType=2,v._bubblesSource=f,v._numberOfBubblesNavigated=0,v._tileUrlFormat=t._updateTfeUrlDomain(i.tileUrlFormat).replace("{hsgenid}",h.dynamicProperties.streetsideImageryGenerationId).replace("{credentials}",r.getAuthKey()),v._disposables.push(v._map.copyrightChanged.add(function(){return v._getCopyrightString()})),p=v._map.getFrameManager(),v._currentFrame=p?p.getFrame():et.frameZero,v._lastFrameRendered=et.frameZero,v._lastFrameLabeled=et.frameZero,v._originalMapView=v._map.getView(),v._navigationBubbleSource=new at(new vt,new ft),v._isTapToGoAllowed=!1,v._streetsideDatasourceOptionalConfig={isCursorAndLabelEnabled:i.streetsideCursorAndLabel,cursor:{image:"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAQAAAAEABAMAAACuXLVVAAAAKlBMVEX///9HcEz///////////////////////////////////////////////824ym1AAAADXRSTlMzANXuQIC/qlJylGQgoMthdQAABnVJREFUeF7E001rE1EYhuF3ZMDU1QhFomYhrdraOhshBikDKUwRt7ZWRV2odFEhIKmCSoUkIC7ctFVbEAStoLSQjUVwG0Hcz2DEwP1fLJ6FRarO+Zh4rw88F5xzZP9/zgYQx88vbHc5jvsPCKZmb7Kj03MzXv8AwaMb7NLxS15fAMXZCNWpoQeb270bGkaVzjVzBxTX1dTIxkfZ0ZMXdcUaa+YKCFYBGLkiu/ShDsC8lx9gXwgkdxvyhwoXQyB5lRMgWAfS+1X5S/5aBIx5eQA+h8Cthvyjwlsgueoe8BioPJMMnVsA7rkGnAfmJWOrwDGngFIbkhnJ3FQIvY47wGANKg3RqLAA3Uk3ALVfropW/puMAsm2f0K0W1ECe0BQg3Ex6D10PXtAqa32zQS9jjVgWu2bCsq2gJbaNxcctQN8gbJYNA2LNoCDEb2qWOS3SZfNAaUaSUOsKoR0O8aAp6RLYtlAxBlTwAG4I9adhetmgGLEhDhoi7RpBGjTrYqD/Bo9E8CnXw/A/hmc1AcMRoyKo1qkk9qAl3wTZz3kuy7gkLMLUJfAa01AyKg4rEWiB9iT4Qdo/oQjOoAg4rY4bS+ppwHY4qs47hoT2QGHSZd+sHcvqY1cURjHr/VovxA4itXIHTdIkEEmAgUyCMQFcjI2SAswuBdQoA0I2slY0FqAoHsBAoeMNXA8Dqir7NKrv72k5CgqtfXqgev+e6Czgh+XqivVrXO+em7AvqM/vxjQ1c/m2esPjTcCogV4+/yAvWgJNgG6+t7EUL9q/GWA7+RV4gCkSsuWwKxYAGtLYFYsgLUlMFYWIFqCzYAjx6/EBUg5/s5GQDLaA+LYC8obAaVoD4hjL/A2AbIamhirreIGQEfVOAFpjdYDTtQ3sVZDrbWAC13FC3ih+3WAU8erxAtIlfzbNYBsdA/GdycW1wA6ehc3YF+j1YC8+ib2auh6JeBbFeIHJPTjSoAb7YJx7obBKsCJhsZCtdVaAbjTlQ3AC52tALh+xQYg5QTLAScaGyvVVWsp4E51O4BdnS0FNPyKHUDK6S8DHGtoLFVb50sAWRVsARIqLgFc6q0twJ4eFgGnzshYq45/uwB4pZ/sAX7ThwVARlV7gLR6CwDXMxarFDwFHGtsE9DV+RPASxVsAhJ68wRwoRubgEPdR4DoEiAuAjN3CSAXgQEugegiiAD/6MYu4FCfPgN0PGO5SqPPABraBrQ1D8ipbBuQVG0OkNV724ADFecATb9iG5ByBnOARt9Yr0Y/ApxqYB/Q1O0MkFPBPiCh2gyQVdU+IK3iDJBRxT4gpd4M0AkMUO5oBigNCUDb+x9wpDIBSGpnCnilOgHY1YcpIKt3BGBfxQkgugmA22AKaAcGKXc4BbgPDKATTAEaMICm/gPkVWYASV2HgOguZO5DE92FzH0YAl6rwgBS+vgIaHoGqtLgEXDZpwCNh0eA+0ABLoNHgAYUoOlPAEfqUYCMdkJAXgUKkNB1CMipTgF2VQsBL1WlAGm9CQFZ3VCAQxVDwGsZrPQxBGR8DuD0QsCFxwFK9yEg2omRvTgEjDhAZwJwhxygHUwAYw7QnQCcAQdo+iFAPQ6QEQ8wxypzgKTOQ0CBAyRCwBZwojoH2FXL5PSeAxyohgO2gC1gC9gC8K0Y/zHaAvC/ZNt/xfSDCf5ohj+c4o/n+AEFfkSDH1Lhx3T4QSV+VMsfVvPH9fwLC/DXqOnjL63w13b4i0v+1S3/8pp/fc83MPAtHN+4I6qJBW/jwRuZ8FYuvJkNb+djGxovPbylE29qxdt66cbmFt7aTTe3fy3t/dBVeKAiPuJBD7ngYz74oBM+6oUPu9HjfvjAIz7yiQ+90mO/9ODzJ3z0Gx9+p8f/v8YAhDwQAcGFYOAxIHgQCh0Fg4fh4HFAdCASHgmFh2LRsWB4MBoeDUeH4+HxgHRAIh4RSYdk4jGheFAqHRWLh+XSccF4YDIdGY2HZtOx4XhwOh0dj4fn058PoD+ggH9Cgv6IBv4ZEfRDKv9Wd+8sBIUBHIcpAyZKokyuHZdFoUMKkazuOhZkoCwudc7JwCCDxV2ZRBFlIWU1yE4ZlO9ifD+A4d/5fYLfN3gIpAKjZOCYDpoTQoNKcFIKjWoJkRUjhUCwGp6Ww+N65OAfXvAmdGCRHHgBxCQA2QQwozhoFU/N4rFdPDeMB5fx5DQe3caz43h4HU/P4/F9cD+JKtAeBwC/awAAAABJRU5ErkJggg==",size:i.streetsideCursorSize},label:{font:i.streetsideLabelFont}},v}return l(s,u),s.prototype.getBubblesSource=function(){return this._bubblesSource},s.prototype.setSize=function(n){var r=this,u,f,o;this._viewer&&(u=!0,this._overviewMapAnimationObject!=null&&(f=this._overviewMapAnimationObject.getDestinationViewportSize(),this._overviewMapAnimationObject.isAnimationTypeCorrectWithCurrentState(this._overviewMapControl&&this.getOverviewMapVisible()===c.expanded)&&f.height===n.height&&f.width===n.width&&this._overviewMapControl?u=!1:(this._overviewMapAnimationObject.cancelAnimation(),this._overviewMapAnimationObject=null)),this._overviewMapControl||this._setSivAndOverviewMapSize(n,new it(0,0)),u&&this._overviewMapControl&&(o=this._perfLog&&this._perfLog.start(this.getOverviewMapVisible()===c.expanded?ni.OpenOverviewMapTime:ni.CloseOverviewMapTime),this._overviewMapAnimationObject=new pt(this.getOverviewMapVisible()===c.expanded?pt.AnimationOn:pt.AnimationOff,this._viewer.getViewportSize(),this._overviewMapControl.getRootElement().get_size(),n),this._overviewMapAnimationObject.startAnimation(function(n,t){return r._setSivAndOverviewMapSize(n,t)},function(){var f,n,u;if(!r._overviewMapControl){r.setSize(r._map.getActualSize());return}r.getOverviewMapVisible()===c.expanded&&r._overviewMapControl.refresh();o&&o.end();f=!0;i.preventSizeFocus&&(n=v(".bm_sharePanel"),n.length>0&&n[0].style.display!=="none"&&(f=!1));e.getFunctionalTestHooksEnabled()&&(r.getOverviewMapVisible()===c.expanded?(u=t._createElement("div"),u.set_attr("data-tag","Streetside.OverviewMap.Ready"),r._rootElement.append(u)):v('div[data-tag="Streetside.OverviewMap.Ready"]').removeFromParent())})))},s.prototype._setSivAndOverviewMapSize=function(n,t){u.prototype.setSize.call(this,n);this._overviewMapControl&&t&&(this._overviewMapControl.getRootElement().set_style({top:n.height+"px"}),this._overviewMapControl.setSize(t))},s.prototype.getNumberBubblesNavigated=function(){return this._numberOfBubblesNavigated},s.prototype.loadBubbleById=function(n,t,i,r){var f=this,u;u=typeof n=="number"?this._bubblesSource.getBubbleById(n,function(n){return f.transitionToNewBubble(n[0],t,i,r)},function(){return f._getBubbleByIdFailed()}):n;u&&this.transitionToNewBubble(u,t,i,r)},s.prototype._getBubbleByIdFailed=function(){},s.prototype.transitionToNewBubble=function(n,t,u,f){var c=this,s,h,o;if(this._map.getMapType().id===r.MapTypeId.streetside)if(s=this.getCurrentBubble(),n&&!this._transitioning){if(s.id==n.id){u!==undefined&&(o=this._viewer.getView(),this._viewer.setView(o.pitch,u,o.verticalFov,!0));return}this._nextBubbleInfo=n;h=new ut(this._tileUrlFormat,a.convertBubbleIdToQuad(n.id),n.he,n.pi,n.ro,n.ml,n.la,n.lo,this._streetsideDatasourceOptionalConfig);this._transitioning=!0;o=this._viewer.getView();this._viewer.transitionBetweenDataSources(this._currentDataSource,h,function(n){return c._dataSourceAdded(n,t)},i.bubbleTransitionTime,typeof u=="number"?u:o.heading,f||o.pitch)}else n&&(this._pendingBubbleUpdate&&this._pendingBubbleUpdate.id!=n.id&&e.log(this._pendingBubbleUpdate.id+" X;",this._pendingBubbleUpdate.id+" canceled due to ongoing transition."),e.log(n.id+" P;",n.id+" postponed due to ongoing transition"),this._pendingBubbleUpdate=n)},s.prototype._showNewBubble=function(n,t){var r=this,i;this._nextBubbleInfo=n;this.setCurrentBubble(this._nextBubbleInfo);i=new ut(this._tileUrlFormat,a.convertBubbleIdToQuad(n.id),n.he,n.pi,n.ro,n.ml,n.la,n.lo,this._streetsideDatasourceOptionalConfig);this._transitioning=!0;this.addDataSource(i,function(n){return r._dataSourceAdded(n,null)},a.convertToRadiansOrReturnNull(t))},s.prototype._dataSourceAdded=function(n,t){var u,e;this._isActive&&(n&&(this.setCurrentBubble(this._nextBubbleInfo),this._currentDataSource=n,this._controlsOverlay.update(this.getCurrentBubble()),this._numberOfBubblesNavigated++,this._syncMapView(this._nextBubbleInfo),this._isTapToGoAllowed||this._configureCursorAndLabel(),u=r.ZoomLevel.toLocation(new o(this._nextBubbleInfo.la,this._nextBubbleInfo.lo),i.overviewMapLOD,!0),t&&rt.logBubbleChanged(f.StreetsideModeFeatureName,u,t),this._overviewMapControl&&this.getOverviewMapVisible()===c.expanded&&t!=f.BubbleChangedMethodOverviewMap&&this._overviewMapControl.updateMapCenter(u),this._nextBubbleInfo=null),this._transitioning=!1,this._pendingBubbleUpdate&&(e=this._pendingBubbleUpdate,this._pendingBubbleUpdate=null,this.transitionToNewBubble(e,t)))},s.prototype.setInitialBubble=function(n,t){this._options=t;this._initialBubble=n},s.prototype._initializeViewer=function(){var u=this,t,i,n,r;this.setCurrentBubble(this._initialBubble);this._syncMapView(this._initialBubble);t={};this._currentDataSource=new ut(this._tileUrlFormat,a.convertBubbleIdToQuad(this._initialBubble.id),this._initialBubble.he,this._initialBubble.pi,this._initialBubble.ro,this._initialBubble.ml,this._initialBubble.la,this._initialBubble.lo,this._streetsideDatasourceOptionalConfig);i=this._map.getActualSize();t.height=i.height;t.width=i.width;t.dataSources=[this._currentDataSource];t.hideDefaultControls=!0;this._viewer=new wt(this._rootElement[0],t);this._addAttributeToFocusElement();this._addSivEventHandling();this._attachOverviewMap();this._controlsOverlay=new ei(this._config,this,this._options);this._disposables.push(this._controlsOverlay);this._setUpExitHandling();this._setupTapToGo();n=this._options;n?(r=n.fov,n.zoom&&n.zoom>=0&&n.zoom<=this._initialBubble.ml&&(r=s._sivZoomToFov(this._initialBubble.ml,n.zoom,this._viewer.getBounds())),this._viewer.setView(a.convertToRadiansOrReturnNull(n.pitch),a.convertToRadiansOrReturnNull(n.heading),a.convertToRadiansOrReturnNull(r),!1),n.overviewMapMode!=null?this.setOverviewMapVisible(n.overviewMapMode):this.setOverviewMapVisible(c.minimized)):this.setOverviewMapVisible(c.minimized);this._contextMenuHandler=function(n){return u._onContextMenu(n)};this._rootElement.add_event("contextmenu",this._contextMenuHandler);this._configureCursorAndLabel()},s.prototype._setupTapToGo=function(){var u=this,n,t;this._isTapToGoAllowed=i.streetsideCursorAndLabel&&this._viewer.getRendererType()!=="canvas2d";this._isTapToGoAllowed&&(this._sivTappedHandler=function(n){return u._onTapped(n)},this._viewer.tappedEvent.addEventListener(this._sivTappedHandler),n=this.getCurrentBubble(),n&&(t=r.ZoomLevel.toLocation(new o(n.la,n.lo),i.overviewMapLOD,!0),this._onTapped(t)))},s.prototype._onTapped=function(n){var e=this,t=new o(n.latitude,n.longitude,0,0),r=ot.metersToDegrees(1e3),u=this._navigationBubbleSource.getBubbles(new p(t,0,0),1,null,null),f;u===null?(f=new p(t,r,r),this._navigationBubbleSource.getBubbles(f,i.bubbleSourceBubbleLimit,function(n){return e._onTappedBubblesReady(n)},null)):this._onTappedBubblesReady(u)},s.prototype._onTappedBubblesReady=function(n){n&&n.length!=0&&this.getCurrentBubble().id!==n[0].id&&!this._transitioning&&this.transitionToNewBubble(n[0],f.BubbleChangedMethodArrow)},s.prototype._onMapOptionsUpdated=function(n){var t,r,i,e,u,f;if(n){if(t=n.streetsideOptions,this._options&&t){for(r=Object.keys(t),i=0,e=r.length;i<e;i++)u=r[i],this._options[u]=t[u];this._controlsOverlay&&this._controlsOverlay.updateOptions();this.setOverviewMapVisible(this._options.overviewMapMode)}(typeof n.pitch=="number"||typeof n.heading=="number"||t&&t.locationToLookAt)&&(f={heading:n.heading,pitch:n.pitch},f.streetsideOptions=t,this._map.setViewInvoked.invoke(f))}},s.prototype._onSetViewInvoked=function(t){var s=this,i=t.streetsideOptions||{},r,u,f=this.getCurrentBubble(),h=t.heading||f&&i.locationToLookAt&&ot.getAngleBetweenTwoLocations(new o(f.la,f.lo),i.locationToLookAt),e;typeof h=="number"&&(r=n.degreesToRadians(h));typeof t.pitch=="number"&&(u=n.degreesToRadians(t.pitch));i.panoramaInfo&&typeof i.panoramaInfo=="object"&&i.panoramaInfo.id?this.transitionToNewBubble(i.panoramaInfo,"SDK",r,u):typeof t.bounds!="undefined"?this._bootstrapper.isAvailable(t.bounds,function(n){return s.transitionToNewBubble(n,"SDK",r,u)}):typeof t.center!="undefined"?this._bootstrapper.isAvailable(t.center,function(n){return s.transitionToNewBubble(n,"SDK",r,u)}):(typeof r!="undefined"||typeof u!="undefined")&&(e=this._map.getFrameManager(),e&&e.hackHackSetFrame(),this._viewer.setView(u,r,null,!0))},s.prototype._addAttributeToFocusElement=function(){var n=v("#focusElement",this._rootElement[0]);n.set_attr("tabindex","0");n.set_attr("aria-label",y.L_StreetsideView)},s.prototype._viewerViewChanged=function(n,t){n&&n.updateHeading(t.heading)},s.prototype._addSivEventHandling=function(){var n=this;this._viewerDoneRenderingHandler=function(t){return n._viewerDoneRendering(t,n._options&&n._options.perfState)};this._viewer.doneRenderingEvent.addEventListener(this._viewerDoneRenderingHandler);this._viewerViewChangeEventHandler=function(){return n._map.targetViewChanged.invoke()};this._viewer.viewChangeEvent.addEventListener(this._viewerViewChangeEventHandler)},s.prototype._attachOverviewMap=function(){var n=this;this._options.overviewMapMode===undefined&&this.setOverviewMapVisible(c.minimized);this._options.overviewMapMode===c.hidden||this._overviewMapControl||(this._overviewMapControl=new fr(this,null),this._overviewMapViewerViewChangedHandler=function(t){n._viewerViewChanged(n._overviewMapControl,t);n._viewerViewChanged(n._controlsOverlay,t);n._throttlerEvent&&n._throttlerEvent.invoke()},this._viewer.viewChangeEvent.addEventListener(this._overviewMapViewerViewChangedHandler),this._viewer.viewChangeEndEvent.addEventListener(this._overviewMapViewerViewChangedHandler),this.setSize(this._map.getActualSize()))},s.prototype._detachOverviewMap=function(){this._overviewMapControl&&(this._overviewMapControl.dispose(),this._viewer.viewChangeEvent.removeEventListener(this._overviewMapViewerViewChangedHandler),this._overviewMapControl=null,this.setSize(this._map.getActualSize()))},s.prototype._cleanUpOverviewMap=function(){this._viewer&&(this._viewer.viewChangeEvent.removeEventListener(this._overviewMapViewerViewChangedHandler),this._viewer.viewChangeEndEvent.removeEventListener(this._overviewMapViewerViewChangedHandler));this._overviewMapControl&&this._overviewMapControl.dispose();this._overviewMapControl=null},s.prototype.getDisplayName=function(){return"Streetside"},s.prototype.onOverviewMapVisibilityChanged=function(n){var t,u;this._options.overviewMapMode=n;this._options.overviewMapMode===c.hidden?this._detachOverviewMap():this._attachOverviewMap();n===c.expanded&&(t=this.getCurrentBubble(),t&&(u=r.ZoomLevel.toLocation(new o(t.la,t.lo),i.overviewMapLOD,!0),this._overviewMapControl.updateMapCenter(u)));this.setSize(this._map.getActualSize())},s.prototype.activated=function(){var n=this,i,t;u.prototype.activated.call(this);this._transitioning=!1;this._viewer?(this._addSivEventHandling(),this._setupTapToGo(),this._viewer.setIsInteractive(!0),this._controlsOverlay||(this._controlsOverlay=new ei(this._config,this,this._options),this._disposables.push(this._controlsOverlay),this._setUpExitHandling()),this._attachOverviewMap(),this._showNewBubble(this._initialBubble,this._options.heading)):this._initializeViewer();this._controlsOverlay.updateOptions();this._overviewMapAnimationObject=null;this.setSize(this._map.getActualSize());this.addControlsOverlayToMap();i=new o(this._initialBubble.la,this._initialBubble.lo);this._initialBubble=null;this._keyDownHandler=function(t){return n._onKeyDown(t)};this._taskBar&&this._taskBar.getSearchBox().add_event("keydown",this._keyDownHandler);t=this._controlsOverlay.getOverviewMapSwitch();t&&t.getRootElement().add_event("keydown",this._keyDownHandler);this._map.getFrameManager()!=null?this._subscribeToFrameManagerEvents():this._map.frameManagerLoaded.addOne(function(){n._subscribeToFrameManagerEvents()});this._browserHistoryManager&&(this._throttledEventHandler=function(){n._bhmSerializable.serializableObjectChanged.invoke({magnitude:0})},this._disposables.push(this._throttlerEvent.addThrottled(this._throttledEventHandler,350)),this._browserHistoryManager.register("SIVView",this._bhmSerializable));this._optionChangedHandler=this._map.mapOptionsChanged.add(function(t){return n._onMapOptionsUpdated(t)});this._viewChangedHandler=this._map.setViewInvoked.add(function(t){return n._onSetViewInvoked(t)});rt.logActivated(f.StreetsideModeFeatureName,this._options.entryPoint,this._map.getView().cameraLocation,i)},s.prototype.deactivated=function(){var i=this,n,t;rt.logDeactivated(f.StreetsideModeFeatureName,this._exitArgs&&this._exitArgs.exitMethod||f.ExitMethodExternal,this.getNumberBubblesNavigated());this._viewer.doneRenderingEvent.removeEventListener(this._viewerDoneRenderingHandler);this._viewer.viewChangeEvent.removeEventListener(this._viewerViewChangeEventHandler);this._sivTappedHandler&&this._viewer.tappedEvent.removeEventListener(this._sivTappedHandler);this._sivTappedHandler=null;this._viewerDoneRenderingHandler=null;this._viewerViewChangeEventHandler=null;this._optionChangedHandler&&(this._optionChangedHandler.dispose(),this._optionChangedHandler=null);this._viewChangedHandler&&(this._viewChangedHandler.dispose(),this._viewChangedHandler=null);this._detachOverviewMap();this._cleanUpOverviewMap();this._numberOfBubblesNavigated=0;this._browserHistoryManager&&(this._throttlerEvent.remove(this._throttledEventHandler),this._browserHistoryManager.unregister("SIVView"));n=this.getPreviousMapType();u.prototype.deactivated.call(this);var e=lt.fromLocation(this._originalMapView.cameraLocation,!0),o=Math.min(e,s._exitMapZoomLevel),h=this._map.getView().cameraLocation,r=lt.toLocation(h,o,!0);n&&n.id===st.birdseyeV2?this._map.getBirdseyeV2Manager().then(function(n){i._map.setView(new ht(r,n.previousMapState.birdseyeV2Heading))}):this._map.setView(new ht(r));this._map.viewChanged.addOne(function(){var n=i._map.getFrameManager();n&&n.hackHackSetFrame()});this._taskBar&&this._taskBar.getSearchBox().remove_event("keydown",this._keyDownHandler);t=this._controlsOverlay.getOverviewMapSwitch();t&&t.getRootElement().remove_event("keydown",this._keyDownHandler);this._controlsOverlay.dispose();this._controlsOverlay=null;this._unsubscribeFromFrameManagerEvents()},s.prototype.getState=function(){var t=this.getCurrentBubble(),r=this.getSharedImmersiveViewer(),i;return!t||!r?null:(i=r.getView(),{centerPoint:new o(t.la,t.lo),direction:n.radiansToDegrees(i.heading),pitch:n.radiansToDegrees(i.pitch),mode:this.mapModeType,style:"x",overviewMap:this.getOverviewMapVisible(),level:this._previousMode?this._previousMode.getState().level:-1,zoom:s._sivFovToZoom(t.ml,i.verticalFov,r.getBounds())})},s.prototype._onKeyDown=function(n){var t=n,f=t.keyCode||t.which;if(f===9){var i=this._taskBar.getSearchBox()[0],r=this._controlsOverlay.getOverviewMapSwitch(),u=r&&r.getRootElement()[0];t.target!==u||t.shiftKey?t.target===i&&t.shiftKey&&(u.focus(),t.preventDefault()):(i.focus(),t.preventDefault())}},s.prototype._subscribeToFrameManagerEvents=function(){var n=this,t=this._map.getFrameManager();this._frameSetHandler=t.frameSet.add(function(t){n._currentFrame=t.frame});this._dataLoadedHandler=t.dataLoaded.add(function(t){n._onFrameManagerDataLoaded(t)})},s.prototype._unsubscribeFromFrameManagerEvents=function(){this._frameSetHandler&&this._frameSetHandler.dispose();this._frameSetHandler=null;this._dataLoadedHandler&&this._dataLoadedHandler.dispose();this._dataLoadedHandler=null},s.prototype._syncMapView=function(n){var t;if(n){var i=lt.toAltitude(new o(0,0),19,!0),r=Math.max(n.al,i),u=new o(n.la,n.lo,r,0);this._map.setView(new ht(u));t=this._map.getFrameManager();t&&t.hackHackSetFrame()}},s.prototype._viewerDoneRendering=function(t,i){var r,f;u.prototype._viewerDoneRendering.call(this,t,i);r=this._map.getFrameManager();r&&this._currentFrame.frameNumber>this._lastFrameRendered.frameNumber&&(this._lastFrameRendered=this._currentFrame,r.completePrimitiveRenderingPhase(this._currentFrame),r.completeLabelRenderingPhase(this._currentFrame));f=this._map.getView();f.heading=((n.radiansToDegrees(t.heading)||0)%360+360)%360;f.pitch=((n.radiansToDegrees(t.pitch)+90)%180+180)%180-90;f.verticalFov=t.verticalFov;this._map.viewChanged.invoke(new ki(1))},s.prototype._configureCursorAndLabel=function(){var n,t,i;this._isTapToGoAllowed&&this._currentDataSource&&(n=this._map.getFrameManager(),n&&(t=n.getFrameData().getPrimitives(1,!0),i=this._formatPrimitiveList(t),this._currentDataSource.setRoadVector(i)));this._controlsOverlay.setBubbleNavigationControlVisible(!this._isTapToGoAllowed)},s.prototype._formatPrimitiveList=function(n){for(var u,i,f=[],r=0;r<n.length;++r)if(u=n[r],u.geometryType==Microsoft.Maps.GeometryType.line){var t=u,e={latLonArray:[],name:ci.getDisplayName(t.entity)},o=t.geometry.x.length;for(i=0;i<o;++i){var s=t.crs.toLatitude(t.geometry.x[i],t.geometry.y[i]),h=t.crs.toLongitude(t.geometry.x[i],t.geometry.y[i]),c={latitude:s,longitude:h};e.latLonArray.push(c)}f.push(e)}return f},s.prototype._onFrameManagerDataLoaded=function(){this._configureCursorAndLabel()},s._exitMapZoomLevel=17,s}(ui),or=function(){function r(n){this._disposables=[];this._currentLocale="en";this._streetsideMode=n;this._streetsideModeRootElement=n.getRootElement();this._sharedImmersiveViewer=n.getSharedImmersiveViewer();this._bubblesSource=n.getBubblesSource();this._createRootElement();this._context=this._navElement[0].getContext("2d");this._pointerArgs=null;this._arrowsPlaced=!1;this._setUpMapSizeBinding();this._setUpEventHandling();var t=this._streetsideMode.getCurrentBubble();this._initialHeading=t.he;this.update(t);this._timerFunctionHandle=0}return r.prototype.setSize=function(n){this._width=n.width;this._streetsideModeRootElementHeight=n.height;this._navElement.set_attr("width",this._width+"px");this._navElement.set_attr("height",r._height+"px");this._cameraProperties?this._cameraProperties.getVanishingPoint().x=this._width/2:this._cameraProperties=new gi(new s(this._width/2,r._yVanishingPoint));this._arrowsPlaced&&this._onViewChange(this._sharedImmersiveViewer.getView())},r.prototype.update=function(n){this._context.clearRect(0,0,this._width,r._height);this._arrows=[];this._checkCacheAndPlaceArrows(n);this._pointerArgs&&this._onPointerDown(this._pointerArgs)},r.prototype.getRootElement=function(){return this._rootElement},r.prototype.dispose=function(){for(var n=this._disposables.length;n--;)this._disposables.pop().dispose();this._sharedImmersiveViewer.viewChangeEvent.removeEventListener(this._sivViewChangeHandler);this._sharedImmersiveViewer.keyDownEvent.removeEventListener(this._sivKeyDownHandler);this._sharedImmersiveViewer.keyUpEvent.removeEventListener(this._sivKeyUpHandler);this._sharedImmersiveViewer.doubleTappedEvent.removeEventListener(this._sivDoubleTappedHandler);this._timerFunctionHandle>0&&(window.clearInterval(this._timerFunctionHandle),this._timerFunctionHandle=0);this._streetsideModeRootElement.remove_event("mousedown,touchstart",this._pointerDownHandler);this._streetsideModeRootElement.remove_event("mouseup,mouseout,touchend,touchcancel",this._pointerUpHandler);this._sivViewChangeHandler=this._sivKeyDownHandler=this._sivKeyUpHandler=this._sivDoubleTappedHandler=this._pointerDownHandler=this._pointerUpHandler=null;this._rootElement.removeFromParent()},r.prototype._createRootElement=function(){this._rootElement=t._createElement("div");this._rootElement.set_attr("class","streetsideNavigation streetsideNavigationRoot");this._navElement=t._createElement("canvas");this._navElement.set_attr("id","ssNav");this._navElement.set_attr("data-tag","Streetside.NavigationControl");this._navElement.set_attr("class","streetsideNavigation");this._tooltipElement=t._createElement("div");this._tooltipElement.set_attr("class","streetsideText streetsideArrowTooltip");this._tooltipElement.set_text(y.L_ArrowTapAndHoldTooltip);this._rootElement.append(this._navElement);this._rootElement.append(this._tooltipElement)},r.prototype._setUpMapSizeBinding=function(){this._disposables.push(new b(this._streetsideMode.getMap(),"actualSize",this,"size"))},r.prototype._setUpEventHandling=function(){var n=this;this._sivViewChangeHandler=function(t){return n._onViewChange(t)};this._sivKeyDownHandler=function(t){return n._onKeyDown(t)};this._sivKeyUpHandler=function(t){return n._onKeyUp(t)};this._sivDoubleTappedHandler=function(t){return n._onDoubleTapped(t)};this._pointerDownHandler=function(t){return n._onPointerDown(t)};this._pointerUpHandler=function(t){return n._onPointerUp(t)};this._sharedImmersiveViewer.viewChangeEvent.addEventListener(this._sivViewChangeHandler);this._sharedImmersiveViewer.keyDownEvent.addEventListener(this._sivKeyDownHandler);this._sharedImmersiveViewer.keyUpEvent.addEventListener(this._sivKeyUpHandler);this._sharedImmersiveViewer.doubleTappedEvent.addEventListener(this._sivDoubleTappedHandler);this._streetsideModeRootElement.add_event("mousedown,touchstart",this._pointerDownHandler);this._streetsideModeRootElement.add_event("mouseup,mouseout,touchend,touchcancel",this._pointerUpHandler)},r.prototype._checkCacheAndPlaceArrows=function(n){this._doWeHaveNavigationBubblesInCache(n)?this._placeArrows():this._precacheMoreBubbles()},r.prototype._placeArrows=function(){function o(n,t,i){return t.id===n?i.id:t.id}function s(n){return n.length===2&&!n[0].az&&!n[1].az}var h,c;e.removeStreetsideArrowTesthooks([r._debugArrowClassName,r._debugCurrentBubbleIdClassName]);var n=this._streetsideMode.getCurrentBubble(),u=n.ne,f=n.pr,i=n.nbn,t=n.pbn;e.addStreetsideArrowTesthook(this._rootElement,r._debugCurrentBubbleIdClassName,n.id.toString(),null);u&&f?this._placeArrowsFromBubbleInfo(n):f&&i&&i.length>0?this._placeArrowsFromBubbleNavigationInfo(n,n.nbn,f):u&&t&&t.length>0?this._placeArrowsFromBubbleNavigationInfo(n,t,u):i&&i.length>0&&t&&t.length>0?s(i)&&s(t)?(n.ne=o(n.id,i[0],i[1]),n.pr=o(n.id,t[0],t[1]),this._placeArrowsFromBubbleInfo(n)):s(i)?(h=o(n.id,i[0],i[1]),this._placeArrowsFromBubbleNavigationInfo(n,t,h)):s(t)?(c=o(n.id,t[0],t[1]),this._placeArrowsFromBubbleNavigationInfo(n,i,c)):i.length>1?this._placeArrowsFromBubbleNavigationInfo(n,i,null):t.length>1&&this._placeArrowsFromBubbleNavigationInfo(n,t,null):(u||f)&&this._placeArrowsFromBubbleInfo(n);this._arrowsPlaced=!0;this._onViewChange(this._sharedImmersiveViewer.getView())},r.prototype._placeArrowFromAngle=function(t,i,u){var f=n.degreesToRadians(t),e=n.getPointFromAngleAndRadius(Math.PI-f,r._navigationControlRadius);this._placeArrow(e.x,e.y,f,i,u)},r.prototype._placeArrowsFromBubbleInfo=function(n){this._placeArrowsFromBubbleInfoWithNextAndPrevious(n,n.ne,n.pr)},r.prototype._placeArrowsFromBubbleInfoWithNextAndPrevious=function(t,i,r){var e=yt.getStreetNameFromMetadata(t.rn,this._currentLocale),u=null,f=null;u=i&&n.normalizeDegrees(this._getAngleToBubble(t,i));f=r&&n.normalizeDegrees(this._getAngleToBubble(t,r));var o=this._areAnglesSimilar(t.he,u),c=this._areAnglesSimilar(t.he,f),s=n.getAngleDifference(t.he,u),h=n.getAngleDifference(t.he,f);o||c?o?(u=this._areAnglesFacingSameDirection(s)?t.he:t.he+180,f=n.normalizeDegrees(u+180)):(f=this._areAnglesFacingSameDirection(h)?t.he:t.he+180,u=n.normalizeDegrees(f+180)):s<h?(u=t.he,f=n.normalizeDegrees(u+180)):(f=t.he,u=n.normalizeDegrees(f+180));i&&this._placeArrowFromAngle(u,e,i);r&&this._placeArrowFromAngle(f,e,r)},r.prototype._areAnglesFacingSameDirection=function(n){return n<i.navigationControlHalfAllowableSimilarAngle||n>360-i.navigationControlHalfAllowableSimilarAngle},r.prototype._areAnglesFacingOppositeDirection=function(n){return n<180+i.navigationControlHalfAllowableSimilarAngle&&n>180-i.navigationControlHalfAllowableSimilarAngle},r.prototype._areAnglesSimilar=function(t,i){if(t===null||i===null)return!1;var r=n.normalizeDegrees(t-i),u=this._areAnglesFacingSameDirection(r),f=this._areAnglesFacingOppositeDirection(r);return u||f},r.prototype._getAngleToBubble=function(t,i){var r=this._bubblesSource.getBubbleById(i,null,null);return r?n.radiansToDegrees(n.normalizeRadian(Math.atan2(t.lo-r.lo,t.la-r.la))):0},r.prototype._placeArrowsFromBubbleNavigationInfo=function(t,i,r){for(var c,v,y,l=!1,u=t.ne,f=t.pr,o=0,p=i.length;o<p;o++){var s=i[o],e=s.id,h=s.az,a=t.id===e;if(h===undefined||h===null){a||(u===undefined||u===null?u=e:(f===undefined||f===null)&&(f=e));l=!0;continue}(c=a?r:e,c!=null)&&(v=yt.getStreetNameFromMetadata(s.rn,this._currentLocale),y=n.normalizeDegrees(h),this._placeArrowFromAngle(y,v,c))}l&&this._placeArrowsFromBubbleInfoWithNextAndPrevious(t,u,f)},r.prototype._placeArrow=function(n,t,i,u,o){var h=this,s;e.addStreetsideArrowTesthook(this._rootElement,r._debugArrowClassName,u+"|"+o+"|"+i,function(n){n.preventDefault();h._streetsideMode.loadBubbleById(o,f.BubbleChangedMethodArrow)});s=new nr(n,t,this._cameraProperties,i,r._xAxisRotationInRadians,u,o);this._arrows.push(s)},r.prototype._drawArrows=function(n){var u,t,i;for(this._context.clearRect(0,0,this._width,r._height),u=this._arrows.length,t=0;t<u;t++)i=this._arrows[t],i.rotateAroundYAxis((Math.PI+n)%360),i.draw(this._context)},r.prototype._onViewChange=function(t){this._yAngleToRotateInRadians=-n.normalizeRadian(t.heading);this._drawArrows(this._yAngleToRotateInRadians)},r.prototype._onKeyDown=function(n){var t=this;n.keyCode===38?(n.handled=!0,this._isBackwardArrowPressed=!0,this._timerFunctionHandle==0&&(this._timerFunctionHandle=Microsoft.Maps.setInterval(function(n){return t._onWindowNavigationTimeout(n)},100,this))):n.keyCode===40&&(n.handled=!0,this._isForwardArrowPressed=!0,this._timerFunctionHandle==0&&(this._timerFunctionHandle=Microsoft.Maps.setInterval(function(n){return t._onWindowNavigationTimeout(n)},100,this)))},r.prototype._onKeyUp=function(n){n.keyCode===38?(n.handled=!0,this._isBackwardArrowPressed=!1,!this._isForwardArrowPressed&&this._timerFunctionHandle>0&&(window.clearInterval(this._timerFunctionHandle),this._timerFunctionHandle=0)):n.keyCode===40&&(n.handled=!0,this._isForwardArrowPressed=!1,!this._isBackwardArrowPressed&&this._timerFunctionHandle>0&&(window.clearInterval(this._timerFunctionHandle),this._timerFunctionHandle=0))},r.prototype._onWindowNavigationTimeout=function(t){t._isBackwardArrowPressed&&t._isForwardArrowPressed||(t._isBackwardArrowPressed?t._goToClosestArrowsBubble(n.normalizeRadian(t._sharedImmersiveViewer.getView().heading)+Math.PI):t._isForwardArrowPressed&&t._goToClosestArrowsBubble(n.normalizeRadian(t._sharedImmersiveViewer.getView().heading)))},r.prototype._goToClosestArrowsBubble=function(t){var r,s,e;if(this._arrows.length!==0){var i=this._arrows[0],u=n.getAngleDifferenceInRadians(t,i.getInitialRadiansOfRotation()),o=this._arrows[0].getNextBubbleId();if(this._arrows.length!==1||!(u>Math.PI/2)){for(r=1,s=this._arrows.length;r<s;r++)i=this._arrows[r],e=n.getAngleDifferenceInRadians(t,i.getInitialRadiansOfRotation()),u>e&&(u=e,o=i.getNextBubbleId());this._streetsideMode.loadBubbleById(o,f.BubbleChangedMethodKeyboard)}}},r.prototype._onDoubleTapped=function(n){this._bubbleIdOfTappedArrow(n)&&(n.handled=!0)},r.prototype._onPointerUp=function(){this._pointerArgs=null},r.prototype._onPointerDown=function(n){var e=this,i=f.BubbleChangedMethodArrow,t,u;this._pointerArgs&&(i=f.BubbleChangedMethodTapAndHold);this._pointerArgs=n;t=this._bubbleIdOfTappedArrow(n);t&&(d.getItem(r._tooltipShownStorageName)||(this._tooltipElement.add_class("streetsideTooltipShow"),u=function(){e._tooltipElement.remove_class("streetsideTooltipShow")},Microsoft.Maps.setTimeout(u,r.TapAndHoldTooltipRemovalWaitTime),d.setItem(r._tooltipShownStorageName,"1",1)),this._streetsideMode.loadBubbleById(t,i))},r.prototype._bubbleIdOfTappedArrow=function(n){var u="clientX",e="clientY",y=this._streetsideMode.getSivSize().height-r._height,o=this._streetsideMode.getRootElement().get_absolute_pos().y,h=this._streetsideMode.getRootElement().get_absolute_pos().x,p=f.BubbleChangedMethodArrow,c,l,t,a,i,v;for(n.type==="touchstart"?n=n.targetTouches[0]:typeof n[r._offsetXString]!="undefined"&&n[r._offsetXString]&&(u=r._offsetXString,e=r._offsetYString,o=0,h=0),c=n[u]-h,l=n[e]-o-y,t=0,a=this._arrows.length;t<a;t++)if(i=this._arrows[t],v=i.getBounds(),v.pointInRect(new s(c,l)))return i.getNextBubbleId();return 0},r.prototype._doWeHaveNavigationBubblesInCache=function(n){return n.ne&&this._bubblesSource.getBubbleById(n.ne,null,null)===null?!1:n.pr&&this._bubblesSource.getBubbleById(n.pr,null,null)===null?!1:n.nbn&&n.nbn.length>0&&!this._checkIfWeHaveNextAndPreviousNavigationInfoBubbles(n.nbn)?!1:n.pbn&&n.pbn.length>0&&!this._checkIfWeHaveNextAndPreviousNavigationInfoBubbles(n.pbn)?!1:!0},r.prototype._precacheMoreBubbles=function(){var n=this,t=this._getBoundingBoxForNextRequest();this._bubblesSource.getBubbles(t,r._numberOfBubblesToPrecache,function(){n._placeArrows();n._pointerArgs&&n._onPointerDown(n._pointerArgs)},function(){return})},r.prototype._getBoundingBoxForNextRequest=function(){var i=this._streetsideMode.getPreviousMode(),u=this._streetsideMode.getCurrentBubble(),f=new o(u.la,u.lo),n=i.tryLocationToPoint(f),e=w.getMercatorZoomLevel(this._streetsideMode.getMap()),t=r._boundingBoxCenterPointDeltaInPixels*e,h=new s(n.x-t,n.y-t),c=new s(n.x+t,n.y+t),l=i.tryPointToLocation(h),a=i.tryPointToLocation(c);return p.fromCorners(l,a)},r.prototype._checkIfWeHaveNextAndPreviousNavigationInfoBubbles=function(n){for(var i,r,u=n.length,t=0;t<u;t++)if(i=n[t],r=this._bubblesSource.getBubbleById(i.id,null,null),r===null)return!1;return!0},r._tooltipShownStorageName="streetsideTooltipShown",r._debugArrowClassName="Streetside.NavigationArrow",r._debugCurrentBubbleIdClassName="Streetside.CurrentBubbleId",r._xAxisRotationInRadians=-2,r._height=275,r._yVanishingPoint=-70,r._navigationControlRadius=100,r._numberOfBubblesToPrecache=50,r._boundingBoxCenterPointDeltaInPixels=50,r._offsetXString="offsetX",r._offsetYString="offsetY",r.TapAndHoldTooltipRemovalWaitTime=1e4,r}(),ei=function(n){function i(t,i,r){return n.call(this,t,i,r)||this}return l(i,n),i.prototype.onViewChange=function(){},i.prototype.clear=function(){n.prototype.clear.call(this);this._approximateAddressControl&&this._approximateAddressControl.clear()},i.prototype.setBubbleNavigationControlVisible=function(n){n&&!this._options.disablePanoramaNavigation?this._attachNavigationControl():this._detachNavigationControl()},i.prototype.update=function(n){this._bubbleNavigationControl&&this._bubbleNavigationControl.update(n);this._approximateAddressControl&&this._approximateAddressControl.update(n);this._reportAProblemControl&&this._reportAProblemControl.update(n);this._overviewMapSwitch&&this._overviewMapSwitch.update(n);this._attributionControl&&this._attributionControl.update(n)},i.prototype.updateOptions=function(){n.prototype.updateOptions.call(this);this._bubbleExitControl&&this._bubbleExitControl.getRootElement().removeFromParent();var i=this._sivMode,t=i.getCurrentBubble();this._setUpCompositeInfoAndExitControl();this._attachAttributionControl(t);this._options.disablePanoramaNavigation?this._detachNavigationControl():this._attachNavigationControl();this._options.showCurrentAddress!==!1?this._attachApproximateAddressControl(t):this._detachApproximateAddressControl();this._options.showProblemReporting!==!1?this._attachReportAProblemControl(t):this._detachReportAProblemControl();this._options.overviewMapMode&&this._options.overviewMapMode==c.hidden?this._detachOverviewMapSwitch():this._attachOverviewMapSwitch();this._overviewMapSwitch&&this._overviewMapSwitch.update(t)},i.prototype.getOverviewMapSwitch=function(){return this._overviewMapSwitch},i.prototype.dispose=function(){n.prototype.dispose.call(this);this._detachApproximateAddressControl();this._detachAttributionControl();this._detachNavigationControl();this._detachOverviewMapSwitch();this._detachReportAProblemControl();this._overlayContainer.removeFromParent()},i.prototype._attachAttributionControl=function(n){this._attributionControl||(this._attributionControl=new ur(n))},i.prototype._detachAttributionControl=function(){this._attributionControl&&(this._attributionControl.dispose(),this._attributionControl=null)},i.prototype._attachOverviewMapSwitch=function(){var t=this,n;this._overviewMapSwitch||(this._overviewMapSwitch=new ir,this._overlayContainer.append(this._overviewMapSwitch.getRootElement()),n=!0,this._overviewMapSwitchBinding=new b(this._overviewMapSwitch,"isOverlaySwitchOn",this._sivMode,"overviewMapVisible",function(i){return n?(n=!1,t._options.overviewMapMode):i?c.expanded:c.minimized},"TwoWay"))},i.prototype._detachOverviewMapSwitch=function(){this._overviewMapSwitch&&(this._overviewMapSwitch.dispose(),this._overviewMapSwitch=null,this._overviewMapSwitchBinding.dispose(),this._overviewMapSwitchBinding=null)},i.prototype._attachNavigationControl=function(){this._bubbleNavigationControl||(this._bubbleNavigationControl=new or(this._sivMode),this._overlayContainer.append(this._bubbleNavigationControl.getRootElement()))},i.prototype._detachNavigationControl=function(){this._bubbleNavigationControl&&(this._bubbleNavigationControl.dispose(),this._bubbleNavigationControl=null)},i.prototype._attachApproximateAddressControl=function(n){this._approximateAddressControl||(this._approximateAddressControl=new yt(n,this._sivMode.getGeocoder()))},i.prototype._detachApproximateAddressControl=function(){this._approximateAddressControl&&(this._approximateAddressControl.dispose(),this._approximateAddressControl=null)},i.prototype._attachReportAProblemControl=function(n){this._reportAProblemControl||(this._reportAProblemControl=new rr(n),this._overlayContainer.append(this._reportAProblemControl.getRootElement()))},i.prototype._detachReportAProblemControl=function(){this._reportAProblemControl&&(this._reportAProblemControl.dispose(),this._reportAProblemControl=null)},i.prototype._setUpCompositeInfoAndExitControl=function(){var n,i,r,u;this._compositeInfoAndExitControlRootElement&&this._compositeInfoAndExitControlRootElement.removeFromParent();this._attributionContainerRootElement&&this._attributionContainerRootElement.removeFromParent();this._compositeInfoAndExitControlRootElement=t._createElement("div");this._compositeInfoAndExitControlRootElement.set_attr("class","streetsideCompositeInfoAndExitControl "+(h.isMapsVertical?"streetsidewithTaskBar":""));n=t._createElement("div");n.set_attr("class","streetsideCompositeInfoAndExitControl left");this._attributionControl&&(h.isMapsVertical?(i=t._createElement("div"),i.set_attr("class","streetsideCompositeInfoAndExitControl left top"),i.append(this._attributionControl.getRootElement())):(this._attributionContainerRootElement=t._createElement("div"),this._attributionContainerRootElement.set_attr("class","streetsideSdkAttributionContainer"),this._attributionContainerRootElement.append(this._attributionControl.getRootElement()),this._overlayContainer.append(this._attributionContainerRootElement)));this._approximateAddressControl&&(r=t._createElement("div"),r.set_attr("class","streetsideCompositeInfoAndExitControl left bottom"),r.append(this._approximateAddressControl.getRootElement()));this._bubbleExitControl&&(u=t._createElement("div"),u.set_attr("class","streetsideCompositeInfoAndExitControl right"),u.append(this._bubbleExitControl.getRootElement()));this._compositeInfoAndExitControlRootElement.append(n);this._compositeInfoAndExitControlRootElement.append(u);n.append(i);n.append(r);this._overlayContainer.insertBefore(this._compositeInfoAndExitControlRootElement,this._overlayContainer[0].firstChild)},i}(fi),sr=function(i){function r(n,r,u){var f=this;return f=i.call(this,{})||this,f._siv=n,f._rootElement=t._createElement("div"),f._rootElement.set_attr("id","ssLeftPanel"),f._applySquareNavStyle=h.isMapsVertical||h.isMapsAnswer,f._rootElement.set_attr("class","streetsideToolPanel"),f._rootElement.set_attr("role","button"),f.updateVisibility(r,u),f}return l(r,i),r.prototype.update=function(n){n&&this.updateHeading(n.he)},r.prototype.updateVisibility=function(n,t){this._showZoomControl=n;this._showHeadingControl=t;this._showHeadingControl!==!1?this._attachHeadingControl():this._detachHeadingControl();this._showZoomControl!==!1?this._attachZoomControl():this._detachZoomControl()},r.prototype.getRootElement=function(){return this._rootElement},r.prototype.dispose=function(){i.prototype.dispose.call(this);this._detachZoomControl();this._detachHeadingControl();this._rootElement.removeFromParent();this._rootElement=null;this._siv=null},r.prototype.updateHeading=function(n){this._updatecCompass(-n)},r.prototype._attachZoomControl=function(){var i=this,n;this._zoomInButton||(n=this._rootElement,this._applySquareNavStyle&&(this._zoomControl=t._createElement("div"),this._zoomControl.set_attr("class","zoomControl streetsideToolPanelButton"),this._zoomControl.set_attr("role","button"),this._zoomControl.set_attr("data-tag","Streetside.ZoomControl"),this._rootElement.append(this._zoomControl),n=this._zoomControl),this._zoomInButton=t._createElement("div"),this._zoomInButton.set_attr("class","zoomIn streetsideToolPanelButton"),this._zoomInButton.set_attr("role","button"),this._zoomInButton.set_attr("tabindex","0"),this._zoomInButton.set_attr("href","#"),this._zoomInButton.set_attr("title",y.L_ZoomInButton_Title),this._zoomInButton.set_attr("data-tag","Streetside.ZoomIn"),n.append(this._zoomInButton),this._zoomOutButton=t._createElement("div"),this._zoomOutButton.set_attr("class","zoomOut streetsideToolPanelButton"),this._zoomOutButton.set_attr("role","button"),this._zoomOutButton.set_attr("tabindex","0"),this._zoomOutButton.set_attr("href","#"),this._zoomOutButton.set_attr("title",y.L_ZoomOutButton_Title),this._zoomOutButton.set_attr("data-tag","Streetside.ZoomOut"),n.append(this._zoomOutButton),this._applySquareNavStyle&&(this._zoomInButton.appendHTML('<div class="NavButton_Icon"><\/div>'),this._zoomOutButton.appendHTML('<div class="NavButton_Icon"><\/div>')),this._zoomInHandler=function(n){i._handleZoomEvent(n,!0)},this._zoomInButton.add_event("click,touchstart,keydown",this._zoomInHandler),this._zoomOutHandler=function(n){i._handleZoomEvent(n,!1)},this._zoomOutButton.add_event("click,touchstart,keydown",this._zoomOutHandler))},r.prototype._handleZoomEvent=function(n,t){n&&n.type==="keydown"&&n.which&&n.which!==13||(n&&n.preventDefault&&n.preventDefault(),t?this._siv.zoomIn(!0):this._siv.zoomOut(!0))},r.prototype._attachHeadingControl=function(){var n=this;this._compassButton||(this._compassButton=t._createElement("div"),this._compassButton.set_attr("class","compass streetsideToolPanelButton"),this._compassButton.set_attr("role","button"),this._compassButton.set_attr("tabindex","0"),this._compassButton.set_attr("href","#"),this._compassButton.set_attr("title",y.L_CompassButton_Title),this._compassButton.set_attr("data-tag","Streetside.Compass"),this._zoomInButton?this._rootElement.insertBefore(this._compassButton,this._zoomInButton):this._rootElement.append(this._compassButton),this._compassHandler=function(t){t&&t.preventDefault&&t.preventDefault();var i=n._siv.getView();n._siv.setView(i.pitch,0,i.verticalFov,!0)},this._compassButton.add_event("click,touchstart",this._compassHandler))},r.prototype._detachZoomControl=function(){this._zoomInButton&&(this._zoomInButton.remove_event("click,touchstart",this._zoomInHandler),this._zoomInButton.removeFromParent(),this._zoomInButton=null,this._zoomOutButton.remove_event("click,touchstart",this._zoomOutHandler),this._zoomOutButton.removeFromParent(),this._zoomOutButton=null,this._applySquareNavStyle&&(this._zoomControl.removeFromParent(),this._zoomControl=null))},r.prototype._detachHeadingControl=function(){this._compassButton&&(this._compassButton.remove_event("click,touchstart",this._compassHandler),this._compassButton.remove_event("touchstart",this._compassHandler),this._compassButton.removeFromParent(),this._compassButton=null)},r.prototype._updatecCompass=function(t){if(this._compassButton){var s=n.radiansToDegrees(t),u=t,f=Math.cos(u),e=Math.sin(u),h=f,c=-e,l=e,a=f,o="progid:DXImageTransform.Microsoft.Matrix(sizingMethod = 'auto expand', M11 = "+h+", M12 = "+c+", M21 = "+l+", M22 = "+a+")",v='"'+o+'"',i="0s",r="rotate("+s+"deg)",y={behavior:"url(-ms - transform.htc)","-moz-transform":r,"-webkit-transform":r,"-o-transform":r,"-ms-transform":r,filter:o,"-ms-filter":v,"-webkit-transition-duration":i,"-moz-transition-duration":i,"-o-transition-duration":i,"transition-duration":i};this._compassButton.set_style(y)}},r}(tt),oi=function(){function n(){}return n.logActivated=function(){n._log(g.Activated,null)},n.logDeactivated=function(t){var i={EM:t};n._log(g.Deactivated,i)},n._log=function(n,t){var i={feature:f.PhotosynthModeFeatureName,action:n,data:t};dt.invokeHandler(kt.instrumentationDataHandlerKey,{logData:i})},n}(),hr=function(i){function r(){var n=i.call(this,null,null,new s(0,0))||this,r=n._overlayContainer=t._createElement("div").set_attr("id","ssOverviewMapHeadingDirectionOverlay").set_attr("data-tag","Streetside.OverviewMap.HeadingDirectionOverlay").set_attr("class","bm_streetsideOverviewMapHeadingDirectionOverlay"),u=t._createElement("div").set_attr("id","ssModeOverviewMapHeadingDirectionBase").set_attr("data-tag","Streetside.OverviewMap.HeadingDirectionBase").set_attr("class","streetsideModeOverviewMapHeadingDirectionBase");return r.append(u),n._headingDirectionPointer=t._createElement("div").set_attr("id","ssModeOverviewMapHeadingDirectionPointer").set_attr("data-tag","Streetside.OverviewMap.HeadingDirectionPointer").set_attr("class","streetsideModeOverviewMapHeadingDirectionPointer"),r.append(n._headingDirectionPointer),n.setOverlayElement(r),n._isFovAnimated=!1,n}return l(r,i),r.prototype.makeNextHeadingChangeAnimated=function(){this._isFovAnimated=!0},r.prototype.setStyle=function(n){this._overlayContainer.set_style(n)},r.prototype.setHeading=function(t){var s=n.radiansToDegrees(t),u=t,f=Math.cos(u),e=Math.sin(u),h=f,c=-e,l=e,a=f,o="progid:DXImageTransform.Microsoft.Matrix(sizingMethod = 'auto expand', M11 = "+h+", M12 = "+c+", M21 = "+l+", M22 = "+a+")",v='"'+o+'"',i=this._isFovAnimated?"0.3s":"0s",r="rotate("+s+"deg)",y={behavior:"url(-ms - transform.htc)","-moz-transform":r,"-webkit-transform":r,"-o-transform":r,"-ms-transform":r,filter:o,"-ms-filter":v,"-webkit-transition-duration":i,"-moz-transition-duration":i,"-o-transition-duration":i,"transition-duration":i};this._isFovAnimated=!1;this._headingDirectionPointer.set_style(y)},r}(gt),cr=function(n){function u(){var t=this,i={};return t=n.call(this,i)||this,i.defineProperty("bubble"),i.defineProperty("headingDirectionOverlayVisible",function(n,i){t._onHeadingDirectionOverlayVisibleChanged(i)}),t._bubblesSource=new at(new vt,new ft),t._disposables=[],t._lockUpdates=!1,t._isDragging=!1,t._headingDirectionOverlay=new hr,t}return l(u,n),u.prototype._onHeadingDirectionOverlayVisibleChanged=function(n){this.isAttached()&&(n?this._map.getOverlays().insert(this._headingDirectionOverlay):this._map.getOverlays().remove(this._headingDirectionOverlay))},u.prototype.updateCaches=function(){var n=this;if(this._map.getMode()==null){Microsoft.Maps.setTimeout(function(){return n.updateCaches()},100);return}this._bubblesSource.getBubbles(this._getViewportBoundingBox(),i.bubbleSourceBubbleLimit,null,null)},u.prototype.makeNextHeadingChangeAnimated=function(){this.isAttached()&&this._headingDirectionOverlay.makeNextHeadingChangeAnimated()},u.prototype.updateHeading=function(n){if(this.isAttached()){if(!this._headingDirectionOverlay)throw"OverviewMapBehavior: should not call updateHeading() on disposed object.";this._headingDirectionOverlay.setHeading(n)}},u.prototype.isAttached=function(){return!!this._map},u.prototype.attach=function(n){var r=this,f,u;e.assert(!this._map,"An event source has already been attached to this behavior.");this._map=n;i.isCoverageLayerEntryPointEnabled&&(this._imageryMapLayer=new li("Microsoft.Maps.StreetsideCoverage",i.coverageLayerZIndex,i.coverageLayerOpacity,null,null,2),f=t._updateTfeUrlDomain(i.coverageLayerTileUrlFormat),this._imageryMapLayer.addScene(10,yi.createMercatorImageryScene("SSOverviewMapCoverage",f,null,this._map),0),this._map.getLayers().insert(this._imageryMapLayer));this._disposables.push(this._map.mapPanStarted.add(function(){return r._isDragging=!0}));this._disposables.push(this._map.mapPanContinued.addThrottled(function(n){return r.onMapPanChanged(n)},150));this._disposables.push(this._map.mapPanStopped.add(function(){r._isDragging=!1;var n=e.getFunctionalTestHooksEnabled()?777:i.bubbleSourceBubbleLimit;r._requestBubblesForBoundingBox(r._getViewportBoundingBox(),n)}));this._disposables.push(this._map.viewChanged.add(function(n){return r.onViewChanged(n)}));this._disposables.push(this._map.mapTapped.add(function(n){var t=r._getViewportBoundingBox(n.location),u=e.getFunctionalTestHooksEnabled()?555:i.bubbleSourceBubbleLimit;r._requestBubblesForBoundingBox(t,u)}));this.updateCaches();e.getFunctionalTestHooksEnabled()&&(u=t._createElement("div"),u.set_attr("id","overviewMapBehaviorTesthook"),u.set_attr("data-tag","Streetside.OverviewMap.BehaviorTesthook"),this._map.getRootElement().append(u))},u.prototype.detach=function(){if(e.assertNotNull(this._map,"No map has been attached to this behavior."),this._map.getOverlays().remove(this._headingDirectionOverlay),this._headingDirectionOverlay=null,this._imageryMapLayer&&(this._map.getLayers().remove(this._imageryMapLayer),this._imageryMapLayer=null),this._map=null,e.getFunctionalTestHooksEnabled()){var n=v("#overviewMapBehaviorTesthook");n.removeFromParent()}},u.prototype.dispose=function(){n.prototype.dispose.call(this);this.isAttached()&&this.detach();for(var t=this._disposables.length;t--;)this._disposables.pop().dispose();this._map=null},u.prototype.setMapCenter=function(n){n&&this.isAttached()&&!this._isDragging&&w.setMapCenter(this._map,n,null,null,hi.defaultAnimation,0)},u.prototype.getClosestBubblesToLocation=function(n,t){var r=this._bubblesSource.getBubbles(new p(n,0,0),1,null,null);r===null&&this._bubblesSource.getBubbles(this._getViewportBoundingBox(n),i.bubbleSourceBubbleLimit,function(n){return t&&t(n)},null);t&&t(r)},u.prototype._getViewportBoundingBox=function(n){var t=w.getMapBounds(this._map);return n?new p(n,t.width,t.height):t},u.prototype.onViewChanged=function(){this._lockUpdates=!1},u.prototype.onMapPanChanged=function(){var n=this,t;!this._lockUpdates&&this._isDragging&&(t=w.getMapCenter(this._map),this.getClosestBubblesToLocation(t,function(t){n._isDragging&&n._onBubblesAvailable(t,!1)}))},u.prototype._requestBubblesForBoundingBox=function(n,t){var r=this,i=this._bubblesSource.getBubbles(n,t,function(n){return r._onBubblesAvailable(n,!0)},null);i&&this._onBubblesAvailable(i)},u.prototype._onBubblesAvailable=function(n,t){var u,s,f,h;(t===void 0&&(t=!1),u=n&&n[0],!u&&t&&(u=this.getBubble()),u&&this._map)&&(s=w.getMapCenter(this._map),f=r.ZoomLevel.toLocation(new o(u.la,u.lo),i.overviewMapLOD,!0),o.areEqual(s,f)||(this._lockUpdates=!0,this.setMapCenter(f),this.setBubble(u)),e.getFunctionalTestHooksEnabled()&&(h=v("#overviewMapBehaviorTesthook"),h.set_text("Bubbles: "+n.length)))},u}(tt),lr=function(n){function t(t,i,r){var u=n.call(this,"OverviewMapPoiLayer"+r,t,i,r)||this;return u._disposables.push(u.primitiveHoverStarted.add(function(n){u._onPrimitiveInteraction(n,1)}),u.primitiveHoverStopped.add(function(n){u._onPrimitiveInteraction(n,0)})),u}return l(t,n),t.prototype._onPrimitiveInteraction=function(n,t){var i=n.primitive;i&&i.viewState!==2&&(i.viewState=t,i.zIndex=t===1?2:0);this.getDataSource().invalidated.invoke()},t}(bi),ar=function(n){function t(t,i,r,u,f){var e=n.call(this,t,i,r,u,f)||this;return e.mapModeType=3,e}return l(t,n),t.prototype.setInitialMetadata=function(n){this._initialMetadata=n},t.prototype.setOverrideList=function(n){this._overrideList=n},t.prototype._createDataSourceFromJsonMetadata=function(){var n=new yr,t={forceToHttps:window.location.protocol.toLowerCase()==="https:",overrideList:this._overrideList};return n.createFromJson(this._initialMetadata,null,t),n},t.prototype._showNewBubble=function(){this._currentDataSource=this._createDataSourceFromJsonMetadata(this._initialMetadata);this._viewer.addDataSource(this._currentDataSource)},t.prototype._initializeViewer=function(){this._currentDataSource=this._createDataSourceFromJsonMetadata(this._initialMetadata);var n={},t=this._map.getActualSize();n.height=t.height;n.width=t.width;n.dataSources=[this._currentDataSource];n.hideDefaultControls=!0;this._viewer=new wt(this._rootElement[0],n);this._controlsOverlay=new fi(this._config,this,null);this._disposables.push(this._controlsOverlay);this._setUpExitHandling()},t.prototype.getDisplayName=function(){return"Photosynth"},t.prototype.activated=function(){n.prototype.activated.call(this);this._viewer?this._showNewBubble(this._initialMetadata):this._initializeViewer();this.addControlsOverlayToMap();this.updateSivBackGround(this._map.getActualSize());this._taskBar.setActionsOptions(16);oi.logActivated()},t.prototype.deactivated=function(){oi.logDeactivated(this._exitArgs&&this._exitArgs.exitMethod||f.ExitMethodExternal);n.prototype.deactivated.call(this)},t.prototype.getState=function(){return null},t}(ui),vr=function(r){function u(){return r!==null&&r.apply(this,arguments)||this}return l(u,r),u.prototype.loadBubble=function(n,r,f){var l=this,o,e,s,c;if(this._finishedInitialRender=!1,o=new ut(t._updateTfeUrlDomain(i.tileUrlFormat).replace("{hsgenid}",h.dynamicProperties.streetsideImageryGenerationId).replace("{credentials}",nt.credentials),a.convertBubbleIdToQuad(n.id),n.he,n.pi,n.ro,n.ml,n.la,n.lo),this._viewer||(e={},e.height=r.height,e.width=r.width,e.dataSources=[o],this._currentDataSource=o,e.hideDefaultControls=!0,e.noInteraction=!r.isInteractive,r.preferredRenderer&&(e.renderer=r.preferredRenderer),this._viewer=new wt(this._rootElement[0],e),this._viewerDoneRenderingHandler=function(n){return l._viewerDoneRendering(n,r.perfState)},this._viewer.doneRenderingEvent.addEventListener(this._viewerDoneRenderingHandler)),this._currentDataSource==null||this._currentDataSource.getDataSourceName()!=o.getDataSourceName()?this.addDataSource(o,function(n){return l._dataSourceAdded(n,r)},a.convertToRadiansOrReturnNull(r.heading),a.convertToRadiansOrReturnNull(r.pitch),a.convertToRadiansOrReturnNull(r.fov)||u._defaultFOVInRadians):this._dataSourceAdded(o,r),r.cssClasses&&r.cssClasses.length>0)for(s=v(document.getElementById(o.getDataSourceName())),s.length===0&&(s=v(this._rootElement[0].children[0])),c=0;c<r.cssClasses.length;c++)s.add_class(r.cssClasses[c]);this._viewer.setIsInteractive(r.isInteractive);f&&f()},u.prototype._dataSourceAdded=function(t,i){var r=this;this._currentDataSource=t;this._viewer.setView(i.pitch&&n.degreesToRadians(i.pitch),i.heading&&n.degreesToRadians(i.heading),i.fov&&n.degreesToRadians(i.fov)||u._defaultFOVInRadians,!!i.setViewAnimationMilliseconds,i.setViewAnimationMilliseconds);i.rotateBubble&&Microsoft.Maps.setTimeout(function(){r._viewer.setView(null,r._viewer.getView().heading+n.twoPI,null,!0,3e4,!0)},50)},u._defaultFOVInRadians=1,u}(a),wt=Microsoft.ImmersiveViewer.SharedImmersiveViewer,ut=Microsoft.ImmersiveViewer.StreetsideSivDataSource,yr=Microsoft.ImmersiveViewer.PhotosynthSivDataSource;u.BubblesSourceProxy=at;u.LRUBubbleCachingStrategy=ri;u.NetworkBubblesSource=vt;u._StreetsideMini=vr;r.PhotosynthMode=ar;r.StreetsideMode=er}catch(si){if(r.logger)r.logger.logCriticalError(si);else throw si;}}).call(window)