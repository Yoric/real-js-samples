var WebBlender=function(e){var t=[],a=!1,i=!1;e(window).on("message",function(e){var a=e.originalEvent||e;if(a&&a.data)try{"ready"===JSON.parse(a.data).message&&clearTimeout(void 0)}catch(e){}for(var i=0;i<t.length;i++)t[i](a)});var n,r=function(t,a,i){var n;switch(t&&t.toLowerCase&&t.toLowerCase()||""){case"dev":n="cliblends.dev.microsoft.com";break;case"int":n="uniblends.www.microsoft.com/int";break;case"ppe":n="uniblends.www.microsoft.com/ppe";break;case"prod":default:n="www.microsoft.com/uniblends"}return"https://{host}/{client}{deviceFamily}".replace("{host}",n).replace("{client}",a&&e.trim(a)?"?client="+a:"?client=").replace("{deviceFamily}",i&&e.trim(i)?"&deviceFamily="+e.trim(i):"")},o=function(t,a){var i;switch(t&&t.toLowerCase&&t.toLowerCase()||""){case"dev":i="oneblend.dev.microsoft.com";break;case"int":i="unistoreblends-int.www.microsoft.com";break;case"ppe":i="unistoreblends-ppe.www.microsoft.com";break;default:i="www.microsoft.com"}return"https://{host}/webblend/api/config{client}".replace("{host}",i).replace("{client}",a&&e.trim(a)?"?client="+a:"")},l=function(e,t){var a;switch(e&&e.toLowerCase&&e.toLowerCase()||""){case"dev":case"int":a="purchase-int.mp.microsoft.com";break;default:a="purchase.mp.microsoft.com"}return"https://{host}/{purchaseServiceVersion}/users/me/orders".replace("{host}",a).replace("{purchaseServiceVersion}",7==t?"v7.0":"v6.0")},s=function(){return"xxxxxxxx-xxxx-4xxx-Rxxx-xxxxxxxxxxxx".replace(/x/g,function(){return Math.floor(16*Math.random()).toString(16)}).replace("R",(8|Math.floor(3*Math.random())).toString(16))},d=function(t,a){var i="wb_auto_blend_container",n=e("#"+i),r=a&&a.width||"456px",o=a&&a.height||"560px",l=a&&a.title||"";return n.length?n.css({height:o,width:r}):(n=e("<iframe />",{id:i,name:i,src:"",title:l,style:"width:{width}; height:{height}; position:relative; top:0; left:0; border:0; outline:none; display:block".replace("{width}",r).replace("{height}",o)})).appendTo(t),n},c=function(e,t){document.getElementById(e).contentWindow.postMessage(JSON.stringify({startdata:t}),"*")},u=function(t,l,s,u,p,m,y){n=e("#"+l);var h=d(n,m),f=Date.now();if(a&&""!==h.attr("src"))t.preloadedOpenTime=f,a=!1;else{i=!1,h.attr("src","about:blank");var I=r(s,u,y);h.attr("src",I)}var C=function(){i=!0;var e=Date.now()-f;window.postMessage(JSON.stringify({message:"status",data:"blenderSDK: Loaded in "+e+"ms"}),"*"),t.Client=u,t.configUrl=o(s,u),t.selApps=p,c(h.attr("id"),t)};i?C():h.one("load",C)},p=function(e,t){t&&(e.Layout=t.layout||"",e.CssOverride=t.cssOverride||"",e.Border=t.border||"",e.Brand=t.brand||"")},m=function(e){var t={};if(e){t.AvailabilityId=e.AvailabilityId||"",t.ProductId=e.ProductId||"",t.SkuId=e.SkuId||"",t.Quantity=e.Quantity||1,t.Auth=e.Auth||"",t.XToken=e.XToken||"",t.Culture=e.Culture||"",t.Market=e.Market||"",t.CV=e.CV||"",t.Flights=e.Flight||"",t.IdentityType=e.IdentityType,t.IdentityValue=e.IdentityValue,t.PurchaseServiceVersion=e.PurchaseServiceVersion||"",t.useDelegatedAuth=e.UseDelegatedAuth||!1,t.MessageChannel=e.MessageChannel||"",t.DisplayCompletion=!!e.DisplayCompletion,t.OrderId=e.OrderId,t.Order=e.Order,t.Jwt=e.Jwt,t.Product=e.Product,t.TestClient=e.TestClient||"",t.DeviceContext="moId=PUBLIC&oemId=PUBLIC&scmId=PUBLIC",e.Options&&(t.CallerApplicationId=e.Options.CallerApplicationId||"",t.UniversalAffiliateId=e.Options.UniversalAffiliateId||"",t.CampaignId=e.Options.CampaignId||"",t.DevOfferId=e.Options.DevOfferId||"",t.OptionalCampaignId=e.Options.OptionalCampaignId||"",t.OfferType=e.Options.OfferType||"",t.AddPiSuccessUrl=e.Options.AddPiSuccessUrl||"",t.AddPiFailureUrl=e.Options.AddPiFailureUrl||""),e.MediaOptions&&(t.ProductType=e.MediaOptions.ProductType||"",t.TransactionType=e.MediaOptions.TransactionType||"buy",t.Title=e.MediaOptions.Title||"",t.TitleNo=e.MediaOptions.TitleNo||"",t.SubTitle1=e.MediaOptions.SubTitle1||"",t.SubTitle2=e.MediaOptions.SubTitle2||"",t.ExpirationBeforePlayInHours=e.MediaOptions.ExpirationBeforePlayInHours||"",t.ExpirationAfterPlayInHours=e.MediaOptions.ExpirationAfterPlayInHours||""),e.BeneficiaryData&&(t.BeneficiaryEmail=e.BeneficiaryData.email,t.BeneficiaryFirstName=e.BeneficiaryData.firstName||"",t.BeneficiaryLastName=e.BeneficiaryData.lastName||"");var a="purchase.confirm";"GiftPurchase"===e.PurchaseScenario&&(a="purchase.gift"),p(t,e.Style),u(t,e.ParentElementId,e.Environment,e.ClientType,a,e.IframeOptions,e.DeviceFamily||"")}},y=function(e,t,a,i,n,r,o,l,s,d,c,m,y,h,f,I,C,v){var g={OrderId:e,Auth:t,Culture:o,Flights:n,Market:l,CV:s,PurchaseServiceVersion:c,Jwt:m,TestClient:I||"",DeviceContext:"moId=PUBLIC&oemId=PUBLIC&scmId=PUBLIC",MessageChannel:C,DisplayCompletion:v};y&&(g.BeneficiaryEmail=y.email,g.BeneficiaryFirstName=y.firstName||"",g.BeneficiaryLastName=y.lastName||""),p(g,h),u(g,a,i,r,"purchase.confirm",d,f||"")};return{loadSingleItemPurchaseHtml:function(e,t,a,i,n,r,o,l,s,d,c,m,y,h,f,I,C,v,g,P,T,S,M){var b={AvailabilityId:e,ProductId:t,SkuId:a,Quantity:g||1,Auth:n,Culture:d,Flights:l,Market:c,CV:m,IdentityType:y,IdentityValue:h,PurchaseServiceVersion:C,TestClient:T||"",DeviceContext:"moId=PUBLIC&oemId=PUBLIC&scmId=PUBLIC",MessageChannel:S,DisplayCompletion:M};i&&(b.CampaignId=i.campaignId||"",b.OptionalCampaignId=i.optionalCampaignId||"",b.OfferType=i.offerType||""),f&&(b.ProductType=f.productType||"",b.TransactionType=f.transactionType||"buy",b.Title=f.title||"",b.TitleNo=f.titleNo||"",b.SubTitle1=f.subTitle1||"",b.SubTitle2=f.subTitle2||"",b.ExpirationBeforePlayInHours=f.expirationBeforePlayInHours||"",b.ExpirationAfterPlayInHours=f.expirationAfterPlayInHours||""),p(b,v),u(b,r,o,s,"purchase.confirm",I,P||"")},loadOrderPurchaseHtml:y,loadRedeemHtml:function(e,t,a,i,n,r,o,l,s,d,c,m,y,h){var f={tokenString:e,Auth:t,Culture:o,Flights:n,Market:l,CV:s,PurchaseServiceVersion:"7",UrlRef:m,OcrScanAvailable:y,MessageChannel:h};p(f,c),u(f,a,i,r,"redeem.enterCode",d)},loadAddPaymentInstrumentHtml:function(e,t,a,i,n,r,o,l,s,d,c){var m={Auth:e,Culture:r,Flights:i,Market:o,CV:l,context:"primaryPi",MessageChannel:c};p(m,d),u(m,t,a,n,"paymentAndBilling.choosePaymentMethodFamily",s)},loadEditPaymentInstrumentHtml:function(e,t,a,i,n,r,o,l,s,d,c,m){var y={Auth:e,Culture:r,Flights:i,Market:o,CV:l,PaymentInstrumentId:s,MessageChannel:m};p(y,c),u(y,t,a,n,"paymentAndBilling.editPaymentInstrument",d)},registerMessageHandler:function(e){for(var a=0;a<t.length;a++)if(""+t[a]==""+e)return void console.error("Same message handler function already registered: "+e);t.push(e)},unregisterMessageHandler:function(e){for(var a=0;a<t.length;a++)""+t[a]==""+e&&t.pop(e)},clientTypes:{UniversalWebStore:"UniversalWebStore",MusicVideoReading:"MusicVideoReading",EnterpriseStore:"EnterpriseStore",AccountMicrosoftCom:"AccountMicrosoftCom"},addPaymentInstrument:function(e){var t={};if(e){t.Auth=e.Auth||"",t.XToken=e.XToken||"",t.Culture=e.Culture||"",t.Flights=e.Flight||"",t.Market=e.Market||"",t.CV=e.CV||"",t.context="primaryPi",t.PaymentMethodFamily=e.PaymentMethodFamily||"",t.PaymentMethodType=e.PaymentMethodType||"",t.BillableAccountId=e.BillableAccountId||"",t.PurchaseServiceVersion="7",t.Gamertag=e.Gamertag||"",t.GamerpicUrl=e.GamerpicUrl||"",t.MessageChannel=e.MessageChannel||"";var a=e.DeviceFamily||"web";p(t,e.Style),u(t,e.ParentElementId,e.Environment,e.ClientType,"paymentAndBilling.choosePaymentMethodFamily",e.IframeOptions,a)}},editPaymentInstrument:function(e){var t={};if(e){t.Auth=e.Auth||"",t.XToken=e.XToken||"",t.Culture=e.Culture||"",t.Flights=e.Flight||"",t.Market=e.Market||"",t.CV=e.CV||"",t.PaymentInstrumentId=e.PaymentInstrumentId,t.PaymentMethodFamily=e.PaymentMethodFamily||"",t.PaymentMethodType=e.PaymentMethodType||"",t.PurchaseServiceVersion="7",t.MessageChannel=e.MessageChannel||"";var a=e.DeviceFamily||"web";p(t,e.Style),u(t,e.ParentElementId,e.Environment,e.ClientType,"paymentAndBilling.editPaymentInstrument",e.IframeOptions,a)}},purchaseSingleItem:m,purchaseFreeItem:function(t){var a={},i=!1;t.Options&&t.Options.CallerApplicationId&&(a.callerApplicationId=t.Options.CallerApplicationId,i=!0),t.Options&&t.Options.UniversalAffiliateId&&(a.universalAffiliateId=t.Options.UniversalAffiliateId,i=!0);var n={billingInformation:null,clientContext:{client:t.ClientType,deviceId:t.DeviceId,deviceType:t.DeviceFamily},friendlyName:null,orderAdditionalMetadata:i?JSON.stringify(a):null,items:[{availabilityId:t.AvailabilityId,beneficiary:t.IdentityType&&t.IdentityValue?{identityType:t.IdentityType,identityValue:t.IdentityValue}:null,campaignId:t.Options.CampaignId,devOfferId:t.Options.DevOfferId,giftingInformation:null,optionalCampaignId:t.Options.OptionalCampaignId,orderManagementPolityId:null,productId:t.ProductId,quantity:t.Quantity,renewalContext:null,setBlockInformation:null,skuId:t.SkuId}],language:t.Languages||t.Culture,market:t.Market,orderId:s(),orderState:"Purchased"};e.ajax({type:"POST",url:l(t.Environment,t.PurchaseServiceVersion),data:JSON.stringify(n),contentType:"application/json",beforeSend:function(e){e.setRequestHeader("MS-CV",t.CV),e.setRequestHeader("Authorization",t.Auth?'WLID1.0="'+t.Auth+'"':t.XToken)}}).then(function(a){var i=a&&e.isArray(a.orderLineItems)&&a.orderLineItems||[],n=i[0],r=n.purchaseRestriction&&n.purchaseRestriction.purchaseApprovalState&&n.purchaseRestriction.purchaseApprovalState.toLowerCase&&n.purchaseRestriction.purchaseApprovalState.toLowerCase(),o=n.parentalApprovalState&&n.parentalApprovalState.toLowerCase&&n.parentalApprovalState.toLowerCase();"blockedbypolicy"===r||"blockedbyage"===r||"blockedbypolicy"===o||"blockedbyage"===o?y(a.orderId,t.Auth,t.ParentElementId,t.Environment,t.Flight,t.ClientType,t.Culture,t.Market,t.CV,t.IframeOptions,t.PurchaseServiceVersion,t.Jwt,t.BeneficiaryData,t.Style,t.DeviceFamily,t.TestClient,t.MessageChannel,t.DisplayCompletion):window.postMessage(JSON.stringify({flowId:t.FlowId||s(),message:"done",status:"success",data:{orderId:a.orderId,count:i.length,lineItems:i}}),"*")},function(e){var a=e&&e.responseJSON;"forbidden"===(a&&a.code&&a.code.toLowerCase&&a.code.toLowerCase())?y(n.orderId,t.Auth,t.ParentElementId,t.Environment,t.Flight,t.ClientType,t.Culture,t.Market,t.CV,t.IframeOptions,t.PurchaseServiceVersion,t.Jwt,t.BeneficiaryData,t.Style,t.DeviceFamily,t.TestClient,t.MessageChannel,t.DisplayCompletion):m(t)})},redeem:function(e){var t={};if(e){t.tokenString=e.TokenString||"",t.Auth=e.Auth||"",t.XToken=e.XToken||"",t.Culture=e.Culture||"",t.Market=e.Market||"",t.CV=e.CV||"",t.Flights=e.Flight||"",t.useDelegatedAuth=e.UseDelegatedAuth||!1,t.PurchaseServiceVersion=e.PurchaseServiceVersion||"7",t.UrlRef=e.UrlRef||"",t.OcrScanAvailable=e.OcrScanAvailable||"",t.MessageChannel=e.MessageChannel||"";var a=e.DeviceFamily||"web";p(t,e.Style),u(t,e.ParentElementId,e.Environment,e.ClientType,"redeem.enterCode",e.IframeOptions,a)}},preLoadBlend:function(t){if(t){n=e("#"+t.ParentElementId);var o=d(n,{height:0,width:0,title:""});i=!1,a=!0,o.attr("src","about:blank");var l=r(t.Environment,t.ClientType,t.DeviceFamily);o.attr("src",l),o.one("load",function(){i=!0}),window.postMessage(JSON.stringify({message:"status",data:"blenderSDK: Preload started"}),"*")}}}}(jQuery);