define(["jquery","util/helpers"],function(a,b){"use strict";var c={init:function(a,c){return this.player=a,this.options=b.extend(!0,{},c),this.bindEvents(),this},bindEvents:function(){this.onPostMessageHandler=this.onPostMessage.bind(this),this.onVideoPlayerHandler=this.onVideoPlayer.bind(this),this.onVideoEventHandler=this.onVideoEvent.bind(this),a(document).on("VideoPlayer.start",this.onVideoPlayerHandler),a(document).on("VideoPlayer.pause",this.onVideoPlayerHandler),a(document).on("VideoPlayer.end",this.onVideoPlayerHandler),a(document).on("VideoPlayer.play",this.onVideoPlayerHandler),a(document).on("VideoPlayer.error",this.onVideoPlayerHandler),a(document).on("VideoPlayer.inited",this.onVideoPlayerHandler),a(document).on("VideoPlayer.advStarted",this.onVideoPlayerHandler),a(document).on("VideoPlayer.advComplete",this.onVideoPlayerHandler),a(window).on("message",this.onPostMessageHandler)},destroy:function(){a(document).off("VideoPlayer.start",this.onVideoPlayerHandler),a(document).off("VideoPlayer.pause",this.onVideoPlayerHandler),a(document).off("VideoPlayer.end",this.onVideoPlayerHandler),a(document).off("VideoPlayer.play",this.onVideoPlayerHandler),a(document).off("VideoPlayer.error",this.onVideoPlayerHandler),a(document).off("VideoPlayer.inited",this.onVideoPlayerHandler),a(document).off("VideoPlayer.advStarted",this.onVideoPlayerHandler),a(document).off("VideoPlayer.advComplete",this.onVideoPlayerHandler),this.video&&(a(this.video).off("pause",this.onVideoEventHandler),a(this.video).off("play",this.onVideoEventHandler),a(this.video).off("playing",this.onVideoEventHandler),a(this.video).off("ended",this.onVideoEventHandler),a(this.video).off("progress",this.onVideoEventHandler),a(this.video).off("suspend",this.onVideoEventHandler),a(this.video).off("seeked",this.onVideoEventHandler),a(this.video).off("timeupdate",this.onVideoEventHandler),a(this.video).off("volumechange",this.onVideoEventHandler),a(this.video).off("waiting",this.onVideoEventHandler)),a(window).off("message",this.onPostMessageHandler)},onVideoPlayer:function(a,b){var c,d=a.namespace,e=0;switch(this.video&&(e=this.video.currentTime),a.namespace){case"start":this.trackVideo(b),this.sendYandexEvent({event:"started",time:e});break;case"pause":this.sendYandexEvent({event:"paused",time:e});break;case"end":this.sendYandexEvent({event:"ended",time:e});break;case"play":this.sendYandexEvent({event:"resumed",time:e});break;case"inited":this.sendYandexEvent({event:"inited",time:e}),this.sendYandexEvent({event:"autoplay",autoplay:this.options.flashVars.autoplay?1:0});break;case"advStarted":this.sendYandexEvent({event:"adShown",time:e});break;case"error":switch(b){case"video_not_found":c="100";break;case"forbidden":c="150";break;case"playback":c="5";break;default:c="0"}this.sendYandexEvent({event:"error",code:c,time:e})}this.sendYandexEvent(JSON.stringify(d))},onPostMessage:function(a){var b,c,d,e=a.originalEvent.data;switch(e&&(b=e.split(",")),b[0]){case"play":this.player.play();break;case"pause":this.player.pause();break;case"mute":0!==this.video.volume&&this.player.toggleMute();break;case"unmute":0===this.video.volume&&this.player.toggleMute();break;case"volume_up":this.player.volumeUp();break;case"volume_down":this.player.volumeDown();break;case"seek_forward":this.player.seekForward();break;case"seek_backward":this.player.seekBackward();break;case"seek":this.player.seek(b[1]);break;case"volume":this.player.setVolume(b[1]);break;default:d=!0}this.isSendMessageCounter||d||(this.options.request.referer&&(c=this.options.request.referer.indexOf("yandex.ru")!==-1||this.options.request.referer.indexOf("yastatic.net")!==-1),this.isSendMessageCounter=!0,(new Image).src="https://my.mail.ru/grstat?name=html5player.ext.off.externalapi.postMessage",c&&((new Image).src="https://my.mail.ru/grstat?name=html5player.ext.off.externalapi.postMessageYandex"))},onVideoEvent:function(a){var b,c,d,e=a.target;b=e.ended?"ended":e.networkState===e.NETWORK_LOADING&&e.readyState<e.HAVE_FUTURE_DATA?"buffering":e.paused?"paused":e.currentTime>0?"playing":"inited",d="timeupdate"===a.type?"timeChanged":"volumechange"===a.type?"volumechanged":"statusChanged","seeked"===a.type&&this.sendYandexEvent({event:"rewound",time:e.currentTime}),c={name:"data",message:d,eventName:a.type,currentTime:e.currentTime,duration:e.duration,volume:e.volume,state:b},this.sendYandexEvent(JSON.stringify(c))},sendYandexEvent:function(a){a&&window!==window.parent&&window.parent.postMessage(a,"*")},trackVideo:function(b){this.video=b,a(this.video).on("pause",this.onVideoEventHandler),a(this.video).on("play",this.onVideoEventHandler),a(this.video).on("playing",this.onVideoEventHandler),a(this.video).on("ended",this.onVideoEventHandler),a(this.video).on("progress",this.onVideoEventHandler),a(this.video).on("suspend",this.onVideoEventHandler),a(this.video).on("seeked",this.onVideoEventHandler),a(this.video).on("timeupdate",this.onVideoEventHandler),a(this.video).on("volumechange",this.onVideoEventHandler),a(this.video).on("waiting",this.onVideoEventHandler)}};return{create:function(a,b){return Object.create(c).init(a,b)}}});