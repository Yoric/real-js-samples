!function e(t,n,r){function s(i,a){if(!n[i]){if(!t[i]){var h="function"==typeof require&&require;if(!a&&h)return h(i,!0);if(o)return o(i,!0);var u=new Error("Cannot find module '"+i+"'");throw u.code="MODULE_NOT_FOUND",u}var c=n[i]={exports:{}};t[i][0].call(c.exports,function(e){var n=t[i][1][e];return s(n||e)},c,c.exports,e,t,n,r)}return n[i].exports}for(var o="function"==typeof require&&require,i=0;i<r.length;i++)s(r[i]);return s}({1:[function(e,t,n){function r(){this._events=this._events||{},this._maxListeners=this._maxListeners||void 0}function s(e){return"function"==typeof e}function o(e){return"number"==typeof e}function i(e){return"object"==typeof e&&null!==e}function a(e){return void 0===e}t.exports=r,r.EventEmitter=r,r.prototype._events=void 0,r.prototype._maxListeners=void 0,r.defaultMaxListeners=10,r.prototype.setMaxListeners=function(e){if(!o(e)||e<0||isNaN(e))throw TypeError("n must be a positive number");return this._maxListeners=e,this},r.prototype.emit=function(e){var t,n,r,o,h,u;if(this._events||(this._events={}),"error"===e&&(!this._events.error||i(this._events.error)&&!this._events.error.length)){if((t=arguments[1])instanceof Error)throw t;var c=new Error('Uncaught, unspecified "error" event. ('+t+")");throw c.context=t,c}if(n=this._events[e],a(n))return!1;if(s(n))switch(arguments.length){case 1:n.call(this);break;case 2:n.call(this,arguments[1]);break;case 3:n.call(this,arguments[1],arguments[2]);break;default:o=Array.prototype.slice.call(arguments,1),n.apply(this,o)}else if(i(n))for(o=Array.prototype.slice.call(arguments,1),u=n.slice(),r=u.length,h=0;h<r;h++)u[h].apply(this,o);return!0},r.prototype.addListener=function(e,t){var n;if(!s(t))throw TypeError("listener must be a function");return this._events||(this._events={}),this._events.newListener&&this.emit("newListener",e,s(t.listener)?t.listener:t),this._events[e]?i(this._events[e])?this._events[e].push(t):this._events[e]=[this._events[e],t]:this._events[e]=t,i(this._events[e])&&!this._events[e].warned&&(n=a(this._maxListeners)?r.defaultMaxListeners:this._maxListeners)&&n>0&&this._events[e].length>n&&(this._events[e].warned=!0,console.error("(node) warning: possible EventEmitter memory leak detected. %d listeners added. Use emitter.setMaxListeners() to increase limit.",this._events[e].length),"function"==typeof console.trace&&console.trace()),this},r.prototype.on=r.prototype.addListener,r.prototype.once=function(e,t){function n(){this.removeListener(e,n),r||(r=!0,t.apply(this,arguments))}if(!s(t))throw TypeError("listener must be a function");var r=!1;return n.listener=t,this.on(e,n),this},r.prototype.removeListener=function(e,t){var n,r,o,a;if(!s(t))throw TypeError("listener must be a function");if(!this._events||!this._events[e])return this;if(n=this._events[e],o=n.length,r=-1,n===t||s(n.listener)&&n.listener===t)delete this._events[e],this._events.removeListener&&this.emit("removeListener",e,t);else if(i(n)){for(a=o;a-- >0;)if(n[a]===t||n[a].listener&&n[a].listener===t){r=a;break}if(r<0)return this;1===n.length?(n.length=0,delete this._events[e]):n.splice(r,1),this._events.removeListener&&this.emit("removeListener",e,t)}return this},r.prototype.removeAllListeners=function(e){var t,n;if(!this._events)return this;if(!this._events.removeListener)return 0===arguments.length?this._events={}:this._events[e]&&delete this._events[e],this;if(0===arguments.length){for(t in this._events)"removeListener"!==t&&this.removeAllListeners(t);return this.removeAllListeners("removeListener"),this._events={},this}if(n=this._events[e],s(n))this.removeListener(e,n);else if(n)for(;n.length;)this.removeListener(e,n[n.length-1]);return delete this._events[e],this},r.prototype.listeners=function(e){return this._events&&this._events[e]?s(this._events[e])?[this._events[e]]:this._events[e].slice():[]},r.prototype.listenerCount=function(e){if(this._events){var t=this._events[e];if(s(t))return 1;if(t)return t.length}return 0},r.listenerCount=function(e,t){return e.listenerCount(t)}},{}],2:[function(e,t,n){"use strict";n.__esModule=!0;var r=function(){function e(){}return e.setGroup=function(e,t,n){this.testId=e,this.groupId=t;try{this.params=JSON.parse(n)}catch(e){this.testId=0}this.viewStart=performance.now()},e.getParam=function(e){return this.params[e]},e.setLogData=function(e,t){this.logData[e]=t},e.getLogData=function(){return this.setLogData("viewDuration",this.getViewDuration()),this.testId?{testId:this.testId,groupId:this.groupId,data:this.logData}:void 0},e.getViewDuration=function(){return Math.round((performance.now()-this.viewStart)/1e3)},e}();r.testId=0,r.params={},r.logData={},r.viewStart=0,n.CandyAB=r},{}],3:[function(e,t,n){"use strict";n.__esModule=!0;var r=e("./loaders/manager"),s=e("./statistics"),o=e("./swarm/swarm"),i=e("./utils/js2flash/js2flash"),a=e("./version"),h=e("./loaders/dashWrapper"),u=function(){function e(e){void 0===e&&(e={}),this.config=e,this.defaultConfig={swarm:{wsserver:"wss://candy.goodgame.ru:8085/",peersLimit:15,updateTimeout:2e4,peerConfig:{rtcConfig:{iceServers:[{url:"stun:stun.l.google.com:19302"},{url:"stun:stun1.l.google.com:19302"}],optional:{optional:[]},constraints:{optional:[],mandatory:{}}},connectionTimeout:1e4,sendTimeout:2e3,flushStatsInterval:6e4,sentChunksThreshold:4,receivedChunksThreshold:4,myCity:""}},storage:{cleanupTimeout:3e4,borderTime:3e4},manager:{idleTimeout:3e5}},this.config=this.merge({},this.defaultConfig,e),e.clientId||(e.clientId=this.getClientId()),s.CandyStat.clientId=e.clientId,s.CandyStat.channel=e.streamKey,this.swarm=new o.Swarm(e.streamKey,e.clientId,this.config.swarm),this.manager=new r.LoaderManager(this.config,this.swarm)}return e.prototype.xhrLoader=function(){return this.manager.xhrLoader()},e.prototype.hlsJsLoader=function(){return this.manager.hlsJsLoader()},e.prototype.dashJsLoader=function(e){return this.manager.dashJsLoader(e)},e.dashWrapper=function(e,t){return new h.DashWrapper(e,t)},e.prototype.flash=function(t){e.js2flash=new i.js2flash(t),e.js2flash.setLoader(this.xhrLoader()),this.manager.bufferTimeFunction=function(){return e.js2flash.getCurrentBufferTime()},e.helpers={JSLoaderPlaylist:{requestPlaylist:function(t,n,r,s){e.js2flash.requestPlaylist(t,n,r,s)},abortPlaylist:function(t){return e.js2flash.abortPlaylist(t)}},JSLoaderFragment:{requestFragment:function(t,n,r,s){e.js2flash.requestFragment(t,n,r,s)},abortFragment:function(t){return e.js2flash.abortFragment(t)}},setCurrentBufferTime:function(t){return e.js2flash.setCurrentBufferTime(t)}}},e.prototype.setStreamKey=function(e){this.manager.stop(),s.CandyStat.channel=this.config.streamKey=e,this.swarm.setStreamKey(e),this.manager.start()},e.prototype.destroy=function(){this.swarm.destroy(),this.manager.destroy()},e.getStat=function(){return s.CandyStat.get()},e.prototype.merge=function(e){for(var t=[],n=1;n<arguments.length;n++)t[n-1]=arguments[n];for(var r in t){var s=t[r];if(!s)break;for(var o in s)"object"==typeof s[o]&&null!==s[o]&&e[o]?this.merge(e[o],s[o]):e[o]=s[o]}return e},e.prototype.getClientId=function(){return{"vk.com":4,"ok.ru":6,"www.ok.ru":6,"vidi.tv":7,"www.vidi.tv":7,"live.russia.tv":8,"public.webdeveloperlab.ru":8}[window.location.hostname]||0},e}();n.Candy=u,window.Candy=u,u.ver=a.CANDY_VERSION},{"./loaders/dashWrapper":5,"./loaders/manager":8,"./statistics":13,"./swarm/swarm":21,"./utils/js2flash/js2flash":24,"./version":26}],4:[function(e,t,n){"use strict";var r=this&&this.__extends||function(){var e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n])};return function(t,n){function r(){this.constructor=t}e(t,n),t.prototype=null===n?Object.create(n):(r.prototype=n.prototype,new r)}}();n.__esModule=!0;var s=e("events"),o=e("../logger"),i=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return r(t,e),t.prototype.addEventListener=function(e,t){return this.addListener(e,t)},t.prototype.dispatchEvent=function(e){for(var t=[],n=1;n<arguments.length;n++)t[n-1]=arguments[n];return e?this.emit.apply(this,[e].concat(t)):void o.Logger.error.apply(o.Logger,["No event type"].concat(t))},t.prototype.removeEventListener=function(e,t){return this.removeListener(e,t)},t.prototype.destroy=function(){this.removeAllListeners()},t}(s.EventEmitter);n.CandyEmitter=i},{"../logger":12,events:1}],5:[function(e,t,n){"use strict";n.__esModule=!0;var r=e("../candy"),s=function(){function e(e,t){this.clientId=e,this.dashInstance=t;for(var n in t)t.hasOwnProperty(n)&&!this[n]&&(this[n]=t[n]);return this.prototype=t.prototype,this}return e.prototype.reset=function(){this.candy.destroy(),this.dashInstance.reset()},e.prototype.initialize=function(e,t,n){var s=this;this.candy=new r.Candy({video:e,streamKey:t.split("/")[4],clientId:this.clientId}),this.loader=this.candy.dashJsLoader(this.candy.manager),this.dashInstance.extend("XHRLoader",this.loader,!0),this.dashInstance.initialize(e,t,n),this.dashInstance.setBufferTimeAtTopQuality(15),this.dashInstance.setBufferTimeAtTopQualityLongForm(30),this.candy.manager.storage.onFileLoaded=function(e){e.peers&&e.peers.length?(s.dashInstance.setBufferTimeAtTopQuality(150),s.dashInstance.setBufferTimeAtTopQualityLongForm(300)):(s.dashInstance.setBufferTimeAtTopQuality(15),s.dashInstance.setBufferTimeAtTopQualityLongForm(30))}},e}();n.DashWrapper=s},{"../candy":3}],6:[function(e,t,n){"use strict";n.__esModule=!0;var r=e("../logger"),s=e("./xhrLoader"),o=function(){function e(){}return e.handleLoaded=function(e,t,n){this.needFailureReport=!1,e.request.requestStartDate=this.requestStartTime,e.request.requestEndDate=new Date,e.request.firstByteDate=e.request.firstByteDate||this.requestStartTime,e.request.checkExistenceOnly||this.metricsModel.addHttpRequest(e.request.mediaType,null,e.request.type,e.request.url,null,e.request.serviceLocation||null,e.request.range||null,e.request.requestStartDate,e.request.firstByteDate,e.request.requestEndDate,t.status,e.request.duration,t.getAllResponseHeaders(),n?this.traces:null)},e.loadCallback=function(e,t){t.status>=200&&t.status<=299&&(this.handleLoaded(e,t,!0),e.success&&e.success(t.response,t.statusText,t),e.complete&&e.complete(e.request,t.statusText))},e.loadendCallback=function(e,t,n){var r=this;-1!==this.loaders.indexOf(t)&&(this.loaders.splice(this.loaders.indexOf(t),1),this.needFailureReport&&(this.handleLoaded(e,t,!1),this.remainingAttempts>0?(this.remainingAttempts--,this.retryTimers.push(setTimeout(function(){r.load(e,n,t.manager)},this.mediaPlayerModel.getRetryIntervalForType(e.request.type)))):(this.errHandler.downloadError(this.downloadErrorToRequestTypeMap[e.request.type],e.request.url,e.request),e.error&&e.error(e.request,"error",t.statusText),e.complete&&e.complete(e.request,t.statusText))))},e.progressCallback=function(e,t){var n=new Date;this.firstProgress&&(this.firstProgress=!1,(!t.lengthComputable||t.lengthComputable&&t.total!==t.loaded)&&(e.request.firstByteDate=n)),t.lengthComputable&&(e.request.bytesLoaded=t.loaded,e.request.bytesTotal=t.total),this.traces.push({s:this.lastTraceTime,d:n.getTime()-this.lastTraceTime.getTime(),b:[t.loaded?t.loaded-this.lastTraceReceivedCount:0]}),this.lastTraceTime=n,this.lastTraceReceivedCount=t.loaded,e.progress&&e.progress()},e.load=function(e,t,n){var o=this,i=e.request,a=new s.xhrLoader(n);this.mediaPlayerModel||(this.mediaPlayerModel=t.mediaPlayerModel,this.metricsModel=t.metricsModel,this.errHandler=t.errHandler,this.remainingAttempts=this.mediaPlayerModel.getRetryAttemptsForType(e.request.type)),this.traces=[],this.firstProgress=!0,this.needFailureReport=!0,this.requestStartTime=new Date,this.lastTraceTime=this.requestStartTime,this.lastTraceReceivedCount=0;try{var h=t.requestModifier.modifyRequestURL(i.url),u=i.checkExistenceOnly?"HEAD":"GET";a.open(u,h,!0),i.responseType&&(a.responseType=i.responseType),i.range&&a.setRequestHeader("Range","bytes="+i.range),i.requestStartDate||(i.requestStartDate=this.requestStartTime),a.withCredentials=t.mediaPlayerModel.getXHRWithCredentialsForType(i.type),a.addEventListener("load",function(){return o.loadCallback(e,a)}),a.addEventListener("loadend",function(){return o.loadendCallback(e,a,t)}),a.addEventListener("error",function(){return o.loadendCallback(e,a,t)}),a.addEventListener("progress",function(t){return o.progressCallback(e,t)});var c=(new Date).getTime();if(isNaN(i.delayLoadingTime)||c>=i.delayLoadingTime)this.loaders.push(a),a.send();else{var d={loader:a};this.delayedLoaders.push(d),d.delayTimeout=setTimeout(function(){if(-1!==this.delayedLoaders.indexOf(d)){this.delayedLoaders.splice(this.delayedLoaders.indexOf(d),1);try{this.loaders.push(d.loader),d.loader.send()}catch(e){d.loader.onerror()}}},i.delayLoadingTime-c)}}catch(e){r.Logger.error(e),console.error(e)}},e.abort=function(){this.retryTimers.forEach(function(e){return clearTimeout(e)}),this.retryTimers=[],this.delayedLoaders.forEach(function(e){return clearTimeout(e.delayTimeout)}),this.delayedLoaders=[],this.loaders.forEach(function(e){e.onloadend=e.onerror=e.onprogress=void 0,e.abort()}),this.loaders=[]},e.getLoader=function(e){var t=this.load.bind(this),n=this.abort.bind(this);return function(r){var s=this.factory.getSingletonInstance(this.context,"MediaPlayerModel"),o={mediaPlayerModel:s,metricsModel:r.metricsModel,requestModifier:r.requestModifier,errHandler:r.errHandler};return{load:function(n){n.request&&t(n,o,e)},abort:function(){n()}}}},e}();o.loaders=[],o.delayedLoaders=[],o.retryTimers=[],o.downloadErrorToRequestTypeMap={MPD:"manifest",XLinkExpansion:"xlink",InitializationSegment:"initialization",MediaSegment:"content",IndexSegment:"content",BitstreamSwitchingSegment:"content",other:"content"},n.dashjsLoader=o},{"../logger":12,"./xhrLoader":11}],7:[function(e,t,n){"use strict";n.__esModule=!0;var r=e("./xhrLoader"),s=function(){function e(){this.stats={}}return e.prototype.load=function(e,t,n){var s=this,o=this.loader=new r.xhrLoader(this.manager);o.open("GET",e.url,!0),o.responseType=e.responseType,o.timeout=1e4,o.withCredentials=this.loader.manager.withCredentials||!1,this.stats.trequest=performance.now(),this.stats.tfirst=0,this.stats.tload=0,this.stats.loaded=1,this.stats.total=1,o.addEventListener("progress",function(t){return s.progressCallback(t,n.onProgress,e)}),o.addEventListener("timeout",function(t){return s.progressCallback(t,n.onProgress,e)}),o.addEventListener("error",function(t){return n.onError({code:o.status,text:t.message},e)}),o.addEventListener("load",function(t){s.stats.tload=performance.now(),n.onSuccess({url:e.url,data:t.target.response.slice(0)},s.stats,e)}),o.send()},e.prototype.abort=function(){this.loader.abort()},e.prototype.destroy=function(){this.loader.destroy&&this.loader.destroy()},e.prototype.progressCallback=function(e,t,n){this.stats.tfirst||(this.stats.tfirst=performance.now()),this.stats.loaded=e.loaded,this.stats.total=e.total,t(this.stats,n)},e}();n.hlsjsLoader=s},{"./xhrLoader":11}],8:[function(e,t,n){"use strict";n.__esModule=!0;var r=e("../logger"),s=e("../storage/storage"),o=e("./dashjsLoader"),i=e("./hlsjsLoader"),a=e("./xhrLoader"),h=function(){function e(e,t){this.swarm=t,this.prefferedPeers={},this.p2pBusy=!1,this.withCredentials=!1,this.video=e.video,this.config=e.manager,this.storage=new s.CandyStorage(e.storage,t),this.withCredentials=e.manager.withCredentials||!1,this.restartIdleTimer()}return e.prototype.xhrLoader=function(){return a.xhrLoader},e.prototype.hlsJsLoader=function(){return i.hlsjsLoader},e.prototype.dashJsLoader=function(e){return o.dashjsLoader.getLoader(e)},e.prototype.start=function(){this.restartIdleTimer(),this.swarm.start()},e.prototype.stop=function(){r.Logger.warn("Manager stop at idleTimeout"),this.swarm.stop(),this.prefferedPeers={}},e.prototype.bufferTime=function(){return this.bufferTimeFunction?this.bufferTimeFunction():this.video instanceof HTMLVideoElement?this.video&&this.video.currentTime&&this.video.buffered.length>0?this.video.buffered.end(this.video.buffered.length-1)-this.video.currentTime||0:0:this.video instanceof Function?this.video():void 0},e.prototype.timeLimit=function(){return 3},e.prototype.fallbackTime=function(){return Math.min(6e4,1e3*(this.bufferTime()-this.timeLimit()))},e.prototype.canLoadWithP2P=function(e){return!!this.canStore(e)&&(!!RTCPeerConnection&&(!(this.bufferTime()<this.timeLimit())&&!!this.swarm.hasPeers()))},e.prototype.canStore=function(e){return-1==e.indexOf(".idx")&&(-1==e.indexOf(".mpd")&&(-1==e.indexOf("init.")&&(-1==e.indexOf(".m3u8")&&(-1==e.indexOf(".ism")&&(-1==e.indexOf(".vtt")&&(-1==e.indexOf("russia_1")||-1!=e.indexOf("_hig_")))))))},e.prototype.getFilename=function(e){if(-1!=e.indexOf("?")&&(e=e.slice(0,e.indexOf("?"))),-1!=e.indexOf("mycdn.me")){var t=e.split("/");return[t[4],t[t.length-1]].join("/")}var n=e.split("/");return n.splice(n.length-2,2).join("/")},e.prototype.destroy=function(){this.storage.destroy(),a.xhrLoader.loadedCallback=null},e.prototype.restartIdleTimer=function(){var e=this;this.idleTimeout&&clearTimeout(this.idleTimeout),this.config.idleTimeout&&(this.idleTimeout=setTimeout(function(){return e.stop()},this.config.idleTimeout))},e}();n.LoaderManager=h},{"../logger":12,"../storage/storage":17,"./dashjsLoader":6,"./hlsjsLoader":7,"./xhrLoader":11}],9:[function(e,t,n){"use strict";var r=this&&this.__extends||function(){var e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n])};return function(t,n){function r(){this.constructor=t}e(t,n),t.prototype=null===n?Object.create(n):(r.prototype=n.prototype,new r)}}();n.__esModule=!0;var s=e("../core/EventTarget"),o=e("../logger"),i=function(e){function t(t){var n=e.call(this)||this;n.manager=t,n.isCandy=!0,n.readyState=0,n.done=!1,n.phase=0,n.interestedPeers=[],n.hasPeers=[],n.loadingPeers=[],n.peers=t.swarm.getActivePeers();for(var r in n.peers)n.peers[r]._handleResponse=function(e){return n.handleResponse(e)};return n}return r(t,e),t.prototype.load=function(e){this.url=this.manager.getFilename(e),this.createFile(),this.manager.p2pBusy=!0,this.startPhase0()},t.prototype.startPhase0=function(){var e=this;if(0==Object.keys(this.manager.prefferedPeers).length)return this.startPhase1();this.phase=0;var t=Object.keys(this.manager.prefferedPeers).map(function(t){return e.manager.prefferedPeers[t]});o.Logger.log("phase 0 started",this.url),this.manager.prefferedPeers={},this.repeat(function(){if(0==t.length||e.hasPeers.length)return!1;o.Logger.log("Asking ",t,e.url);for(var n=!1,r=0;r<t.length;r++){var s=!1;try{var i=t[r];s=i.sendHave(e.url)}catch(e){}s?n=!0:(t.splice(r,1),delete e.manager.prefferedPeers[i.id])}return n?void 0:(o.Logger.warn("phase 0 aborted"),!1)},1e3,5,function(){e.hasPeers.length||e.startPhase1()})},t.prototype.startPhase1=function(){var e=this;o.Logger.log("phase 1 started",this.url),this.phase=1;var t=this.peers;for(var n in t){var r=t[n];try{var s=r.sendHave(this.url)}catch(e){s=!1}s?this.interestedPeers.push(r):delete t[n]}this.interestedTimeout=setTimeout(function(){return e.interestedPhaseDone()},2e3)},t.prototype.interestedPhaseDone=function(){if(!this.done){if(3==this.phase)return void o.Logger.log("Already downloading...");clearTimeout(this.interestedTimeout),o.Logger.log("interestedPhaseDone","fails:",this.interestedPeers.length,"have:",this.hasPeers.length,"loadings:",this.loadingPeers.length),this.hasPeers.length?this.startLoading():this.loadingPeers.length?this.waitLoadingPeers():this.onFail("interestedPhaseDone")}},t.prototype.waitLoadingPeers=function(){var e=this;o.Logger.warn("Have loading peers, waiting..."),setTimeout(function(){if(e.phase=2,e.done)return!1;o.Logger.warn("phase 2 started",e.url);for(var t=0;t<e.loadingPeers.length;t++){var n=e.loadingPeers[t],r=!1;try{r=n.sendHave(e.url)}catch(e){}r&&e.interestedPeers.push(n)}e.loadingTimeout=setTimeout(function(){return e.loadingPhaseDone()},2e3)},1e3)},t.prototype.loadingPhaseDone=function(){clearTimeout(this.loadingTimeout),o.Logger.log("loadingPhaseDone"),this.hasPeers.length?this.startLoading():this.startPhase1()},t.prototype.startLoading=function(){var e=this;this.phase=3,this.trequest||(this.trequest=performance.now()),o.Logger.log("Phase 3 downloading",this.hasPeers),this.file.loading=!0;var t;this.repeat(function(){if(t=e.file.getMissingChunks(),0==t.length)return o.Logger.log("getMissingChunks == 0"),e.onFail(),!1;var n=0,r=e.chunk(t,Math.ceil(t.length/2));if(r.length||o.Logger.log("No blocks for chunks:",t),!e.hasPeers.length)return o.Logger.error("No peers"),!1;for(o.Logger.log("phase",e.phase,e.url,"peers: ",e.hasPeers.length,"blocks: ",r.length,"chunks:",t.length);r.length;){var s=r.shift(),i=!1;try{o.Logger.log("asking",e.hasPeers[n].id,s),e.hasPeers[n].askChunks(e.url,s),i=!0}catch(t){o.Logger.log("Error askings peers",e.hasPeers,n,t)}i||e.hasPeers.splice(n,1),n++,n>=e.hasPeers.length&&(n=0)}},1e3,4,function(){e.done||(o.Logger.warn("Download failed!"),e.hasPeers.length=0,e.startPhase1())})},t.prototype.createFile=function(){var e=this;this.file=this.manager.storage.createFile(this.url),this.file.addEventListener("progress",function(t){return e.dispatchEvent("progress",t)}),this.file.addEventListener("load",function(t){return e.onDone(t)})},t.prototype.handleResponse=function(e){var t=e.message;if("answer"==t.type&&t.url==this.url){o.Logger.log("phase",this.phase,e.peer.id,e.message);e.peer.id;if("have"==t.result){-1==this.hasPeers.indexOf(e.peer)&&this.hasPeers.push(e.peer);var n=this.interestedPeers.indexOf(e.peer);return n>-1&&this.interestedPeers.splice(n,1),this.file.sizeInChunks||(this.file.sizeInChunks=t.size),this.interestedPhaseDone()}if(2!=this.phase&&"loading"==t.result&&this.loadingPeers.push(e.peer),1==this.phase){var n=this.interestedPeers.indexOf(e.peer);n>-1&&this.interestedPeers.splice(n,1),0==this.interestedPeers.length&&this.interestedPhaseDone()}if(2==this.phase){var r=this.loadingPeers.indexOf(e.peer);r>-1&&this.loadingPeers.splice(r,1),0==this.loadingPeers.length&&this.loadingPhaseDone()}}},t.prototype.onDone=function(e){var t=this;this.done||(o.Logger.info("got file from p2p",this.url,performance.now()-this.trequest),this.done=!0,this.response=e.response,this.readyState=4,this.peers=e.target.peers,e.target=this,this.hasPeers.forEach(function(e){return t.manager.prefferedPeers[e.id]=e}),this.dispatchEvent("load",e),this.destroy())},t.prototype.onFail=function(e){this.done&&this.response||(e&&o.Logger.log("p2pLoader error",e),this.dispatchEvent("fallback",{type:"fallback",target:this}),this.destroy())},t.prototype.repeat=function(e,t,n,r){var s,o=this,i=0,a=function(){return!o.done&&(i++,!1===e()||n&&!(i<=n)?r&&r():void(s=setTimeout(a,t)))};a()},t.prototype.chunk=function(e,t){for(var n=[],r=0;r<e.length;r+=t)n.push(e.slice(r,r+t));return n},t.prototype.abort=function(){this.done=!0,this.destroy()},t.prototype.destroy=function(){this.manager.p2pBusy=!1,this.done=!0,e.prototype.destroy.call(this)},t}(s.CandyEmitter);n.p2pLoader=i},{"../core/EventTarget":4,"../logger":12}],10:[function(e,t,n){"use strict";var r=this&&this.__extends||function(){var e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n])};return function(t,n){function r(){this.constructor=t}e(t,n),t.prototype=null===n?Object.create(n):(r.prototype=n.prototype,new r)}}();n.__esModule=!0;var s=e("../logger"),o=e("../storage/chunk"),i=e("../core/EventTarget"),a=function(e){function t(t,n){var r=e.call(this)||this;return r.request=t,r.file=n,r.isRange=!0,r.readyState=0,r.mode=h.single,r.allRequest=[],r.ranges=[],r.buildRanges(),r.events(),r}return r(t,e),t.prototype.load=function(){var e=this;this.mode==h.multiple?this.multipleRequest(this.ranges):(s.Logger.log("Range loader",this.ranges.length,"parts"),this.ranges.forEach(function(t){return e.singleRequest(t)}))},t.prototype.destroy=function(){this.request=null,this.file=null,this.allRequest.forEach(function(e){return e.abort()}),this.allRequest.length=0,e.prototype.destroy.call(this)},t.prototype.buildRanges=function(){for(var e=this.file.getMissingChunks(),t=[],n=NaN,r=[],o=0;o<e.length;o++){var i=e[o];1!==i-n&&(r=[],t.push(r)),r.push(i),n=i}s.Logger.log("buildRanges",t),this.ranges=t},t.prototype.events=function(){var e=this;this.file.addEventListener("progress",function(t){return e.dispatchEvent("progress",t)}),this.file.addEventListener("load",function(t){return e.onDone(t)})},t.prototype.onDone=function(e){s.Logger.info("got file from range requester",this.request.url),this.response=e.response,this.readyState=4,e.target=this,t=this.file.getBytesStat(),e.p2pBytes=t[0],e.cdnBytes=t[1],this.dispatchEvent("load",e),this.destroy();var t},t.prototype.singleRequest=function(e){var t=this,n=this.bytesRange(e);s.Logger.log("singleRequest:",n);var r=new XMLHttpRequest;r.open(this.request.method,this.request.url,!0),r.setRequestHeader("Range","bytes="+n),r.responseType=this.request.responseType,r.onreadystatechange=function(e){return t.onReadySingle(e)},r.onerror=function(e){return t.onError(e)},r.part=e,r.rangeMode=h.single,r.rangeStr=n,r.send(),this.allRequest.push(r)},t.prototype.onReadySingle=function(e){var t=e.currentTarget;if(4==t.readyState&&t.response){if(!this.file)return;for(var n=t.response,r=0;r<t.part.length;r++)if(this.file){var s=t.part[r],i=n.slice(r*o.FileChunk.payloadSize,(r+1)*o.FileChunk.payloadSize),a=new o.FileChunk(this.file.url,s).setPayload(i);this.file.addChunk(a)}this.allRequest.splice(this.allRequest.indexOf(t),1)}},t.prototype.multipleRequest=function(e){var t=this,n=e.map(function(e){return t.bytesRange(e)}).join(",");s.Logger.log(n);var r=new XMLHttpRequest;r.open(this.request.method,this.request.url,!0),r.setRequestHeader("Range","bytes="+n),r.responseType=this.request.responseType,r.onreadystatechange=function(e){return t.onReadyMultiple(e)},r.onerror=function(e){return t.onError(e)},r.parts=e,r.rangeMode=h.multiple,r.rangestr=n,r.send(),this.allRequest.push(r)},t.prototype.onReadyMultiple=function(e){var t=e.currentTarget;if(4==t.readyState&&t.response){for(var n=t.response,r=t.getResponseHeader("content-type"),s=r.substr(r.lastIndexOf("=")+1),i=this.str2bytes("\r\n\r\n"),a="\r\n--"+s,h=this.str2bytes(a),u=h.length,c=new Uint8Array(n),d=this.findByteSequence(0,c,h),l=0;-1!==d;){var p=this.findByteSequence(d,c,i);if(-1===p)break;d=this.findByteSequence(p,c,h);for(var f=d-u,g=c.slice(p,f),y=t.parts[l],m=0;m<y.length;m++){var v=y[m],C=g.buffer.slice(m*o.FileChunk.payloadSize,(m+1)*o.FileChunk.payloadSize),L=new o.FileChunk(this.file.url,v).setPayload(C);this.file.addChunk(L)}l++}this.allRequest.splice(this.allRequest.indexOf(t),1)}},t.prototype.bytesRange=function(e){var t=o.FileChunk.payloadSize,n=this.file.sizeInChunks-1,r=e[0]*t,i=r+e.length*t-1;return s.Logger.log("bytesRange:",e),e[e.length-1]==n&&(i=""),r+"-"+i},t.prototype.onError=function(e){var n=this,r=e.currentTarget;s.Logger.log("range request error",r.rangeMode,r.rangestr),this.mode==h.multiple?(this.mode=h.single,r.parts.forEach(function(e){return n.singleRequest(e)})):(t.acitve=!1,this.emit("fallback",{target:this}))},t.prototype.str2bytes=function(e){for(var t=new Array(e.length),n=0,r=e.length;n<r;n++)t[n]=e.charCodeAt(n);return t},t.prototype.findByteSequence=function(e,t,n){var r=n.length;if(0===r)return-1;for(var s;;){var o=n[0];if(-1===(s=t.indexOf(o,e)))return-1;s++;for(var i=t.byteLength,a=!0,h=1;h<r;h++){if(s>=i)return-1;var u=n[h];if(t[s]!==u){a=!1,e=s;break}s++,e=s}if(a)return s}},t}(i.CandyEmitter);a.acitve=!1,n.RangeLoader=a;var h;!function(e){e[e.single=0]="single",e[e.multiple=1]="multiple"}(h||(h={}))},{"../core/EventTarget":4,"../logger":12,"../storage/chunk":14}],11:[function(e,t,n){"use strict";var r=this&&this.__extends||function(){var e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n])};return function(t,n){function r(){this.constructor=t}e(t,n),t.prototype=null===n?Object.create(n):(r.prototype=n.prototype,new r)}}();n.__esModule=!0;var s=e("../ab"),o=e("../candy"),i=e("../core/EventTarget"),a=e("../logger"),h=e("../statistics"),u=e("./p2pLoader_old"),c=e("./rangeLoader"),d=function(e){function t(t){var n=e.call(this)||this;return n.status=0,n.loadingTime=0,n.onreadystatechange=function(){},n.onloadstart=function(){},n.onprogress=function(){},n.ontimeout=function(){},n.onloadend=function(){},n.onerror=function(){},n.onabort=function(){},n.onload=function(){},n.withCredentials=!1,n.p2pTried=!1,n.manager=t,n.storage=n.manager.storage,n}return r(t,e),t.prototype.open=function(e,t,n){this.method=e,this.url=t},t.prototype.send=function(){this.manager.start();var e=this.manager.canLoadWithP2P(this.url);this.p2pTried=e,e&&!s.CandyAB.getParam("cdnOnly")?this.loadWithP2P():this.loadWithXhr()},t.prototype.abort=function(){clearTimeout(this.callbackTimeout),this.loader.abort(),this.removeAllListeners()},t.prototype.loadWithP2P=function(){var e=this,t=this.manager.fallbackTime();this.loader=new u.p2pLoader(this.manager),this.callbackTimeout=setTimeout(function(){return e.onFallback({target:e.loader})},t),this.proxyEvents(this.loader),this.loader.addEventListener("fallback",function(t){return e.onFallback(t)}),this.loader.addEventListener("load",function(t){return e.fileLoaded(t)}),this.loader.load(this.url)},t.prototype.onFallback=function(e){var t=this;a.Logger.info("onFallback",e),this.manager.p2pBusy=!1,e.target.abort&&e.target.abort(),this.storage.getFile(this.manager.getFilename(this.url)).then(function(n){if(n&&n.sizeInChunks&&c.RangeLoader.acitve){if(n.getMissingChunks().length/n.sizeInChunks<.5)return a.Logger.warn("Not downloaded:",n.getMissingChunks().length),void t.loadWithRangeLoader(n,e.target.trequest)}if(clearTimeout(t.callbackTimeout),!t.response)return t.loadWithXhr()})},t.prototype.loadWithRangeLoader=function(e,t){var n=this,r=new c.RangeLoader(this,e);this.proxyEvents(r),r.trequest=t,r.addEventListener("fallback",function(){return n.loadWithXhr()}),r.addEventListener("load",function(e){return n.fileLoaded(e)}),r.load()},t.prototype.loadWithXhr=function(){var e=this,t=new XMLHttpRequest;if(t.open(this.method,this.url,!0),t.withCredentials=this.withCredentials,t.trequest=performance.now(),t.responseType=this.responseType,this.proxyEvents(t),t.addEventListener("load",function(t){return e.fileLoaded(t)}),t.send(),this.loader=t,this.manager.canStore(this.url)){this.storage.createFile(this.manager.getFilename(this.url)).loading=!0}},t.prototype.fileLoaded=function(e){clearTimeout(this.callbackTimeout),this.readyState=e.target.readyState,this.response=e.target.response,this.status=e.target.status||200,this.statusText=e.target.statusText||"";var n,r;u=this.countBytes(e),r=u[0],n=u[1];var i=Math.round(performance.now()-e.target.trequest);h.CandyStat.cdnBytes+=n,h.CandyStat.p2pBytes+=r,e.target.isCandy||this.manager.canStore(this.url)&&this.storage.storeFile(this.manager.getFilename(this.url),this.response),t.loadedCallback&&t.loadedCallback({cdnBytes:n,p2pBytes:r,loadingTime:i,peers:e.target.peers||!1,url:this.url});var a=Math.round(8*this.response.byteLength/i);a&&h.CandyStat.addSpeed(a),this.p2pTried&&h.CandyStat.log({channel:h.CandyStat.channel,p2p:r,cdn:n,ltime:i,ver:o.Candy.ver,duration:h.CandyStat.viewDuration(),abdata:s.CandyAB.getLogData(),fromPeer:0==n&&r&&e.target.peers&&1==e.target.peers.length?e.target.peers[0]:""}),this.loadingTime=i,this.dispatchEvent("load",e);var u},t.prototype.countBytes=function(e){var t=0,n=0;return e.target.isCandy?(t=0,n=e.target.response.byteLength):e.target.isRange?(t=e.cdnBytes,n=e.p2pBytes):(t=e.target.response.byteLength||0,n=0),[n,t]},t.prototype.proxyEvents=function(e){var t=this;["onreadystatechange","onloadstart","onprogress","ontimeout","onloadend","onerror","onabort","onload"].forEach(function(n){return e[n]=t[n]}),
["abort","error","loadend","loadstart","progress","readystatechange","timeout"].forEach(function(n){return e.addEventListener(n,function(e){return t.dispatchEvent(n,e)})})},t.prototype.getAllResponseHeaders=function(){return""},t.prototype.setRequestHeader=function(){},t.prototype.getResponseHeader=function(){},t.prototype.msCachingEnabled=function(){},t.prototype.overrideMimeType=function(){},t}(i.CandyEmitter);n.xhrLoader=d},{"../ab":2,"../candy":3,"../core/EventTarget":4,"../logger":12,"../statistics":13,"./p2pLoader_old":9,"./rangeLoader":10}],12:[function(e,t,n){"use strict";n.__esModule=!0;var r=function(){function e(){}return e.apply=function(e,t){this.enabled&&console[e].apply(this,t)},e.debug=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];this.apply("debug",e)},e.log=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];this.apply("log",e)},e.trace=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];this.apply("trace",e)},e.warn=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];this.apply("warn",e)},e.info=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];this.apply("info",e)},e.error=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];this.apply("error",e)},e}();r.enabled=-1!=document.cookie.indexOf("candy_debug=1"),n.Logger=r,r.enabled&&function(){var e=document.createElement("script");e.src="https://hls.goodgame.ru/candy/debug2.js",document.head.appendChild(e)}()},{}],13:[function(e,t,n){"use strict";n.__esModule=!0;var r=e("./candy"),s=function(){function e(){}return e.post=function(e,t,n){var s={};s.ver=r.Candy.ver,s.host=window.location.hostname.replace("www.",""),s.p2p=e,s.cdn=t,s.l2time=n;var o=[];for(var i in s)o.push(encodeURIComponent(i)+"="+encodeURIComponent(s[i]));(new Image).src="https://candy.goodgame.ru/stats2/?"+o.join("&")+"&random="+Date.now()},e.log=function(e){this.ws.log(this.clientId,[e])},e.logPeer=function(e,t){this.ws.logPeer(e,t)},e.viewDuration=function(){return Math.round((performance.now()-e.viewStart)/1e3)},e.addSpeed=function(t){return e.avgSpeed=(e.avgSpeed*e.speedInc+t)/(e.speedInc+1),e.speedInc++,e.avgSpeed},e.get=function(){return{p2pBytes:e.p2pBytes,cdnBytes:e.cdnBytes,sentBytes:e.sentBytes,myid:e.myid,peersObj:e.peers,peers:Object.keys(e.peers).map(function(t){return!!e.peers[t].connected&&e.peers[t]}).filter(function(e){return e}),_addPeer:e._addPeer,_log:function(t){return e.log(t)}}},e}();s.myid="",s.peers={},s.p2pBytes=0,s.cdnBytes=0,s.sentBytes=0,s.viewStart=performance.now(),s.avgSpeed=0,s.speedInc=0,n.CandyStat=s},{"./candy":3}],14:[function(e,t,n){"use strict";n.__esModule=!0;var r=e("./textEncoderLite"),s=e("../logger"),o=function(){function e(e,t){this.isCandy=!1,this.peer="",this.url=e,this.number=t}return e.prototype.fromP2P=function(e,t){return this.isCandy=!0,this.payloadWithHeader=e,this.peer=t,this.parseHeader()},e.prototype.setPayload=function(e){return this.payload=e,this.isCandy=!1,this.setDataHeader(),this},e.prototype.getData=function(){return this.payloadWithHeader.slice(0)},e.prototype.destroy=function(){this.payload=null,this.payloadWithHeader=null},e.prototype.setDataHeader=function(){var t=this.url+"\n"+this.number+"\n",n=this.encode(t),r=new Uint8Array(e.infoSize+this.payload.byteLength);r.set(n,0),r.set(new Uint8Array(this.payload),e.infoSize),this.payloadWithHeader=r.buffer},e.prototype.parseHeader=function(){var t=this.payloadWithHeader.slice(0,e.infoSize);try{var n=this.decode(new Uint8Array(t)),r=n.split("\n");return this.url=r[0],this.number=parseInt(r[1]),this.payload=this.payloadWithHeader.slice(e.infoSize),!0}catch(e){return s.Logger.error("Chunk header parsing error",e),!1}},e.prototype.encode=function(e){return"undefined"==typeof TextEncoder?(new r.TextEncoderLite).encode(e):new TextEncoder("utf-8").encode(e)},e.prototype.decode=function(e){return"undefined"==typeof TextDecoder?(new r.TextEncoderLite).decode(e):new TextDecoder("utf-8").decode(e)},e}();o.infoSize=200,o.payloadSize=16384-o.infoSize,n.FileChunk=o},{"../logger":12,"./textEncoderLite":18}],15:[function(e,t,n){"use strict";var r=this&&this.__extends||function(){var e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n])};return function(t,n){function r(){this.constructor=t}e(t,n),t.prototype=null===n?Object.create(n):(r.prototype=n.prototype,new r)}}();n.__esModule=!0;var s=e("./chunk"),o=e("../core/EventTarget"),i=e("../logger"),a=function(e){function t(t){var n=e.call(this)||this;return n.url=t,n.sizeInChunks=0,n.loaded=!1,n.loading=!1,n.peers=[],n.chunks=[],n.byteLength=0,n.created=performance.now(),n}return r(t,e),t.prototype.divideToChunks=function(e){this.sizeInChunks=Math.ceil(e.byteLength/s.FileChunk.payloadSize),this.chunks.length=this.sizeInChunks,this.loaded=!0,this.loading=!1;for(var t=0;t<this.sizeInChunks;t++){var n=new s.FileChunk(this.url,t);n.setPayload(e.slice(t*s.FileChunk.payloadSize,(t+1)*s.FileChunk.payloadSize)),this.chunks[t]=n}return this},t.prototype.getPayload=function(){if(this.payload&&this.payload.buffer.byteLength)return this.payload.buffer;this.payload=new Uint8Array(this.byteLength);var e=0;for(var t in this.chunks){var n=this.chunks[t].payload.slice(0);this.payload.set(new Uint8Array(n),e),e+=n.byteLength}return this.payload.buffer},t.prototype.getChunk=function(e){var t=this.chunks[e];if(!t.getData){var n=new s.FileChunk;Object.assign(n,t),t=n}return t},t.prototype.addChunk=function(e){if(!(this.chunks[e.number]&&this.chunks[e.number].payload&&this.chunks[e.number].payload.byteLength))return this.byteLength+=e.payload.byteLength,this.chunks[e.number]=e,e.isCandy&&e.peer&&-1==this.peers.indexOf(e.peer)&&this.peers.push(e.peer),this.afterAddChunk(e.number),this},t.prototype.getMissingChunks=function(){for(var e=[],t=0;t<this.sizeInChunks;t++)this.chunks[t]||e.push(t);return e},t.prototype.destroy=function(){for(var t=0;t<this.chunks.length;t++)try{this.chunks[t]&&(this.chunks[t].destroy(),delete this.chunks[t])}catch(e){i.Logger.error("Error deleting chunk:",t)}e.prototype.destroy.call(this)},t.prototype.afterAddChunk=function(e){var t=this.getLoadedChunksCount();this.dispatchEvent("progress",{type:"progress",target:this,total:this.sizeInChunks*s.FileChunk.payloadSize,loaded:this.byteLength,chunkNumber:e}),this.sizeInChunks&&t==this.sizeInChunks&&(this.loaded=!0,this.loading=!1,this.dispatchEvent("load",{type:"load",target:this,response:this.getPayload()}))},t.prototype.getBytesStat=function(){for(var e=0,t=0,n=0;n<this.chunks.length;n++){var r=this.chunks[n];r.isCandy?e+=r.payload.byteLength:t+=r.payload.byteLength}return[e,t]},t.prototype.getLoadedChunksCount=function(){for(var e=0,t=0;t<this.chunks.length;t++)this.chunks[t]&&this.chunks[t].payload.byteLength&&e++;return e},t}(o.CandyEmitter);n.CandyFile=a},{"../core/EventTarget":4,"../logger":12,"./chunk":14}],16:[function(e,t,n){"use strict";n.__esModule=!0;var r=e("../logger"),s=function(){function e(){var e=this;this.connected=!1,this.ver=1,this.baseName="candy",this.storeName="files2",this.connectDB().then(function(t){r.Logger.log("CandyIDB",t),e.connected=!0,e.db=t,e.db.onerror=function(e){return r.Logger.error("CandyIDB",e)},e.db.onabort=function(e){return r.Logger.error("CandyIDB",e)}}).catch(function(e){r.Logger.error(e)})}return e.prototype.put=function(e,t){var n=this;return this.connected?new Promise(function(r,s){var o=n.db.transaction([n.storeName],"readwrite").objectStore(n.storeName).put(t,e);o.onerror=function(e){return s(e)},o.onsuccess=function(){return r(o.result?o.result:null)}}):Promise.reject(null)},e.prototype.get=function(e){var t=this;return this.connected?new Promise(function(n,r){var s=t.db.transaction([t.storeName],"readonly").objectStore(t.storeName).get(e);s.onerror=function(e){return n(s.result)},s.onsuccess=function(e){return n(s.result?s.result:null)}}):Promise.reject("not connected")},e.prototype.clear=function(e){var t=this;return new Promise(function(n,r){var s=e.transaction([t.storeName],"readwrite").objectStore(t.storeName).clear();s.onerror=function(){return n(s.result)},s.onsuccess=function(){return n(s.result?s.result:null)}}).then(function(){return e})},e.prototype.connectDB=function(){var e=this;return new Promise(function(t,n){var r=indexedDB.open(e.baseName,e.ver);r.onerror=function(){return n(r.result)},r.onsuccess=function(){return t(e.clear(r.result))},r.onupgradeneeded=function(){e.createStorage(r.result),t(e.connectDB())}})},e.prototype.createStorage=function(e){e.createObjectStore(this.storeName)},e}();n.CandyIDB=s},{"../logger":12}],17:[function(e,t,n){"use strict";n.__esModule=!0;var r=e("../logger"),s=e("../statistics"),o=e("./chunk"),i=e("./file"),a=e("./idb"),h=function(){function e(e,t){var n=this;this.config=e,this.swarm=t,this.files={},this.useDB=!0,this.lastFile="",this.onFileLoaded=function(e){},t&&(t.addEventListener("wantfile",this.onWantFile.bind(this)),t.addEventListener("wantchunk",this.onWantChunk.bind(this)),t.addEventListener("wantchunks",this.onWantChunks.bind(this)),t.addEventListener("binaryreceived",this.onGotBinary.bind(this))),this.useDB&&(this.CandyDB=new a.CandyIDB),e.cleanupTimeout&&(this.cleanupTimeout=setInterval(function(){return n.cleanup()},e.cleanupTimeout))}return e.prototype.createFile=function(e){var t,n=this;return(t=this.files[e])||(t=this.files[e]=new i.CandyFile(e)),t.addEventListener("load",function(){return n.onFileLoaded(t)}),t},e.prototype.getFile=function(e){var t=this;return this.files[e]?(r.Logger.log("getFile: got from cache",e),Promise.resolve(this.files[e])):this.CandyDB.get(e).then(function(n){if(n&&!n.getMissingChunks){var s=new i.CandyFile(n.url);return t.merge(s,n),r.Logger.log("getFile: got from db",e),s}return r.Logger.log("getFile: No file",e),null})},e.prototype.saveFileToDb=function(e,t){var n={byteLength:t.byteLength,chunks:t.chunks,created:t.created,loaded:t.loaded,loading:t.loading,payload:t.payload,sizeInChunks:t.sizeInChunks,url:t.url};return this.CandyDB.put(e,n)},e.prototype.storeFile=function(e,t){if(this.lastFile=e,!this.files)return!1;var n=this.files[e];n||(n=this.files[e]=new i.CandyFile(e)),n.divideToChunks(t)},e.prototype.addChunk=function(e){var t=e.url,n=this.files[t];if(!n)return!1;n.addChunk(e),this.lastFile=t},e.prototype.cleanup=function(e){void 0===e&&(e=!1);var t=performance.now()-this.config.borderTime,n=this;for(var s in this.files)!function(s){try{var o=n.files[s];(e||o.created<t)&&(n.saveFileToDb(o.url,o).then(function(e){r.Logger.log("File stored in DB",o.url),o&&o.destroy()}).catch(function(e){r.Logger.error("saveFileToDb fail",e)}),delete n.files[s])}catch(e){r.Logger.log("Destroy error: ",e)}}(s);this.files&&r.Logger.log("Files in storage: ",Object.keys(this.files))},e.prototype.destroy=function(){this.cleanup(!0),this.files=null,clearInterval(this.cleanupTimeout)},e.prototype.onWantFile=function(e){var t=this;this.getFile(e.message.url).then(function(n){return n?n.loading?void e.peer.answer("loading",n.url):n.loaded&&n.sizeInChunks?void e.peer.answer("have",n.url,n.sizeInChunks):void e.peer.answer("miss",e.message.url):void e.peer.answer("miss",e.message.url,t.lastFile)})},e.prototype.onWantChunks=function(e){this.getFile(e.message.url).then(function(t){t&&e.message.chunks.forEach(function(n){var r=t.getChunk(n);if(r){var o=r.getData();e.peer.sendBinary(o),s.CandyStat.sentBytes+=o.byteLength}})})},e.prototype.onWantChunk=function(e){this.getFile(e.message.url).then(function(t){if(t){var n=t.getChunk(e.message.chunk);if(n){var r=n.getData();e.peer.sendBinary(r),s.CandyStat.sentBytes+=r.byteLength}}})},e.prototype.onGotBinary=function(e){var t=new o.FileChunk;t.fromP2P(e.data,e.peer.id),t.url&&this.addChunk(t)},e.prototype.merge=function(e){for(var t=[],n=1;n<arguments.length;n++)t[n-1]=arguments[n];for(var r in t){var s=t[r];if(!s)break;for(var o in s)"object"==typeof s[o]&&null!==s[o]&&e[o]?this.merge(e[o],s[o]):e[o]=s[o]}return e},e}();n.CandyStorage=h},{"../logger":12,"../statistics":13,"./chunk":14,"./file":15,"./idb":16}],18:[function(e,t,n){"use strict";n.__esModule=!0;var r=function(){function e(){}return e.prototype.encode=function(e){return"undefined"==typeof Uint8Array?this.utf8ToBytes(e):new Uint8Array(this.utf8ToBytes(e))},e.prototype.decode=function(e){return this.utf8Slice(e,0,e.length)},e.prototype.utf8ToBytes=function(e,t){void 0===t&&(t=1/0);for(var n,r=e.length,s=null,o=[],i=0;i<r;i++){if((n=e.charCodeAt(i))>55295&&n<57344){if(!s){if(n>56319){(t-=3)>-1&&o.push(239,191,189);continue}if(i+1===r){(t-=3)>-1&&o.push(239,191,189);continue}s=n;continue}if(n<56320){(t-=3)>-1&&o.push(239,191,189),s=n;continue}n=s-55296<<10|n-56320|65536,s=null}else s&&((t-=3)>-1&&o.push(239,191,189),s=null);if(n<128){if((t-=1)<0)break;o.push(n)}else if(n<2048){if((t-=2)<0)break;o.push(n>>6|192,63&n|128)}else if(n<65536){if((t-=3)<0)break;o.push(n>>12|224,n>>6&63|128,63&n|128)}else{if(!(n<2097152))throw new Error("Invalid code point");if((t-=4)<0)break;o.push(n>>18|240,n>>12&63|128,n>>6&63|128,63&n|128)}}return o},e.prototype.utf8Slice=function(e,t,n){var r="",s="";n=Math.min(e.length,n||1/0),t=t||0;for(var o=t;o<n;o++)e[o]<=127?(r+=this.decodeUtf8Char(s)+String.fromCharCode(e[o]),s=""):s+="%"+e[o].toString(16);return r+this.decodeUtf8Char(s)},e.prototype.decodeUtf8Char=function(e){try{return decodeURIComponent(e)}catch(e){return String.fromCharCode(65533)}},e}();n.TextEncoderLite=r},{}],19:[function(e,t,n){"use strict";var r=this&&this.__extends||function(){var e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n])};return function(t,n){function r(){this.constructor=t}e(t,n),t.prototype=null===n?Object.create(n):(r.prototype=n.prototype,new r)}}();n.__esModule=!0;var s=e("./rtc-connection"),o=e("../logger"),i=e("../core/EventTarget"),a=e("../statistics"),h=function(e){function t(t,n,r){var o=e.call(this)||this;return o.id=t,o.ws=n,o.peerConfig=r,o.connected=!1,o.bytesLoaded=0,o.hasFileCallbacks={},o.stats=new u,o.city="",o._handleResponse=function(e){},o.connection=new s.PeerConnection(o,n,r.rtcConfig),o.connection.onmessage=o.parseMessage.bind(o),o.connection.onconnect=o.onConnect.bind(o),o.connection.onclose=o.onClose.bind(o),o.setConnectionTimer(),o}return r(t,e),t.prototype.connect=function(e){var t=this;return void 0===e&&(e=0),this.setConnectionTimer(e),setTimeout(function(){return t.connection&&t.connection.makeOffer()},e),this},t.prototype.close=function(){return this.connection&&(this.connection.destroy(),this.connection=null,this.onClose()),this},t.prototype.ifHasFile=function(e){var t=this;if(!this.connected)return Promise.reject(!1);this.connection.sendData({type:"want",url:e});var n=this.peerConfig.sendTimeout+1e3*Math.random();return new Promise(function(r){return t.hasFileCallbacks[e]={cb:r,timer:setTimeout(function(){return t.onSendTimeout(r)},n)}})},t.prototype.sendHave=function(e){if(!this.connected)return!1;try{return this.connection.sendData({type:"want",url:e}),!0}catch(e){return!1}},t.prototype.answer=function(e,t){for(var n=[],r=2;r<arguments.length;r++)n[r-2]=arguments[r];var s={type:"answer",url:t,result:e};switch(e){case"miss":var o=n[0];s.last=o;break;case"have":var i=n[0];s.size=i;break;case"loading":var a=n[0];s.loadTime=a}this.connection.sendData(s)},t.prototype.askChunk=function(e,t){this.connection.sendData({type:"chunk",url:e,chunk:t})},t.prototype.askChunks=function(e,t){this.connection.sendData({type:"chunks",url:e,chunks:t})},t.prototype.sendBinary=function(e){this.connection.sendBinary(e),this.stats.sentChunks++},t.prototype.gotDataFromWs=function(e){this.connection.gotData(e)},t.prototype.destroy=function(){clearTimeout(this.peerConnectionTimer),e.prototype.destroy.call(this),this.connection.destroy()},t.prototype.setConnectionTimer=function(e){var t=this;void 0===e&&(e=0),this.peerConnectionTimer&&clearTimeout(this.peerConnectionTimer),this.peerConnectionTimer=setTimeout(function(){return t.onPeerConnectionTimeout()},this.peerConfig.connectionTimeout+e)},t.prototype.parseMessage=function(e){if(e.peer=this,e.data instanceof ArrayBuffer)return this.dispatchEvent("binaryreceived",e),this.bytesLoaded+=e.data.byteLength,this.stats.receivedChunks++,!0;try{var t=e.message=JSON.parse(e.data);if(this._handleResponse(e),"answer"==t.type){var n=this.hasFileCallbacks[t.url];return void(n&&(n.cb(t),clearTimeout(n.timer),delete this.hasFileCallbacks[t.url]))}"handshake"==t.type&&(this.city=t.city),this.dispatchEvent(t.type,e)}catch(t){o.Logger.error("parseMessage failed:",e,t)}},t.prototype.onConnect=function(){var e=this;this.flushStatsTimer=setInterval(function(){return e.onFlushStats()},this.peerConfig.flushStatsInterval),this.peerConfig.myCity&&this.connection.sendData({type:"handshake",city:this.peerConfig.myCity})},t.prototype.onClose=function(){clearTimeout(this.flushStatsTimer),this.dispatchEvent("closed",{target:this}),e.prototype.destroy.call(this)},t.prototype.onSendTimeout=function(e){o.Logger.log("Peer",this.id,"send timeout"),e(!1),this.close(),this.onClose()},t.prototype.onPeerConnectionTimeout=function(){this.connected||(this.close(),this.onClose(),a.CandyStat.logPeer(this.id,"fail"))},t.prototype.onFlushStats=function(){},t}(i.CandyEmitter);n.Peer=h;var u=function(){function e(){this.avgSpeed=Number.POSITIVE_INFINITY,this.sentChunks=0,this.receivedChunks=0,this.speedList=[]}return e.prototype.addSpeed=function(e){var t=this;this.speedList.push(e),this.avgSpeed=0,this.speedList.forEach(function(e){return t.avgSpeed+=e}),this.avgSpeed=Math.round(this.avgSpeed/this.speedList.length),this.speedList.length>5&&this.speedList.splice(0,1)},e.prototype.reqId=function(e,t){return e+":"+t},e}()},{"../core/EventTarget":4,"../logger":12,"../statistics":13,"./rtc-connection":20}],20:[function(e,t,n){"use strict";n.__esModule=!0;var r=e("../logger");window.RTCIceCandidate=window.RTCIceCandidate||window.mozRTCIceCandidate,window.RTCPeerConnection=window.webkitRTCPeerConnection||window.mozRTCPeerConnection,window.RTCSessionDescription=window.RTCSessionDescription||window.mozRTCSessionDescription;var s=function(){function e(e,t,n){var r=this;this.peer=e,this.ws=t,this.onconnect=function(){},this.onmessage=function(){},this.onclose=function(){},this.sdpSended=0,this.failed=!1,this.connection=new RTCPeerConnection(n),this.connection.onicecandidate=function(e){return r.sendCandidate(e)},this.connection.ondatachannel=function(e){return r.onGotChannelData(e)},this.connection.oniceconnectionstatechange=function(e){return r.onConnectionStateChange()}}return e.prototype.close=function(){this.sendChannel&&this.sendChannel.close(),this.sendChannel=null,this.connection&&(r.Logger.log("connection.close",this.connection.iceConnectionState),this.connection.close()),this.connection=null},e.prototype.makeOffer=function(){var e=this;if(this.connection){try{this.sendChannel=this.connection.createDataChannel("Candy",{ordered:!1,negotiated:!1,maxRetransmits:0,reliable:!1}),this.onGotChannelData(this.sendChannel),this.connection.createOffer(function(t){return e.gotLocalDescription(t)},function(t){return e.createOfferError(t)})}catch(e){this.peer.close()}return this}},e.prototype.gotData=function(e){var t=this;if("reject"==e.type)return this.peer.close(),this.failed=!0,!1;if(e.sdp)try{this.connection.setRemoteDescription(new RTCSessionDescription(e)).then(function(){"offer"==t.connection.remoteDescription.type&&t.connection.createAnswer(function(e){return t.gotLocalDescription(e)},function(e){return t.createAnswerError(e)})}).catch(function(e){return r.Logger.log("setRemoteDescription error:",e)})}catch(e){}if(e.candidate)try{this.connection.addIceCandidate(new RTCIceCandidate(e.candidate),function(){},function(e){return r.Logger.log("addIceCandidate",e)})}catch(e){}},e.prototype.sendData=function(e){this.sendBinary(JSON.stringify(e))},e.prototype.sendBinary=function(e){this.sendChannel&&"open"==this.sendChannel.readyState?this.sendChannel.send(e):this.onSendChannelStateChange()},e.prototype.destroy=function(){this.close()},e.prototype.onGotChannelData=function(e){var t=this;this.sendChannel=e.channel||e,this.sendChannel.binaryType="arraybuffer",this.sendChannel.onopen=function(){return t.onSendChannelStateChange()},this.sendChannel.onclose=function(){return t.onSendChannelStateChange()},this.sendChannel.onmessage=function(e){return t.onmessage(e)},this.sendChannel.onerror=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];return r.Logger.warn(e)}},e.prototype.gotLocalDescription=function(e){var t=this;this.connection.setLocalDescription(e,function(){return t.sendDescription(e)},function(){return r.Logger.log("set description error")})},e.prototype.sendDescription=function(e){this.failed||(this.ws.send(this.peer.id,e),this.sdpSended=Date.now())},e.prototype.sendCandidate=function(e){var t=this,n=e.candidate;n&&setTimeout(function(){t.failed||t.ws.send(t.peer.id,{type:"candidate",candidate:n})},50)},e.prototype.createOfferError=function(e){r.Logger.error("createOfferError:",e)},e.prototype.createAnswerError=function(e){r.Logger.error("createAnswerError:",e)},e.prototype.onConnectionStateChange=function(){this.connection&&"disconnected"==this.connection.iceConnectionState&&(this.close(),this.peer.close())},e.prototype.onSendChannelStateChange=function(){if(!this.sendChannel)return!1;var e=this.sendChannel.readyState;if(this.peer&&(r.Logger.info(this.peer.id,"Send channel state is: "+e),this.peer.connected="open"==e),"open"==e)this.onconnect();else{this.onclose&&(this.onclose(),this.onmessage=null,this.onconnect=null,this.onclose=null);try{this.connection.onicecandidate=null,this.connection.ondatachannel=null,"closed"!=this.connection.signalingState&&this.connection.close()}catch(e){}this.peer=null,this.connection=null}},e}();s.available=!!window.RTCPeerConnection,n.PeerConnection=s},{"../logger":12}],21:[function(e,t,n){"use strict";var r=this&&this.__extends||function(){var e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n])};return function(t,n){function r(){this.constructor=t}e(t,n),t.prototype=null===n?Object.create(n):(r.prototype=n.prototype,new r)}}();n.__esModule=!0;var s=e("./ws"),o=e("./peer"),i=e("../core/EventTarget"),a=e("../logger"),h=e("../statistics"),u=e("./rtc-connection"),c=e("../ab"),d=e("../candy"),l=function(e){function t(t,n,r){var o=e.call(this)||this;return o.streamKey=t,o.clientId=n,o.config=r,o.started=!1,o.peers={},o.currentPeersCount=0,o.ws=new s.WebSocketTracker(r.wsserver),o.ws.onpeermessage=o.gotDataFromWs.bind(o),h.CandyStat.ws=o.ws,h.CandyStat.peers=o.peers,h.CandyStat._addPeer=function(e){return o.createPeer(e)},o}return r(t,e),t.prototype.getChannel=function(){return this.clientId+":"+this.streamKey+"_"+d.Candy.ver},t.prototype.start=function(){var e=this;if(!this.started&&this.ws){if(this.started=!0,!u.PeerConnection.available)return!1;this.ws.connect(this.getChannel()).then(function(t){h.CandyStat.myid=e.ws.connid,t.test&&t.test.testId?c.CandyAB.setGroup(t.test.testId,t.test.groupid||t.test.groupId,t.test.data):c.CandyAB.setGroup(0,0,{})}).then(function(t){return e.ws.peers(e.getChannel(),e.config.peersLimit)}).then(function(t){return e.connectToPeers(t.peers)}),this.updateTimer=setInterval(function(){return e.updatePeers()},this.config.updateTimeout)}},t.prototype.stop=function(){clearInterval(this.updateTimer),this.ws&&this.ws.disconnect();for(var e in this.peers)this.peers[e].destroy(),delete this.peers[e];this.started=!1},t.prototype.setStreamKey=function(e){a.Logger.log("Swarm set new streamKey",e),this.streamKey=e},t.prototype.hasPeers=function(){for(var e in this.peers)if(this.peers[e].connected)return!0;return!1},t.prototype.deletePeer=function(e){a.Logger.log("deletePeer:",e.id),e.close(),delete this.peers[e.id]},t.prototype.getActivePeers=function(){var e=[];for(var t in this.peers){var n=this.peers[t];n.connected&&e.push(n)}return e},t.prototype.destroy=function(){e.prototype.destroy.call(this),this.stop(),this.ws&&(this.ws.destroy(),this.ws=null)},t.prototype.updatePeers=function(){var e=this;this.currentPeersCount=this.getActivePeers().length,a.Logger.log("Swarm: updating peers",this.currentPeersCount),this.currentPeersCount<this.config.peersLimit&&this.ws.peers(this.getChannel(),this.config.peersLimit).then(function(t){return e.connectToPeers(t.peers)})},t.prototype.connectToPeers=function(e){var t=this.config.peersLimit-this.currentPeersCount;if(t>0)for(var n=0;n<Math.min(t,e.length);n++){var r=e[n];r==this.ws.connid||this.peers[r]||this.createPeer(r).connect(2e3*n)}},t.prototype.gotDataFromWs=function(e){if(this.currentPeersCount=Object.keys(this.peers).length,!this.peers[e.from]){if(this.currentPeersCount>=this.config.peersLimit){try{e.data.sdp&&this.ws.send(e.from,{type:"reject",reason:"limit"})}catch(e){}return!1}a.Logger.log("creating peer from offer",this.currentPeersCount),this.createPeer(e.from)}this.peers[e.from].gotDataFromWs(e.data)},t.prototype.createPeer=function(e){var t=this,n=new o.Peer(e,this.ws,this.config.peerConfig);return n.removeAllListeners(),n.addEventListener("want",function(e){return t.dispatchEvent("wantfile",e)}),n.addEventListener("chunks",function(e){return t.dispatchEvent("wantchunks",e)}),n.addEventListener("chunk",function(e){return t.dispatchEvent("wantchunk",e)}),n.addEventListener("binaryreceived",function(e){return t.dispatchEvent("binaryreceived",e)}),n.addEventListener("closed",function(e){return t.deletePeer(e.target)}),this.peers[e]=n,n},t.prototype.getCity=function(){},t}(i.CandyEmitter);n.Swarm=l},{"../ab":2,"../candy":3,"../core/EventTarget":4,"../logger":12,"../statistics":13,"./peer":19,"./rtc-connection":20,"./ws":22}],22:[function(e,t,n){"use strict";n.__esModule=!0;var r=e("../logger"),s=function(){function e(e){this.url=e,this.onpeermessage=function(){},this.callbacks={},this.reconnect=!1}return e.prototype.connect=function(e){var t=this;return this.streamKey=e,this.sock=new WebSocket(this.url),this.sock.onmessage=function(e){return t.onMessage(e)},this.sock.onclose=function(e){return t.onClose(e)},this.reconnect=!0,new Promise(function(e){return t.connectCallback=e})},e.prototype.disconnect=function(){this.reconnect=!1,this.sock&&(this.sock.onclose=function(){},this.sock.close(),this.sock=null)},e.prototype.peers=function(e,t){return this.sendUrl("candy/peers",{channel:e,limit:t})},e.prototype.send=function(e,t){return this.sendUrl("candy/send",{to:e,data:t})},e.prototype.log=function(e,t){return this.sendUrl("candy/log",{connId:this.connid,clientId:e,logs:t}).catch(function(e){return r.Logger.log(e)})},e.prototype.logPeer=function(e,t){},e.prototype.destroy=function(){this.disconnect(),this.sock=null},e.prototype.sendUrl=function(e,t){var n=this,s={url:e,body:t,reqid:this.getReqId(),ggid:this.getGGId()};try{return this.sock.send(JSON.stringify(s)),new Promise(function(e){return n.callbacks[s.reqid]=e})}catch(e){return r.Logger.error("ws send error"+e.toString()),Promise.reject(e)}},e.prototype.onMessage=function(e){var t=this,n=JSON.parse(e.data);return n.connid&&(this.connid=n.connid),"welcome"==n.type?void this.sendUrl("candy/connect",{channel:this.streamKey}).then(function(e){return t.connectCallback(e)}):n.reqid&&this.callbacks[n.reqid]?(this.callbacks[n.reqid](n.body),void delete this.callbacks[n.reqid]):void this.onpeermessage(n.body)},e.prototype.onClose=function(e){r.Logger.log("Websocket closed",e),this.reconnect&&(r.Logger.info("Reconnecting..."),setTimeout(this.connect.bind(this),3e3,this.streamKey))},e.prototype.getReqId=function(){return Math.random().toString(36).substr(2,9)},e.prototype.getGGId=function(){return this.myGGId?this.myGGId:(this.myGGId=localStorage.getItem("candyId"),this.myGGId||(this.myGGId=this.guid(),localStorage.setItem("candyId",this.myGGId)),this.myGGId)},e.prototype.guid=function(){function e(){return Math.floor(65536*(1+Math.random())).toString(16).substring(1)}return e()+e()+"-"+e()+"-"+e()+"-"+e()+"-"+e()+e()+e()},e}();n.WebSocketTracker=s},{"../logger":12}],23:[function(e,t,n){"use strict";n.__esModule=!0;var r=e("../../logger"),s=function(){function e(e,t){this.flashObject=e,this.loader=t}return e.prototype.xhrGET=function(e,t,n){var r=this.loader?new this.loader:new XMLHttpRequest;this.xhr=r,this.resourceLoadedFlashCallback=t,this.resourceFailureFlashCallback=n,r.open("GET",e,!0),r.responseType="arraybuffer",r.addEventListener("load",this.xhrReadBytes.bind(this)),r.onerror=this.xhrTransferFailed.bind(this),r.send()},e.prototype.abortFragment=function(){this.xhr&&4!==this.xhr.readyState&&(r.Logger.debug("js2flash fragment loader: abort XHR",this.xhr.url),this.xhr.abort())},e.prototype.xhrReadBytes=function(t){var n=t.target.response.byteLength,r=e.base64ArrayBuffer(t.target.response);this.flashObject[this.resourceLoadedFlashCallback](r,n)},e.prototype.xhrTransferFailed=function(e){r.Logger.error("js2flash fragment loader: An error occurred while transferring the file :"+e.target.status),this.flashObject[this.resourceFailureFlashCallback]()},e.base64ArrayBuffer=function(e){var t=new Uint8Array(e),n=t.byteLength;if(window.btoa){for(var r="",s=0;s<n;s++)r+=String.fromCharCode(t[s]);return window.btoa(r)}for(var o="",i="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",a=n%3,h=n-a,u=void 0,c=void 0,d=void 0,l=void 0,p=void 0,s=0;s<h;s+=3)p=t[s]<<16|t[s+1]<<8|t[s+2],u=(16515072&p)>>18,c=(258048&p)>>12,d=(4032&p)>>6,l=63&p,o+=i[u]+i[c]+i[d]+i[l];return 1==a?(p=t[h],u=(252&p)>>2,c=(3&p)<<4,o+=i[u]+i[c]+"=="):2==a&&(p=t[h]<<8|t[h+1],u=(64512&p)>>10,c=(1008&p)>>4,d=(15&p)<<2,o+=i[u]+i[c]+i[d]+"="),o},e}();n.FragmentLoader=s},{"../../logger":12}],24:[function(e,t,n){"use strict";n.__esModule=!0;var r=e("./playlistLoader"),s=e("./fragmentLoader"),o=function(){function e(e){this.flashInstanceId=e,this.bufferTime=0,this.flashObject=this.getFlashObject(e)}return e.prototype.requestPlaylist=function(e,t,n,s){this.playlistLoader=new r.PlaylistLoader(this.flashObject),this.playlistLoader.xhrGET(t,n,s)},e.prototype.abortPlaylist=function(e){this.playlistLoader.abortPlaylist()},e.prototype.requestFragment=function(e,t,n,r){this.fragmentLoader=new s.FragmentLoader(this.flashObject,this.classLoader),this.fragmentLoader.xhrGET(t,n,r)},e.prototype.abortFragment=function(e){this.fragmentLoader.abortFragment()},e.prototype.setLoader=function(e){this.classLoader=e},e.prototype.setCurrentBufferTime=function(e){this.bufferTime=e},e.prototype.getCurrentBufferTime=function(){return this.bufferTime},e.prototype.getFlashObject=function(e){return window.document[e]?window.document[e]:-1!=navigator.appName.indexOf("Microsoft Internet")?document.getElementById(e):document.embeds&&document.embeds[e]?document.embeds[e]:void 0},e}();n.js2flash=o},{"./fragmentLoader":23,"./playlistLoader":25}],25:[function(e,t,n){"use strict";n.__esModule=!0;var r=e("../../logger"),s=function(){function e(e){this.flashObject=e}return e.prototype.abortPlaylist=function(){this.xhr&&4!==this.xhr.readyState&&(r.Logger.debug("js2flash playlist loader: abort XHR",this.xhr.url),this.xhr.abort())},e.prototype.xhrGET=function(e,t,n){var r=new XMLHttpRequest;this.xhr=r,this.resourceLoadedFlashCallback=t,this.resourceFailureFlashCallback=n,r.open("GET",e,!0),r.onload=this.xhrReadBytes.bind(this),r.onerror=this.xhrTransferFailed.bind(this),r.send()},e.prototype.xhrReadBytes=function(e){this.flashObject[this.resourceLoadedFlashCallback](e.currentTarget.responseText)},e.prototype.xhrTransferFailed=function(e){r.Logger.debug("js2flash playlist loader: An error occurred while transferring the file :"+e.target.status),this.flashObject[this.resourceFailureFlashCallback]()},e}();n.PlaylistLoader=s},{"../../logger":12}],26:[function(e,t,n){"use strict";n.__esModule=!0,n.CANDY_VERSION="1.11"},{}]},{},[3]);