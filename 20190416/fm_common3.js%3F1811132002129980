(function(){"use strict";$(function(){var $mainRadioController=$(".fm_announce"),$fmPlayerPage=$("#fm_player");if(!$mainRadioController.length&&!$fmPlayerPage.length)return;if(typeof localStorage!="object"||!localStorage)return;var isPlayerPage=$fmPlayerPage&&$fmPlayerPage.length&&$fmPlayerPage.length>0,windowUID=isPlayerPage?makeID():null,radioPlayerStatus=getLocalStorage("radioPlayerStatus"),radioActiveWindows=getLocalStorage("radioActiveWindows"),radioActiveWindowUID=getLocalStorage("radioActiveWindowUID");isPlayerPage&&$(".fm_player__main").length==0?$(document).on("isPlayerReady",function(event){event.detail&&event.detail=="true"&&init()}):init();function init(){if(!radioPlayerStatus||!radioActiveWindows||!isPlayerPage&&radioActiveWindows=="{}"){setLocalStorage({radioPlayerStatus:"pause",radioActiveWindowUID:"",radioActiveWindows:{},playerRewind:""})}checkOpenedPlayerWindows();isPlayerPage&&radioActiveWindowUID!=windowUID&&setLocalStorage("radioActiveWindowUID",windowUID);!isPlayerPage&&toggleRadioPlayPause(radioPlayerStatus);if(isPlayerPage){$(document).keyup(function(event){event.keyCode==32&&setAction("toggle",{})});$(document).on("userEvent",function(event){if(event.detail&&event.detail.data=="activateButtonClick")setLocalStorage("radioActiveWindowUID",windowUID)});$(window).on("unload",deleteWindowFromActive)}else{$($mainRadioController).on("click",function(){sendGA("event",{action:getLocalStorage("radioPlayerStatus")=="play"?"pause":"play",label:"widget"});getLocalStorage("playerAction")=="archive"?setAction("sync",{status:"play",rewind:null}):setAction("toggle",{})})}$(document).on("pplayerEvent",function(event){if(!event||!event.detail)return;var detail=event.detail;var playerAction=detail.action;var status=detail.playerStatus;switch(playerAction){case"toggle":setAction("toggle",{});break;case"sync":var rewind=detail.rewindTime||null;status&&setAction("sync",{status:status,rewind:rewind});break;case"archive":status&&setAction("archive",{status:status,rewind:null});break}});"addEventListener"in window?window.addEventListener("storage",storageEventHandler,false):document.attachEvent("onstorage",storageEventHandler);setInterval(checkOpenedPlayerWindows,3*60*1e3);sendRadioEvent({action:getLocalStorage("playerAction"),playerStatus:getLocalStorage("radioPlayerStatus"),rewind:getLocalStorage("playerRewind")})}function setAction(action,playerData){if(!action||!~["toggle","sync","archive"].indexOf(action))return false;if(!(getLocalStorage("radioActiveWindows")=="{}"&&isMobile())){playerSetter(action,playerData)}if(getLocalStorage("radioActiveWindows")!="{}")return false;window.open("/fm/player","_blank");checkOpenedPlayerWindows()}function playerSetter(action,playerData){var oldPlayerAction=getLocalStorage("playerAction");if(action=="toggle"&&oldPlayerAction!=="toggle"){setLocalStorage({playerAction:"toggle"});return}var oldRewindTime=getLocalStorage("playerRewind");var oldPlayerStatus=getLocalStorage("radioPlayerStatus");var rewindTime=playerData?playerData.rewind:"unknown";var playerStatus=playerData?playerData.status:null;if(action=="sync"||action=="archive"){setLocalStorage({playerAction:action,radioPlayerStatus:playerStatus||oldPlayerStatus,playerRewind:rewindTime=="unknown"?oldRewindTime:rewindTime})}}function toggleRadioPlayPause(status){if(isPlayerPage)return;var newStatus=status=="play"||status=="playing"?"playing":"paused";newStatus=="playing"?$mainRadioController.addClass("is_playing"):$mainRadioController.removeClass("is_playing")}function setLocalStorage(key,value){var currentRadioStorage=getLocalStorage(),oldRadioStorage=JSON.stringify(currentRadioStorage);if(typeof key=="object")for(var item in key)updateObject(item,key[item]);else updateObject(key,value);var newRadioStorage=JSON.stringify(currentRadioStorage);localStorage.setItem("radio",newRadioStorage);var event=document.createEvent("StorageEvent");event.initStorageEvent("storage",false,false,"radio",oldRadioStorage,newRadioStorage,location.href,localStorage);window.dispatchEvent(event);function updateObject(objKey,objValue){var currentValue=currentRadioStorage?currentRadioStorage[objKey]:null;if(typeof objValue=="undefined"||currentValue==objValue)return;try{if(!currentRadioStorage||typeof currentRadioStorage!=="object")currentRadioStorage={};currentRadioStorage[objKey]=objValue}catch(error){}}}function getLocalStorage(key){var currentRadioStorageObj,currentRadioStorage=localStorage.getItem("radio");try{currentRadioStorageObj=JSON.parse(currentRadioStorage);if(!currentRadioStorageObj)return null;if(!key)return currentRadioStorageObj;return currentRadioStorageObj[key]||null}catch(error){}return null}function storageEventHandler(event){if(event.key!=="radio")return;try{var oldRadioStorage=JSON.parse(event.oldValue);var newRadioStorage=JSON.parse(event.newValue);if(isPlayerPage&&oldRadioStorage.radioActiveWindowUID!==newRadioStorage.radioActiveWindowUID){switchTabStatus(newRadioStorage.radioActiveWindowUID!=windowUID?"inactive":"active");return}if(oldRadioStorage.playerAction!==newRadioStorage.playerAction&&newRadioStorage.playerAction=="toggle"){sendRadioEvent("action","toggle");return}if(newRadioStorage.playerAction=="sync"&&(oldRadioStorage.radioPlayerStatus!==newRadioStorage.radioPlayerStatus||oldRadioStorage.playerRewind!==newRadioStorage.playerRewind)||oldRadioStorage.playerAction!==newRadioStorage.playerAction&&newRadioStorage.playerAction=="sync"){toggleRadioPlayPause(newRadioStorage.radioPlayerStatus);sendRadioEvent({action:"sync",playerStatus:newRadioStorage.radioPlayerStatus,rewind:newRadioStorage.playerRewind});return}if(newRadioStorage.playerAction=="archive"){toggleRadioPlayPause("paused");sendRadioEvent({action:"archive",playerStatus:newRadioStorage.radioPlayerStatus})}}catch(error){}}function checkOpenedPlayerWindows(){var openedWindows={},activeWindows={},expireTime=new Date(Date.now()-5*60*1e3).getTime();try{openedWindows=JSON.parse(getLocalStorage("radioActiveWindows"))}catch(error){}for(var itemUID in openedWindows){var timer=openedWindows[itemUID];if(timer>expireTime)activeWindows[itemUID]=timer}if(isPlayerPage)activeWindows[windowUID]=Date.now();setLocalStorage("radioActiveWindows",JSON.stringify(activeWindows))}function deleteWindowFromActive(){var openedWindows={},openedWindowsJSON="{}";try{openedWindows=JSON.parse(getLocalStorage("radioActiveWindows"));delete openedWindows[windowUID]}catch(error){}openedWindowsJSON=JSON.stringify(openedWindows);setLocalStorage("radioActiveWindows",openedWindowsJSON);if(windowUID==getLocalStorage("radioActiveWindowUID")&&openedWindowsJSON!="{}")setLocalStorage("radioActiveWindowUID",Object.keys(openedWindows)[0]);if(openedWindowsJSON=="{}"){setLocalStorage("radioPlayerStatus","pause");setLocalStorage("radioActiveWindowUID","");setLocalStorage("playerRewind","")}}function switchTabStatus(status){sendRadioEvent("tabStatus",status)}function makeID(){var id="",idLength=5,possible="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789";for(var i=0;i<idLength;i++)id+=possible.charAt(Math.floor(Math.random()*possible.length));return id}function isMobile(){if(!navigator||!navigator.userAgent)return false;return/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)}function sendRadioEvent(eventType,event){var data={};if(typeof eventType=="string"){data[eventType]=event}else{data=eventType}var radioEvent=new CustomEvent("radioEvent",{detail:data});document.dispatchEvent(radioEvent)}function normalizeTime(time){if(!time||time=="0")return null;var strTime=time.toString();var normalizedTime=strTime.length>10?strTime.substr(0,10):time;return parseInt(normalizedTime)||null}function sendGA(type,obj){if(typeof ga!=="function"){return}switch(type){case"event":ga("send","event","new_fm",obj.action,obj.label);break;case"exception":ga("send","exception",obj.message,obj.isFatal);break}}})})();
