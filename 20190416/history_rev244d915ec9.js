define(["jquery","counters","factory","client-server","audio-player","base/view","util/promise","util/infinite-scroll","util/schedule","util/helpers","util/htmlescape","util/uri","util/find-event-target","util/hosts","util/date-time","util/lazy-background","app/history","app/banners","product-tools/comments","product-tools/likes","mimic/mimic","home/view-event","home/history/audio","home/history/events"],function(a,b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u,v,w,x){"use strict";function y(){c("product-tools/auth-form",function(a){a.show()})}function z(b){var c,d,e,f=b.find(".b-history_filter-text");f.each(function(){e=a(this),c=e.parent(),d=parseInt(c.css("margin-right"),10)||0,c.css({width:e.width()+d,margin:0})})}function A(b,c){var d=Number(b.maxFeedContextLength)||3072;ca&&(b.eventsTimer=setTimeout(function(){localStorage.lastHistoryViewTime=Math.round(Date.now()/1e3)},5e3)),b.feedContext?(b.feedContext=b.feedContext+(c.feedContext||""),b.feedContext.length>=d&&(b.feedContext=b.feedContext.slice(d))):b.feedContext=c.feedContext||"",delete c.feedContext,a.extend(b,{data:[],stopped:!1,lastId:null,lastTid:null,updateWaiting:!1,filter:"",isChronoHistory:null,eventsLimit:50},c||{})}function B(a,b){var c=a.elem,d="";a.hasEvents||0===Number(a.lastId)||(a.hasEvents=!0),"noevents"!==b||0!==Number(a.lastId)||a.hasEvents||(d="-noitems"),c.removeClass(c.attr("class").split(" ").filter(function(a){return/^b-history__/.test(a)}).join(" ")).addClass("b-history__"+b+d).attr("data-state",b)}function C(a){var b,c,d=a.find(".event_links_share-app-button"),e=/my.mail.ru\/apps\/\d+/,f=0;if(d.length)for(f;f<d.length;f++)b=d.eq(f),c=e.exec(decodeURIComponent(b.attr("href"))),c&&b.attr("href","//"+c[0]+"?ref=like").addClass("show")}function D(c,d){if(c.banner&&!c.banner.showOnes&&!c.banner.stopShow){var e=d.find(".b-history-event[data-id]"),f=c.banner.currentIndex||c.banner.start,g=c.banner.repeat,h=f,i=[],k=6443;if(g){for(;h<=e.length;)i.push(h),h+=g;c.banner.currentIndex=h-e.length}else i.push(f),c.banner.showOnes=!0;c.banner.slots||(c.banner.slots=[]),r.load({content:{q:k}},{count:i.length,exb:c.banner.slots.join(",")}).then(function(d){var f=a(d[0].html).filter(".rb-banner");f.find(".trg-b-banner,.rb-media-banner").each(function(b,d){c.banner.slots.push(a(d).data("id"))}),f.length?(i.forEach(function(a,b){var c=f[b];c&&e.eq(a-1).before(c)}),b.mygrst("monitoring3.show"+k+"slot")):c.banner.stopShow=!0}),c.mimic.isEnable&&setTimeout(function(){var b=!1,f=d.find(".rb-banner"),g=j.extend(!0,{},j.parseJsonFromSrc(a(".b-mimic-adv-config")),{id:c.mimic.id,limit:2,type:c.mimic.type,statId:c.mimic.statId,counter:c.mimic.counter,siteSection:"history",minHeight:25,timeout:0,rb:{originalSlot:c.mimic.rb.originalSlot}});f.each(function(c,d){d.clientHeight>20?b=!0:a(d).remove()}),0!==f.size()&&b||i.forEach(function(b){var c=a('<div class="b-history-event ui-simple-block"></div>');e.eq(b-1).before(c),u.createRunTime(g,c)})},c.mimic.timeout)}}function E(b,e,f){var g=[],h=3,i=e.find(".b-history-event"),j=10;i.each(function(c){var d=a("<div/>");(c+1)%j===b&&(a(this).before(d),g.push(d))}),d.func("app.genre_gender_age",{check_rl:1,limit:h*g.length,offset:3,shuffle:1},{success:function(a){var b,d;"string"==typeof a&&(a=JSON.parse(a)),d=a[3]&&a[3].data?a[3].data:[],d.length&&g.forEach(function(a,e){var g=(e+2)*h;b=d.splice(0,h),c("home/history/apps-best",function(a,b,c,d){var e,g=[];a.length&&(e=d.create().onLoad(c),e.collection.setResponse({data:a,offset:b}),e.collection.getItems().forEach(function(a,b,c){a.set("appUrl",a.getAppUrl("best_games")),g.push(a.toJSON())}.bind(this)),e.render({apps:g,locales:f||{}},function(a){a.appendTo(c),a.addClass("b-history__apps-best_showed")}))}.bind(this,b,g,a))})}})}function F(b,c,d){var e=a("<div />").html(c);return w.bind(e),C(e),d||(D(b,e),b.specialAdv&&b.specialAdv.isEnable&&j.isArray(b.advItems)&&b.advItems.length||b.showAdvPosts(e),b.appsBestPos=parseInt(b.appsBestPos,10),b.appsBestPos&&!b.filter&&ca&&E(b.appsBestPos,e,b.locales.apps)),e}function G(d,e,f,g){var h,i,k=d.eventsEl,l=a("#history_container"),m=a("#history_footer"),n=0!==l.children().size(),o=d.lastId;f?k.html(F(d,e)):g?k.prepend(F(d,e,g)):(k.append(F(d,e)),"login"===d.type&&"0"!==d.lastId&&b.myrb(6855985),"login"===d.type&&"0"===d.lastId&&c("jquery.jcarousel",function(){a(".b-history-event__mobile_app_promo").find(".jcarousel").jcarousel({animation:400,wrap:"circular"}).jcarouselAutoscroll({interval:3e3,target:"+=1",autostart:!0}).on("mouseover",function(){a(this).jcarouselAutoscroll("stop")}).on("mouseout",function(){a(this).jcarouselAutoscroll("start")}).end().find(".jcarousel-prev").jcarouselControl({target:"-=1"}).end().find(".jcarousel-next").jcarouselControl({target:"+=1"}),b.myrb(7210456)}),d.specialAdv&&d.specialAdv.isEnable&&j.isArray(d.advItems)&&d.advItems.length&&d.showSpecialAdvPosts()),p.check(),h=k.find('[data-type="history-config"]'),h&&h.length?(i=JSON.parse(h.html()),h.remove()):i={},A(d,i),g&&(d.lastId=o),"fresh"===d.filter&&(d.filter=""),d.stopped!==!0||n||m.hide(),x.repaintPosts(d.elem),x.cutAppPosts(d.elem)}function H(a,b){var c=a.elem.find('[data-history-error-load="1"]'),d=c.find('[data-history-error-load="timeout"]'),e=Number(d.html());e>0?(d.html(--e),a.reloadTimer=setTimeout(function(){H(a,b)},1e3)):b()}function I(a,b){var c=a.elem.find('[data-history-error-load="1"]'),d=c.find('[data-history-error-load="timeout"]'),e=a.elem.find('[data-history="footer"]');c.addClass("show"),e.addClass("hide"),d.html(16),H(a,function(){c.removeClass("show"),e.removeClass("hide"),N(a,b)})}function J(b){var c=b.elem,d=b.faderEl,e=b.eventsEl,f=a("#LeftColumn"),g="b-history_fade-events";d.height(Math.max(c.height(),f.height())).show(),e.addClass(g)}function K(a){var b=a.faderEl,c=a.eventsEl,d="b-history_fade-events";b.hide(),c.removeClass(d)}function L(a){"guestbook"===a.filter&&(K(a),B(a,"guestbook"),j.isObject(a.guestbook)||c("home/guestbook",function(b){a.guestbook=b.create().onLoad(a.elem)}))}function M(c,d){var e,f=l().param("filter");if(f&&0!==f&&q.page("/",q.SetHashModes.SUPPRESS_EVENT),a.isArray(d))e=d[2];else try{e=JSON.parse(d)[2]}catch(a){(new Image).src="//csp.my.mail.ru/jserr/history-error?message="+a.message+"&stack="+a.stack,(new Image).src="//my.mail.ru/grstat?name=monit-ring-history.json-error"}c.updateWaiting===!0&&(c.updateWaiting=!1,G(c,e,!1),b.myrb("714006")),c.stopped===!0?"guestbook"!==c.filter?(B(c,"noevents"),b.myrb("715129")):L(c):B(c,"loaded")}function N(c,e){var f=l().attr("query"),g="/ajax_history"+(""!==f?"?"+f:""),h=c.elem.find('[data-history="footer"]');"admin"===c.type?g="/ajax_history?active_email="+l().param("email")+"&x_swa_auth_digest="+c.swa.digest+"&x_swa_auth="+c.swa.auth+"&x_swa_rnd="+c.swa.rnd:"hashtag"===c.type?g="/ajax_history_tag":ca||(g=da+"ajax_history",c.type&&"community"!==c.type||b.myrb("715898")),c.show_holidaypromo_id&&c.show_holidaypromo_id.length>0&&(g+="?show_holidaypromo_id="+c.show_holidaypromo_id),h.removeClass("hide"),c.request=d.func("history.get",{limit:c.eventsLimit,feed_context:c.feedContext,smart_history:c.smartHistory||void 0,adapt_history:c.adaptHistory||void 0,from_page:c.type,filter:c.filter||"",chrono:c.isChronoHistory||void 0,start:c.lastId||"",lasttid:c.lastTid||"",hashtag:c.hashtag||""},a.extend({type:"POST",url:g,error:function(){I(c,e)}},e||{}))}function O(a){var b=a.elem.find('[data-history-error-load="1"]'),c=a.elem.find('[data-history="footer"]');b.removeClass("show"),c.removeClass("hide"),clearTimeout(a.reloadTimer),a.request&&a.request.abort(),B(a,"loading"),N(a,{success:function(b){M(a,b)}})}function P(a){var b=a.elem.find('[data-history-error-load="1"]'),c=a.elem.find('[data-history="footer"]');b.removeClass("show"),c.addClass("hide"),clearTimeout(a.reloadTimer),a.request&&a.request.abort()}function Q(a,b){a.updateWaiting=!0,a.request&&"pending"===a.request.state()||a.stopped||!a.lastId&&(a.lastId||"hashtag"!==a.type)||(B(a,"loading"),N(a,{success:function(c){a.updateWaiting===!0&&a.stopped===!1&&b.run(),a.stopped===!0&&b.stop(),M(a,c)}}))}function R(a,b){var c=a.elem,d=c.find(".b-filter-load-error__timeout"),e=Number(d.html());0===e?b():d.html(e-1)}function S(a,b){var c=a.elem,d=a.elem.find('[data-history="footer"]'),e=c.find(".b-filter-load-error__timeout"),f=c.find(".b-filter-load-error__reload"),g=c.find(".b-filter-load-error__cancel");c.addClass("filter-load-error"),e.html(15),a.timer&&a.timer.stop(),a.timer=new i(function(){R(a,function(){a.timer.stop(),T(a,b)})},1e3,!0),f.off("click").on("click",function(){a.timer.stop(),T(a,b)}),g.off("click").on("click",function(){a.timer.stop(),c.removeClass("filter-load-error"),K(a),d.removeClass("hide")})}function T(c,d){a(document).trigger("AudioPlayer.stop",{fragment:"history"}),c.getComments().destroyWriters();var e,f=c.elem,g=c.infScroll,h=c.elem.find('[data-history="footer"]'),i=f.find('[data-type="next-events"]');g.stop(),A(c,{filter:d}),J(c),h.addClass("hide"),B(c,"loading-filter"),f.removeClass("filter-load-error"),N(c,{success:function(j){var k;k=a.isArray(j)?j[2]:JSON.parse(j)[2],f.attr("filter",d),i.length&&(e=i.attr("href"),i.attr("href",e.replace(/\&filter=[^\&]*/,"&filter="+d))),G(c,k,!0),c.stopped?(g.stop(),b.myrb("715129"),"guestbook"!==c.filter?(K(c),h.removeClass("hide"),c.elem.removeClass("content-wrapper_noevents_groups"),B(c,"noevents"),c.elem.addClass("content-wrapper_noevents_"+d)):L(c)):(K(c),h.removeClass("hide"),g.run(),B(c,"loaded"))},error:function(){S(c,d)}})}function U(a){a.infScroll=h.create({marker:"#history_footer",interval:100,callback:function(a,b){a.stop(),Q(this,a,b)}.bind(a)})}function V(a){d.func("",{show_adapt_history:a},{url:"/+/user/current",type:"post"},null,null,null,!0)}function W(c,d){var e,f,g,h,i,j,k;e=m(d,".b-history_filter"),!e||e.hasClass("b-history_filter-more")||e.hasClass("b-history_filter-active")||(c.addonsEl.hide().removeClass("showed"),c.controlsEl.find(".b-history_filter").removeClass("b-history_filter-active"),e.addClass("b-history_filter-active"),f=e.attr("data-filter"),k=!!e.attr("data-adapt"),g=a(".b-history_filter_more"),h=a(".b-history_filter_more span"),i=e.attr("data-item-filter"),a(".b-history_filter-more em").empty(),""!==f&&"guestbook"!==f&&"friends"!==f&&"groups"!==f&&"visible"!==i?(h.html(e.html()),g.addClass("b-history_filter__active")):(j=h.data("textDefault"),h.html(j),g.removeClass("b-history_filter-active")),c.infScroll?c.infScroll.stop():U(c),c.request&&c.request.abort(),k?(c.adaptHistory=1,V(k),b.myrb(20227067),b.myrb(20012372)):c.adaptHistory&&""===f&&(delete c.adaptHistory,V(k),b.myrb(20227065)),c.banner&&(delete c.banner.currentIndex,delete c.banner.slots,delete c.banner.stopShow),c.adv&&(delete c.adv.currentIndex,delete c.adv.posts,delete c.adv.stopShow),c.infScroll&&T(c,f)),m(d,'[data-history-error-load="reload"]')&&O(c),m(d,'[data-history-error-load="cancel"]')&&P(c)}function X(a,b){var c=m(b,".b-history_filter-more"),d=a.addonsEl;c?d.hasClass("showed")?d.hide().removeClass("showed"):d.addClass("showed").show():d.hide().removeClass("showed")}function Y(d){var e,f,g,h,i=d.data.cx;if("click"===d.type){if(!this.safeMode&&(W(i,d),X(i,d),e=m(d,".loadmore")))return b.myrb("714114"),void i.infScroll.run();(m(d,".b-history")||m(d,".b-history-page")||m(d,".b-sticky-post")||m(d,".b-common-friends"))&&(e=m(d,"[data-history-action]"),e&&(g=x[e.attr("data-history-action")],g&&g.call(i,e,d)),s.onBrowserEvent(d),t.onBrowserEvent(d),c("product-tools/friendship",function(a){a.onBrowserEvent(d)}),e=a(d.target).closest("[data-share-type]"),e.length&&c("product-tools/share-url",function(a){a.onBrowserEvent(d)}),e=a(d.target).closest('[data-event-control="open"], [data-event-control="settings"]'),e.length&&!this.HistorySettings&&c("home/history/settings",function(a,b){d.preventDefault(),d.stopPropagation(),this.HistorySettings=b.create(),this.HistorySettings.onLoad(i.elem.add(i.elem.siblings(".b-sticky-post"))),this.HistorySettings.clickHandler(a)}.bind(this,e)),e=m(d,'[data-type="comments-focus"]'),e&&(e.data("activeEmail")?(f=(m(d,"[data-comments-container]")||m(d,".b-history-event")).find(".b-comments__history"),f&&(f.removeClass("b-comments__history_no-comments"),f.find("textarea").focus().closest(".b-comments__history").show())):y()),e=m(d,'[data-type="audio-expand"]'),h=m(d,".b-history-event__audio-playlist"),e&&h&&(h.find(".jp__track.hide").removeClass("hide").slideUp(0).slideDown(),e.parent().hide()),e=m(d,'[data-action-show="photo-video-comment"]'),e&&e.parent().removeClass("b-history-event__cut-text"),e=m(d,".b-history-event__app--install_txt-cut"),e&&e.removeClass("b-history-event__app--install_txt-cut"))}else"mousedown"===d.type&&(m(d,".b-history_addons")||m(d,".b-history_filter-more")||!i.addonsEl||i.addonsEl.hide().removeClass("showed"))}function Z(e){var f=a(".b-history__update-info"),g=a(".b-history__update-info__text");e.updatedEventsCount<e.updateMaxEventsCount&&(e.updateUpdateTimer=setTimeout(function(){d.func("history.last_events_time",{time:this.lastEventTime},{success:function(e){var h=JSON.parse(e)[2].time;h>Number(this.lastEventTime)&&(!this.filter||"fresh"===this.filter)?d.func("",{time:this.lastEventTime,feed_context:this.feedContext,smart_history:this.smartHistory||void 0,adapt_history:this.adaptHistory||void 0,chrono:this.isChronoHistory||void 0,filter:"fresh"},{url:"/ajax_history",success:function(d){var e,h=a(".b-publisher__text"),i=a(window).scrollTop(),j=document.body.scrollHeight,k=d[2],l=k.split('class="b-history-event ').length-1,m=[];for(k=k.replace(/class="b-history-event\s/g,'class="b-history-event b-history-event__runtime-update '),this.newEventsCount+=l,c("util/num-end",function(a){this.newEventsCount>100?(g.html("100+ "+g.attr("data-five")),document.title="(100+) "+ea):this.newEventsCount>0?(a.ending(g,this.newEventsCount),document.title="("+this.newEventsCount+") "+ea):(f.removeClass("show"),document.title=ea)}.bind(this)),f.hasClass("show")||b.myrb(19654700),this.newEventsCount>0&&f.addClass("show"),e=0;e<l;e+=1)m.push(19654758);b.myrb(m),G(this,k,!1,!0),h.size()&&(h.is(":focus")||h.val().length)||a(window).scrollTop(i+(document.body.scrollHeight-j)),v.checkWatch(),this.updateTimeout.current=this.updateTimeout.respawn,this.updatedEventsCount+=l,Z(this)}.bind(this)}):(this.updateTimeout.current=Math.min(this.updateTimeout.current*this.updateTimeout.rate,this.updateTimeout.max),Z(this))}.bind(this)})}.bind(e),1e3*e.updateTimeout.current))}function $(c){a(".b-history__update-info").on("click",function(){a(".b-history-event__runtime-update").removeClass(".b-history-event__runtime-update"),a(".b-history__update-info").removeClass("show"),c.newEventsCount=0,a("body,html").animate({scrollTop:0},500),a(window.document).trigger("right-banners-update"),b.myrb(19654709)}),c.updateTimeout.current=c.updateTimeout.start,c.updateEnable&&Z(c)}function _(b,c,d){var f,g;b.faderEl=c.find(".history-fader"),b.addonsEl=c.find(".b-history_addons"),b.eventsEl=c.find(".b-history_events-wrapper"),b.controlsEl=c.find(".b-history_controls-wrapper"),b.hasEvents=null,b.newEventsCount=0,b.updatedEventsCount=0,0!==b.filter.length&&(b.controlsEl.find(".b-history_filter").removeClass("b-history_filter-active"),c.find('[data-filter="'+b.filter+'"]').addClass("b-history_filter-active"));try{b.i18n=a.parseJSON(c.find(".i18n").html())}catch(a){}b.elem.on("click",{cx:b},d),a(document).on("mousedown",{cx:b},d),b.elem.hasClass("b-sticky-post")?(f=c,g=f.find(".jp__playlist"),c.add(f),b.elem.show(),p.check(),e.createPlaylist({id:g.data("historyEventContainer"),element:g,activeEmail:g.data("activeEmail"),fragment:"history",eventType:g.data("eventType"),noLink:g.data("noLink")}).createTracks()):(U(b),a(document.body).on("publisher.newPost",function(c,d){var f=a("#history_container"),g=a(d.post).prependTo(f),h=g.find(".jp__playlist");p.check(),x.repaintPosts(b.elem),x.cutAppPosts(b.elem),f.find(".events-notfound").hide(),e.createPlaylist({id:h.data("historyEventContainer"),element:h,fragment:"history",eventType:h.data("eventType"),noLink:h.data("noLink")}).createTracks()})),ca&&$(b)}var aa,ba,ca=!1,da="",ea=document.title;return s=s.create(),t=t.create(),aa=f.extend({props:{templates:{advPost:"home/tmpl/history/adv-post"},deferred:{advPost:"home/history/adv-post",advPostCarousel:"home/history/adv-post-carousel"}},public:{init:function(){var b,d,e,f,g,h,i=this.$el.find('[data-type="history-config-main"]'),k=this.$el.find('[data-type="history-config"]'),m=l().param("filter"),n={};return ba=a.proxy(Y,this),i&&i.length&&(n=JSON.parse(i.html().replace(/\r|\n|\t|\s{2,}/g,""))),k&&k.length&&a.extend(!0,n,JSON.parse(k.html().replace(/\r|\n|\t|\s{2,}/g,""))),i.remove(),k.remove(),b=this.$el.find(".b-history__audio-promo"),b&&b.length>0&&c("home/history/audio-promo",function(a){a.create().onLoad(b)}),d=this.$el.find(".b-history__apps-carousel"),d&&d.length>0&&c("home/history/apps-carousel",function(a){a.create().onLoad(d)}),e=this.$el.find(".b-history__apps-best"),e&&e.length>0&&c("home/history/apps-best",function(a){this.appsBest=a.create().onLoad(e),this.appsBest.collection.setParam("check_rl",1),this.appsBest.collection.fetch(),this.appsBest.collection.removeParam("check_rl")}.bind(this)),f=this.$el.find(".b-history__video-promo"),f&&f.length>0&&c("home/history/video-promo",function(a){a.create().onLoad(f)}),g=this.$el.find(".b-history__hot-or-not"),g&&g.length>0&&c("home/history/hot-or-not",function(a){this.hotOrNot=a.create().onLoad(g)}.bind(this)),h=this.$el.find(".b-history__photos"),h&&h.length>0&&c("home/history/photos",function(a){this.historyPhotos=a.create().onLoad(h)}.bind(this)),v.init(this.$el,{onWatched:function(b){var d=a(".b-history__update-info"),e=a(".b-history__update-info__text");b.removeClass("b-history-event__runtime-update"),this.newEventsCount-=b.size(),this.newEventsCount<0&&(this.newEventsCount=0),c("util/num-end",function(a){this.newEventsCount>100?(e.html("100+ "+e.attr("data-five")),document.title="(100+) "+ea):this.newEventsCount>0?(a.ending(e,this.newEventsCount),document.title="("+this.newEventsCount+") "+ea):(d.removeClass("show"),document.title=ea)}.bind(this))}.bind(this)}),ca=this.$el.data("history-lenta"),da=this.$el.data("history-journaldir"),this.elem=this.$el,this.type=this.elem.attr("data-history-type"),"hashtag"===this.type&&(this.hashtag=this.elem.attr("data-history-hashtag")),w.bind(this.$el),C(this.$el),z(this.$el),m&&0!==m.length&&a.extend(n,{filter:m}),A(this,n),D(this,this.$el),n.specialAdv&&n.specialAdv.isEnable?this.initSpecialAdvPosts(n.specialAdv.limit).then(function(a){this.advItems=a[0],this.sliderItems=a[2],j.isArray(this.sliderItems)&&(this.sliderItems=this.sliderItems.filter(function(a){return a.PostData&&a.PostData.Photo&&a.PostData.Photo["photo-url"]})),j.isArray(this.advItems)&&(this.showSpecialAdvPosts(),n.specialAdv&&n.specialAdv.slider&&n.specialAdv.slider.isEnable&&j.isArray(this.sliderItems)&&this.sliderItems.length>=3&&this.showSpecialAdvSlider())}.bind(this)):this.showAdvPosts(this.$el),_(this,this.$el,ba),s.setUp(this.$el).catch(function(){}),x.init(this.$el,da,n),x.repaintPosts(this.elem),x.cutAppPosts(this.elem),this},destroy:function(){return clearTimeout(this.eventsTimer),s.reset(),t.reset(),this.HistorySettings&&(this.HistorySettings.onUnload(this.elem),delete this.HistorySettings),v.destroy(),this.elem.off("click",ba),a(document.body).off("publisher.newPost"),x.destroy(),clearTimeout(this.updateUpdateTimer),j.isObject(this.guestbook)&&this.guestbook.destroy(),j.isObject(this.welcomeNovice)&&this.welcomeNovice.destroy(),this.request&&(this.request.abort(),delete this.request),this.infScroll&&(this.infScroll.stop(),delete this.infScroll),this.friendsPopup&&(this.friendsPopup.destroy(),delete this.friendsPopup),this.hotOrNot&&(this.hotOrNot.destroy(),delete this.hotOrNot),this.appsBest&&(this.appsBest.destroy(),delete this.appsBest),this.historyPhotos&&(this.historyPhotos.destroy(),delete this.historyPhotos),delete this.safeMode,delete this.eventsEl,delete this.addonsEl,delete this.controlsEl,delete this.faderEl,delete this.banner,delete this.adv,aa.__super__.destroy.call(this),this},getComments:function(){return s},showAdvPosts:function(a){var b,c,e,f,g=[],h=""===this.filter||"groups"===this.filter;if(h&&this.adv&&!this.adv.showOnes&&!this.adv.stopShow){if(b=a.find(".b-history-event[data-id]"),c=this.adv.currentIndex||this.adv.start,e=this.adv.repeat,f=c,g=[],e){for(;f<=b.length;)g.push(f),f+=e;this.adv.currentIndex=f-b.length}else g.push(c),this.adv.showOnes=!0;this.adv.posts||(this.adv.posts=[]),d.func("multipost.adv_get",{limit:g.length,pids:this.adv.posts.join(",")},{dataType:"json"}).success(function(a){"ok"===a[2]&&a[3].length?(a=a[3],g.forEach(function(c,d){var e=a[d];e?(this.require("advPost",function(a){var d=new a({isShowComplaint:this.adv.isShowComplaint,textLength:this.adv.textLength,data:e,locales:this.locales.adv});d.renderPost().then(function(){b.eq(c-1).before(d.getElement())})}.bind(this)),this.adv.posts.push(e.PostID)):this.adv.stopShow=!0}.bind(this))):this.adv.stopShow=!0}.bind(this))}},initSpecialAdvPosts:function(a){return new g(function(b,c){d.func("multipost.adv_get",{limit:a||50,with_special:1},{dataType:"json"}).success(function(a){"ok"===a[2]&&j.isObject(a[3])&&b(a[3])})})},showSpecialAdvPosts:function(){var a,b=""===this.filter||"groups"===this.filter;b&&(a=this.$el.find(".b-history-event[data-id]"),this.require("advPost",function(b){this.advItems.filter(function(a){return!a.isInserted}).forEach(function(c,d){var e=new b({isShowComplaint:this.adv.isShowComplaint,textLength:this.adv.textLength,data:c,locales:this.locales.adv});e.renderPost().then(function(){var b=a.eq(Number(c.Position)-1);b.length&&(c.isInserted=!0,b.before(e.getElement()))})}.bind(this))}.bind(this)))},showSpecialAdvSlider:function(){var a,b=""===this.filter||"groups"===this.filter;b&&(a=this.$el.find(".b-history-event[data-id]"),this.require("advPostCarousel",function(b){var c=new b({title:this.specialAdv.slider.title,list:this.sliderItems});c.render(function(b){b.insertBefore(a.eq(this.specialAdv.slider.position-1)),c.init()}.bind(this))}.bind(this)))}}})});