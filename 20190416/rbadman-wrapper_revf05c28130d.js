define(["jquery","counters","base/view","util/helpers","util/htmlescape","video-html5/controls","video-html5/wrapper/preroll-element"],function(a,b,c,d,e,f,g){"use strict";var h=c.extend({props:{defaultOptions:{admanUrl:"//ad.mail.ru/static/admanhtml/2.1.7/rbadman-html5.min.js"},CNT:{bannerShown:22307968,overlayClosed:22307990,advPlayingExternal:23762970,advPlayingInternal:23762950,advPlayingAuth:23841720,goAdvPlaying:25568732,adblock:27103308},cssClasses:{advSkip:"b-video-html5__skip",advTimer:"b-video-html5__adv-timer"}},public:{init:function(){return this.promises={},this.stat=this.options.stat,this.$advContainer=this.options.$container,this.$overlayContainer=a("<div style='width:100%; height:100%;'></div>").appendTo(this.options.$overlayContainer),this.options.params.wrapper=this.$overlayContainer.get(0),this.video=this.$el[0],this.require(this.options.admanUrl,function(a){this.onAdmanLoaded(new a)}.bind(this)).then(null,function(){b.myrb(this.CNT.adblock),this.stat.send({name:"adblock"})}.bind(this)),h.__super__.init.call(this)},destroy:function(){return this.firstAdv&&this.firstAdv!==this.adv&&(this.firstAdv.stop(),this.firstAdv.destroy(),delete this.firstAdv),this.adv&&(this.adv.stop(),this.adv.destroy(),delete this.adv),this.destroyPreroll(),h.__super__.destroy.call(this)},playPreroll:function(){return this.currentAdvType="preroll",this.mediaElement=(new g).init({$video:a(this.options.params.videoEl),adv:this.adv}),this.createAdvControls(),new Promise(function(a,b){this.promises.preroll={resolve:a,reject:b},this.adv.start("preroll")}.bind(this))},startOverlay:function(){return this.pendingStart=!0,new Promise(function(a,b){this.promises.overlay={resolve:a,reject:b},this.firstAdv&&this.clearAdv(this.firstAdv),this.options.reRequestOverlay?(this.options.params.params.re_request=1,this.options.showLastOverlay&&!this.firstAdv?this.require(this.options.admanUrl,function(a){this.firstAdv=this.adv,this.clearAdv(this.firstAdv),this.adv=new a,this.adv.onError(this.onAdvError.bind(this)),this.adv.onReady(this.onAdvReady.bind(this)),this.adv.onClicked(this.onAdvClicked.bind(this)),this.adv.onStarted(this.onOverlayStarted.bind(this)),this.adv.onClosed(this.onAdvClosed.bind(this)),this.load().then(function(){this.adv.start("overlay")}.bind(this),null)}.bind(this)):this.load().then(function(){this.adv.start("overlay")}.bind(this),null)):this.adv.start("overlay"),this.currentAdvType="overlay",setTimeout(function(a){this.pendingStart&&(this.promises.overlay.reject(),this.pendingStart=!1,this.clearAdv(this.firstAdv),this.$overlayContainer.hide())}.bind(this),5e3)}.bind(this))},clearAdv:function(a){try{a.stop(),a.destroy()}catch(a){this.$overlayContainer&&this.$overlayContainer.empty()}},onOverlayStarted:function(){b.myrb(this.CNT.bannerShown),this.promises.overlay.resolve(),this.pendingStart&&(this.pendingStart=!1,this.$overlayContainer.parent().children().hide(),this.$overlayContainer.show())},showLastOverlay:function(){return new Promise(function(a,b){this.promises.overlay={resolve:a,reject:b},this.firstAdv?(this.adv.stop(),this.adv.destroy(),this.firstAdv.start("overlay"),setTimeout(b,100)):b(),this.pendingStart=!1})},load:function(){return new Promise(function(a,b){this.adv?(this.promises.load={resolve:a,reject:b},this.admanInited=!0,this.adv.setDebug(!1),this.adv.init(this.options.params)):this.require(this.options.admanUrl,function(c){this.onAdmanLoaded(new c),this.promises.load={resolve:a,reject:b},this.admanInited=!0,this.adv.setDebug(!1),this.adv.init(this.options.params)}.bind(this))}.bind(this))},pause:function(){this.adv.pause()},resume:function(){this.adv.resume()},getControls:function(){return this.advControls},isPlaying:function(){return this.playing}},protected:{onAdmanLoaded:function(a){this.adv||(this.adv=a,this.adv.onError(this.onAdvError.bind(this)),this.adv.onReady(this.onAdvReady.bind(this)),this.adv.onCompleted(this.onAdvCompleted.bind(this)),this.adv.onSkipped(this.onAdvSkipped.bind(this)),this.adv.onClicked(this.onAdvClicked.bind(this)),this.adv.onStarted(this.onAdvStarted.bind(this)),this.adv.onTimeRemained(this.onAdvTime.bind(this)),this.adv.onClosed(this.onAdvClosed.bind(this)),this.adv.onPlayed(this.onAdvPlayed.bind(this)),this.adv.onPaused(this.onAdvPaused.bind(this)))},onAdvError:function(a){this.promises.load.reject()},onAdvReady:function(a){a.noAd?this.promises.load.reject():this.isDestroyed||this.promises.load.resolve()},createAdvControls:function(){this.advControls||(this.advControls=f.createRunTime(d.extend(!0,{},{advMode:!0,mediaElement:this.mediaElement,progressBarColor:"#A67100",showViral:!1,stat:this.stat,fullscreenElement:this.options.$parentElement.get(0)}),this.$advContainer))},onAdvCompleted:function(a){this.destroyPreroll()},onAdvSkipped:function(a){this.destroyPreroll()},onAdvClicked:function(a){"preroll"===this.currentAdvType?(this.promises.preroll.resolve(),setTimeout(function(){this.destroyPreroll(),this.video.pause()}.bind(this),300)):(this.trigger("overlay_clicked"),this.video.pause())},onAdvStarted:function(c,d){this.advSettings=d,"preroll"===c?(this.advSettings.allowCloseDelay||(this.advSettings.allowCloseDelay=0),this.createAdvSkip(),this.stat.send({name:"preroll_started"}),a(this.video).addClass("overlapped"),this.advControls.updateView(),a(document).trigger("VideoPlayer.play",[this.video]),"video"!==d.type?(this.$advSkip.appendTo(this.$overlayContainer),this.$overlayContainer.parent().addClass("swf")):this.$advContainer.show(),"additionalData"===d.type&&d.url&&d.url.indexOf("ima3vpaid.appspot.com")!==-1&&this.$advSkip.remove()):"overlay"===c&&(b.myrb(this.CNT.bannerShown),this.promises.overlay.resolve(),this.pendingStart&&(this.pendingStart=!1,this.$overlayContainer.parent().children().hide(),this.$overlayContainer.show()))},createAdvSkip:function(){this.$advSkip=a("<div></div>").addClass(this.cssClasses.advSkip).appendTo(this.$advContainer),this.advSettings.allowClose?(this.$advSkip.html(this.options.locales.advRemaining||e.unescape(this.options.locales.adv.remaining)),this.advTimeout=this.advSettings.allowCloseDelay,this.$advTimer=this.$advSkip.find("."+this.cssClasses.advTimer),this.$advTimer.html(this.advTimeout)):this.$advSkip.html(this.options.locales.advertisement||e.unescape(this.options.locales.adv.advertisement)).addClass("skipless"),this.$advSkip.hide()},onAdvTime:function(c,d){c=d||c;var f=Math.round(this.advTimeout-c.currentTime);this.advCurrentTime=c.currentTime,this.$advTimer&&this.$advTimer.html(f),f<=0&&!this.$advSkip.hasClass("complete")&&(a("<div></div>").css({position:"absolute",top:"-10px",left:"-10px",bottom:"-10px",right:"-10px"}).appendTo(this.$advSkip),this.$advSkip.html(this.options.locales.advSkip||e.unescape(this.options.locales.adv.skip)).addClass("complete").on("click",this.onAdvSkipClick.bind(this)).focus()),this.$advSkip&&this.advCurrentTime>0&&this.$advSkip.show(),!this.prerollPlaying&&c.duration&&(this.options.external?b.myrb(this.CNT.advPlayingExternal):b.myrb(this.CNT.advPlayingInternal),this.options.authorized&&b.myrb(this.CNT.advPlayingAuth),"go"===this.options.partnerId&&b.myrb(this.CNT.goAdvPlaying),this.stat.comScorePlayAdv(c.duration),this.prerollPlaying=!0)},onAdvSkipClick:function(a){this.$advSkip.off(),this.adv.skip()},onAdvClosed:function(){b.myrb(this.CNT.overlayClosed)},onAdvPlayed:function(){this.playing=!0},onAdvPaused:function(){this.playing=!1},destroyPreroll:function(){this.adv&&this.adv.stop(),this.advControls&&(this.advControls.destroy(),delete this.advControls),this.$advSkip&&(this.$advSkip.off("click").remove(),delete this.$advSkip),a(this.video).removeClass("overlapped"),this.$advContainer.hide(),this.$overlayContainer.parent().removeClass("swf"),this.promises.preroll&&(this.prerollPlaying?this.promises.preroll.resolve():this.promises.preroll.reject())}}});return h});