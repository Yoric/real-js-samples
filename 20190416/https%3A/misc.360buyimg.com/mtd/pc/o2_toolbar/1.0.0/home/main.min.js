seajs.config({paths:{O2_TOOLBAR_BASE:"//misc.360buyimg.com/mtd/pc/o2_toolbar/1.0.0"+"/home"},alias:{"o2_toolbar/maincss":"O2_TOOLBAR_BASE/main.min.css","o2_toolbar/cart":"O2_TOOLBAR_BASE/cart.min.js","o2_toolbar/cartcss":"O2_TOOLBAR_BASE/cart.min.css","o2_toolbar/follow":"O2_TOOLBAR_BASE/follow.min.js","o2_toolbar/followcss":"O2_TOOLBAR_BASE/follow.min.css","o2_toolbar/history":"O2_TOOLBAR_BASE/history.min.js","o2_toolbar/historycss":"O2_TOOLBAR_BASE/history.min.css","o2_toolbar/localStorageObj":"O2_TOOLBAR_BASE/static/js/localStorageObj.js","o2_toolbar/tools":"O2_TOOLBAR_BASE/static/js/tools.js","jdf/dialog":"O2_TOOLBAR_BASE/static/js/jdf_dialog.js","jdf/dropdown":"O2_TOOLBAR_BASE/static/js/jdf_dropdown.js","jdf/event":"O2_TOOLBAR_BASE/static/js/jdf_event.js","jdf/globalreco":"O2_TOOLBAR_BASE/static/js/jdf_globalreco.js","jdf/login":"O2_TOOLBAR_BASE/static/js/jdf_login.js","jdf/setuserinfo":"O2_TOOLBAR_BASE/static/js/jdf_setuserinfo.js","jdf/switchable":"O2_TOOLBAR_BASE/static/js/jdf_switchable.js","jdf/trimpath":"O2_TOOLBAR_BASE/static/js/jdf_trimpath.js"}}),define("o2_toolbar",["jdf/trimpath","jdf/login","o2_toolbar/localStorageObj","o2_toolbar/maincss"],function(require,exports,module){function t(t){return t&&t.replace(/^http(s?):/,"")}function e(t){this.settings=$.extend(!0,{},s,t),this.onOpen=t.onOpen||function(){},this.onClose=t.onClose||function(){},this.onSwitch=t.onSwitch||function(){},this.onLogin=t.onLogin||function(){},this.settings.links.top.href&&delete this.settings.links.top.anchor,this.settings.links.feedback.anchor&&delete this.settings.links.feedback.href,this.init()}var i=(require("jdf/trimpath"),require("jdf/login")),a=require("o2_toolbar/localStorageObj").localStorage,s={$el:$("#J-global-toolbar"),pType:"",enabled:!0,bars:{jdvip:{index:.3,enabled:!0,title:"京东会员",login:!0,vip:"1",iframe:"//vip.jd.com/sideBar/index.html"},cart:{index:1,enabled:!0,title:"购物车",href:"//cart.jd.com/cart.action?r="+Math.random(),js:"o2_toolbar/cart"},follow:{index:2,enabled:!0,title:"我的关注",login:!0,href:"//t.jd.com/home/follow",js:"o2_toolbar/follow"},history:{index:3,enabled:!0,title:"我的足迹",login:!0,href:"//my.jd.com/history/list.html",js:"o2_toolbar/history"},message:{index:4,enabled:!0,title:"我的消息",target:"//joycenter.jd.com/msgCenter/queryHistoryMessage.action"},jimi:{index:5,enabled:!0,title:"咨询JIMI",target:"//chat.jd.com/chat/index.action?venderId=1&entry=jd_web_jimi_jdhome"}},links:{top:{index:1,title:"顶部",anchor:"#shortcut-2013"},feedback:{index:-1,title:"反馈",href:"//diaoyan.jd.com/survey/answerSurvey.htm?eSurveyId=AZDFYX5KJGMOK"}},ad:{enabled:!0,id:"0_0_7209",startTime:+new Date(2017,0,4,0,0,1)/1e3,endTime:+new Date(2017,1,4,0,0,0)/1e3}},n=function(t){return"mousewheel"===t.type?t.wheelDelta>0?"up":"down":"DOMMouseScroll"===t.type?t.detail>0?"down":"up":"unknown"},o=function(t){return 0===t.scrollTop()?"top":t.scrollTop()+t.outerHeight()>=t[0].scrollHeight?"bottom":"middle"},r=function(t){return t[0].scrollHeight>t.innerHeight()};pageConfig.__toolbarLogin=function(t){seajs.use("jdf/login",function(e){e({modal:!0,complete:function(e){t(e)}})})},e.prototype={init:function(){return!!this.settings.enabled&&(this.$w=$(window),this.$d=$(document),this.isIE6=$.browser.isIE6(),this.settings.clsPageType=this.getPageType(),this.render(),this.bindEvent(),this.opened=!1,this.triggerClick="z-jdm-tbar-tab-selected",this.triggerHover="z-jdm-tbar-tab-hover",this.toolbarOpen="z-jdm-toolbar-open",this.$toolbar=this.settings.$el.find(".J-toolbar"),this.$wrap=this.settings.$el.find(".J-wrap"),this.$trigger=this.settings.$el.find('.J-trigger[data-type="bar"]'),this.$content=this.settings.$el.find(".J-content"),this.$newItemInCartHint=this.settings.$el.find(".jdm-tbar-tab-cart .tabs-tip"),this.setBubbleCount("cart",readCookie("cn")),this.isIE6&&(this.resetLayout("height"),this.resetLayout("top"),this.resetLayout("right")),this.settings.$el.find("#J-toolbar-load-hook").trigger("click"),this.eventDispatcher=$({}),this.settings.ad.enabled&&this.insertAD(),this.bubbleKey="toolbar_bubble",void("home"===this.settings.pType&&this.setGiftBubble()))},setGiftBubble:function(){var t=this;i.isLogin(function(e){e&&t.setLocalStorage()&&t.createGiftBubble()})},setLocalStorage:function(){var t=this;return a.check(t.bubbleKey)},createGiftBubble:function(){var t=this,e=t.settings.$el.find(".jdm-toolbar-tabs");$.ajax({url:"//libao.jd.com/gift/queryWaitingGifts.do?type=1&channel=1",scriptCharset:"utf-8",dataType:"jsonp",jsonpCallback:"jsonpGifts",success:function(i){if(i&&i.success===!0&&i.result&&$.isArray(i.result.giftPackages)){var s="",n=i.result.giftPackages;if(0!==n.length){if(n.length>1)s='<div class="tbarpop tbarpop_common">                  <div class="tbarpop_txt">您有<br>'+n.length+'个礼包</div>                  <div class="tbarpop_close"></div>                </div>';else{var o,r=n[0];switch(r.businessType){case 2:o="tbarpop_birth";break;case 3:o="tbarpop_new";break;default:o="tbarpop_common"}s='<div class="tbarpop '+o+'">                  <div class="tbarpop_txt">您有<br>1个'+r.name+'</div>                  <div class="tbarpop_close"></div>                </div>'}e.append(s),$(".tbarpop .tbarpop_close").unbind("click").bind("click",function(){return $(".tbarpop").fadeOut(300,function(){$(".tbarpop").remove(),a.set(t.bubbleKey)}),!1}),$(".tbarpop").unbind("click").bind("click",function(){$(".jdm-tbar-tab-jdvip").trigger("click"),$(".tbarpop").fadeOut(300,function(){$(".tbarpop").remove()})})}}}})},getPageType:function(){var t="h";switch(this.settings.pType){case"home":t="h";break;case"list":t="thirdtype";break;case"search":t="thirdtype";break;case"item":t="shangpin";break;default:t="h"}return t},insertAD:function(){try{if(this.settings.ad&&this.settings.ad.startTime){this.settings.ad.endTime||(this.settings.ad.endTime=this.settings.ad.startTime+7776e3);var t,e,i=(new Date).valueOf()/1e3;window.pageConfig&&window.pageConfig.timestamp?(e=window.pageConfig.timestamp/1e3,t=i-e<300&&i-e>0?i:e):t=i;var a=this.settings.ad.startTime,s=this.settings.ad.endTime;(/isdebug/.test(location.search)||t>a&&t<s)&&this.loadAD()}else this.settings.ad=null}catch(n){this.settings.ad=null}},renderAD:function(e){screen.width<1380&&e.extension&&e.extension.pictureUrl?(e.width="60px",e.height="160px",e.imgSrc=t(e.extension.pictureUrl)):(e.width="90px",e.height="200px",e.imgSrc=t(e.pictureUrl));var i=$("#J-global-toolbar");i.find(".jdm-tbar-panel-ad").attr("data-iframe",t(e.link)),i.find(".jdm-tbar-panel-ad .title").text(e.name);var a=i.find(".jdm-toolbar-header .J-trigger");a.attr("clstag",a.attr("clstag")+"sale|saleicon|e"),i.find(".jdm-toolbar-header .jdm-tbar-act").css({width:e.width,height:e.height,background:"url("+e.imgSrc+") no-repeat",cursor:"pointer"}),i.find(".jdm-toolbar-header").css("width",e.width)},loadAD:function(t){var e=this,i="//lapi.jd.com/pool?body={%22pid%22:%220302520%22}&source=pc_home";$.ajax({url:i,scriptCharset:"utf-8",dataType:"jsonp",jsonpCallback:"jsonpToolbarAd",success:function(t){0===t.code&&t.info&&t.info.hit_num>0&&(e.renderAD(t.data[0]),e.settings.bars.ad={name:"ad",iframe:e.$wrap.find(".jdm-tbar-panel-ad").attr("data-iframe")})}})},render:function(){var t='          <div class="jdm-toolbar-wrap J-wrap">              <div class="jdm-toolbar J-toolbar">                  <div class="jdm-toolbar-panels J-panel">                  <div data-name="ad" class="J-content jdm-toolbar-panel jdm-tbar-panel-ad">                      <h3 class="jdm-tbar-panel-header J-panel-header">                          <a>                          <i></i>                          <em class="title"></em>                          </a>                          <span class="close-panel J-close"></span>                      </h3>                      <div class="jdm-tbar-panel-main">                          <div class="jdm-tbar-panel-content J-panel-content">                          </div>                      </div>                  </div>                  {for bar in bars}                  {if bar.enabled&&!bar.target}                      <div data-name="${bar.name}" class="J-content jdm-toolbar-panel jdm-tbar-panel-${bar.name}">                          <h3 class="jdm-tbar-panel-header J-panel-header">                              <{if bar.href}a href="${bar.href}" target="_blank"{else}span{/if} class="title" clstag="${clsPageType}|keycount|cebianlan_${clsPageType}_${bar.name}|title">                              <i></i>                              <em class="title">${bar.title}</em>                              </{if bar.href}a{else}span{/if}>                              <span class="close-panel J-close"></span>                          </h3>                          <div class="jdm-tbar-panel-main">                              <div class="jdm-tbar-panel-content J-panel-content" {if bar.iframe}style="overflow:hidden;"{/if}>                              <div class="jdm-tbar-tipbox2">                                  <div class="tip-inner">                                      <i class="i-loading"></i>                                  </div>                              </div>                              </div>                          </div>                          <div class="jdm-tbar-panel-footer J-panel-footer"></div>                      </div>                  {/if}                  {/for}                  </div>                  <div class="jdm-toolbar-header">                      <div class="jdm-tbar-act J-trigger" data-type="bar" data-name="ad" data-iframe="true"                           clstag="${clsPageType}|keycount|">                      </div>                  </div>                  <div class="jdm-toolbar-tabs J-tab">                  {for bar in bars}                  {if bar.enabled}                      <div {if !bar.target} data-type="bar" {/if}                          clstag="${clsPageType}|keycount|cebianlan_${clsPageType}_${bar.name}|btn"                           class="J-trigger jdm-toolbar-tab jdm-tbar-tab-${bar.name}"                           data-name="${bar.name}"                          {if bar.login}data-login="${bar.login}"{/if}                          {if bar.iframe}data-iframe="${bar.iframe}"{/if}>                                                    {if bar.target}<a target="_blank" href="${bar.target}">{/if}                          {if bar.vip}<i class="tab-tip"></i>{/if}                              <i class="tab-ico"></i>                              <em class="tab-text">                                  ${bar.title}                              </em>                              {if bar.extraHTML}${bar.extraHTML}{/if}                          {if bar.target}</a>{/if}                          <span class="tab-sub J-count hide">0</span>                          <div class="tabs-tip hide">                              <span class="ico"></span>                              <span class="text">成功加入购物车!</span>                              <b></b>                          </div>                      </div>                  {/if}                  {/for}                  {for link in links}                    {if link.href}                      <div data-type="link" class="J-trigger jdm-toolbar-tab jdm-tbar-tab-${link.name}">                        <a href="${link.href}" target="_blank" clstag="${clsPageType}|keycount|cebianlan_${clsPageType}|${link.name}">                            <i class="tab-ico"></i>                            <em class="tab-text">${link.title}</em>                            {if link.extraHTML}${link.extraHTML}{/if}                        </a>                      </div>                    {/if}                  {/for}                  </div>                  <div class="jdm-toolbar-footer">                    {for link in links}                      {if link.anchor}                        <div data-type="link" class="J-trigger jdm-toolbar-tab jdm-tbar-tab-${link.name}">                          <a href="${link.anchor}" clstag="${clsPageType}|keycount|cebianlan_${clsPageType}|${link.name}">                            <i class="tab-ico"></i>                            <em class="tab-text">${link.title}</em>                            {if link.extraHTML}${link.extraHTML}{/if}                          </a>                        </div>                      {/if}                    {/for}                  </div>                  <div class="jdm-toolbar-mini">                  </div>              </div>              <div id="J-toolbar-load-hook" clstag="${clsPageType}|keycount|cebianlan_${clsPageType}|load"></div>          </div>',e=this.sortJsonToArray(this.settings);e.clsPageType=this.getPageType();try{this.settings.$el.html(t.process(e))}catch(i){console.log("Toolbar rendered error >> "+i)}},sortJsonToArray:function(t){function e(t,e){var i=t.index||0,a=e.index||0;return i-a}var i=[],a=[];for(var s in t.links)t.links.hasOwnProperty(s)&&(t.links[s].name=s,a.push(t.links[s]));for(var n in t.bars)t.bars.hasOwnProperty(n)&&(t.bars[n].name=n,i.push(t.bars[n]));return{enabled:this.settings.enabled,ad:this.settings.ad,bars:i.sort(e),links:a.sort(e),clsPageType:this.clsPageType}},setBubbleCount:function(t,e){var i,a=this.$trigger.filter('[data-name="'+t+'"]').find(".J-count");e>0?(i=e>99?"99+":e,a.html(i).show()):a.hide()},updateLayout:function(){var t=$(window).height(),e=this.$content.eq(this.m.index),i=e.find(".J-panel-header").outerHeight(),a=e.find(".J-panel-footer").outerHeight(),s=e.find(".J-panel-content");s.css("height",t-i-a)},bindEvent:function(){var t=this;$(window).unbind("resize.toolbar").bind("resize.toolbar",function(){t.opened&&t.updateLayout()}),$(document).undelegate("click.toolbar").delegate("body","click.toolbar",function(e){$.contains(t.$wrap[0],e.target)||t.close()}),this.settings.$el.delegate(".J-trigger","mouseenter",function(){t.handleHover(!0,$(this))});var e=null;this.settings.$el.delegate(".J-trigger","mouseleave",function(){t.handleHover(!1,$(this)),$(this).hasClass("jdm-tbar-tab-jdvip")&&$(".tbarpop").length&&!t.opened&&(clearTimeout(e),e=setTimeout(function(){$(".tbarpop").fadeIn(300,function(){$(".tbarpop").show()})},300))}),this.settings.$el.delegate(".J-trigger","click",function(){$(this).hasClass("jdm-tbar-tab-jdvip")&&$(".tbarpop").length&&$(".tbarpop").fadeOut(300,function(){$(".tbarpop").remove()}),t.handleTrigger($(this))}),this.settings.$el.delegate(".J-close","click",function(){t.close()}),this.settings.$el.delegate(".J-panel-content","mousewheel DOMMouseScroll",function(t){function e(){return"up"===s&&"top"===l}function i(){return"down"===s&&"bottom"===l}var a=$(this),s=n(t),l=o(a),d=r(a);(!d||e()||i())&&t.preventDefault()}),this.isIE6&&(this.$w.bind("resize",function(){t.resetLayout("height"),t.resetLayout("right")}),this.$w.bind("scroll",function(){t.resetLayout("top")}))},resetLayout:function(t){if("height"===t){var e=this.$w.height();this.$toolbar.add(this.$wrap).css("height",e)}if("top"===t){var i=this.$d.scrollTop();this.$wrap.css("top",i)}"right"===t&&(this.$w.width()%2>0?this.$wrap.css("right",-1):this.$wrap.css("right",0))},handleHover:function(t,e){var i=this;e.parent().hasClass("jdm-toolbar-header")||(t?e.addClass(i.triggerHover):e.removeClass(i.triggerHover))},handleTrigger:function(t){var e=this,i=this.$trigger.index(t),a="bar"===t.attr("data-type"),s={index:i,login:t.attr("data-login"),name:t.attr("data-name"),iframe:t.attr("data-iframe")};return e.opened&&i===e.$content.data("last")?void e.close():(this.m=s,!!a&&void(s.login?seajs.use("jdf/login",function(t){t.isLogin(function(i){i?e.open(s):"true"===s.login?t({modal:!0,firstCheck:!1,complete:function(t){e.open(s),e.onLogin(s)}}):location.href="//passport.jd.com/new/login.aspx?ReturnUrl="+encodeURIComponent(s.login)})}):this.open(s)))},switchTo:function(t){this.eventDispatcher.trigger(t.name+"PanelOpen"),this.$trigger.removeClass(this.triggerClick),this.$trigger.eq(t.index).parent().hasClass("jdm-toolbar-header")||this.$trigger.eq(t.index).addClass(this.triggerClick);var e=this.$content.data("last");parseInt(e,10)!==t.index&&(this.$content.css("visibility","hidden"),this.$content.eq(t.index).css("z-index","2"),this.$content.eq(t.index).css("visibility","visible"),void 0!==e&&(this.$content.eq(e).css("z-index","1").css("visibility","visible"),this.$content.eq(e).removeClass("toolbar-animate-in").addClass("toolbar-animate-out")),this.$content.eq(t.index).removeClass("toolbar-animate-out").addClass("toolbar-animate-in"),this.$content.data("last",t.index),this.settings.bars[t.name].loaded||this.load(t),this.updateLayout(t))},load:function(t){var e=this,i=this.$content.eq(t.index),a=i.find(".J-panel-header"),s=i.find(".J-panel-content"),n=i.find(".J-panel-footer");if(t.iframe){var o='<iframe frameborder="0" style="height:100%;width:100%;" width="100%" height="100%" src="'+this.settings.bars[t.name].iframe+'"></iframe>';s.html(o),this.settings.bars[t.name].loaded=!0}else{var r=this.settings.bars[t.name].js;seajs.use(r,function(i){i&&new i({$header:a,$content:s,$footer:n}),e.settings.bars[t.name].loaded=!0})}},open:function(t){this.$wrap.addClass(this.toolbarOpen),this.opened?this.onSwitch(t):this.onOpen(t),this.opened=!0,this.switchTo(t)},close:function(){this.$wrap.removeClass(this.toolbarOpen),this.$trigger.removeClass(this.triggerClick).removeClass(this.triggerHover),this.opened=!1,this.onClose()},setStatus:function(t,e,i){var a=i||"fd",s='          <div>              <div class="jdm-tbar-tipbox2">                  <div class="tip-inner">                      <i class="i-face-'+a+' tip-face"></i>                      <div class="tip-text">                          {content}                      </div>                  </div>              </div>          <div>';t.html(s.replace("{content}",e))},newItemInCart:function(){var t,e=this.$trigger.filter('[data-name="cart"]').find(".J-count");t=e.is(":visible")?parseInt(e.text(),10):0,this.setBubbleCount("cart",t+1),this.$newItemInCartHint.stop().show().css({opacity:1}).delay(800).fadeOut(600)},sendLog:function(t,e,i){log("ce_bian_lan","0000110",this.settings.pType,t,e,i)}},module.exports=e});