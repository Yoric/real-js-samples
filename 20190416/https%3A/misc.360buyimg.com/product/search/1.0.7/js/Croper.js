/* product-search/1.0.7 Croper.js Date:2017-12-14 16:56:39 */
define("//misc.360buyimg.com/product/search/1.0.7/js/Croper.js",["//misc.360buyimg.com/jdf/1.0.0/unit/trimPath/1.0.0/trimPath"],function(require){require("//misc.360buyimg.com/jdf/1.0.0/unit/trimPath/1.0.0/trimPath");var c='<div class="full-img">	<img src="${data.src}" alt="">	<div class="mask"></div></div><div class="croper">	<img src="${data.src}" alt="">	<div class="crop-marker">		<i class="nw"></i>		<i class="ne"></i>		<i class="se"></i>		<i class="sw"></i>		<div class="mark-inner"></div>	</div></div>';var o,d=$(document),e=SEARCH.base_url||"?",f=SEARCH.img_info,g=!1,h={},i={},j=!1,k={},l=!1,m={},n={};var p=function(a){this.$cropPanel=a.$cropPanel,this.imgSrc=a.imgSrc,this.startPos=a.startPos||{bottom:"100",left:"0",right:"100",top:"0"},this.cropMinWidth=a.cropMinWidth,this.cropMinHeight=a.cropMinHeight,this.template=a.template||c,this.callback=a.callback||function(){},this.init()};return p.prototype={init:function(){var a=this;h.startPos={bottom:parseFloat(a.startPos.bottom),left:parseFloat(a.startPos.left),right:parseFloat(a.startPos.right),top:parseFloat(a.startPos.top)};var b;h.width=parseInt(f.width),h.height=parseInt(f.height),h.width<280&&h.height<280?(g=!0,i.src="//img12.360buyimg.com/uba/"+a.imgSrc,b=1,i.width=h.width,i.height=h.height):(i.src="//img12.360buyimg.com/uba/s280x280_"+a.imgSrc,h.width>h.height?(b=h.width/280,i.width=280,i.height=h.height/b):(b=h.height/280,i.height=280,i.width=h.width/b),a.cropMinWidth=128/b,a.cropMinHeight=128/b),h.ratio=b,h.cropWidth=h.startPos.right-h.startPos.left,h.cropHeight=h.startPos.bottom-h.startPos.top,i.startPos={bottom:h.startPos.bottom/b,left:h.startPos.left/b,right:h.startPos.right/b,top:h.startPos.top/b},i.cropWidth=h.cropWidth/b,i.cropHeight=h.cropHeight/b,a.setCroper(),a.bindEvent()},setCroper:function(){var a=i.startPos,b=i.cropWidth,d=i.cropHeight,e="",f=this.$cropPanel;e=c.process({data:i}),f.html(e),f.find(".full-img,.croper").css({width:i.width,height:i.height,marginLeft:-i.width/2,marginTop:-i.height/2});var g=f.find(".croper");n.left=a.left,n.top=a.top,n.width=b,n.height=d,o=g.find("img"),u(),g.find(".crop-marker").css({width:b-2,height:d-2,left:a.left,top:a.top})},bindEvent:function(){var a=this.$cropPanel.find(".crop-marker"),b=this.$cropPanel.closest(".imgs-crop-operate"),c=b.closest(".imgs-crop");a.bind("mousedown",q),v(this),b.delegate(".btn-cancel","click",function(a){a.preventDefault(),c.removeClass("z-imgs-crop-show")}),b.delegate(".btn-sure","click",function(b){b.preventDefault();var c=parseInt(a.css("top")),d=parseInt(a.css("left")),f=d+a[0].getBoundingClientRect().width,g=c+a[0].getBoundingClientRect().height,i=h.ratio;h.endPos={bottom:Math.max((g*i).toFixed(6),(c*i+128).toFixed(6)),left:(d*i).toFixed(6),right:Math.max((f*i).toFixed(6),(d*i+128).toFixed(6)),top:(c*i).toFixed(6)};var j="main_rect="+h.endPos.left+","+h.endPos.top+"|"+h.endPos.right+","+h.endPos.bottom;var k=location.href.split("?")[0];j=e.split("&").length>1?"&"+j:j,location.href=k+e+j})}},p;function q(a){var b=$(a.currentTarget);j=!0,k.dragItem=b,k.dX=a.clientX-b.offset().left,k.dY=a.clientY-b.offset().top,d.bind("mousemove",r)}function r(a){if(j){var b=k.dragItem;return t(b,a.clientX,a.clientY),d.bind("mouseup",s),!1}}function s(){k.dragItem;j=!1,d.unbind("mousemove",r)}function t(a,b,c){var d=a.closest(".croper"),e=d.offset().left,f=d.offset().top,g=e+d[0].getBoundingClientRect().width-a[0].getBoundingClientRect().width,h=f+d[0].getBoundingClientRect().height-a[0].getBoundingClientRect().height,i=b-k.dX,j=c-k.dY;a.offset(e>=i?{left:e}:i>=g?{left:g}:{left:i}),a.offset(f>=j?{top:f}:j>=h?{top:h}:{top:j}),n.left=parseInt(a.css("left")),n.top=parseInt(a.css("top")),u()}function u(){var a=[],b="";a=[n.top,n.left+n.width,n.top+n.height,n.left,""],b="rect("+a.join("px ")+")",o.get(0).style.clip=b}function v(a){var b=a.$cropPanel.find(".croper"),c=b.find(".crop-marker"),d=c.find(".nw"),e=c.find(".ne"),f=c.find(".se"),g=c.find(".sw");m.resizeItem=c,m.minWidth=a.cropMinWidth,m.minHeight=a.cropMinHeight,d.bind("mousedown",function(a){l="nw",j=!1,w(a)}),e.bind("mousedown",function(a){l="ne",j=!1,w(a)}),f.bind("mousedown",function(a){l="se",j=!1,w(a)}),g.bind("mousedown",function(a){l="sw",j=!1,w(a)})}function w(a){var b=m.resizeItem,c=b.closest(".croper"),e=b.offset().left,f=b.offset().top,g=b[0].getBoundingClientRect().width,h=b[0].getBoundingClientRect().height;switch(m.croperX=c.offset().left,m.croperY=c.offset().top,m.croperW=c[0].getBoundingClientRect().width,m.croperH=c[0].getBoundingClientRect().height,m.nw_dLeft=e,m.nw_dTop=f,m.se_dLeft=e+g,m.se_dTop=f+h,m.ne_dLeft=e+g,m.ne_dTop=f,m.sw_dLeft=e,m.sw_dTop=f+h,l){case"nw":m.nw_dX=a.clientX-m.nw_dLeft,m.nw_dY=a.clientY-m.nw_dTop;break;case"ne":m.ne_dX=a.clientX-m.ne_dLeft,m.ne_dY=a.clientY-m.ne_dTop;break;case"se":m.se_dX=a.clientX-m.se_dLeft,m.se_dY=a.clientY-m.se_dTop;break;case"sw":m.sw_dX=a.clientX-m.sw_dLeft,m.sw_dY=a.clientY-m.sw_dTop}d.bind("mousemove",x),a.stopPropagation()}function x(a){if(l){var b=m.resizeItem;switch(l){case"nw":y(a);break;case"ne":z(a);break;case"se":A(a);break;case"sw":B(a)}return n.left=parseInt(b.css("left")),n.top=parseInt(b.css("top")),n.width=parseInt(b[0].getBoundingClientRect().width),n.height=parseInt(b[0].getBoundingClientRect().height),u(),d.bind("mouseup",C),!1}}function y(a){var b=m.resizeItem,c=m.minWidth,d=m.minHeight,e=a.clientX-m.nw_dX,f=a.clientY-m.nw_dY,g=m.croperX,h=m.se_dLeft-m.minWidth,i=m.croperY,j=m.se_dTop-m.minHeight,k=Math.abs(m.se_dLeft-g),l=Math.abs(m.se_dTop-i),n=Math.abs(m.se_dLeft-e),o=Math.abs(m.se_dTop-f);g>=e?(b.offset({left:g}),b.width(k-2)):e>=h?(b.offset({left:h}),b.width(c-2)):(b.offset({left:e}),b.width(n-2)),i>=f?(b.offset({top:i}),b.height(l-2)):f>=j?(b.offset({top:j}),b.height(d-2)):(b.offset({top:f}),b.height(o-2))}function z(a){var b=m.resizeItem,c=m.minWidth,d=m.minHeight,e=a.clientX-m.ne_dX,f=a.clientY-m.ne_dY,g=m.sw_dLeft+c,h=m.croperX+m.croperW,i=m.sw_dTop-d,j=m.croperY,k=Math.abs(m.sw_dLeft-h),l=Math.abs(m.sw_dTop-j),n=Math.abs(m.sw_dLeft-e),o=Math.abs(m.sw_dTop-f);b.width(g>=e?c-2:e>=h?k-2:n-2),j>=f?(b.offset({top:j}),b.height(l-2)):f>=i?(b.offset({top:i}),b.height(d-2)):(b.offset({top:f}),b.height(o-2))}function A(a){var b=m.resizeItem,c=m.minWidth,d=m.minHeight,e=a.clientX-m.se_dX,f=a.clientY-m.se_dY,g=m.nw_dLeft+c,h=m.croperX+m.croperW,i=m.nw_dTop+d,j=m.croperY+m.croperH,k=Math.abs(m.nw_dLeft-h),l=Math.abs(m.nw_dTop-j),n=Math.abs(m.nw_dLeft-e),o=Math.abs(m.nw_dTop-f);b.width(g>=e?c-2:e>=h?k-2:n-2),b.height(i>=f?d-2:f>=j?l-2:o-2)}function B(a){var b=m.resizeItem,c=m.minWidth,d=m.minHeight,e=a.clientX-m.sw_dX,f=a.clientY-m.sw_dY,g=m.croperX,h=m.ne_dLeft-c,i=m.ne_dTop+d,j=m.croperY+m.croperH,k=Math.abs(m.ne_dLeft-g),l=Math.abs(m.ne_dTop-j),n=Math.abs(m.ne_dLeft-e),o=Math.abs(m.ne_dTop-f);g>=e?(b.offset({left:g}),b.width(k-2)):e>=h?(b.offset({left:h}),b.width(c-2)):(b.offset({left:e}),b.width(n-2)),b.height(i>=f?d-2:f>=j?l-2:o-2)}function C(){l=!1,d.unbind("mousemove",x)}});