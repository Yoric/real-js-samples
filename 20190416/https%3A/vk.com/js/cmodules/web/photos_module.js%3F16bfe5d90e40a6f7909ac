!function(e){var t={};function i(s){if(t[s])return t[s].exports;var o=t[s]={i:s,l:!1,exports:{}};return e[s].call(o.exports,o,o.exports,i),o.l=!0,o.exports}i.m=e,i.c=t,i.d=function(e,t,s){i.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:s})},i.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},i.t=function(e,t){if(1&t&&(e=i(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var s=Object.create(null);if(i.r(s),Object.defineProperty(s,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var o in e)i.d(s,o,function(t){return e[t]}.bind(null,o));return s},i.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return i.d(t,"a",t),t},i.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},i.p="",i(i.s=118)}({118:function(e,t,i){e.exports=i("Lrwn")},Lrwn:function(e,t,i){"use strict";function s(e){var t=cur.pvListId,i=cur.pvIndex;if(cur.pvData&&t&&!isNaN(i)){var s=cur.pvData[t][i];return e?s[e]:s}return!1}function o(e,t){var i=cur.pvListId,s=cur.pvIndex;return!(!cur.pvData||!i||isNaN(s))&&(cur.pvData[i][s][e]=t,cur.pvData[i][s])}function n(){return cur.pvIndexedFriends}i.r(t);var r=function(){return function(e,t){if(Array.isArray(e))return e;if(Symbol.iterator in Object(e))return function(e,t){var i=[],s=!0,o=!1,n=void 0;try{for(var r,a=e[Symbol.iterator]();!(s=(r=a.next()).done)&&(i.push(r.value),!t||i.length!==t);s=!0);}catch(e){o=!0,n=e}finally{try{!s&&a.return&&a.return()}finally{if(o)throw n}}return i}(e,t);throw new TypeError("Invalid attempt to destructure non-iterable instance")}}();var a="friends_dropdown__list_item",d="friends_dropdown__list_item system_message",h=function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.options=extend({onUserSelected:function(){return!1},onEscapePress:function(){return!1},onKeyUp:function(){return!1}},t),cur.pvServerFriendsIndex&&cur.pvServerFriendsIds||(cur.pvServerFriendsIndex=new vkIndexer([],function(e){var t=r(e,2);t[0];return t[1]}),cur.pvServerFriendsIds=[]),this.topUsers=new vkIndexer([],function(e){var t=r(e,2);t[0];return t[1]}),this.isInited=!1,this.lastSeachTerm="",this.hoverItem=null,this.keyboardNavigation=!1,this.freeTerm=null,this._handleInputKeyEvent=this._handleInputKeyEvent.bind(this),this._handleMouseMoveOnce=this._handleMouseMoveOnce.bind(this)}return e.prototype.init=function(){this.isInited&&this.friendsdListNode||(n()||this.fetchFriendsList(),this.isInited=!0,this._initElement(),this._initScroll());return this.friendsdListNode},e.prototype.update=function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[];this._resetScroll(),this.setTopUsers(e),this._hideDropdown()},e.prototype.setTopUsers=function(e){var t=this;this.topUsers.list.forEach(function(e){t.topUsers.remove(e)}),e.forEach(function(e){t.topUsers.add(e)}),this.topUsers.list=e},e.prototype._hideDropdown=function(){removeClass(this.friendsdListNode,"show-dropdown")},e.prototype._getItemHtml=function(e,t,i,s){return'<div class="'+a+'" data-id="'+e+'" data-name="'+t+'">\n      <img src="'+s+'" alt="'+t+'" class="friends_dropdown__list_image">\n      <div class="friends_dropdown__list_info">\n        <div class="friends_dropdown__list_name">'+t+" "+(e===vk.id.toString()?"("+getLang("photos_tags_user_you")+")":"")+'</div>\n        <div class="friends_dropdown__list_label">'+i+"</div>\n      </div>\n    </div>"},e.prototype._initElement=function(){var e=this;this.friendsdListNode=ce("div",{className:"friends_dropdown__list"}),this.listInput=ce("input",{className:"friends_dropdown__list_input",placeholder:""+replaceEntities(getLang("photos_tags_dropdown_placeholder"))}),this.listDropdown=ce("div",{className:"friends_dropdown__list_dropdown"}),this.listContent=ce("div",{className:"friends_dropdown__list_content"}),this.listDropdown.appendChild(this.listContent),this.friendsdListNode.appendChild(this.listInput),this.friendsdListNode.appendChild(this.listDropdown),this._setListHTML('<div class="'+d+'">'+getLang("box_loading")+"</div>"),addEvent(this.friendsdListNode,"click",cancelEvent),addEvent(this.listDropdown,"click",function(t){e._handleItemSelected(t.target)}),addEvent(this.listDropdown,"mouseover",function(t){if(!e.keyboardNavigation){var i=hasClass(t.target,a)?t.target:gpeByClass(a,t.target);e._setHoverItem(i)}}),addEvent(this.listInput,"keyup keydown keypress",this._handleInputKeyEvent),addEvent(this.listInput,"click",function(){e.show()})},e.prototype._handleItemSelected=function(e){var t=hasClass(e,a)?e:gpeByClass(a,e),i=domData(t,"name"),s=domData(t,"id");s&&this.options.onUserSelected(s,i),hasClass(e,"add_term_tag")&&this.freeTerm&&this.options.onUserSelected(0,this.freeTerm)},e.prototype._getItemEleById=function(e){return window.domQuery1('[data-id="'+e+'"]',this.listDropdown)},e.prototype._setListHTML=function(e){(this.listContent.__uiScroll__?this.listContent.__uiScroll__.content:this.listContent).innerHTML=e},e.prototype._setHoverItem=function(e){var t=arguments.length>1&&void 0!==arguments[1]&&arguments[1],i=domData(e,"id");if(i&&i!==this.hoverItem){if(this.hoverItem){var s=this._getItemEleById(this.hoverItem);removeClass(s,"hover")}this.hoverItem=i,addClass(e,"hover"),t&&this.scroll&&this.scroll&&this.scroll.scrollIntoView(e)}},e.prototype.show=function(e){hasClass(this.friendsdListNode,"show-dropdown")||(this._renderFriendsList(this.lastSeachTerm,e),addClass(this.friendsdListNode,"show-dropdown"),this._resetScroll(),this.scroll&&this.scroll.update())},e.prototype._renderFriendsList=function(e){var t=this,i=arguments.length>1&&void 0!==arguments[1]&&arguments[1];if(e=trim(e),n()){var s=this._doSearch(e);this._renderFriendsDropdown(e,s,i)}else this._setListHTML('<div class="'+d+'">'+getLang("box_loading")+"</div>");clearTimeout(this.requestTimeout),e.length>0&&e!==this.lastSeachTerm&&(this.requestTimeout=setTimeout(function(){t.fetchFriendsWithQuery(e)},300))},e.prototype._initScroll=function(){var e=this;browser.safari||stManager.add(["ui_common.css","ui_common.js"],function(){e.scroll=new window.uiScroll(e.listContent,{global:!0})})},e.prototype._handleInputKeyEvent=function(e){if("keyup"===e.type){switch(e.keyCode){case KEY.ENTER:this._handleEnter();break;case KEY.ESC:return this.options.onEscapePress(),void this._hideDropdown();default:var t=e&&e.target.value;t!==this.lastSeachTerm&&(this._renderFriendsList(t),this.lastSeachTerm=t,this.hoverItem=null)}this.options.onKeyUp(),this.show()}else switch(e.keyCode){case KEY.UP:case KEY.DOWN:this._handleArrows(e.keyCode===KEY.DOWN)}},e.prototype._handleArrows=function(){var e=!(arguments.length>0&&void 0!==arguments[0])||arguments[0],t=void 0,i=void 0;if(this.keyboardNavigation||(this.keyboardNavigation=!0,addEvent(this.listDropdown,"mousemove",this._handleMouseMoveOnce)),this.hoverItem)t=this._getItemEleById(this.hoverItem),i=e?domNS(t):domPS(t);else{var s=this.listContent.__uiScroll__?this.listContent.__uiScroll__.content:this.listContent;i=domFC(s)}i&&this._setHoverItem(i,!0)},e.prototype._handleMouseMoveOnce=function(){this.keyboardNavigation=!1,removeEvent(this.listDropdown,"mousemove",this._handleMouseMoveOnce)},e.prototype._handleEnter=function(){if(this.hoverItem){var e=this._getItemEleById(this.hoverItem);this._handleItemSelected(e)}},e.prototype._doSearch=function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"",t=void 0,i=s("tagged"),o=n(),a=void 0,d=void 0,h=void 0;e.length>0?(a=this.topUsers.search(e),d=o.search(e),h=cur.pvServerFriendsIndex.search(e)):(a=this.topUsers.list,d=o.list,h=cur.pvServerFriendsIndex.list);var l=[];return(t=(t=a.concat(d,h)).filter(function(e){var t=r(e,1)[0],s=l.indexOf(t)<0&&(!i||!i[t]);return l.push(t),s})).length>20&&(t=t.slice(0,20)),t},e.prototype._renderFriendsDropdown=function(e,t){var i=this,s=arguments.length>2&&void 0!==arguments[2]&&arguments[2],o="";if(t.forEach(function(e){var t=r(e,4),s=t[0],n=t[1],a=t[2],d=t[3],h="id"+s;o+=i._getItemHtml(s,n,a,d,h)}),!o&&s){this.freeTerm=e,e=clean(e);var n=getLang("photos_tags_not_found_tag_text").replace("{tagName}",'<span class="add_term_tag">'+e+"</span>");o='<div class="'+d+'">'+n+"</div>",this._setListHTML(o)}else o&&(this._setListHTML(o),this.freeTerm=null,this._resetScroll());this.hoverItem=null},e.prototype.focus=function(){this.listInput.focus()},e.prototype.reset=function(){this.listInput.value="",this.lastSeachTerm="",this.hoverItem=null,this._resetScroll()},e.prototype._resetScroll=function(){this.scroll?this.scroll.scrollTop():this.listContent.scrollTop=0},e.prototype.fetchFriendsList=function(){var e=this;ajax.post("hints.php",{act:"a_json_friends",from:"photo_tags"},{onDone:function(t){!function(e,t){cur.pvIndexedFriends=new vkIndexer(e,function(e){return e[1]},t)}(t,function(){e._renderFriendsList(e.lastSeachTerm)})}})},e.prototype.fetchFriendsWithQuery=function(e){var t=this;ajax.post("hints.php",{act:"a_json_friends",from:"photo_tags",str:e,photo:s("id")},{onDone:function(i){t._handleFetchFriends(e,i)}})},e.prototype._handleFetchFriends=function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[];if(this.lastSeachTerm===e){var i=0,o=void 0,n=s("tagged");(o=n?t.filter(function(e){var t=r(e,1)[0];return!n[t]}):t).forEach(function(e){var t=e[0];cur.pvServerFriendsIds.indexOf(t)<0&&(cur.pvServerFriendsIds.push(t),cur.pvServerFriendsIndex.add(e),i++)}),(i>0||0===o.length)&&this._renderFriendsList(e,!0)}},e}();var l=function(){function e(t){var i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.options=extend({closeOnClick:!0,resetDropdownOnShow:!0,onUserSelected:function(){return!1},onMouseLeave:function(){return!1},onEscapePressed:function(){return!1},onDeleteClicked:function(){return!1},onSuggestionDeclined:function(){return!1}},i),this.container=t,this.friendsDropdown=new h({onUserSelected:this._handleUserSelected.bind(this),onEscapePress:this._handleEscapePress.bind(this),onKeyUp:this._handleStartInteraction.bind(this)}),this.friendsDropdownNode=this.friendsDropdown.init(),this._handleConfirmedTooltipClick=this._handleConfirmedTooltipClick.bind(this),this._handleDocumentClick=this._handleDocumentClick.bind(this),this.renderTooltip()}return e.prototype.renderTooltip=function(){var e=this;this.tooltipNode=ce("div",{className:"photo_tooltip"},{display:"none"});var t=ce("div",{className:"photo_tooltip__content"});this.sugggestionNode=ce("div"),this.nameNode=ce("div",{className:"photo_tooltip__name"},{display:"none"}),this.listNode=ce("div",{className:"photo_tooltip__suggestion"}),this.listNode.appendChild(this.friendsDropdownNode),addEvent(this.nameNode,"click",this._handleConfirmedTooltipClick),t.appendChild(this.nameNode),t.appendChild(this.sugggestionNode),t.appendChild(this.listNode),this.tooltipNode.appendChild(t),this.container.appendChild(this.tooltipNode),addEvent(this.tooltipNode,"mouseenter",function(){e.isActive=!0}),addEvent(this.sugggestionNode,"click",function(t){switch(cancelEvent(t),window.domData(t.target,"button")){case"yes":e.options.onUserSelected(e.suggestedUserId,e.suggestedUserName,!0);break;case"no":e.options.onSuggestionDeclined(),hide(e.sugggestionNode),e.showFriendsList(),e.userHref=null,e.showAndFocusFriendsList()}}),addEvent(this.tooltipNode,"mouseleave",function(){e.interaction||(e.isActive=!1,e.options.onMouseLeave())}),this.options.closeOnClick&&addEvent(document,"click",this._handleDocumentClick)},e.prototype._handleDocumentClick=function(e){this.options.onMouseLeave(),this.interaction=!1,this.isActive=!1,this.hide()},e.prototype._handleUserSelected=function(e,t){this.isActive=!1,this.options.onUserSelected(e,t)},e.prototype._handleEscapePress=function(){this.isActive=!1,this.interaction=!1,this.friendsDropdown.reset(),this.options.onEscapePressed()},e.prototype._handleStartInteraction=function(){this.interaction=!0},e.prototype._handleConfirmedTooltipClick=function(e){cancelEvent(e),"button"===e.target.tagName.toLowerCase()?this.options.onDeleteClicked():this.userHref&&this._go(this.userHref,e)},e.prototype.updatePosition=function(e){var t=e.top,i=e.right,s=e.bottom,o=e.left,n=i-o,r=getSize(this.tooltipNode),a=r[0]?r[0]:280,d="bottom",h=o+Math.floor(n/2)-a/2,l=s;if((h<10||this.hasDropdown&&s>window.clientHeight()-300)&&(d="right_top"),"right_top"===d){h=i,l=t;var u=window.clientHeight()-t;u<300&&(l=t-300+u)}domData(this.tooltipNode,"dir",d),setStyle(this.tooltipNode,{top:l,left:h})},e.prototype.updateSuggestionQuestion=function(e,t){this.sugggestionNode.innerHTML=this._getSuggestionHTML(e,t),this.suggestedUserName=t,this.suggestedUserId=e},e.prototype._getSuggestionHTML=function(e,t){var i=e===vk.id?getLang("photos_tags_user_you"):t;return'<div class="suggested_tag_user">\n      '+getLang("photos_tags_suggestion_question").replace("{userName}",'<div class="suggested_tag_user__name">&nbsp;'+i+"</div>")+'\n      <div class="suggested_tag_user__actions">\n        <button data-button="yes" class="yes">'+getLang("box_yes")+'</button>\n        <span>&middot;</span>\n        <button data-button="no">'+getLang("box_no")+"</button>\n      </div>\n    </div>"},e.prototype.updateState=function(e){var t=e.suggestedUserName,i=e.suggestedUserId,s=e.usersList,o=e.userName,n=e.userHref,r=e.canDeleteTag;this.suggestedUserName=!1,this.suggestedUserId=!1,this.userHref=n,this.hasDropdown=!1,removeClass(this.tooltipNode,"tagged"),o?(this.nameNode.innerHTML=o+" "+(r?"<button>Delete</button>":""),toggleClass(this.nameNode,"show_delete",r),show(this.nameNode),hide(this.listNode),hide(this.sugggestionNode),addClass(this.tooltipNode,"tagged")):i?(this.updateSuggestionQuestion(i,t),hide(this.nameNode),hide(this.listNode),show(this.sugggestionNode)):(this.friendsDropdown.update(s),hide(this.nameNode),hide(this.sugggestionNode),this.showFriendsList(),this.hasDropdown=!0)},e.prototype.showFriendsList=function(){show(this.listNode),this.options.resetDropdownOnShow&&this.resetFriendsDropdown()},e.prototype.resetFriendsDropdown=function(){this.friendsDropdown.reset()},e.prototype.show=function(e){function t(t){return e.apply(this,arguments)}return t.toString=function(){return e.toString()},t}(function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},i=arguments.length>2&&void 0!==arguments[2]&&arguments[2];this.isActive=!1,this.interaction=!1,this.updateState(t),this.updatePosition(e),show(this.tooltipNode),i&&this.friendsDropdown.show(!0),this.friendsDropdown.focus()}),e.prototype.hide=function(e){function t(){return e.apply(this,arguments)}return t.toString=function(){return e.toString()},t}(function(){hide(this.tooltipNode)}),e.prototype.showAndFocusFriendsList=function(e){this.userHref?this._go(this.userHref,e):(this.friendsDropdown.focus(),this.friendsDropdown.show())},e.prototype.unMount=function(){removeEvent(document,"click",this._handleDocumentClick),re(this.tooltipNode)},e.prototype._go=function(e,t){t&&t.ctrlKey?window.open(e):nav.go(e,t)},e}(),u=function(){return function(e,t){if(Array.isArray(e))return e;if(Symbol.iterator in Object(e))return function(e,t){var i=[],s=!0,o=!1,n=void 0;try{for(var r,a=e[Symbol.iterator]();!(s=(r=a.next()).done)&&(i.push(r.value),!t||i.length!==t);s=!0);}catch(e){o=!0,n=e}finally{try{!s&&a.return&&a.return()}finally{if(o)throw n}}return i}(e,t);throw new TypeError("Invalid attempt to destructure non-iterable instance")}}();var c=window.getXYRect,p=function(){function e(t,i){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.imageNode=t,this.containerNode=i,this.activeAreaId=null,this.tagAreaFound=!1,this.areasHidden=!1,this.tooltipsPaused=!1,this._handleImageMouseMove=this._handleImageMouseMove.bind(this),this._handleAreaClick=this._handleAreaClick.bind(this),this._removeActiveAreaAfterTimeout=this._removeActiveAreaAfterTimeout.bind(this),this._queueCheckUpdates=this._queueCheckUpdates.bind(this),this._queueReceiveUpdates=this._queueReceiveUpdates.bind(this),this._userSelectedCallback=this._userSelectedCallback.bind(this),this._handleSuggestionDeclined=this._handleSuggestionDeclined.bind(this),this._updatePhotoView=this._updatePhotoView.bind(this),this.deleteTag=this.deleteTag.bind(this),this._init(),this._queueCheckUpdates()}return e.prototype._init=function(){this.photoTooltip=new l(window.layer,{onMouseLeave:this._removeActiveAreaAfterTimeout,onUserSelected:this._userSelectedCallback,onDeleteClicked:this.deleteTag,onEscapePressed:this._removeActiveAreaAfterTimeout,onSuggestionDeclined:this._handleSuggestionDeclined}),this.photoView=window.Photoview,this.areasContainer=ce("div",{className:"photo_tags_suggested_areas_list"}),this.containerNode.innerHTML="",this.containerNode.appendChild(this.areasContainer),addEvent(this.imageNode,"mousemove",this._handleImageMouseMove),addEvent(this.imageNode,"mouseleave",this._removeActiveAreaAfterTimeout),addEvent(this.imageNode,"mouseenter",this.showAllSuggestedAreas.bind(this)),addEvent(this.areasContainer,"mouseleave",this._removeActiveAreaAfterTimeout),addEvent(this.areasContainer,"click",this._handleAreaClick),this.renderTagAreas()},e.prototype._handleImageMouseMove=function(e){var t=this;if(!this.areasHidden){var i=getXY(e.target),s=Math.round(100*(e.pageX-i[0])/e.target.offsetWidth),o=Math.round(100*(e.pageY-i[1])/e.target.offsetHeight);for(var n in clearTimeout(this.areasTimeOut),this.areasTimeOut=setTimeout(function(){t.photoTooltip.isActive||t.activeAreaId||t.hideAllSuggestedAreas()},700),this.showAllSuggestedAreas(),this.areas)if(this.areas.hasOwnProperty(n)){var r=this.areas[n],a=r.x,d=r.y,h=r.x2,l=r.y2;if(s>parseInt(a)&&s<parseInt(h)&&o>parseInt(d)&&o<parseInt(l)){if(n===this.activeAreaId)return void(this.tagAreaFound=!0);if(this.tagAreaFound=this.showTagArea(n),this.tagAreaFound)return}}this.tagAreaFound=!1,this._removeActiveAreaAfterTimeout()}},e.prototype._handleAreaClick=function(e){cancelEvent(e),this.photoTooltip.showAndFocusFriendsList(e)},e.prototype.showTagArea=function(e){var t=this.areas[e];return!(!t||t.isDeleted)&&(null!==this.activeAreaId&&this.areas[this.activeAreaId]&&removeClass(this.areas[this.activeAreaId].ele,"active"),this.activeAreaId=e,addClass(this.areas[e].ele,"active"),this.showTooltip(e),this.showAllSuggestedAreas(),!0)},e.prototype.hideTagArea=function(){clearTimeout(this.waitTimeout),null!==this.activeAreaId&&this.areas[this.activeAreaId]&&removeClass(this.areas[this.activeAreaId].ele,"active"),this.activeAreaId=null,this.photoTooltip.hide(),this.hideAllSuggestedAreas()},e.prototype._removeActiveAreaAfterTimeout=function(){var e=this,t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:500;this.activeAreaId&&!this.waitToRemove&&(this.waitToRemove=!0,clearTimeout(this.waitTimeout),this.waitTimeout=setTimeout(function(){!e.photoTooltip.isActive&&!e.tagAreaFound&&!e.photoTooltip.interaction&&e.hideTagArea(),e.waitToRemove=!1},t))},e.prototype.showTooltip=function(e){if(!this.tooltipsPaused){var t=this.areas[e].ele,i=this._getTooltipOptions(e);if(t){var s=c(t,!0),o=s.top,n=s.right,r=s.bottom,a=s.left;this.photoTooltip.show({top:o,right:n,bottom:r,left:a},i)}}},e.prototype.showAllSuggestedAreas=function(){addClass(this.areasContainer,"visible_all"),removeClass(this.areasContainer,"area_hover"),this.activeAreaId&&addClass(this.areasContainer,"area_hover")},e.prototype.hideAllSuggestedAreas=function(){removeClass(this.areasContainer,"visible_all")},e.prototype.pauseTooltips=function(){this.hideTagArea(),this.tooltipsPaused=!0},e.prototype.resumeTooltips=function(){this.tooltipsPaused=!1},e.prototype._createTagElement=function(e,t,i,s){var o=cur.pvPhWidth,n=cur.pvPhHeight/o,r=i-e,a=s-t,d=ce("div",{className:"photo_tags_suggested_area"},{left:e+"%",marginTop:n*t+"%",width:r+"%"}),h=ce("div",{},{paddingBottom:100*n*(a/r)+"%"});return d.appendChild(h),d},e.prototype.renderTagAreas=function(){this.areas={},this.areasContainer.innerHTML="";var e=s("tags"),t=s("suggested_tags");for(var i in cur.postTo&&cur.postTo<0&&(t=[]),e)if("0"!==i&&e.hasOwnProperty(i)){var o=u(e[i],7),n=o[0],r=o[1],a=o[2],d=o[3],h=o[4],l=o[5],c=o[6],p=this._createTagElement(n,r,a,d);this.areas[i]={ele:p,x:n,y:r,x2:a,y2:d,userName:h,userHref:l,canDeleteTag:Boolean(c),confirmedTag:!1},this.areasContainer.appendChild(p)}for(var g in t)if(g&&t.hasOwnProperty(g)){var v=u(t[g],7),f=v[0],_=v[1],m=v[2],w=v[3],y=v[4],T=v[5],A=v[6],I=this._createTagElement(f,_,m,w),N=void 0;y&&(N="/id"+y),this.areas[g]={ele:I,x:f,y:_,x2:m,y2:w,userHref:N,suggestedUserId:y,suggestedUserName:T,usersList:A,confirmedTag:!1},this.areasContainer.appendChild(I)}},e.prototype._userSelectedCallback=function(e,t){var i=this,o=arguments.length>2&&void 0!==arguments[2]&&arguments[2],n=s("tags"),r=s("suggested_tags"),a=this.activeAreaId,d=this.areas[a],h=d.x,l=d.y,u=d.x2,c=d.y2,p="/id"+e,g=cur.pvAskForAutoTag&&o,v=clean(t);n[a]=[h,l,u,c,v,p,!0],delete r[a];var f={suggestedUserId:!1,suggestedUserName:!1,usersList:[],userId:e,userName:v,userHref:p,canDeleteTag:!0},_=this.activeAreaId;this._confirmSuggestedTag(a,e,t,function(){i.activeAreaId=_,i.areas[_]=extend(d,f),i.photoTooltip.updateState(f),i.showTagArea(_),i._removeActiveAreaAfterTimeout(1e3),g&&(cur.pvAskForAutoTag=!1,i.showSettingsBox())})},e.prototype.showSettingsBox=function(){showBox("/al_photos.php",{act:"show_autotag_settings"},{params:{containerClass:"autotag_settings_box",grey:!0,width:450}})},e.prototype.deleteTag=function(e){e||(e=this.activeAreaId,this.photoView.deleteTag(e)),this.hideTagArea();var t=this.areas[e];e&&t&&(t=extend(t,{isDeleted:!0}),addClass(t.ele,"deleted"))},e.prototype._getTooltipOptions=function(e){var t=this.areas[e],i=t.suggestedUserId,s=t.suggestedUserName;return{suggestedUserId:i,userName:t.userName,userHref:t.userHref,suggestedUserName:s,usersList:t.usersList,canDeleteTag:t.canDeleteTag}},e.prototype._handleSuggestionDeclined=function(){var e=this.activeAreaId,t=this.areas[e];if(t){var i=s("suggested_tags");this.areas[e]=extend(t,{suggestedUserId:!1,suggestedUserName:!1,userHref:null}),this.showTagArea(e),i&&i[e]&&(i[e][4]=0);var o=s("id"),n=s("hash");ajax.post("al_photos.php",{act:"decline_suggested_tag",tag:e,photo:o,hash:n},{onFail:this.handleTagRequestFail})}},e.prototype._confirmSuggestedTag=function(e,t,i,o){var n=this,r=s("id"),a=s("hash");ajax.post("al_photos.php",{act:"confirm_suggested_tag",tag:e,tagged_id:t,name:i,photo:r,hash:a},{onDone:function(e,t,i){n._updatePhotoView(e,t,i),o()},onFail:this.handleTagRequestFail})},e.prototype.handleTagRequestFail=function(e){var t=getLang("global_error");return setTimeout(showFastBox(t,e).hide,3e3),!0},e.prototype.unMount=function(){removeEvent(this.imageNode,"mousemove",this._handleImageMouseMove),removeEvent(this.areasContainer,"click",this._handleAreaClick),this.containerNode.innerHTML=""},e.prototype.hideAreas=function(){this.areasHidden=!0,hide(this.areasContainer),this.photoTooltip.hide()},e.prototype.showAreas=function(){this.areasHidden=!1,show(this.areasContainer),removeEvent(this.imageNode,"mousemove",this._handleImageMouseMove),addEvent(this.imageNode,"mousemove",this._handleImageMouseMove)},e.prototype.reload=function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null;this.hideTagArea(),this.resumeTooltips(),this.renderTagAreas(),e&&(this.imageNode=e),this.activeAreaId=null,this.waitToRemove=null,this.tagAreaFound=!1,this.areasHidden=!1,this.tooltipsPaused=!1,this.showAreas()},e.prototype._queueCheckUpdates=function(){cur.pvTagsQueueParams&&window.Notifier&&Notifier.addKey(cur.pvTagsQueueParams,this._queueReceiveUpdates)},e.prototype._updatePhotoView=function(e,t,i){o("tags",e),o("tagged",t),o("tagshtml",i),this.photoView.setTags(i)},e.prototype._queueReceiveUpdates=function(e,t){var i=this;t.events&&t.events.forEach(function(e){var t=e.split("<!>"),n=t[1],r=t[2],a=JSON.parse(r),d=JSON.parse(t[3]),h=JSON.parse(t[4]),l=t[5];if(s("id")===n)o("suggested_tags",a),i._updatePhotoView(d,h,l),i.renderTagAreas();else if(cur.pvData){var u=function(e){if(cur.pvData.hasOwnProperty(e)){var t=cur.pvData[e];t.length&&t.forEach(function(t,i){if(t.id&&t.id===n){var s=cur.pvData[e][i];s.suggested_tags=a,s.tags=d,s.tagged=h,s.tagshtml=l}})}};for(var c in cur.pvData)u(c)}})},e}();window.PhotoTags=p,window.PhotoTooltip=l;try{stManager.done(jsc("web/photos_module.js"))}catch(e){}}});