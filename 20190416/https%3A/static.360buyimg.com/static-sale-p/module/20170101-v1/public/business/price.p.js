define("public/business/price.p",["public/business/partition/partition","public/business/goodsBelt"],function(require,exports,module){var autoPartition=require("public/business/partition/partition"),Belt=require("public/business/goodsBelt");window.jshop=jshop||{},jshop.component=jshop.component||{},window.skuIdPriceObj={},function(w){function _get_nodes(){nodes=jQuery(param.tagAttr)}function _load(){_get_nodes(),nodesShow=[];for(var e=_window.scrollTop(),t=_window.height(),i=e?Math.floor(e-t/4):0,r=e?Math.floor(e+1.5*t):t,p=0,o=nodes.length;p<o;p++){var a=jQuery(nodes[p]),n=a.offset().top;0===a.html().length&&a.html("&nbsp;"),n<r&&n>i&&a.is(":visible")&&(nodesShow.push(nodes[p]),a.removeAttr(param.attrName))}jQuery.when(autoPartition({skuIds:nodesShow})).done(function(e){getSkuid(e),getData()})}function getSkuid(e){if(skuCurrent=[],e&&e.length>0)for(var t=0;e[t];t++)e[t].realSkuId?skuCurrent.push(e[t].realSkuId):skuCurrent.push(e[t].goodsId);else for(var t=0;nodesShow[t];t++)for(var i=0;aPriceType[i];i++)jQuery(nodesShow[t]).attr(aPriceType[i])&&skuCurrent.push(jQuery(nodesShow[t]).attr(aPriceType[i]));skuCurrent=skuCurrent.unique()}function getData(){for(var e=Math.ceil(skuCurrent.length/param.maxCount),t=0;t<e;t++){var i,r,r;!function(){function e(e,t){for(var i=0,r=t.length;i<r;i++)if(e==t[i])return!0;return!1}if(i=skuCurrent.slice(t*param.maxCount,Math.min(skuCurrent.length,(t+1)*param.maxCount)),skuidStr="","yhd"===$("#JSHOP_CHANNEL_FLAG").val())for(r=0;i[r];r++)skuidStr+=i[r]+",";else for(r=0;i[r];r++)skuidStr+="J_"+i[r]+",";!function(t){var r=$.Deferred();"yhd"===$("#JSHOP_CHANNEL_FLAG").val()?jQuery.ajax({url:"//pyhd.3.cn/prices/mgets",data:{skuids:skuidStr,area:CookieUtil.getCookie("ipLoc-djd")?CookieUtil.getCookie("ipLoc-djd").replace(/-/g,"_"):"",source:"jshopact",ext:1e7,origin:8},dataType:"jsonp",success:function(e){r.resolve(e),callBackPriceService(e)},error:function(){r.resolve([])}}):jQuery.ajax({url:INTERFACE.price.jd,data:{skuids:skuidStr,area:CookieUtil.getCookie("ipLoc-djd")?CookieUtil.getCookie("ipLoc-djd").replace(/-/g,"_"):"",pin:CookieUtil.getCookie("pin")?encodeURI(CookieUtil.getCookie("pin")):"",source:"jshop",ext:11e6},dataType:"jsonp",success:function(e){r.resolve(e),callBackPriceService(e)},error:function(){r.resolve([])}});var p=Belt.getBelt(nodesShow.filter(function(t,r){return e($(t).attr("jdprice"),i)}));$.when(r,p).done(Belt.processBeltAdvance)}()}()}}function _event_register(){var e=0;_window.bind("scroll resize",function(){clearTimeout(e),e=setTimeout(_load,150)})}function _init(){_load(),_event_register();var e=0;_window.bind("mousemove",function(){clearTimeout(e),e=setTimeout(_load,100)}),_window.bind("click",_load)}function callBackPriceService(e){for(var t=0,i=e.length;t<i;t++){var r;r="yhd"===$("#JSHOP_CHANNEL_FLAG").val()?e[t].id:e[t].id.substr(2),e[t].id=r,p.getNumPriceService(e[t])}}var param={tagAttr:'[jshop="price"]',attrName:"jshop",jsprice:"jsprice",jdprice:"jdprice",jspprice:"jspprice",jppprice:"jppprice",jtppprice:"jtppprice",jtkpprice:"jtkpprice",jprice:"jprice",jopprice:"jopprice",discountRate:"dsaleprice",maxCount:10},aPriceType=["jsprice","jdprice","jspprice","jppprice","jtppprice","jtkpprice","jprice"],nodes=[],skuidStr="",nodesShow=[],skuCurrent=[],_window=jQuery(window),p={};p.JD_price={_get_discount:function(e,t){if(void 0!==e&&void 0!==t){if(e=parseFloat(e),t=parseFloat(t),!e||!t)return"";var i=Math.ceil(100*parseFloat(t/e).toFixed(15));return i?parseFloat(i/10):""}},_set_jd_price:function _set_jd_price(data,tag){function putSoldOutBehind(data){var node=jQuery("["+param.jdprice+"="+data.id+"]");node.each(function(){var item=$(this).closest("li"),ul=item.parent("ul");if(item&&ul&&"UserDefine"!=ul.closest("div[module-name]").attr("module-name")){ul.append(item);var module=item.closest(".j-module"),_param={},func=module.attr("data-function");if(void 0!==func){var funcs=func.split(",");try{_param=eval("("+module.attr("module-param")+")")}catch(e){_param={}}$.inArray("autoFill",funcs)>=0&&jshop.module.autoFill.call(module,_param),$.inArray("autoQuene",funcs)>=0&&jshop.module.autoQuene.call(module,_param)}}})}var _price=data.p>=0?data.p:tag;jQuery("["+param.jdprice+"="+data.id+"]").each(function(e,t){jQuery(t).html(_price)}),data.p<0&&(p.JD_price._set_sold_out(data,param.jdprice),putSoldOutBehind(data))},_set_sale_price:function(e,t){var i=e.m>=0?e.m:t;$("["+param.jsprice+"="+e.id+"]").each(function(e,t){$(t).html(i)})},_set_op_price:function(e,t){var i=e.op>=0?e.op:t;$("["+param.jopprice+"="+e.id+"]").each(function(e,t){$(t).html(i)})},_set_discount_sale_price:function(e){var t=e.p>=0?e.p:0,i=e.m>=0?e.m:0;$("["+param.discountRate+"="+e.id+"]").each(function(e,r){$(r).html(p.JD_price._get_discount(i,t))})},_set_sold_out:function(e,t){0==jQuery("#J_styleSoldOut").length&&jQuery("body").append('<style id="J_styleSoldOut">.d-soldout{display:block; top:0; height:100%; position:absolute; left:0; width:100%; -webkit-transition: all .2s ease-out; -moz-transition: all .2s ease-out; -ms-transition: all .2s ease-out; -o-transition: all .2s ease-out; transition: all .2s ease-out;}.d-soldout .d-soldout-bg{height: 100%; opacity: .4; filter: alpha(opacity=40); position: absolute; left: 0; top: 0; z-index: 1; width: 100%; background: #000;}.d-soldout b{background: url(//img10.360buyimg.com/cms/jfs/t2977/349/2488392477/6460/7b22cb4c/57b136c4N366eaa28.png) no-repeat;position: absolute; left: 50%; top: 50%; z-index: 2; width: 160px; height: 160px; margin-left: -80px; margin-top: -80px;}.d-sold-out .d-stock{display:none;}</style>'),jQuery("["+t+"="+e.id+"]").each(function(e,t){var i=jQuery(t).closest("li");"PromptRecommend"!=i.closest("[module-name]").attr("module-name")&&(i.data("isSold")||("static"==i.css("position")&&i.css("position","relative"),i.append('<div class="d-soldout"><a href="#" target="_blank"><span class="d-soldout-bg"></span><b></b></a></div>'.replace(/#/,i.find("a").attr("href"))).data("isSold",!0).addClass("d-sold-out")))})},_remove_goods:function(e){var t=e.closest("li"),i=t.closest("ul");t.remove(),i.find("li").length<2&&i.html("")},_remove_lists:function(e){var t=e.closest("ul");t.find("li").length<2&&t.html("")},_set_sp_price:function(e,t){var i=e.sp>=0?e.sp:t;$("["+param.jspprice+"="+e.id+"]").each(function(e,t){$(t).html(i)})},_set_pp_price:function(e,t){var i=e.tpp>=0?e.tpp:e.pp>=0?e.pp:t;$("["+param.jppprice+"="+e.id+"]").each(function(e,t){$(t).html(i)});var r=location.href;11!==returnUrlType(r)&&(e.tpp||e.pp||p.JD_price._remove_goods($("["+param.jppprice+"="+e.id+"]")),p.JD_price._remove_lists($("["+param.jppprice+"="+e.id+"]")))},_set_tpp_price:function(e,t){var i=e.tpp>=0?e.tpp:e.pp>=0?e.pp:t;$("["+param.jtppprice+"="+e.id+"]").each(function(e,t){$(t).html(i)});var r=location.href;11!==returnUrlType(r)&&(e.tpp||e.pp||p.JD_price._remove_goods($("["+param.jtppprice+"="+e.id+"]")),p.JD_price._remove_lists($("["+param.jtppprice+"="+e.id+"]")))},_set_tkp_price:function(e,t){var i="",r="";e.tkp&&e.tkp>=0?(i=e.tkp,r=param.jtkpprice):e.p>=0?(i=e.p,r=param.jdprice):i=t,$("["+param.jtkpprice+"="+e.id+"]").each(function(e,t){$(t).html(i).attr("data-price",r)})},_set_p3_price:function(e,t){var i="",r="";e.up?(e.up=e.up.split(",")[0],i=e[e.up]>=0?e[e.up]:t,r=e.up):(i=e.p>=0?e.p:t,r="p"),$("["+param.jprice+"="+e.id+"]").each(function(e,t){$(t).html(i).attr("data-price",r)}),i==t&&p.JD_price._set_sold_out(e,param.jprice)}},p.getNumPriceService=function(e){if(e){jQuery("["+param.jdprice+"]").length>0&&p.JD_price._set_jd_price(e,"暂无定价"),jQuery("["+param.jsprice+"]").length>0&&p.JD_price._set_sale_price(e,"暂无定价"),jQuery("["+param.discountRate+"]").length>0&&p.JD_price._set_discount_sale_price(e),jQuery("["+param.jspprice+"]").length>0&&p.JD_price._set_sp_price(e,"暂无定价"),jQuery("["+param.jppprice+"]").length>0&&p.JD_price._set_pp_price(e,"暂无定价"),jQuery("["+param.jtppprice+"]").length>0&&p.JD_price._set_tpp_price(e,"暂无定价"),jQuery("["+param.jtkpprice+"]").length>0&&p.JD_price._set_tkp_price(e,"暂无定价"),jQuery("["+param.jprice+"]").length>0&&p.JD_price._set_p3_price(e,"暂无定价"),jQuery("["+param.jopprice+"]").length>0&&p.JD_price._set_op_price(e,"暂无定价")}},w.moduleRefreshP=function(e){if(e&&e.length){"string"==typeof e&&(e=jQuery(e));var t=e.find(param.tagAttr);t.length&&(nodesShow=t,getData())}},jQuery(function(){_init()})}(window),jshop.component.getPrice=skuIdPriceObj.localPriceRefresh=function(e){window.moduleRefreshP&&moduleRefreshP(e)}});