/*!Name: ebook.js
 * Date: 2019-4-4 18:53:50 */
define("MOD_ROOT/ebook/ebook",function(require,exports,module){var o=require("MOD_ROOT/common/core"),e=require("MOD_ROOT/common/tools/event").Event;require("JDF_UI/dialog/1.0.0/dialog");function n(){$.ajax({url:"//gw-e.jd.com/shoppingCart/shoppingCart_shoppingCart.action",data:{pin:readCookie("pin")},dataType:"jsonp",cache:!0,success:function(o){0==o.code&&o.result.map.result&&o.result.map.result.count&&$("#ebook-cart .cw-icon").append('<i class="ci-count" id="ebook-cart-amount">'+o.result.map.result.count+"</i>")}})}function t(o){var e=o.cat,n=[o.skuid];o.bookCode&&n.push(o.bookCode),d({skus:n},function(n){if($.isArray(n))for(var t=0,a=n.length;t<a;t++){var c=n[t],r=c.id?c.id.split("_").pop():0;if(r==o.skuid){var d=+c.p;if(5272!=e[0]||10941!=e[1]&&14155!=e[1])0===d?($(".J-summary-price .p-price span").html(""),$(".J-summary-price .p-price .price").html("\u514d\u8d39")):i(o,d);else{var s='<em style="color:#e4393c;">\xa5 </em><span style="color:#e4393c;font-size:16px;">0.05/\u5343\u5b57</span>';$(".J-summary-price .p-price").html(s),$(".extra .p-info .p-price").html(s)}0===d?($("#J_read").show(),$("#InitCartUrl, #InitCartUrl-mini").remove(),$("#btn-buynow").remove(),$("#J_freeTxt").show()):($("#J_read").remove(),$("#InitCartUrl, #InitCartUrl-mini").show(),$("#btn-buynow").show(),$("#J_jingDouTxt").show())}else r==o.bookCode&&($(".J-original-price .del-price").html("<span>\uffe5</span>"+c.m),$(".J-original-price").show())}})}function i(o,e){$.ajax({url:"//gw-e.jd.com/forBookCode/forBookCode_getEbookInFoAndOrginPrices4JSONP.action?bookCodes="+o.skuid,dataType:"jsonp",scriptCharset:"utf-8",success:function(o){var n=$(".J-summary-price .p-price"),t=o.result.resultList;if(t.length){var i=t[0].jdPrice;e<i&&e>0?($(".J-prom-price .p-price .price").html(e),n.find(".price").html(i.toFixed(2)),$(".J-summary-price .p-price").addClass("del"),$(".J-prom-price").show()):$(".J-summary-price .p-price .price").html(i.toFixed(2))}}})}function a(e){$("#InitCartUrl, #InitCartUrl-mini").click(function(){location.href=e.buyurl});var n=$("#J_read");n.length>0&&n.click(function(){r(e)});var t=$("#btn-onlineread");t.length>0&&t.click(function(){c(e)});var i=$("#btn-buynow");i.length>0&&i.click(function(){location.href=e.buynowlink}),o.wideVersion||$(".download").hover(function(){$(this).addClass("download-hover")},function(){$(this).removeClass("download-hover")})}function c(o){seajs.use("jdf/1.0.0/unit/login/1.0.0/login.js",function(e){e({modal:!0,complete:function(e){var n;null!=e&&null!=e.Identity.IsAuthenticated&&e.Identity.IsAuthenticated&&$.ajax({url:"//cread.jd.com/openread/openRead.action",data:{bookId:o.skuid,readType:0},dataType:"jsonp",success:function(e){null!=e.code&&"0"==e.code?location.href="https://cread.jd.com/read/startRead.action?bookId="+o.skuid+"&readType=0":n=$("body").dialog({width:442,height:120,title:"\u6e29\u99a8\u63d0\u793a",type:"html",source:'        <div class="bookLayer">            <p>\u5f88\u9057\u61be\uff0c\u60a8\u76ee\u524d\u6ca1\u6709\u53ef\u7528\u7684\u201c\u7545\u8bfbVIP\u201d\u670d\u52a1</p>            <div class="btn-wrap">                <a href="//sale.jd.com/act/MypqiIJPYx.html" class="red" target="_blank">\u7acb\u5373\u5f00\u901a\u7545\u8bfb</a>                <a class="cancel-btn" href="javascript:;">\u6682\u4e0d\u5f00\u901a</a>            </div>        </div>',onReady:function(){$(".bookLayer").find(".cancel-btn").click(function(){n.close()})}})}})}})})}function r(o){seajs.use("jdf/1.0.0/unit/login/1.0.0/login.js",function(e){e({modal:!0,complete:function(e){null!=e&&null!=e.Identity.IsAuthenticated&&e.Identity.IsAuthenticated&&$.ajax({url:"//gw-e.jd.com/downrecord/downrecord_insert.action?ebookId="+o.skuid,dataType:"jsonp",cache:!0,success:function(e){1==e.code?location.href="https://cread.jd.com/read/startRead.action?bookId="+o.skuid+"&readType=3":0==e.code&&alert("\u7cfb\u7edf\u9519\u8bef\uff0c\u7a0d\u540e\u518d\u8bd5")}})}})})}function d(o,e){var n=o.skus||[],t=o.$el||$("body"),i=o.selector||".J-p-",a=o.text||"\uffe5{NUM}";function c(){var o=readCookie("__jda"),e="";return o&&o.indexOf(".")>-1&&(e=o.split(".")[1]),e}$.ajax({url:"//p.3.cn/prices/mgets",data:{skuids:"J_"+n.join(",J_"),type:2,pdtk:readCookie("pdtk")||"",pduid:c,pdpin:readCookie("pin")||"",pdbp:0},dataType:"jsonp",cache:!0,success:function(o){if($.isArray(o))for(var n=0,c=o.length;n<c;n++)if(o[n].id){var r=o[n].id.replace("J_",""),d=parseFloat(o[n].p);d>0?t.find(i+r).html(a.replace("{NUM}",o[n].p)):t.find(i+r).html("\u514d\u8d39")}"function"==typeof e&&e(o)}})}function s(){var o=["0_0_8249","0_0_8250"];$.ajax({url:"//nfa.jd.com/loadFa_toJson.js?aid="+o.join("-")+"&ver=20131107",dataType:"script",cache:!0,success:function(){}})}function l(o){$.ajax({url:"//gw-e.jd.com/client.action?functionId=getScanDesc&body={ebookId:"+o.skuid+",sourceType:0}",dataType:"jsonp",cache:!0,success:function(o){0==o.resultCode&&($(".download .download-qrcode-tit h3").html(o.map.scanBook.scanTypeStr),$(".download .qr-code p").html(o.map.scanBook.scanDesc))}})}function p(o){e.addListener("onStockReady",function(){t(o)}),n(),a(o),s(),l(o)}module.exports.__id="ebook",module.exports.init=p,module.exports.priceNum=d});
