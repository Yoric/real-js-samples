/* sohutv 2017-08-29 17:56:21 */
!function(){function e(e){try{return}catch(n){}}this.dolphin=this.dolphin||{},dolphin.DefaultMessage=function(n){e("call default function, please init your 'message' function.")},dolphin.Transport=function(e,n,t){this.config=dolphin["extends"](e),this.handleMessage=n,this.retryConnect=t},dolphin.Transport.prototype.connect=function(){return!1},dolphin.Transport.prototype.reconnect=function(){e("fire transport close"),this.retryConnect()},dolphin["extends"]=function(e){function n(){}return n.prototype=e,new n},dolphin.WebSocketTransport=function(n){_self=dolphin["extends"](n);var t,o=_self.config.url,r=function(){e("call heartbeat"),t=setInterval(function(){e("trigger heartbeatInterval"),_self.ws.send(_self.config.heartbeat())},_self.config.timeout)};return _self.connect=function(){e("connect to "+o);var n=new WebSocket(o);_self.ws=n;var s=setTimeout(function(){e("Socket connection timeout readyState:%d",n.readyState),n.close()},_self.config.connect_timeout);n.onopen=function(){s&&clearTimeout(s),e("WebSocket connect success."),n.send(_self.config.handshake())},n.onerror=function(n){e("fire ws.onerror")},n.onclose=function(){t&&clearInterval(t),s&&clearTimeout(s),e("WebSocket connection close",n.readyState),_self.reconnect()},n.onmessage=function(e){if(e&&e.data){var t=JSON.parse(e.data),o=_self.handleMessage(t);if(o==dolphin.Operation.OP_HANDSHAKE_REPLY&&r(),dolphin.isOpSuccess(o))return}n.close()}},_self},dolphin.isOpSuccess=function(e){return e!=dolphin.Operation.OP_SYSTEM_ERROR&&e!=dolphin.Operation.OP_DISCONNECT&&e!=dolphin.Operation.OP_DISCONNECT_REPLY},dolphin.JsonpPollingTransport=function(n){_self=dolphin["extends"](n);var t=_self.config.url.replace(/^http:/,""),o=0;_self.active=function(){o=(new Date).valueOf()},_self.connect=function(){e("connect to "+t),i(_self.config.handshake(),_self.config.connect_timeout)};var r=function(e){dolphin.isOpSuccess(e)?setTimeout(s,_self.config.delay):_self.reconnect()},s=function(){i(_self.config.heartbeat())},i=function(n,o){$.jsonp({url:t,timeout:o,data:"message="+n,callback:"helloworld",callbackParameter:"callback",success:function(n){e("call jsonp success"),n&&(r(_self.handleMessage(n)),e("jsonp success result"))},error:function(n,t,o){e("jsonp error"),r(dolphin.Operation.OP_SYSTEM_ERROR)}})};return _self},dolphin.Operation={OP_SYSTEM_ERROR:0,OP_HANDSHAKE:1,OP_HANDSHAKE_REPLY:2,OP_PING:3,OP_PONG:4,OP_DISCONNECT:5,OP_DISCONNECT_REPLY:6,OP_SEND_SMS:20,OP_SEND_SMS_REPLY:21},dolphin.MyMessage=function(n){var t={channel:"/p/",message:dolphin.DefaultReceive,passport:"",token:"",debug:!0,connect_timeout:2e3,delay:3e3,router:"http://127.0.0.1:9001/private/api/router.do"};this.config=n||{},this.config.channel=this.config.channel||t.channel,this.config.message=this.config.message||t.message,this.config.passport=this.config.passport||t.passport,this.config.token=this.config.token||t.token,this.config.debug=this.config.debug||t.debug,this.config.delay=this.config.delay||t.delay,this.config.connect_timeout=this.config.connect_timeout||t.connect_timeout,this.config.router=this.config.router||t.router;var o,r,s=this,c=1,a="",l=!1,p=[];this.config.handshake=function(){return JSON.stringify({ver:1,op:dolphin.Operation.OP_HANDSHAKE,seq:c,ch:o,data:{passport:s.config.passport,token:s.config.token}})},this.config.heartbeat=function(){return JSON.stringify({ver:1,op:dolphin.Operation.OP_PING,seq:c,ch:o,data:{clid:a}})},this.handle=function(n){var t=dolphin.Operation.OP_SYSTEM_ERROR;if(n&&n.length){c++;for(i in n){if(!(n[i]&&n[i].op>dolphin.Operation.OP_SYSTEM_ERROR&&n[i].data))break;var o=[];switch(t=n[i].op,n[i].op){case dolphin.Operation.OP_HANDSHAKE_REPLY:e("receive handshake message"),a=n[i].data.clid;break;case dolphin.Operation.OP_PONG:e("receive pong message");break;case dolphin.Operation.OP_SEND_SMS_REPLY:o.push(n[i].data);break;case dolphin.Operation.OP_DISCONNECT_REPLY:e("receive disconnect message");break;default:e("ignore op:%d, data:%s",n[i].op,n[i].data)}var r=s.config.message;r&&o.length&&(e("receive push message"),r(o))}}return t},this.retry=function(){l&&(e((new Date).getTime()),r=setTimeout(s.current_transport.connect,1e4))};var f=function(){c=1,a=0,r&&clearTimeout(r)};this.stop=function(){l&&(l=!1,f())};this.start=function(){l||(u={},this.callRouter())};var u={};this.browserTransport=function(){return{websocket:!1,jsonp:!0}},this.getCurrentTransport=function(n){l=!0,n&&n.num?(e("get serverTrans success"),s.current_transport=s.getAllowTransport(),e("start message %s"),s.current_transport.connect()):e("get serverTrans fail")},this.getAllowTransport=function(){var e=s.browserTransport();if(e.websocket&&u.websocket){var n=dolphin["extends"](s.config);n.url=u.websocket.url,o=u.websocket.ch,n.server=u.websocket.server,n.timeout=u.websocket.timeout,n.transport=u.websocket.transport,transport=new dolphin.Transport(n,s.handle,s.retry),p.push(new dolphin.WebSocketTransport(transport))}if(e.jsonp&&u.jsonp){var n=dolphin["extends"](s.config);n.url=u.jsonp.url,o=u.jsonp.ch,n.server=u.jsonp.server,n.timeout=u.jsonp.timeout,n.transport=u.jsonp.transport,transport=new dolphin.Transport(n,s.handle,s.retry),p.push(new dolphin.JsonpPollingTransport(transport))}return p[0]},this.callRouter=function(){$.jsonp({url:s.config.router,timeout:s.config.connect_timeout,data:"passport="+s.config.passport+"&token="+s.config.token+"&ch="+s.config.channel,callback:"hello",callbackParameter:"callback",success:function(n){if(e("get router success"),n&&n.length){for(i in n)u[n[i].transport]=n[i],u.num=i;s.getCurrentTransport(u)}},error:function(n,t,o){e("get router failed")}})}}}();