/* sohutv 2018-04-03 12:10:15 */
!function(){var t=kao.EventEmitter;sohuHD.namespace("sohuHD.wemedia.rssutil"),sohuHD.extend(sohuHD.wemedia.rssutil,{subUrl:"//push.my.tv.sohu.com/user/a/fo/batchadd.do?callback=?",unsubUrl:"//push.my.tv.sohu.com/user/a/fo/batchcancel.do?callback=?",checkUrl:"//push.my.tv.sohu.com/user/a/fo/batchJudge.do?callback=?",isLogin:function(){return!!this.getPassport()},getPassport:function(){return sohuHD.passport.getPassport()},sub:function(t){"[object Array]"!=Object.prototype.toString.call(t)&&(t=[].slice.call(arguments));var i=this.subUrl+"&uids="+t.join(",")+"&passport="+this.getPassport();return $.getJSON(i)},unsub:function(t){"[object Array]"!=Object.prototype.toString.call(t)&&(t=[].slice.call(arguments));var i=this.unsubUrl+"&uids="+t.join(",")+"&passport="+this.getPassport();return $.getJSON(i)},check:function(t){"[object Array]"!=Object.prototype.toString.call(t)&&(t=[].slice.call(arguments));var i=this.checkUrl+"&uids="+t.join(",")+"&passport="+this.getPassport();return $.getJSON(i)}});var i=(sohuHD.wemedia.rssutil,{unsubed:{t:"\u8ba2\u9605",c:""},subed:{t:"\u5df2\u8ba2\u9605",c:""},cancel:{t:"\u53d6\u6d88\u8ba2\u9605",c:""}});sohuHD.namespace("sohuHD.wemedia.RssBtn"),sohuHD.wemedia.RssBtn=function(t,s){sohuHD.wemedia.RssBtn.superClass.constructor.call(this),this.originalConfig=s,this.config=s||{},this.btn=$(t),this.uid=s.uid,this.uid||(this.uid=this.btn.data("uid")||this.btn.data("rss-uid")),this.skin=this.btn.data("skin")||"white",this.stateMap=s.stateMap||{};for(var a in i){this.stateMap[a]=this.stateMap[a]||{};var o=this.stateMap[a],n=i[a];if(n)for(var e in n)"undefined"==typeof o[e]&&(o[e]=n[e])}this.alertDialog=new sohuHD.wemedia.ui.AlertDialog({delayHideTime:2e3}),this.config.initData&&(this.initData=this.config.initData,this.uData=this.initData),this.initData&&"undefined"!=typeof this.initData.isFollow&&(this.isFollow=this.initData.isFollow)},sohuHD.inherit(sohuHD.wemedia.RssBtn,t,{util:sohuHD.wemedia.rssutil,init:function(){this.initEvent(),this._init(),this.initialed=!0},initEvent:function(){this.btn.hover(function(){this.isFollow&&this.trigger("hover",this.isFollow)}.bind(this),function(){this.isFollow&&this.trigger("hoverout",this.isFollow)}.bind(this)),this.btn.on("click",function(t){var i=this.btn.data("pb-txid"),s=this.btn.data("pb-other");i&&messagebus.publish("statV2.ping",{type:"click",txid:i,other:s});var a=this.btn.data("action");return"sub"==a?this.doSub():"unsub"==a&&this.doUnsub(),!1}.bind(this)),this.on("sub",this),this.on("suberror",this),this.on("unsub",this),this.on("hover",this),this.on("hoverout",this),this.on("click",this),messagebus.subscribe("core.login",function(){this._init()}.bind(this),null,null),messagebus.subscribe("core.logout",function(){this._init()}.bind(this),null,null)},_init:function(){if(!this.initialed&&"undefined"!=typeof this.isFollow&&this.initData)return this.btn.show(),this.setBtnState(this.isFollow),setTimeout(function(){this.trigger("check",this.initData),this.trigger("init",this.initData)}.bind(this)),void(this.originalConfig.myuid==this.uid&&this.btn.hide());if(this.initialed&&!this.util.isLogin())this.btn.show(),this.isFollow=!1,this.setBtnState(this.isFollow);else if(!this.subing){var t=this.util.check(this.uid);t.done(function(t){t=t||{};var i=t.isFollows[0],s=t.fansCount[0];if(this.uData={isFollow:i,fansCount:s},this.isFollow=i,this.btn.show(),this.setBtnState(this.isFollow),this.trigger("check",this.uData),this.trigger("init",this.uData),this.uid==t.uid)return void this.btn.hide()}.bind(this))}},calcDialogPosition:function(t){var i,s,a=this.btn.offset(),o=t.size(),n=$(window).scrollTop(),e=$(window).scrollLeft(),h=this.btn.width(),u=this.btn.height();return i=a.top-o.h,i<n&&(i=a.top+u+20),s=a.left,s+o.w>e+$(window).width()&&(s=s+h-o.w),{top:i,left:s}},getFollowData:function(){this.util.check(this.uid).done(function(t){t=t||{};var i=t.isFollows[0],s=t.fansCount[0];this.uData={isFollow:i,fansCount:s},this.trigger("check",this.uData),this.trigger("init",this.uData)}.bind(this))},doSub:function(){if(!this.util.isLogin())return sohuHD.showLoginWinbox(function(){this.subing=!0,this.doSub()}.bind(this)),void sohuHD.initLogin();this.util.sub(this.uid).done(function(t){if(-2==t.status)this.trigger("suberror",t);else{this.subing=!1,this.trigger("sub",t);var i=this.btn.data("pb-txid-sub"),s=this.btn.data("pb-other");i&&messagebus.publish("statV2.ping",{type:"click",txid:i,other:s})}this.getFollowData()}.bind(this))},doUnsub:function(){this.util.unsub(this.uid).done(function(t){this.trigger("unsub",t);var i=this.btn.data("pb-txid-unsub"),s=this.btn.data("pb-other");i&&messagebus.publish("statV2.ping",{type:"click",txid:i,other:s}),this.getFollowData()}.bind(this))},handleEvent:function(t){switch(t){case"sub":this.onSub();break;case"unsub":this.onUnsub();break;case"hover":this.onHover();break;case"hoverout":this.onHoverOut();break;case"suberror":this.suberror()}},setBtnState:function(t){if(!0===t?t=1:!1===t&&(t=-1),1==t){if(this.btn.data("action",""),this.stateMap){var i=this.stateMap.subed,s=this.stateMap.unsubed,a=this.stateMap.cancel;this.btn.html(i.t),this.btn.removeClass(s.c||"").removeClass(a.c||""),this.btn.addClass(i.c||"")}}else if(-1==t){if(this.btn.data("action","sub"),this.stateMap){var i=this.stateMap.subed,s=this.stateMap.unsubed,a=this.stateMap.cancel;this.btn.html(s.t),this.btn.removeClass(a.c||"").removeClass(i.c||""),this.btn.addClass(s.c||"")}}else if(0==t&&(this.btn.data("action","unsub"),this.stateMap)){var i=this.stateMap.subed,s=this.stateMap.unsubed,a=this.stateMap.cancel;this.btn.html(a.t),this.btn.removeClass(i.c||"").removeClass(s.c||""),this.btn.addClass(a.c||"")}},onHover:function(){this.isFollow&&this.setBtnState(0)},onHoverOut:function(){this.isFollow&&this.setBtnState(1)},onSub:function(){this.isFollow=!0,this.setBtnState(this.isFollow),this.alertDialog.el.addClass(this.btn.data("skin")||""),this.alertDialog.setTip("\u8ba2\u9605\u6210\u529f\uff01"),this.alertDialog.show();var t=this.calcDialogPosition(this.alertDialog);this.alertDialog.setPosition(t.top,t.left)},onUnsub:function(){this.isFollow=!1,this.setBtnState(this.isFollow),this.alertDialog.el.addClass(this.btn.data("skin")||""),this.alertDialog.setTip("\u53d6\u6d88\u8ba2\u9605\u6210\u529f\uff01"),this.alertDialog.show();var t=this.calcDialogPosition(this.alertDialog);this.alertDialog.setPosition(t.top,t.left)},suberror:function(){this.alertDialog.el.addClass(this.btn.data("skin")||""),this.alertDialog.setTip("\u8ba2\u9605\u5931\u8d25\uff01"),this.alertDialog.show(),this.alertDialog.el.find(".read_tips").removeClass("read_tips_ok").addClass("read_tips_fail").width(70);var t=this.calcDialogPosition(this.alertDialog);this.alertDialog.setPosition(t.top,t.left)},getData:function(){return this.uData}}),sohuHD.extend(sohuHD.wemedia.RssBtn,{init:function(t,i){t=t||".wemedia-rss-btn";var s=[],a=[],o=$(t);if(o.each(function(t,i){var s=$(i).data("uid")||$(i).data("rss-uid");a.push(s)}),!a.length)return null;var n=jQuery.Deferred();return sohuHD.wemedia.rssutil.check(a).done(function(t){t=t||{};var a=t.isFollows||[],e=t.fansCount||[],h=[];a.forEach(function(t,i){var s={isFollow:t,fansCount:e[i]};h.push(s)}),t.results=h,t.results.forEach(function(a,n){var e=($(o[n]).data(i.labUid||"uid"),$.extend({},i,{state:a.isFollow,initData:a,myuid:t.uid})),h=new sohuHD.wemedia.RssBtn(o[n],e);h.init(),s.push(h)}),n.resolve({btns:s,data:t})}),n}})}();