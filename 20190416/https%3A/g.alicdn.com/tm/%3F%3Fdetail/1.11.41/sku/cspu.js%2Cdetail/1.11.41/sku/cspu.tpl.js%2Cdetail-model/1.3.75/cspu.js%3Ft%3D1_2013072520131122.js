KISSY.add("malldetail/sku/cspu",function(e,t,a,i,n,o,r,l){var c;return{"init":function(e){codeTrack("sku.cspu.init","trade.main.init");var t=this;t.utilMethods(),t.ellast=e.ellast,t.skuMap=e.skuMap,t.spuId=e.spuId,t.cspuCategorySwitch=e.cspuCategorySwitch,t.apiUrl=e.apiUrl,c=new o,t.hasCspu(function(e){t.createEl()})},"hasCspu":function(t){var a=this,i=function(){a.skuMap;var t=new Array(0);for(var i in a.skuMap)a.skuMap[i]&&a.skuMap[i].cspuId&&!e.inArray(a.skuMap[i].cspuId,t)&&t.push(a.skuMap[i].cspuId);return t.length};1==function(){return new r(location.href).getQuery().get("standard")}()&&a.cspuCategorySwitch&&new n({"url":a.apiUrl,"type":"get","data":{"cspuNums":i(),"spuId":a.spuId},"dataType":"jsonp","complete":function(a){a&&a.hasCspu&&(e.isFunction(t)&&t(a),c.set("cspuControl",a))},"timeout":5})},"createEl":function(){var i=this,n=t.parent(i.ellast,".tb-prop");t.css(n,{"position":"relative"}),t.append(t.create('<div id="J_sellerCspu"></div>',{"html":'<span>\u6ca1\u6709\u60f3\u8981\u7684\u89c4\u683c\u5417\uff1f<a class="tm-getall-cspu">\u67e5\u770b\u6240\u6709\u89c4\u683c</a> </span>'}),n),i.el=t.get("#J_sellerCspu"),function(){e.use("mui/overlay/dialog",function(e,t){i.overLayDialog=new t({"skin":"red","showCat":!1,"mask":!1,"headerContent":"","bodyContent":"\u6211\u662f\u5185\u5bb9","align":{"points":["cc","cc"]},"id":"J_sellerCspuDialog","closeAction":"hide"})});var n=function(){i.propElms=t.query(".tb-prop",t.get("#"+i.overLayDialog.get("id"))),i.confirmEl=t.get(".tm-confirm-box","#"+i.overLayDialog.get("id")),i.selectBoxEl=t.get(".tm-cspuselect-box","#"+i.overLayDialog.get("id"));var n=function(){var a=!0;return e.each(i.propElms,function(e,i){t.get(".tb-selected",e)||(a=!1)}),a};e.each(i.propElms,function(o){var r=t.query("li",o);a.on(r,"click",function(a){var o=t.create("<i>\u5df2\u9009\u4e2d</i>"),r="li"==a.target.nodeName?a.target:t.parent(a.target,"li");if(!t.hasClass(r,"tb-out-of-stock")){var l=function(a){var i=e.clone(c.get("cspuSkuProp"));i||(i={});var n=t.attr(r,"data-value"),o=n.split(":"),l={};l[o[0]]=o[1],e.mix(i,l),c.set("cspuSkuProp",i),c.set("currentSelectProp",l),c.set("selectStr",n),c.set("cancelTag",a)};t.hasClass(r,"tb-selected")?(t.removeClass(this.propValEls,"tb-selected"),t.remove(t.get("i",this.propValEls)),c.onChange("cancelSkuMapStock",function(t){if(t){for(var a=e.clone(c.get("cspuSkuMapStock")),i=Object.keys(t),n=0;n<i.length;n++)for(var o=t[n],r=0;r<o.length;r++)o[r]||(a[n][r]=!0);c.set("cancelTag",!1),c.set("cspuSkuMapStock",a)}}),l(!0)):(l(!1),t.removeClass(this.propValEls,"tb-selected"),t.remove(t.get("i",this.propValEls)),t.addClass(r,"tb-selected"),t.append(o,r)),n()?(t.css(i.confirmEl,"display","block"),t.css(i.selectBoxEl,"display","none")):(t.css(i.confirmEl,"display","none"),t.css(i.selectBoxEl,"display","block"))}},{"propValEls":r})}),c.onChange("cspuSkuProp",function(e){}),c.onChange("cspuSkuMapStock",function(e){for(var a=Object.keys(e),n=t.create("<i>\u5df2\u9009\u4e2d</i>"),o=0;o<a.length;o++)for(var r=t.query("li",i.propElms[o]),l=e[o],c=0;c<l.length;c++)if(l[c])t.removeClass(r[c],"tb-out-of-stock");else if(t.addClass(r[c],"tb-out-of-stock"),t.hasClass(r[c],"tb-selected"))if(t.removeClass(r[c],"tb-selected"),t.remove(t.get("i",r[c])),r.length>c+1)t.addClass(r[c+1],"tb-selected"),t.append(n,r[c+1]);else for(var s=0;s<r.length;s++)if(!t.hasClass(r[s],"tb-out-of-stock")){t.addClass(r[s],"tb-selected"),t.append(n,r[s]);break}})},o=function(){var n=t.get("span",t.get(".tm-confirm-box","#"+i.overLayDialog.get("id")));a.on(n,"click",function(a){c.onLoad(["cspuMap"],function(a){var n=t.query(".tb-selected",i.propElms),o="";e.each(n,function(e,a){o+=t.attr(e,"data-value")+";"});var r=a[o.substring(0,o.length-1)].itemId;r&&(i.overLayDialog&&i.overLayDialog.hide(),l.openNewSafeTab("//detail.tmall.com/item.htm?standard=1&cspuGuider=1&id="+r))})})},r=!1;a.on(t.get(".tm-getall-cspu",i.el),"click tap",function(e){i.renderProsElm(),i.overLayDialog.render(),i.overLayDialog.show(),TShop.sendAtpanel("tmalldetail.38.1"),r||(n(),o(),r=!0)})}()},"renderProsElm":function(){var e=this;c.onLoad(["cspuPropList"],function(t){var a=i({"cspuPropList":t});e.overLayDialog.set("bodyContent",a)})},"utilMethods":function(){Object.keys||(Object.keys=function(e){var t=[];for(var a in e)e.hasOwnProperty(a)&&t.push(a);return t})}}},{"requires":["dom","event","malldetail/sku/cspu.tpl","io","detail-model/cspu","uri","malldetail/common/util","malldetail/sku/cspu.css"]});KISSY.add("malldetail/sku/cspu.tpl",function(){return function(e,t){var a={"escapehash":{"<":"&lt;",">":"&gt;","&":"&amp;",'"':"&quot;","'":"&#x27;","/":"&#x2f;"},"escapereplace":function(e){return a.escapehash[e]},"escaping":function(e){return"string"!=typeof e?e:e.replace(/[&<>"]/gim,this.escapereplace)},"detection":function(e){return void 0===e?"":e}},i=function(e){if("undefined"!=typeof console){if(console.warn)return void console.warn(e);if(console.log)return void console.log(e)}throw e};t=t||{},t.__escapehtml=a,t.__throw=i;var e=e||{},n="";n+="";try{n+="";var o=e.cspuPropList;e.item,e.iv,e.index,e.dl,e.prop,e.clear,e.dt,e.metatit,e.dd,e.ul,e.property,e.img,e.li,e.value,e.a,e.center,e.repeat,e.span,e.i,e.div,e.cspuselect,e.box,e.confirm;n+="",function(){for(var e in o)if(o.hasOwnProperty(e)){var a=o[e];n+=' <dl class="tb-prop tm-clear">     <dt class="tb-metatit">',n+=t.__escapehtml.escaping(t.__escapehtml.detection(a.name)),n+="</dt>     <dd>         ",a.isImg?(n+='         <ul data-property="',n+=t.__escapehtml.escaping(t.__escapehtml.detection(a.name)),n+='" class="tm-clear J_TCspuProp  tb-img">             ',function(){for(var e in a.value)if(a.value.hasOwnProperty(e)){var i=a.value[e],o=e;n+='             <li data-value="',n+=t.__escapehtml.escaping(t.__escapehtml.detection(a.pid)),n+=":",n+=t.__escapehtml.escaping(t.__escapehtml.detection(i.vid)),n+='" title="',n+=t.__escapehtml.escaping(t.__escapehtml.detection(i.title)),n+='">                 <a style="background:url(',n+=t.__escapehtml.escaping(t.__escapehtml.detection(i.url)),n+='_30x30q90.jpg) center no-repeat;">                     <span>',n+=t.__escapehtml.escaping(t.__escapehtml.detection(i.title)),n+="</span>                 </a>                 ",0==o&&(n+="<i>\u5df2\u9009\u4e2d</i>"),n+="             </li>             "}}(),n+="         </ul>         "):(n+='         <ul data-property="',n+=t.__escapehtml.escaping(t.__escapehtml.detection(a.name)),n+='" class="tm-clear J_TCspuProp  ">             ',function(){for(var e in a.value)if(a.value.hasOwnProperty(e)){var i=a.value[e],o=e;n+='             <li data-value="',n+=t.__escapehtml.escaping(t.__escapehtml.detection(a.pid)),n+=":",n+=t.__escapehtml.escaping(t.__escapehtml.detection(i.vid)),n+='">                 <a>                     <span>',n+=t.__escapehtml.escaping(t.__escapehtml.detection(i.name)),n+="</span>                 </a>                 ",0==o&&(n+="<i>\u5df2\u9009\u4e2d</i>"),n+="             </li>             "}}(),n+="         </ul>         "),n+="     </dd> </dl> "}}(),n+=' <div class="tm-cspuselect-box">     <span>\u8bf7\u9009\u62e9\u4f60\u8981\u7684\u89c4\u683c</span> </div> <div class="tm-confirm-box">     <span>\u786e\u5b9a</span> </div>  '}catch(r){t.__throw("Juicer Render Exception: "+r.message)}return n+=""}});KISSY.add("detail-model/cspu",function(t,e,n){function o(t){o.superclass.constructor.apply(this,arguments);var e=this;codeTrack("model.cspu.init","app.init"),e.addAttr("testdata",{"load":function(t){e.onLoad("cspuControl",function(e){e&&e.testdata&&t(e.testdata)})}}),e.addAttr("cspuPropList",{"load":function(t){e.onLoad("cspuControl",function(e){e&&e.cspuPropList&&t(e.cspuPropList)})}}),e.addAttr("cspuMap",{"load":function(t){e.onLoad("cspuControl",function(e){e&&e.cspuMap&&t(e.cspuMap)})}}),e.addAttr("cspuSkuProp",{"load":function(t){e.onLoad("cspuPropList",function(e){if(e){for(var n={},o=0;o<e.length;o++)n[e[o].pid]=null;t(n)}})}}),e.addAttr("currentSelectProp",{"load":function(t){t(null)}}),e.addAttr("cspuSkuMapStock",{"load":function(t){e.onChange(["cspuSkuProp","cspuMap","cspuPropList","currentSelectProp","selectStr","cancelTag"],function(n,o,a,i,c,r){if(n&&i){for(var u={},m=c,d=c.split(":")[0],s=0;s<a.length;s++){for(var l=a[s].value,f=new Array(l.length),p=function(t,e){var n=!1;for(var a in o){var i=new RegExp(e),c=new RegExp(t);i.test(a)&&c.test(a)&&(n=!0)}return n},b=function(t){var e=!1;for(var n in o){new RegExp(t).test(n)&&(e=!0)}return e},v=0;v<f.length;v++){var y=a[s].pid+":"+a[s].value[v].vid;a[s].pid==d?f[v]=b(y):f[v]=p(y,m)}u[s]=f}r?e.set("cancelSkuMapStock",u):t(u)}})}}),e.addAttr("cancelSkuMapStock",{"load":function(t){e.onChange(["cspuSkuMapStock","cancelTag"],function(t,e){})}})}return t.extend(o,e),o},{"requires":["detail-model/model","dom"]});