KISSY.add("mui/tribechat/mods/msgboard/index",function(e,i,t){var r={init:false,isChatWindow:true,isTipShowing:false,isTipclosed:false,renderDetailTip:function(){var e=this;if(this.isTipclosed||this.isChatWindow||this.isTipShowing){return false}if(!this.init){this.init=true;this.isTipShowing=true;var r=i.get("#J_Reviews");var n='<div class="tribechat-detail-tip show-tips" id="J_TribeChat_Tip">"\u4e00\u8d77\u901b"\u6709\u65b0\u6d88\u606f<a href="javascript:;">\u70b9\u51fb\u67e5\u770b</a><span>\xd7</span></div>';i.append(i.create(n),r);t.on("#J_TribeChat_Tip a","click",function(){t.fire(i.get("#J_Reviews .rate-chat-btn input"),"click");i.removeClass("#J_TribeChat_Tip","show-tips")});t.on("#J_TribeChat_Tip span","click",function(){e.isTipclosed=true;e.isTipShowing=false;i.removeClass("#J_TribeChat_Tip","show-tips")})}else{this.isTipShowing=true;this.isTipclosed=false;i.addClass("#J_TribeChat_Tip","show-tips")}},resetTip:function(){if(this.isTipShowing){this.isTipShowing=false;i.hide("#J_TribeChat_Tip")}this.isTipclosed=false}};function n(){this.$Tpl=i.create('<div class="tribechat-msg" id="J_TribeChat_Msg_Container"><div id="J_TribeChat_Msg"></div></div>');this.$currentSize=0;this.$sizeLimit=300;this.$cfg=null}n.prototype.config=function(e){this.$cfg=e||{}};function s(e){var i=e.length||0;var t;if(i==0){t="*****"}else if(i<3&&i>0){t=[e[0],"***",e[i-1]].join("")}else{t=[e[0],"***",e[i-2],e[i-1]].join("")}return t}function a(e){var i=new Date(e);var t=i.getMonth()+1,r=i.getDate(),n=i.getHours(),s=i.getMinutes();if(t<10){t="0"+t}if(r<10){r="0"+r}if(n<10){n="0"+n}if(s<10){s="0"+s}return[t,"-",r," ",n,":",s].join("")}function o(e){var i;if(TribeModule&&e==TribeModule.self_uid){return 1}if(TribeModule&&TribeModule.users){i=TribeModule.users[e]||2;return i}else{return 2}}function c(i,t){var r=["","shopping","shopping","buyed"];var n=["","\u81ea\u5df1","\u6b63\u5728\u901b\u7684\u7528\u6237","\u8d2d\u4e70\u8fc7\u7684\u7528\u6237"];var c,d,u,l,g;var f="//img.alicdn.com/L1/134/10161/ftssrvlk/0/5/";if(i===2){if(!e.isString(t.msg)){if(t.type===3){g=3;var h=REVIEW_SDK.Base.getNick(t.from);if(o(h)===1){return null}u=s(h)+"\u52a0\u5165\u4e86\u7fa4\u804a";TribeModule.msg.fire("SDK.CHAT_INSERT",{uid:t.from})}else if(t.type===5){g=5;var h=REVIEW_SDK.Base.getNick(t.from);if(o(h)===1){return null}u=s(h)+"\u9000\u51fa\u4e86\u7fa4\u804a";TribeModule.msg.fire("SDK.CHAT_QUIT",{uid:t.from})}else{return null}}c=s(REVIEW_SDK.Base.getNick(t.from));d=a(t.time);if(t.type===0){u=t.msg;g=0}else if(t.type===1){u=REVIEW_SDK.Plugin.Emot.decode(t.msg||"");g=1}l=o(REVIEW_SDK.Base.getNick(t.from)||"")}if(i===1){if(!e.isString(t.msg)){return null}u=t.msg;if(t.type===0){u=REVIEW_SDK.Plugin.Emot.decode(u)}c=s(t.uid||"");l=1}return{name:c||"*****",time:d||"",typeClass:r[l],typeName:n[l],msg:u||"",type:g}}n.prototype.renderSelfMsg=function(e){var t=c(1,{msg:e.msg,type:e.msgType,uid:this.$cfg.uid}),r="";if(!t){return 0}if(TribeModule&&TribeModule.users&&TribeModule.users[this.$cfg.uid]){t.name=TribeModule.users[this.$cfg.uid].nick||""}else{t.name=""}if(e.msgType===0){r=['<div class="tribechat-msg-single from-me ',t.typeClass,'"><p class="tribechat-msg-single-info">',t.name,"(",t.typeName,')</p><div class="tribechat-msg-single-content">',t.msg,"</div></div>"].join("")}if(e.msgType===1){r=['<div class="tribechat-msg-single from-me ',t.typeClass,'"><p class="tribechat-msg-single-info">',t.name,"(",t.typeName,')</p><div class="tribechat-msg-single-content"><img class="chat-img" src="',t.msg,'" title="\u804a\u5929\u56fe\u7247"></div></div>'].join("")}i.append(i.create(r),"#J_TribeChat_Msg");return 1};n.prototype.renderOtherMsg=function(e){var t={},r="";var n=e.msgs||[];var s=n.length||0;var a=0;for(var o=0;o<s;o++){t=c(2,n[o]);if(!t){continue}if(t.type===1){r=['<div class="tribechat-msg-single from-other ',t.typeClass,'"><p class="tribechat-msg-single-info">',t.name,"(",t.typeName,")<span>",t.time,'</span></p><div class="tribechat-msg-single-content">',t.msg,"</div></div>"].join("")}else if(t.type===16){r=['<div class="tribechat-msg-single from-other ',t.typeClass,'"><p class="tribechat-msg-single-info">',t.name,"(",t.typeName,")<span>",t.time,'</span></p><div class="tribechat-msg-single-content"><img class="chat-img" src="',t.msg,'" title="\u804a\u5929\u56fe\u7247"></div></div>'].join("")}else if(t.type===3){r=['<div class="tribechat-msg-single from-infor">',t.msg,"</div>"].join("")}else if(t.type===5){r=['<div class="tribechat-msg-single from-infor">',t.msg,"</div>"].join("")}i.append(i.create(r),"#J_TribeChat_Msg");a++}return a};n.prototype.renderErrorMsg=function(e){var t=false;switch(e.errorType){case"login":{t="\u5bf9\u4e0d\u8d77\uff0c\u670d\u52a1\u5668\u8fde\u63a5\u5931\u8d25\uff0c\u8bf7\u5237\u65b0\u540e\u91cd\u8bd5"}break;case"relogin":{t="\u5bf9\u4e0d\u8d77\uff0c\u670d\u52a1\u5668\u8fde\u63a5\u5df2\u65ad\u5f00\uff0c\u8bf7\u5237\u65b0\u540e\u91cd\u8bd5"}break;case"send.pic":{t="\u56fe\u7247\u53d1\u9001\u5931\u8d25\uff0c\u8bf7\u7a0d\u540e\u91cd\u8bd5"}break;case"send.error":{t="\u6d88\u606f\u53d1\u9001\u5931\u8d25\uff0c\u8bf7\u7a0d\u540e\u91cd\u8bd5"}break;case"pic.sizelimit":{t="\u4e0a\u4f20\u56fe\u7247\u7684\u5927\u5c0f\u8bf7\u4e0d\u8981\u8d85\u8fc72MB"}break;case"pic.error":{t="\u5bf9\u4e0d\u8d77\uff0c\u56fe\u7247\u4e0a\u4f20\u5931\u8d25\uff0c\u8bf7\u7a0d\u540e\u91cd\u8bd5"}break;case"pic.notsupport":{t="\u8bf7\u91cd\u65b0\u9009\u62e9\u4e00\u5f20\u6b63\u786e\u683c\u5f0f\u7684\u56fe\u7247"}break;case"account.error":{t="\u5bf9\u4e0d\u8d77\uff0c\u8fde\u63a5\u521d\u59cb\u5316\u5931\u8d25\uff0c\u8bf7\u5237\u65b0\u540e\u91cd\u8bd5"}break;case"send.long":{t="\u60a8\u8f93\u5165\u7684\u6587\u5b57\u592a\u957f\u4e86\uff0c\u4e0d\u80fd\u8d85\u8fc7400\u4e2a\u5b57\u54df"}break;default:break}if(t){_tpl=['<div class="tribechat-msg-single from-error">',t,"</div>"].join("");i.append(i.create(_tpl),"#J_TribeChat_Msg");return 1}else{return 0}};n.prototype.renderInforMsg=function(e){var t=false;var r="";switch(e.msgType){case"login":{t="\u670d\u52a1\u5668\u8fde\u63a5\u6210\u529f\uff0c\u60a8\u53ef\u4ee5\u7545\u804a\u5566";r="J_TribeChat_MsgLogin"}break;case"invite.success":{t="\u9080\u8bf7\u53d1\u9001\u6210\u529f\uff0c\u8bf7\u7a0d\u540e"}break;default:break}if(t){_tpl=['<div class="tribechat-msg-single from-infor" id="',r,'">',t,"</div>"].join("");i.append(i.create(_tpl),"#J_TribeChat_Msg");return 1}else{return 0}};n.prototype.renderMsg=function(e,t){if(e===1){this.$currentSize+=this.renderSelfMsg(t||{})}else if(e===2){this.$currentSize+=this.renderOtherMsg(t||{})}else if(e===9){this.$currentSize+=this.renderErrorMsg(t||{})}else if(e===10){this.$currentSize+=this.renderInforMsg(t||{})}else if(e===11){this.$currentSize+=this.renderRecentMsg(t||{})}i.scrollTop("#J_TribeChat_Msg_Container",i.height("#J_TribeChat_Msg"));if(this.$currentSize>=this.$sizeLimit){var r=i.query("#J_TribeChat_Msg .tribechat-msg-single")||[];i.remove(r.slice(0,parseInt(r.length/2)));this.$currentSize=parseInt(this.$sizeLimit/2)}};n.prototype.renderRecentMsg=function(e){var t=this;var r=e.data.msgs;var n=e.data.uid;var o={};if(TribeModule&&TribeModule.users){o=TribeModule.users[REVIEW_SDK.Base.getNick(n)]||{}}var c=o.nick?o.nick:"";var d=r.length||0;var u=['<div class="tribechat-msg-single from-me from-record shopping"><p class="tribechat-msg-single-info"><span>',"\u53d1\u9001\u65f6\u95f4","</span>",c,'(\u81ea\u5df1)</p><div class="tribechat-msg-single-content">',"\u6d88\u606f","</div></div>"];var l=['<div class="tribechat-msg-single from-other from-record shopping"><p class="tribechat-msg-single-info">',"\u6635\u79f0","<span>","\u53d1\u9001\u65f6\u95f4",'</span></p><div class="tribechat-msg-single-content">',"\u6d88\u606f","</div></div>"];var g='<div class="tribechat-msg-single from-infor">\u2014\u2014\u2014\u4e4b\u524d\u7684\u804a\u5929\u8bb0\u5f55\u2014\u2014\u2014</div>';var f=[];var h=0,m,p;for(h=d-1;h>=0;h--){if(r[h].type!==0){break}if(n==r[h].from){u[1]=a(r[h].time);u[5]=REVIEW_SDK.Plugin.Emot.decode(r[h].msg||"");f.push(u.join(""))}else{l[1]=s(REVIEW_SDK.Base.getNick(r[h].from));l[3]=a(r[h].time);l[5]=REVIEW_SDK.Plugin.Emot.decode(r[h].msg||"");f.push(l.join(""))}}if(f.length>0){f.push(g);i.insertAfter(i.create(f.join("")),"#J_TribeChat_MsgLogin")}return f.length||0};n.prototype.fetchRecentMsg=function(){var e=this;REVIEW_SDK&&REVIEW_SDK.Tribe.getHistory({tid:e.$cfg.touid,count:200,nextkey:"",success:function(i){e.renderMsg(11,i||[])},error:function(e){_CTK202c(17,"sdk.recentmsg_fetch_fail","sdk.login_success")}})};n.prototype.render=function(e){var t=this;var n=r;i.append(this.$Tpl,"#J_TribeChat");setTimeout(function(){TribeModule.msg.on("SDK.LOGIN",function(e){t.config(e.data);t.fetchRecentMsg();TribeModule.msg.fire("SDK.SEND:MSG",{data:{},msgType:"login"})});TribeModule.msg.on("SDK.SEND",function(e){t.renderMsg(1,{msg:e.data,msgType:e.msgType})});TribeModule.msg.on("SDK.SEND:ERROR",function(e){t.renderMsg(9,{data:e.data||{},errorType:e.errorType||""})});TribeModule.msg.on("SDK.SEND:MSG",function(e){t.renderMsg(10,{data:e.data||{},msgType:e.msgType||""})});TribeModule.msg.on("RECEIVE",function(e){t.renderMsg(2,e.data);if(!n.isChatWindow){n.renderDetailTip()}});TribeModule.msg.on("DETAIL.TRIGGER",function(e){n.isChatWindow=e.isChatWindow;if(n.isChatWindow){n.resetTip()}})},0)};return new n},{requires:["dom","event"]});KISSY.add("mui/tribechat/mods/softinput/index",function(e,i,t,r){function n(){this.$cfg={};this.$empt=false;this.$emptShow=false;this.$picMaxSize=1024*1024*2;this.$Tpl='<div class="tribechat-soft-input" id="J_TribeChat_SoftInput">'+'<a href="javascript:;" class="icon-biaoqing" id="J_TribeChat_SoftInput_BQ" title="\u8868\u60c5"></a>'+'<a href="javascript:;" class="icon-pic-upload" id="J_TribeChat_SoftInput_Pic" title="\u4e0a\u4f20\u56fe\u7247"></a>'+'<input id="J_TribeChat_SoftInput_PicInput" disabled type="file" title="\u4e0a\u4f20\u56fe\u7247">'+'<div class="tribechat-bq-container" id="J_TribeChat_BQ_Container"></div>'+'<div id="J_TribeChat_LengthLimit" class="length-limit"></div>'+"</div>";this.$noImageTpl='<div class="tribechat-soft-input" id="J_TribeChat_SoftInput">'+'<a href="javascript:;" class="icon-biaoqing" id="J_TribeChat_SoftInput_BQ" title="\u8868\u60c5"></a>'+'<div class="tribechat-bq-container" id="J_TribeChat_BQ_Container"></div>'+'<div id="J_TribeChat_LengthLimit" class="length-limit"></div>'+"</div>"}function s(){if(r.ie===6||r.ie===7||r.ie===8||r.ie<6){return false}else{return!!document.createElement("canvas").getContext}}n.prototype.triggerEmpt=function(){var e=this;if(!this.$empt){var t=document.getElementById("J_TribeChat_Input_TextArea");REVIEW_SDK.Plugin.Emot.render({container:document.getElementById("J_TribeChat_BQ_Container"),onEmotClick:function(r){t.value+=r;t.focus();e.$emptShow=false;i.hide("#J_TribeChat_BQ_Container")}});this.$empt=true}if(this.$emptShow){i.hide("#J_TribeChat_BQ_Container")}else{i.show("#J_TribeChat_BQ_Container")}this.$emptShow=!this.$emptShow};n.prototype.sendImage=function(e){REVIEW_SDK.Tribe.sendMsg({tid:this.$cfg.touid||"",msg:e.data.url||"",msgType:1,success:function(i){var t=(e.data.url||"").replace(/https{0,1}:/,"");TribeModule.msg.fire("SDK.SEND",{data:t,msgType:1})},error:function(e){TribeModule.msg.fire("SDK.SEND:ERROR",{data:e,errorType:"send.pic"})}})};n.prototype.initUploadImage=function(){var e=this;var r=i.get("#J_TribeChat_SoftInput_PicInput");if(s()){i.removeAttr(r,"disabled");t.on("#J_TribeChat_SoftInput_Pic","click",function(e){r.click()});t.on(r,"change",function(t){REVIEW_SDK.Plugin.Image.upload({target:document.getElementById("J_TribeChat_SoftInput_PicInput"),timeout:"10000",maxSize:e.$picMaxSize,success:function(i){if(i.code==1e3&&i.data){e.sendImage(i)}},error:function(e){if(e.code===-4){TribeModule.msg.fire("SDK.SEND:ERROR",{data:e,errorType:"pic.sizelimit"})}else if(e.code===-3||e.code===-5){TribeModule.msg.fire("SDK.SEND:ERROR",{data:e,errorType:"pic.notsupport"})}else{TribeModule.msg.fire("SDK.SEND:ERROR",{data:e,errorType:"pic.error"})}_CTK202c(17,"img.upload.error","sdk.start")}});t.preventDefault?t.preventDefault():t.stopPropagation();i.val(t.target,"")})}else{}};n.prototype.init=function(e){var i=this;this.$cfg=e;t.on("#J_TribeChat_SoftInput_BQ","click",function(){i.triggerEmpt()})};n.prototype.render=function(e,t){var r=this;this.$cfg=t||{};i.append(i.create(this.$noImageTpl),"#J_TribeChat");setTimeout(function(){TribeModule.msg.on("SDK.LOGIN",function(e){r.init(e.data||{})})},0)};var a=new n;return a},{requires:["dom","event","ua"]});KISSY.add("mui/tribechat/mods/input/index",function(e,i,t){function n(){this.$cfg=null;this.$lengthLimit=400}n.prototype.sendMsg=function(e,t){var n=this;if(e===1){TribeModule.msg.fire("SDK.SEND",{data:t,msgType:0});i.val("#J_TribeChat_Input_TextArea","");REVIEW_SDK.Tribe.sendMsg({msg:t,tid:this.$cfg.touid||"",success:function(e){_CTK202c(17,"sdk.msg_send_success","sdk.login_success")},error:function(e){TribeModule.msg.fire("SDK.SEND:ERROR",{data:e,errorType:"send.error"});_CTK202c(17,"sdk.msg_send_error","sdk.login_success")}})}};n.prototype.bindEvents=function(e){var n=this;this.$cfg=e;this.$SEND_BTN=i.get("#J_TribeChat_Input_SendBtn");i.css("#J_TribeChat_LengthLimit",{display:"inline-block"});t.on("#J_TribeChat_Input_TextArea","keydown",function(e){var t=i.val("#J_TribeChat_Input_TextArea");var r=t.trim().length;if(e.keyCode==13){if(r>0&&r<=n.$lengthLimit){t=REVIEW_SDK.Plugin.Emot.htmlEncode(t);n.sendMsg(1,t)}return false}});t.on("#J_TribeChat_Input_TextArea","keyup focus",function(e){var t=i.val("#J_TribeChat_Input_TextArea");var r=t.trim().length;if(n.$lengthLimit-r<0){i.text("#J_TribeChat_LengthLimit","\u8f93\u5165\u592a\u591a\u5566\uff0c\u4e0d\u8981\u8d85\u8fc7"+n.$lengthLimit+"\u4e2a\u5b57");i.removeClass(n.$SEND_BTN,"able-send")}else{i.text("#J_TribeChat_LengthLimit","\u60a8\u8fd8\u53ef\u4ee5\u8f93\u5165"+(n.$lengthLimit-r)+"\u4e2a\u5b57");if(r>0){i.addClass(n.$SEND_BTN,"able-send")}else{i.removeClass(n.$SEND_BTN,"able-send")}}});t.on("#J_TribeChat_Input_SendBtn","click",function(e){var t=i.val("#J_TribeChat_Input_TextArea");var r=t.trim().length;if(r>0&&r<=n.$lengthLimit){t=REVIEW_SDK.Plugin.Emot.htmlEncode(t);n.sendMsg(1,t);i.text("#J_TribeChat_LengthLimit","");i.removeClass(n.$SEND_BTN,"able-send");i.get("#J_TribeChat_Input_TextArea").focus()}else{return false}})};n.prototype.showMLogin=function(){e.use("mui/minilogin",function(e,i){i.show(function(){TribeModule.msg.fire("USER.LOGIN")},{check:true,needRedirect:false})})};n.prototype.render=function(e){var n="";var r=this;if(e===false){n='<div class="tribechat-input" id="J_TribeChat_Input"><h3 class="no-login-title">\u767b\u5f55\u624d\u80fd\u53d1\u8a00\u54e6</h3><p class="no-login-btn"><button class="no-login-btn">\u767b\u5f55</button></p></div>';i.append(i.create(n),"#J_TribeChat");TribeModule.msg.on("USER.LOGIN",function(){r.render(true)});setTimeout(function(){t.on("#J_TribeChat_Input button.no-login-btn","click",function(){r.showMLogin()})},0)}else{var o=i.get("#J_TribeChat_Input");if(o===null||o===undefined){n='<div class="tribechat-input" id="J_TribeChat_Input"><textarea id="J_TribeChat_Input_TextArea"></textarea><button id="J_TribeChat_Input_SendBtn" class="send-btn">\u53d1&nbsp;\u9001</button></div>';i.append(i.create(n),"#J_TribeChat")}else{n='<textarea id="J_TribeChat_Input_TextArea"></textarea><button id="J_TribeChat_Input_SendBtn" class="send-btn">\u53d1&nbsp;\u9001</button>';i.html("#J_TribeChat_Input",n)}}setTimeout(function(){TribeModule.msg.on("SDK.LOGIN",function(e){r.bindEvents(e.data||{})})},0)};var r=new n;return r},{requires:["dom","event"]});KISSY.add("mui/tribechat/mods/userlist/index",function(e,i,t,r,n){function s(){this.$cfg={};this.$noLoginTpl='<div class="tribechat-list" id="J_TribeChat_List">'+'<div class="list-wrapper"><h3 class="tag" id="J_TribeChat_ListTag">\u5728\u7ebf\u5217\u8868</h3><div class="list-content" id="J_TribeChat_ListContent"></div></div>'+'<div class="loading-part" id="J_TribeChat_ListLoading">\u55b5~\u767b\u5f55\u540e\u624d\u80fd\u67e5\u770b\u5217\u8868\u5466</div>'+'<div class="invite-wrapper"><button class="tribechat-invite-btn" id="J_TribeChat_InviteBtn" disabled>\u9080\u8bf7\u66f4\u591a\u8d2d\u4e70\u7528\u6237</button><p id="J_TribeChat_InviteMsg"></p></div>'+'<div class="yw-logo"><img src="//img.alicdn.com/tps/TB1F30vKpXXXXaMXpXXXXXXXXXX-29-17.png" title="\u4e91\u65fa">Powered by \u4e91\u65fa</div>'+"</div>";this.$Tpl='<div class="tribechat-list" id="J_TribeChat_List">'+'<div class="list-wrapper"><h3 class="tag" id="J_TribeChat_ListTag">\u5728\u7ebf\u5217\u8868</h3><div class="list-content" id="J_TribeChat_ListContent"></div></div>'+'<div class="loading-part" id="J_TribeChat_ListLoading">\u4e3a\u60a8\u52a0\u8f7d\u5f53\u524d\u5217\u8868<span class="loading-icon"></span></div>'+'<div class="invite-wrapper"><button class="tribechat-invite-btn" id="J_TribeChat_InviteBtn" disabled>\u9080\u8bf7\u66f4\u591a\u8d2d\u4e70\u7528\u6237</button><p id="J_TribeChat_InviteMsg"></p></div>'+'<div class="yw-logo"><img src="//img.alicdn.com/tps/TB1F30vKpXXXXaMXpXXXXXXXXXX-29-17.png" title="\u4e91\u65fa">Powered by \u4e91\u65fa</div>'+"</div>";this.$UserList=[];this.$UserMap={};this.$lastInviteTime=0}function a(e){var i=e.length||0;var t;if(i==0){t="*****"}else if(i<3&&i>0){t=[e[0],"***",e[i-1]].join("")}else{t=[e[0],"***",e[i-2],e[i-1]].join("")}return t}s.prototype._bindInviteEvent=function(){var e=this;r.on("#J_TribeChat_InviteBtn","click",function(){var r=(new Date).getTime();if(r-e.$lastInviteTime<1e3*60*1){i.text("#J_TribeChat_InviteMsg","\u60a8\u521a\u521a\u53d1\u9001\u8fc7\u9080\u8bf7\u54e6\uff0c\u8bf7\u8010\u5fc3\u7b49\u5f85");return false}else{i.text("#J_TribeChat_InviteMsg","\u6b63\u5728\u4e3a\u60a8\u9080\u8bf7\u5176\u4ed6\u5df2\u8d2d\u4e70\u7528\u6237...")}new t({url:(e.$cfg.isDaily?"//rate.daily.tmall.net/":"//rate.tmall.com/")+"chat/send_invitations.htm",dataType:"jsonp",data:{itemId:e.$cfg.itemId||""},success:function(t){if(t.result==="success"){i.text("#J_TribeChat_InviteMsg","\u9080\u8bf7\u5df2\u53d1\u9001\u6210\u529f\uff0c\u8bf7\u8010\u5fc3\u7b49\u5f85")}else{i.text("#J_TribeChat_InviteMsg",t.msg||"")}e.$lastInviteTime=r},error:function(){i.text("#J_TribeChat_InviteMsg","\u5bf9\u4e0d\u8d77\uff0c\u9080\u8bf7\u53d1\u9001\u5931\u8d25\uff0c\u8bf7\u7a0d\u540e\u91cd\u8bd5")},crossDomain:true,cache:false})});i.removeAttr("#J_TribeChat_InviteBtn","disabled")};s.prototype.preData=function(e){var i=e.itemId||"";var t=e.tribeId||"";var r=e.members||[];var n,s=[],o=r.length||0;var c={self:1,notbought:2,bought:3};var d={};for(n=0;n<o;n++){var u={};var l=c[r[n].role]||2;if(l===1){u={uid:r[n].uid||"",userNick:a(r[n].nick||""),type:1};d[r[n].uid||""]={type:1,nick:a(r[n].nick||"")}}else{u={uid:r[n].uid||"",userNick:a(r[n].uid||""),type:l};d[r[n].uid||""]=l}s.push(u)}this.$UserList=s;this.$UserMap=d;if(TribeModule){TribeModule.users=this.$UserMap||{}}return s};s.prototype.fetchData=function(e,i){var r=this;var s=new n(location.href).getQuery().get("debug_session");if(s){s="_debug"}else{s=""}new t({url:(r.$cfg.isDaily?"//rate.daily.tmall.net/":"//rate.tmall.com/")+"chat/get_session"+s+".htm",dataType:"jsonp",data:{itemId:r.$cfg.itemId||""},success:function(t){var n=[];_CTK202c(17,"userlist.fetch_success","sdk.init");if(t.result==="success"){n=r.preData(t.data||{})}else{_CTK202c(17,"userlist.fetch_error","sdk.init");!i&&r.fetchError();return false}e(n)},error:function(){_CTK202c(17,"userlist.fetch_error","sdk.init");!i&&r.fetchError()},crossDomain:true,cache:false})};s.prototype.renderList=function(){var e=0,t=0;var r=this.$UserList.length;var n=[],s="";for(e=0;e<r;e++){if(this.$UserList[e].type===1){s=['<p class="looking"><span class="user-nick">',this.$UserList[e].userNick,"</span>(\u81ea\u5df1)</p>"].join("")}else if(this.$UserList[e].type===3){s=['<p class="buyed"><span class="user-nick">',this.$UserList[e].userNick,"</span>(\u8d2d\u4e70\u8fc7\u7684\u7528\u6237)</p>"].join("")}else{s=['<p class="looking"><span class="user-nick">',this.$UserList[e].userNick,"</span>(\u6b63\u5728\u901b\u7684\u7528\u6237)</p>"].join("")}n.push(s)}i.html("#J_TribeChat_ListContent",n.join(""),false);i.text("#J_TribeChat_ListTag","\u5728\u7ebf"+(r||0)+"\u4eba")};s.prototype.initList=function(e){var t=this;this.fetchData(function(e){i.hide("#J_TribeChat_ListLoading");t.renderList()},e)};s.prototype.render=function(e,t){var r=this;this.$cfg=t||{};if(e){i.append(i.create(this.$Tpl),"#J_TribeChat");this.initList()}else{i.append(i.create(this.$noLoginTpl),"#J_TribeChat");TribeModule.msg.on("USER.LOGIN",function(){r.initList()})}TribeModule.msg.on("SDK.LOGIN",function(){r._bindInviteEvent()});TribeModule.msg.on("SDK.CHAT_INSERT",function(e){r.updateUser(0,e.uid||"")});TribeModule.msg.on("SDK.CHAT_QUIT",function(e){r.updateUser(1,e.uid||"")})};s.prototype.updateUser=function(e,i){var t=0,r=this.$UserList,n=[];if(e===0){this.initList(true)}if(e===1){this.initList(true)}};s.prototype.fetchError=function(){i.text("#J_TribeChat_ListLoading","\u55b5~\u6570\u636e\u52a0\u8f7d\u5931\u8d25\u4e86")};return new s},{requires:["dom","io","event","uri"]});KISSY.add("mui/tribechat/widgets/sdk/index",function(e,i,t,r){function n(e,i,t){var r=!!document.attachEvent;var n="attachEvent";var s="addEventListener";var a=r?n:s;e[a]((r?"on":"")+i,function(e){e=e||win.event;var i=e.target||e.srcElement;t(e,i)})}var s={$cfg:null,$loginStatus:false,$isFocus:true,$bindFocusEvent:false,config:function(e){this.$cfg={};this.$cfg.uid=e.uid||"";this.$cfg.appkey=e.appkey||"";this.$cfg.credential=e.credential||"";this.$cfg.touid=e.touid||"";this.$cfg.itemId=e.itemId||"";this.$cfg.isDaily=!!e.isDaily},startReceiveMsg:function(){var e=this;REVIEW_SDK.Event.on("MSG_RECEIVED",function(e){}).on("TRIBE.MSG_RECEIVED",function(i){if(i.data&&i.data.touid==e.$cfg.touid&&i.code==1e3){TribeModule.msg.fire("RECEIVE",{data:i.data})}}).on("KICK_OFF",function(){e.$loginStatus=false;_CTK202c(17,"sdk.kick_off","sdk.login_success");REVIEW_SDK.Event.off("MSG_RECEIVED");REVIEW_SDK.Event.off("TRIBE.MSG_RECEIVED");REVIEW_SDK.Event.off("KICK_OFF");if(!e.$bindFocusEvent){e.$bindFocusEvent=true;i.on(window,"focus",function(){if(!e.$loginStatus){e.reLogin()}else{}})}});REVIEW_SDK.Base.startListenAllMsg()},login:function(e){var i=this;REVIEW_SDK.Base.login({uid:i.$cfg.uid,appkey:i.$cfg.appkey,credential:i.$cfg.credential,timeout:4e3,success:function(e){i.startReceiveMsg();TribeModule.msg.fire("SDK.LOGIN",{data:i.$cfg});i.$loginStatus=true;_CTK202c(17,"sdk.login_success","sdk.init");setTimeout(function(){TribeModule.msg.detach("SDK.LOGIN")},0)},error:function(t){if(e===3){TribeModule.msg.fire("SDK.SEND:ERROR",{data:t,errorType:"login"});var r="RETRY_MORETHAN_3";_CTK202c(0,"error:sdk.login.error","sdk.init",{group:r,type:"error"})}else{_CTK202c(17,"sdk.login_retry","sdk.init",{group:e});i.login(e+1)}}})},init:function(e){var i=this;this.config(e);if(!window.REVIEW_SDK){window.REVIEW_SDK=new WSDK}_CTK202c(17,"sdk.init","tb.init");this.login(1);n(window,"beforeunload",function(e,t){new r({dataType:"jsonp",url:(i.$cfg.isDaily?"//rate.daily.tmall.net/":"//rate.tmall.com/")+"chat/quit_session.htm",data:{itemId:i.$cfg.itemId},success:function(){},error:function(){},crossDomain:true,cache:false});return true})},reLogin:function(){var e=this;if(!this.$loginStatus){REVIEW_SDK.Base.login({uid:e.$cfg.uid,appkey:e.$cfg.appkey,credential:e.$cfg.credential,timeout:4e3,success:function(i){e.startReceiveMsg();e.$loginStatus=true},error:function(i){e.reLogin=function(){};TribeModule.msg.fire("SDK.SEND:ERROR",{data:i,errorType:"relogin"});var t=i.type||"\u9519\u8bef\u70b9";_CTK202c(0,"error:sdk.relogin.error","sdk.kick_off",{group:t,type:"error"})}});_CTK202c(17,"sdk.relogin","sdk.init")}}};window.SDKMODULE=s;return s},{requires:["event","uri","io"]});KISSY.add("mui/tribechat/widgets/base64/index",function(e){var i={};var t="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=";function r(e){var i="",t=0,r,n,s;r=n=s=0;while(t<e.length){r=e.charCodeAt(t);if(r<128){i+=String.fromCharCode(r);t++}else if(r>191&&r<224){s=e.charCodeAt(t+1);i+=String.fromCharCode((r&31)<<6|s&63);t+=2}else{s=e.charCodeAt(t+1);n=e.charCodeAt(t+2);i+=String.fromCharCode((r&15)<<12|(s&63)<<6|n&63);t+=3}}return i}function n(e){e=e.replace(/\r\n/g,"\n");var i="";for(var t=0;t<e.length;t++){var r=e.charCodeAt(t);if(r<128){i+=String.fromCharCode(r)}else if(r>127&&r<2048){i+=String.fromCharCode(r>>6|192);i+=String.fromCharCode(r&63|128)}else{i+=String.fromCharCode(r>>12|224);i+=String.fromCharCode(r>>6&63|128);i+=String.fromCharCode(r&63|128)}}return i}var i={encode:function(e){var i="";var r,s,a,o,c,d,u;var l=0;e=n(e);while(l<e.length){r=e.charCodeAt(l++);s=e.charCodeAt(l++);a=e.charCodeAt(l++);o=r>>2;c=(r&3)<<4|s>>4;d=(s&15)<<2|a>>6;u=a&63;if(isNaN(s)){d=u=64}else if(isNaN(a)){u=64}i=i+t.charAt(o)+t.charAt(c)+t.charAt(d)+t.charAt(u)}return i},decode:function(e){var i="";var n,s,a;var o,c,d,u;var l=0;e=e.replace(/[^A-Za-z0-9\+\/\=]/g,"");while(l<e.length){o=t.indexOf(e.charAt(l++));c=t.indexOf(e.charAt(l++));d=t.indexOf(e.charAt(l++));u=t.indexOf(e.charAt(l++));n=o<<2|c>>4;s=(c&15)<<4|d>>2;a=(d&3)<<6|u;i=i+String.fromCharCode(n);if(d!==64){i=i+String.fromCharCode(s)}if(u!==64){i=i+String.fromCharCode(a)}}i=r(i);return i}};return i});