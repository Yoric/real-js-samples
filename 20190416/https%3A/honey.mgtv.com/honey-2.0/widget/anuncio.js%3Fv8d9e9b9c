"use strict";var _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e};honey.def("lib:jquery, lib:mustache, tpl:anuncio",function(i){i.anuncio={_ans:null,init:function(){if(!this._filter()||"5.0"===window.PAGE_DATA.version){var e=this._genAnID(),t=this._genAnUrl(e);this._fetchAn(t),this.bindEvent()}},bindEvent:function(){var r,i=this;i.hasBindEvent||(i.hasBindEvent=!0,$(document).on("page.reload.mock",function(e,t){if(i._ans&&i._ans.length)for(var n=0;n<i._ans.length&&!(r=i._ans[n]).asyncRender;n++)$("#"+r.uniqueID).replaceWith("<anuncio id="+r.id+"></anuncio>");i.init()}))},_filter:function(){return/(iPad)/.test(navigator.userAgent)},_genAnID:function(){var r=[];return $("anuncio").each(function(e,t){var n=parseInt($(t).attr("id"));isNaN(n)||r.push(n)}),r},_genAnUrl:function(e){var t="https:"==location.protocol?"//web.da.mgtv.com":"//pc.da.mgtv.com",n={};window.STK&&(n={vip:"1"==STK.$.cookie.get("vipStatus")?1:0,cxid:STK.$.getCxid("cxid")||"",ck:STK.$.globalStorage()||"",sid:STK.$.sessionid()||""});var r=JSON.stringify({m:{aids:e,pu:encodeURIComponent(location.href)},u:n,c:{type:1,os:this._getOSName(),ua:encodeURIComponent(navigator.userAgent),openudid:this._getOpenID()}}),i=window.VIDEOINFO||{vid:0,rid:0,cid:0};return t+="/pc/page?p="+r+"&v="+JSON.stringify({v:{id:parseInt(i.vid),channel_id:parseInt(i.rid),hid:parseInt(i.cid)}})},_fetchAn:function(t){var n=this;$.ajax({url:t,type:"GET",timeout:4e3,dataType:"jsonp",jsonpCallback:"cb",success:function(e){e?n._parseAn(e.v):console.log("[ERROR] cannot fetch ["+t+"] anuncio data.")}})},_parseAn:function(e){var s=this,c=[];$($.parseXML(e)).find("Ad").each(function(e,t){var n=$(t),r={};r.uniqueID="d"+ +new Date+Math.floor(1e4*Math.random())+n.attr("id"),r.id=n.attr("id"),r.type=n.attr("type"),r.isThirdpartJs="js"==n.find("Wrapper").attr("Type"),r.isThirdpartJs&&(r.type="thirdpartJS",r.jsResourceData=n.find("VASTAdTagURI").text(),n=n.find("Wrapper")),r.duration=s._parseDuration(n.find("Duration").text());var i=n.find("StaticResource");r.resourceData=i.text();var o=(i.attr("creativeType")||"").split("/")[0];r["is"+o]=!0,r.url=n.find("NonLinearClickThrough").text(),r.title=n.find("Title").text(),r.desc=n.find("Desc").text();var a=n.find("NonLinear");r.style={width:a.attr("width"),height:a.attr("height")},r.start=[],r.close=[],r.click=[],r.error=[],n.find("Impression").each(function(e,t){r.start.push($(t).text())}),n.find("Tracking").each(function(e,t){"view"===$(t).attr("event")&&r.start.push($(t).text()),"close"===$(t).attr("event")&&r.close.push($(t).text())}),n.find("NonLinearClickTracking").each(function(e,t){r.click.push($(t).text())}),n.find("Error").each(function(e,t){r.error.push($(t).text())}),0==r.error.length&&(r.error=[""]),c.push(r)}),this._ans=c,this._dispatch(c)},_getOpenID:function(){var e=this._getCookie("anuncioOpenID");return e||(e=this._genOpenID(),this._setCookie("anuncioOpenID",e)),e},_genOpenID:function(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(e){var t=16*Math.random()|0;return("x"==e?t:3&t|8).toString(16)}).toUpperCase()},_parseDuration:function(e){var t=0,n=/(\d+):(\d+):(\d+)/.exec(e);return n&&(t=60*parseInt(n[1],10)*60+60*parseInt(n[2],10)+parseInt(n[3],10)),t},_dispatch:function(e){var r=this;$.each(e,function(e,t){if("2000203"!=t.id&&"200049"!=t.id&&"stream"!=t.type&&"9000108"!=t.id){""==t.url&&(t.url="javascript:;");var n=i.anuncioTpl[t.type];r._render(t,n)}else t.asyncRender=!0}),$(document).trigger("anuncio.ready")},_setTitle:function(t){var n=["200051","200056","200061","200066","200071"];if(t){var r=t.id,e=t.uniqueID;$("#"+e).parent().addClass("on"),$.each(n,function(e){r==n[e]&&$("[anuncio-title="+r+"]").html(t.title)})}},_render:function(t,e){var n=this,r="";r+=Mustache.render(e.tpl,t),r+=Mustache.render(e.style,t),$("anuncio#"+t.id).replaceWith(r);var i=$("#"+t.uniqueID);this._setTitle(t),this._anlog(t.start,t.error),$("#"+t.uniqueID).on("click",".jump",function(e){n._anlog(t.click,t.error),e.stopPropagation()}),t.isimage?this._imageError(t,function(){e.custom&&e.custom(t,i,$.proxy(n._anlog,n))}):e.custom&&e.custom(t,i,$.proxy(this._anlog,this))},_imageError:function(t,e){var n=this,r=new Image;r.onload=function(){e()},r.onerror=function(){var e=[t.error[0].replace("[ERRORCODE]","500").replace("[ERRORMSG]","").replace("[ERRORURL]",encodeURIComponent(t.resourceData))];n._anlog(e)},r.src=t.resourceData},_anlog:function(e,r){var i=this;new RegExp("app/impression");$.each(e,function(e,t){if(t){var n=new Image(1,1);n.onload=function(){return n=null},r&&(n.onerror=function(){var e=[r[0].replace("[ERRORCODE]","700").replace("[ERRORMSG]","").replace("[ERRORURL]",encodeURIComponent(t))];i._anlog(e)}),n.src=t+(-1==t.indexOf("?")?"?":"&")+"rnd="+ +new Date}})},_setCookie:function(e,t){var n=new Date;n.setTime(n.getTime()+31104e6),document.cookie=e+"="+encodeURIComponent(t)+"; expires="+n.toGMTString()},_getCookie:function(e){var t,n=new RegExp("(^| )"+e+"=([^;]*)(;|$)");return(t=document.cookie.match(n))?decodeURIComponent(t[2]):""},_getOSName:function(){var e="other",t=[{s:"win7",r:/(Windows 7|Windows NT 6.1)/},{s:"win8",r:/(Windows 8|Windows NT 6.2|Windows NT 6.3)/},{s:"win10",r:/(Windows 10|Windows NT 10.0)/},{s:"win2000",r:/(Windows NT 5.0|Windows 2000)/},{s:"winXP",r:/(Windows NT 5.1|Windows XP)/},{s:"winVista",r:/Windows NT 6.0/},{s:"win",r:/Windows/},{s:"mac",r:/(Mac OS X|MacPPC|MacIntel|Mac_PowerPC|Macintosh)/},{s:"linux",r:/(UNIX|Linux|X11)/}];for(var n in t){var r=t[n];if(r.r.test(navigator.userAgent)){e=r.s;break}}return e}},i.anuncio.init()}),function(i){i.fn.iframeTracker=function(e){var t=this.get();if(null===e||!1===e)i.iframeTracker.untrack(t);else{if("object"!=(void 0===e?"undefined":_typeof(e)))throw new Error("Wrong handler type (must be an object, or null|false to untrack)");i.iframeTracker.track(t,e)}},i.iframeTracker={focusRetriever:null,focusRetrieved:!1,handlersList:[],isIE8AndOlder:!1,init:function(){try{1==i.browser.msie&&i.browser.version<9&&(this.isIE8AndOlder=!0)}catch(e){try{navigator.userAgent.match(/(msie) ([\w.]+)/i)[2]<9&&(this.isIE8AndOlder=!0)}catch(t){}}if(i(window).focus(),i(window).blur(function(e){i.iframeTracker.windowLoseFocus(e)}),i("body").append('<div style="position:fixed; top:0; left:0; overflow:hidden;"><input style="position:absolute; left:-300px;" type="text" value="" id="focus_retriever" readonly="true" /></div>'),this.focusRetriever=i("#focus_retriever"),this.focusRetrieved=!1,i(document).mousemove(function(e){document.activeElement&&"IFRAME"==document.activeElement.tagName&&(i.iframeTracker.focusRetriever.focus(),i.iframeTracker.focusRetrieved=!0)}),this.isIE8AndOlder){this.focusRetriever.blur(function(e){e.stopPropagation(),e.preventDefault(),i.iframeTracker.windowLoseFocus(e)}),i("body").click(function(e){i(window).focus()}),i("form").click(function(e){e.stopPropagation()});try{i("body").on("click","form",function(e){e.stopPropagation()})}catch(e){console.log("[iframeTracker] Please update jQuery to 1.7 or newer. (exception: "+e.message+")")}}},track:function(e,t){t.target=e,i.iframeTracker.handlersList.push(t),i(e).bind("mouseover",{handler:t},i.iframeTracker.mouseoverListener).bind("mouseout",{handler:t},i.iframeTracker.mouseoutListener)},untrack:function(e){if("function"==typeof Array.prototype.filter){i(e).each(function(e){i(this).unbind("mouseover",i.iframeTracker.mouseoverListener).unbind("mouseout",i.iframeTracker.mouseoutListener)});var t=function(e){return null!==e};for(var n in this.handlersList){for(var r in this.handlersList[n].target)-1!==i.inArray(this.handlersList[n].target[r],e)&&(this.handlersList[n].target[r]=null);this.handlersList[n].target=this.handlersList[n].target.filter(t),0==this.handlersList[n].target.length&&(this.handlersList[n]=null)}this.handlersList=this.handlersList.filter(t)}else console.log("Your browser doesn't support Array filter, untrack disabled")},mouseoverListener:function(e){e.data.handler.over=!0;try{e.data.handler.overCallback(this)}catch(t){}},mouseoutListener:function(e){e.data.handler.over=!1,i.iframeTracker.focusRetriever.focus();try{e.data.handler.outCallback(this)}catch(t){}},windowLoseFocus:function(e){for(var t in this.handlersList)if(1==this.handlersList[t].over)try{this.handlersList[t].blurCallback()}catch(n){}}},i(document).ready(function(){i.iframeTracker.init()})}(jQuery);