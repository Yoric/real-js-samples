var ChLocPopAs;(function(n){function nt(n,t,i,r,u,f,e,s,h,c,l,a,v,y){n=n||"";v=v||b;g.push(new o(n,t,i,r,u,f,e,s,v,h,c,l,a,y))}function u(n){for(var i=[],t=1;t<arguments.length;t++)i[t-1]=arguments[t];return n.replace(/{(\d+)}/g,function(n,t){return typeof i[t]!="undefined"?i[t]:n})}function s(){var n=new Date;return r(n.getUTCFullYear()%100)+r(n.getUTCMonth()+1)+r(n.getUTCDate())}function h(){var n=new Date;return r(n.getUTCHours())+r(n.getUTCMinutes())+r(n.getUTCSeconds())}function r(n){return n>9?n.toString():"0"+n}function c(n,t){sj_cook.set(w,n,t,!0,"/")}function l(n){sj_sp(n);sj_pd(n)}function t(n){for(var i=[],t=1;t<arguments.length;t++)i[t-1]=arguments[t];Log&&Log.Log&&Log.Log.apply(Log,[n,"Geolocation","ChLocPopAs",!1].concat(i))}var a=13,v=27,y=38,p=40,w="SRCHHPGUSR",b="DEFLOC",k="REVIP",f="geoItm_hlt",e="GEODTAS",i="b_hide",d="D41D8CD98F00B204E9800998ECF8427E17832687",g=n.popups=[],o;n.init=nt;o=function(){function n(n,t,i,r,u,f,e,o,s,h,c,l,a,v){this.id=n;this.locSuggestionsApiUrl=t;this.maxSuggestions=i;this.doHitHighlightingSuggestions=r;this.defaultLocationCookieFormat=u;this.defaultLocationSubmitUrl=f;this.clientId=e;this.requeryTemplate=o;this.shouldWriteRevIp=h;this.revIpLatitude=c;this.revIpLongitude=l;this.revIpLocationCookieFormat=a;this.defLocationCrumbName=s;this.clientIP=v;sj_evt.bind("chloc_popupLoad"+this.id,this.setup.bind(this),1)}return n.prototype.setup=function(){this.locationChangeForm=_d.forms["wpc_chlocman"+this.id];this.locationTextBox=_ge("chlocman_tb"+this.id);this.locationTextBoxDefaultText=this.locationTextBox.value;this.submitButton=_ge("chlocman_sb"+this.id);this.resultContainer=_ge("chpopas_res"+this.id);this.resultItem=_ge("chpopas_resItm"+this.id).firstChild;this.noTextErrorMsgDiv=_ge("chpopas_eNoTxt"+this.id);this.noResultErrorMsgDiv=_ge("chpopas_eNoRes"+this.id);this.ajaxErrorMsgDiv=_ge("chpopas_eAjx"+this.id);this.locSuggestionsFetchTimeout=null;this.suggestions=[];this.selectedSuggestionIndex=0;this.userFirstInteractionLogged=!1;sj_be(this.submitButton,"click",this.submitButtonHandler.bind(this));sj_be(this.locationTextBox,"keydown",this.changeLocationKeyPressHandler.bind(this));sj_be(this.locationTextBox,"input",this.changeLocationTextChangeHandler.bind(this,200));sj_be(this.locationTextBox,"blur",this.hideErrorContainers.bind(this));this.locationTextBox.focus();t("SetupPopUp","id",this.id)},n.prototype.changeLocationKeyPressHandler=function(n){var i=n.keyCode?n.keyCode:n.charCode;switch(i){case a:t("KeyPress","id",this.id,"Key","Enter");this.submitButtonHandler();break;case p:t("KeyPress","id",this.id,"Key","Down");this.suggestions.length>0&&this.highlightLocationAtIndex((this.selectedSuggestionIndex+1)%this.suggestions.length);break;case y:t("KeyPress","id",this.id,"Key","Up");this.suggestions.length>0&&this.highlightLocationAtIndex((this.selectedSuggestionIndex-1+this.suggestions.length)%this.suggestions.length);l(n);break;case v:l(n)}},n.prototype.changeLocationTextChangeHandler=function(n){var i=this;this.userFirstInteractionLogged||(this.userFirstInteractionLogged=!0,t("UserInteracted","id",this.id));clearTimeout(this.locSuggestionsFetchTimeout);this.locSuggestionsFetchTimeout=setTimeout(function(){i.resultContainer.innerHTML="";i.suggestions=[];i.selectedSuggestionIndex=0;i.hideErrorContainers();var n=i.locationTextBox.value.trim();n.length>0&&i.fetchData(n)},n)},n.prototype.highlightLocationAtIndex=function(n){Lib.CssClass.remove(this.suggestions[this.selectedSuggestionIndex],f);Lib.CssClass.add(this.suggestions[n],f);this.selectedSuggestionIndex=n},n.prototype.submitButtonHandler=function(){var n=this.locationTextBox.value.trim(),t,r;if(n.length===0||n===this.locationTextBoxDefaultText)Lib.CssClass.remove(this.noTextErrorMsgDiv,i);else{if(this.suggestions.length>0){this.changeLocation(this.suggestions[this.selectedSuggestionIndex],n);return}this.requeryTemplate?this.changeLocationTextChangeHandler(1):this.defaultLocationSubmitUrl&&(t=UrlLib.AddParam(location.href,"form",e),r=u(this.defaultLocationSubmitUrl,this.clientId,encodeURIComponent(n),encodeURIComponent(t)),location.href=r)}this.locationTextBox.focus()},n.prototype.fetchData=function(n){var r=this,i=u(this.locSuggestionsApiUrl,encodeURIComponent(n),d),t=sj_gx();t.open("get",i,!0);t.onreadystatechange=function(){t.readyState===4&&r.handleResults(t,i,n)};t.send()},n.prototype.handleResults=function(n,r,u){var s=null,l,a,v,c,o,h,e;try{n.status===200&&(s=JSON.parse(n.responseText))}catch(y){}if(s&&s.value&&s.instrumentation&&s.instrumentation.pageLoadPingUrl!==""&&s.instrumentation.pingUrlBase!==""){for(this.instrumentationUrl=s.instrumentation.pingUrlBase,l=sj_gx(),l.open("get",s.instrumentation.pageLoadPingUrl,!0),l.send(),this.resultContainer.innerHTML="",this.suggestions=[],this.selectedSuggestionIndex=0,this.hideErrorContainers(),a=s.value,v=[],c=0;c<a.length;c++)if((o=a[c],h=o.name||o.address&&o.address.text||o.text,h&&v.indexOf(h)===-1&&o.geo&&o.geo.latitude&&o.geo.longitude)&&(v.push(h),e=this.resultItem.cloneNode(!0),e.innerHTML=this.getHitHighlightedSuggestion(h,u),e.setAttribute("data-lat",o.geo.latitude),e.setAttribute("data-lon",o.geo.longitude),e.setAttribute("data-disp",h),e.setAttribute("data-id",o.readLinkPingSuffix),sj_be(e,"click",this.changeLocation.bind(this,e,u)),sj_be(e,"mouseenter",this.highlightLocationAtIndex.bind(this,this.suggestions.length)),sj_be(e,"mouseleave",this.highlightLocationAtIndex.bind(this,0)),this.resultContainer.appendChild(e),this.suggestions.push(e),this.suggestions.length===this.maxSuggestions))break;this.suggestions.length>0?Lib.CssClass.add(this.suggestions[0],f):(Lib.CssClass.remove(this.noResultErrorMsgDiv,i),t("NoResults","id",this.id,"Locality",u))}else Lib.CssClass.remove(this.ajaxErrorMsgDiv,i),t("AjaxFailed","id",this.id,"Url",r)},n.prototype.getHitHighlightedSuggestion=function(n,t){if(!this.doHitHighlightingSuggestions)return n;t=t.replace(/  +/g," ");var i=n.toLowerCase().indexOf(t.toLowerCase());return i!==-1?n.substr(0,i)+"<b>"+n.substr(i,t.length)+"<\/b>"+n.substr(i+t.length):n},n.prototype.hideErrorContainers=function(){Lib.CssClass.add(this.noTextErrorMsgDiv,i);Lib.CssClass.add(this.noResultErrorMsgDiv,i);Lib.CssClass.add(this.ajaxErrorMsgDiv,i)},n.prototype.changeLocation=function(n,i){var v=n.getAttribute("data-lat"),y=n.getAttribute("data-lon"),f=encodeURIComponent(n.getAttribute("data-disp")),p=n.getAttribute("data-id"),o,l,a,r;if(t("Submitted","id",this.id,"Locality",i,"Location",f),o=sj_gx(),o.open("get",this.instrumentationUrl+p,!0),o.send(),this.requeryTemplate){location.href=this.createRequeryUrl(f);return}l=u(this.defaultLocationCookieFormat,v,y,f,s(),h());c(this.defLocationCrumbName,l);this.shouldWriteRevIp&&(a=u(this.revIpLocationCookieFormat,this.revIpLatitude,this.revIpLongitude,s(),h()),c(k,a),_lochelper.wcIP(this.clientIP));r=UrlLib.AddParam(location.href,"isRef","1");r=UrlLib.AddParam(r,"showTw","1");location.href=UrlLib.AddParam(r,"form",e)},n.prototype.createRequeryUrl=function(n){var t=u(this.requeryTemplate,n);return UrlLib.AddParam(t,"form",e)},n}();sj_evt.fire("ChLocPopAsLoad")})(ChLocPopAs||(ChLocPopAs={}))